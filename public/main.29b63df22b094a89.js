(self.webpackChunkfront=self.webpackChunkfront||[]).push([[179],{953:(gg,Gc,Bl)=>{"use strict";function Qn(i){return"function"==typeof i}function bh(i){const a=i(u=>{Error.call(u),u.stack=(new Error).stack});return a.prototype=Object.create(Error.prototype),a.prototype.constructor=a,a}const _g=bh(i=>function(a){i(this),this.message=a?`${a.length} errors occurred during unsubscription:\n${a.map((u,d)=>`${d+1}) ${u.toString()}`).join("\n  ")}`:"",this.name="UnsubscriptionError",this.errors=a});function qt(i,o){if(i){const a=i.indexOf(o);0<=a&&i.splice(a,1)}}class it{constructor(o){this.initialTeardown=o,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let o;if(!this.closed){this.closed=!0;const{_parentage:a}=this;if(a)if(this._parentage=null,Array.isArray(a))for(const g of a)g.remove(this);else a.remove(this);const{initialTeardown:u}=this;if(Qn(u))try{u()}catch(g){o=g instanceof _g?g.errors:[g]}const{_finalizers:d}=this;if(d){this._finalizers=null;for(const g of d)try{Ae(g)}catch(x){o=o??[],x instanceof _g?o=[...o,...x.errors]:o.push(x)}}if(o)throw new _g(o)}}add(o){var a;if(o&&o!==this)if(this.closed)Ae(o);else{if(o instanceof it){if(o.closed||o._hasParent(this))return;o._addParent(this)}(this._finalizers=null!==(a=this._finalizers)&&void 0!==a?a:[]).push(o)}}_hasParent(o){const{_parentage:a}=this;return a===o||Array.isArray(a)&&a.includes(o)}_addParent(o){const{_parentage:a}=this;this._parentage=Array.isArray(a)?(a.push(o),a):a?[a,o]:o}_removeParent(o){const{_parentage:a}=this;a===o?this._parentage=null:Array.isArray(a)&&qt(a,o)}remove(o){const{_finalizers:a}=this;a&&qt(a,o),o instanceof it&&o._removeParent(this)}}it.EMPTY=(()=>{const i=new it;return i.closed=!0,i})();const Go=it.EMPTY;function vs(i){return i instanceof it||i&&"closed"in i&&Qn(i.remove)&&Qn(i.add)&&Qn(i.unsubscribe)}function Ae(i){Qn(i)?i():i.unsubscribe()}const mo={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},qo={setTimeout(i,o,...a){const{delegate:u}=qo;return u?.setTimeout?u.setTimeout(i,o,...a):setTimeout(i,o,...a)},clearTimeout(i){const{delegate:o}=qo;return(o?.clearTimeout||clearTimeout)(i)},delegate:void 0};function ia(i){qo.setTimeout(()=>{const{onUnhandledError:o}=mo;if(!o)throw i;o(i)})}function qc(){}const $a=Zi("C",void 0,void 0);function Zi(i,o,a){return{kind:i,value:o,error:a}}let xs=null;function bs(i){if(mo.useDeprecatedSynchronousErrorHandling){const o=!xs;if(o&&(xs={errorThrown:!1,error:null}),i(),o){const{errorThrown:a,error:u}=xs;if(xs=null,a)throw u}}else i()}class Ha extends it{constructor(o){super(),this.isStopped=!1,o?(this.destination=o,vs(o)&&o.add(this)):this.destination=yg}static create(o,a,u){return new jl(o,a,u)}next(o){this.isStopped?xr(function wh(i){return Zi("N",i,void 0)}(o),this):this._next(o)}error(o){this.isStopped?xr(function vf(i){return Zi("E",void 0,i)}(o),this):(this.isStopped=!0,this._error(o))}complete(){this.isStopped?xr($a,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(o){this.destination.next(o)}_error(o){try{this.destination.error(o)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}}const ws=Function.prototype.bind;function tt(i,o){return ws.call(i,o)}class Ke{constructor(o){this.partialObserver=o}next(o){const{partialObserver:a}=this;if(a.next)try{a.next(o)}catch(u){Es(u)}}error(o){const{partialObserver:a}=this;if(a.error)try{a.error(o)}catch(u){Es(u)}else Es(o)}complete(){const{partialObserver:o}=this;if(o.complete)try{o.complete()}catch(a){Es(a)}}}class jl extends Ha{constructor(o,a,u){let d;if(super(),Qn(o)||!o)d={next:o??void 0,error:a??void 0,complete:u??void 0};else{let g;this&&mo.useDeprecatedNextContext?(g=Object.create(o),g.unsubscribe=()=>this.unsubscribe(),d={next:o.next&&tt(o.next,g),error:o.error&&tt(o.error,g),complete:o.complete&&tt(o.complete,g)}):d=o}this.destination=new Ke(d)}}function Es(i){mo.useDeprecatedSynchronousErrorHandling?function xf(i){mo.useDeprecatedSynchronousErrorHandling&&xs&&(xs.errorThrown=!0,xs.error=i)}(i):ia(i)}function xr(i,o){const{onStoppedNotification:a}=mo;a&&qo.setTimeout(()=>a(i,o))}const yg={closed:!0,next:qc,error:function be(i){throw i},complete:qc},Ga="function"==typeof Symbol&&Symbol.observable||"@@observable";function oa(i){return i}function qa(i){return 0===i.length?oa:1===i.length?i[0]:function(a){return i.reduce((u,d)=>d(u),a)}}let Nn=(()=>{class i{constructor(a){a&&(this._subscribe=a)}lift(a){const u=new i;return u.source=this,u.operator=a,u}subscribe(a,u,d){const g=function Ds(i){return i&&i instanceof Ha||function Ts(i){return i&&Qn(i.next)&&Qn(i.error)&&Qn(i.complete)}(i)&&vs(i)}(a)?a:new jl(a,u,d);return bs(()=>{const{operator:x,source:w}=this;g.add(x?x.call(g,w):w?this._subscribe(g):this._trySubscribe(g))}),g}_trySubscribe(a){try{return this._subscribe(a)}catch(u){a.error(u)}}forEach(a,u){return new(u=Gt(u))((d,g)=>{const x=new jl({next:w=>{try{a(w)}catch(S){g(S),x.unsubscribe()}},error:g,complete:d});this.subscribe(x)})}_subscribe(a){var u;return null===(u=this.source)||void 0===u?void 0:u.subscribe(a)}[Ga](){return this}pipe(...a){return qa(a)(this)}toPromise(a){return new(a=Gt(a))((u,d)=>{let g;this.subscribe(x=>g=x,x=>d(x),()=>u(g))})}}return i.create=o=>new i(o),i})();function Gt(i){var o;return null!==(o=i??mo.Promise)&&void 0!==o?o:Promise}const Ul=bh(i=>function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});let yi=(()=>{class i extends Nn{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(a){const u=new Vt(this,this);return u.operator=a,u}_throwIfClosed(){if(this.closed)throw new Ul}next(a){bs(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(const u of this.currentObservers)u.next(a)}})}error(a){bs(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=a;const{observers:u}=this;for(;u.length;)u.shift().error(a)}})}complete(){bs(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;const{observers:a}=this;for(;a.length;)a.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var a;return(null===(a=this.observers)||void 0===a?void 0:a.length)>0}_trySubscribe(a){return this._throwIfClosed(),super._trySubscribe(a)}_subscribe(a){return this._throwIfClosed(),this._checkFinalizedStatuses(a),this._innerSubscribe(a)}_innerSubscribe(a){const{hasError:u,isStopped:d,observers:g}=this;return u||d?Go:(this.currentObservers=null,g.push(a),new it(()=>{this.currentObservers=null,qt(g,a)}))}_checkFinalizedStatuses(a){const{hasError:u,thrownError:d,isStopped:g}=this;u?a.error(d):g&&a.complete()}asObservable(){const a=new Nn;return a.source=this,a}}return i.create=(o,a)=>new Vt(o,a),i})();class Vt extends yi{constructor(o,a){super(),this.destination=o,this.source=a}next(o){var a,u;null===(u=null===(a=this.destination)||void 0===a?void 0:a.next)||void 0===u||u.call(a,o)}error(o){var a,u;null===(u=null===(a=this.destination)||void 0===a?void 0:a.error)||void 0===u||u.call(a,o)}complete(){var o,a;null===(a=null===(o=this.destination)||void 0===o?void 0:o.complete)||void 0===a||a.call(o)}_subscribe(o){var a,u;return null!==(u=null===(a=this.source)||void 0===a?void 0:a.subscribe(o))&&void 0!==u?u:Go}}function Ci(i){return Qn(i?.lift)}function Br(i){return o=>{if(Ci(o))return o.lift(function(a){try{return i(a,this)}catch(u){this.error(u)}});throw new TypeError("Unable to lift unknown Observable type")}}function mr(i,o,a,u,d){return new bf(i,o,a,u,d)}class bf extends Ha{constructor(o,a,u,d,g,x){super(o),this.onFinalize=g,this.shouldUnsubscribe=x,this._next=a?function(w){try{a(w)}catch(S){o.error(S)}}:super._next,this._error=d?function(w){try{d(w)}catch(S){o.error(S)}finally{this.unsubscribe()}}:super._error,this._complete=u?function(){try{u()}catch(w){o.error(w)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var o;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){const{closed:a}=this;super.unsubscribe(),!a&&(null===(o=this.onFinalize)||void 0===o||o.call(this))}}}function un(i,o){return Br((a,u)=>{let d=0;a.subscribe(mr(u,g=>{u.next(i.call(o,g,d++))}))})}function Cn(i){return this instanceof Cn?(this.v=i,this):new Cn(i)}function Mn(i,o,a){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var d,u=a.apply(i,o||[]),g=[];return d={},x("next"),x("throw"),x("return"),d[Symbol.asyncIterator]=function(){return this},d;function x(G){u[G]&&(d[G]=function(J){return new Promise(function(ct,mt){g.push([G,J,ct,mt])>1||w(G,J)})})}function w(G,J){try{!function S(G){G.value instanceof Cn?Promise.resolve(G.value.v).then(P,k):F(g[0][2],G)}(u[G](J))}catch(ct){F(g[0][3],ct)}}function P(G){w("next",G)}function k(G){w("throw",G)}function F(G,J){G(J),g.shift(),g.length&&w(g[0][0],g[0][1])}}function vi(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var a,o=i[Symbol.asyncIterator];return o?o.call(i):(i=function ae(i){var o="function"==typeof Symbol&&Symbol.iterator,a=o&&i[o],u=0;if(a)return a.call(i);if(i&&"number"==typeof i.length)return{next:function(){return i&&u>=i.length&&(i=void 0),{value:i&&i[u++],done:!i}}};throw new TypeError(o?"Object is not iterable.":"Symbol.iterator is not defined.")}(i),a={},u("next"),u("throw"),u("return"),a[Symbol.asyncIterator]=function(){return this},a);function u(g){a[g]=i[g]&&function(x){return new Promise(function(w,S){!function d(g,x,w,S){Promise.resolve(S).then(function(P){g({value:P,done:w})},x)}(w,S,(x=i[g](x)).done,x.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const Dt=i=>i&&"number"==typeof i.length&&"function"!=typeof i;function Pt(i){return Qn(i?.then)}function Ft(i){return Qn(i[Ga])}function It(i){return Symbol.asyncIterator&&Qn(i?.[Symbol.asyncIterator])}function $t(i){return new TypeError(`You provided ${null!==i&&"object"==typeof i?"an invalid object":`'${i}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}const Te=function Rt(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}();function dn(i){return Qn(i?.[Te])}function Jt(i){return Mn(this,arguments,function*(){const a=i.getReader();try{for(;;){const{value:u,done:d}=yield Cn(a.read());if(d)return yield Cn(void 0);yield yield Cn(u)}}finally{a.releaseLock()}})}function hn(i){return Qn(i?.getReader)}function mn(i){if(i instanceof Nn)return i;if(null!=i){if(Ft(i))return function ir(i){return new Nn(o=>{const a=i[Ga]();if(Qn(a.subscribe))return a.subscribe(o);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}(i);if(Dt(i))return function gr(i){return new Nn(o=>{for(let a=0;a<i.length&&!o.closed;a++)o.next(i[a]);o.complete()})}(i);if(Pt(i))return function si(i){return new Nn(o=>{i.then(a=>{o.closed||(o.next(a),o.complete())},a=>o.error(a)).then(null,ia)})}(i);if(It(i))return br(i);if(dn(i))return function Io(i){return new Nn(o=>{for(const a of i)if(o.next(a),o.closed)return;o.complete()})}(i);if(hn(i))return function Ii(i){return br(Jt(i))}(i)}throw $t(i)}function br(i){return new Nn(o=>{(function ai(i,o){var a,u,d,g;return function Wt(i,o,a,u){return new(a||(a=Promise))(function(g,x){function w(k){try{P(u.next(k))}catch(F){x(F)}}function S(k){try{P(u.throw(k))}catch(F){x(F)}}function P(k){k.done?g(k.value):function d(g){return g instanceof a?g:new a(function(x){x(g)})}(k.value).then(w,S)}P((u=u.apply(i,o||[])).next())})}(this,void 0,void 0,function*(){try{for(a=vi(i);!(u=yield a.next()).done;)if(o.next(u.value),o.closed)return}catch(x){d={error:x}}finally{try{u&&!u.done&&(g=a.return)&&(yield g.call(a))}finally{if(d)throw d.error}}o.complete()})})(i,o).catch(a=>o.error(a))})}function Yi(i,o,a,u=0,d=!1){const g=o.schedule(function(){a(),d?i.add(this.schedule(null,u)):this.unsubscribe()},u);if(i.add(g),!d)return g}function wr(i,o,a=1/0){return Qn(o)?wr((u,d)=>un((g,x)=>o(u,g,d,x))(mn(i(u,d))),a):("number"==typeof o&&(a=o),Br((u,d)=>function Xa(i,o,a,u,d,g,x,w){const S=[];let P=0,k=0,F=!1;const G=()=>{F&&!S.length&&!P&&o.complete()},J=mt=>P<u?ct(mt):S.push(mt),ct=mt=>{g&&o.next(mt),P++;let St=!1;mn(a(mt,k++)).subscribe(mr(o,Lt=>{d?.(Lt),g?J(Lt):o.next(Lt)},()=>{St=!0},void 0,()=>{if(St)try{for(P--;S.length&&P<u;){const Lt=S.shift();x?Yi(o,x,()=>ct(Lt)):ct(Lt)}G()}catch(Lt){o.error(Lt)}}))};return i.subscribe(mr(o,J,()=>{F=!0,G()})),()=>{w?.()}}(u,d,i,a)))}function Ya(i=1/0){return wr(oa,i)}const Ss=new Nn(i=>i.complete());function wf(i){return i[i.length-1]}function Ka(i){return function pD(i){return i&&Qn(i.schedule)}(wf(i))?i.pop():void 0}function Eh(i,o=0){return Br((a,u)=>{a.subscribe(mr(u,d=>Yi(u,i,()=>u.next(d),o),()=>Yi(u,i,()=>u.complete(),o),d=>Yi(u,i,()=>u.error(d),o)))})}function vg(i,o=0){return Br((a,u)=>{u.add(i.schedule(()=>a.subscribe(u),o))})}function Ef(i,o){if(!i)throw new Error("Iterable cannot be null");return new Nn(a=>{Yi(a,o,()=>{const u=i[Symbol.asyncIterator]();Yi(a,o,()=>{u.next().then(d=>{d.done?a.complete():a.next(d.value)})},0,!0)})})}function Lr(i,o){return o?function Tf(i,o){if(null!=i){if(Ft(i))return function gD(i,o){return mn(i).pipe(vg(o),Eh(o))}(i,o);if(Dt(i))return function Qv(i,o){return new Nn(a=>{let u=0;return o.schedule(function(){u===i.length?a.complete():(a.next(i[u++]),a.closed||this.schedule())})})}(i,o);if(Pt(i))return function _D(i,o){return mn(i).pipe(vg(o),Eh(o))}(i,o);if(It(i))return Ef(i,o);if(dn(i))return function tx(i,o){return new Nn(a=>{let u;return Yi(a,o,()=>{u=i[Te](),Yi(a,o,()=>{let d,g;try{({value:d,done:g}=u.next())}catch(x){return void a.error(x)}g?a.complete():a.next(d)},0,!0)}),()=>Qn(u?.return)&&u.return()})}(i,o);if(hn(i))return function xg(i,o){return Ef(Jt(i),o)}(i,o)}throw $t(i)}(i,o):mn(i)}function me(i,o,...a){if(!0===o)return void i();if(!1===o)return;const u=new jl({next:()=>{u.unsubscribe(),i()}});return o(...a).subscribe(u)}function _e(i){for(let o in i)if(i[o]===_e)return o;throw Error("Could not find renamed property on target object.")}function In(i){if("string"==typeof i)return i;if(Array.isArray(i))return"["+i.map(In).join(", ")+"]";if(null==i)return""+i;if(i.overriddenName)return`${i.overriddenName}`;if(i.name)return`${i.name}`;const o=i.toString();if(null==o)return""+o;const a=o.indexOf("\n");return-1===a?o:o.substring(0,a)}function Hl(i,o){return null==i||""===i?null===o?"":o:null==o||""===o?i:i+" "+o}const ex=_e({__forward_ref__:_e});function Sf(i){return i.__forward_ref__=Sf,i.toString=function(){return In(this())},i}function Ge(i){return function Th(i){return"function"==typeof i&&i.hasOwnProperty(ex)&&i.__forward_ref__===Sf}(i)?i():i}class ne extends Error{constructor(o,a){super(function Gl(i,o){return`NG0${Math.abs(i)}${o?": "+o.trim():""}`}(o,a)),this.code=o}}function Ln(i){return"function"==typeof i?i.name||i.toString():"object"==typeof i&&null!=i&&"function"==typeof i.type?i.type.name||i.type.toString():function Je(i){return"string"==typeof i?i:null==i?"":String(i)}(i)}function he(i,o){throw new ne(-201,!1)}function De(i,o){null==i&&function re(i,o,a,u){throw new Error(`ASSERTION ERROR: ${i}`+(null==u?"":` [Expected=> ${a} ${u} ${o} <=Actual]`))}(o,i,null,"!=")}function Ue(i){return{token:i.token,providedIn:i.providedIn||null,factory:i.factory,value:void 0}}function Ki(i){return{providers:i.providers||[],imports:i.imports||[]}}function ci(i){return ox(i,tu)||ox(i,Ch)}function ox(i,o){return i.hasOwnProperty(o)?i[o]:null}function Qc(i){return i&&(i.hasOwnProperty(Mf)||i.hasOwnProperty(Eg))?i[Mf]:null}const tu=_e({\u0275prov:_e}),Mf=_e({\u0275inj:_e}),Ch=_e({ngInjectableDef:_e}),Eg=_e({ngInjectorDef:_e});var Oe=(()=>((Oe=Oe||{})[Oe.Default=0]="Default",Oe[Oe.Host=1]="Host",Oe[Oe.Self=2]="Self",Oe[Oe.SkipSelf=4]="SkipSelf",Oe[Oe.Optional=8]="Optional",Oe))();let Mh;function le(i){const o=Mh;return Mh=i,o}function If(i,o,a){const u=ci(i);return u&&"root"==u.providedIn?void 0===u.value?u.value=u.factory():u.value:a&Oe.Optional?null:void 0!==o?o:void he(In(i))}function kr(i){return{toString:i}.toString()}var Tr=(()=>((Tr=Tr||{})[Tr.OnPush=0]="OnPush",Tr[Tr.Default=1]="Default",Tr))(),Vn=(()=>{return(i=Vn||(Vn={}))[i.Emulated=0]="Emulated",i[i.None=2]="None",i[i.ShadowDom=3]="ShadowDom",Vn;var i})();const Un=(()=>typeof globalThis<"u"&&globalThis||typeof global<"u"&&global||typeof window<"u"&&window||typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&self)(),sr={},An=[],eu=_e({\u0275cmp:_e}),Yo=_e({\u0275dir:_e}),ql=_e({\u0275pipe:_e}),nu=_e({\u0275mod:_e}),Ze=_e({\u0275fac:_e}),Ah=_e({__NG_ELEMENT_ID__:_e});let Tg=0;function Qi(i){return kr(()=>{const a=!0===i.standalone,u={},d={type:i.type,providersResolver:null,decls:i.decls,vars:i.vars,factory:null,template:i.template||null,consts:i.consts||null,ngContentSelectors:i.ngContentSelectors,hostBindings:i.hostBindings||null,hostVars:i.hostVars||0,hostAttrs:i.hostAttrs||null,contentQueries:i.contentQueries||null,declaredInputs:u,inputs:null,outputs:null,exportAs:i.exportAs||null,onPush:i.changeDetection===Tr.OnPush,directiveDefs:null,pipeDefs:null,standalone:a,dependencies:a&&i.dependencies||null,getStandaloneInjector:null,selectors:i.selectors||An,viewQuery:i.viewQuery||null,features:i.features||null,data:i.data||{},encapsulation:i.encapsulation||Vn.Emulated,id:"c"+Tg++,styles:i.styles||An,_:null,setInput:null,schemas:i.schemas||null,tView:null},g=i.dependencies,x=i.features;return d.inputs=Sg(i.inputs,u),d.outputs=Sg(i.outputs),x&&x.forEach(w=>w(d)),d.directiveDefs=g?()=>("function"==typeof g?g():g).map(Dg).filter(Wl):null,d.pipeDefs=g?()=>("function"==typeof g?g():g).map(Ai).filter(Wl):null,d})}function Dg(i){return Pn(i)||Gr(i)}function Wl(i){return null!==i}function Qr(i){return kr(()=>({type:i.type,bootstrap:i.bootstrap||An,declarations:i.declarations||An,imports:i.imports||An,exports:i.exports||An,transitiveCompileScopes:null,schemas:i.schemas||null,id:i.id||null}))}function Sg(i,o){if(null==i)return sr;const a={};for(const u in i)if(i.hasOwnProperty(u)){let d=i[u],g=d;Array.isArray(d)&&(g=d[1],d=d[0]),a[d]=u,o&&(o[d]=g)}return a}const xi=Qi;function Pn(i){return i[eu]||null}function Gr(i){return i[Yo]||null}function Ai(i){return i[ql]||null}function eo(i,o){const a=i[nu]||null;if(!a&&!0===o)throw new Error(`Type ${In(i)} does not have '\u0275mod' property.`);return a}function Ri(i){return Array.isArray(i)&&"object"==typeof i[1]}function _o(i){return Array.isArray(i)&&!0===i[1]}function Cg(i){return 0!=(8&i.flags)}function Of(i){return 2==(2&i.flags)}function Jo(i){return null!==i.template}function cx(i){return 0!=(256&i[2])}function il(i,o){return i.hasOwnProperty(Ze)?i[Ze]:null}class Vf{constructor(o,a,u){this.previousValue=o,this.currentValue=a,this.firstChange=u}isFirstChange(){return this.firstChange}}function Ag(i){return i.type.prototype.ngOnChanges&&(i.setInput=au),yx}function yx(){const i=vx(this),o=i?.current;if(o){const a=i.previous;if(a===sr)i.previous=o;else for(let u in o)a[u]=o[u];i.current=null,this.ngOnChanges(o)}}function au(i,o,a,u){const d=vx(i)||function TD(i,o){return i[Pg]=o}(i,{previous:sr,current:null}),g=d.current||(d.current={}),x=d.previous,w=this.declaredInputs[a],S=x[w];g[w]=new Vf(S&&S.currentValue,o,x===sr),i[u]=o}const Pg="__ngSimpleChanges__";function vx(i){return i[Pg]||null}function hr(i){for(;Array.isArray(i);)i=i[0];return i}function Li(i,o){return hr(o[i.index])}function ki(i,o){const a=o[i];return Ri(a)?a:a[0]}function lu(i){return 64==(64&i[2])}function Ms(i,o){return null==o?null:i[o]}function wx(i){i[18]=0}function cu(i,o){i[5]+=o;let a=i,u=i[3];for(;null!==u&&(1===o&&1===a[5]||-1===o&&0===a[5]);)u[5]+=o,a=u,u=u[3]}const Qe={lFrame:jg(null),bindingsEnabled:!0};function Ex(){return Qe.bindingsEnabled}function At(){return Qe.lFrame.lView}function Sn(){return Qe.lFrame.tView}function qr(){let i=Sx();for(;null!==i&&64===i.type;)i=i.parent;return i}function Sx(){return Qe.lFrame.currentTNode}function Po(i,o){const a=Qe.lFrame;a.currentTNode=i,a.isParent=o}function Fh(){return Qe.lFrame.isParent}function Jl(i,o){const a=Qe.lFrame;a.bindingIndex=a.bindingRootIndex=i,Nh(o)}function Nh(i){Qe.lFrame.currentDirectiveIndex=i}function Ng(i){Qe.lFrame.currentQueryIndex=i}function Ix(i){const o=i[1];return 2===o.type?o.declTNode:1===o.type?i[6]:null}function uu(i,o,a){if(a&Oe.SkipSelf){let d=o,g=i;for(;!(d=d.parent,null!==d||a&Oe.Host||(d=Ix(g),null===d||(g=g[15],10&d.type))););if(null===d)return!1;o=d,i=g}const u=Qe.lFrame=Ax();return u.currentTNode=o,u.lView=i,!0}function Bg(i){const o=Ax(),a=i[1];Qe.lFrame=o,o.currentTNode=a.firstChild,o.lView=i,o.tView=a,o.contextLView=i,o.bindingIndex=a.bindingStartIndex,o.inI18n=!1}function Ax(){const i=Qe.lFrame,o=null===i?null:i.child;return null===o?jg(i):o}function jg(i){const o={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:i,child:null,inI18n:!1};return null!==i&&(i.child=o),o}function Px(){const i=Qe.lFrame;return Qe.lFrame=i.parent,i.currentTNode=null,i.lView=null,i}const Gf=Px;function hu(){const i=Px();i.isParent=!0,i.tView=null,i.selectedIndex=-1,i.contextLView=null,i.elementDepthCount=0,i.currentDirectiveIndex=-1,i.currentNamespace=null,i.bindingRootIndex=-1,i.bindingIndex=-1,i.currentQueryIndex=0}function Rs(i){Qe.lFrame.selectedIndex=i}function Vh(i,o){for(let a=o.directiveStart,u=o.directiveEnd;a<u;a++){const g=i.data[a].type.prototype,{ngAfterContentInit:x,ngAfterContentChecked:w,ngAfterViewInit:S,ngAfterViewChecked:P,ngOnDestroy:k}=g;x&&(i.contentHooks||(i.contentHooks=[])).push(-a,x),w&&((i.contentHooks||(i.contentHooks=[])).push(a,w),(i.contentCheckHooks||(i.contentCheckHooks=[])).push(a,w)),S&&(i.viewHooks||(i.viewHooks=[])).push(-a,S),P&&((i.viewHooks||(i.viewHooks=[])).push(a,P),(i.viewCheckHooks||(i.viewCheckHooks=[])).push(a,P)),null!=k&&(i.destroyHooks||(i.destroyHooks=[])).push(a,k)}}function tc(i,o,a){Ug(i,o,3,a)}function du(i,o,a,u){(3&i[2])===a&&Ug(i,o,a,u)}function fu(i,o){let a=i[2];(3&a)===o&&(a&=2047,a+=1,i[2]=a)}function Ug(i,o,a,u){const g=u??-1,x=o.length-1;let w=0;for(let S=void 0!==u?65535&i[18]:0;S<x;S++)if("number"==typeof o[S+1]){if(w=o[S],null!=u&&w>=u)break}else o[S]<0&&(i[18]+=65536),(w<g||-1==g)&&(Ox(i,a,o,S),i[18]=(4294901760&i[18])+S+2),S++}function Ox(i,o,a,u){const d=a[u]<0,g=a[u+1],w=i[d?-a[u]:a[u]];if(d){if(i[2]>>11<i[18]>>16&&(3&i[2])===o){i[2]+=2048;try{g.call(w)}finally{}}}else try{g.call(w)}finally{}}class Uh{constructor(o,a,u){this.factory=o,this.resolving=!1,this.canSeeViewProviders=a,this.injectImpl=u}}function Hh(i,o,a){let u=0;for(;u<a.length;){const d=a[u];if("number"==typeof d){if(0!==d)break;u++;const g=a[u++],x=a[u++],w=a[u++];i.setAttribute(o,x,w,g)}else{const g=d,x=a[++u];Gg(g)?i.setProperty(o,g,x):i.setAttribute(o,g,x),u++}}return u}function Hg(i){return 3===i||4===i||6===i}function Gg(i){return 64===i.charCodeAt(0)}function Gh(i,o){if(null!==o&&0!==o.length)if(null===i||0===i.length)i=o.slice();else{let a=-1;for(let u=0;u<o.length;u++){const d=o[u];"number"==typeof d?a=d:0===a||qg(i,a,d,null,-1===a||2===a?o[++u]:null)}}return i}function qg(i,o,a,u,d){let g=0,x=i.length;if(-1===o)x=-1;else for(;g<i.length;){const w=i[g++];if("number"==typeof w){if(w===o){x=-1;break}if(w>o){x=g-1;break}}}for(;g<i.length;){const w=i[g];if("number"==typeof w)break;if(w===a){if(null===u)return void(null!==d&&(i[g+1]=d));if(u===i[g+1])return void(i[g+2]=d)}g++,null!==u&&g++,null!==d&&g++}-1!==x&&(i.splice(x,0,o),g=x+1),i.splice(g++,0,a),null!==u&&i.splice(g++,0,u),null!==d&&i.splice(g++,0,d)}function ec(i){return-1!==i}function nc(i){return 32767&i}function pu(i,o){let a=function jx(i){return i>>16}(i),u=o;for(;a>0;)u=u[15],a--;return u}let Wf=!0;function qh(i){const o=Wf;return Wf=i,o}let Vx=0;const Jn={};function mu(i,o){const a=Xg(i,o);if(-1!==a)return a;const u=o[1];u.firstCreatePass&&(i.injectorIndex=o.length,cl(u.data,i),cl(o,null),cl(u.blueprint,null));const d=Zf(i,o),g=i.injectorIndex;if(ec(d)){const x=nc(d),w=pu(d,o),S=w[1].data;for(let P=0;P<8;P++)o[g+P]=w[x+P]|S[x+P]}return o[g+8]=d,g}function cl(i,o){i.push(0,0,0,0,0,0,0,0,o)}function Xg(i,o){return-1===i.injectorIndex||i.parent&&i.parent.injectorIndex===i.injectorIndex||null===o[i.injectorIndex+8]?-1:i.injectorIndex}function Zf(i,o){if(i.parent&&-1!==i.parent.injectorIndex)return i.parent.injectorIndex;let a=0,u=null,d=o;for(;null!==d;){if(u=Yg(d),null===u)return-1;if(a++,d=d[15],-1!==u.injectorIndex)return u.injectorIndex|a<<16}return-1}function Xf(i,o,a){!function kD(i,o,a){let u;"string"==typeof a?u=a.charCodeAt(0)||0:a.hasOwnProperty(Ah)&&(u=a[Ah]),null==u&&(u=a[Ah]=Vx++);const d=255&u;o.data[i+(d>>5)]|=1<<d}(i,o,a)}function Ux(i,o,a){if(a&Oe.Optional||void 0!==i)return i;he()}function $x(i,o,a,u){if(a&Oe.Optional&&void 0===u&&(u=null),0==(a&(Oe.Self|Oe.Host))){const d=i[9],g=le(void 0);try{return d?d.get(o,u,a&Oe.Optional):If(o,u,a&Oe.Optional)}finally{le(g)}}return Ux(u,0,a)}function Yf(i,o,a,u=Oe.Default,d){if(null!==i){if(1024&o[2]){const x=function qx(i,o,a,u,d){let g=i,x=o;for(;null!==g&&null!==x&&1024&x[2]&&!(256&x[2]);){const w=Hx(g,x,a,u|Oe.Self,Jn);if(w!==Jn)return w;let S=g.parent;if(!S){const P=x[21];if(P){const k=P.get(a,Jn,u);if(k!==Jn)return k}S=Yg(x),x=x[15]}g=S}return d}(i,o,a,u,Jn);if(x!==Jn)return x}const g=Hx(i,o,a,u,Jn);if(g!==Jn)return g}return $x(o,a,u,d)}function Hx(i,o,a,u,d){const g=function Jf(i){if("string"==typeof i)return i.charCodeAt(0)||0;const o=i.hasOwnProperty(Ah)?i[Ah]:void 0;return"number"==typeof o?o>=0?255&o:gu:o}(a);if("function"==typeof g){if(!uu(o,i,u))return u&Oe.Host?Ux(d,0,u):$x(o,a,u,d);try{const x=g(u);if(null!=x||u&Oe.Optional)return x;he()}finally{Gf()}}else if("number"==typeof g){let x=null,w=Xg(i,o),S=-1,P=u&Oe.Host?o[16][6]:null;for((-1===w||u&Oe.SkipSelf)&&(S=-1===w?Zf(i,o):o[w+8],-1!==S&&pa(u,!1)?(x=o[1],w=nc(S),o=pu(S,o)):w=-1);-1!==w;){const k=o[1];if(Gx(g,w,k.data)){const F=FD(w,o,a,x,u,P);if(F!==Jn)return F}S=o[w+8],-1!==S&&pa(u,o[1].data[w+8]===P)&&Gx(g,w,o)?(x=k,w=nc(S),o=pu(S,o)):w=-1}}return d}function FD(i,o,a,u,d,g){const x=o[1],w=x.data[i+8],k=function Kf(i,o,a,u,d){const g=i.providerIndexes,x=o.data,w=1048575&g,S=i.directiveStart,k=g>>20,G=d?w+k:i.directiveEnd;for(let J=u?w:w+k;J<G;J++){const ct=x[J];if(J<S&&a===ct||J>=S&&ct.type===a)return J}if(d){const J=x[S];if(J&&Jo(J)&&J.type===a)return S}return null}(w,x,a,null==u?Of(w)&&Wf:u!=x&&0!=(3&w.type),d&Oe.Host&&g===w);return null!==k?Oi(o,x,k,w):Jn}function Oi(i,o,a,u){let d=i[a];const g=o.data;if(function RD(i){return i instanceof Uh}(d)){const x=d;x.resolving&&function rx(i,o){const a=o?`. Dependency path: ${o.join(" > ")} > ${i}`:"";throw new ne(-200,`Circular dependency in DI detected for ${i}${a}`)}(Ln(g[a]));const w=qh(x.canSeeViewProviders);x.resolving=!0;const S=x.injectImpl?le(x.injectImpl):null;uu(i,u,Oe.Default);try{d=i[a]=x.factory(void 0,g,i,u),o.firstCreatePass&&a>=u.directiveStart&&function Ql(i,o,a){const{ngOnChanges:u,ngOnInit:d,ngDoCheck:g}=o.type.prototype;if(u){const x=Ag(o);(a.preOrderHooks||(a.preOrderHooks=[])).push(i,x),(a.preOrderCheckHooks||(a.preOrderCheckHooks=[])).push(i,x)}d&&(a.preOrderHooks||(a.preOrderHooks=[])).push(0-i,d),g&&((a.preOrderHooks||(a.preOrderHooks=[])).push(i,g),(a.preOrderCheckHooks||(a.preOrderCheckHooks=[])).push(i,g))}(a,g[a],o)}finally{null!==S&&le(S),qh(w),x.resolving=!1,Gf()}}return d}function Gx(i,o,a){return!!(a[o+(i>>5)]&1<<i)}function pa(i,o){return!(i&Oe.Self||i&Oe.Host&&o)}class Fi{constructor(o,a){this._tNode=o,this._lView=a}get(o,a,u){return Yf(this._tNode,this._lView,o,u,a)}}function gu(){return new Fi(qr(),At())}function Yg(i){const o=i[1],a=o.type;return 2===a?o.declTNode:1===a?i[6]:null}const Ht="__parameters__";function hl(i,o,a){return kr(()=>{const u=function Kg(i){return function(...a){if(i){const u=i(...a);for(const d in u)this[d]=u[d]}}}(o);function d(...g){if(this instanceof d)return u.apply(this,g),this;const x=new d(...g);return w.annotation=x,w;function w(S,P,k){const F=S.hasOwnProperty(Ht)?S[Ht]:Object.defineProperty(S,Ht,{value:[]})[Ht];for(;F.length<=k;)F.push(null);return(F[k]=F[k]||[]).push(x),S}}return a&&(d.prototype=Object.create(a.prototype)),d.prototype.ngMetadataName=i,d.annotationCls=d,d})}class $e{constructor(o,a){this._desc=o,this.ngMetadataName="InjectionToken",this.\u0275prov=void 0,"number"==typeof a?this.__NG_ELEMENT_ID__=a:void 0!==a&&(this.\u0275prov=Ue({token:this,providedIn:a.providedIn||"root",factory:a.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}}function xo(i,o){i.forEach(a=>Array.isArray(a)?xo(a,o):o(a))}function Jg(i,o,a){o>=i.length?i.push(a):i.splice(o,0,a)}function Wh(i,o){return o>=i.length-1?i.pop():i.splice(o,1)[0]}const sc={},Os="__NG_DI_FLAG__",ts="ngTempTokenPath",op=/\n/gm,sp="__source";let ac;function bo(i){const o=ac;return ac=i,o}function t_(i,o=Oe.Default){if(void 0===ac)throw new ne(-203,!1);return null===ac?If(i,void 0,o):ac.get(i,o&Oe.Optional?null:void 0,o)}function fe(i,o=Oe.Default){return(function Ji(){return Mh}()||t_)(Ge(i),o)}function yr(i,o=Oe.Default){return"number"!=typeof o&&(o=0|(o.optional&&8)|(o.host&&1)|(o.self&&2)|(o.skipSelf&&4)),fe(i,o)}function Fs(i){const o=[];for(let a=0;a<i.length;a++){const u=Ge(i[a]);if(Array.isArray(u)){if(0===u.length)throw new ne(900,!1);let d,g=Oe.Default;for(let x=0;x<u.length;x++){const w=u[x],S=e_(w);"number"==typeof S?-1===S?d=w.token:g|=S:d=w}o.push(fe(d,g))}else o.push(fe(u))}return o}function er(i,o){return i[Os]=o,i.prototype[Os]=o,i}function e_(i){return i[Os]}const lc=er(hl("Optional"),8),ga=er(hl("SkipSelf"),4);var io=(()=>((io=io||{})[io.Important=1]="Important",io[io.DashCase=2]="DashCase",io))();const hc=new Map;let bu=0;const f_="__ngContext__";function di(i,o){Ri(o)?(i[f_]=o[20],function es(i){hc.set(i[20],i)}(o)):i[f_]=o}function mp(i,o){return undefined(i,o)}function wu(i){const o=i[3];return _o(o)?o[3]:o}function fn(i){return oo(i[13])}function Qh(i){return oo(i[4])}function oo(i){for(;null!==i&&!_o(i);)i=i[4];return i}function fc(i,o,a,u,d){if(null!=u){let g,x=!1;_o(u)?g=u:Ri(u)&&(x=!0,u=u[0]);const w=hr(u);0===i&&null!==a?null==d?x_(o,a,w):gl(o,a,w,d||null,!0):1===i&&null!==a?gl(o,a,w,d||null,!0):2===i?function bp(i,o,a){const u=td(i,o);u&&function C1(i,o,a,u){i.removeChild(o,a,u)}(i,u,o,a)}(o,w,x):3===i&&o.destroyNode(w),null!=g&&function P1(i,o,a,u,d){const g=a[7];g!==hr(a)&&fc(o,i,u,g,d);for(let w=10;w<a.length;w++){const S=a[w];Eu(S[1],S,i,o,u,g)}}(o,i,g,a,d)}}function Xn(i,o,a){return i.createElement(o,a)}function g_(i,o){const a=i[9],u=a.indexOf(o),d=o[3];512&o[2]&&(o[2]&=-513,cu(d,-1)),a.splice(u,1)}function yp(i,o){if(i.length<=10)return;const a=10+o,u=i[a];if(u){const d=u[17];null!==d&&d!==i&&g_(d,u),o>0&&(i[a-1][4]=u[4]);const g=Wh(i,10+o);!function b1(i,o){Eu(i,o,o[11],2,null,null),o[0]=null,o[6]=null}(u[1],u);const x=g[19];null!==x&&x.detachView(g[1]),u[3]=null,u[4]=null,u[2]&=-65}return u}function ge(i,o){if(!(128&o[2])){const a=o[11];a.destroyNode&&Eu(i,o,a,3,null,null),function T1(i){let o=i[13];if(!o)return ve(i[1],i);for(;o;){let a=null;if(Ri(o))a=o[13];else{const u=o[10];u&&(a=u)}if(!a){for(;o&&!o[4]&&o!==i;)Ri(o)&&ve(o[1],o),o=o[3];null===o&&(o=i),Ri(o)&&ve(o[1],o),a=o&&o[4]}o=a}}(o)}}function ve(i,o){if(!(128&o[2])){o[2]&=-65,o[2]|=128,function va(i,o){let a;if(null!=i&&null!=(a=i.destroyHooks))for(let u=0;u<a.length;u+=2){const d=o[a[u]];if(!(d instanceof Uh)){const g=a[u+1];if(Array.isArray(g))for(let x=0;x<g.length;x+=2){const w=d[g[x]],S=g[x+1];try{S.call(w)}finally{}}else try{g.call(d)}finally{}}}}(i,o),function __(i,o){const a=i.cleanup,u=o[7];let d=-1;if(null!==a)for(let g=0;g<a.length-1;g+=2)if("string"==typeof a[g]){const x=a[g+1],w="function"==typeof x?x(o):hr(o[x]),S=u[d=a[g+2]],P=a[g+3];"boolean"==typeof P?w.removeEventListener(a[g],S,P):P>=0?u[d=P]():u[d=-P].unsubscribe(),g+=2}else{const x=u[d=a[g+1]];a[g].call(x)}if(null!==u){for(let g=d+1;g<u.length;g++)(0,u[g])();o[7]=null}}(i,o),1===o[1].type&&o[11].destroy();const a=o[17];if(null!==a&&_o(o[3])){a!==o[3]&&g_(a,o);const u=o[19];null!==u&&u.detachView(i)}!function dc(i){hc.delete(i[20])}(o)}}function y_(i,o,a){return function v_(i,o,a){let u=o;for(;null!==u&&40&u.type;)u=(o=u).parent;if(null===u)return a[0];if(2&u.flags){const d=i.data[u.directiveStart].encapsulation;if(d===Vn.None||d===Vn.Emulated)return null}return Li(u,a)}(i,o.parent,a)}function gl(i,o,a,u,d){i.insertBefore(o,a,u,d)}function x_(i,o,a){i.appendChild(o,a)}function b_(i,o,a,u,d){null!==u?gl(i,o,a,u,d):x_(i,o,a)}function td(i,o){return i.parentNode(o)}let Sp,I1=function Ns(i,o,a){return 40&i.type?Li(i,a):null};function Bi(i,o,a,u){const d=y_(i,u,o),g=o[11],w=function w_(i,o,a){return I1(i,o,a)}(u.parent||o[6],u,o);if(null!=d)if(Array.isArray(a))for(let S=0;S<a.length;S++)b_(g,d,a[S],w,!1);else b_(g,d,a,w,!1)}function ed(i,o){if(null!==o){const a=o.type;if(3&a)return Li(o,i);if(4&a)return xp(-1,i[o.index]);if(8&a){const u=o.child;if(null!==u)return ed(i,u);{const d=i[o.index];return _o(d)?xp(-1,d):hr(d)}}if(32&a)return mp(o,i)()||hr(i[o.index]);{const u=E_(i,o);return null!==u?Array.isArray(u)?u[0]:ed(wu(i[16]),u):ed(i,o.next)}}return null}function E_(i,o){return null!==o?i[16][6].projection[o.projection]:null}function xp(i,o){const a=10+i+1;if(a<o.length){const u=o[a],d=u[1].firstChild;if(null!==d)return ed(u,d)}return o[7]}function wp(i,o,a,u,d,g,x){for(;null!=a;){const w=u[a.index],S=a.type;if(x&&0===o&&(w&&di(hr(w),u),a.flags|=4),64!=(64&a.flags))if(8&S)wp(i,o,a.child,u,d,g,!1),fc(o,i,d,w,g);else if(32&S){const P=mp(a,u);let k;for(;k=P();)fc(o,i,d,k,g);fc(o,i,d,w,g)}else 16&S?T_(i,o,u,a,d,g):fc(o,i,d,w,g);a=x?a.projectionNext:a.next}}function Eu(i,o,a,u,d,g){wp(a,u,i.firstChild,o,d,g,!1)}function T_(i,o,a,u,d,g){const x=a[16],S=x[6].projection[u.projection];if(Array.isArray(S))for(let P=0;P<S.length;P++)fc(o,i,d,S[P],g);else wp(i,o,S,x[3],d,g,!0)}function Ep(i,o,a){i.setAttribute(o,"style",a)}function xa(i,o,a){""===a?i.removeAttribute(o,"class"):i.setAttribute(o,"class",a)}const ko=new $e("ENVIRONMENT_INITIALIZER"),q1=new $e("INJECTOR",-1),rd=new $e("INJECTOR_DEF_TYPES");class F_{get(o,a=sc){if(a===sc){const u=new Error(`NullInjectorError: No provider for ${In(o)}!`);throw u.name="NullInjectorError",u}return a}}function _l(...i){return{\u0275providers:z_(0,i)}}function z_(i,...o){const a=[],u=new Set;let d;return xo(o,g=>{const x=g;Oo(x,a,[],u)&&(d||(d=[]),d.push(x))}),void 0!==d&&W1(d,a),a}function W1(i,o){for(let a=0;a<i.length;a++){const{providers:d}=i[a];xo(d,g=>{o.push(g)})}}function Oo(i,o,a,u){if(!(i=Ge(i)))return!1;let d=null,g=Qc(i);const x=!g&&Pn(i);if(g||x){if(x&&!x.standalone)return!1;d=i}else{const S=i.ngModule;if(g=Qc(S),!g)return!1;d=S}const w=u.has(d);if(x){if(w)return!1;if(u.add(d),x.dependencies){const S="function"==typeof x.dependencies?x.dependencies():x.dependencies;for(const P of S)Oo(P,o,a,u)}}else{if(!g)return!1;{if(null!=g.imports&&!w){let P;u.add(d);try{xo(g.imports,k=>{Oo(k,o,a,u)&&(P||(P=[]),P.push(k))})}finally{}void 0!==P&&W1(P,o)}if(!w){const P=il(d)||(()=>new d);o.push({provide:d,useFactory:P,deps:An},{provide:rd,useValue:d,multi:!0},{provide:ko,useValue:()=>fe(d),multi:!0})}const S=g.providers;null==S||w||xo(S,k=>{o.push(k)})}}return d!==i&&void 0!==i.providers}const tn=_e({provide:String,useValue:_e});function gc(i){return null!==i&&"object"==typeof i&&tn in i}function ba(i){return"function"==typeof i}const Rp=new $e("Set Injector scope."),sd={},X1={};let is;function Tn(){return void 0===is&&(is=new F_),is}class Fo{}class wa extends Fo{constructor(o,a,u,d){super(),this.parent=a,this.source=u,this.scopes=d,this.records=new Map,this._ngOnDestroyHooks=new Set,this._onDestroyHooks=[],this._destroyed=!1,B_(o,x=>this.processProvider(x)),this.records.set(q1,pi(void 0,this)),d.has("environment")&&this.records.set(Fo,pi(void 0,this));const g=this.records.get(Rp);null!=g&&"string"==typeof g.value&&this.scopes.add(g.value),this.injectorDefTypes=new Set(this.get(rd.multi,An,Oe.Self))}get destroyed(){return this._destroyed}destroy(){this.assertNotDestroyed(),this._destroyed=!0;try{for(const o of this._ngOnDestroyHooks)o.ngOnDestroy();for(const o of this._onDestroyHooks)o()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),this._onDestroyHooks.length=0}}onDestroy(o){this._onDestroyHooks.push(o)}runInContext(o){this.assertNotDestroyed();const a=bo(this),u=le(void 0);try{return o()}finally{bo(a),le(u)}}get(o,a=sc,u=Oe.Default){this.assertNotDestroyed();const d=bo(this),g=le(void 0);try{if(!(u&Oe.SkipSelf)){let w=this.records.get(o);if(void 0===w){const S=function kp(i){return"function"==typeof i||"object"==typeof i&&i instanceof $e}(o)&&ci(o);w=S&&this.injectableDefInScope(S)?pi(ei(o),sd):null,this.records.set(o,w)}if(null!=w)return this.hydrate(o,w)}return(u&Oe.Self?Tn():this.parent).get(o,a=u&Oe.Optional&&a===sc?null:a)}catch(x){if("NullInjectorError"===x.name){if((x[ts]=x[ts]||[]).unshift(In(o)),d)throw x;return function n_(i,o,a,u){const d=i[ts];throw o[sp]&&d.unshift(o[sp]),i.message=function Kh(i,o,a,u=null){i=i&&"\n"===i.charAt(0)&&"\u0275"==i.charAt(1)?i.slice(2):i;let d=In(o);if(Array.isArray(o))d=o.map(In).join(" -> ");else if("object"==typeof o){let g=[];for(let x in o)if(o.hasOwnProperty(x)){let w=o[x];g.push(x+":"+("string"==typeof w?JSON.stringify(w):In(w)))}d=`{${g.join(", ")}}`}return`${a}${u?"("+u+")":""}[${d}]: ${i.replace(op,"\n  ")}`}("\n"+i.message,d,a,u),i.ngTokenPath=d,i[ts]=null,i}(x,o,"R3InjectorError",this.source)}throw x}finally{le(g),bo(d)}}resolveInjectorInitializers(){const o=bo(this),a=le(void 0);try{const u=this.get(ko.multi,An,Oe.Self);for(const d of u)d()}finally{bo(o),le(a)}}toString(){const o=[],a=this.records;for(const u of a.keys())o.push(In(u));return`R3Injector[${o.join(", ")}]`}assertNotDestroyed(){if(this._destroyed)throw new ne(205,!1)}processProvider(o){let a=ba(o=Ge(o))?o:Ge(o&&o.provide);const u=function Mu(i){return gc(i)?pi(void 0,i.useValue):pi(function Lp(i,o,a){let u;if(ba(i)){const d=Ge(i);return il(d)||ei(d)}if(gc(i))u=()=>Ge(i.useValue);else if(function id(i){return!(!i||!i.useFactory)}(i))u=()=>i.useFactory(...Fs(i.deps||[]));else if(function N_(i){return!(!i||!i.useExisting)}(i))u=()=>fe(Ge(i.useExisting));else{const d=Ge(i&&(i.useClass||i.provide));if(!function zo(i){return!!i.deps}(i))return il(d)||ei(d);u=()=>new d(...Fs(i.deps))}return u}(i),sd)}(o);if(ba(o)||!0!==o.multi)this.records.get(a);else{let d=this.records.get(a);d||(d=pi(void 0,sd,!0),d.factory=()=>Fs(d.multi),this.records.set(a,d)),a=o,d.multi.push(o)}this.records.set(a,u)}hydrate(o,a){return a.value===sd&&(a.value=X1,a.value=a.factory()),"object"==typeof a.value&&a.value&&function lS(i){return null!==i&&"object"==typeof i&&"function"==typeof i.ngOnDestroy}(a.value)&&this._ngOnDestroyHooks.add(a.value),a.value}injectableDefInScope(o){if(!o.providedIn)return!1;const a=Ge(o.providedIn);return"string"==typeof a?"any"===a||this.scopes.has(a):this.injectorDefTypes.has(a)}}function ei(i){const o=ci(i),a=null!==o?o.factory:il(i);if(null!==a)return a;if(i instanceof $e)throw new ne(204,!1);if(i instanceof Function)return function aS(i){const o=i.length;if(o>0)throw function Zh(i,o){const a=[];for(let u=0;u<i;u++)a.push(o);return a}(o,"?"),new ne(204,!1);const a=function Sh(i){const o=i&&(i[tu]||i[Ch]);if(o){const a=function wg(i){if(i.hasOwnProperty("name"))return i.name;const o=(""+i).match(/^function\s*([^\s(]+)/);return null===o?"":o[1]}(i);return console.warn(`DEPRECATED: DI is instantiating a token "${a}" that inherits its @Injectable decorator but does not provide one itself.\nThis will become an error in a future version of Angular. Please add @Injectable() to the "${a}" class.`),o}return null}(i);return null!==a?()=>a.factory(i):()=>new i}(i);throw new ne(204,!1)}function pi(i,o,a=!1){return{factory:i,value:o,multi:a?[]:void 0}}function Y1(i){return!!i.\u0275providers}function B_(i,o){for(const a of i)Array.isArray(a)?B_(a,o):Y1(a)?B_(a.\u0275providers,o):o(a)}class wo{}class U_{resolveComponentFactory(o){throw function Ea(i){const o=Error(`No component factory found for ${In(i)}. Did you add it to @NgModule.entryComponents?`);return o.ngComponent=i,o}(o)}}let yl=(()=>{class i{}return i.NULL=new U_,i})();function $_(){return os(qr(),At())}function os(i,o){return new Cr(Li(i,o))}let Cr=(()=>{class i{constructor(a){this.nativeElement=a}}return i.__NG_ELEMENT_ID__=$_,i})();class G_{}let W_=(()=>{class i{}return i.\u0275prov=Ue({token:i,providedIn:"root",factory:()=>null}),i})();class ld{constructor(o){this.full=o,this.major=o.split(".")[0],this.minor=o.split(".")[1],this.patch=o.split(".").slice(2).join(".")}}const K1=new ld("14.3.0"),Mr={};function Z_(i){return i.ngOriginalError}class Iu{constructor(){this._console=console}handleError(o){const a=this._findOriginalError(o);this._console.error("ERROR",o),a&&this._console.error("ORIGINAL ERROR",a)}_findOriginalError(o){let a=o&&Z_(o);for(;a&&Z_(a);)a=Z_(a);return a||null}}function as(i){return i instanceof Function?i():i}function Ur(i,o,a){let u=i.length;for(;;){const d=i.indexOf(o,a);if(-1===d)return d;if(0===d||i.charCodeAt(d-1)<=32){const g=o.length;if(d+g===u||i.charCodeAt(d+g)<=32)return d}a=d+1}}const Vi="ng-template";function dr(i,o,a){let u=0;for(;u<i.length;){let d=i[u++];if(a&&"class"===d){if(d=i[u],-1!==Ur(d.toLowerCase(),o,0))return!0}else if(1===d){for(;u<i.length&&"string"==typeof(d=i[u++]);)if(d.toLowerCase()===o)return!0;return!1}}return!1}function X_(i){return 4===i.type&&i.value!==Vi}function nr(i,o,a){return o===(4!==i.type||a?i.value:Vi)}function nb(i,o,a){let u=4;const d=i.attrs||[],g=function K_(i){for(let o=0;o<i.length;o++)if(Hg(i[o]))return o;return i.length}(d);let x=!1;for(let w=0;w<o.length;w++){const S=o[w];if("number"!=typeof S){if(!x)if(4&u){if(u=2|1&u,""!==S&&!nr(i,S,a)||""===S&&1===o.length){if(ni(u))return!1;x=!0}}else{const P=8&u?S:o[++w];if(8&u&&null!==i.attrs){if(!dr(i.attrs,P,a)){if(ni(u))return!1;x=!0}continue}const F=Y_(8&u?"class":S,d,X_(i),a);if(-1===F){if(ni(u))return!1;x=!0;continue}if(""!==P){let G;G=F>g?"":d[F+1].toLowerCase();const J=8&u?G:null;if(J&&-1!==Ur(J,P,0)||2&u&&P!==G){if(ni(u))return!1;x=!0}}}}else{if(!x&&!ni(u)&&!ni(S))return!1;if(x&&ni(S))continue;x=!1,u=S|1&u}}return ni(u)||x}function ni(i){return 0==(1&i)}function Y_(i,o,a,u){if(null===o)return-1;let d=0;if(u||!a){let g=!1;for(;d<o.length;){const x=o[d];if(x===i)return d;if(3===x||6===x)g=!0;else{if(1===x||2===x){let w=o[++d];for(;"string"==typeof w;)w=o[++d];continue}if(4===x)break;if(0===x){d+=4;continue}}d+=g?1:2}return-1}return function rb(i,o){let a=i.indexOf(4);if(a>-1)for(a++;a<i.length;){const u=i[a];if("number"==typeof u)return-1;if(u===o)return a;a++}return-1}(o,i)}function Au(i,o,a=!1){for(let u=0;u<o.length;u++)if(nb(i,o[u],a))return!0;return!1}function ib(i,o){return i?":not("+o.trim()+")":o}function Q_(i){let o=i[0],a=1,u=2,d="",g=!1;for(;a<i.length;){let x=i[a];if("string"==typeof x)if(2&u){const w=i[++a];d+="["+x+(w.length>0?'="'+w+'"':"")+"]"}else 8&u?d+="."+x:4&u&&(d+=" "+x);else""!==d&&!ni(x)&&(o+=ib(g,d),d=""),u=x,g=g||!ni(u);a++}return""!==d&&(o+=ib(g,d)),o}const ze={};function ny(i,o=null,a=null,u){const d=ry(i,o,a,u);return d.resolveInjectorInitializers(),d}function ry(i,o=null,a=null,u,d=new Set){const g=[a||An,_l(i)];return u=u||("object"==typeof i?void 0:In(i)),new wa(g,o||Tn(),u||null,d)}let Yr=(()=>{class i{static create(a,u){if(Array.isArray(a))return ny({name:""},u,a,"");{const d=a.name??"";return ny({name:d},a.parent,a.providers,d)}}}return i.THROW_IF_NOT_FOUND=sc,i.NULL=new F_,i.\u0275prov=Ue({token:i,providedIn:"any",factory:()=>fe(q1)}),i.__NG_ELEMENT_ID__=-1,i})();function Ie(i,o=Oe.Default){const a=At();return null===a?fe(i,o):Yf(qr(),a,Ge(i),o)}function fd(){throw new Error("invalid")}function yd(i,o){const a=i.contentQueries;if(null!==a)for(let u=0;u<a.length;u+=2){const d=a[u],g=a[u+1];if(-1!==g){const x=i.data[g];Ng(d),x.contentQueries(2,o[g],g)}}}function qp(i,o,a,u,d,g,x,w,S,P,k){const F=o.blueprint.slice();return F[0]=d,F[2]=76|u,(null!==k||i&&1024&i[2])&&(F[2]|=1024),wx(F),F[3]=F[15]=i,F[8]=a,F[10]=x||i&&i[10],F[11]=w||i&&i[11],F[12]=S||i&&i[12]||null,F[9]=P||i&&i[9]||null,F[6]=g,F[20]=function _a(){return bu++}(),F[21]=k,F[16]=2==o.type?i[16]:F,F}function _c(i,o,a,u,d){let g=i.data[o];if(null===g)g=function Fu(i,o,a,u,d){const g=Sx(),x=Fh(),S=i.data[o]=function ES(i,o,a,u,d,g){return{type:a,index:u,insertBeforeIndex:null,injectorIndex:o?o.injectorIndex:-1,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,propertyBindings:null,flags:0,providerIndexes:0,value:d,attrs:g,mergedAttrs:null,localNames:null,initialInputs:void 0,inputs:null,outputs:null,tViews:null,next:null,projectionNext:null,child:null,parent:o,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}(0,x?g:g&&g.parent,a,o,u,d);return null===i.firstChild&&(i.firstChild=S),null!==g&&(x?null==g.child&&null!==S.parent&&(g.child=S):null===g.next&&(g.next=S)),S}(i,o,a,u,d),function Kl(){return Qe.lFrame.inI18n}()&&(g.flags|=64);else if(64&g.type){g.type=a,g.value=u,g.attrs=d;const x=function Oh(){const i=Qe.lFrame,o=i.currentTNode;return i.isParent?o:o.parent}();g.injectorIndex=null===x?-1:x.injectorIndex}return Po(g,!0),g}function bn(i,o,a,u){if(0===a)return-1;const d=o.length;for(let g=0;g<a;g++)o.push(u),i.blueprint.push(u),i.data.push(null);return d}function vd(i,o,a){Bg(o);try{const u=i.viewQuery;null!==u&&wd(1,u,a);const d=i.template;null!==d&&Ty(i,o,d,1,a),i.firstCreatePass&&(i.firstCreatePass=!1),i.staticContentQueries&&yd(i,o),i.staticViewQueries&&wd(2,i.viewQuery,a);const g=i.components;null!==g&&function Ab(i,o){for(let a=0;a<o.length;a++)CS(i,o[a])}(o,g)}catch(u){throw i.firstCreatePass&&(i.incompleteFirstPass=!0,i.firstCreatePass=!1),u}finally{o[2]&=-5,hu()}}function xd(i,o,a,u){const d=o[2];if(128!=(128&d)){Bg(o);try{wx(o),function sl(i){return Qe.lFrame.bindingIndex=i}(i.bindingStartIndex),null!==a&&Ty(i,o,a,2,u);const x=3==(3&d);if(x){const P=i.preOrderCheckHooks;null!==P&&tc(o,P,null)}else{const P=i.preOrderHooks;null!==P&&du(o,P,0,null),fu(o,0)}if(function DS(i){for(let o=fn(i);null!==o;o=Qh(o)){if(!o[2])continue;const a=o[9];for(let u=0;u<a.length;u++){const d=a[u],g=d[3];0==(512&d[2])&&cu(g,1),d[2]|=512}}}(o),function TS(i){for(let o=fn(i);null!==o;o=Qh(o))for(let a=10;a<o.length;a++){const u=o[a],d=u[1];lu(u)&&xd(d,u,d.template,u[8])}}(o),null!==i.contentQueries&&yd(i,o),x){const P=i.contentCheckHooks;null!==P&&tc(o,P)}else{const P=i.contentHooks;null!==P&&du(o,P,1),fu(o,1)}!function Ey(i,o){const a=i.hostBindingOpCodes;if(null!==a)try{for(let u=0;u<a.length;u++){const d=a[u];if(d<0)Rs(~d);else{const g=d,x=a[++u],w=a[++u];Jl(x,g),w(2,o[g])}}}finally{Rs(-1)}}(i,o);const w=i.components;null!==w&&function Gp(i,o){for(let a=0;a<o.length;a++)SS(i,o[a])}(o,w);const S=i.viewQuery;if(null!==S&&wd(2,S,u),x){const P=i.viewCheckHooks;null!==P&&tc(o,P)}else{const P=i.viewHooks;null!==P&&du(o,P,2),fu(o,2)}!0===i.firstUpdatePass&&(i.firstUpdatePass=!1),o[2]&=-41,512&o[2]&&(o[2]&=-513,cu(o[3],-1))}finally{hu()}}}function Ty(i,o,a,u,d){const g=function Dr(){return Qe.lFrame.selectedIndex}(),x=2&u;try{Rs(-1),x&&o.length>22&&function ud(i,o,a,u){if(!u)if(3==(3&o[2])){const g=i.preOrderCheckHooks;null!==g&&tc(o,g,a)}else{const g=i.preOrderHooks;null!==g&&du(o,g,0,a)}Rs(a)}(i,o,22,!1),a(u,d)}finally{Rs(g)}}function Pb(i){const o=i.tView;return null===o||o.incompleteFirstPass?i.tView=Dy(1,null,i.template,i.decls,i.vars,i.directiveDefs,i.pipeDefs,i.viewQuery,i.schemas,i.consts):o}function Dy(i,o,a,u,d,g,x,w,S,P){const k=22+u,F=k+d,G=function bS(i,o){const a=[];for(let u=0;u<o;u++)a.push(u<i?null:ze);return a}(k,F),J="function"==typeof P?P():P;return G[1]={type:i,blueprint:G,template:a,queries:null,viewQuery:w,declTNode:o,data:G.slice().fill(null,k),bindingStartIndex:k,expandoStartIndex:F,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:"function"==typeof g?g():g,pipeRegistry:"function"==typeof x?x():x,firstChild:null,schemas:S,consts:J,incompleteFirstPass:!1}}function Lb(i,o,a){for(let u in i)if(i.hasOwnProperty(u)){const d=i[u];(a=null===a?{}:a).hasOwnProperty(u)?a[u].push(o,d):a[u]=[o,d]}return a}function kb(i,o){const u=o.directiveEnd,d=i.data,g=o.attrs,x=[];let w=null,S=null;for(let P=o.directiveStart;P<u;P++){const k=d[P],F=k.inputs,G=null===g||X_(o)?null:Vb(F,g);x.push(G),w=Lb(F,P,w),S=Lb(k.outputs,P,S)}null!==w&&(w.hasOwnProperty("class")&&(o.flags|=16),w.hasOwnProperty("style")&&(o.flags|=32)),o.initialInputs=x,o.inputs=w,o.outputs=S}function My(i,o,a,u,d,g){const x=g.hostBindings;if(x){let w=i.hostBindingOpCodes;null===w&&(w=i.hostBindingOpCodes=[]);const S=~o.index;(function Fb(i){let o=i.length;for(;o>0;){const a=i[--o];if("number"==typeof a&&a<0)return a}return 0})(w)!=S&&w.push(S),w.push(u,d,x)}}function Iy(i,o){null!==i.hostBindings&&i.hostBindings(1,o)}function Ay(i,o){o.flags|=2,(i.components||(i.components=[])).push(o.index)}function jb(i,o,a){if(a){if(o.exportAs)for(let u=0;u<o.exportAs.length;u++)a[o.exportAs[u]]=i;Jo(o)&&(a[""]=i)}}function Yp(i,o,a){i.flags|=1,i.directiveStart=o,i.directiveEnd=o+a,i.providerIndexes=o}function Kp(i,o,a,u,d){i.data[u]=d;const g=d.factory||(d.factory=il(d.type)),x=new Uh(g,Jo(d),Ie);i.blueprint[u]=x,a[u]=x,My(i,o,0,u,bn(i,a,d.hostVars,ze),d)}function yc(i,o,a){const u=Li(o,i),d=Pb(a),g=i[10],x=bd(i,qp(i,d,null,a.onPush?32:16,u,o,g,g.createRenderer(u,a),null,null,null));i[o.index]=x}function Py(i,o,a,u,d,g){const x=g[o];if(null!==x){const w=u.setInput;for(let S=0;S<x.length;){const P=x[S++],k=x[S++],F=x[S++];null!==w?u.setInput(a,F,P,k):a[k]=F}}}function Vb(i,o){let a=null,u=0;for(;u<o.length;){const d=o[u];if(0!==d)if(5!==d){if("number"==typeof d)break;i.hasOwnProperty(d)&&(null===a&&(a=[]),a.push(d,i[d],o[u+1])),u+=2}else u+=2;else u+=4}return a}function SS(i,o){const a=ki(o,i);if(lu(a)){const u=a[1];48&a[2]?xd(u,a,u.template,a[8]):a[5]>0&&Ry(a)}}function Ry(i){for(let u=fn(i);null!==u;u=Qh(u))for(let d=10;d<u.length;d++){const g=u[d];if(lu(g))if(512&g[2]){const x=g[1];xd(x,g,x.template,g[8])}else g[5]>0&&Ry(g)}const a=i[1].components;if(null!==a)for(let u=0;u<a.length;u++){const d=ki(a[u],i);lu(d)&&d[5]>0&&Ry(d)}}function CS(i,o){const a=ki(o,i),u=a[1];(function MS(i,o){for(let a=o.length;a<i.blueprint.length;a++)o.push(i.blueprint[a])})(u,a),vd(u,a,a[8])}function bd(i,o){return i[13]?i[14][4]=o:i[13]=o,i[14]=o,o}function fr(i,o,a,u=!0){const d=o[10];d.begin&&d.begin();try{xd(i,o,i.template,a)}catch(x){throw u&&function zu(i,o){const a=i[9],u=a?a.get(Iu,null):null;u&&u.handleError(o)}(o,x),x}finally{d.end&&d.end()}}function wd(i,o,a){Ng(0),o(i,a)}function ky(i,o,a,u,d){for(let g=0;g<a.length;){const x=a[g++],w=a[g++],S=o[x],P=i.data[x];null!==P.setInput?P.setInput(S,d,u,w):S[w]=d}}function Nu(i,o,a){let u=a?i.styles:null,d=a?i.classes:null,g=0;if(null!==o)for(let x=0;x<o.length;x++){const w=o[x];"number"==typeof w?g=w:1==g?d=Hl(d,w):2==g&&(u=Hl(u,w+": "+o[++x]+";"))}a?i.styles=u:i.stylesWithoutHost=u,a?i.classes=d:i.classesWithoutHost=d}function Qp(i,o,a,u,d=!1){for(;null!==a;){const g=o[a.index];if(null!==g&&u.push(hr(g)),_o(g))for(let w=10;w<g.length;w++){const S=g[w],P=S[1].firstChild;null!==P&&Qp(S[1],S,P,u)}const x=a.type;if(8&x)Qp(i,o,a.child,u);else if(32&x){const w=mp(a,o);let S;for(;S=w();)u.push(S)}else if(16&x){const w=E_(o,a);if(Array.isArray(w))u.push(...w);else{const S=wu(o[16]);Qp(S[1],S,w,u,!0)}}a=d?a.projectionNext:a.next}return u}class Ed{constructor(o,a){this._lView=o,this._cdRefInjectingView=a,this._appRef=null,this._attachedToViewContainer=!1}get rootNodes(){const o=this._lView,a=o[1];return Qp(a,o,a.firstChild,[])}get context(){return this._lView[8]}set context(o){this._lView[8]=o}get destroyed(){return 128==(128&this._lView[2])}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){const o=this._lView[3];if(_o(o)){const a=o[8],u=a?a.indexOf(this):-1;u>-1&&(yp(o,u),Wh(a,u))}this._attachedToViewContainer=!1}ge(this._lView[1],this._lView)}onDestroy(o){!function Rb(i,o,a,u){const d=function ls(i){return i[7]||(i[7]=[])}(o);null===a?d.push(u):(d.push(a),i.firstCreatePass&&function $b(i){return i.cleanup||(i.cleanup=[])}(i).push(u,d.length-1))}(this._lView[1],this._lView,null,o)}markForCheck(){!function Ly(i){for(;i;){i[2]|=32;const o=wu(i);if(cx(i)&&!o)return i;i=o}return null}(this._cdRefInjectingView||this._lView)}detach(){this._lView[2]&=-65}reattach(){this._lView[2]|=64}detectChanges(){fr(this._lView[1],this._lView,this.context)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new ne(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null,function E1(i,o){Eu(i,o,o[11],2,null,null)}(this._lView[1],this._lView)}attachToAppRef(o){if(this._attachedToViewContainer)throw new ne(902,!1);this._appRef=o}}class IS extends Ed{constructor(o){super(o),this._view=o}detectChanges(){const o=this._view;fr(o[1],o,o[8],!1)}checkNoChanges(){}get context(){return null}}class tm extends yl{constructor(o){super(),this.ngModule=o}resolveComponentFactory(o){const a=Pn(o);return new Bu(a,this.ngModule)}}function em(i){const o=[];for(let a in i)i.hasOwnProperty(a)&&o.push({propName:i[a],templateName:a});return o}class Oy{constructor(o,a){this.injector=o,this.parentInjector=a}get(o,a,u){const d=this.injector.get(o,Mr,u);return d!==Mr||a===Mr?d:this.parentInjector.get(o,a,u)}}class Bu extends wo{constructor(o,a){super(),this.componentDef=o,this.ngModule=a,this.componentType=o.type,this.selector=function ob(i){return i.map(Q_).join(",")}(o.selectors),this.ngContentSelectors=o.ngContentSelectors?o.ngContentSelectors:[],this.isBoundToModule=!!a}get inputs(){return em(this.componentDef.inputs)}get outputs(){return em(this.componentDef.outputs)}create(o,a,u,d){let g=(d=d||this.ngModule)instanceof Fo?d:d?.injector;g&&null!==this.componentDef.getStandaloneInjector&&(g=this.componentDef.getStandaloneInjector(g)||g);const x=g?new Oy(o,g):o,w=x.get(G_,null);if(null===w)throw new ne(407,!1);const S=x.get(W_,null),P=w.createRenderer(null,this.componentDef),k=this.componentDef.selectors[0][0]||"div",F=u?function wS(i,o,a){return i.selectRootElement(o,a===Vn.ShadowDom)}(P,u,this.componentDef.encapsulation):Xn(P,k,function Ui(i){const o=i.toLowerCase();return"svg"===o?"svg":"math"===o?"math":null}(k)),G=this.componentDef.onPush?288:272,J=Dy(0,null,null,1,0,null,null,null,null,null),ct=qp(null,J,null,G,null,null,w,P,S,x,null);let mt,St;Bg(ct);try{const Lt=function Fy(i,o,a,u,d,g){const x=a[1];a[22]=i;const S=_c(x,22,2,"#host",null),P=S.mergedAttrs=o.hostAttrs;null!==P&&(Nu(S,P,!0),null!==i&&(Hh(d,i,P),null!==S.classes&&xa(d,i,S.classes),null!==S.styles&&Ep(d,i,S.styles)));const k=u.createRenderer(i,o),F=qp(a,Pb(o),null,o.onPush?32:16,a[22],S,u,k,g||null,null,null);return x.firstCreatePass&&(Xf(mu(S,a),x,o.type),Ay(x,S),Yp(S,a.length,1)),bd(a,F),a[22]=F}(F,this.componentDef,ct,w,P);if(F)if(u)Hh(P,F,["ng-version",K1.full]);else{const{attrs:Qt,classes:Mt}=function fS(i){const o=[],a=[];let u=1,d=2;for(;u<i.length;){let g=i[u];if("string"==typeof g)2===d?""!==g&&o.push(g,i[++u]):8===d&&a.push(g);else{if(!ni(d))break;d=g}u++}return{attrs:o,classes:a}}(this.componentDef.selectors[0]);Qt&&Hh(P,F,Qt),Mt&&Mt.length>0&&xa(P,F,Mt.join(" "))}if(St=function kh(i,o){return i.data[o]}(J,22),void 0!==a){const Qt=St.projection=[];for(let Mt=0;Mt<this.ngContentSelectors.length;Mt++){const ke=a[Mt];Qt.push(null!=ke?Array.from(ke):null)}}mt=function nm(i,o,a,u){const d=a[1],g=function Ob(i,o,a){const u=qr();i.firstCreatePass&&(a.providersResolver&&a.providersResolver(a),Kp(i,u,o,bn(i,o,1,null),a),kb(i,u));const d=Oi(o,i,u.directiveStart,u);di(d,o);const g=Li(u,o);return g&&di(g,o),d}(d,a,o);if(i[8]=a[8]=g,null!==u)for(const w of u)w(g,o);if(o.contentQueries){const w=qr();o.contentQueries(1,g,w.directiveStart)}const x=qr();return!d.firstCreatePass||null===o.hostBindings&&null===o.hostAttrs||(Rs(x.index),My(a[1],x,0,x.directiveStart,x.directiveEnd,o),Iy(o,g)),g}(Lt,this.componentDef,ct,[PS]),vd(J,ct,null)}finally{hu()}return new Td(this.componentType,mt,os(St,ct),ct,St)}}class Td extends class j_{}{constructor(o,a,u,d,g){super(),this.location=u,this._rootLView=d,this._tNode=g,this.instance=a,this.hostView=this.changeDetectorRef=new IS(d),this.componentType=o}setInput(o,a){const u=this._tNode.inputs;let d;if(null!==u&&(d=u[o])){const g=this._rootLView;ky(g[1],g,d,o,a),function Sy(i,o){const a=ki(o,i);16&a[2]||(a[2]|=32)}(g,this._tNode.index)}}get injector(){return new Fi(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(o){this.hostView.onDestroy(o)}}function PS(){const i=qr();Vh(At()[1],i)}function hm(i,o,a,u,d){const x=d?"class":"style";ky(i,a,o.inputs[x],x,u)}function lo(i,o,a,u){const d=At(),g=Sn(),x=22+i,w=d[11],S=d[x]=Xn(w,o,function kx(){return Qe.lFrame.currentNamespace}()),P=g.firstCreatePass?function tw(i,o,a,u,d,g,x){const w=o.consts,P=_c(o,i,2,d,Ms(w,g));return function Cy(i,o,a,u){let d=!1;if(Ex()){const g=function Bb(i,o,a){const u=i.directiveRegistry;let d=null;if(u)for(let g=0;g<u.length;g++){const x=u[g];Au(a,x.selectors,!1)&&(d||(d=[]),Xf(mu(a,o),i,x.type),Jo(x)?(Ay(i,a),d.unshift(x)):d.push(x))}return d}(i,o,a),x=null===u?null:{"":-1};if(null!==g){d=!0,Yp(a,i.data.length,g.length);for(let k=0;k<g.length;k++){const F=g[k];F.providersResolver&&F.providersResolver(F)}let w=!1,S=!1,P=bn(i,o,g.length,null);for(let k=0;k<g.length;k++){const F=g[k];a.mergedAttrs=Gh(a.mergedAttrs,F.hostAttrs),Kp(i,a,o,P,F),jb(P,F,x),null!==F.contentQueries&&(a.flags|=8),(null!==F.hostBindings||null!==F.hostAttrs||0!==F.hostVars)&&(a.flags|=128);const G=F.type.prototype;!w&&(G.ngOnChanges||G.ngOnInit||G.ngDoCheck)&&((i.preOrderHooks||(i.preOrderHooks=[])).push(a.index),w=!0),!S&&(G.ngOnChanges||G.ngDoCheck)&&((i.preOrderCheckHooks||(i.preOrderCheckHooks=[])).push(a.index),S=!0),P++}kb(i,a)}x&&function Dl(i,o,a){if(o){const u=i.localNames=[];for(let d=0;d<o.length;d+=2){const g=a[o[d+1]];if(null==g)throw new ne(-301,!1);u.push(o[d],g)}}}(a,u,x)}return a.mergedAttrs=Gh(a.mergedAttrs,a.attrs),d}(o,a,P,Ms(w,x)),null!==P.attrs&&Nu(P,P.attrs,!1),null!==P.mergedAttrs&&Nu(P,P.mergedAttrs,!0),null!==o.queries&&o.queries.elementStart(o,P),P}(x,g,d,0,o,a,u):g.data[x];Po(P,!0);const k=P.mergedAttrs;null!==k&&Hh(w,S,k);const F=P.classes;null!==F&&xa(w,S,F);const G=P.styles;return null!==G&&Ep(w,S,G),64!=(64&P.flags)&&Bi(g,d,S,P),0===function Og(){return Qe.lFrame.elementDepthCount}()&&di(S,d),function CD(){Qe.lFrame.elementDepthCount++}(),function Ff(i){return 1==(1&i.flags)}(P)&&(function Tl(i,o,a){!Ex()||(function zb(i,o,a,u){const d=a.directiveStart,g=a.directiveEnd;i.firstCreatePass||mu(a,o),di(u,o);const x=a.initialInputs;for(let w=d;w<g;w++){const S=i.data[w],P=Jo(S);P&&yc(o,a,S);const k=Oi(o,i,w,a);di(k,o),null!==x&&Py(0,w-d,k,S,0,x),P&&(ki(a.index,o)[8]=k)}}(i,o,a,Li(a,o)),128==(128&a.flags)&&function Nb(i,o,a){const u=a.directiveStart,d=a.directiveEnd,g=a.index,x=function Mx(){return Qe.lFrame.currentDirectiveIndex}();try{Rs(g);for(let w=u;w<d;w++){const S=i.data[w],P=o[w];Nh(w),(null!==S.hostBindings||0!==S.hostVars||null!==S.hostAttrs)&&Iy(S,P)}}finally{Rs(-1),Nh(x)}}(i,o,a))}(g,d,P),function Gs(i,o,a){if(Cg(o)){const d=o.directiveEnd;for(let g=o.directiveStart;g<d;g++){const x=i.data[g];x.contentQueries&&x.contentQueries(1,a[g],g)}}}(g,P,d)),null!==u&&function Wp(i,o,a=Li){const u=o.localNames;if(null!==u){let d=o.index+1;for(let g=0;g<u.length;g+=2){const x=u[g+1],w=-1===x?a(o,i):i[x];i[d++]=w}}}(d,P),lo}function Eo(){let i=qr();Fh()?function zh(){Qe.lFrame.isParent=!1}():(i=i.parent,Po(i,!1));const o=i;!function Hf(){Qe.lFrame.elementDepthCount--}();const a=Sn();return a.firstCreatePass&&(Vh(a,i),Cg(i)&&a.queries.elementEnd(i)),null!=o.classesWithoutHost&&function zx(i){return 0!=(16&i.flags)}(o)&&hm(a,o,At(),o.classesWithoutHost,!0),null!=o.stylesWithoutHost&&function Nx(i){return 0!=(32&i.flags)}(o)&&hm(a,o,At(),o.stylesWithoutHost,!1),Eo}function Ti(i,o,a,u){return lo(i,o,a,u),Eo(),Ti}function wc(i){return!!i&&"function"==typeof i.then}const nw=function ew(i){return!!i&&"function"==typeof i.subscribe};function Ec(i,o=""){const a=At(),u=Sn(),d=i+22,g=u.firstCreatePass?_c(u,d,1,o,null):u.data[d],x=a[d]=function _p(i,o){return i.createText(o)}(a[11],o);Bi(u,a,x,g),Po(g,!1)}const Dc="en-US";let r0=Dc;class Al{}class E0{}class fE extends Al{constructor(o,a){super(),this._parent=a,this._bootstrapComponents=[],this.destroyCbs=[],this.componentFactoryResolver=new tm(this);const u=eo(o);this._bootstrapComponents=as(u.bootstrap),this._r3Injector=ry(o,a,[{provide:Al,useValue:this},{provide:yl,useValue:this.componentFactoryResolver}],In(o),new Set(["environment"])),this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(o)}get injector(){return this._r3Injector}destroy(){const o=this._r3Injector;!o.destroyed&&o.destroy(),this.destroyCbs.forEach(a=>a()),this.destroyCbs=null}onDestroy(o){this.destroyCbs.push(o)}}class T0 extends E0{constructor(o){super(),this.moduleType=o}create(o){return new fE(this.moduleType,o)}}class pE extends Al{constructor(o,a,u){super(),this.componentFactoryResolver=new tm(this),this.instance=null;const d=new wa([...o,{provide:Al,useValue:this},{provide:yl,useValue:this.componentFactoryResolver}],a||Tn(),u,new Set(["environment"]));this.injector=d,d.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(o){this.injector.onDestroy(o)}}function Do(i,o,a=null){return new pE(i,o,a).injector}let TC=(()=>{class i{constructor(a){this._injector=a,this.cachedInjectors=new Map}getOrCreateStandaloneInjector(a){if(!a.standalone)return null;if(!this.cachedInjectors.has(a.id)){const u=z_(0,a.type),d=u.length>0?Do([u],this._injector,`Standalone[${a.type.name}]`):null;this.cachedInjectors.set(a.id,d)}return this.cachedInjectors.get(a.id)}ngOnDestroy(){try{for(const a of this.cachedInjectors.values())null!==a&&a.destroy()}finally{this.cachedInjectors.clear()}}}return i.\u0275prov=Ue({token:i,providedIn:"environment",factory:()=>new i(fe(Fo))}),i})();function mE(i){i.getStandaloneInjector=o=>o.get(TC).getOrCreateStandaloneInjector(i)}function Wd(i){return o=>{setTimeout(i,void 0,o)}}const $r=class OC extends yi{constructor(o=!1){super(),this.__isAsync=o}emit(o){super.next(o)}subscribe(o,a,u){let d=o,g=a||(()=>null),x=u;if(o&&"object"==typeof o){const S=o;d=S.next?.bind(S),g=S.error?.bind(S),x=S.complete?.bind(S)}this.__isAsync&&(g=Wd(g),d&&(d=Wd(d)),x&&(x=Wd(x)));const w=super.subscribe({next:d,error:g,complete:x});return o instanceof it&&o.add(w),w}};let So=(()=>{class i{}return i.__NG_ELEMENT_ID__=k0,i})();function k0(){return function km(i,o){let a;const u=o[i.index];if(_o(u))a=u;else{let d;if(8&i.type)d=hr(u);else{const g=o[11];d=g.createComment("");const x=Li(i,o);gl(g,td(g,x),d,function M1(i,o){return i.nextSibling(o)}(g,x),!1)}o[i.index]=a=function Ub(i,o,a,u){return new Array(i,!0,!1,o,null,0,u,a,null,null)}(u,o,d,i),bd(o,a)}return new AE(a,i,o)}(qr(),At())}const O0=So,AE=class extends O0{constructor(o,a,u){super(),this._lContainer=o,this._hostTNode=a,this._hostLView=u}get element(){return os(this._hostTNode,this._hostLView)}get injector(){return new Fi(this._hostTNode,this._hostLView)}get parentInjector(){const o=Zf(this._hostTNode,this._hostLView);if(ec(o)){const a=pu(o,this._hostLView),u=nc(o);return new Fi(a[1].data[u+8],a)}return new Fi(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(o){const a=Rm(this._lContainer);return null!==a&&a[o]||null}get length(){return this._lContainer.length-10}createEmbeddedView(o,a,u){let d,g;"number"==typeof u?d=u:null!=u&&(d=u.index,g=u.injector);const x=o.createEmbeddedView(a||{},g);return this.insert(x,d),x}createComponent(o,a,u,d,g){const x=o&&!function wi(i){return"function"==typeof i}(o);let w;if(x)w=a;else{const F=a||{};w=F.index,u=F.injector,d=F.projectableNodes,g=F.environmentInjector||F.ngModuleRef}const S=x?o:new Bu(Pn(o)),P=u||this.parentInjector;if(!g&&null==S.ngModule){const G=(x?P:this.parentInjector).get(Fo,null);G&&(g=G)}const k=S.create(P,d,void 0,g);return this.insert(k.hostView,w),k}insert(o,a){const u=o._lView,d=u[1];if(function SD(i){return _o(i[3])}(u)){const k=this.indexOf(o);if(-1!==k)this.detach(k);else{const F=u[3],G=new AE(F,F[6],F[3]);G.detach(G.indexOf(o))}}const g=this._adjustIndex(a),x=this._lContainer;!function D1(i,o,a,u){const d=10+u,g=a.length;u>0&&(a[d-1][4]=o),u<g-10?(o[4]=a[d],Jg(a,10+u,o)):(a.push(o),o[4]=null),o[3]=a;const x=o[17];null!==x&&a!==x&&function S1(i,o){const a=i[9];o[16]!==o[3][3][16]&&(i[2]=!0),null===a?i[9]=[o]:a.push(o)}(x,o);const w=o[19];null!==w&&w.insertView(i),o[2]|=64}(d,u,x,g);const w=xp(g,x),S=u[11],P=td(S,x[7]);return null!==P&&function w1(i,o,a,u,d,g){u[0]=d,u[6]=o,Eu(i,u,a,1,d,g)}(d,x[6],S,u,P,w),o.attachToViewContainerRef(),Jg(Lm(x),g,o),o}move(o,a){return this.insert(o,a)}indexOf(o){const a=Rm(this._lContainer);return null!==a?a.indexOf(o):-1}remove(o){const a=this._adjustIndex(o,-1),u=yp(this._lContainer,a);u&&(Wh(Lm(this._lContainer),a),ge(u[1],u))}detach(o){const a=this._adjustIndex(o,-1),u=yp(this._lContainer,a);return u&&null!=Wh(Lm(this._lContainer),a)?new Ed(u):null}_adjustIndex(o,a=0){return o??this.length+a}};function Rm(i){return i[8]}function Lm(i){return i[8]||(i[8]=[])}function ef(...i){}const Lc=new $e("Application Initializer");let kc=(()=>{class i{constructor(a){this.appInits=a,this.resolve=ef,this.reject=ef,this.initialized=!1,this.done=!1,this.donePromise=new Promise((u,d)=>{this.resolve=u,this.reject=d})}runInitializers(){if(this.initialized)return;const a=[],u=()=>{this.done=!0,this.resolve()};if(this.appInits)for(let d=0;d<this.appInits.length;d++){const g=this.appInits[d]();if(wc(g))a.push(g);else if(nw(g)){const x=new Promise((w,S)=>{g.subscribe({complete:w,error:S})});a.push(x)}}Promise.all(a).then(()=>{u()}).catch(d=>{this.reject(d)}),0===a.length&&u(),this.initialized=!0}}return i.\u0275fac=function(a){return new(a||i)(fe(Lc,8))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();const uh=new $e("AppId",{providedIn:"root",factory:function Y0(){return`${hh()}${hh()}${hh()}`}});function hh(){return String.fromCharCode(97+Math.floor(25*Math.random()))}const cn=new $e("Platform Initializer"),K0=new $e("Platform ID",{providedIn:"platform",factory:()=>"unknown"}),GE=new $e("appBootstrapListener");let lM=(()=>{class i{log(a){console.log(a)}warn(a){console.warn(a)}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"platform"}),i})();const Ks=new $e("LocaleId",{providedIn:"root",factory:()=>yr(Ks,Oe.Optional|Oe.SkipSelf)||function qE(){return typeof $localize<"u"&&$localize.locale||Dc}()});class ZE{constructor(o,a){this.ngModuleFactory=o,this.componentFactories=a}}let Wm=(()=>{class i{compileModuleSync(a){return new T0(a)}compileModuleAsync(a){return Promise.resolve(this.compileModuleSync(a))}compileModuleAndAllComponentsSync(a){const u=this.compileModuleSync(a),g=as(eo(a).declarations).reduce((x,w)=>{const S=Pn(w);return S&&x.push(new Bu(S)),x},[]);return new ZE(u,g)}compileModuleAndAllComponentsAsync(a){return Promise.resolve(this.compileModuleAndAllComponentsSync(a))}clearCache(){}clearCacheFor(a){}getModuleId(a){}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();const dM=(()=>Promise.resolve(0))();function J0(i){typeof Zone>"u"?dM.then(()=>{i&&i.apply(null,null)}):Zone.current.scheduleMicroTask("scheduleMicrotask",i)}class Hr{constructor({enableLongStackTrace:o=!1,shouldCoalesceEventChangeDetection:a=!1,shouldCoalesceRunChangeDetection:u=!1}){if(this.hasPendingMacrotasks=!1,this.hasPendingMicrotasks=!1,this.isStable=!0,this.onUnstable=new $r(!1),this.onMicrotaskEmpty=new $r(!1),this.onStable=new $r(!1),this.onError=new $r(!1),typeof Zone>"u")throw new ne(908,!1);Zone.assertZonePatched();const d=this;if(d._nesting=0,d._outer=d._inner=Zone.current,Zone.AsyncStackTaggingZoneSpec){const g=Zone.AsyncStackTaggingZoneSpec;d._inner=d._inner.fork(new g("Angular"))}Zone.TaskTrackingZoneSpec&&(d._inner=d._inner.fork(new Zone.TaskTrackingZoneSpec)),o&&Zone.longStackTraceZoneSpec&&(d._inner=d._inner.fork(Zone.longStackTraceZoneSpec)),d.shouldCoalesceEventChangeDetection=!u&&a,d.shouldCoalesceRunChangeDetection=u,d.lastRequestAnimationFrameId=-1,d.nativeRequestAnimationFrame=function fM(){let i=Un.requestAnimationFrame,o=Un.cancelAnimationFrame;if(typeof Zone<"u"&&i&&o){const a=i[Zone.__symbol__("OriginalDelegate")];a&&(i=a);const u=o[Zone.__symbol__("OriginalDelegate")];u&&(o=u)}return{nativeRequestAnimationFrame:i,nativeCancelAnimationFrame:o}}().nativeRequestAnimationFrame,function pM(i){const o=()=>{!function tT(i){i.isCheckStableRunning||-1!==i.lastRequestAnimationFrameId||(i.lastRequestAnimationFrameId=i.nativeRequestAnimationFrame.call(Un,()=>{i.fakeTopEventTask||(i.fakeTopEventTask=Zone.root.scheduleEventTask("fakeTopEventTask",()=>{i.lastRequestAnimationFrameId=-1,tv(i),i.isCheckStableRunning=!0,Q0(i),i.isCheckStableRunning=!1},void 0,()=>{},()=>{})),i.fakeTopEventTask.invoke()}),tv(i))}(i)};i._inner=i._inner.fork({name:"angular",properties:{isAngularZone:!0},onInvokeTask:(a,u,d,g,x,w)=>{try{return ev(i),a.invokeTask(d,g,x,w)}finally{(i.shouldCoalesceEventChangeDetection&&"eventTask"===g.type||i.shouldCoalesceRunChangeDetection)&&o(),nv(i)}},onInvoke:(a,u,d,g,x,w,S)=>{try{return ev(i),a.invoke(d,g,x,w,S)}finally{i.shouldCoalesceRunChangeDetection&&o(),nv(i)}},onHasTask:(a,u,d,g)=>{a.hasTask(d,g),u===d&&("microTask"==g.change?(i._hasPendingMicrotasks=g.microTask,tv(i),Q0(i)):"macroTask"==g.change&&(i.hasPendingMacrotasks=g.macroTask))},onHandleError:(a,u,d,g)=>(a.handleError(d,g),i.runOutsideAngular(()=>i.onError.emit(g)),!1)})}(d)}static isInAngularZone(){return typeof Zone<"u"&&!0===Zone.current.get("isAngularZone")}static assertInAngularZone(){if(!Hr.isInAngularZone())throw new ne(909,!1)}static assertNotInAngularZone(){if(Hr.isInAngularZone())throw new ne(909,!1)}run(o,a,u){return this._inner.run(o,a,u)}runTask(o,a,u,d){const g=this._inner,x=g.scheduleEventTask("NgZoneEvent: "+d,o,QE,ef,ef);try{return g.runTask(x,a,u)}finally{g.cancelTask(x)}}runGuarded(o,a,u){return this._inner.runGuarded(o,a,u)}runOutsideAngular(o){return this._outer.run(o)}}const QE={};function Q0(i){if(0==i._nesting&&!i.hasPendingMicrotasks&&!i.isStable)try{i._nesting++,i.onMicrotaskEmpty.emit(null)}finally{if(i._nesting--,!i.hasPendingMicrotasks)try{i.runOutsideAngular(()=>i.onStable.emit(null))}finally{i.isStable=!0}}}function tv(i){i.hasPendingMicrotasks=!!(i._hasPendingMicrotasks||(i.shouldCoalesceEventChangeDetection||i.shouldCoalesceRunChangeDetection)&&-1!==i.lastRequestAnimationFrameId)}function ev(i){i._nesting++,i.isStable&&(i.isStable=!1,i.onUnstable.emit(null))}function nv(i){i._nesting--,Q0(i)}class mM{constructor(){this.hasPendingMicrotasks=!1,this.hasPendingMacrotasks=!1,this.isStable=!0,this.onUnstable=new $r,this.onMicrotaskEmpty=new $r,this.onStable=new $r,this.onError=new $r}run(o,a,u){return o.apply(a,u)}runGuarded(o,a,u){return o.apply(a,u)}runOutsideAngular(o){return o()}runTask(o,a,u,d){return o.apply(a,u)}}const eT=new $e(""),Zm=new $e("");let Ym,Xm=(()=>{class i{constructor(a,u,d){this._ngZone=a,this.registry=u,this._pendingCount=0,this._isZoneStable=!0,this._didWork=!1,this._callbacks=[],this.taskTrackingZone=null,Ym||(function gM(i){Ym=i}(d),d.addToWindow(u)),this._watchAngularEvents(),a.run(()=>{this.taskTrackingZone=typeof Zone>"u"?null:Zone.current.get("TaskTrackingZone")})}_watchAngularEvents(){this._ngZone.onUnstable.subscribe({next:()=>{this._didWork=!0,this._isZoneStable=!1}}),this._ngZone.runOutsideAngular(()=>{this._ngZone.onStable.subscribe({next:()=>{Hr.assertNotInAngularZone(),J0(()=>{this._isZoneStable=!0,this._runCallbacksIfReady()})}})})}increasePendingRequestCount(){return this._pendingCount+=1,this._didWork=!0,this._pendingCount}decreasePendingRequestCount(){if(this._pendingCount-=1,this._pendingCount<0)throw new Error("pending async requests below zero");return this._runCallbacksIfReady(),this._pendingCount}isStable(){return this._isZoneStable&&0===this._pendingCount&&!this._ngZone.hasPendingMacrotasks}_runCallbacksIfReady(){if(this.isStable())J0(()=>{for(;0!==this._callbacks.length;){let a=this._callbacks.pop();clearTimeout(a.timeoutId),a.doneCb(this._didWork)}this._didWork=!1});else{let a=this.getPendingTasks();this._callbacks=this._callbacks.filter(u=>!u.updateCb||!u.updateCb(a)||(clearTimeout(u.timeoutId),!1)),this._didWork=!0}}getPendingTasks(){return this.taskTrackingZone?this.taskTrackingZone.macroTasks.map(a=>({source:a.source,creationLocation:a.creationLocation,data:a.data})):[]}addCallback(a,u,d){let g=-1;u&&u>0&&(g=setTimeout(()=>{this._callbacks=this._callbacks.filter(x=>x.timeoutId!==g),a(this._didWork,this.getPendingTasks())},u)),this._callbacks.push({doneCb:a,timeoutId:g,updateCb:d})}whenStable(a,u,d){if(d&&!this.taskTrackingZone)throw new Error('Task tracking zone is required when passing an update callback to whenStable(). Is "zone.js/plugins/task-tracking" loaded?');this.addCallback(a,u,d),this._runCallbacksIfReady()}getPendingRequestCount(){return this._pendingCount}registerApplication(a){this.registry.registerApplication(a,this)}unregisterApplication(a){this.registry.unregisterApplication(a)}findProviders(a,u,d){return[]}}return i.\u0275fac=function(a){return new(a||i)(fe(Hr),fe(rv),fe(Zm))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})(),rv=(()=>{class i{constructor(){this._applications=new Map}registerApplication(a,u){this._applications.set(a,u)}unregisterApplication(a){this._applications.delete(a)}unregisterAllApplications(){this._applications.clear()}getTestability(a){return this._applications.get(a)||null}getAllTestabilities(){return Array.from(this._applications.values())}getAllRootElements(){return Array.from(this._applications.keys())}findTestabilityInTree(a,u=!0){return Ym?.findTestabilityInTree(this,a,u)??null}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"platform"}),i})(),Rl=null;const nT=new $e("AllowMultipleToken"),Km=new $e("PlatformDestroyListeners");class iT{constructor(o,a){this.name=o,this.token=a}}function oT(i,o,a=[]){const u=`Platform: ${o}`,d=new $e(u);return(g=[])=>{let x=av();if(!x||x.injector.get(nT,!1)){const w=[...a,...g,{provide:d,useValue:!0}];i?i(w):function uo(i){if(Rl&&!Rl.get(nT,!1))throw new ne(400,!1);Rl=i;const o=i.get(sT);(function ov(i){const o=i.get(cn,null);o&&o.forEach(a=>a())})(i)}(function sv(i=[],o){return Yr.create({name:o,providers:[{provide:Rp,useValue:"platform"},{provide:Km,useValue:new Set([()=>Rl=null])},...i]})}(w,u))}return function Jm(i){const o=av();if(!o)throw new ne(401,!1);return o}()}}function av(){return Rl?.get(sT)??null}let sT=(()=>{class i{constructor(a){this._injector=a,this._modules=[],this._destroyListeners=[],this._destroyed=!1}bootstrapModuleFactory(a,u){const d=function lv(i,o){let a;return a="noop"===i?new mM:("zone.js"===i?void 0:i)||new Hr(o),a}(u?.ngZone,function aT(i){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:!(!i||!i.ngZoneEventCoalescing)||!1,shouldCoalesceRunChangeDetection:!(!i||!i.ngZoneRunCoalescing)||!1}}(u)),g=[{provide:Hr,useValue:d}];return d.run(()=>{const x=Yr.create({providers:g,parent:this.injector,name:a.moduleType.name}),w=a.create(x),S=w.injector.get(Iu,null);if(!S)throw new ne(402,!1);return d.runOutsideAngular(()=>{const P=d.onError.subscribe({next:k=>{S.handleError(k)}});w.onDestroy(()=>{Ba(this._modules,w),P.unsubscribe()})}),function Qm(i,o,a){try{const u=a();return wc(u)?u.catch(d=>{throw o.runOutsideAngular(()=>i.handleError(d)),d}):u}catch(u){throw o.runOutsideAngular(()=>i.handleError(u)),u}}(S,d,()=>{const P=w.injector.get(kc);return P.runInitializers(),P.donePromise.then(()=>(function o0(i){De(i,"Expected localeId to be defined"),"string"==typeof i&&(r0=i.toLowerCase().replace(/_/g,"-"))}(w.injector.get(Ks,Dc)||Dc),this._moduleDoBootstrap(w),w))})})}bootstrapModule(a,u=[]){const d=cv({},u);return function rT(i,o,a){const u=new T0(a);return Promise.resolve(u)}(0,0,a).then(g=>this.bootstrapModuleFactory(g,d))}_moduleDoBootstrap(a){const u=a.injector.get(Oc);if(a._bootstrapComponents.length>0)a._bootstrapComponents.forEach(d=>u.bootstrap(d));else{if(!a.instance.ngDoBootstrap)throw new ne(403,!1);a.instance.ngDoBootstrap(u)}this._modules.push(a)}onDestroy(a){this._destroyListeners.push(a)}get injector(){return this._injector}destroy(){if(this._destroyed)throw new ne(404,!1);this._modules.slice().forEach(u=>u.destroy()),this._destroyListeners.forEach(u=>u());const a=this._injector.get(Km,null);a&&(a.forEach(u=>u()),a.clear()),this._destroyed=!0}get destroyed(){return this._destroyed}}return i.\u0275fac=function(a){return new(a||i)(fe(Yr))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"platform"}),i})();function cv(i,o){return Array.isArray(o)?o.reduce(cv,i):{...i,...o}}let Oc=(()=>{class i{constructor(a,u,d){this._zone=a,this._injector=u,this._exceptionHandler=d,this._bootstrapListeners=[],this._views=[],this._runningTick=!1,this._stable=!0,this._destroyed=!1,this._destroyListeners=[],this.componentTypes=[],this.components=[],this._onMicrotaskEmptySubscription=this._zone.onMicrotaskEmpty.subscribe({next:()=>{this._zone.run(()=>{this.tick()})}});const g=new Nn(w=>{this._stable=this._zone.isStable&&!this._zone.hasPendingMacrotasks&&!this._zone.hasPendingMicrotasks,this._zone.runOutsideAngular(()=>{w.next(this._stable),w.complete()})}),x=new Nn(w=>{let S;this._zone.runOutsideAngular(()=>{S=this._zone.onStable.subscribe(()=>{Hr.assertNotInAngularZone(),J0(()=>{!this._stable&&!this._zone.hasPendingMacrotasks&&!this._zone.hasPendingMicrotasks&&(this._stable=!0,w.next(!0))})})});const P=this._zone.onUnstable.subscribe(()=>{Hr.assertInAngularZone(),this._stable&&(this._stable=!1,this._zone.runOutsideAngular(()=>{w.next(!1)}))});return()=>{S.unsubscribe(),P.unsubscribe()}});this.isStable=function Df(...i){const o=Ka(i),a=function Jv(i,o){return"number"==typeof wf(i)?i.pop():o}(i,1/0),u=i;return u.length?1===u.length?mn(u[0]):Ya(a)(Lr(u,o)):Ss}(g,x.pipe(function $l(i={}){const{connector:o=(()=>new yi),resetOnError:a=!0,resetOnComplete:u=!0,resetOnRefCountZero:d=!0}=i;return g=>{let x,w,S,P=0,k=!1,F=!1;const G=()=>{w?.unsubscribe(),w=void 0},J=()=>{G(),x=S=void 0,k=F=!1},ct=()=>{const mt=x;J(),mt?.unsubscribe()};return Br((mt,St)=>{P++,!F&&!k&&G();const Lt=S=S??o();St.add(()=>{P--,0===P&&!F&&!k&&(w=me(ct,d))}),Lt.subscribe(St),!x&&P>0&&(x=new jl({next:Qt=>Lt.next(Qt),error:Qt=>{F=!0,G(),w=me(J,a,Qt),Lt.error(Qt)},complete:()=>{k=!0,G(),w=me(J,u),Lt.complete()}}),mn(mt).subscribe(x))})(g)}}()))}get destroyed(){return this._destroyed}get injector(){return this._injector}bootstrap(a,u){const d=a instanceof wo;if(!this._injector.get(kc).done)throw!d&&function Ko(i){const o=Pn(i)||Gr(i)||Ai(i);return null!==o&&o.standalone}(a),new ne(405,false);let x;x=d?a:this._injector.get(yl).resolveComponentFactory(a),this.componentTypes.push(x.componentType);const w=function _M(i){return i.isBoundToModule}(x)?void 0:this._injector.get(Al),P=x.create(Yr.NULL,[],u||x.selector,w),k=P.location.nativeElement,F=P.injector.get(eT,null);return F?.registerApplication(k),P.onDestroy(()=>{this.detachView(P.hostView),Ba(this.components,P),F?.unregisterApplication(k)}),this._loadComponent(P),P}tick(){if(this._runningTick)throw new ne(101,!1);try{this._runningTick=!0;for(let a of this._views)a.detectChanges()}catch(a){this._zone.runOutsideAngular(()=>this._exceptionHandler.handleError(a))}finally{this._runningTick=!1}}attachView(a){const u=a;this._views.push(u),u.attachToAppRef(this)}detachView(a){const u=a;Ba(this._views,u),u.detachFromAppRef()}_loadComponent(a){this.attachView(a.hostView),this.tick(),this.components.push(a),this._injector.get(GE,[]).concat(this._bootstrapListeners).forEach(d=>d(a))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(a=>a()),this._views.slice().forEach(a=>a.destroy()),this._onMicrotaskEmptySubscription.unsubscribe()}finally{this._destroyed=!0,this._views=[],this._bootstrapListeners=[],this._destroyListeners=[]}}onDestroy(a){return this._destroyListeners.push(a),()=>Ba(this._destroyListeners,a)}destroy(){if(this._destroyed)throw new ne(406,!1);const a=this._injector;a.destroy&&!a.destroyed&&a.destroy()}get viewCount(){return this._views.length}warnIfDestroyed(){}}return i.\u0275fac=function(a){return new(a||i)(fe(Hr),fe(Fo),fe(Iu))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();function Ba(i,o){const a=i.indexOf(o);a>-1&&i.splice(a,1)}let cT=!0,uv=(()=>{class i{}return i.__NG_ELEMENT_ID__=wM,i})();function wM(i){return function dT(i,o,a){if(Of(i)&&!a){const u=ki(i.index,o);return new Ed(u,u)}return 47&i.type?new Ed(o[16],o):null}(qr(),At(),16==(16&i))}const kM=oT(null,"core",[]);let _s=(()=>{class i{constructor(a){}}return i.\u0275fac=function(a){return new(a||i)(fe(Oc))},i.\u0275mod=Qr({type:i}),i.\u0275inj=Ki({}),i})(),eg=null;function kl(){return eg}const Hi=new $e("DocumentToken");let lf=(()=>{class i{historyGo(a){throw new Error("Not implemented")}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:function(){return function NM(){return fe(ng)}()},providedIn:"platform"}),i})();const BM=new $e("Location Initialized");let ng=(()=>{class i extends lf{constructor(a){super(),this._doc=a,this._init()}_init(){this.location=window.location,this._history=window.history}getBaseHrefFromDOM(){return kl().getBaseHref(this._doc)}onPopState(a){const u=kl().getGlobalEventTarget(this._doc,"window");return u.addEventListener("popstate",a,!1),()=>u.removeEventListener("popstate",a)}onHashChange(a){const u=kl().getGlobalEventTarget(this._doc,"window");return u.addEventListener("hashchange",a,!1),()=>u.removeEventListener("hashchange",a)}get href(){return this.location.href}get protocol(){return this.location.protocol}get hostname(){return this.location.hostname}get port(){return this.location.port}get pathname(){return this.location.pathname}get search(){return this.location.search}get hash(){return this.location.hash}set pathname(a){this.location.pathname=a}pushState(a,u,d){wT()?this._history.pushState(a,u,d):this.location.hash=d}replaceState(a,u,d){wT()?this._history.replaceState(a,u,d):this.location.hash=d}forward(){this._history.forward()}back(){this._history.back()}historyGo(a=0){this._history.go(a)}getState(){return this._history.state}}return i.\u0275fac=function(a){return new(a||i)(fe(Hi))},i.\u0275prov=Ue({token:i,factory:function(){return function ET(){return new ng(fe(Hi))}()},providedIn:"platform"}),i})();function wT(){return!!window.history.pushState}function rg(i,o){if(0==i.length)return o;if(0==o.length)return i;let a=0;return i.endsWith("/")&&a++,o.startsWith("/")&&a++,2==a?i+o.substring(1):1==a?i+o:i+"/"+o}function TT(i){const o=i.match(/#|\?|$/),a=o&&o.index||i.length;return i.slice(0,a-("/"===i[a-1]?1:0))+i.slice(a)}function ys(i){return i&&"?"!==i[0]?"?"+i:i}let Qs=(()=>{class i{historyGo(a){throw new Error("Not implemented")}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:function(){return yr(DT)},providedIn:"root"}),i})();const xv=new $e("appBaseHref");let DT=(()=>{class i extends Qs{constructor(a,u){super(),this._platformLocation=a,this._removeListenerFns=[],this._baseHref=u??this._platformLocation.getBaseHrefFromDOM()??yr(Hi).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(a){this._removeListenerFns.push(this._platformLocation.onPopState(a),this._platformLocation.onHashChange(a))}getBaseHref(){return this._baseHref}prepareExternalUrl(a){return rg(this._baseHref,a)}path(a=!1){const u=this._platformLocation.pathname+ys(this._platformLocation.search),d=this._platformLocation.hash;return d&&a?`${u}${d}`:u}pushState(a,u,d,g){const x=this.prepareExternalUrl(d+ys(g));this._platformLocation.pushState(a,u,x)}replaceState(a,u,d,g){const x=this.prepareExternalUrl(d+ys(g));this._platformLocation.replaceState(a,u,x)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(a=0){this._platformLocation.historyGo?.(a)}}return i.\u0275fac=function(a){return new(a||i)(fe(lf),fe(xv,8))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})(),ST=(()=>{class i extends Qs{constructor(a,u){super(),this._platformLocation=a,this._baseHref="",this._removeListenerFns=[],null!=u&&(this._baseHref=u)}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(a){this._removeListenerFns.push(this._platformLocation.onPopState(a),this._platformLocation.onHashChange(a))}getBaseHref(){return this._baseHref}path(a=!1){let u=this._platformLocation.hash;return null==u&&(u="#"),u.length>0?u.substring(1):u}prepareExternalUrl(a){const u=rg(this._baseHref,a);return u.length>0?"#"+u:u}pushState(a,u,d,g){let x=this.prepareExternalUrl(d+ys(g));0==x.length&&(x=this._platformLocation.pathname),this._platformLocation.pushState(a,u,x)}replaceState(a,u,d,g){let x=this.prepareExternalUrl(d+ys(g));0==x.length&&(x=this._platformLocation.pathname),this._platformLocation.replaceState(a,u,x)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(a=0){this._platformLocation.historyGo?.(a)}}return i.\u0275fac=function(a){return new(a||i)(fe(lf),fe(xv,8))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})(),bv=(()=>{class i{constructor(a){this._subject=new $r,this._urlChangeListeners=[],this._urlChangeSubscription=null,this._locationStrategy=a;const u=this._locationStrategy.getBaseHref();this._baseHref=TT(CT(u)),this._locationStrategy.onPopState(d=>{this._subject.emit({url:this.path(!0),pop:!0,state:d.state,type:d.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(a=!1){return this.normalize(this._locationStrategy.path(a))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(a,u=""){return this.path()==this.normalize(a+ys(u))}normalize(a){return i.stripTrailingSlash(function jM(i,o){return i&&o.startsWith(i)?o.substring(i.length):o}(this._baseHref,CT(a)))}prepareExternalUrl(a){return a&&"/"!==a[0]&&(a="/"+a),this._locationStrategy.prepareExternalUrl(a)}go(a,u="",d=null){this._locationStrategy.pushState(d,"",a,u),this._notifyUrlChangeListeners(this.prepareExternalUrl(a+ys(u)),d)}replaceState(a,u="",d=null){this._locationStrategy.replaceState(d,"",a,u),this._notifyUrlChangeListeners(this.prepareExternalUrl(a+ys(u)),d)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(a=0){this._locationStrategy.historyGo?.(a)}onUrlChange(a){return this._urlChangeListeners.push(a),this._urlChangeSubscription||(this._urlChangeSubscription=this.subscribe(u=>{this._notifyUrlChangeListeners(u.url,u.state)})),()=>{const u=this._urlChangeListeners.indexOf(a);this._urlChangeListeners.splice(u,1),0===this._urlChangeListeners.length&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(a="",u){this._urlChangeListeners.forEach(d=>d(a,u))}subscribe(a,u,d){return this._subject.subscribe({next:a,error:u,complete:d})}}return i.normalizeQueryParams=ys,i.joinWithSlash=rg,i.stripTrailingSlash=TT,i.\u0275fac=function(a){return new(a||i)(fe(Qs))},i.\u0275prov=Ue({token:i,factory:function(){return function wv(){return new bv(fe(Qs))}()},providedIn:"root"}),i})();function CT(i){return i.replace(/\/index.html$/,"")}function pe(i,o){o=encodeURIComponent(o);for(const a of i.split(";")){const u=a.indexOf("="),[d,g]=-1==u?[a,""]:[a.slice(0,u),a.slice(u+1)];if(d.trim()===o)return decodeURIComponent(g)}return null}let cR=(()=>{class i{}return i.\u0275fac=function(a){return new(a||i)},i.\u0275mod=Qr({type:i}),i.\u0275inj=Ki({}),i})();let fR=(()=>{class i{}return i.\u0275prov=Ue({token:i,providedIn:"root",factory:()=>new pR(fe(Hi),window)}),i})();class pR{constructor(o,a){this.document=o,this.window=a,this.offset=()=>[0,0]}setOffset(o){this.offset=Array.isArray(o)?()=>o:o}getScrollPosition(){return this.supportsScrolling()?[this.window.pageXOffset,this.window.pageYOffset]:[0,0]}scrollToPosition(o){this.supportsScrolling()&&this.window.scrollTo(o[0],o[1])}scrollToAnchor(o){if(!this.supportsScrolling())return;const a=function mR(i,o){const a=i.getElementById(o)||i.getElementsByName(o)[0];if(a)return a;if("function"==typeof i.createTreeWalker&&i.body&&(i.body.createShadowRoot||i.body.attachShadow)){const u=i.createTreeWalker(i.body,NodeFilter.SHOW_ELEMENT);let d=u.currentNode;for(;d;){const g=d.shadowRoot;if(g){const x=g.getElementById(o)||g.querySelector(`[name="${o}"]`);if(x)return x}d=u.nextNode()}}return null}(this.document,o);a&&(this.scrollToElement(a),a.focus())}setHistoryScrollRestoration(o){if(this.supportScrollRestoration()){const a=this.window.history;a&&a.scrollRestoration&&(a.scrollRestoration=o)}}scrollToElement(o){const a=o.getBoundingClientRect(),u=a.left+this.window.pageXOffset,d=a.top+this.window.pageYOffset,g=this.offset();this.window.scrollTo(u-g[0],d-g[1])}supportScrollRestoration(){try{if(!this.supportsScrolling())return!1;const o=h2(this.window.history)||h2(Object.getPrototypeOf(this.window.history));return!(!o||!o.writable&&!o.set)}catch{return!1}}supportsScrolling(){try{return!!this.window&&!!this.window.scrollTo&&"pageXOffset"in this.window}catch{return!1}}}function h2(i){return Object.getOwnPropertyDescriptor(i,"scrollRestoration")}class d2{}class oI extends class UR extends class vv{}{constructor(){super(...arguments),this.supportsDOMEvents=!0}}{static makeCurrent(){!function zM(i){eg||(eg=i)}(new oI)}onAndCancel(o,a,u){return o.addEventListener(a,u,!1),()=>{o.removeEventListener(a,u,!1)}}dispatchEvent(o,a){o.dispatchEvent(a)}remove(o){o.parentNode&&o.parentNode.removeChild(o)}createElement(o,a){return(a=a||this.getDefaultDocument()).createElement(o)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(o){return o.nodeType===Node.ELEMENT_NODE}isShadowRoot(o){return o instanceof DocumentFragment}getGlobalEventTarget(o,a){return"window"===a?window:"document"===a?o:"body"===a?o.body:null}getBaseHref(o){const a=function $R(){return Lv=Lv||document.querySelector("base"),Lv?Lv.getAttribute("href"):null}();return null==a?null:function HR(i){jT=jT||document.createElement("a"),jT.setAttribute("href",i);const o=jT.pathname;return"/"===o.charAt(0)?o:`/${o}`}(a)}resetBaseElement(){Lv=null}getUserAgent(){return window.navigator.userAgent}getCookie(o){return pe(document.cookie,o)}}let jT,Lv=null;const _2=new $e("TRANSITION_ID"),qR=[{provide:Lc,useFactory:function GR(i,o,a){return()=>{a.get(kc).donePromise.then(()=>{const u=kl(),d=o.querySelectorAll(`style[ng-transition="${i}"]`);for(let g=0;g<d.length;g++)u.remove(d[g])})}},deps:[_2,Hi,Yr],multi:!0}];let ZR=(()=>{class i{build(){return new XMLHttpRequest}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();const VT=new $e("EventManagerPlugins");let UT=(()=>{class i{constructor(a,u){this._zone=u,this._eventNameToPlugin=new Map,a.forEach(d=>d.manager=this),this._plugins=a.slice().reverse()}addEventListener(a,u,d){return this._findPluginFor(u).addEventListener(a,u,d)}addGlobalEventListener(a,u,d){return this._findPluginFor(u).addGlobalEventListener(a,u,d)}getZone(){return this._zone}_findPluginFor(a){const u=this._eventNameToPlugin.get(a);if(u)return u;const d=this._plugins;for(let g=0;g<d.length;g++){const x=d[g];if(x.supports(a))return this._eventNameToPlugin.set(a,x),x}throw new Error(`No event manager plugin found for event ${a}`)}}return i.\u0275fac=function(a){return new(a||i)(fe(VT),fe(Hr))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();class y2{constructor(o){this._doc=o}addGlobalEventListener(o,a,u){const d=kl().getGlobalEventTarget(this._doc,o);if(!d)throw new Error(`Unsupported event target ${d} for event ${a}`);return this.addEventListener(d,a,u)}}let v2=(()=>{class i{constructor(){this._stylesSet=new Set}addStyles(a){const u=new Set;a.forEach(d=>{this._stylesSet.has(d)||(this._stylesSet.add(d),u.add(d))}),this.onStylesAdded(u)}onStylesAdded(a){}getAllStyles(){return Array.from(this._stylesSet)}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})(),kv=(()=>{class i extends v2{constructor(a){super(),this._doc=a,this._hostNodes=new Map,this._hostNodes.set(a.head,[])}_addStylesToHost(a,u,d){a.forEach(g=>{const x=this._doc.createElement("style");x.textContent=g,d.push(u.appendChild(x))})}addHost(a){const u=[];this._addStylesToHost(this._stylesSet,a,u),this._hostNodes.set(a,u)}removeHost(a){const u=this._hostNodes.get(a);u&&u.forEach(x2),this._hostNodes.delete(a)}onStylesAdded(a){this._hostNodes.forEach((u,d)=>{this._addStylesToHost(a,d,u)})}ngOnDestroy(){this._hostNodes.forEach(a=>a.forEach(x2))}}return i.\u0275fac=function(a){return new(a||i)(fe(Hi))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();function x2(i){kl().remove(i)}const sI={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/MathML/"},aI=/%COMP%/g;function $T(i,o,a){for(let u=0;u<o.length;u++){let d=o[u];Array.isArray(d)?$T(i,d,a):(d=d.replace(aI,i),a.push(d))}return a}function E2(i){return o=>{if("__ngUnwrap__"===o)return i;!1===i(o)&&(o.preventDefault(),o.returnValue=!1)}}let lI=(()=>{class i{constructor(a,u,d){this.eventManager=a,this.sharedStylesHost=u,this.appId=d,this.rendererByCompId=new Map,this.defaultRenderer=new cI(a)}createRenderer(a,u){if(!a||!u)return this.defaultRenderer;switch(u.encapsulation){case Vn.Emulated:{let d=this.rendererByCompId.get(u.id);return d||(d=new tL(this.eventManager,this.sharedStylesHost,u,this.appId),this.rendererByCompId.set(u.id,d)),d.applyToHost(a),d}case 1:case Vn.ShadowDom:return new eL(this.eventManager,this.sharedStylesHost,a,u);default:if(!this.rendererByCompId.has(u.id)){const d=$T(u.id,u.styles,[]);this.sharedStylesHost.addStyles(d),this.rendererByCompId.set(u.id,this.defaultRenderer)}return this.defaultRenderer}}begin(){}end(){}}return i.\u0275fac=function(a){return new(a||i)(fe(UT),fe(kv),fe(uh))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();class cI{constructor(o){this.eventManager=o,this.data=Object.create(null),this.destroyNode=null}destroy(){}createElement(o,a){return a?document.createElementNS(sI[a]||a,o):document.createElement(o)}createComment(o){return document.createComment(o)}createText(o){return document.createTextNode(o)}appendChild(o,a){(D2(o)?o.content:o).appendChild(a)}insertBefore(o,a,u){o&&(D2(o)?o.content:o).insertBefore(a,u)}removeChild(o,a){o&&o.removeChild(a)}selectRootElement(o,a){let u="string"==typeof o?document.querySelector(o):o;if(!u)throw new Error(`The selector "${o}" did not match any elements`);return a||(u.textContent=""),u}parentNode(o){return o.parentNode}nextSibling(o){return o.nextSibling}setAttribute(o,a,u,d){if(d){a=d+":"+a;const g=sI[d];g?o.setAttributeNS(g,a,u):o.setAttribute(a,u)}else o.setAttribute(a,u)}removeAttribute(o,a,u){if(u){const d=sI[u];d?o.removeAttributeNS(d,a):o.removeAttribute(`${u}:${a}`)}else o.removeAttribute(a)}addClass(o,a){o.classList.add(a)}removeClass(o,a){o.classList.remove(a)}setStyle(o,a,u,d){d&(io.DashCase|io.Important)?o.style.setProperty(a,u,d&io.Important?"important":""):o.style[a]=u}removeStyle(o,a,u){u&io.DashCase?o.style.removeProperty(a):o.style[a]=""}setProperty(o,a,u){o[a]=u}setValue(o,a){o.nodeValue=a}listen(o,a,u){return"string"==typeof o?this.eventManager.addGlobalEventListener(o,a,E2(u)):this.eventManager.addEventListener(o,a,E2(u))}}function D2(i){return"TEMPLATE"===i.tagName&&void 0!==i.content}class tL extends cI{constructor(o,a,u,d){super(o),this.component=u;const g=$T(d+"-"+u.id,u.styles,[]);a.addStyles(g),this.contentAttr=function KR(i){return"_ngcontent-%COMP%".replace(aI,i)}(d+"-"+u.id),this.hostAttr=function JR(i){return"_nghost-%COMP%".replace(aI,i)}(d+"-"+u.id)}applyToHost(o){super.setAttribute(o,this.hostAttr,"")}createElement(o,a){const u=super.createElement(o,a);return super.setAttribute(u,this.contentAttr,""),u}}class eL extends cI{constructor(o,a,u,d){super(o),this.sharedStylesHost=a,this.hostEl=u,this.shadowRoot=u.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);const g=$T(d.id,d.styles,[]);for(let x=0;x<g.length;x++){const w=document.createElement("style");w.textContent=g[x],this.shadowRoot.appendChild(w)}}nodeOrShadowRoot(o){return o===this.hostEl?this.shadowRoot:o}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}appendChild(o,a){return super.appendChild(this.nodeOrShadowRoot(o),a)}insertBefore(o,a,u){return super.insertBefore(this.nodeOrShadowRoot(o),a,u)}removeChild(o,a){return super.removeChild(this.nodeOrShadowRoot(o),a)}parentNode(o){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(o)))}}let nL=(()=>{class i extends y2{constructor(a){super(a)}supports(a){return!0}addEventListener(a,u,d){return a.addEventListener(u,d,!1),()=>this.removeEventListener(a,u,d)}removeEventListener(a,u,d){return a.removeEventListener(u,d)}}return i.\u0275fac=function(a){return new(a||i)(fe(Hi))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();const S2=["alt","control","meta","shift"],rL={"\b":"Backspace","\t":"Tab","\x7f":"Delete","\x1b":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},iL={alt:i=>i.altKey,control:i=>i.ctrlKey,meta:i=>i.metaKey,shift:i=>i.shiftKey};let oL=(()=>{class i extends y2{constructor(a){super(a)}supports(a){return null!=i.parseEventName(a)}addEventListener(a,u,d){const g=i.parseEventName(u),x=i.eventCallback(g.fullKey,d,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>kl().onAndCancel(a,g.domEventName,x))}static parseEventName(a){const u=a.toLowerCase().split("."),d=u.shift();if(0===u.length||"keydown"!==d&&"keyup"!==d)return null;const g=i._normalizeKey(u.pop());let x="",w=u.indexOf("code");if(w>-1&&(u.splice(w,1),x="code."),S2.forEach(P=>{const k=u.indexOf(P);k>-1&&(u.splice(k,1),x+=P+".")}),x+=g,0!=u.length||0===g.length)return null;const S={};return S.domEventName=d,S.fullKey=x,S}static matchEventFullKeyCode(a,u){let d=rL[a.key]||a.key,g="";return u.indexOf("code.")>-1&&(d=a.code,g="code."),!(null==d||!d)&&(d=d.toLowerCase()," "===d?d="space":"."===d&&(d="dot"),S2.forEach(x=>{x!==d&&(0,iL[x])(a)&&(g+=x+".")}),g+=d,g===u)}static eventCallback(a,u,d){return g=>{i.matchEventFullKeyCode(g,a)&&d.runGuarded(()=>u(g))}}static _normalizeKey(a){return"esc"===a?"escape":a}}return i.\u0275fac=function(a){return new(a||i)(fe(Hi))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();const cL=oT(kM,"browser",[{provide:K0,useValue:"browser"},{provide:cn,useValue:function sL(){oI.makeCurrent()},multi:!0},{provide:Hi,useFactory:function lL(){return function O1(i){Sp=i}(document),document},deps:[]}]),I2=new $e(""),A2=[{provide:Zm,useClass:class WR{addToWindow(o){Un.getAngularTestability=(u,d=!0)=>{const g=o.findTestabilityInTree(u,d);if(null==g)throw new Error("Could not find testability for element.");return g},Un.getAllAngularTestabilities=()=>o.getAllTestabilities(),Un.getAllAngularRootElements=()=>o.getAllRootElements(),Un.frameworkStabilizers||(Un.frameworkStabilizers=[]),Un.frameworkStabilizers.push(u=>{const d=Un.getAllAngularTestabilities();let g=d.length,x=!1;const w=function(S){x=x||S,g--,0==g&&u(x)};d.forEach(function(S){S.whenStable(w)})})}findTestabilityInTree(o,a,u){return null==a?null:o.getTestability(a)??(u?kl().isShadowRoot(a)?this.findTestabilityInTree(o,a.host,!0):this.findTestabilityInTree(o,a.parentElement,!0):null)}},deps:[]},{provide:eT,useClass:Xm,deps:[Hr,rv,Zm]},{provide:Xm,useClass:Xm,deps:[Hr,rv,Zm]}],P2=[{provide:Rp,useValue:"root"},{provide:Iu,useFactory:function aL(){return new Iu},deps:[]},{provide:VT,useClass:nL,multi:!0,deps:[Hi,Hr,K0]},{provide:VT,useClass:oL,multi:!0,deps:[Hi]},{provide:lI,useClass:lI,deps:[UT,kv,uh]},{provide:G_,useExisting:lI},{provide:v2,useExisting:kv},{provide:kv,useClass:kv,deps:[Hi]},{provide:UT,useClass:UT,deps:[VT,Hr]},{provide:d2,useClass:ZR,deps:[]},[]];let uL=(()=>{class i{constructor(a){}static withServerTransition(a){return{ngModule:i,providers:[{provide:uh,useValue:a.appId},{provide:_2,useExisting:uh},qR]}}}return i.\u0275fac=function(a){return new(a||i)(fe(I2,12))},i.\u0275mod=Qr({type:i}),i.\u0275inj=Ki({providers:[...P2,...A2],imports:[cR,_s]}),i})(),R2=(()=>{class i{constructor(a){this._doc=a}getTitle(){return this._doc.title}setTitle(a){this._doc.title=a||""}}return i.\u0275fac=function(a){return new(a||i)(fe(Hi))},i.\u0275prov=Ue({token:i,factory:function(a){let u=null;return u=a?new a:function dL(){return new R2(fe(Hi))}(),u},providedIn:"root"}),i})();function Ve(...i){return Lr(i,Ka(i))}typeof window<"u"&&window;class Ua extends yi{constructor(o){super(),this._value=o}get value(){return this.getValue()}_subscribe(o){const a=super._subscribe(o);return!a.closed&&o.next(this._value),a}getValue(){const{hasError:o,thrownError:a,_value:u}=this;if(o)throw a;return this._throwIfClosed(),u}next(o){super.next(this._value=o)}}const HT=bh(i=>function(){i(this),this.name="EmptyError",this.message="no elements in sequence"}),{isArray:xL}=Array,{getPrototypeOf:bL,prototype:wL,keys:EL}=Object;const{isArray:SL}=Array;function O2(...i){const o=Ka(i),a=function mD(i){return Qn(wf(i))?i.pop():void 0}(i),{args:u,keys:d}=function TL(i){if(1===i.length){const o=i[0];if(xL(o))return{args:o,keys:null};if(function DL(i){return i&&"object"==typeof i&&bL(i)===wL}(o)){const a=EL(o);return{args:a.map(u=>o[u]),keys:a}}}return{args:i,keys:null}}(i);if(0===u.length)return Lr([],o);const g=new Nn(function AL(i,o,a=oa){return u=>{F2(o,()=>{const{length:d}=i,g=new Array(d);let x=d,w=d;for(let S=0;S<d;S++)F2(o,()=>{const P=Lr(i[S],o);let k=!1;P.subscribe(mr(u,F=>{g[S]=F,k||(k=!0,w--),w||u.next(a(g.slice()))},()=>{--x||u.complete()}))},u)},u)}}(u,o,d?x=>function IL(i,o){return i.reduce((a,u,d)=>(a[u]=o[d],a),{})}(d,x):oa));return a?g.pipe(function ML(i){return un(o=>function CL(i,o){return SL(o)?i(...o):i(o)}(i,o))}(a)):g}function F2(i,o,a){i?Yi(a,i,o):o()}function dI(...i){return function PL(){return Ya(1)}()(Lr(i,Ka(i)))}function z2(i){return new Nn(o=>{mn(i()).subscribe(o)})}function Ov(i,o){const a=Qn(i)?i:()=>i,u=d=>d.error(a());return new Nn(o?d=>o.schedule(u,0,d):u)}function fI(){return Br((i,o)=>{let a=null;i._refCount++;const u=mr(o,void 0,void 0,void 0,()=>{if(!i||i._refCount<=0||0<--i._refCount)return void(a=null);const d=i._connection,g=a;a=null,d&&(!g||d===g)&&d.unsubscribe(),o.unsubscribe()});i.subscribe(u),u.closed||(a=i.connect())})}class N2 extends Nn{constructor(o,a){super(),this.source=o,this.subjectFactory=a,this._subject=null,this._refCount=0,this._connection=null,Ci(o)&&(this.lift=o.lift)}_subscribe(o){return this.getSubject().subscribe(o)}getSubject(){const o=this._subject;return(!o||o.isStopped)&&(this._subject=this.subjectFactory()),this._subject}_teardown(){this._refCount=0;const{_connection:o}=this;this._subject=this._connection=null,o?.unsubscribe()}connect(){let o=this._connection;if(!o){o=this._connection=new it;const a=this.getSubject();o.add(this.source.subscribe(mr(a,void 0,()=>{this._teardown(),a.complete()},u=>{this._teardown(),a.error(u)},()=>this._teardown()))),o.closed&&(this._connection=null,o=it.EMPTY)}return o}refCount(){return fI()(this)}}function zl(i,o){return Br((a,u)=>{let d=null,g=0,x=!1;const w=()=>x&&!d&&u.complete();a.subscribe(mr(u,S=>{d?.unsubscribe();let P=0;const k=g++;mn(i(S,k)).subscribe(d=mr(u,F=>u.next(o?o(S,F,k,P++):F),()=>{d=null,w()}))},()=>{x=!0,w()}))})}function Fv(i){return i<=0?()=>Ss:Br((o,a)=>{let u=0;o.subscribe(mr(a,d=>{++u<=i&&(a.next(d),i<=u&&a.complete())}))})}function Vc(i,o){return Br((a,u)=>{let d=0;a.subscribe(mr(u,g=>i.call(o,g,d++)&&u.next(g)))})}function GT(i){return Br((o,a)=>{let u=!1;o.subscribe(mr(a,d=>{u=!0,a.next(d)},()=>{u||a.next(i),a.complete()}))})}function B2(i=LL){return Br((o,a)=>{let u=!1;o.subscribe(mr(a,d=>{u=!0,a.next(d)},()=>u?a.complete():a.error(i())))})}function LL(){return new HT}function gh(i,o){const a=arguments.length>=2;return u=>u.pipe(i?Vc((d,g)=>i(d,g,u)):oa,Fv(1),a?GT(o):B2(()=>new HT))}function _h(i,o){return Qn(o)?wr(i,o,1):wr(i,1)}function po(i,o,a){const u=Qn(i)||o||a?{next:i,error:o,complete:a}:i;return u?Br((d,g)=>{var x;null===(x=u.subscribe)||void 0===x||x.call(u);let w=!0;d.subscribe(mr(g,S=>{var P;null===(P=u.next)||void 0===P||P.call(u,S),g.next(S)},()=>{var S;w=!1,null===(S=u.complete)||void 0===S||S.call(u),g.complete()},S=>{var P;w=!1,null===(P=u.error)||void 0===P||P.call(u,S),g.error(S)},()=>{var S,P;w&&(null===(S=u.unsubscribe)||void 0===S||S.call(u)),null===(P=u.finalize)||void 0===P||P.call(u)}))}):oa}function yh(i){return Br((o,a)=>{let g,u=null,d=!1;u=o.subscribe(mr(a,void 0,void 0,x=>{g=mn(i(x,yh(i)(o))),u?(u.unsubscribe(),u=null,g.subscribe(a)):d=!0})),d&&(u.unsubscribe(),u=null,g.subscribe(a))})}function kL(i,o,a,u,d){return(g,x)=>{let w=a,S=o,P=0;g.subscribe(mr(x,k=>{const F=P++;S=w?i(S,k,F):(w=!0,k),u&&x.next(S)},d&&(()=>{w&&x.next(S),x.complete()})))}}function j2(i,o){return Br(kL(i,o,arguments.length>=2,!0))}function pI(i){return i<=0?()=>Ss:Br((o,a)=>{let u=[];o.subscribe(mr(a,d=>{u.push(d),i<u.length&&u.shift()},()=>{for(const d of u)a.next(d);a.complete()},void 0,()=>{u=null}))})}function V2(i,o){const a=arguments.length>=2;return u=>u.pipe(i?Vc((d,g)=>i(d,g,u)):oa,pI(1),a?GT(o):B2(()=>new HT))}function mI(i){return Br((o,a)=>{try{o.subscribe(a)}finally{a.add(i)}})}const vn="primary",zv=Symbol("RouteTitle");class zL{constructor(o){this.params=o||{}}has(o){return Object.prototype.hasOwnProperty.call(this.params,o)}get(o){if(this.has(o)){const a=this.params[o];return Array.isArray(a)?a[0]:a}return null}getAll(o){if(this.has(o)){const a=this.params[o];return Array.isArray(a)?a:[a]}return[]}get keys(){return Object.keys(this.params)}}function cg(i){return new zL(i)}function NL(i,o,a){const u=a.path.split("/");if(u.length>i.length||"full"===a.pathMatch&&(o.hasChildren()||u.length<i.length))return null;const d={};for(let g=0;g<u.length;g++){const x=u[g],w=i[g];if(x.startsWith(":"))d[x.substring(1)]=w;else if(x!==w.path)return null}return{consumed:i.slice(0,u.length),posParams:d}}function Nl(i,o){const a=i?Object.keys(i):void 0,u=o?Object.keys(o):void 0;if(!a||!u||a.length!=u.length)return!1;let d;for(let g=0;g<a.length;g++)if(d=a[g],!U2(i[d],o[d]))return!1;return!0}function U2(i,o){if(Array.isArray(i)&&Array.isArray(o)){if(i.length!==o.length)return!1;const a=[...i].sort(),u=[...o].sort();return a.every((d,g)=>u[g]===d)}return i===o}function $2(i){return Array.prototype.concat.apply([],i)}function H2(i){return i.length>0?i[i.length-1]:null}function qi(i,o){for(const a in i)i.hasOwnProperty(a)&&o(i[a],a)}function vh(i){return nw(i)?i:wc(i)?Lr(Promise.resolve(i)):Ve(i)}const VL={exact:function W2(i,o,a){if(!pf(i.segments,o.segments)||!qT(i.segments,o.segments,a)||i.numberOfChildren!==o.numberOfChildren)return!1;for(const u in o.children)if(!i.children[u]||!W2(i.children[u],o.children[u],a))return!1;return!0},subset:Z2},G2={exact:function UL(i,o){return Nl(i,o)},subset:function $L(i,o){return Object.keys(o).length<=Object.keys(i).length&&Object.keys(o).every(a=>U2(i[a],o[a]))},ignored:()=>!0};function q2(i,o,a){return VL[a.paths](i.root,o.root,a.matrixParams)&&G2[a.queryParams](i.queryParams,o.queryParams)&&!("exact"===a.fragment&&i.fragment!==o.fragment)}function Z2(i,o,a){return X2(i,o,o.segments,a)}function X2(i,o,a,u){if(i.segments.length>a.length){const d=i.segments.slice(0,a.length);return!(!pf(d,a)||o.hasChildren()||!qT(d,a,u))}if(i.segments.length===a.length){if(!pf(i.segments,a)||!qT(i.segments,a,u))return!1;for(const d in o.children)if(!i.children[d]||!Z2(i.children[d],o.children[d],u))return!1;return!0}{const d=a.slice(0,i.segments.length),g=a.slice(i.segments.length);return!!(pf(i.segments,d)&&qT(i.segments,d,u)&&i.children[vn])&&X2(i.children[vn],o,g,u)}}function qT(i,o,a){return o.every((u,d)=>G2[a](i[d].parameters,u.parameters))}class ff{constructor(o,a,u){this.root=o,this.queryParams=a,this.fragment=u}get queryParamMap(){return this._queryParamMap||(this._queryParamMap=cg(this.queryParams)),this._queryParamMap}toString(){return qL.serialize(this)}}class wn{constructor(o,a){this.segments=o,this.children=a,this.parent=null,qi(a,(u,d)=>u.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return WT(this)}}class Nv{constructor(o,a){this.path=o,this.parameters=a}get parameterMap(){return this._parameterMap||(this._parameterMap=cg(this.parameters)),this._parameterMap}toString(){return Q2(this)}}function pf(i,o){return i.length===o.length&&i.every((a,u)=>a.path===o[u].path)}let Y2=(()=>{class i{}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:function(){return new _I},providedIn:"root"}),i})();class _I{parse(o){const a=new ek(o);return new ff(a.parseRootSegment(),a.parseQueryParams(),a.parseFragment())}serialize(o){const a=`/${Bv(o.root,!0)}`,u=function XL(i){const o=Object.keys(i).map(a=>{const u=i[a];return Array.isArray(u)?u.map(d=>`${ZT(a)}=${ZT(d)}`).join("&"):`${ZT(a)}=${ZT(u)}`}).filter(a=>!!a);return o.length?`?${o.join("&")}`:""}(o.queryParams);return`${a}${u}${"string"==typeof o.fragment?`#${function WL(i){return encodeURI(i)}(o.fragment)}`:""}`}}const qL=new _I;function WT(i){return i.segments.map(o=>Q2(o)).join("/")}function Bv(i,o){if(!i.hasChildren())return WT(i);if(o){const a=i.children[vn]?Bv(i.children[vn],!1):"",u=[];return qi(i.children,(d,g)=>{g!==vn&&u.push(`${g}:${Bv(d,!1)}`)}),u.length>0?`${a}(${u.join("//")})`:a}{const a=function GL(i,o){let a=[];return qi(i.children,(u,d)=>{d===vn&&(a=a.concat(o(u,d)))}),qi(i.children,(u,d)=>{d!==vn&&(a=a.concat(o(u,d)))}),a}(i,(u,d)=>d===vn?[Bv(i.children[vn],!1)]:[`${d}:${Bv(u,!1)}`]);return 1===Object.keys(i.children).length&&null!=i.children[vn]?`${WT(i)}/${a[0]}`:`${WT(i)}/(${a.join("//")})`}}function K2(i){return encodeURIComponent(i).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function ZT(i){return K2(i).replace(/%3B/gi,";")}function yI(i){return K2(i).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function XT(i){return decodeURIComponent(i)}function J2(i){return XT(i.replace(/\+/g,"%20"))}function Q2(i){return`${yI(i.path)}${function ZL(i){return Object.keys(i).map(o=>`;${yI(o)}=${yI(i[o])}`).join("")}(i.parameters)}`}const YL=/^[^\/()?;=#]+/;function YT(i){const o=i.match(YL);return o?o[0]:""}const KL=/^[^=?&#]+/,QL=/^[^&#]+/;class ek{constructor(o){this.url=o,this.remaining=o}parseRootSegment(){return this.consumeOptional("/"),""===this.remaining||this.peekStartsWith("?")||this.peekStartsWith("#")?new wn([],{}):new wn([],this.parseChildren())}parseQueryParams(){const o={};if(this.consumeOptional("?"))do{this.parseQueryParam(o)}while(this.consumeOptional("&"));return o}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(""===this.remaining)return{};this.consumeOptional("/");const o=[];for(this.peekStartsWith("(")||o.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),o.push(this.parseSegment());let a={};this.peekStartsWith("/(")&&(this.capture("/"),a=this.parseParens(!0));let u={};return this.peekStartsWith("(")&&(u=this.parseParens(!1)),(o.length>0||Object.keys(a).length>0)&&(u[vn]=new wn(o,a)),u}parseSegment(){const o=YT(this.remaining);if(""===o&&this.peekStartsWith(";"))throw new ne(4009,!1);return this.capture(o),new Nv(XT(o),this.parseMatrixParams())}parseMatrixParams(){const o={};for(;this.consumeOptional(";");)this.parseParam(o);return o}parseParam(o){const a=YT(this.remaining);if(!a)return;this.capture(a);let u="";if(this.consumeOptional("=")){const d=YT(this.remaining);d&&(u=d,this.capture(u))}o[XT(a)]=XT(u)}parseQueryParam(o){const a=function JL(i){const o=i.match(KL);return o?o[0]:""}(this.remaining);if(!a)return;this.capture(a);let u="";if(this.consumeOptional("=")){const x=function tk(i){const o=i.match(QL);return o?o[0]:""}(this.remaining);x&&(u=x,this.capture(u))}const d=J2(a),g=J2(u);if(o.hasOwnProperty(d)){let x=o[d];Array.isArray(x)||(x=[x],o[d]=x),x.push(g)}else o[d]=g}parseParens(o){const a={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){const u=YT(this.remaining),d=this.remaining[u.length];if("/"!==d&&")"!==d&&";"!==d)throw new ne(4010,!1);let g;u.indexOf(":")>-1?(g=u.slice(0,u.indexOf(":")),this.capture(g),this.capture(":")):o&&(g=vn);const x=this.parseChildren();a[g]=1===Object.keys(x).length?x[vn]:new wn([],x),this.consumeOptional("//")}return a}peekStartsWith(o){return this.remaining.startsWith(o)}consumeOptional(o){return!!this.peekStartsWith(o)&&(this.remaining=this.remaining.substring(o.length),!0)}capture(o){if(!this.consumeOptional(o))throw new ne(4011,!1)}}function vI(i){return i.segments.length>0?new wn([],{[vn]:i}):i}function KT(i){const o={};for(const u of Object.keys(i.children)){const g=KT(i.children[u]);(g.segments.length>0||g.hasChildren())&&(o[u]=g)}return function nk(i){if(1===i.numberOfChildren&&i.children[vn]){const o=i.children[vn];return new wn(i.segments.concat(o.segments),o.children)}return i}(new wn(i.segments,o))}function mf(i){return i instanceof ff}function ok(i,o,a,u,d){if(0===a.length)return ug(o.root,o.root,o.root,u,d);const g=function nP(i){if("string"==typeof i[0]&&1===i.length&&"/"===i[0])return new eP(!0,0,i);let o=0,a=!1;const u=i.reduce((d,g,x)=>{if("object"==typeof g&&null!=g){if(g.outlets){const w={};return qi(g.outlets,(S,P)=>{w[P]="string"==typeof S?S.split("/"):S}),[...d,{outlets:w}]}if(g.segmentPath)return[...d,g.segmentPath]}return"string"!=typeof g?[...d,g]:0===x?(g.split("/").forEach((w,S)=>{0==S&&"."===w||(0==S&&""===w?a=!0:".."===w?o++:""!=w&&d.push(w))}),d):[...d,g]},[]);return new eP(a,o,u)}(a);return g.toRoot()?ug(o.root,o.root,new wn([],{}),u,d):function x(S){const P=function ak(i,o,a,u){if(i.isAbsolute)return new hg(o.root,!0,0);if(-1===u)return new hg(a,a===o.root,0);return function rP(i,o,a){let u=i,d=o,g=a;for(;g>d;){if(g-=d,u=u.parent,!u)throw new ne(4005,!1);d=u.segments.length}return new hg(u,!1,d-g)}(a,u+(jv(i.commands[0])?0:1),i.numberOfDoubleDots)}(g,o,i.snapshot?._urlSegment,S),k=P.processChildren?Uv(P.segmentGroup,P.index,g.commands):bI(P.segmentGroup,P.index,g.commands);return ug(o.root,P.segmentGroup,k,u,d)}(i.snapshot?._lastPathIndex)}function jv(i){return"object"==typeof i&&null!=i&&!i.outlets&&!i.segmentPath}function Vv(i){return"object"==typeof i&&null!=i&&i.outlets}function ug(i,o,a,u,d){let x,g={};u&&qi(u,(S,P)=>{g[P]=Array.isArray(S)?S.map(k=>`${k}`):`${S}`}),x=i===o?a:tP(i,o,a);const w=vI(KT(x));return new ff(w,g,d)}function tP(i,o,a){const u={};return qi(i.children,(d,g)=>{u[g]=d===o?a:tP(d,o,a)}),new wn(i.segments,u)}class eP{constructor(o,a,u){if(this.isAbsolute=o,this.numberOfDoubleDots=a,this.commands=u,o&&u.length>0&&jv(u[0]))throw new ne(4003,!1);const d=u.find(Vv);if(d&&d!==H2(u))throw new ne(4004,!1)}toRoot(){return this.isAbsolute&&1===this.commands.length&&"/"==this.commands[0]}}class hg{constructor(o,a,u){this.segmentGroup=o,this.processChildren=a,this.index=u}}function bI(i,o,a){if(i||(i=new wn([],{})),0===i.segments.length&&i.hasChildren())return Uv(i,o,a);const u=function ck(i,o,a){let u=0,d=o;const g={match:!1,pathIndex:0,commandIndex:0};for(;d<i.segments.length;){if(u>=a.length)return g;const x=i.segments[d],w=a[u];if(Vv(w))break;const S=`${w}`,P=u<a.length-1?a[u+1]:null;if(d>0&&void 0===S)break;if(S&&P&&"object"==typeof P&&void 0===P.outlets){if(!oP(S,P,x))return g;u+=2}else{if(!oP(S,{},x))return g;u++}d++}return{match:!0,pathIndex:d,commandIndex:u}}(i,o,a),d=a.slice(u.commandIndex);if(u.match&&u.pathIndex<i.segments.length){const g=new wn(i.segments.slice(0,u.pathIndex),{});return g.children[vn]=new wn(i.segments.slice(u.pathIndex),i.children),Uv(g,0,d)}return u.match&&0===d.length?new wn(i.segments,{}):u.match&&!i.hasChildren()?wI(i,o,a):u.match?Uv(i,0,d):wI(i,o,a)}function Uv(i,o,a){if(0===a.length)return new wn(i.segments,{});{const u=function lk(i){return Vv(i[0])?i[0].outlets:{[vn]:i}}(a),d={};return qi(u,(g,x)=>{"string"==typeof g&&(g=[g]),null!==g&&(d[x]=bI(i.children[x],o,g))}),qi(i.children,(g,x)=>{void 0===u[x]&&(d[x]=g)}),new wn(i.segments,d)}}function wI(i,o,a){const u=i.segments.slice(0,o);let d=0;for(;d<a.length;){const g=a[d];if(Vv(g)){const S=uk(g.outlets);return new wn(u,S)}if(0===d&&jv(a[0])){u.push(new Nv(i.segments[o].path,iP(a[0]))),d++;continue}const x=Vv(g)?g.outlets[vn]:`${g}`,w=d<a.length-1?a[d+1]:null;x&&w&&jv(w)?(u.push(new Nv(x,iP(w))),d+=2):(u.push(new Nv(x,{})),d++)}return new wn(u,{})}function uk(i){const o={};return qi(i,(a,u)=>{"string"==typeof a&&(a=[a]),null!==a&&(o[u]=wI(new wn([],{}),0,a))}),o}function iP(i){const o={};return qi(i,(a,u)=>o[u]=`${a}`),o}function oP(i,o,a){return i==a.path&&Nl(o,a.parameters)}class Uc{constructor(o,a){this.id=o,this.url=a}}class EI extends Uc{constructor(o,a,u="imperative",d=null){super(o,a),this.type=0,this.navigationTrigger=u,this.restoredState=d}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}}class gf extends Uc{constructor(o,a,u){super(o,a),this.urlAfterRedirects=u,this.type=1}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}}class JT extends Uc{constructor(o,a,u,d){super(o,a),this.reason=u,this.code=d,this.type=2}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}}class sP extends Uc{constructor(o,a,u,d){super(o,a),this.error=u,this.target=d,this.type=3}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}}class hk extends Uc{constructor(o,a,u,d){super(o,a),this.urlAfterRedirects=u,this.state=d,this.type=4}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class dk extends Uc{constructor(o,a,u,d){super(o,a),this.urlAfterRedirects=u,this.state=d,this.type=7}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class fk extends Uc{constructor(o,a,u,d,g){super(o,a),this.urlAfterRedirects=u,this.state=d,this.shouldActivate=g,this.type=8}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}}class pk extends Uc{constructor(o,a,u,d){super(o,a),this.urlAfterRedirects=u,this.state=d,this.type=5}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class mk extends Uc{constructor(o,a,u,d){super(o,a),this.urlAfterRedirects=u,this.state=d,this.type=6}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}}class gk{constructor(o){this.route=o,this.type=9}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}}class _k{constructor(o){this.route=o,this.type=10}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}}class yk{constructor(o){this.snapshot=o,this.type=11}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class vk{constructor(o){this.snapshot=o,this.type=12}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class xk{constructor(o){this.snapshot=o,this.type=13}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class bk{constructor(o){this.snapshot=o,this.type=14}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}}class aP{constructor(o,a,u){this.routerEvent=o,this.position=a,this.anchor=u,this.type=15}toString(){return`Scroll(anchor: '${this.anchor}', position: '${this.position?`${this.position[0]}, ${this.position[1]}`:null}')`}}class lP{constructor(o){this._root=o}get root(){return this._root.value}parent(o){const a=this.pathFromRoot(o);return a.length>1?a[a.length-2]:null}children(o){const a=TI(o,this._root);return a?a.children.map(u=>u.value):[]}firstChild(o){const a=TI(o,this._root);return a&&a.children.length>0?a.children[0].value:null}siblings(o){const a=DI(o,this._root);return a.length<2?[]:a[a.length-2].children.map(d=>d.value).filter(d=>d!==o)}pathFromRoot(o){return DI(o,this._root).map(a=>a.value)}}function TI(i,o){if(i===o.value)return o;for(const a of o.children){const u=TI(i,a);if(u)return u}return null}function DI(i,o){if(i===o.value)return[o];for(const a of o.children){const u=DI(i,a);if(u.length)return u.unshift(o),u}return[]}class $c{constructor(o,a){this.value=o,this.children=a}toString(){return`TreeNode(${this.value})`}}function dg(i){const o={};return i&&i.children.forEach(a=>o[a.value.outlet]=a),o}class cP extends lP{constructor(o,a){super(o),this.snapshot=a,SI(this,o)}toString(){return this.snapshot.toString()}}function uP(i,o){const a=function Ek(i,o){const x=new QT([],{},{},"",{},vn,o,null,i.root,-1,{});return new dP("",new $c(x,[]))}(i,o),u=new Ua([new Nv("",{})]),d=new Ua({}),g=new Ua({}),x=new Ua({}),w=new Ua(""),S=new _f(u,d,x,w,g,vn,o,a.root);return S.snapshot=a.root,new cP(new $c(S,[]),a)}class _f{constructor(o,a,u,d,g,x,w,S){this.url=o,this.params=a,this.queryParams=u,this.fragment=d,this.data=g,this.outlet=x,this.component=w,this.title=this.data?.pipe(un(P=>P[zv]))??Ve(void 0),this._futureSnapshot=S}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap||(this._paramMap=this.params.pipe(un(o=>cg(o)))),this._paramMap}get queryParamMap(){return this._queryParamMap||(this._queryParamMap=this.queryParams.pipe(un(o=>cg(o)))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}}function hP(i,o="emptyOnly"){const a=i.pathFromRoot;let u=0;if("always"!==o)for(u=a.length-1;u>=1;){const d=a[u],g=a[u-1];if(d.routeConfig&&""===d.routeConfig.path)u--;else{if(g.component)break;u--}}return function Tk(i){return i.reduce((o,a)=>({params:{...o.params,...a.params},data:{...o.data,...a.data},resolve:{...a.data,...o.resolve,...a.routeConfig?.data,...a._resolvedData}}),{params:{},data:{},resolve:{}})}(a.slice(u))}class QT{constructor(o,a,u,d,g,x,w,S,P,k,F,G){this.url=o,this.params=a,this.queryParams=u,this.fragment=d,this.data=g,this.outlet=x,this.component=w,this.title=this.data?.[zv],this.routeConfig=S,this._urlSegment=P,this._lastPathIndex=k,this._correctedLastPathIndex=G??k,this._resolve=F}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap||(this._paramMap=cg(this.params)),this._paramMap}get queryParamMap(){return this._queryParamMap||(this._queryParamMap=cg(this.queryParams)),this._queryParamMap}toString(){return`Route(url:'${this.url.map(u=>u.toString()).join("/")}', path:'${this.routeConfig?this.routeConfig.path:""}')`}}class dP extends lP{constructor(o,a){super(a),this.url=o,SI(this,a)}toString(){return fP(this._root)}}function SI(i,o){o.value._routerState=i,o.children.forEach(a=>SI(i,a))}function fP(i){const o=i.children.length>0?` { ${i.children.map(fP).join(", ")} } `:"";return`${i.value}${o}`}function CI(i){if(i.snapshot){const o=i.snapshot,a=i._futureSnapshot;i.snapshot=a,Nl(o.queryParams,a.queryParams)||i.queryParams.next(a.queryParams),o.fragment!==a.fragment&&i.fragment.next(a.fragment),Nl(o.params,a.params)||i.params.next(a.params),function BL(i,o){if(i.length!==o.length)return!1;for(let a=0;a<i.length;++a)if(!Nl(i[a],o[a]))return!1;return!0}(o.url,a.url)||i.url.next(a.url),Nl(o.data,a.data)||i.data.next(a.data)}else i.snapshot=i._futureSnapshot,i.data.next(i._futureSnapshot.data)}function MI(i,o){const a=Nl(i.params,o.params)&&function HL(i,o){return pf(i,o)&&i.every((a,u)=>Nl(a.parameters,o[u].parameters))}(i.url,o.url);return a&&!(!i.parent!=!o.parent)&&(!i.parent||MI(i.parent,o.parent))}function $v(i,o,a){if(a&&i.shouldReuseRoute(o.value,a.value.snapshot)){const u=a.value;u._futureSnapshot=o.value;const d=function Sk(i,o,a){return o.children.map(u=>{for(const d of a.children)if(i.shouldReuseRoute(u.value,d.value.snapshot))return $v(i,u,d);return $v(i,u)})}(i,o,a);return new $c(u,d)}{if(i.shouldAttach(o.value)){const g=i.retrieve(o.value);if(null!==g){const x=g.route;return x.value._futureSnapshot=o.value,x.children=o.children.map(w=>$v(i,w)),x}}const u=function Ck(i){return new _f(new Ua(i.url),new Ua(i.params),new Ua(i.queryParams),new Ua(i.fragment),new Ua(i.data),i.outlet,i.component,i)}(o.value),d=o.children.map(g=>$v(i,g));return new $c(u,d)}}const II="ngNavigationCancelingError";function pP(i,o){const{redirectTo:a,navigationBehaviorOptions:u}=mf(o)?{redirectTo:o,navigationBehaviorOptions:void 0}:o,d=mP(!1,0,o);return d.url=a,d.navigationBehaviorOptions=u,d}function mP(i,o,a){const u=new Error("NavigationCancelingError: "+(i||""));return u[II]=!0,u.cancellationCode=o,a&&(u.url=a),u}function gP(i){return _P(i)&&mf(i.url)}function _P(i){return i&&i[II]}class Mk{constructor(){this.outlet=null,this.route=null,this.resolver=null,this.injector=null,this.children=new Hv,this.attachRef=null}}let Hv=(()=>{class i{constructor(){this.contexts=new Map}onChildOutletCreated(a,u){const d=this.getOrCreateContext(a);d.outlet=u,this.contexts.set(a,d)}onChildOutletDestroyed(a){const u=this.getContext(a);u&&(u.outlet=null,u.attachRef=null)}onOutletDeactivated(){const a=this.contexts;return this.contexts=new Map,a}onOutletReAttached(a){this.contexts=a}getOrCreateContext(a){let u=this.getContext(a);return u||(u=new Mk,this.contexts.set(a,u)),u}getContext(a){return this.contexts.get(a)||null}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();const tD=!1;let yP=(()=>{class i{constructor(a,u,d,g,x){this.parentContexts=a,this.location=u,this.changeDetector=g,this.environmentInjector=x,this.activated=null,this._activatedRoute=null,this.activateEvents=new $r,this.deactivateEvents=new $r,this.attachEvents=new $r,this.detachEvents=new $r,this.name=d||vn,a.onChildOutletCreated(this.name,this)}ngOnDestroy(){this.parentContexts.getContext(this.name)?.outlet===this&&this.parentContexts.onChildOutletDestroyed(this.name)}ngOnInit(){if(!this.activated){const a=this.parentContexts.getContext(this.name);a&&a.route&&(a.attachRef?this.attach(a.attachRef,a.route):this.activateWith(a.route,a.injector))}}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new ne(4012,tD);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new ne(4012,tD);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new ne(4012,tD);this.location.detach();const a=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(a.instance),a}attach(a,u){this.activated=a,this._activatedRoute=u,this.location.insert(a.hostView),this.attachEvents.emit(a.instance)}deactivate(){if(this.activated){const a=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(a)}}activateWith(a,u){if(this.isActivated)throw new ne(4013,tD);this._activatedRoute=a;const d=this.location,x=a._futureSnapshot.component,w=this.parentContexts.getOrCreateContext(this.name).children,S=new Ik(a,w,d.injector);if(u&&function Ak(i){return!!i.resolveComponentFactory}(u)){const P=u.resolveComponentFactory(x);this.activated=d.createComponent(P,d.length,S)}else this.activated=d.createComponent(x,{index:d.length,injector:S,environmentInjector:u??this.environmentInjector});this.changeDetector.markForCheck(),this.activateEvents.emit(this.activated.instance)}}return i.\u0275fac=function(a){return new(a||i)(Ie(Hv),Ie(So),function Ls(i){return function OD(i,o){if("class"===o)return i.classes;if("style"===o)return i.styles;const a=i.attrs;if(a){const u=a.length;let d=0;for(;d<u;){const g=a[d];if(Hg(g))break;if(0===g)d+=2;else if("number"==typeof g)for(d++;d<u&&"string"==typeof a[d];)d++;else{if(g===o)return a[d+1];d+=2}}}return null}(qr(),i)}("name"),Ie(uv),Ie(Fo))},i.\u0275dir=xi({type:i,selectors:[["router-outlet"]],outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],standalone:!0}),i})();class Ik{constructor(o,a,u){this.route=o,this.childContexts=a,this.parent=u}get(o,a){return o===_f?this.route:o===Hv?this.childContexts:this.parent.get(o,a)}}let AI=(()=>{class i{}return i.\u0275fac=function(a){return new(a||i)},i.\u0275cmp=Qi({type:i,selectors:[["ng-component"]],standalone:!0,features:[mE],decls:1,vars:0,template:function(a,u){1&a&&Ti(0,"router-outlet")},dependencies:[yP],encapsulation:2}),i})();function vP(i,o){return i.providers&&!i._injector&&(i._injector=Do(i.providers,o,`Route: ${i.path}`)),i._injector??o}function RI(i){const o=i.children&&i.children.map(RI),a=o?{...i,children:o}:{...i};return!a.component&&!a.loadComponent&&(o||a.loadChildren)&&a.outlet&&a.outlet!==vn&&(a.component=AI),a}function ra(i){return i.outlet||vn}function xP(i,o){const a=i.filter(u=>ra(u)===o);return a.push(...i.filter(u=>ra(u)!==o)),a}function Gv(i){if(!i)return null;if(i.routeConfig?._injector)return i.routeConfig._injector;for(let o=i.parent;o;o=o.parent){const a=o.routeConfig;if(a?._loadedInjector)return a._loadedInjector;if(a?._injector)return a._injector}return null}class Ok{constructor(o,a,u,d){this.routeReuseStrategy=o,this.futureState=a,this.currState=u,this.forwardEvent=d}activate(o){const a=this.futureState._root,u=this.currState?this.currState._root:null;this.deactivateChildRoutes(a,u,o),CI(this.futureState.root),this.activateChildRoutes(a,u,o)}deactivateChildRoutes(o,a,u){const d=dg(a);o.children.forEach(g=>{const x=g.value.outlet;this.deactivateRoutes(g,d[x],u),delete d[x]}),qi(d,(g,x)=>{this.deactivateRouteAndItsChildren(g,u)})}deactivateRoutes(o,a,u){const d=o.value,g=a?a.value:null;if(d===g)if(d.component){const x=u.getContext(d.outlet);x&&this.deactivateChildRoutes(o,a,x.children)}else this.deactivateChildRoutes(o,a,u);else g&&this.deactivateRouteAndItsChildren(a,u)}deactivateRouteAndItsChildren(o,a){o.value.component&&this.routeReuseStrategy.shouldDetach(o.value.snapshot)?this.detachAndStoreRouteSubtree(o,a):this.deactivateRouteAndOutlet(o,a)}detachAndStoreRouteSubtree(o,a){const u=a.getContext(o.value.outlet),d=u&&o.value.component?u.children:a,g=dg(o);for(const x of Object.keys(g))this.deactivateRouteAndItsChildren(g[x],d);if(u&&u.outlet){const x=u.outlet.detach(),w=u.children.onOutletDeactivated();this.routeReuseStrategy.store(o.value.snapshot,{componentRef:x,route:o,contexts:w})}}deactivateRouteAndOutlet(o,a){const u=a.getContext(o.value.outlet),d=u&&o.value.component?u.children:a,g=dg(o);for(const x of Object.keys(g))this.deactivateRouteAndItsChildren(g[x],d);u&&u.outlet&&(u.outlet.deactivate(),u.children.onOutletDeactivated(),u.attachRef=null,u.resolver=null,u.route=null)}activateChildRoutes(o,a,u){const d=dg(a);o.children.forEach(g=>{this.activateRoutes(g,d[g.value.outlet],u),this.forwardEvent(new bk(g.value.snapshot))}),o.children.length&&this.forwardEvent(new vk(o.value.snapshot))}activateRoutes(o,a,u){const d=o.value,g=a?a.value:null;if(CI(d),d===g)if(d.component){const x=u.getOrCreateContext(d.outlet);this.activateChildRoutes(o,a,x.children)}else this.activateChildRoutes(o,a,u);else if(d.component){const x=u.getOrCreateContext(d.outlet);if(this.routeReuseStrategy.shouldAttach(d.snapshot)){const w=this.routeReuseStrategy.retrieve(d.snapshot);this.routeReuseStrategy.store(d.snapshot,null),x.children.onOutletReAttached(w.contexts),x.attachRef=w.componentRef,x.route=w.route.value,x.outlet&&x.outlet.attach(w.componentRef,w.route.value),CI(w.route.value),this.activateChildRoutes(o,null,x.children)}else{const w=Gv(d.snapshot),S=w?.get(yl)??null;x.attachRef=null,x.route=d,x.resolver=S,x.injector=w,x.outlet&&x.outlet.activateWith(d,x.injector),this.activateChildRoutes(o,null,x.children)}}else this.activateChildRoutes(o,null,u)}}class bP{constructor(o){this.path=o,this.route=this.path[this.path.length-1]}}class eD{constructor(o,a){this.component=o,this.route=a}}function Fk(i,o,a){const u=i._root;return qv(u,o?o._root:null,a,[u.value])}function fg(i,o){const a=Symbol(),u=o.get(i,a);return u===a?"function"!=typeof i||function cr(i){return null!==ci(i)}(i)?o.get(i):i:u}function qv(i,o,a,u,d={canDeactivateChecks:[],canActivateChecks:[]}){const g=dg(o);return i.children.forEach(x=>{(function Nk(i,o,a,u,d={canDeactivateChecks:[],canActivateChecks:[]}){const g=i.value,x=o?o.value:null,w=a?a.getContext(i.value.outlet):null;if(x&&g.routeConfig===x.routeConfig){const S=function Bk(i,o,a){if("function"==typeof a)return a(i,o);switch(a){case"pathParamsChange":return!pf(i.url,o.url);case"pathParamsOrQueryParamsChange":return!pf(i.url,o.url)||!Nl(i.queryParams,o.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!MI(i,o)||!Nl(i.queryParams,o.queryParams);default:return!MI(i,o)}}(x,g,g.routeConfig.runGuardsAndResolvers);S?d.canActivateChecks.push(new bP(u)):(g.data=x.data,g._resolvedData=x._resolvedData),qv(i,o,g.component?w?w.children:null:a,u,d),S&&w&&w.outlet&&w.outlet.isActivated&&d.canDeactivateChecks.push(new eD(w.outlet.component,x))}else x&&Wv(o,w,d),d.canActivateChecks.push(new bP(u)),qv(i,null,g.component?w?w.children:null:a,u,d)})(x,g[x.value.outlet],a,u.concat([x.value]),d),delete g[x.value.outlet]}),qi(g,(x,w)=>Wv(x,a.getContext(w),d)),d}function Wv(i,o,a){const u=dg(i),d=i.value;qi(u,(g,x)=>{Wv(g,d.component?o?o.children.getContext(x):null:o,a)}),a.canDeactivateChecks.push(new eD(d.component&&o&&o.outlet&&o.outlet.isActivated?o.outlet.component:null,d))}function Zv(i){return"function"==typeof i}function LI(i){return i instanceof HT||"EmptyError"===i?.name}const nD=Symbol("INITIAL_VALUE");function pg(){return zl(i=>O2(i.map(o=>o.pipe(Fv(1),function RL(...i){const o=Ka(i);return Br((a,u)=>{(o?dI(i,a,o):dI(i,a)).subscribe(u)})}(nD)))).pipe(un(o=>{for(const a of o)if(!0!==a){if(a===nD)return nD;if(!1===a||a instanceof ff)return a}return!0}),Vc(o=>o!==nD),Fv(1)))}function wP(i){return function Vl(...i){return qa(i)}(po(o=>{if(mf(o))throw pP(0,o)}),un(o=>!0===o))}const kI={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function EP(i,o,a,u,d){const g=OI(i,o,a);return g.matched?function nO(i,o,a,u){const d=o.canMatch;return d&&0!==d.length?Ve(d.map(x=>{const w=fg(x,i);return vh(function Gk(i){return i&&Zv(i.canMatch)}(w)?w.canMatch(o,a):i.runInContext(()=>w(o,a)))})).pipe(pg(),wP()):Ve(!0)}(u=vP(o,u),o,a).pipe(un(x=>!0===x?g:{...kI})):Ve(g)}function OI(i,o,a){if(""===o.path)return"full"===o.pathMatch&&(i.hasChildren()||a.length>0)?{...kI}:{matched:!0,consumedSegments:[],remainingSegments:a,parameters:{},positionalParamSegments:{}};const d=(o.matcher||NL)(a,i,o);if(!d)return{...kI};const g={};qi(d.posParams,(w,S)=>{g[S]=w.path});const x=d.consumed.length>0?{...g,...d.consumed[d.consumed.length-1].parameters}:g;return{matched:!0,consumedSegments:d.consumed,remainingSegments:a.slice(d.consumed.length),parameters:x,positionalParamSegments:d.posParams??{}}}function rD(i,o,a,u,d="corrected"){if(a.length>0&&function oO(i,o,a){return a.some(u=>iD(i,o,u)&&ra(u)!==vn)}(i,a,u)){const x=new wn(o,function iO(i,o,a,u){const d={};d[vn]=u,u._sourceSegment=i,u._segmentIndexShift=o.length;for(const g of a)if(""===g.path&&ra(g)!==vn){const x=new wn([],{});x._sourceSegment=i,x._segmentIndexShift=o.length,d[ra(g)]=x}return d}(i,o,u,new wn(a,i.children)));return x._sourceSegment=i,x._segmentIndexShift=o.length,{segmentGroup:x,slicedSegments:[]}}if(0===a.length&&function sO(i,o,a){return a.some(u=>iD(i,o,u))}(i,a,u)){const x=new wn(i.segments,function rO(i,o,a,u,d,g){const x={};for(const w of u)if(iD(i,a,w)&&!d[ra(w)]){const S=new wn([],{});S._sourceSegment=i,S._segmentIndexShift="legacy"===g?i.segments.length:o.length,x[ra(w)]=S}return{...d,...x}}(i,o,a,u,i.children,d));return x._sourceSegment=i,x._segmentIndexShift=o.length,{segmentGroup:x,slicedSegments:a}}const g=new wn(i.segments,i.children);return g._sourceSegment=i,g._segmentIndexShift=o.length,{segmentGroup:g,slicedSegments:a}}function iD(i,o,a){return(!(i.hasChildren()||o.length>0)||"full"!==a.pathMatch)&&""===a.path}function TP(i,o,a,u){return!!(ra(i)===u||u!==vn&&iD(o,a,i))&&("**"===i.path||OI(o,i,a).matched)}function DP(i,o,a){return 0===o.length&&!i.children[a]}const oD=!1;class sD{constructor(o){this.segmentGroup=o||null}}class SP{constructor(o){this.urlTree=o}}function Xv(i){return Ov(new sD(i))}function CP(i){return Ov(new SP(i))}class uO{constructor(o,a,u,d,g){this.injector=o,this.configLoader=a,this.urlSerializer=u,this.urlTree=d,this.config=g,this.allowRedirects=!0}apply(){const o=rD(this.urlTree.root,[],[],this.config).segmentGroup,a=new wn(o.segments,o.children);return this.expandSegmentGroup(this.injector,this.config,a,vn).pipe(un(g=>this.createUrlTree(KT(g),this.urlTree.queryParams,this.urlTree.fragment))).pipe(yh(g=>{if(g instanceof SP)return this.allowRedirects=!1,this.match(g.urlTree);throw g instanceof sD?this.noMatchError(g):g}))}match(o){return this.expandSegmentGroup(this.injector,this.config,o.root,vn).pipe(un(d=>this.createUrlTree(KT(d),o.queryParams,o.fragment))).pipe(yh(d=>{throw d instanceof sD?this.noMatchError(d):d}))}noMatchError(o){return new ne(4002,oD)}createUrlTree(o,a,u){const d=vI(o);return new ff(d,a,u)}expandSegmentGroup(o,a,u,d){return 0===u.segments.length&&u.hasChildren()?this.expandChildren(o,a,u).pipe(un(g=>new wn([],g))):this.expandSegment(o,u,a,u.segments,d,!0)}expandChildren(o,a,u){const d=[];for(const g of Object.keys(u.children))"primary"===g?d.unshift(g):d.push(g);return Lr(d).pipe(_h(g=>{const x=u.children[g],w=xP(a,g);return this.expandSegmentGroup(o,w,x,g).pipe(un(S=>({segment:S,outlet:g})))}),j2((g,x)=>(g[x.outlet]=x.segment,g),{}),V2())}expandSegment(o,a,u,d,g,x){return Lr(u).pipe(_h(w=>this.expandSegmentAgainstRoute(o,a,u,w,d,g,x).pipe(yh(P=>{if(P instanceof sD)return Ve(null);throw P}))),gh(w=>!!w),yh((w,S)=>{if(LI(w))return DP(a,d,g)?Ve(new wn([],{})):Xv(a);throw w}))}expandSegmentAgainstRoute(o,a,u,d,g,x,w){return TP(d,a,g,x)?void 0===d.redirectTo?this.matchSegmentAgainstRoute(o,a,d,g,x):w&&this.allowRedirects?this.expandSegmentAgainstRouteUsingRedirect(o,a,u,d,g,x):Xv(a):Xv(a)}expandSegmentAgainstRouteUsingRedirect(o,a,u,d,g,x){return"**"===d.path?this.expandWildCardWithParamsAgainstRouteUsingRedirect(o,u,d,x):this.expandRegularSegmentAgainstRouteUsingRedirect(o,a,u,d,g,x)}expandWildCardWithParamsAgainstRouteUsingRedirect(o,a,u,d){const g=this.applyRedirectCommands([],u.redirectTo,{});return u.redirectTo.startsWith("/")?CP(g):this.lineralizeSegments(u,g).pipe(wr(x=>{const w=new wn(x,{});return this.expandSegment(o,w,a,x,d,!1)}))}expandRegularSegmentAgainstRouteUsingRedirect(o,a,u,d,g,x){const{matched:w,consumedSegments:S,remainingSegments:P,positionalParamSegments:k}=OI(a,d,g);if(!w)return Xv(a);const F=this.applyRedirectCommands(S,d.redirectTo,k);return d.redirectTo.startsWith("/")?CP(F):this.lineralizeSegments(d,F).pipe(wr(G=>this.expandSegment(o,a,u,G.concat(P),x,!1)))}matchSegmentAgainstRoute(o,a,u,d,g){return"**"===u.path?(o=vP(u,o),u.loadChildren?(u._loadedRoutes?Ve({routes:u._loadedRoutes,injector:u._loadedInjector}):this.configLoader.loadChildren(o,u)).pipe(un(w=>(u._loadedRoutes=w.routes,u._loadedInjector=w.injector,new wn(d,{})))):Ve(new wn(d,{}))):EP(a,u,d,o).pipe(zl(({matched:x,consumedSegments:w,remainingSegments:S})=>x?this.getChildConfig(o=u._injector??o,u,d).pipe(wr(k=>{const F=k.injector??o,G=k.routes,{segmentGroup:J,slicedSegments:ct}=rD(a,w,S,G),mt=new wn(J.segments,J.children);if(0===ct.length&&mt.hasChildren())return this.expandChildren(F,G,mt).pipe(un(Mt=>new wn(w,Mt)));if(0===G.length&&0===ct.length)return Ve(new wn(w,{}));const St=ra(u)===g;return this.expandSegment(F,mt,G,ct,St?vn:g,!0).pipe(un(Qt=>new wn(w.concat(Qt.segments),Qt.children)))})):Xv(a)))}getChildConfig(o,a,u){return a.children?Ve({routes:a.children,injector:o}):a.loadChildren?void 0!==a._loadedRoutes?Ve({routes:a._loadedRoutes,injector:a._loadedInjector}):function eO(i,o,a,u){const d=o.canLoad;return void 0===d||0===d.length?Ve(!0):Ve(d.map(x=>{const w=fg(x,i);return vh(function Vk(i){return i&&Zv(i.canLoad)}(w)?w.canLoad(o,a):i.runInContext(()=>w(o,a)))})).pipe(pg(),wP())}(o,a,u).pipe(wr(d=>d?this.configLoader.loadChildren(o,a).pipe(po(g=>{a._loadedRoutes=g.routes,a._loadedInjector=g.injector})):function lO(i){return Ov(mP(oD,3))}())):Ve({routes:[],injector:o})}lineralizeSegments(o,a){let u=[],d=a.root;for(;;){if(u=u.concat(d.segments),0===d.numberOfChildren)return Ve(u);if(d.numberOfChildren>1||!d.children[vn])return Ov(new ne(4e3,oD));d=d.children[vn]}}applyRedirectCommands(o,a,u){return this.applyRedirectCreateUrlTree(a,this.urlSerializer.parse(a),o,u)}applyRedirectCreateUrlTree(o,a,u,d){const g=this.createSegmentGroup(o,a.root,u,d);return new ff(g,this.createQueryParams(a.queryParams,this.urlTree.queryParams),a.fragment)}createQueryParams(o,a){const u={};return qi(o,(d,g)=>{if("string"==typeof d&&d.startsWith(":")){const w=d.substring(1);u[g]=a[w]}else u[g]=d}),u}createSegmentGroup(o,a,u,d){const g=this.createSegments(o,a.segments,u,d);let x={};return qi(a.children,(w,S)=>{x[S]=this.createSegmentGroup(o,w,u,d)}),new wn(g,x)}createSegments(o,a,u,d){return a.map(g=>g.path.startsWith(":")?this.findPosParam(o,g,d):this.findOrReturn(g,u))}findPosParam(o,a,u){const d=u[a.path.substring(1)];if(!d)throw new ne(4001,oD);return d}findOrReturn(o,a){let u=0;for(const d of a){if(d.path===o.path)return a.splice(u),d;u++}return o}}class dO{}class mO{constructor(o,a,u,d,g,x,w,S){this.injector=o,this.rootComponentType=a,this.config=u,this.urlTree=d,this.url=g,this.paramsInheritanceStrategy=x,this.relativeLinkResolution=w,this.urlSerializer=S}recognize(){const o=rD(this.urlTree.root,[],[],this.config.filter(a=>void 0===a.redirectTo),this.relativeLinkResolution).segmentGroup;return this.processSegmentGroup(this.injector,this.config,o,vn).pipe(un(a=>{if(null===a)return null;const u=new QT([],Object.freeze({}),Object.freeze({...this.urlTree.queryParams}),this.urlTree.fragment,{},vn,this.rootComponentType,null,this.urlTree.root,-1,{}),d=new $c(u,a),g=new dP(this.url,d);return this.inheritParamsAndData(g._root),g}))}inheritParamsAndData(o){const a=o.value,u=hP(a,this.paramsInheritanceStrategy);a.params=Object.freeze(u.params),a.data=Object.freeze(u.data),o.children.forEach(d=>this.inheritParamsAndData(d))}processSegmentGroup(o,a,u,d){return 0===u.segments.length&&u.hasChildren()?this.processChildren(o,a,u):this.processSegment(o,a,u,u.segments,d)}processChildren(o,a,u){return Lr(Object.keys(u.children)).pipe(_h(d=>{const g=u.children[d],x=xP(a,d);return this.processSegmentGroup(o,x,g,d)}),j2((d,g)=>d&&g?(d.push(...g),d):null),function OL(i,o=!1){return Br((a,u)=>{let d=0;a.subscribe(mr(u,g=>{const x=i(g,d++);(x||o)&&u.next(g),!x&&u.complete()}))})}(d=>null!==d),GT(null),V2(),un(d=>{if(null===d)return null;const g=MP(d);return function gO(i){i.sort((o,a)=>o.value.outlet===vn?-1:a.value.outlet===vn?1:o.value.outlet.localeCompare(a.value.outlet))}(g),g}))}processSegment(o,a,u,d,g){return Lr(a).pipe(_h(x=>this.processSegmentAgainstRoute(x._injector??o,x,u,d,g)),gh(x=>!!x),yh(x=>{if(LI(x))return DP(u,d,g)?Ve([]):Ve(null);throw x}))}processSegmentAgainstRoute(o,a,u,d,g){if(a.redirectTo||!TP(a,u,d,g))return Ve(null);let x;if("**"===a.path){const w=d.length>0?H2(d).parameters:{},S=AP(u)+d.length;x=Ve({snapshot:new QT(d,w,Object.freeze({...this.urlTree.queryParams}),this.urlTree.fragment,RP(a),ra(a),a.component??a._loadedComponent??null,a,IP(u),S,LP(a),S),consumedSegments:[],remainingSegments:[]})}else x=EP(u,a,d,o).pipe(un(({matched:w,consumedSegments:S,remainingSegments:P,parameters:k})=>{if(!w)return null;const F=AP(u)+S.length;return{snapshot:new QT(S,k,Object.freeze({...this.urlTree.queryParams}),this.urlTree.fragment,RP(a),ra(a),a.component??a._loadedComponent??null,a,IP(u),F,LP(a),F),consumedSegments:S,remainingSegments:P}}));return x.pipe(zl(w=>{if(null===w)return Ve(null);const{snapshot:S,consumedSegments:P,remainingSegments:k}=w;o=a._injector??o;const F=a._loadedInjector??o,G=function _O(i){return i.children?i.children:i.loadChildren?i._loadedRoutes:[]}(a),{segmentGroup:J,slicedSegments:ct}=rD(u,P,k,G.filter(St=>void 0===St.redirectTo),this.relativeLinkResolution);if(0===ct.length&&J.hasChildren())return this.processChildren(F,G,J).pipe(un(St=>null===St?null:[new $c(S,St)]));if(0===G.length&&0===ct.length)return Ve([new $c(S,[])]);const mt=ra(a)===g;return this.processSegment(F,G,J,ct,mt?vn:g).pipe(un(St=>null===St?null:[new $c(S,St)]))}))}}function yO(i){const o=i.value.routeConfig;return o&&""===o.path&&void 0===o.redirectTo}function MP(i){const o=[],a=new Set;for(const u of i){if(!yO(u)){o.push(u);continue}const d=o.find(g=>u.value.routeConfig===g.value.routeConfig);void 0!==d?(d.children.push(...u.children),a.add(d)):o.push(u)}for(const u of a){const d=MP(u.children);o.push(new $c(u.value,d))}return o.filter(u=>!a.has(u))}function IP(i){let o=i;for(;o._sourceSegment;)o=o._sourceSegment;return o}function AP(i){let o=i,a=o._segmentIndexShift??0;for(;o._sourceSegment;)o=o._sourceSegment,a+=o._segmentIndexShift??0;return a-1}function RP(i){return i.data||{}}function LP(i){return i.resolve||{}}function kP(i){return"string"==typeof i.title||null===i.title}function FI(i){return zl(o=>{const a=i(o);return a?Lr(a).pipe(un(()=>o)):Ve(o)})}let OP=(()=>{class i{buildTitle(a){let u,d=a.root;for(;void 0!==d;)u=this.getResolvedTitleForRoute(d)??u,d=d.children.find(g=>g.outlet===vn);return u}getResolvedTitleForRoute(a){return a.data[zv]}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:function(){return yr(FP)},providedIn:"root"}),i})(),FP=(()=>{class i extends OP{constructor(a){super(),this.title=a}updateTitle(a){const u=this.buildTitle(a);void 0!==u&&this.title.setTitle(u)}}return i.\u0275fac=function(a){return new(a||i)(fe(R2))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();class SO{}class MO extends class CO{shouldDetach(o){return!1}store(o,a){}shouldAttach(o){return!1}retrieve(o){return null}shouldReuseRoute(o,a){return o.routeConfig===a.routeConfig}}{}const lD=new $e("",{providedIn:"root",factory:()=>({})}),zI=new $e("ROUTES");let NI=(()=>{class i{constructor(a,u){this.injector=a,this.compiler=u,this.componentLoaders=new WeakMap,this.childrenLoaders=new WeakMap}loadComponent(a){if(this.componentLoaders.get(a))return this.componentLoaders.get(a);if(a._loadedComponent)return Ve(a._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(a);const u=vh(a.loadComponent()).pipe(po(g=>{this.onLoadEndListener&&this.onLoadEndListener(a),a._loadedComponent=g}),mI(()=>{this.componentLoaders.delete(a)})),d=new N2(u,()=>new yi).pipe(fI());return this.componentLoaders.set(a,d),d}loadChildren(a,u){if(this.childrenLoaders.get(u))return this.childrenLoaders.get(u);if(u._loadedRoutes)return Ve({routes:u._loadedRoutes,injector:u._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(u);const g=this.loadModuleFactoryOrRoutes(u.loadChildren).pipe(un(w=>{this.onLoadEndListener&&this.onLoadEndListener(u);let S,P,k=!1;Array.isArray(w)?P=w:(S=w.create(a).injector,P=$2(S.get(zI,[],Oe.Self|Oe.Optional)));return{routes:P.map(RI),injector:S}}),mI(()=>{this.childrenLoaders.delete(u)})),x=new N2(g,()=>new yi).pipe(fI());return this.childrenLoaders.set(u,x),x}loadModuleFactoryOrRoutes(a){return vh(a()).pipe(wr(u=>u instanceof E0||Array.isArray(u)?Ve(u):Lr(this.compiler.compileModuleAsync(u))))}}return i.\u0275fac=function(a){return new(a||i)(fe(Yr),fe(Wm))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();class AO{}class PO{shouldProcessUrl(o){return!0}extract(o){return o}merge(o,a){return o}}function RO(i){throw i}function LO(i,o,a){return o.parse("/")}const kO={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},OO={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"};function NP(){const i=yr(Y2),o=yr(Hv),a=yr(bv),u=yr(Yr),d=yr(Wm),g=yr(zI,{optional:!0})??[],x=yr(lD,{optional:!0})??{},w=yr(FP),S=yr(OP,{optional:!0}),P=yr(AO,{optional:!0}),k=yr(SO,{optional:!0}),F=new Wi(null,i,o,a,u,d,$2(g));return P&&(F.urlHandlingStrategy=P),k&&(F.routeReuseStrategy=k),F.titleStrategy=S??w,function FO(i,o){i.errorHandler&&(o.errorHandler=i.errorHandler),i.malformedUriErrorHandler&&(o.malformedUriErrorHandler=i.malformedUriErrorHandler),i.onSameUrlNavigation&&(o.onSameUrlNavigation=i.onSameUrlNavigation),i.paramsInheritanceStrategy&&(o.paramsInheritanceStrategy=i.paramsInheritanceStrategy),i.relativeLinkResolution&&(o.relativeLinkResolution=i.relativeLinkResolution),i.urlUpdateStrategy&&(o.urlUpdateStrategy=i.urlUpdateStrategy),i.canceledNavigationResolution&&(o.canceledNavigationResolution=i.canceledNavigationResolution)}(x,F),F}let Wi=(()=>{class i{constructor(a,u,d,g,x,w,S){this.rootComponentType=a,this.urlSerializer=u,this.rootContexts=d,this.location=g,this.config=S,this.lastSuccessfulNavigation=null,this.currentNavigation=null,this.disposed=!1,this.navigationId=0,this.currentPageId=0,this.isNgZoneEnabled=!1,this.events=new yi,this.errorHandler=RO,this.malformedUriErrorHandler=LO,this.navigated=!1,this.lastSuccessfulId=-1,this.afterPreactivation=()=>Ve(void 0),this.urlHandlingStrategy=new PO,this.routeReuseStrategy=new MO,this.onSameUrlNavigation="ignore",this.paramsInheritanceStrategy="emptyOnly",this.urlUpdateStrategy="deferred",this.relativeLinkResolution="corrected",this.canceledNavigationResolution="replace",this.configLoader=x.get(NI),this.configLoader.onLoadEndListener=G=>this.triggerEvent(new _k(G)),this.configLoader.onLoadStartListener=G=>this.triggerEvent(new gk(G)),this.ngModule=x.get(Al),this.console=x.get(lM);const F=x.get(Hr);this.isNgZoneEnabled=F instanceof Hr&&Hr.isInAngularZone(),this.resetConfig(S),this.currentUrlTree=function jL(){return new ff(new wn([],{}),{},null)}(),this.rawUrlTree=this.currentUrlTree,this.browserUrlTree=this.currentUrlTree,this.routerState=uP(this.currentUrlTree,this.rootComponentType),this.transitions=new Ua({id:0,targetPageId:0,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,extractedUrl:this.urlHandlingStrategy.extract(this.currentUrlTree),urlAfterRedirects:this.urlHandlingStrategy.extract(this.currentUrlTree),rawUrl:this.currentUrlTree,extras:{},resolve:null,reject:null,promise:Promise.resolve(!0),source:"imperative",restoredState:null,currentSnapshot:this.routerState.snapshot,targetSnapshot:null,currentRouterState:this.routerState,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null}),this.navigations=this.setupNavigations(this.transitions),this.processNavigations()}get browserPageId(){return this.location.getState()?.\u0275routerPageId}setupNavigations(a){const u=this.events;return a.pipe(Vc(d=>0!==d.id),un(d=>({...d,extractedUrl:this.urlHandlingStrategy.extract(d.rawUrl)})),zl(d=>{let g=!1,x=!1;return Ve(d).pipe(po(w=>{this.currentNavigation={id:w.id,initialUrl:w.rawUrl,extractedUrl:w.extractedUrl,trigger:w.source,extras:w.extras,previousNavigation:this.lastSuccessfulNavigation?{...this.lastSuccessfulNavigation,previousNavigation:null}:null}}),zl(w=>{const S=this.browserUrlTree.toString(),P=!this.navigated||w.extractedUrl.toString()!==S||S!==this.currentUrlTree.toString();if(("reload"===this.onSameUrlNavigation||P)&&this.urlHandlingStrategy.shouldProcessUrl(w.rawUrl))return BP(w.source)&&(this.browserUrlTree=w.extractedUrl),Ve(w).pipe(zl(F=>{const G=this.transitions.getValue();return u.next(new EI(F.id,this.serializeUrl(F.extractedUrl),F.source,F.restoredState)),G!==this.transitions.getValue()?Ss:Promise.resolve(F)}),function hO(i,o,a,u){return zl(d=>function cO(i,o,a,u,d){return new uO(i,o,a,u,d).apply()}(i,o,a,d.extractedUrl,u).pipe(un(g=>({...d,urlAfterRedirects:g}))))}(this.ngModule.injector,this.configLoader,this.urlSerializer,this.config),po(F=>{this.currentNavigation={...this.currentNavigation,finalUrl:F.urlAfterRedirects},d.urlAfterRedirects=F.urlAfterRedirects}),function xO(i,o,a,u,d,g){return wr(x=>function pO(i,o,a,u,d,g,x="emptyOnly",w="legacy"){return new mO(i,o,a,u,d,x,w,g).recognize().pipe(zl(S=>null===S?function fO(i){return new Nn(o=>o.error(i))}(new dO):Ve(S)))}(i,o,a,x.urlAfterRedirects,u.serialize(x.urlAfterRedirects),u,d,g).pipe(un(w=>({...x,targetSnapshot:w}))))}(this.ngModule.injector,this.rootComponentType,this.config,this.urlSerializer,this.paramsInheritanceStrategy,this.relativeLinkResolution),po(F=>{if(d.targetSnapshot=F.targetSnapshot,"eager"===this.urlUpdateStrategy){if(!F.extras.skipLocationChange){const J=this.urlHandlingStrategy.merge(F.urlAfterRedirects,F.rawUrl);this.setBrowserUrl(J,F)}this.browserUrlTree=F.urlAfterRedirects}const G=new hk(F.id,this.serializeUrl(F.extractedUrl),this.serializeUrl(F.urlAfterRedirects),F.targetSnapshot);u.next(G)}));if(P&&this.rawUrlTree&&this.urlHandlingStrategy.shouldProcessUrl(this.rawUrlTree)){const{id:G,extractedUrl:J,source:ct,restoredState:mt,extras:St}=w,Lt=new EI(G,this.serializeUrl(J),ct,mt);u.next(Lt);const Qt=uP(J,this.rootComponentType).snapshot;return Ve(d={...w,targetSnapshot:Qt,urlAfterRedirects:J,extras:{...St,skipLocationChange:!1,replaceUrl:!1}})}return this.rawUrlTree=w.rawUrl,w.resolve(null),Ss}),po(w=>{const S=new dk(w.id,this.serializeUrl(w.extractedUrl),this.serializeUrl(w.urlAfterRedirects),w.targetSnapshot);this.triggerEvent(S)}),un(w=>d={...w,guards:Fk(w.targetSnapshot,w.currentSnapshot,this.rootContexts)}),function Wk(i,o){return wr(a=>{const{targetSnapshot:u,currentSnapshot:d,guards:{canActivateChecks:g,canDeactivateChecks:x}}=a;return 0===x.length&&0===g.length?Ve({...a,guardsResult:!0}):function Zk(i,o,a,u){return Lr(i).pipe(wr(d=>function tO(i,o,a,u,d){const g=o&&o.routeConfig?o.routeConfig.canDeactivate:null;return g&&0!==g.length?Ve(g.map(w=>{const S=Gv(o)??d,P=fg(w,S);return vh(function Hk(i){return i&&Zv(i.canDeactivate)}(P)?P.canDeactivate(i,o,a,u):S.runInContext(()=>P(i,o,a,u))).pipe(gh())})).pipe(pg()):Ve(!0)}(d.component,d.route,a,o,u)),gh(d=>!0!==d,!0))}(x,u,d,i).pipe(wr(w=>w&&function jk(i){return"boolean"==typeof i}(w)?function Xk(i,o,a,u){return Lr(o).pipe(_h(d=>dI(function Kk(i,o){return null!==i&&o&&o(new yk(i)),Ve(!0)}(d.route.parent,u),function Yk(i,o){return null!==i&&o&&o(new xk(i)),Ve(!0)}(d.route,u),function Qk(i,o,a){const u=o[o.length-1],g=o.slice(0,o.length-1).reverse().map(x=>function zk(i){const o=i.routeConfig?i.routeConfig.canActivateChild:null;return o&&0!==o.length?{node:i,guards:o}:null}(x)).filter(x=>null!==x).map(x=>z2(()=>Ve(x.guards.map(S=>{const P=Gv(x.node)??a,k=fg(S,P);return vh(function $k(i){return i&&Zv(i.canActivateChild)}(k)?k.canActivateChild(u,i):P.runInContext(()=>k(u,i))).pipe(gh())})).pipe(pg())));return Ve(g).pipe(pg())}(i,d.path,a),function Jk(i,o,a){const u=o.routeConfig?o.routeConfig.canActivate:null;if(!u||0===u.length)return Ve(!0);const d=u.map(g=>z2(()=>{const x=Gv(o)??a,w=fg(g,x);return vh(function Uk(i){return i&&Zv(i.canActivate)}(w)?w.canActivate(o,i):x.runInContext(()=>w(o,i))).pipe(gh())}));return Ve(d).pipe(pg())}(i,d.route,a))),gh(d=>!0!==d,!0))}(u,g,i,o):Ve(w)),un(w=>({...a,guardsResult:w})))})}(this.ngModule.injector,w=>this.triggerEvent(w)),po(w=>{if(d.guardsResult=w.guardsResult,mf(w.guardsResult))throw pP(0,w.guardsResult);const S=new fk(w.id,this.serializeUrl(w.extractedUrl),this.serializeUrl(w.urlAfterRedirects),w.targetSnapshot,!!w.guardsResult);this.triggerEvent(S)}),Vc(w=>!!w.guardsResult||(this.restoreHistory(w),this.cancelNavigationTransition(w,"",3),!1)),FI(w=>{if(w.guards.canActivateChecks.length)return Ve(w).pipe(po(S=>{const P=new pk(S.id,this.serializeUrl(S.extractedUrl),this.serializeUrl(S.urlAfterRedirects),S.targetSnapshot);this.triggerEvent(P)}),zl(S=>{let P=!1;return Ve(S).pipe(function bO(i,o){return wr(a=>{const{targetSnapshot:u,guards:{canActivateChecks:d}}=a;if(!d.length)return Ve(a);let g=0;return Lr(d).pipe(_h(x=>function wO(i,o,a,u){const d=i.routeConfig,g=i._resolve;return void 0!==d?.title&&!kP(d)&&(g[zv]=d.title),function EO(i,o,a,u){const d=function TO(i){return[...Object.keys(i),...Object.getOwnPropertySymbols(i)]}(i);if(0===d.length)return Ve({});const g={};return Lr(d).pipe(wr(x=>function DO(i,o,a,u){const d=Gv(o)??u,g=fg(i,d);return vh(g.resolve?g.resolve(o,a):d.runInContext(()=>g(o,a)))}(i[x],o,a,u).pipe(gh(),po(w=>{g[x]=w}))),pI(1),function FL(i){return un(()=>i)}(g),yh(x=>LI(x)?Ss:Ov(x)))}(g,i,o,u).pipe(un(x=>(i._resolvedData=x,i.data=hP(i,a).resolve,d&&kP(d)&&(i.data[zv]=d.title),null)))}(x.route,u,i,o)),po(()=>g++),pI(1),wr(x=>g===d.length?Ve(a):Ss))})}(this.paramsInheritanceStrategy,this.ngModule.injector),po({next:()=>P=!0,complete:()=>{P||(this.restoreHistory(S),this.cancelNavigationTransition(S,"",2))}}))}),po(S=>{const P=new mk(S.id,this.serializeUrl(S.extractedUrl),this.serializeUrl(S.urlAfterRedirects),S.targetSnapshot);this.triggerEvent(P)}))}),FI(w=>{const S=P=>{const k=[];P.routeConfig?.loadComponent&&!P.routeConfig._loadedComponent&&k.push(this.configLoader.loadComponent(P.routeConfig).pipe(po(F=>{P.component=F}),un(()=>{})));for(const F of P.children)k.push(...S(F));return k};return O2(S(w.targetSnapshot.root)).pipe(GT(),Fv(1))}),FI(()=>this.afterPreactivation()),un(w=>{const S=function Dk(i,o,a){const u=$v(i,o._root,a?a._root:void 0);return new cP(u,o)}(this.routeReuseStrategy,w.targetSnapshot,w.currentRouterState);return d={...w,targetRouterState:S}}),po(w=>{this.currentUrlTree=w.urlAfterRedirects,this.rawUrlTree=this.urlHandlingStrategy.merge(w.urlAfterRedirects,w.rawUrl),this.routerState=w.targetRouterState,"deferred"===this.urlUpdateStrategy&&(w.extras.skipLocationChange||this.setBrowserUrl(this.rawUrlTree,w),this.browserUrlTree=w.urlAfterRedirects)}),((i,o,a)=>un(u=>(new Ok(o,u.targetRouterState,u.currentRouterState,a).activate(i),u)))(this.rootContexts,this.routeReuseStrategy,w=>this.triggerEvent(w)),po({next(){g=!0},complete(){g=!0}}),mI(()=>{g||x||this.cancelNavigationTransition(d,"",1),this.currentNavigation?.id===d.id&&(this.currentNavigation=null)}),yh(w=>{if(x=!0,_P(w)){gP(w)||(this.navigated=!0,this.restoreHistory(d,!0));const S=new JT(d.id,this.serializeUrl(d.extractedUrl),w.message,w.cancellationCode);if(u.next(S),gP(w)){const P=this.urlHandlingStrategy.merge(w.url,this.rawUrlTree),k={skipLocationChange:d.extras.skipLocationChange,replaceUrl:"eager"===this.urlUpdateStrategy||BP(d.source)};this.scheduleNavigation(P,"imperative",null,k,{resolve:d.resolve,reject:d.reject,promise:d.promise})}else d.resolve(!1)}else{this.restoreHistory(d,!0);const S=new sP(d.id,this.serializeUrl(d.extractedUrl),w,d.targetSnapshot??void 0);u.next(S);try{d.resolve(this.errorHandler(w))}catch(P){d.reject(P)}}return Ss}))}))}resetRootComponentType(a){this.rootComponentType=a,this.routerState.root.component=this.rootComponentType}setTransition(a){this.transitions.next({...this.transitions.value,...a})}initialNavigation(){this.setUpLocationChangeListener(),0===this.navigationId&&this.navigateByUrl(this.location.path(!0),{replaceUrl:!0})}setUpLocationChangeListener(){this.locationSubscription||(this.locationSubscription=this.location.subscribe(a=>{const u="popstate"===a.type?"popstate":"hashchange";"popstate"===u&&setTimeout(()=>{const d={replaceUrl:!0},g=a.state?.navigationId?a.state:null;if(g){const w={...g};delete w.navigationId,delete w.\u0275routerPageId,0!==Object.keys(w).length&&(d.state=w)}const x=this.parseUrl(a.url);this.scheduleNavigation(x,u,g,d)},0)}))}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return this.currentNavigation}triggerEvent(a){this.events.next(a)}resetConfig(a){this.config=a.map(RI),this.navigated=!1,this.lastSuccessfulId=-1}ngOnDestroy(){this.dispose()}dispose(){this.transitions.complete(),this.locationSubscription&&(this.locationSubscription.unsubscribe(),this.locationSubscription=void 0),this.disposed=!0}createUrlTree(a,u={}){const{relativeTo:d,queryParams:g,fragment:x,queryParamsHandling:w,preserveFragment:S}=u,P=d||this.routerState.root,k=S?this.currentUrlTree.fragment:x;let F=null;switch(w){case"merge":F={...this.currentUrlTree.queryParams,...g};break;case"preserve":F=this.currentUrlTree.queryParams;break;default:F=g||null}return null!==F&&(F=this.removeEmptyProps(F)),ok(P,this.currentUrlTree,a,F,k??null)}navigateByUrl(a,u={skipLocationChange:!1}){const d=mf(a)?a:this.parseUrl(a),g=this.urlHandlingStrategy.merge(d,this.rawUrlTree);return this.scheduleNavigation(g,"imperative",null,u)}navigate(a,u={skipLocationChange:!1}){return function zO(i){for(let o=0;o<i.length;o++){if(null==i[o])throw new ne(4008,false)}}(a),this.navigateByUrl(this.createUrlTree(a,u),u)}serializeUrl(a){return this.urlSerializer.serialize(a)}parseUrl(a){let u;try{u=this.urlSerializer.parse(a)}catch(d){u=this.malformedUriErrorHandler(d,this.urlSerializer,a)}return u}isActive(a,u){let d;if(d=!0===u?{...kO}:!1===u?{...OO}:u,mf(a))return q2(this.currentUrlTree,a,d);const g=this.parseUrl(a);return q2(this.currentUrlTree,g,d)}removeEmptyProps(a){return Object.keys(a).reduce((u,d)=>{const g=a[d];return null!=g&&(u[d]=g),u},{})}processNavigations(){this.navigations.subscribe(a=>{this.navigated=!0,this.lastSuccessfulId=a.id,this.currentPageId=a.targetPageId,this.events.next(new gf(a.id,this.serializeUrl(a.extractedUrl),this.serializeUrl(this.currentUrlTree))),this.lastSuccessfulNavigation=this.currentNavigation,this.titleStrategy?.updateTitle(this.routerState.snapshot),a.resolve(!0)},a=>{this.console.warn(`Unhandled Navigation Error: ${a}`)})}scheduleNavigation(a,u,d,g,x){if(this.disposed)return Promise.resolve(!1);let w,S,P;x?(w=x.resolve,S=x.reject,P=x.promise):P=new Promise((G,J)=>{w=G,S=J});const k=++this.navigationId;let F;return"computed"===this.canceledNavigationResolution?(0===this.currentPageId&&(d=this.location.getState()),F=d&&d.\u0275routerPageId?d.\u0275routerPageId:g.replaceUrl||g.skipLocationChange?this.browserPageId??0:(this.browserPageId??0)+1):F=0,this.setTransition({id:k,targetPageId:F,source:u,restoredState:d,currentUrlTree:this.currentUrlTree,currentRawUrl:this.rawUrlTree,rawUrl:a,extras:g,resolve:w,reject:S,promise:P,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),P.catch(G=>Promise.reject(G))}setBrowserUrl(a,u){const d=this.urlSerializer.serialize(a),g={...u.extras.state,...this.generateNgRouterState(u.id,u.targetPageId)};this.location.isCurrentPathEqualTo(d)||u.extras.replaceUrl?this.location.replaceState(d,"",g):this.location.go(d,"",g)}restoreHistory(a,u=!1){if("computed"===this.canceledNavigationResolution){const d=this.currentPageId-a.targetPageId;"popstate"!==a.source&&"eager"!==this.urlUpdateStrategy&&this.currentUrlTree!==this.currentNavigation?.finalUrl||0===d?this.currentUrlTree===this.currentNavigation?.finalUrl&&0===d&&(this.resetState(a),this.browserUrlTree=a.currentUrlTree,this.resetUrlToCurrentUrlTree()):this.location.historyGo(d)}else"replace"===this.canceledNavigationResolution&&(u&&this.resetState(a),this.resetUrlToCurrentUrlTree())}resetState(a){this.routerState=a.currentRouterState,this.currentUrlTree=a.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,a.rawUrl)}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.rawUrlTree),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}cancelNavigationTransition(a,u,d){const g=new JT(a.id,this.serializeUrl(a.extractedUrl),u,d);this.triggerEvent(g),a.resolve(!1)}generateNgRouterState(a,u){return"computed"===this.canceledNavigationResolution?{navigationId:a,\u0275routerPageId:u}:{navigationId:a}}}return i.\u0275fac=function(a){fd()},i.\u0275prov=Ue({token:i,factory:function(){return NP()},providedIn:"root"}),i})();function BP(i){return"imperative"!==i}class jP{}let jO=(()=>{class i{constructor(a,u,d,g,x){this.router=a,this.injector=d,this.preloadingStrategy=g,this.loader=x}setUpPreloading(){this.subscription=this.router.events.pipe(Vc(a=>a instanceof gf),_h(()=>this.preload())).subscribe(()=>{})}preload(){return this.processRoutes(this.injector,this.router.config)}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}processRoutes(a,u){const d=[];for(const g of u){g.providers&&!g._injector&&(g._injector=Do(g.providers,a,`Route: ${g.path}`));const x=g._injector??a,w=g._loadedInjector??x;g.loadChildren&&!g._loadedRoutes&&void 0===g.canLoad||g.loadComponent&&!g._loadedComponent?d.push(this.preloadConfig(x,g)):(g.children||g._loadedRoutes)&&d.push(this.processRoutes(w,g.children??g._loadedRoutes))}return Lr(d).pipe(Ya())}preloadConfig(a,u){return this.preloadingStrategy.preload(u,()=>{let d;d=u.loadChildren&&void 0===u.canLoad?this.loader.loadChildren(a,u):Ve(null);const g=d.pipe(wr(x=>null===x?Ve(void 0):(u._loadedRoutes=x.routes,u._loadedInjector=x.injector,this.processRoutes(x.injector??a,x.routes))));return u.loadComponent&&!u._loadedComponent?Lr([g,this.loader.loadComponent(u)]).pipe(Ya()):g})}}return i.\u0275fac=function(a){return new(a||i)(fe(Wi),fe(Wm),fe(Fo),fe(jP),fe(NI))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();const VI=new $e("");let VP=(()=>{class i{constructor(a,u,d={}){this.router=a,this.viewportScroller=u,this.options=d,this.lastId=0,this.lastSource="imperative",this.restoredId=0,this.store={},d.scrollPositionRestoration=d.scrollPositionRestoration||"disabled",d.anchorScrolling=d.anchorScrolling||"disabled"}init(){"disabled"!==this.options.scrollPositionRestoration&&this.viewportScroller.setHistoryScrollRestoration("manual"),this.routerEventsSubscription=this.createScrollEvents(),this.scrollEventsSubscription=this.consumeScrollEvents()}createScrollEvents(){return this.router.events.subscribe(a=>{a instanceof EI?(this.store[this.lastId]=this.viewportScroller.getScrollPosition(),this.lastSource=a.navigationTrigger,this.restoredId=a.restoredState?a.restoredState.navigationId:0):a instanceof gf&&(this.lastId=a.id,this.scheduleScrollEvent(a,this.router.parseUrl(a.urlAfterRedirects).fragment))})}consumeScrollEvents(){return this.router.events.subscribe(a=>{a instanceof aP&&(a.position?"top"===this.options.scrollPositionRestoration?this.viewportScroller.scrollToPosition([0,0]):"enabled"===this.options.scrollPositionRestoration&&this.viewportScroller.scrollToPosition(a.position):a.anchor&&"enabled"===this.options.anchorScrolling?this.viewportScroller.scrollToAnchor(a.anchor):"disabled"!==this.options.scrollPositionRestoration&&this.viewportScroller.scrollToPosition([0,0]))})}scheduleScrollEvent(a,u){this.router.triggerEvent(new aP(a,"popstate"===this.lastSource?this.store[this.restoredId]:null,u))}ngOnDestroy(){this.routerEventsSubscription&&this.routerEventsSubscription.unsubscribe(),this.scrollEventsSubscription&&this.scrollEventsSubscription.unsubscribe()}}return i.\u0275fac=function(a){fd()},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();function mg(i,o){return{\u0275kind:i,\u0275providers:o}}function UI(i){return[{provide:zI,multi:!0,useValue:i}]}function $P(){const i=yr(Yr);return o=>{const a=i.get(Oc);if(o!==a.components[0])return;const u=i.get(Wi),d=i.get(HP);1===i.get($I)&&u.initialNavigation(),i.get(GP,null,Oe.Optional)?.setUpPreloading(),i.get(VI,null,Oe.Optional)?.init(),u.resetRootComponentType(a.componentTypes[0]),d.closed||(d.next(),d.unsubscribe())}}const HP=new $e("",{factory:()=>new yi}),$I=new $e("",{providedIn:"root",factory:()=>1});const GP=new $e("");function HO(i){return mg(0,[{provide:GP,useExisting:jO},{provide:jP,useExisting:i}])}const qP=new $e("ROUTER_FORROOT_GUARD"),GO=[bv,{provide:Y2,useClass:_I},{provide:Wi,useFactory:NP},Hv,{provide:_f,useFactory:function UP(i){return i.routerState.root},deps:[Wi]},NI];function qO(){return new iT("Router",Wi)}let WP=(()=>{class i{constructor(a){}static forRoot(a,u){return{ngModule:i,providers:[GO,[],UI(a),{provide:qP,useFactory:YO,deps:[[Wi,new lc,new ga]]},{provide:lD,useValue:u||{}},u?.useHash?{provide:Qs,useClass:ST}:{provide:Qs,useClass:DT},{provide:VI,useFactory:()=>{const i=yr(Wi),o=yr(fR),a=yr(lD);return a.scrollOffset&&o.setOffset(a.scrollOffset),new VP(i,o,a)}},u?.preloadingStrategy?HO(u.preloadingStrategy).\u0275providers:[],{provide:iT,multi:!0,useFactory:qO},u?.initialNavigation?KO(u):[],[{provide:ZP,useFactory:$P},{provide:GE,multi:!0,useExisting:ZP}]]}}static forChild(a){return{ngModule:i,providers:[UI(a)]}}}return i.\u0275fac=function(a){return new(a||i)(fe(qP,8))},i.\u0275mod=Qr({type:i}),i.\u0275inj=Ki({imports:[AI]}),i})();function YO(i){return"guarded"}function KO(i){return["disabled"===i.initialNavigation?mg(3,[{provide:Lc,multi:!0,useFactory:()=>{const o=yr(Wi);return()=>{o.setUpLocationChangeListener()}}},{provide:$I,useValue:2}]).\u0275providers:[],"enabledBlocking"===i.initialNavigation?mg(2,[{provide:$I,useValue:0},{provide:Lc,multi:!0,deps:[Yr],useFactory:o=>{const a=o.get(BM,Promise.resolve());let u=!1;return()=>a.then(()=>new Promise(g=>{const x=o.get(Wi),w=o.get(HP);(function d(g){o.get(Wi).events.pipe(Vc(w=>w instanceof gf||w instanceof JT||w instanceof sP),un(w=>w instanceof gf||w instanceof JT&&(0===w.code||1===w.code)&&null),Vc(w=>null!==w),Fv(1)).subscribe(()=>{g()})})(()=>{g(!0),u=!0}),x.afterPreactivation=()=>(g(!0),u||w.closed?Ve(void 0):w),x.initialNavigation()}))}}]).\u0275providers:[]]}const ZP=new $e(""),QO=[];let tF=(()=>{class i{}return i.\u0275fac=function(a){return new(a||i)},i.\u0275mod=Qr({type:i}),i.\u0275inj=Ki({imports:[WP.forRoot(QO),WP]}),i})();class XP{}class YP{}class Hc{constructor(o){this.normalizedNames=new Map,this.lazyUpdate=null,o?this.lazyInit="string"==typeof o?()=>{this.headers=new Map,o.split("\n").forEach(a=>{const u=a.indexOf(":");if(u>0){const d=a.slice(0,u),g=d.toLowerCase(),x=a.slice(u+1).trim();this.maybeSetNormalizedName(d,g),this.headers.has(g)?this.headers.get(g).push(x):this.headers.set(g,[x])}})}:()=>{this.headers=new Map,Object.keys(o).forEach(a=>{let u=o[a];const d=a.toLowerCase();"string"==typeof u&&(u=[u]),u.length>0&&(this.headers.set(d,u),this.maybeSetNormalizedName(a,d))})}:this.headers=new Map}has(o){return this.init(),this.headers.has(o.toLowerCase())}get(o){this.init();const a=this.headers.get(o.toLowerCase());return a&&a.length>0?a[0]:null}keys(){return this.init(),Array.from(this.normalizedNames.values())}getAll(o){return this.init(),this.headers.get(o.toLowerCase())||null}append(o,a){return this.clone({name:o,value:a,op:"a"})}set(o,a){return this.clone({name:o,value:a,op:"s"})}delete(o,a){return this.clone({name:o,value:a,op:"d"})}maybeSetNormalizedName(o,a){this.normalizedNames.has(a)||this.normalizedNames.set(a,o)}init(){this.lazyInit&&(this.lazyInit instanceof Hc?this.copyFrom(this.lazyInit):this.lazyInit(),this.lazyInit=null,this.lazyUpdate&&(this.lazyUpdate.forEach(o=>this.applyUpdate(o)),this.lazyUpdate=null))}copyFrom(o){o.init(),Array.from(o.headers.keys()).forEach(a=>{this.headers.set(a,o.headers.get(a)),this.normalizedNames.set(a,o.normalizedNames.get(a))})}clone(o){const a=new Hc;return a.lazyInit=this.lazyInit&&this.lazyInit instanceof Hc?this.lazyInit:this,a.lazyUpdate=(this.lazyUpdate||[]).concat([o]),a}applyUpdate(o){const a=o.name.toLowerCase();switch(o.op){case"a":case"s":let u=o.value;if("string"==typeof u&&(u=[u]),0===u.length)return;this.maybeSetNormalizedName(o.name,a);const d=("a"===o.op?this.headers.get(a):void 0)||[];d.push(...u),this.headers.set(a,d);break;case"d":const g=o.value;if(g){let x=this.headers.get(a);if(!x)return;x=x.filter(w=>-1===g.indexOf(w)),0===x.length?(this.headers.delete(a),this.normalizedNames.delete(a)):this.headers.set(a,x)}else this.headers.delete(a),this.normalizedNames.delete(a)}}forEach(o){this.init(),Array.from(this.normalizedNames.keys()).forEach(a=>o(this.normalizedNames.get(a),this.headers.get(a)))}}class eF{encodeKey(o){return KP(o)}encodeValue(o){return KP(o)}decodeKey(o){return decodeURIComponent(o)}decodeValue(o){return decodeURIComponent(o)}}const rF=/%(\d[a-f0-9])/gi,iF={40:"@","3A":":",24:"$","2C":",","3B":";","3D":"=","3F":"?","2F":"/"};function KP(i){return encodeURIComponent(i).replace(rF,(o,a)=>iF[a]??o)}function dD(i){return`${i}`}class xh{constructor(o={}){if(this.updates=null,this.cloneFrom=null,this.encoder=o.encoder||new eF,o.fromString){if(o.fromObject)throw new Error("Cannot specify both fromString and fromObject.");this.map=function nF(i,o){const a=new Map;return i.length>0&&i.replace(/^\?/,"").split("&").forEach(d=>{const g=d.indexOf("="),[x,w]=-1==g?[o.decodeKey(d),""]:[o.decodeKey(d.slice(0,g)),o.decodeValue(d.slice(g+1))],S=a.get(x)||[];S.push(w),a.set(x,S)}),a}(o.fromString,this.encoder)}else o.fromObject?(this.map=new Map,Object.keys(o.fromObject).forEach(a=>{const u=o.fromObject[a],d=Array.isArray(u)?u.map(dD):[dD(u)];this.map.set(a,d)})):this.map=null}has(o){return this.init(),this.map.has(o)}get(o){this.init();const a=this.map.get(o);return a?a[0]:null}getAll(o){return this.init(),this.map.get(o)||null}keys(){return this.init(),Array.from(this.map.keys())}append(o,a){return this.clone({param:o,value:a,op:"a"})}appendAll(o){const a=[];return Object.keys(o).forEach(u=>{const d=o[u];Array.isArray(d)?d.forEach(g=>{a.push({param:u,value:g,op:"a"})}):a.push({param:u,value:d,op:"a"})}),this.clone(a)}set(o,a){return this.clone({param:o,value:a,op:"s"})}delete(o,a){return this.clone({param:o,value:a,op:"d"})}toString(){return this.init(),this.keys().map(o=>{const a=this.encoder.encodeKey(o);return this.map.get(o).map(u=>a+"="+this.encoder.encodeValue(u)).join("&")}).filter(o=>""!==o).join("&")}clone(o){const a=new xh({encoder:this.encoder});return a.cloneFrom=this.cloneFrom||this,a.updates=(this.updates||[]).concat(o),a}init(){null===this.map&&(this.map=new Map),null!==this.cloneFrom&&(this.cloneFrom.init(),this.cloneFrom.keys().forEach(o=>this.map.set(o,this.cloneFrom.map.get(o))),this.updates.forEach(o=>{switch(o.op){case"a":case"s":const a=("a"===o.op?this.map.get(o.param):void 0)||[];a.push(dD(o.value)),this.map.set(o.param,a);break;case"d":if(void 0===o.value){this.map.delete(o.param);break}{let u=this.map.get(o.param)||[];const d=u.indexOf(dD(o.value));-1!==d&&u.splice(d,1),u.length>0?this.map.set(o.param,u):this.map.delete(o.param)}}}),this.cloneFrom=this.updates=null)}}class oF{constructor(){this.map=new Map}set(o,a){return this.map.set(o,a),this}get(o){return this.map.has(o)||this.map.set(o,o.defaultValue()),this.map.get(o)}delete(o){return this.map.delete(o),this}has(o){return this.map.has(o)}keys(){return this.map.keys()}}function JP(i){return typeof ArrayBuffer<"u"&&i instanceof ArrayBuffer}function QP(i){return typeof Blob<"u"&&i instanceof Blob}function tR(i){return typeof FormData<"u"&&i instanceof FormData}class Yv{constructor(o,a,u,d){let g;if(this.url=a,this.body=null,this.reportProgress=!1,this.withCredentials=!1,this.responseType="json",this.method=o.toUpperCase(),function sF(i){switch(i){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"JSONP":return!1;default:return!0}}(this.method)||d?(this.body=void 0!==u?u:null,g=d):g=u,g&&(this.reportProgress=!!g.reportProgress,this.withCredentials=!!g.withCredentials,g.responseType&&(this.responseType=g.responseType),g.headers&&(this.headers=g.headers),g.context&&(this.context=g.context),g.params&&(this.params=g.params)),this.headers||(this.headers=new Hc),this.context||(this.context=new oF),this.params){const x=this.params.toString();if(0===x.length)this.urlWithParams=a;else{const w=a.indexOf("?");this.urlWithParams=a+(-1===w?"?":w<a.length-1?"&":"")+x}}else this.params=new xh,this.urlWithParams=a}serializeBody(){return null===this.body?null:JP(this.body)||QP(this.body)||tR(this.body)||function aF(i){return typeof URLSearchParams<"u"&&i instanceof URLSearchParams}(this.body)||"string"==typeof this.body?this.body:this.body instanceof xh?this.body.toString():"object"==typeof this.body||"boolean"==typeof this.body||Array.isArray(this.body)?JSON.stringify(this.body):this.body.toString()}detectContentTypeHeader(){return null===this.body||tR(this.body)?null:QP(this.body)?this.body.type||null:JP(this.body)?null:"string"==typeof this.body?"text/plain":this.body instanceof xh?"application/x-www-form-urlencoded;charset=UTF-8":"object"==typeof this.body||"number"==typeof this.body||"boolean"==typeof this.body?"application/json":null}clone(o={}){const a=o.method||this.method,u=o.url||this.url,d=o.responseType||this.responseType,g=void 0!==o.body?o.body:this.body,x=void 0!==o.withCredentials?o.withCredentials:this.withCredentials,w=void 0!==o.reportProgress?o.reportProgress:this.reportProgress;let S=o.headers||this.headers,P=o.params||this.params;const k=o.context??this.context;return void 0!==o.setHeaders&&(S=Object.keys(o.setHeaders).reduce((F,G)=>F.set(G,o.setHeaders[G]),S)),o.setParams&&(P=Object.keys(o.setParams).reduce((F,G)=>F.set(G,o.setParams[G]),P)),new Yv(a,u,g,{params:P,headers:S,context:k,reportProgress:w,responseType:d,withCredentials:x})}}var ii=(()=>((ii=ii||{})[ii.Sent=0]="Sent",ii[ii.UploadProgress=1]="UploadProgress",ii[ii.ResponseHeader=2]="ResponseHeader",ii[ii.DownloadProgress=3]="DownloadProgress",ii[ii.Response=4]="Response",ii[ii.User=5]="User",ii))();class HI{constructor(o,a=200,u="OK"){this.headers=o.headers||new Hc,this.status=void 0!==o.status?o.status:a,this.statusText=o.statusText||u,this.url=o.url||null,this.ok=this.status>=200&&this.status<300}}class GI extends HI{constructor(o={}){super(o),this.type=ii.ResponseHeader}clone(o={}){return new GI({headers:o.headers||this.headers,status:void 0!==o.status?o.status:this.status,statusText:o.statusText||this.statusText,url:o.url||this.url||void 0})}}class fD extends HI{constructor(o={}){super(o),this.type=ii.Response,this.body=void 0!==o.body?o.body:null}clone(o={}){return new fD({body:void 0!==o.body?o.body:this.body,headers:o.headers||this.headers,status:void 0!==o.status?o.status:this.status,statusText:o.statusText||this.statusText,url:o.url||this.url||void 0})}}class eR extends HI{constructor(o){super(o,0,"Unknown Error"),this.name="HttpErrorResponse",this.ok=!1,this.message=this.status>=200&&this.status<300?`Http failure during parsing for ${o.url||"(unknown url)"}`:`Http failure response for ${o.url||"(unknown url)"}: ${o.status} ${o.statusText}`,this.error=o.error||null}}function qI(i,o){return{body:o,headers:i.headers,context:i.context,observe:i.observe,params:i.params,reportProgress:i.reportProgress,responseType:i.responseType,withCredentials:i.withCredentials}}let nR=(()=>{class i{constructor(a){this.handler=a}request(a,u,d={}){let g;if(a instanceof Yv)g=a;else{let S,P;S=d.headers instanceof Hc?d.headers:new Hc(d.headers),d.params&&(P=d.params instanceof xh?d.params:new xh({fromObject:d.params})),g=new Yv(a,u,void 0!==d.body?d.body:null,{headers:S,context:d.context,params:P,reportProgress:d.reportProgress,responseType:d.responseType||"json",withCredentials:d.withCredentials})}const x=Ve(g).pipe(_h(S=>this.handler.handle(S)));if(a instanceof Yv||"events"===d.observe)return x;const w=x.pipe(Vc(S=>S instanceof fD));switch(d.observe||"body"){case"body":switch(g.responseType){case"arraybuffer":return w.pipe(un(S=>{if(null!==S.body&&!(S.body instanceof ArrayBuffer))throw new Error("Response is not an ArrayBuffer.");return S.body}));case"blob":return w.pipe(un(S=>{if(null!==S.body&&!(S.body instanceof Blob))throw new Error("Response is not a Blob.");return S.body}));case"text":return w.pipe(un(S=>{if(null!==S.body&&"string"!=typeof S.body)throw new Error("Response is not a string.");return S.body}));default:return w.pipe(un(S=>S.body))}case"response":return w;default:throw new Error(`Unreachable: unhandled observe type ${d.observe}}`)}}delete(a,u={}){return this.request("DELETE",a,u)}get(a,u={}){return this.request("GET",a,u)}head(a,u={}){return this.request("HEAD",a,u)}jsonp(a,u){return this.request("JSONP",a,{params:(new xh).append(u,"JSONP_CALLBACK"),observe:"body",responseType:"json"})}options(a,u={}){return this.request("OPTIONS",a,u)}patch(a,u,d={}){return this.request("PATCH",a,qI(d,u))}post(a,u,d={}){return this.request("POST",a,qI(d,u))}put(a,u,d={}){return this.request("PUT",a,qI(d,u))}}return i.\u0275fac=function(a){return new(a||i)(fe(XP))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();class rR{constructor(o,a){this.next=o,this.interceptor=a}handle(o){return this.interceptor.intercept(o,this.next)}}const iR=new $e("HTTP_INTERCEPTORS");let lF=(()=>{class i{intercept(a,u){return u.handle(a)}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();const cF=/^\)\]\}',?\n/;let oR=(()=>{class i{constructor(a){this.xhrFactory=a}handle(a){if("JSONP"===a.method)throw new Error("Attempted to construct Jsonp request without HttpClientJsonpModule installed.");return new Nn(u=>{const d=this.xhrFactory.build();if(d.open(a.method,a.urlWithParams),a.withCredentials&&(d.withCredentials=!0),a.headers.forEach((J,ct)=>d.setRequestHeader(J,ct.join(","))),a.headers.has("Accept")||d.setRequestHeader("Accept","application/json, text/plain, */*"),!a.headers.has("Content-Type")){const J=a.detectContentTypeHeader();null!==J&&d.setRequestHeader("Content-Type",J)}if(a.responseType){const J=a.responseType.toLowerCase();d.responseType="json"!==J?J:"text"}const g=a.serializeBody();let x=null;const w=()=>{if(null!==x)return x;const J=d.statusText||"OK",ct=new Hc(d.getAllResponseHeaders()),mt=function uF(i){return"responseURL"in i&&i.responseURL?i.responseURL:/^X-Request-URL:/m.test(i.getAllResponseHeaders())?i.getResponseHeader("X-Request-URL"):null}(d)||a.url;return x=new GI({headers:ct,status:d.status,statusText:J,url:mt}),x},S=()=>{let{headers:J,status:ct,statusText:mt,url:St}=w(),Lt=null;204!==ct&&(Lt=typeof d.response>"u"?d.responseText:d.response),0===ct&&(ct=Lt?200:0);let Qt=ct>=200&&ct<300;if("json"===a.responseType&&"string"==typeof Lt){const Mt=Lt;Lt=Lt.replace(cF,"");try{Lt=""!==Lt?JSON.parse(Lt):null}catch(ke){Lt=Mt,Qt&&(Qt=!1,Lt={error:ke,text:Lt})}}Qt?(u.next(new fD({body:Lt,headers:J,status:ct,statusText:mt,url:St||void 0})),u.complete()):u.error(new eR({error:Lt,headers:J,status:ct,statusText:mt,url:St||void 0}))},P=J=>{const{url:ct}=w(),mt=new eR({error:J,status:d.status||0,statusText:d.statusText||"Unknown Error",url:ct||void 0});u.error(mt)};let k=!1;const F=J=>{k||(u.next(w()),k=!0);let ct={type:ii.DownloadProgress,loaded:J.loaded};J.lengthComputable&&(ct.total=J.total),"text"===a.responseType&&!!d.responseText&&(ct.partialText=d.responseText),u.next(ct)},G=J=>{let ct={type:ii.UploadProgress,loaded:J.loaded};J.lengthComputable&&(ct.total=J.total),u.next(ct)};return d.addEventListener("load",S),d.addEventListener("error",P),d.addEventListener("timeout",P),d.addEventListener("abort",P),a.reportProgress&&(d.addEventListener("progress",F),null!==g&&d.upload&&d.upload.addEventListener("progress",G)),d.send(g),u.next({type:ii.Sent}),()=>{d.removeEventListener("error",P),d.removeEventListener("abort",P),d.removeEventListener("load",S),d.removeEventListener("timeout",P),a.reportProgress&&(d.removeEventListener("progress",F),null!==g&&d.upload&&d.upload.removeEventListener("progress",G)),d.readyState!==d.DONE&&d.abort()}})}}return i.\u0275fac=function(a){return new(a||i)(fe(d2))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})();const WI=new $e("XSRF_COOKIE_NAME"),ZI=new $e("XSRF_HEADER_NAME");class sR{}let hF=(()=>{class i{constructor(a,u,d){this.doc=a,this.platform=u,this.cookieName=d,this.lastCookieString="",this.lastToken=null,this.parseCount=0}getToken(){if("server"===this.platform)return null;const a=this.doc.cookie||"";return a!==this.lastCookieString&&(this.parseCount++,this.lastToken=pe(a,this.cookieName),this.lastCookieString=a),this.lastToken}}return i.\u0275fac=function(a){return new(a||i)(fe(Hi),fe(K0),fe(WI))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})(),XI=(()=>{class i{constructor(a,u){this.tokenService=a,this.headerName=u}intercept(a,u){const d=a.url.toLowerCase();if("GET"===a.method||"HEAD"===a.method||d.startsWith("http://")||d.startsWith("https://"))return u.handle(a);const g=this.tokenService.getToken();return null!==g&&!a.headers.has(this.headerName)&&(a=a.clone({headers:a.headers.set(this.headerName,g)})),u.handle(a)}}return i.\u0275fac=function(a){return new(a||i)(fe(sR),fe(ZI))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})(),dF=(()=>{class i{constructor(a,u){this.backend=a,this.injector=u,this.chain=null}handle(a){if(null===this.chain){const u=this.injector.get(iR,[]);this.chain=u.reduceRight((d,g)=>new rR(d,g),this.backend)}return this.chain.handle(a)}}return i.\u0275fac=function(a){return new(a||i)(fe(YP),fe(Yr))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac}),i})(),fF=(()=>{class i{static disable(){return{ngModule:i,providers:[{provide:XI,useClass:lF}]}}static withOptions(a={}){return{ngModule:i,providers:[a.cookieName?{provide:WI,useValue:a.cookieName}:[],a.headerName?{provide:ZI,useValue:a.headerName}:[]]}}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275mod=Qr({type:i}),i.\u0275inj=Ki({providers:[XI,{provide:iR,useExisting:XI,multi:!0},{provide:sR,useClass:hF},{provide:WI,useValue:"XSRF-TOKEN"},{provide:ZI,useValue:"X-XSRF-TOKEN"}]}),i})(),pF=(()=>{class i{}return i.\u0275fac=function(a){return new(a||i)},i.\u0275mod=Qr({type:i}),i.\u0275inj=Ki({providers:[nR,{provide:XP,useClass:dF},oR,{provide:YP,useExisting:oR}],imports:[fF.withOptions({cookieName:"XSRF-TOKEN",headerName:"X-XSRF-TOKEN"})]}),i})(),mF=(()=>{class i{constructor(a){this.http=a,this.baseUrl="localhost:3000/api/"}getArboles(){return this.http.get("/api/arboles")}}return i.\u0275fac=function(a){return new(a||i)(fe(nR))},i.\u0275prov=Ue({token:i,factory:i.\u0275fac,providedIn:"root"}),i})(),gF=(()=>{class i{constructor(){}ngOnInit(){}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275cmp=Qi({type:i,selectors:[["app-selector"]],decls:14,vars:0,consts:[[1,"mt-5"],[1,"text-center"],[1,"row"],[1,"contenedor-selector","mx-auto"],["aria-label","Default select example",1,"form-select"],["selected",""],["value","1"],["value","2"],["value","3"]],template:function(a,u){1&a&&(lo(0,"div",0)(1,"h1",1),Ec(2,"Seleccione un Arbol"),Eo(),lo(3,"div",2)(4,"div",3)(5,"select",4)(6,"option",5),Ec(7,"Open this select menu"),Eo(),lo(8,"option",6),Ec(9,"One"),Eo(),lo(10,"option",7),Ec(11,"Two"),Eo(),lo(12,"option",8),Ec(13,"Three"),Eo()()()()())}}),i})(),_F=(()=>{class i{constructor(){}ngOnInit(){}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275cmp=Qi({type:i,selectors:[["app-images"]],decls:3,vars:0,consts:[[1,"mt-5"],[1,"imagen"],["src","assets/no-image.png","alt","dsa"]],template:function(a,u){1&a&&(lo(0,"div",0)(1,"div",1),Ti(2,"img",2),Eo()())}}),i})();var yF=Bl(898),YI=Bl.n(yF);let vF=(()=>{class i{constructor(){this.style="mapbox://styles/mapbox/streets-v11",this.lat=26.3398,this.lng=-81.7787}ngAfterViewInit(){YI(),this.map=new(YI().Map)({accessToken:"pk.eyJ1IjoiZHBpZXRyb2NhcmxvIiwiYSI6ImNram9tOGFuMTBvb3oyeXFsdW5uYmJjNGQifQ._zE6Mub0-Vpl7ggMj8xSUQ",container:"map",style:this.style,zoom:8,center:[this.lng,this.lat]})}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275cmp=Qi({type:i,selectors:[["app-map"]],decls:1,vars:0,consts:[["id","map",1,"mt-5",2,"width","100%","height","100%"]],template:function(a,u){1&a&&Ti(0,"div",0)}}),i})(),xF=(()=>{class i{constructor(){}ngOnInit(){}}return i.\u0275fac=function(a){return new(a||i)},i.\u0275cmp=Qi({type:i,selectors:[["app-message"]],decls:2,vars:0,template:function(a,u){1&a&&(lo(0,"p"),Ec(1,"message works!"),Eo())}}),i})(),bF=(()=>{class i{constructor(a){this.services=a,this.title="front",this.arboles=""}ngOnInit(){this.services.getArboles().subscribe(a=>{this.arboles=a.response,console.log(this.arboles)})}}return i.\u0275fac=function(a){return new(a||i)(Ie(mF))},i.\u0275cmp=Qi({type:i,selectors:[["app-root"]],decls:8,vars:0,consts:[[1,"container"],[1,"row"],[1,"col-6"]],template:function(a,u){1&a&&(lo(0,"div",0),Ti(1,"app-selector"),lo(2,"div",1)(3,"div",2),Ti(4,"app-images"),Eo(),lo(5,"div",2),Ti(6,"app-map"),Eo()(),Ti(7,"app-message"),Eo())},dependencies:[gF,_F,vF,xF]}),i})(),wF=(()=>{class i{}return i.\u0275fac=function(a){return new(a||i)},i.\u0275mod=Qr({type:i,bootstrap:[bF]}),i.\u0275inj=Ki({imports:[pF,uL,tF]}),i})();YI().accessToken="pk.eyJ1IjoiZGFya3Jpc2luZyIsImEiOiJjbHI5dmtxODkwN2FjMnBxbm5lNnE3MTd4In0.p1PYHbV4B_DC08YdbTeHUw",function bM(){cT=!1}(),cL().bootstrapModule(wF).catch(i=>console.error(i))},898:function(gg){gg.exports=function(){"use strict";var Gc,Bl,Qn;function bh(qt,it){if(Gc)if(Bl){var Go="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+Gc+")(sharedChunk); ("+Bl+")(sharedChunk); self.onerror = null;",vs={};Gc(vs),Qn=it(vs),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Qn.workerUrl=window.URL.createObjectURL(new Blob([Go],{type:"text/javascript"})))}else Bl=it;else Gc=it}return bh(0,function(qt){var it=typeof self<"u"?self:{},Go="3.0.1";let vs;const Ae={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==vs){const e=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{vs=null!=process.env.API_URL_REGEX?new RegExp(process.env.API_URL_REGEX):e}catch{vs=e}}return vs},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Ae.API_URL)return null;try{const e=new URL(Ae.API_URL);return"api.mapbox.cn"===e.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===e.hostname?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},mo={supported:!1,testSupport:function(e){!qc&&ia&&($a?vf(e):qo=e)}};let qo,ia,qc=!1,$a=!1;function vf(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,ia),e.isContextLost())return;mo.supported=!0}catch{}e.deleteTexture(t),qc=!0}it.document&&(ia=it.document.createElement("img"),ia.onload=function(){qo&&vf(qo),qo=null,$a=!0},ia.onerror=function(){qc=!0,qo=null},ia.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const wh="01";function Zi(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var xs=bs;function bs(e,t,n,r){this.cx=3*e,this.bx=3*(n-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(r-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=n,this.p2y=r}bs.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(void 0===t&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var n=e,r=0;r<8;r++){var s=this.sampleCurveX(n)-e;if(Math.abs(s)<t)return n;var l=this.sampleCurveDerivativeX(n);if(Math.abs(l)<1e-6)break;n-=s/l}var c=0,h=1;for(n=e,r=0;r<20&&(s=this.sampleCurveX(n),!(Math.abs(s-e)<t));r++)e>s?c=n:h=n,n=.5*(h-c)+c;return n},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}};var xf=Zi(xs),Ha=ws;function ws(e,t){this.x=e,this.y=t}ws.prototype={clone:function(){return new ws(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,n=e.y-this.y;return t*t+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),n=Math.sin(e),r=n*this.x+t*this.y;return this.x=t*this.x-n*this.y,this.y=r,this},_rotateAround:function(e,t){var n=Math.cos(e),r=Math.sin(e),s=t.y+r*(this.x-t.x)+n*(this.y-t.y);return this.x=t.x+n*(this.x-t.x)-r*(this.y-t.y),this.y=s,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ws.convert=function(e){return e instanceof ws?e:Array.isArray(e)?new ws(e[0],e[1]):e};var tt=Zi(Ha);function Ke(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Ke(e[n],t[n]))return!1;return!0}if("object"==typeof e&&null!==e&&null!==t){if("object"!=typeof t||Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(!Ke(e[n],t[n]))return!1;return!0}return e===t}const jl=Math.PI/180,Es=180/Math.PI;function be(e){return e*jl}function xr(e){return e*Es}const yg=[[0,0],[1,0],[1,1],[0,1]];function Ga(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,n=t*e;return 4*(e<.5?n:3*(e-t)+n-.75)}function oa(e){let t=1/0,n=1/0,r=-1/0,s=-1/0;for(const l of e)t=Math.min(t,l.x),n=Math.min(n,l.y),r=Math.max(r,l.x),s=Math.max(s,l.y);return{min:new tt(t,n),max:new tt(r,s)}}function Vl(e,t,n=0,r=!0){const s=new tt(n,n),l=e.sub(s),c=t.add(s),h=[l,new tt(c.x,l.y),c,new tt(l.x,c.y)];return r&&h.push(l.clone()),h}function qa(e,t,n,r){const s=new xf(e,t,n,r);return function(l){return s.solve(l)}}const Nn=qa(.25,.1,.25,1);function Gt(e,t,n){return Math.min(n,Math.max(t,e))}function Ts(e,t,n){return(n=Gt((n-e)/(t-e),0,1))*n*(3-2*n)}function Ds(e,t,n){const r=n-t,s=((e-t)%r+r)%r+t;return s===t?n:s}function Ul(e,t,n){if(!e.length)return n(null,[]);let r=e.length;const s=new Array(e.length);let l=null;e.forEach((c,h)=>{t(c,(f,p)=>{f&&(l=f),s[h]=p,0==--r&&n(l,s)})})}function yi(e){const t=[];for(const n in e)t.push(e[n]);return t}function Vt(e,...t){for(const n of t)for(const r in n)e[r]=n[r];return e}function Ci(e,t){const n={};for(let r=0;r<t.length;r++){const s=t[r];s in e&&(n[s]=e[s])}return n}let Br=1;function mr(){return Br++}function bf(){return function e(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()}function un(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function Wc(e){return!!e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function Rr(e,t){e.forEach(n=>{t[n]&&(t[n]=t[n].bind(t))})}function Wa(e,t){return-1!==e.indexOf(t,e.length-t.length)}function Zc(e,t,n){const r={};for(const s in e)r[s]=t.call(n||this,e[s],s,e);return r}function Tt(e,t,n){const r={};for(const s in e)t.call(n||this,e[s],s,e)&&(r[s]=e[s]);return r}function U(e){return Array.isArray(e)?e.map(U):"object"==typeof e&&e?Zc(e,U):e}const q={};function Y(e){q[e]||(typeof console<"u"&&console.warn(e),q[e]=!0)}function gt(e,t,n){return(n.y-e.y)*(t.x-e.x)>(t.y-e.y)*(n.x-e.x)}function yt(e){let t=0;for(let n,r,s=0,l=e.length,c=l-1;s<l;c=s++)n=e[s],r=e[c],t+=(r.x-n.x)*(n.y+r.y);return t}function Nt([e,t,n]){const r=be(t+90),s=be(n);return{x:e*Math.cos(r)*Math.sin(s),y:e*Math.sin(r)*Math.sin(s),z:e*Math.cos(s),azimuthal:t,polar:n}}function Wt(e,t,n){const r=Math.sqrt(e*e+t*t+n*n),s=r>0?Math.acos(n/r)*Es:0;let l=0!==e||0!==t?Math.atan2(-t,-e)*Es+90:0;return l<0&&(l+=360),[r,l,s]}function _t(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Yt(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,r,s,l)=>{const c=s||l;return t[r]=!c||c.toLowerCase(),""}),t["max-age"]){const n=parseInt(t["max-age"],10);isNaN(n)?delete t["max-age"]:t["max-age"]=n}return t}let se=null;function ae(){return!!it.document.fullscreenElement||!!it.document.webkitFullscreenElement}function En(e){try{const t=it[e];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}}function Yn(e,t){return[e[4*t],e[4*t+1],e[4*t+2],e[4*t+3]]}function jr(e,t,n){e[4*t+0]=n[0],e[4*t+1]=n[1],e[4*t+2]=n[2],e[4*t+3]=n[3]}function Kn(e,t){return[Math.pow(e[0],2.2)*t,Math.pow(e[1],2.2)*t,Math.pow(e[2],2.2)*t]}function Cn(e){return[Math.pow(e[0],1/2.2),Math.pow(e[1],1/2.2),Math.pow(e[2],1/2.2)]}const Mn="mapbox-tiles";let Mi,Wo,oi=500,vi=50;function Xc(){try{return it.caches}catch{}}function Xi(){Xc()&&!Mi&&(Mi=it.caches.open(Mn))}function sa(e){const t=e.indexOf("?");if(t<0)return e;const r=function(s){const l=s.indexOf("?");return l>0?s.slice(l+1).split("&"):[]}(e).filter(s=>{const l=s.split("=");return"language"===l[0]||"worldview"===l[0]});return r.length?`${e.slice(0,t)}?${r.join("&")}`:e.slice(0,t)}let Za=1/0;function Yc(e){Za++,Za>vi&&(e.getActor().send("enforceCacheSizeLimit",oi),Za=0)}const dt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(dt);class pt extends Error{constructor(t,n,r){401===n&&mn(r)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=n,this.url=r}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const vt=_t()?()=>self.worker&&self.worker.referrer:()=>("blob:"===it.location.protocol?it.parent:it).location.href,Ct=function(e,t){if(!(/^file:/.test(n=e.url)||/^file:/.test(vt())&&!/^\w+:/.test(n))){if(it.fetch&&it.Request&&it.AbortController&&it.Request.prototype.hasOwnProperty("signal"))return function(r,s){const l=new it.AbortController,c=new it.Request(r.url,{method:r.method||"GET",body:r.body,credentials:r.credentials,headers:r.headers,referrer:vt(),referrerPolicy:r.referrerPolicy,signal:l.signal});let h=!1,f=!1;const p=(m=c.url).indexOf("sku=")>0&&mn(m);var m;"json"===r.type&&c.headers.set("Accept","application/json");const _=(v,b,E)=>{if(f)return;if(v&&"SecurityError"!==v.message&&Y(v.toString()),b&&E)return y(b);const D=Date.now();it.fetch(c).then(T=>{if(T.ok){const C=p?T.clone():null;return y(T,C,D)}return s(new pt(T.statusText,T.status,r.url))}).catch(T=>{"AbortError"!==T.name&&s(new Error(`${T.message} ${r.url}`))})},y=(v,b,E)=>{("arrayBuffer"===r.type?v.arrayBuffer():"json"===r.type?v.json():v.text()).then(D=>{f||(b&&E&&function(T,C,I){if(Xi(),!Mi)return;const A={status:C.status,statusText:C.statusText,headers:new it.Headers};C.headers.forEach((L,O)=>A.headers.set(O,L));const M=Yt(C.headers.get("Cache-Control")||"");if(M["no-store"])return;M["max-age"]&&A.headers.set("Expires",new Date(I+1e3*M["max-age"]).toUTCString());const R=A.headers.get("Expires");R&&(new Date(R).getTime()-I<42e4||function(L,O){if(void 0===Wo)try{new Response(new ReadableStream),Wo=!0}catch{Wo=!1}Wo?O(L.body):L.blob().then(O)}(C,L=>{const O=new it.Response(L,A);Xi(),Mi&&Mi.then(z=>z.put(sa(T.url),O)).catch(z=>Y(z.message))}))}(c,b,E),h=!0,s(null,D,v.headers.get("Cache-Control"),v.headers.get("Expires")))}).catch(D=>{f||s(new Error(D.message))})};return p?function(v,b){if(Xi(),!Mi)return b(null);const E=sa(v.url);Mi.then(D=>{D.match(E).then(T=>{const C=function(I){if(!I)return!1;const A=new Date(I.headers.get("Expires")||0),M=Yt(I.headers.get("Cache-Control")||"");return A>Date.now()&&!M["no-cache"]}(T);D.delete(E),C&&D.put(E,T.clone()),b(null,T,C)}).catch(b)}).catch(b)}(c,_):_(null,null),{cancel:()=>{f=!0,h||l.abort()}}}(e,t);if(_t()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0)}var n;return function(r,s){const l=new it.XMLHttpRequest;l.open(r.method||"GET",r.url,!0),"arrayBuffer"===r.type&&(l.responseType="arraybuffer");for(const c in r.headers)l.setRequestHeader(c,r.headers[c]);return"json"===r.type&&(l.responseType="text",l.setRequestHeader("Accept","application/json")),l.withCredentials="include"===r.credentials,l.onerror=()=>{s(new Error(l.statusText))},l.onload=()=>{if((l.status>=200&&l.status<300||0===l.status)&&null!==l.response){let c=l.response;if("json"===r.type)try{c=JSON.parse(l.response)}catch(h){return s(h)}s(null,c,l.getResponseHeader("Cache-Control"),l.getResponseHeader("Expires"))}else s(new pt(l.statusText,l.status,r.url))},l.send(r.body),{cancel:()=>l.abort()}}(e,t)},Dt=function(e,t){return Ct(Vt(e,{type:"json"}),t)},Pt=function(e,t){return Ct(Vt(e,{type:"arrayBuffer"}),t)};function Ft(e){const t=it.document.createElement("a");return t.href=e,t.protocol===it.document.location.protocol&&t.host===it.document.location.host}const It="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let $t,Rt;$t=[],Rt=0;const Te=function(e,t){if(mo.supported&&(e.headers||(e.headers={}),e.headers.accept="image/webp,*/*"),Rt>=Ae.MAX_PARALLEL_IMAGE_REQUESTS){const l={requestParameters:e,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return $t.push(l),l}Rt++;let n=!1;const r=()=>{if(!n)for(n=!0,Rt--;$t.length&&Rt<Ae.MAX_PARALLEL_IMAGE_REQUESTS;){const l=$t.shift(),{requestParameters:c,callback:h,cancelled:f}=l;f||(l.cancel=Te(c,h).cancel)}},s=Pt(e,(l,c,h,f)=>{r(),l?t(l):c&&(it.createImageBitmap?function(p,m){const _=new it.Blob([new Uint8Array(p)],{type:"image/png"});it.createImageBitmap(_).then(y=>{m(null,y)}).catch(y=>{m(new Error(`Could not load image because of ${y.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(c,(p,m)=>t(p,m,h,f)):function(p,m){const _=new it.Image,y=it.URL;_.onload=()=>{m(null,_),y.revokeObjectURL(_.src),_.onload=null,it.requestAnimationFrame(()=>{_.src=It})},_.onerror=()=>m(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const v=new it.Blob([new Uint8Array(p)],{type:"image/png"});_.src=p.byteLength?y.createObjectURL(v):It}(c,(p,m)=>t(p,m,h,f)))});return{cancel:()=>{s.cancel(),r()}}},dn="NO_ACCESS_TOKEN";class Jt{constructor(t,n,r){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!r,this._createSkuToken()}_createSkuToken(){const t=function(){let n="";for(let r=0;r<10;r++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",wh,n].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!hn(t))return t;const r=br(t);return r.params.push("sdk=js-3.0.1"),r.path=`/styles/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!hn(t))return t;const r=br(t);return r.path=`/fonts/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||n)}normalizeModelURL(t,n){if(!hn(t))return t;const r=br(t);return r.path=`/models/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||n)}normalizeSourceURL(t,n,r,s){if(!hn(t))return t;const l=br(t);return l.path=`/v4/${l.authority}.json`,l.params.push("secure"),r&&l.params.push(`language=${r}`),s&&l.params.push(`worldview=${s}`),this._makeAPIURL(l,this._customAccessToken||n)}normalizeSpriteURL(t,n,r,s){const l=br(t);return hn(t)?(l.path=`/styles/v1${l.path}/sprite${n}${r}`,this._makeAPIURL(l,this._customAccessToken||s)):(l.path+=`${n}${r}`,Ii(l))}normalizeTileURL(t,n,r){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!hn(t))return t;const s=br(t);s.path=s.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${n||r&&"raster"!==s.authority&&512===r?"@2x":""}${mo.supported?".webp":"$1"}`),"raster"===s.authority?s.path=`/${Ae.RASTER_URL_PREFIX}${s.path}`:(s.path=s.path.replace(/^.+\/v4\//,"/"),s.path=`/${Ae.TILE_URL_VERSION}${s.path}`);const l=this._customAccessToken||function(c){for(const h of c){const f=h.match(/^access_token=(.*)$/);if(f)return f[1]}return null}(s.params)||Ae.ACCESS_TOKEN;return Ae.REQUIRE_ACCESS_TOKEN&&l&&this._skuToken&&s.params.push(`sku=${this._skuToken}`),this._makeAPIURL(s,l)}canonicalizeTileURL(t,n){const r=br(t);if(!r.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!r.path.match(/\.[\w]+$/))return t;let s="mapbox://";r.path.match(/^\/raster\/v1\//)?s+=`raster/${r.path.replace(`/${Ae.RASTER_URL_PREFIX}/`,"")}`:s+=`tiles/${r.path.replace(`/${Ae.TILE_URL_VERSION}/`,"")}`;let l=r.params;return n&&(l=l.filter(c=>!c.match(/^access_token=/))),l.length&&(s+=`?${l.join("&")}`),s}canonicalizeTileset(t,n){const r=!!n&&hn(n),s=[];for(const l of t.tiles||[])mn(l)?s.push(this.canonicalizeTileURL(l,r)):s.push(l);return s}_makeAPIURL(t,n){const r="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",s=br(Ae.API_URL);if(t.protocol=s.protocol,t.authority=s.authority,"http"===t.protocol){const l=t.params.indexOf("secure");l>=0&&t.params.splice(l,1)}if("/"!==s.path&&(t.path=`${s.path}${t.path}`),!Ae.REQUIRE_ACCESS_TOKEN)return Ii(t);if(n=n||Ae.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error(`An API access token is required to use Mapbox GL. ${r}`);if("s"===n[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${r}`)}return t.params=t.params.filter(l=>-1===l.indexOf("access_token")),t.params.push(`access_token=${n||""}`),Ii(t)}}function hn(e){return 0===e.indexOf("mapbox:")}function mn(e){return Ae.API_URL_REGEX.test(e)}function ir(e){return Ae.API_CDN_URL_REGEX.test(e)}function gr(e){return Ae.API_STYLE_REGEX.test(e)&&!si(e)}function si(e){return Ae.API_SPRITE_REGEX.test(e)}const Io=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function br(e){const t=e.match(Io);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function Ii(e){const t=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${t}`}const ai="mapbox.eventData";function Yi(e){if(!e)return null;const t=e.split(".");if(!t||3!==t.length)return null;try{return JSON.parse(decodeURIComponent(it.atob(t[1]).split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class Xa{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=Yi(Ae.ACCESS_TOKEN);let r="";return r=n&&n.u?it.btoa(encodeURIComponent(n.u).replace(/%([0-9A-F]{2})/g,(s,l)=>String.fromCharCode(Number("0x"+l)))):Ae.ACCESS_TOKEN||"",t?`${ai}.${t}:${r}`:`${ai}:${r}`}fetchEventData(){const t=En("localStorage"),n=this.getStorageKey(),r=this.getStorageKey("uuid");if(t)try{const s=it.localStorage.getItem(n);s&&(this.eventData=JSON.parse(s));const l=it.localStorage.getItem(r);l&&(this.anonId=l)}catch{Y("Unable to read from LocalStorage")}}saveEventData(){const t=En("localStorage"),n=this.getStorageKey(),r=this.getStorageKey("uuid");if(t)try{it.localStorage.setItem(r,this.anonId),Object.keys(this.eventData).length>=1&&it.localStorage.setItem(n,JSON.stringify(this.eventData))}catch{Y("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,r,s){if(!Ae.EVENTS_URL)return;const l=br(Ae.EVENTS_URL);l.params.push(`access_token=${s||Ae.ACCESS_TOKEN||""}`);const c={event:this.type,created:new Date(t).toISOString()},h=n?Vt(c,n):c,f={url:Ii(l),headers:{"Content-Type":"text/plain"},body:JSON.stringify([h])};var m;this.pendingRequest=(m=p=>{this.pendingRequest=null,r(p),this.saveEventData(),this.processRequests(s)},Ct(Vt(f,{method:"POST"}),m))}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}const wr=new class extends Xa{constructor(e){super("appUserTurnstile"),this._customAccessToken=e}postTurnstileEvent(e,t){Ae.EVENTS_URL&&Ae.ACCESS_TOKEN&&Array.isArray(e)&&e.some(n=>hn(n)||mn(n))&&this.queueRequest(Date.now(),t)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=Yi(Ae.ACCESS_TOKEN),n=t?t.u:Ae.ACCESS_TOKEN;let r=n!==this.eventData.tokenU;Wc(this.anonId)||(this.anonId=bf(),r=!0);const s=this.queue.shift();if(this.eventData.lastSuccess){const l=new Date(this.eventData.lastSuccess),c=new Date(s),h=(s-this.eventData.lastSuccess)/864e5;r=r||h>=1||h<-1||l.getDate()!==c.getDate()}else r=!0;r?this.postEvent(s,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Go,skuId:wh,"enabled.telemetry":!1,userId:this.anonId},l=>{l||(this.eventData.lastSuccess=s,this.eventData.tokenU=n)},e):this.processRequests()}},Ya=wr.postTurnstileEvent.bind(wr),Ss=new class extends Xa{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(e,t,n,r){this.skuToken=t,this.errorCb=r,Ae.EVENTS_URL&&(n||Ae.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},n):this.errorCb(new Error(dn)))}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),Wc(this.anonId)||(this.anonId=bf()),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Go,skuId:wh,skuToken:this.skuToken,userId:this.anonId},r=>{r?this.errorCb(r):t&&(this.success[t]=!0)},e))}},sA=Ss.postMapLoadEvent.bind(Ss),Kv=new class extends Xa{constructor(){super("gljs.performance")}postPerformanceEvent(e,t){Ae.EVENTS_URL&&(e||Ae.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},e)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,performanceData:n}=this.queue.shift(),r=function(s){const l=it.performance.getEntriesByType("resource"),c=it.performance.getEntriesByType("mark"),h=function(y){const v={};if(y)for(const b in y)if("other"!==b)for(const E of y[b]){const D=`${b}ResolveRangeMin`,T=`${b}ResolveRangeMax`,C=`${b}RequestCount`,I=`${b}RequestCachedCount`;v[D]=Math.min(v[D]||1/0,E.startTime),v[T]=Math.max(v[T]||-1/0,E.responseEnd);const A=M=>{void 0===v[M]&&(v[M]=0),++v[M]};void 0!==E.transferSize&&0===E.transferSize&&A(I),A(C)}return v}(function(y,v){const b={};if(y)for(const E of y){const D=v(E);void 0===b[D]&&(b[D]=[]),b[D].push(E)}return b}(l,gD)),f=it.devicePixelRatio,p=it.navigator.connection||it.navigator.mozConnection||it.navigator.webkitConnection,m={counters:[],metadata:[],attributes:[]},_=(y,v,b)=>{null!=b&&y.push({name:v,value:b.toString()})};for(const y in h)_(m.counters,y,h[y]);if(s.interactionRange[0]!==1/0&&s.interactionRange[1]!==-1/0&&(_(m.counters,"interactionRangeMin",s.interactionRange[0]),_(m.counters,"interactionRangeMax",s.interactionRange[1])),c)for(const y of Object.keys(Eh)){const v=Eh[y],b=c.find(E=>E.name===v);b&&_(m.counters,v,b.startTime)}return _(m.counters,"visibilityHidden",s.visibilityHidden),_(m.attributes,"style",function(y){if(y)for(const v of y){const b=v.name.split("?")[0];if(gr(b)){const E=b.split("/").slice(-2);if(2===E.length)return`mapbox://styles/${E[0]}/${E[1]}`}}}(l)),_(m.attributes,"terrainEnabled",s.terrainEnabled?"true":"false"),_(m.attributes,"fogEnabled",s.fogEnabled?"true":"false"),_(m.attributes,"projection",s.projection),_(m.attributes,"zoom",s.zoom),_(m.metadata,"devicePixelRatio",f),_(m.metadata,"connectionEffectiveType",p?p.effectiveType:void 0),_(m.metadata,"navigatorUserAgent",it.navigator.userAgent),_(m.metadata,"screenWidth",it.screen.width),_(m.metadata,"screenHeight",it.screen.height),_(m.metadata,"windowWidth",it.innerWidth),_(m.metadata,"windowHeight",it.innerHeight),_(m.metadata,"mapWidth",s.width/f),_(m.metadata,"mapHeight",s.height/f),_(m.metadata,"webglRenderer",s.renderer),_(m.metadata,"webglVendor",s.vendor),_(m.metadata,"sdkVersion",Go),_(m.metadata,"sdkIdentifier","mapbox-gl-js"),m}(n);for(const s of r.metadata);for(const s of r.counters);for(const s of r.attributes);this.postEvent(t,r,()=>{},e)}},pD=Kv.postPerformanceEvent.bind(Kv),wf=new class extends Xa{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(e,t,n,r){if(!Ae.API_URL||!Ae.SESSION_PATH)return;const s=br(Ae.API_URL+Ae.SESSION_PATH);s.params.push(`sku=${t||""}`),s.params.push(`access_token=${r||Ae.ACCESS_TOKEN||""}`);const l={url:Ii(s),headers:{"Content-Type":"text/plain"}};var h;this.pendingRequest=(h=c=>{this.pendingRequest=null,n(c),this.saveEventData(),this.processRequests(r)},Ct(Vt(l,{method:"GET"}),h))}getSessionAPI(e,t,n,r){this.skuToken=t,this.errorCb=r,Ae.SESSION_PATH&&Ae.API_URL&&(n||Ae.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},n):this.errorCb(new Error(dn)))}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,r=>{r?this.errorCb(r):t&&(this.success[t]=!0)},e)}},mD=wf.getSessionAPI.bind(wf),Ka=new Set;function Jv(e,t){t?Ka.add(e):Ka.delete(e)}const Eh={create:"create",load:"load",fullLoad:"fullLoad"},vg={mark(e){it.performance.mark(e)},measure(e,t,n){it.performance.measure(e,t,n)}};function gD(e){const t=e.name.split("?")[0];return ir(t)&&t.includes("mapbox-gl.js")?"javascript":ir(t)&&t.includes("mapbox-gl.css")?"css":Ae.API_FONTS_REGEX.test(t)?"fontRange":si(t)?"sprite":gr(t)?"style":Ae.API_TILEJSON_REGEX.test(t)?"tilejson":"other"}const _D=it.performance;function Qv(e){const t=e?e.url.toString():void 0;return _D.getEntriesByName(t)}var tx=Ef;function Ef(e){return t=e,!(typeof window>"u"||typeof document>"u"||!(Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray)||!Function.prototype||!Function.prototype.bind||!(Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions)||!("JSON"in window&&"parse"in JSON&&"stringify"in JSON)||!function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var r,s,l=new Blob([""],{type:"text/javascript"}),c=URL.createObjectURL(l);try{s=new Worker(c),r=!0}catch{r=!1}return s&&s.terminate(),URL.revokeObjectURL(c),r}()||!("Uint8ClampedArray"in window)||!ArrayBuffer.isView||!function(){var r=document.createElement("canvas");r.width=r.height=1;var s=r.getContext("2d");if(!s)return!1;var l=s.getImageData(0,0,1,1);return l&&l.width===r.width}()||(void 0===xg[n=t&&t.failIfMajorPerformanceCaveat]&&(xg[n]=function(r){var s,c,h,f,l=(c=r,h=document.createElement("canvas"),(f=Object.create(Ef.webGLContextAttributes)).failIfMajorPerformanceCaveat=c,h.getContext("webgl",f)||h.getContext("experimental-webgl",f));if(!l)return!1;try{s=l.createShader(l.VERTEX_SHADER)}catch{return!1}return!(!s||l.isContextLost())&&(l.shaderSource(s,"void main() {}"),l.compileShader(s),!0===l.getShaderParameter(s,l.COMPILE_STATUS))}(n)),!xg[n]||document.documentMode));var t,n}var xg={};let Tf,Lr,Df,$l;Ef.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const me={now:()=>void 0!==Df?Df:it.performance.now(),setNow(e){Df=e},restoreNow(){Df=void 0},frame(e){const t=it.requestAnimationFrame(e);return{cancel:()=>it.cancelAnimationFrame(t)}},getImageData(e,t=0){const{width:n,height:r}=e;$l||($l=it.document.createElement("canvas"));const s=$l.getContext("2d",{willReadFrequently:!0});if(!s)throw new Error("failed to create canvas 2d context");return(n>$l.width||r>$l.height)&&($l.width=n,$l.height=r),s.clearRect(-t,-t,n+2*t,r+2*t),s.drawImage(e,0,0,n,r),s.getImageData(-t,-t,n+2*t,r+2*t)},resolveURL:e=>(Tf||(Tf=it.document.createElement("a")),Tf.href=e,Tf.href),get devicePixelRatio(){return it.devicePixelRatio},get prefersReducedMotion(){return!!it.matchMedia&&(null==Lr&&(Lr=it.matchMedia("(prefers-reduced-motion: reduce)")),Lr.matches)}};function _e(e,t,n){const r=it.document.createElement(e);return void 0!==t&&(r.className=t),n&&n.appendChild(r),r}function Zo(e,t,n){const r=it.document.createElementNS("http://www.w3.org/2000/svg",e);for(const s of Object.keys(t))r.setAttributeNS(null,s,t[s]);return n&&n.appendChild(r),r}const In=it.document&&it.document.documentElement.style,Hl=In&&void 0!==In.userSelect?"userSelect":"WebkitUserSelect";let ex;function Sf(){In&&Hl&&(ex=In[Hl],In[Hl]="none")}function Ge(){In&&Hl&&(In[Hl]=ex)}function Th(e){e.preventDefault(),e.stopPropagation(),it.removeEventListener("click",Th,!0)}function nx(){it.addEventListener("click",Th,!0),it.setTimeout(()=>{it.removeEventListener("click",Th,!0)},0)}function ne(e,t){const n=e.getBoundingClientRect();return Ln(e,n,t)}function Gl(e,t){const n=e.getBoundingClientRect(),r=[];for(let s=0;s<t.length;s++)r.push(Ln(e,n,t[s]));return r}function Je(e){return void 0!==it.InstallTrigger&&2===e.button&&e.ctrlKey&&it.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:e.button}function Ln(e,t,n){const r=e.offsetWidth===t.width?1:e.offsetWidth/t.width;return new tt((n.clientX-t.left)*r,(n.clientY-t.top)*r)}function rx(e,t,n){n[e]&&-1!==n[e].indexOf(t)||(n[e]=n[e]||[],n[e].push(t))}function ix(e,t,n){if(n&&n[e]){const r=n[e].indexOf(t);-1!==r&&n[e].splice(r,1)}}class xt{constructor(t,n={}){Vt(this,n),this.type=t}}class he extends xt{constructor(t,n={}){super("error",Vt({error:t},n))}}class xn{on(t,n){return this._listeners=this._listeners||{},rx(t,n,this._listeners),this}off(t,n){return ix(t,n,this._listeners),ix(t,n,this._oneTimeListeners),this}once(t,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},rx(t,n,this._oneTimeListeners),this):new Promise(r=>this.once(t,r))}fire(t,n){"string"==typeof t&&(t=new xt(t,n||{}));const r=t.type;if(this.listens(r)){t.target=this;const s=this._listeners&&this._listeners[r]?this._listeners[r].slice():[];for(const h of s)h.call(this,t);const l=this._oneTimeListeners&&this._oneTimeListeners[r]?this._oneTimeListeners[r].slice():[];for(const h of l)ix(r,h,this._oneTimeListeners),h.call(this,t);const c=this._eventedParent;c&&(Vt(t,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),c.fire(t))}else t instanceof he&&console.error(t.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,n){return this._eventedParent=t,this._eventedParentData=n,this}}var rt=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","default":[0,1],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class Ut{constructor(t,n,r,s){this.message=(t?`${t}: `:"")+r,s&&(this.identifier=s),null!=n&&n.__line__&&(this.line=n.__line__)}}class Kc extends Ut{}function li(e,...t){for(const n of t)for(const r in n)e[r]=n[r];return e}function Er(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function Ja(e){if(Array.isArray(e))return e.map(Ja);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const n in e)t[n]=Ja(e[n]);return t}return Er(e)}class aA extends Error{constructor(t,n){super(n),this.message=n,this.key=t}}var aa=aA;class bg{constructor(t,n=[]){this.parent=t,this.bindings={};for(const[r,s]of n)this.bindings[r]=s}concat(t){return new bg(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var lA=bg;const Jc={kind:"null"},Bt={kind:"number"},De={kind:"string"},re={kind:"boolean"},Xo={kind:"color"},Dh={kind:"object"},nn={kind:"value"},Ue={kind:"collator"},Cf={kind:"formatted"},Ki={kind:"resolvedImage"};function ci(e,t){return{kind:"array",itemType:e,N:t}}function cr(e){if("array"===e.kind){const t=cr(e.itemType);return"number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}const ox=[Jc,Bt,De,re,Xo,Cf,Dh,ci(nn),Ki];function Sh(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!Sh(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if("value"===e.kind)for(const n of ox)if(!Sh(n,t))return null}return`Expected ${cr(e)} but found ${cr(t)} instead.`}function wg(e,t){return t.some(n=>n.kind===e.kind)}function Qc(e,t){return t.some(n=>"null"===n?null===e:"array"===n?Array.isArray(e):"object"===n?e&&!Array.isArray(e)&&"object"==typeof e:n===typeof e)}var tu,Mf={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Ch(e){return(e=Math.round(e))<0?0:e>255?255:e}function Eg(e){return Ch("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function Oe(e){return(t="%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t}function Mh(e,t,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?e+(t-e)*n*6:2*n<1?t:3*n<2?e+(t-e)*(2/3-n)*6:e}try{tu={}.parseCSSColor=function(e){var t,n=e.replace(/ /g,"").toLowerCase();if(n in Mf)return Mf[n].slice();if("#"===n[0])return 4===n.length?(t=parseInt(n.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:7===n.length&&(t=parseInt(n.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var r=n.indexOf("("),s=n.indexOf(")");if(-1!==r&&s+1===n.length){var l=n.substr(0,r),c=n.substr(r+1,s-(r+1)).split(","),h=1;switch(l){case"rgba":if(4!==c.length)return null;h=Oe(c.pop());case"rgb":return 3!==c.length?null:[Eg(c[0]),Eg(c[1]),Eg(c[2]),h];case"hsla":if(4!==c.length)return null;h=Oe(c.pop());case"hsl":if(3!==c.length)return null;var f=(parseFloat(c[0])%360+360)%360/360,p=Oe(c[1]),m=Oe(c[2]),_=m<=.5?m*(p+1):m+p-m*p,y=2*m-_;return[Ch(255*Mh(y,_,f+1/3)),Ch(255*Mh(y,_,f)),Ch(255*Mh(y,_,f-1/3)),h];default:return null}}return null}}catch{}class Ji{constructor(t,n,r,s=1){this.r=t,this.g=n,this.b=r,this.a=s}static parse(t){if(!t)return;if(t instanceof Ji)return t;if("string"!=typeof t)return;const n=tu(t);return n?new Ji(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toString(){const[t,n,r,s]=this.toArray();return`rgba(${Math.round(t)},${Math.round(n)},${Math.round(r)},${s})`}toArray(){const{r:t,g:n,b:r,a:s}=this;return 0===s?[0,0,0,0]:[255*t/s,255*n/s,255*r/s,s]}toArray01(){const{r:t,g:n,b:r,a:s}=this;return 0===s?[0,0,0,0]:[t/s,n/s,r/s,s]}toArray01Scaled(t){const{r:n,g:r,b:s,a:l}=this;return 0===l?[0,0,0]:[n/l*t,r/l*t,s/l*t]}toArray01PremultipliedAlpha(){const{r:t,g:n,b:r,a:s}=this;return[t,n,r,s]}toArray01Linear(){const{r:t,g:n,b:r,a:s}=this;return 0===s?[0,0,0,0]:[Math.pow(t/s,2.2),Math.pow(n/s,2.2),Math.pow(r/s,2.2),s]}}Ji.black=new Ji(0,0,0,1),Ji.white=new Ji(1,1,1,1),Ji.transparent=new Ji(0,0,0,0),Ji.red=new Ji(1,0,0,1),Ji.blue=new Ji(0,0,1,1);var le=Ji;class If{constructor(t,n,r){this.sensitivity=t?n?"variant":"case":n?"accent":"base",this.locale=r,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,n){return this.collator.compare(t,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class sx{constructor(t,n,r,s,l){this.text=t.normalize?t.normalize():t,this.image=n,this.scale=r,this.fontStack=s,this.textColor=l}}class kr{constructor(t){this.sections=t}static fromString(t){return new kr([new sx(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(t=>0!==t.text.length||t.image&&0!==t.image.namePrimary.length)}static factory(t){return t instanceof kr?t:kr.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const n of this.sections){if(n.image){t.push(["image",n.image.namePrimary]);continue}t.push(n.text);const r={};n.fontStack&&(r["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(r["font-scale"]=n.scale),n.textColor&&(r["text-color"]=["rgba"].concat(n.textColor.toArray())),t.push(r)}return t}}class Tr{constructor(t){this.namePrimary=t.namePrimary,t.nameSecondary&&(this.nameSecondary=t.nameSecondary),this.available=t.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(t,n){return t?new Tr({namePrimary:t,nameSecondary:n,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function yD(e,t,n,r){return"number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof n&&n>=0&&n<=255?void 0===r||"number"==typeof r&&r>=0&&r<=1?null:`Invalid rgba value [${[e,t,n,r].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof r?[e,t,n,r]:[e,t,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ih(e){if(null===e||"string"==typeof e||"boolean"==typeof e||"number"==typeof e||e instanceof le||e instanceof If||e instanceof kr||e instanceof Tr)return!0;if(Array.isArray(e)){for(const t of e)if(!Ih(t))return!1;return!0}if("object"==typeof e){for(const t in e)if(!Ih(e[t]))return!1;return!0}return!1}function Vn(e){if(null===e)return Jc;if("string"==typeof e)return De;if("boolean"==typeof e)return re;if("number"==typeof e)return Bt;if(e instanceof le)return Xo;if(e instanceof If)return Ue;if(e instanceof kr)return Cf;if(e instanceof Tr)return Ki;if(Array.isArray(e)){const t=e.length;let n;for(const r of e){const s=Vn(r);if(n){if(n===s)continue;n=nn;break}n=s}return ci(n||nn,t)}return Dh}function Un(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof le||e instanceof kr||e instanceof Tr?e.toString():JSON.stringify(e)}class ax{constructor(t,n){this.type=t,this.value=n}static parse(t,n){if(2!==t.length)return n.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Ih(t[1]))return n.error("invalid value");const r=t[1];let s=Vn(r);const l=n.expectedType;return"array"!==s.kind||0!==s.N||!l||"array"!==l.kind||"number"==typeof l.N&&0!==l.N||(s=l),new ax(s,r)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof le?["rgba"].concat(this.value.toArray()):this.value instanceof kr?this.value.serialize():this.value}}var Af=ax,sr=class{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}};const An={string:De,number:Bt,boolean:re,object:Dh};class eu{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");let r,s=1;const l=t[0];if("array"===l){let h,f;if(t.length>2){const p=t[1];if("string"!=typeof p||!(p in An)||"object"===p)return n.error('The item type argument of "array" must be one of string, number, boolean',1);h=An[p],s++}else h=nn;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return n.error('The length argument to "array" must be a positive integer literal',2);f=t[2],s++}r=ci(h,f)}else r=An[l];const c=[];for(;s<t.length;s++){const h=n.parse(t[s],s,nn);if(!h)return null;c.push(h)}return new eu(r,c)}evaluate(t){for(let n=0;n<this.args.length;n++){const r=this.args[n].evaluate(t);if(!Sh(this.type,Vn(r)))return r;if(n===this.args.length-1)throw new sr(`Expected value to be of type ${cr(this.type)}, but found ${cr(Vn(r))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,n=[t.kind];if("array"===t.kind){const r=t.itemType;if("string"===r.kind||"number"===r.kind||"boolean"===r.kind){n.push(r.kind);const s=t.N;("number"==typeof s||this.args.length>1)&&n.push(s)}}return n.concat(this.args.map(r=>r.serialize()))}}var Yo=eu;class ql{constructor(t){this.type=Cf,this.sections=t}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const r=t[1];if(!Array.isArray(r)&&"object"==typeof r)return n.error("First argument must be an image or text section.");const s=[];let l=!1;for(let c=1;c<=t.length-1;++c){const h=t[c];if(l&&"object"==typeof h&&!Array.isArray(h)){l=!1;let f=null;if(h["font-scale"]&&(f=n.parse(h["font-scale"],1,Bt),!f))return null;let p=null;if(h["text-font"]&&(p=n.parse(h["text-font"],1,ci(De)),!p))return null;let m=null;if(h["text-color"]&&(m=n.parse(h["text-color"],1,Xo),!m))return null;const _=s[s.length-1];_.scale=f,_.font=p,_.textColor=m}else{const f=n.parse(t[c],1,nn);if(!f)return null;const p=f.type.kind;if("string"!==p&&"value"!==p&&"null"!==p&&"resolvedImage"!==p)return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");l=!0,s.push({content:f,scale:null,font:null,textColor:null})}}return new ql(s)}evaluate(t){return new kr(this.sections.map(n=>{const r=n.content.evaluate(t);return Vn(r)===Ki?new sx("",r,null,null,null):new sx(Un(r),null,n.scale?n.scale.evaluate(t):null,n.font?n.font.evaluate(t).join(","):null,n.textColor?n.textColor.evaluate(t):null)}))}eachChild(t){for(const n of this.sections)t(n.content),n.scale&&t(n.scale),n.font&&t(n.font),n.textColor&&t(n.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const n of this.sections){t.push(n.content.serialize());const r={};n.scale&&(r["font-scale"]=n.scale.serialize()),n.font&&(r["text-font"]=n.font.serialize()),n.textColor&&(r["text-color"]=n.textColor.serialize()),t.push(r)}return t}}class nu{constructor(t,n){this.type=Ki,this.inputPrimary=t,this.inputSecondary=n}static parse(t,n){if(t.length<2)return n.error("Expected two or more arguments.");const r=n.parse(t[1],1,De);if(!r)return n.error("No image name provided.");if(2===t.length)return new nu(r);const s=n.parse(t[2],1,De);return s?new nu(r,s):n.error("Secondary image variant is not a string.")}evaluate(t){const n=Tr.fromString(this.inputPrimary.evaluate(t),this.inputSecondary?this.inputSecondary.evaluate(t):void 0);return n&&t.availableImages&&(n.available=t.availableImages.indexOf(n.namePrimary)>-1,n.nameSecondary&&n.available&&t.availableImages&&(n.available=t.availableImages.indexOf(n.nameSecondary)>-1)),n}eachChild(t){t(this.inputPrimary),this.inputSecondary&&t(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Ze(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":null===e?"null":typeof e}const Ah={"to-boolean":re,"to-color":Xo,"to-number":Bt,"to-string":De};class Tg{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const r=t[0],s=[];let l=Jc;if("to-array"===r){if(!Array.isArray(t[1]))return null;const c=t[1].length;if(n.expectedType){if("array"!==n.expectedType.kind)return n.error(`Expected ${n.expectedType.kind} but found array.`);l=ci(n.expectedType.itemType,c)}else{if(!(c>0&&Ih(t[1][0])))return null;l=ci(Vn(t[1][0]),c)}for(let h=0;h<c;h++){const f=t[1][h];let p;if("array"===Ze(f))p=n.parse(f,void 0,l.itemType);else{const m=Ze(f);if(m!==l.itemType.kind)return n.error(`Expected ${l.itemType.kind} but found ${m}.`);p=n.registry.literal.parse(["literal",void 0===f?null:f],n)}if(!p)return null;s.push(p)}}else{if(("to-boolean"===r||"to-string"===r)&&2!==t.length)return n.error("Expected one argument.");l=Ah[r];for(let c=1;c<t.length;c++){const h=n.parse(t[c],c,nn);if(!h)return null;s.push(h)}}return new Tg(l,s)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let n,r;for(const s of this.args){if(n=s.evaluate(t),r=null,n instanceof le)return n;if("string"==typeof n){const l=t.parseColor(n);if(l)return l}else if(Array.isArray(n)&&(r=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:yD(n[0],n[1],n[2],n[3]),!r))return new le(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new sr(r||`Could not parse color from value '${"string"==typeof n?n:String(JSON.stringify(n))}'`)}if("number"===this.type.kind){let n=null;for(const r of this.args){if(n=r.evaluate(t),null===n)return 0;const s=Number(n);if(!isNaN(s))return s}throw new sr(`Could not convert ${JSON.stringify(n)} to number.`)}return"formatted"===this.type.kind?kr.fromString(Un(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?Tr.fromString(Un(this.args[0].evaluate(t))):"array"===this.type.kind?this.args.map(n=>n.evaluate(t)):Un(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if("formatted"===this.type.kind)return new ql([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new nu(this.args[0]).serialize();const t="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{t.push(n.serialize())}),t}}var Qi=Tg;const vD=["Unknown","Point","LineString","Polygon"];var Dg=class{constructor(e){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.options=e}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?vD[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:n,y:r}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(n*t-e[0])+this.featureDistanceData.bearing[1]*(r*t-e[1])}return 0}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=le.parse(e)),t}getConfig(e){return this.options?this.options.get(e):null}};class Wl{constructor(t,n,r,s){this.name=t,this.type=n,this._evaluate=r,this.args=s}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,n){const r=t[0],s=Wl.definitions[r];if(!s)return n.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0);const l=Array.isArray(s)?s[0]:s.type,c=Array.isArray(s)?[[s[1],s[2]]]:s.overloads,h=c.filter(([p])=>!Array.isArray(p)||p.length===t.length-1);let f=null;for(const[p,m]of h){f=new ED(n.registry,n.path,null,n.scope,void 0,n.options);const _=[];let y=!1;for(let v=1;v<t.length;v++){const b=t[v],E=Array.isArray(p)?p[v-1]:p.type,D=f.parse(b,1+_.length,E);if(!D){y=!0;break}_.push(D)}if(!y)if(Array.isArray(p)&&p.length!==_.length)f.error(`Expected ${p.length} arguments, but found ${_.length} instead.`);else{for(let v=0;v<_.length;v++){const b=Array.isArray(p)?p[v]:p.type,E=_[v];f.concat(v+1).checkSubtype(b,E.type)}if(0===f.errors.length)return new Wl(r,l,m,_)}}if(1===h.length)n.errors.push(...f.errors);else{const p=(h.length?h:c).map(([_])=>{return y=_,Array.isArray(y)?`(${y.map(cr).join(", ")})`:`(${cr(y.type)}...)`;var y}).join(" | "),m=[];for(let _=1;_<t.length;_++){const y=n.parse(t[_],1+m.length);if(!y)return null;m.push(cr(y.type))}n.error(`Expected arguments of type ${p}, but found (${m.join(", ")}) instead.`)}return null}static register(t,n){Wl.definitions=n;for(const r in n)t[r]=Wl}}var Qr=Wl;class Pf{constructor(t,n,r){this.type=Ue,this.locale=r,this.caseSensitive=t,this.diacriticSensitive=n}static parse(t,n){if(2!==t.length)return n.error("Expected one argument.");const r=t[1];if("object"!=typeof r||Array.isArray(r))return n.error("Collator options argument must be an object.");const s=n.parse(void 0!==r["case-sensitive"]&&r["case-sensitive"],1,re);if(!s)return null;const l=n.parse(void 0!==r["diacritic-sensitive"]&&r["diacritic-sensitive"],1,re);if(!l)return null;let c=null;return r.locale&&(c=n.parse(r.locale,1,De),!c)?null:new Pf(s,l,c)}evaluate(t){return new If(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}var Sg={exports:{}};Sg.exports=function(){function e(r,s,l,c,h){for(;c>l;){if(c-l>600){var f=c-l+1,p=s-l+1,m=Math.log(f),_=.5*Math.exp(2*m/3),y=.5*Math.sqrt(m*_*(f-_)/f)*(p-f/2<0?-1:1);e(r,s,Math.max(l,Math.floor(s-p*_/f+y)),Math.min(c,Math.floor(s+(f-p)*_/f+y)),h)}var v=r[s],b=l,E=c;for(t(r,l,s),h(r[c],v)>0&&t(r,l,c);b<E;){for(t(r,b,E),b++,E--;h(r[b],v)<0;)b++;for(;h(r[E],v)>0;)E--}0===h(r[l],v)?t(r,l,E):t(r,++E,c),E<=s&&(l=E+1),s<=E&&(c=E-1)}}function t(r,s,l){var c=r[s];r[s]=r[l],r[l]=c}function n(r,s){return r<s?-1:r>s?1:0}return function(r,s,l,c,h){e(r,s,l||0,c||r.length-1,h||n)}}();var xi=Zi(Sg.exports);function to(e){let t=0;for(let n,r,s=0,l=e.length,c=l-1;s<l;c=s++)n=e[s],r=e[c],t+=(r.x-n.x)*(n.y+r.y);return t}function Pn(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function Gr(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function Ai(e,t,n){const r=e[0]-t[0],s=e[1]-t[1],l=e[0]-n[0],c=e[1]-n[1];return r*c-l*s==0&&r*l<=0&&s*c<=0}function Ko(e,t,n=!1){let r=!1;for(let h=0,f=t.length;h<f;h++){const p=t[h];for(let m=0,_=p.length,y=_-1;m<_;y=m++){const v=p[y],b=p[m];if(Ai(e,v,b))return n;(l=v)[1]>(s=e)[1]!=(c=b)[1]>s[1]&&s[0]<(c[0]-l[0])*(s[1]-l[1])/(c[1]-l[1])+l[0]&&(r=!r)}}var s,l,c;return r}function eo(e,t,n,r){const s=r[0]-n[0],l=r[1]-n[1],c=(e[0]-n[0])*l-s*(e[1]-n[1]),h=(t[0]-n[0])*l-s*(t[1]-n[1]);return c>0&&h<0||c<0&&h>0}function Pi(e,t,n,r){return(s=[r[0]-n[0],r[1]-n[1]])[0]*(l=[t[0]-e[0],t[1]-e[1]])[1]-s[1]*l[0]!=0&&!(!eo(e,t,n,r)||!eo(n,r,e,t));var s,l}const Xt=8192;function rn(e,t){const n=(180+e[0])/360,r=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,s=Math.pow(2,t.z);return[Math.round(n*s*Xt),Math.round(r*s*Xt)]}function ur(e,t){for(let n=0;n<t.length;n++)if(Ko(e,t[n]))return!0;return!1}function go(e,t,n){for(const r of n)for(let s=0,l=r.length,c=l-1;s<l;c=s++)if(Pi(e,t,r[c],r[s]))return!0;return!1}function Qa(e,t){for(let n=0;n<e.length;++n)if(!Ko(e[n],t))return!1;for(let n=0;n<e.length-1;++n)if(go(e[n],e[n+1],t))return!1;return!0}function ti(e,t){for(let n=0;n<t.length;n++)if(Qa(e,t[n]))return!0;return!1}function la(e,t,n){const r=[];for(let s=0;s<e.length;s++){const l=[];for(let c=0;c<e[s].length;c++){const h=rn(e[s][c],n);Pn(t,h),l.push(h)}r.push(l)}return r}function _r(e,t,n){const r=[];for(let s=0;s<e.length;s++){const l=la(e[s],t,n);r.push(l)}return r}function ru(e,t,n,r){if(e[0]<n[0]||e[0]>n[2]){const s=.5*r;let l=e[0]-n[0]>s?-r:n[0]-e[0]>s?r:0;0===l&&(l=e[0]-n[2]>s?-r:n[2]-e[0]>s?r:0),e[0]+=l}Pn(t,e)}function iu(e,t,n,r){const s=Math.pow(2,r.z)*Xt,l=[r.x*Xt,r.y*Xt],c=[];if(!e)return c;for(const h of e)for(const f of h){const p=[f.x+l[0],f.y+l[1]];ru(p,t,n,s),c.push(p)}return c}function on(e,t,n,r){const s=Math.pow(2,r.z)*Xt,l=[r.x*Xt,r.y*Xt],c=[];if(!e)return c;for(const f of e){const p=[];for(const m of f){const _=[m.x+l[0],m.y+l[1]];Pn(t,_),p.push(_)}c.push(p)}if(t[2]-t[0]<=s/2){(h=t)[0]=h[1]=1/0,h[2]=h[3]=-1/0;for(const f of c)for(const p of f)ru(p,t,n,s)}var h;return c}class tl{constructor(t,n){this.type=re,this.geojson=t,this.geometries=n}static parse(t,n){if(2!==t.length)return n.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Ih(t[1])){const r=t[1];if("FeatureCollection"===r.type)for(let s=0;s<r.features.length;++s){const l=r.features[s].geometry.type;if("Polygon"===l||"MultiPolygon"===l)return new tl(r,r.features[s].geometry)}else if("Feature"===r.type){const s=r.geometry.type;if("Polygon"===s||"MultiPolygon"===s)return new tl(r,r.geometry)}else if("Polygon"===r.type||"MultiPolygon"===r.type)return new tl(r,r)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(n,r){const s=[1/0,1/0,-1/0,-1/0],l=[1/0,1/0,-1/0,-1/0],c=n.canonicalID();if(!c)return!1;if("Polygon"===r.type){const h=la(r.coordinates,l,c),f=iu(n.geometry(),s,l,c);if(!Gr(s,l))return!1;for(const p of f)if(!Ko(p,h))return!1}if("MultiPolygon"===r.type){const h=_r(r.coordinates,l,c),f=iu(n.geometry(),s,l,c);if(!Gr(s,l))return!1;for(const p of f)if(!ur(p,h))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(n,r){const s=[1/0,1/0,-1/0,-1/0],l=[1/0,1/0,-1/0,-1/0],c=n.canonicalID();if(!c)return!1;if("Polygon"===r.type){const h=la(r.coordinates,l,c),f=on(n.geometry(),s,l,c);if(!Gr(s,l))return!1;for(const p of f)if(!Qa(p,h))return!1}if("MultiPolygon"===r.type){const h=_r(r.coordinates,l,c),f=on(n.geometry(),s,l,c);if(!Gr(s,l))return!1;for(const p of f)if(!ti(p,h))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var el=tl,Rf={exports:{}};Rf.exports=function(){var e={kilometers:1,miles:.621371192237334,nauticalmiles:.5399568034557235,meters:1e3,metres:1e3,yards:1093.6132983377079,feet:3280.839895013123,inches:39370.078740157485},t=1/298.257223563,n=t*(2-t),r=Math.PI/180,s=function(p,m){if(void 0===p)throw new Error("No latitude given.");if(m&&!e[m])throw new Error("Unknown unit "+m+". Use one of: "+Object.keys(e).join(", "));var _=6378.137*r*(m?e[m]:1),y=Math.cos(p*r),v=1/(1-n*(1-y*y)),b=Math.sqrt(v);this.kx=_*b*y,this.ky=_*b*v*(1-n)},l={units:{configurable:!0}};function c(p,m){return p[0]===m[0]&&p[1]===m[1]}function h(p,m,_){var y=f(m[0]-p[0]);return[p[0]+y*_,p[1]+(m[1]-p[1])*_]}function f(p){for(;p<-180;)p+=360;for(;p>180;)p-=360;return p}return s.fromTile=function(p,m,_){var y=Math.PI*(1-2*(p+.5)/Math.pow(2,m)),v=Math.atan(.5*(Math.exp(y)-Math.exp(-y)))/r;return new s(v,_)},l.units.get=function(){return e},s.prototype.distance=function(p,m){var _=f(p[0]-m[0])*this.kx,y=(p[1]-m[1])*this.ky;return Math.sqrt(_*_+y*y)},s.prototype.bearing=function(p,m){var _=f(m[0]-p[0])*this.kx;return Math.atan2(_,(m[1]-p[1])*this.ky)/r},s.prototype.destination=function(p,m,_){var y=_*r;return this.offset(p,Math.sin(y)*m,Math.cos(y)*m)},s.prototype.offset=function(p,m,_){return[p[0]+m/this.kx,p[1]+_/this.ky]},s.prototype.lineDistance=function(p){for(var m=0,_=0;_<p.length-1;_++)m+=this.distance(p[_],p[_+1]);return m},s.prototype.area=function(p){for(var m=0,_=0;_<p.length;_++)for(var y=p[_],v=0,b=y.length,E=b-1;v<b;E=v++)m+=f(y[v][0]-y[E][0])*(y[v][1]+y[E][1])*(_?-1:1);return Math.abs(m)/2*this.kx*this.ky},s.prototype.along=function(p,m){var _=0;if(m<=0)return p[0];for(var y=0;y<p.length-1;y++){var v=p[y],b=p[y+1],E=this.distance(v,b);if((_+=E)>m)return h(v,b,(m-(_-E))/E)}return p[p.length-1]},s.prototype.pointToSegmentDistance=function(p,m,_){var y=m[0],v=m[1],b=f(_[0]-y)*this.kx,E=(_[1]-v)*this.ky,D=0;return 0===b&&0===E||((D=(f(p[0]-y)*this.kx*b+(p[1]-v)*this.ky*E)/(b*b+E*E))>1?(y=_[0],v=_[1]):D>0&&(y+=b/this.kx*D,v+=E/this.ky*D)),b=f(p[0]-y)*this.kx,E=(p[1]-v)*this.ky,Math.sqrt(b*b+E*E)},s.prototype.pointOnLine=function(p,m){for(var _,y,v,b,E=1/0,D=0;D<p.length-1;D++){var T=p[D][0],C=p[D][1],I=f(p[D+1][0]-T)*this.kx,A=(p[D+1][1]-C)*this.ky,M=0;0===I&&0===A||((M=(f(m[0]-T)*this.kx*I+(m[1]-C)*this.ky*A)/(I*I+A*A))>1?(T=p[D+1][0],C=p[D+1][1]):M>0&&(T+=I/this.kx*M,C+=A/this.ky*M));var R=(I=f(m[0]-T)*this.kx)*I+(A=(m[1]-C)*this.ky)*A;R<E&&(E=R,_=T,y=C,v=D,b=M)}return{point:[_,y],index:v,t:Math.max(0,Math.min(1,b))}},s.prototype.lineSlice=function(p,m,_){var y=this.pointOnLine(_,p),v=this.pointOnLine(_,m);if(y.index>v.index||y.index===v.index&&y.t>v.t){var b=y;y=v,v=b}var E=[y.point],D=y.index+1,T=v.index;!c(_[D],E[0])&&D<=T&&E.push(_[D]);for(var C=D+1;C<=T;C++)E.push(_[C]);return c(_[T],v.point)||E.push(v.point),E},s.prototype.lineSliceAlong=function(p,m,_){for(var y=0,v=[],b=0;b<_.length-1;b++){var E=_[b],D=_[b+1],T=this.distance(E,D);if((y+=T)>p&&0===v.length&&v.push(h(E,D,(p-(y-T))/T)),y>=m)return v.push(h(E,D,(m-(y-T))/T)),v;y>p&&v.push(D)}return v},s.prototype.bufferPoint=function(p,m){var _=m/this.ky,y=m/this.kx;return[p[0]-y,p[1]-_,p[0]+y,p[1]+_]},s.prototype.bufferBBox=function(p,m){var _=m/this.ky,y=m/this.kx;return[p[0]-y,p[1]-_,p[2]+y,p[3]+_]},s.prototype.insideBBox=function(p,m){return f(p[0]-m[0])>=0&&f(p[0]-m[2])<=0&&p[1]>=m[1]&&p[1]<=m[3]},Object.defineProperties(s,l),s}();var ca=Zi(Rf.exports),ui={exports:{}};ui.exports=function(){var e=function(n,r){if(void 0===n&&(n=[]),void 0===r&&(r=t),this.data=n,this.length=this.data.length,this.compare=r,this.length>0)for(var s=(this.length>>1)-1;s>=0;s--)this._down(s)};function t(n,r){return n<r?-1:n>r?1:0}return e.prototype.push=function(n){this.data.push(n),this.length++,this._up(this.length-1)},e.prototype.pop=function(){if(0!==this.length){var n=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),n}},e.prototype.peek=function(){return this.data[0]},e.prototype._up=function(n){for(var r=this.data,s=this.compare,l=r[n];n>0;){var c=n-1>>1,h=r[c];if(s(l,h)>=0)break;r[n]=h,n=c}r[n]=l},e.prototype._down=function(n){for(var r=this.data,s=this.compare,l=this.length>>1,c=r[n];n<l;){var h=1+(n<<1),f=r[h],p=h+1;if(p<this.length&&s(r[p],f)<0&&(h=p,f=r[p]),s(f,c)>=0)break;r[n]=f,n=h}r[n]=c},e}();var Zl=Zi(ui.exports),st=8192;function Ao(e,t){return t.dist-e.dist}function tr(e){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function kf(e){return e[1]-e[0]+1}function ua(e,t){const n=e[1]>=e[0]&&e[1]<t;return n||console.warn("Distance Expression: Index is out of range"),n}function ou(e,t){if(e[0]>e[1])return[null,null];const n=kf(e);if(t){if(2===n)return[e,null];const r=Math.floor(n/2);return[[e[0],e[0]+r],[e[0]+r,e[1]]]}{if(1===n)return[e,null];const r=Math.floor(n/2)-1;return[[e[0],e[0]+r],[e[0]+r+1,e[1]]]}}function ha(e,t){const n=[1/0,1/0,-1/0,-1/0];if(!ua(t,e.length))return n;for(let r=t[0];r<=t[1];++r)Pn(n,e[r]);return n}function rl(e){const t=[1/0,1/0,-1/0,-1/0];for(let n=0;n<e.length;++n)for(let r=0;r<e[n].length;++r)Pn(t,e[n][r]);return t}function da(e,t,n){if(tr(e)||tr(t))return NaN;let r=0,s=0;return e[2]<t[0]&&(r=t[0]-e[2]),e[0]>t[2]&&(r=e[0]-t[2]),e[1]>t[3]&&(s=e[1]-t[3]),e[3]<t[1]&&(s=t[1]-e[3]),n.distance([0,0],[r,s])}function fa(e,t){const n=Math.pow(2,t.z);return[(s=(e.x/st+t.x)/n,360*s-180),(r=(e.y/st+t.y)/n,360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90)];var r,s}function bi(e,t){const n=[];for(let r=0;r<e.length;++r)n.push(fa(e[r],t));return n}function lx(e,t,n){const r=n.pointOnLine(t,e).point;return n.distance(e,r)}function Ri(e,t,n,r,s){const l=n.slice(r[0],r[1]+1);let c=1/0;for(let h=t[0];h<=t[1];++h)if(0===(c=Math.min(c,lx(e[h],l,s))))return 0;return c}function _o(e,t,n,r,s){const l=Math.min(s.pointToSegmentDistance(e,n,r),s.pointToSegmentDistance(t,n,r)),c=Math.min(s.pointToSegmentDistance(n,e,t),s.pointToSegmentDistance(r,e,t));return Math.min(l,c)}function Cg(e,t,n,r,s){if(!ua(t,e.length)||!ua(r,n.length))return NaN;let l=1/0;for(let c=t[0];c<t[1];++c)for(let h=r[0];h<r[1];++h){if(Pi(e[c],e[c+1],n[h],n[h+1]))return 0;l=Math.min(l,_o(e[c],e[c+1],n[h],n[h+1],s))}return l}function Of(e,t,n,r,s){if(!ua(t,e.length)||!ua(r,n.length))return NaN;let l=1/0;for(let c=t[0];c<=t[1];++c)for(let h=r[0];h<=r[1];++h)if(0===(l=Math.min(l,s.distance(e[c],n[h]))))return l;return l}function Ff(e,t,n){if(Ko(e,t,!0))return 0;let r=1/0;for(const s of t){const l=s.length;if(l<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(s[0]!==s[l-1]&&0===(r=Math.min(r,n.pointToSegmentDistance(e,s[l-1],s[0])))||0===(r=Math.min(r,lx(e,s,n))))return r}return r}function Jo(e,t,n,r){if(!ua(t,e.length))return NaN;for(let l=t[0];l<=t[1];++l)if(Ko(e[l],n,!0))return 0;let s=1/0;for(let l=t[0];l<t[1];++l)for(const c of n)for(let h=0,f=c.length,p=f-1;h<f;p=h++){if(Pi(e[l],e[l+1],c[p],c[h]))return 0;s=Math.min(s,_o(e[l],e[l+1],c[p],c[h],r))}return s}function cx(e,t){for(const n of e)for(let r=0;r<=n.length-1;++r)if(Ko(n[r],t,!0))return!0;return!1}function cA(e,t,n,r=1/0){const s=rl(e),l=rl(t);if(r!==1/0&&da(s,l,n)>=r)return r;if(Gr(s,l)){if(cx(e,t))return 0}else if(cx(t,e))return 0;let c=r;for(const h of e)for(let f=0,p=h.length,m=p-1;f<p;m=f++)for(const _ of t)for(let y=0,v=_.length,b=v-1;y<v;b=y++){if(Pi(h[m],h[f],_[b],_[y]))return 0;c=Math.min(c,_o(h[m],h[f],_[b],_[y],n))}return c}function zf(e,t,n,r,s,l,c){if(null===l||null===c)return;const h=da(ha(r,l),ha(s,c),n);h<t&&e.push({dist:h,range1:l,range2:c})}function xD(e,t,n,r,s=1/0){let l=Math.min(r.distance(e[0],n[0][0]),s);if(0===l)return l;const c=new Zl([{dist:0,range1:[0,e.length-1],range2:[0,0]}],Ao),h=t?50:100,f=rl(n);for(;c.length;){const p=c.pop();if(p.dist>=l)continue;const m=p.range1;if(kf(m)<=h){if(!ua(m,e.length))return NaN;if(t){const _=Jo(e,m,n,r);if(0===(l=Math.min(l,_)))return l}else for(let _=m[0];_<=m[1];++_){const y=Ff(e[_],n,r);if(0===(l=Math.min(l,y)))return l}}else{const _=ou(m,t);if(null!==_[0]){const y=da(ha(e,_[0]),f,r);y<l&&c.push({dist:y,range1:_[0],range2:[0,0]})}if(null!==_[1]){const y=da(ha(e,_[1]),f,r);y<l&&c.push({dist:y,range1:_[1],range2:[0,0]})}}}return l}function bD(e,t,n,r,s,l=1/0){let c=Math.min(l,s.distance(e[0],n[0]));if(0===c)return c;const h=new Zl([{dist:0,range1:[0,e.length-1],range2:[0,n.length-1]}],Ao),f=t?50:100,p=r?50:100;for(;h.length;){const m=h.pop();if(m.dist>=c)continue;const _=m.range1,y=m.range2;if(kf(_)<=f&&kf(y)<=p){if(!ua(_,e.length)||!ua(y,n.length))return NaN;if(t&&r?c=Math.min(c,Cg(e,_,n,y,s)):t||r?t&&!r?c=Math.min(c,Ri(n,y,e,_,s)):!t&&r&&(c=Math.min(c,Ri(e,_,n,y,s))):c=Math.min(c,Of(e,_,n,y,s)),0===c)return c}else{const v=ou(_,t),b=ou(y,r);zf(h,c,s,e,n,v[0],b[0]),zf(h,c,s,e,n,v[0],b[1]),zf(h,c,s,e,n,v[1],b[0]),zf(h,c,s,e,n,v[1],b[1])}}return c}function ux(e,t,n,r,s=1/0){let l=s;const c=ha(e,[0,e.length-1]);for(const h of n)if(!(l!==1/0&&da(c,ha(h,[0,h.length-1]),r)>=l)&&(l=Math.min(l,bD(e,t,h,!0,r,l)),0===l))return l;return l}function Mg(e,t,n,r,s=1/0){let l=s;const c=ha(e,[0,e.length-1]);for(const h of n){if(l!==1/0&&da(c,rl(h),r)>=l)continue;const f=xD(e,t,h,r,l);if(isNaN(f))return f;if(0===(l=Math.min(l,f)))return l}return l}function hx(e){return"Point"===e||"MultiPoint"===e||"LineString"===e||"MultiLineString"===e||"Polygon"===e||"MultiPolygon"===e}class Nf{constructor(t,n){this.type=Bt,this.geojson=t,this.geometries=n}static parse(t,n){if(2!==t.length)return n.error(`'distance' expression requires either one argument, but found ' ${t.length-1} instead.`);if(Ih(t[1])){const r=t[1];if("FeatureCollection"===r.type){for(let s=0;s<r.features.length;++s)if(hx(r.features[s].geometry.type))return new Nf(r,r.features[s].geometry)}else if("Feature"===r.type){if(hx(r.geometry.type))return new Nf(r,r.geometry)}else if(hx(r.type))return new Nf(r,r)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(t){const n=t.geometry(),r=t.canonicalID();if(null!=n&&null!=r){if("Point"===t.geometryType())return function(s,l,c){const h=[];for(const p of s)for(const m of p)h.push(fa(m,l));const f=new ca(h[0][1],"meters");return"Point"===c.type||"MultiPoint"===c.type||"LineString"===c.type?bD(h,!1,"Point"===c.type?[c.coordinates]:c.coordinates,"LineString"===c.type,f):"MultiLineString"===c.type?ux(h,!1,c.coordinates,f):"Polygon"===c.type||"MultiPolygon"===c.type?Mg(h,!1,"Polygon"===c.type?[c.coordinates]:c.coordinates,f):null}(n,r,this.geometries);if("LineString"===t.geometryType())return function(s,l,c){const h=[];for(const p of s){const m=[];for(const _ of p)m.push(fa(_,l));h.push(m)}const f=new ca(h[0][0][1],"meters");if("Point"===c.type||"MultiPoint"===c.type||"LineString"===c.type)return ux("Point"===c.type?[c.coordinates]:c.coordinates,"LineString"===c.type,h,f);if("MultiLineString"===c.type){let p=1/0;for(let m=0;m<c.coordinates.length;m++){const _=ux(c.coordinates[m],!0,h,f,p);if(isNaN(_))return _;if(0===(p=Math.min(p,_)))return p}return p}if("Polygon"===c.type||"MultiPolygon"===c.type){let p=1/0;for(let m=0;m<h.length;m++){const _=Mg(h[m],!0,"Polygon"===c.type?[c.coordinates]:c.coordinates,f,p);if(isNaN(_))return _;if(0===(p=Math.min(p,_)))return p}return p}return null}(n,r,this.geometries);if("Polygon"===t.geometryType())return function(s,l,c){const h=[];for(const p of function(m,_){const y=m.length;if(y<=1)return[m];const v=[];let b,E;for(let D=0;D<y;D++){const T=to(m[D]);0!==T&&(m[D].area=Math.abs(T),void 0===E&&(E=T<0),E===T<0?(b&&v.push(b),b=[m[D]]):b.push(m[D]))}return b&&v.push(b),v}(s)){const m=[];for(let _=0;_<p.length;++_)m.push(bi(p[_],l));h.push(m)}const f=new ca(h[0][0][0][1],"meters");if("Point"===c.type||"MultiPoint"===c.type||"LineString"===c.type)return Mg("Point"===c.type?[c.coordinates]:c.coordinates,"LineString"===c.type,h,f);if("MultiLineString"===c.type){let p=1/0;for(let m=0;m<c.coordinates.length;m++){const _=Mg(c.coordinates[m],!0,h,f,p);if(isNaN(_))return _;if(0===(p=Math.min(p,_)))return p}return p}return"Polygon"===c.type||"MultiPolygon"===c.type?function(p,m,_){let y=1/0;for(const v of p)for(const b of m){const E=cA(v,b,_,y);if(isNaN(E))return E;if(0===(y=Math.min(y,E)))return y}return y}("Polygon"===c.type?[c.coordinates]:c.coordinates,h,f):null}(n,r,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var dx=Nf;function Bf(e){if(e instanceof Qr&&("get"===e.name&&1===e.args.length||"feature-state"===e.name||"has"===e.name&&1===e.args.length||"properties"===e.name||"geometry-type"===e.name||"id"===e.name||/^filter-/.test(e.name))||e instanceof el||e instanceof dx)return!1;let t=!0;return e.eachChild(n=>{t&&!Bf(n)&&(t=!1)}),t}function Ig(e){if(e instanceof Qr&&"feature-state"===e.name)return!1;let t=!0;return e.eachChild(n=>{t&&!Ig(n)&&(t=!1)}),t}function fx(e){if(e instanceof Qr&&"config"===e.name)return!1;let t=!0;return e.eachChild(n=>{t&&!fx(n)&&(t=!1)}),t}function Ph(e,t){if(e instanceof Qr&&t.indexOf(e.name)>=0)return!1;let n=!0;return e.eachChild(r=>{n&&!Ph(r,t)&&(n=!1)}),n}class px{constructor(t,n){this.type=n.type,this.name=t,this.boundExpression=n}static parse(t,n){if(2!==t.length||"string"!=typeof t[1])return n.error("'var' expression requires exactly one string literal argument.");const r=t[1];return n.scope.has(r)?new px(r,n.scope.get(r)):n.error(`Unknown variable "${r}". Make sure "${r}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var wD=px;class mx{constructor(t,n=[],r,s=new lA,l=[],c){this.registry=t,this.path=n,this.key=n.map(h=>`[${h}]`).join(""),this.scope=s,this.errors=l,this.expectedType=r,this.options=c}parse(t,n,r,s,l={}){return n||r?this.concat(n,r,s)._parse(t,l):this._parse(t,l)}_parse(t,n){function r(s,l,c){return"assert"===c?new Yo(l,[s]):"coerce"===c?new Qi(l,[s]):s}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const s="string"==typeof t[0]?this.registry[t[0]]:void 0;if(s){let l=s.parse(t,this);if(!l)return null;if(this.expectedType){const c=this.expectedType,h=l.type;if("string"!==c.kind&&"number"!==c.kind&&"boolean"!==c.kind&&"object"!==c.kind&&"array"!==c.kind||"value"!==h.kind)if("color"!==c.kind&&"formatted"!==c.kind&&"resolvedImage"!==c.kind||"value"!==h.kind&&"string"!==h.kind){if(this.checkSubtype(c,h))return null}else l=r(l,c,n.typeAnnotation||"coerce");else l=r(l,c,n.typeAnnotation||"assert")}if(!(l instanceof Af)&&"resolvedImage"!==l.type.kind&&jf(l)){const c=new Dg(this.options);try{l=new Af(l.type,l.evaluate(c))}catch(h){return this.error(h.message),null}}return l}return Qi.parse(["to-array",t],this)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,n,r){const s="number"==typeof t?this.path.concat(t):this.path,l=r?this.scope.concat(r):this.scope;return new mx(this.registry,s,n||null,l,this.errors,this.options)}error(t,...n){const r=`${this.key}${n.map(s=>`[${s}]`).join("")}`;this.errors.push(new aa(r,t))}checkSubtype(t,n){const r=Sh(t,n);return r&&this.error(r),r}}var ED=mx;function jf(e){if(e instanceof wD)return jf(e.boundExpression);if(e instanceof Qr&&"error"===e.name||e instanceof Qr&&"config"===e.name||e instanceof Pf||e instanceof el||e instanceof dx)return!1;const t=e instanceof Qi||e instanceof Yo;let n=!0;return e.eachChild(r=>{n=t?n&&jf(r):n&&r instanceof Af}),!!n&&Bf(e)&&Ph(e,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light"])}function su(e,t){const n=e.length-1;let r,s,l=0,c=n,h=0;for(;l<=c;)if(h=Math.floor((l+c)/2),r=e[h],s=e[h+1],r<=t){if(h===n||t<s)return h;l=h+1}else{if(!(r>t))throw new sr("Input is not a number.");c=h-1}return 0}class gx{constructor(t,n,r){this.type=t,this.input=n,this.labels=[],this.outputs=[];for(const[s,l]of r)this.labels.push(s),this.outputs.push(l)}static parse(t,n){if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");const r=n.parse(t[1],1,Bt);if(!r)return null;const s=[];let l=null;n.expectedType&&"value"!==n.expectedType.kind&&(l=n.expectedType);for(let c=1;c<t.length;c+=2){const h=1===c?-1/0:t[c],f=t[c+1],p=c,m=c+1;if("number"!=typeof h)return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',p);if(s.length&&s[s.length-1][0]>=h)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',p);const _=n.parse(f,m,l);if(!_)return null;l=l||_.type,s.push([h,_])}return new gx(l,r,s)}evaluate(t){const n=this.labels,r=this.outputs;if(1===n.length)return r[0].evaluate(t);const s=this.input.evaluate(t);if(s<=n[0])return r[0].evaluate(t);const l=n.length;return s>=n[l-1]?r[l-1].evaluate(t):r[su(n,s)].evaluate(t)}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&t.push(this.labels[n]),t.push(this.outputs[n].serialize());return t}}var _x=gx;function de(e,t,n){return e*(1-n)+t*n}function il(e,t,n){return e.map((r,s)=>de(r,t[s],n))}var Vf=Object.freeze({__proto__:null,array:il,color:function(e,t,n){return new le(de(e.r,t.r,n),de(e.g,t.g,n),de(e.b,t.b,n),de(e.a,t.a,n))},number:de});const yx=4/29,au=6/29,Pg=3*au*au,TD=Math.PI/180,Rg=180/Math.PI;function Lg(e){return e>.008856451679035631?Math.pow(e,1/3):e/Pg+yx}function no(e){return e>au?e*e*e:Pg*(e-yx)}function Rh(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function kg(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function Uf(e){const t=kg(e.r),n=kg(e.g),r=kg(e.b),s=Lg((.4124564*t+.3575761*n+.1804375*r)/.95047),l=Lg((.2126729*t+.7151522*n+.072175*r)/1);return{l:116*l-16,a:500*(s-l),b:200*(l-Lg((.0193339*t+.119192*n+.9503041*r)/1.08883)),alpha:e.a}}function xx(e){let t=(e.l+16)/116,n=isNaN(e.a)?t:t+e.a/500,r=isNaN(e.b)?t:t-e.b/200;return t=1*no(t),n=.95047*no(n),r=1.08883*no(r),new le(Rh(3.2404542*n-1.5371385*t-.4985314*r),Rh(-.969266*n+1.8760108*t+.041556*r),Rh(.0556434*n-.2040259*t+1.0572252*r),e.alpha)}function uA(e,t,n){const r=t-e;return e+n*(r>180||r<-180?r-360*Math.round(r/360):r)}const hr={forward:Uf,reverse:xx,interpolate:function(e,t,n){return{l:de(e.l,t.l,n),a:de(e.a,t.a,n),b:de(e.b,t.b,n),alpha:de(e.alpha,t.alpha,n)}}},Lh={forward:function(e){const{l:t,a:n,b:r}=Uf(e),s=Math.atan2(r,n)*Rg;return{h:s<0?s+360:s,c:Math.sqrt(n*n+r*r),l:t,alpha:e.a}},reverse:function(e){const t=e.h*TD,n=e.c;return xx({l:e.l,a:Math.cos(t)*n,b:Math.sin(t)*n,alpha:e.alpha})},interpolate:function(e,t,n){return{h:uA(e.h,t.h,n),c:de(e.c,t.c,n),l:de(e.l,t.l,n),alpha:de(e.alpha,t.alpha,n)}}};var DD=Object.freeze({__proto__:null,hcl:Lh,lab:hr});class Xl{constructor(t,n,r,s,l){this.type=t,this.operator=n,this.interpolation=r,this.input=s,this.labels=[],this.outputs=[];for(const[c,h]of l)this.labels.push(c),this.outputs.push(h)}static interpolationFactor(t,n,r,s){let l=0;if("exponential"===t.name)l=Li(n,t.base,r,s);else if("linear"===t.name)l=Li(n,1,r,s);else if("cubic-bezier"===t.name){const c=t.controlPoints;l=new xf(c[0],c[1],c[2],c[3]).solve(Li(n,1,r,s))}return l}static parse(t,n){let[r,s,l,...c]=t;if(!Array.isArray(s)||0===s.length)return n.error("Expected an interpolation type expression.",1);if("linear"===s[0])s={name:"linear"};else if("exponential"===s[0]){const p=s[1];if("number"!=typeof p)return n.error("Exponential interpolation requires a numeric base.",1,1);s={name:"exponential",base:p}}else{if("cubic-bezier"!==s[0])return n.error(`Unknown interpolation type ${String(s[0])}`,1,0);{const p=s.slice(1);if(4!==p.length||p.some(m=>"number"!=typeof m||m<0||m>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);s={name:"cubic-bezier",controlPoints:p}}}if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(l=n.parse(l,2,Bt),!l)return null;const h=[];let f=null;"interpolate-hcl"===r||"interpolate-lab"===r?f=Xo:n.expectedType&&"value"!==n.expectedType.kind&&(f=n.expectedType);for(let p=0;p<c.length;p+=2){const m=c[p],_=c[p+1],y=p+3,v=p+4;if("number"!=typeof m)return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',y);if(h.length&&h[h.length-1][0]>=m)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',y);const b=n.parse(_,v,f);if(!b)return null;f=f||b.type,h.push([m,b])}return"number"===f.kind||"color"===f.kind||"array"===f.kind&&"number"===f.itemType.kind&&"number"==typeof f.N?new Xl(f,r,s,l,h):n.error(`Type ${cr(f)} is not interpolatable.`)}evaluate(t){const n=this.labels,r=this.outputs;if(1===n.length)return r[0].evaluate(t);const s=this.input.evaluate(t);if(s<=n[0])return r[0].evaluate(t);const l=n.length;if(s>=n[l-1])return r[l-1].evaluate(t);const c=su(n,s),h=Xl.interpolationFactor(this.interpolation,s,n[c],n[c+1]),f=r[c].evaluate(t),p=r[c+1].evaluate(t);return"interpolate"===this.operator?Vf[this.type.kind.toLowerCase()](f,p,h):"interpolate-hcl"===this.operator?Lh.reverse(Lh.interpolate(Lh.forward(f),Lh.forward(p),h)):hr.reverse(hr.interpolate(hr.forward(f),hr.forward(p),h))}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const n=[this.operator,t,this.input.serialize()];for(let r=0;r<this.labels.length;r++)n.push(this.labels[r],this.outputs[r].serialize());return n}}function Li(e,t,n,r){const s=r-n,l=e-n;return 0===s?0:1===t?l/s:(Math.pow(t,l)-1)/(Math.pow(t,s)-1)}var Cs=Xl;class kh{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expectected at least one argument.");let r=null;const s=n.expectedType;s&&"value"!==s.kind&&(r=s);const l=[];for(const h of t.slice(1)){const f=n.parse(h,1+l.length,r,void 0,{typeAnnotation:"omit"});if(!f)return null;r=r||f.type,l.push(f)}const c=s&&l.some(h=>Sh(s,h.type));return new kh(c?nn:r,l)}evaluate(t){let n,r=null,s=0;for(const l of this.args){if(s++,r=l.evaluate(t),r&&r instanceof Tr&&!r.available&&(n||(n=r),r=null,s===this.args.length))return n;if(null!==r)break}return r}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(n=>{t.push(n.serialize())}),t}}var Yl=kh;class ki{constructor(t,n){this.type=n.type,this.bindings=[].concat(t),this.result=n}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const n of this.bindings)t(n[1]);t(this.result)}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const r=[];for(let l=1;l<t.length-1;l+=2){const c=t[l];if("string"!=typeof c)return n.error(`Expected string, but found ${typeof c} instead.`,l);if(/[^a-zA-Z0-9_]/.test(c))return n.error("Variable names must contain only alphanumeric characters or '_'.",l);const h=n.parse(t[l+1],l+1);if(!h)return null;r.push([c,h])}const s=n.parse(t[t.length-1],t.length-1,n.expectedType,r);return s?new ki(r,s):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[n,r]of this.bindings)t.push(n,r.serialize());return t.push(this.result.serialize()),t}}var bx=ki;class lu{constructor(t,n,r){this.type=t,this.index=n,this.input=r}static parse(t,n){if(3!==t.length)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,Bt),s=n.parse(t[2],2,ci(n.expectedType||nn));return r&&s?new lu(s.type.itemType,r,s):null}evaluate(t){const n=this.index.evaluate(t),r=this.input.evaluate(t);if(n<0)throw new sr(`Array index out of bounds: ${n} < 0.`);if(n>=r.length)throw new sr(`Array index out of bounds: ${n} > ${r.length-1}.`);if(n!==Math.floor(n))throw new sr(`Array index must be an integer, but found ${n} instead.`);return r[n]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var SD=lu;class Ms{constructor(t,n){this.type=re,this.needle=t,this.haystack=n}static parse(t,n){if(3!==t.length)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,nn),s=n.parse(t[2],2,nn);return r&&s?wg(r.type,[re,De,Bt,Jc,nn])?new Ms(r,s):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${cr(r.type)} instead`):null}evaluate(t){const n=this.needle.evaluate(t),r=this.haystack.evaluate(t);if(null==r)return!1;if(!Qc(n,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${cr(Vn(n))} instead.`);if(!Qc(r,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${cr(Vn(r))} instead.`);return r.indexOf(n)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var wx=Ms;class cu{constructor(t,n,r){this.type=Bt,this.needle=t,this.haystack=n,this.fromIndex=r}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,nn),s=n.parse(t[2],2,nn);if(!r||!s)return null;if(!wg(r.type,[re,De,Bt,Jc,nn]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${cr(r.type)} instead`);if(4===t.length){const l=n.parse(t[3],3,Bt);return l?new cu(r,s,l):null}return new cu(r,s)}evaluate(t){const n=this.needle.evaluate(t),r=this.haystack.evaluate(t);if(!Qc(n,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${cr(Vn(n))} instead.`);if(!Qc(r,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${cr(Vn(r))} instead.`);if(this.fromIndex){const s=this.fromIndex.evaluate(t);return r.indexOf(n,s)}return r.indexOf(n)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var Qe=cu;class $f{constructor(t,n,r,s,l,c){this.inputType=t,this.type=n,this.input=r,this.cases=s,this.outputs=l,this.otherwise=c}static parse(t,n){if(t.length<5)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return n.error("Expected an even number of arguments.");let r,s;n.expectedType&&"value"!==n.expectedType.kind&&(s=n.expectedType);const l={},c=[];for(let p=2;p<t.length-1;p+=2){let m=t[p];const _=t[p+1];Array.isArray(m)||(m=[m]);const y=n.concat(p);if(0===m.length)return y.error("Expected at least one branch label.");for(const b of m){if("number"!=typeof b&&"string"!=typeof b)return y.error("Branch labels must be numbers or strings.");if("number"==typeof b&&Math.abs(b)>Number.MAX_SAFE_INTEGER)return y.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof b&&Math.floor(b)!==b)return y.error("Numeric branch labels must be integer values.");if(r){if(y.checkSubtype(r,Vn(b)))return null}else r=Vn(b);if(void 0!==l[String(b)])return y.error("Branch labels must be unique.");l[String(b)]=c.length}const v=n.parse(_,p,s);if(!v)return null;s=s||v.type,c.push(v)}const h=n.parse(t[1],1,nn);if(!h)return null;const f=n.parse(t[t.length-1],t.length-1,s);return f?"value"!==h.type.kind&&n.concat(1).checkSubtype(r,h.type)?null:new $f(r,s,h,l,c,f):null}evaluate(t){const n=this.input.evaluate(t);return(Vn(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),r=[],s={};for(const c of n){const h=s[this.cases[c]];void 0===h?(s[this.cases[c]]=r.length,r.push([this.cases[c],[c]])):r[h][1].push(c)}const l=c=>"number"===this.inputType.kind?Number(c):c;for(const[c,h]of r)t.push(1===h.length?l(h[0]):h.map(l)),t.push(this.outputs[c].serialize());return t.push(this.otherwise.serialize()),t}}var hA=$f;class Og{constructor(t,n,r){this.type=t,this.branches=n,this.otherwise=r}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return n.error("Expected an odd number of arguments.");let r;n.expectedType&&"value"!==n.expectedType.kind&&(r=n.expectedType);const s=[];for(let c=1;c<t.length-1;c+=2){const h=n.parse(t[c],c,re);if(!h)return null;const f=n.parse(t[c+1],c+1,r);if(!f)return null;s.push([h,f]),r=r||f.type}const l=n.parse(t[t.length-1],t.length-1,r);return l?new Og(r,s,l):null}evaluate(t){for(const[n,r]of this.branches)if(n.evaluate(t))return r.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[n,r]of this.branches)t(n),t(r);t(this.otherwise)}outputDefined(){return this.branches.every(([t,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(n=>{t.push(n.serialize())}),t}}var CD=Og;class Hf{constructor(t,n,r,s){this.type=t,this.input=n,this.beginIndex=r,this.endIndex=s}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,nn),s=n.parse(t[2],2,Bt);if(!r||!s)return null;if(!wg(r.type,[ci(nn),De,nn]))return n.error(`Expected first argument to be of type array or string, but found ${cr(r.type)} instead`);if(4===t.length){const l=n.parse(t[3],3,Bt);return l?new Hf(r.type,r,s,l):null}return new Hf(r.type,r,s)}evaluate(t){const n=this.input.evaluate(t),r=this.beginIndex.evaluate(t);if(!Qc(n,["string","array"]))throw new sr(`Expected first argument to be of type array or string, but found ${cr(Vn(n))} instead.`);if(this.endIndex){const s=this.endIndex.evaluate(t);return n.slice(r,s)}return n.slice(r)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var Ex=Hf;function Tx(e,t){return"=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind}function Dx(e,t,n,r){return 0===r.compare(t,n)}function At(e,t,n){const r="=="!==e&&"!="!==e;return class aR{constructor(l,c,h){this.type=re,this.lhs=l,this.rhs=c,this.collator=h,this.hasUntypedArgument="value"===l.type.kind||"value"===c.type.kind}static parse(l,c){if(3!==l.length&&4!==l.length)return c.error("Expected two or three arguments.");const h=l[0];let f=c.parse(l[1],1,nn);if(!f)return null;if(!Tx(h,f.type))return c.concat(1).error(`"${h}" comparisons are not supported for type '${cr(f.type)}'.`);let p=c.parse(l[2],2,nn);if(!p)return null;if(!Tx(h,p.type))return c.concat(2).error(`"${h}" comparisons are not supported for type '${cr(p.type)}'.`);if(f.type.kind!==p.type.kind&&"value"!==f.type.kind&&"value"!==p.type.kind)return c.error(`Cannot compare types '${cr(f.type)}' and '${cr(p.type)}'.`);r&&("value"===f.type.kind&&"value"!==p.type.kind?f=new Yo(p.type,[f]):"value"!==f.type.kind&&"value"===p.type.kind&&(p=new Yo(f.type,[p])));let m=null;if(4===l.length){if("string"!==f.type.kind&&"string"!==p.type.kind&&"value"!==f.type.kind&&"value"!==p.type.kind)return c.error("Cannot use collator to compare non-string types.");if(m=c.parse(l[3],3,Ue),!m)return null}return new aR(f,p,m)}evaluate(l){const c=this.lhs.evaluate(l),h=this.rhs.evaluate(l);if(r&&this.hasUntypedArgument){const f=Vn(c),p=Vn(h);if(f.kind!==p.kind||"string"!==f.kind&&"number"!==f.kind)throw new sr(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${f.kind}, ${p.kind}) instead.`)}if(this.collator&&!r&&this.hasUntypedArgument){const f=Vn(c),p=Vn(h);if("string"!==f.kind||"string"!==p.kind)return t(l,c,h)}return this.collator?n(l,c,h,this.collator.evaluate(l)):t(l,c,h)}eachChild(l){l(this.lhs),l(this.rhs),this.collator&&l(this.collator)}outputDefined(){return!0}serialize(){const l=[e];return this.eachChild(c=>{l.push(c.serialize())}),l}}}const Sn=At("==",function(e,t,n){return t===n},Dx),MD=At("!=",function(e,t,n){return t!==n},function(e,t,n,r){return!Dx(0,t,n,r)}),ID=At("<",function(e,t,n){return t<n},function(e,t,n,r){return r.compare(t,n)<0}),qr=At(">",function(e,t,n){return t>n},function(e,t,n,r){return r.compare(t,n)>0}),Sx=At("<=",function(e,t,n){return t<=n},function(e,t,n,r){return r.compare(t,n)<=0}),Oh=At(">=",function(e,t,n){return t>=n},function(e,t,n,r){return r.compare(t,n)>=0});class Po{constructor(t,n,r,s,l,c){this.type=De,this.number=t,this.locale=n,this.currency=r,this.unit=s,this.minFractionDigits=l,this.maxFractionDigits=c}static parse(t,n){if(3!==t.length)return n.error("Expected two arguments.");const r=n.parse(t[1],1,Bt);if(!r)return null;const s=t[2];if("object"!=typeof s||Array.isArray(s))return n.error("NumberFormat options argument must be an object.");let l=null;if(s.locale&&(l=n.parse(s.locale,1,De),!l))return null;let c=null;if(s.currency&&(c=n.parse(s.currency,1,De),!c))return null;let h=null;if(s.unit&&(h=n.parse(s.unit,1,De),!h))return null;let f=null;if(s["min-fraction-digits"]&&(f=n.parse(s["min-fraction-digits"],1,Bt),!f))return null;let p=null;return s["max-fraction-digits"]&&(p=n.parse(s["max-fraction-digits"],1,Bt),!p)?null:new Po(r,l,c,h,f,p)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class Fh{constructor(t){this.type=Bt,this.input=t}static parse(t,n){if(2!==t.length)return n.error(`Expected 1 argument, but found ${t.length-1} instead.`);const r=n.parse(t[1],1);return r?"array"!==r.type.kind&&"string"!==r.type.kind&&"value"!==r.type.kind?n.error(`Expected argument of type string or array, but found ${cr(r.type)} instead.`):new Fh(r):null}evaluate(t){const n=this.input.evaluate(t);if("string"==typeof n||Array.isArray(n))return n.length;throw new sr(`Expected value to be of type string or array, but found ${cr(Vn(n))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(n=>{t.push(n.serialize())}),t}}function zh(e){return function(){e=1831565813+(e|=0)|0;let t=Math.imul(e^e>>>15,1|e);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const AD={"==":Sn,"!=":MD,">":qr,"<":ID,">=":Oh,"<=":Sx,array:Yo,at:SD,boolean:Yo,case:CD,coalesce:Yl,collator:Pf,format:ql,image:nu,in:wx,"index-of":Qe,interpolate:Cs,"interpolate-hcl":Cs,"interpolate-lab":Cs,length:Fh,let:bx,literal:Af,match:hA,number:Yo,"number-format":Po,object:Yo,slice:Ex,step:_x,string:Yo,"to-boolean":Qi,"to-color":Qi,"to-number":Qi,"to-string":Qi,var:wD,within:el,distance:dx};function Cx(e,[t,n,r,s]){t=t.evaluate(e),n=n.evaluate(e),r=r.evaluate(e);const l=s?s.evaluate(e):1,c=yD(t,n,r,l);if(c)throw new sr(c);return new le(t/255*l,n/255*l,r/255*l,l)}function PD(e,[t,n,r,s]){t=t.evaluate(e),n=n.evaluate(e),r=r.evaluate(e);const l=s?s.evaluate(e):1,c=(m=n,_=r,y=l,"number"==typeof(p=t)&&p>=0&&p<=360?"number"==typeof m&&m>=0&&m<=100&&"number"==typeof _&&_>=0&&_<=100?void 0===y||"number"==typeof y&&y>=0&&y<=1?null:`Invalid hsla value [${[p,m,_,y].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof y?[p,m,_,y]:[p,m,_]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof y?[p,m,_,y]:[p,m,_]).join(", ")}]: 'h' must be between 0 and 360.`);var p,m,_,y;if(c)throw new sr(c);const h=`hsla(${t}, ${n}%, ${r}%, ${l})`,f=le.parse(h);if(!f)throw new sr(`Failed to parse HSLA color: ${h}`);return f}function Fg(e,t){return e in t}function hi(e,t){const n=t[e];return void 0===n?null:n}function Is(e,t,n){n.length&&(t+=`\x1f${n}`);const r=e.getConfig(t);return r?r.evaluate(e):null}function sl(e){return{type:e}}Qr.register(AD,{error:[{kind:"error"},[De],(e,[t])=>{throw new sr(t.evaluate(e))}],typeof:[De,[nn],(e,[t])=>cr(Vn(t.evaluate(e)))],"to-rgba":[ci(Bt,4),[Xo],(e,[t])=>t.evaluate(e).toArray()],rgb:[Xo,[Bt,Bt,Bt],Cx],rgba:[Xo,[Bt,Bt,Bt,Bt],Cx],hsl:[Xo,[Bt,Bt,Bt],PD],hsla:[Xo,[Bt,Bt,Bt,Bt],PD],has:{type:re,overloads:[[[De],(e,[t])=>Fg(t.evaluate(e),e.properties())],[[De,Dh],(e,[t,n])=>Fg(t.evaluate(e),n.evaluate(e))]]},get:{type:nn,overloads:[[[De],(e,[t])=>hi(t.evaluate(e),e.properties())],[[De,Dh],(e,[t,n])=>hi(t.evaluate(e),n.evaluate(e))]]},config:{type:nn,overloads:[[[De],(e,[t])=>Is(e,t.evaluate(e),"")],[[De,De],(e,[t,n])=>Is(e,t.evaluate(e),n.evaluate(e))]]},"feature-state":[nn,[De],(e,[t])=>hi(t.evaluate(e),e.featureState||{})],properties:[Dh,[],e=>e.properties()],"geometry-type":[De,[],e=>e.geometryType()],id:[nn,[],e=>e.id()],zoom:[Bt,[],e=>e.globals.zoom],pitch:[Bt,[],e=>e.globals.pitch||0],"distance-from-center":[Bt,[],e=>e.distanceFromCenter()],"measure-light":[Bt,[De],(e,[t])=>e.measureLight(t.evaluate(e))],"heatmap-density":[Bt,[],e=>e.globals.heatmapDensity||0],"line-progress":[Bt,[],e=>e.globals.lineProgress||0],"raster-value":[Bt,[],e=>e.globals.rasterValue||0],"sky-radial-progress":[Bt,[],e=>e.globals.skyRadialProgress||0],accumulated:[nn,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[Bt,sl(Bt),(e,t)=>{let n=0;for(const r of t)n+=r.evaluate(e);return n}],"*":[Bt,sl(Bt),(e,t)=>{let n=1;for(const r of t)n*=r.evaluate(e);return n}],"-":{type:Bt,overloads:[[[Bt,Bt],(e,[t,n])=>t.evaluate(e)-n.evaluate(e)],[[Bt],(e,[t])=>-t.evaluate(e)]]},"/":[Bt,[Bt,Bt],(e,[t,n])=>t.evaluate(e)/n.evaluate(e)],"%":[Bt,[Bt,Bt],(e,[t,n])=>t.evaluate(e)%n.evaluate(e)],ln2:[Bt,[],()=>Math.LN2],pi:[Bt,[],()=>Math.PI],e:[Bt,[],()=>Math.E],"^":[Bt,[Bt,Bt],(e,[t,n])=>Math.pow(t.evaluate(e),n.evaluate(e))],sqrt:[Bt,[Bt],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[Bt,[Bt],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[Bt,[Bt],(e,[t])=>Math.log(t.evaluate(e))],log2:[Bt,[Bt],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[Bt,[Bt],(e,[t])=>Math.sin(t.evaluate(e))],cos:[Bt,[Bt],(e,[t])=>Math.cos(t.evaluate(e))],tan:[Bt,[Bt],(e,[t])=>Math.tan(t.evaluate(e))],asin:[Bt,[Bt],(e,[t])=>Math.asin(t.evaluate(e))],acos:[Bt,[Bt],(e,[t])=>Math.acos(t.evaluate(e))],atan:[Bt,[Bt],(e,[t])=>Math.atan(t.evaluate(e))],min:[Bt,sl(Bt),(e,t)=>Math.min(...t.map(n=>n.evaluate(e)))],max:[Bt,sl(Bt),(e,t)=>Math.max(...t.map(n=>n.evaluate(e)))],abs:[Bt,[Bt],(e,[t])=>Math.abs(t.evaluate(e))],round:[Bt,[Bt],(e,[t])=>{const n=t.evaluate(e);return n<0?-Math.round(-n):Math.round(n)}],floor:[Bt,[Bt],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[Bt,[Bt],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[re,[De,nn],(e,[t,n])=>e.properties()[t.value]===n.value],"filter-id-==":[re,[nn],(e,[t])=>e.id()===t.value],"filter-type-==":[re,[De],(e,[t])=>e.geometryType()===t.value],"filter-<":[re,[De,nn],(e,[t,n])=>{const r=e.properties()[t.value],s=n.value;return typeof r==typeof s&&r<s}],"filter-id-<":[re,[nn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n<r}],"filter->":[re,[De,nn],(e,[t,n])=>{const r=e.properties()[t.value],s=n.value;return typeof r==typeof s&&r>s}],"filter-id->":[re,[nn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n>r}],"filter-<=":[re,[De,nn],(e,[t,n])=>{const r=e.properties()[t.value],s=n.value;return typeof r==typeof s&&r<=s}],"filter-id-<=":[re,[nn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n<=r}],"filter->=":[re,[De,nn],(e,[t,n])=>{const r=e.properties()[t.value],s=n.value;return typeof r==typeof s&&r>=s}],"filter-id->=":[re,[nn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n>=r}],"filter-has":[re,[nn],(e,[t])=>t.value in e.properties()],"filter-has-id":[re,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[re,[ci(De)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[re,[ci(nn)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[re,[De,ci(nn)],(e,[t,n])=>n.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[re,[De,ci(nn)],(e,[t,n])=>function(r,s,l,c){for(;l<=c;){const h=l+c>>1;if(s[h]===r)return!0;s[h]>r?c=h-1:l=h+1}return!1}(e.properties()[t.value],n.value,0,n.value.length-1)],all:{type:re,overloads:[[[re,re],(e,[t,n])=>t.evaluate(e)&&n.evaluate(e)],[sl(re),(e,t)=>{for(const n of t)if(!n.evaluate(e))return!1;return!0}]]},any:{type:re,overloads:[[[re,re],(e,[t,n])=>t.evaluate(e)||n.evaluate(e)],[sl(re),(e,t)=>{for(const n of t)if(n.evaluate(e))return!0;return!1}]]},"!":[re,[re],(e,[t])=>!t.evaluate(e)],"is-supported-script":[re,[De],(e,[t])=>{const n=e.globals&&e.globals.isSupportedScript;return!n||n(t.evaluate(e))}],upcase:[De,[De],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[De,[De],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[De,sl(nn),(e,t)=>t.map(n=>Un(n.evaluate(e))).join("")],"resolved-locale":[De,[Ue],(e,[t])=>t.evaluate(e).resolvedLocale()],random:[Bt,[Bt,Bt,nn],(e,t)=>{const[n,r,s]=t.map(c=>c.evaluate(e));if(n>r||n===r)return n;let l;if("string"==typeof s)l=function(c){let h=0;if(0===c.length)return h;for(let f=0;f<c.length;f++)h=(h<<5)-h+c.charCodeAt(f),h&=h;return h}(s);else{if("number"!=typeof s)throw new sr(`Invalid seed input: ${s}`);l=s}return n+zh(l)()*(r-n)}]});var As=AD;function Ps(e){return{result:"success",value:e}}function Kl(e){return{result:"error",value:e}}function zg(e,t){return!!e&&!!e.parameters&&e.parameters.indexOf(t)>-1}function Jl(e){return"data-driven"===e["property-type"]}function Mx(e){return zg(e.expression,"measure-light")}function Nh(e){return zg(e.expression,"zoom")}function Bh(e){return!!e.expression&&e.expression.interpolated}function jh(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function Ng(e){return e}function Ix(e,t){const n="color"===t.type,r=e.stops&&"object"==typeof e.stops[0][0],s=r||!(r||void 0!==e.property),l=e.type||(Bh(t)?"exponential":"interval");if(n&&((e=li({},e)).stops&&(e.stops=e.stops.map(p=>[p[0],le.parse(p[1])])),e.default=le.parse(e.default?e.default:t.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!DD[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let c,h,f;if("exponential"===l)c=jg;else if("interval"===l)c=Ax;else if("categorical"===l){c=Bg,h=Object.create(null);for(const p of e.stops)h[p[0]]=p[1];f=typeof e.stops[0][0]}else{if("identity"!==l)throw new Error(`Unknown function type "${l}"`);c=Px}if(r){const p={},m=[];for(let v=0;v<e.stops.length;v++){const b=e.stops[v],E=b[0].zoom;void 0===p[E]&&(p[E]={zoom:E,type:e.type,property:e.property,default:e.default,stops:[]},m.push(E)),p[E].stops.push([b[0].value,b[1]])}const _=[];for(const v of m)_.push([p[v].zoom,Ix(p[v],t)]);const y={name:"linear"};return{kind:"composite",interpolationType:y,interpolationFactor:Cs.interpolationFactor.bind(void 0,y),zoomStops:_.map(v=>v[0]),evaluate:({zoom:v},b)=>jg({stops:_,base:e.base},t,v).evaluate(v,b)}}if(s){const p="exponential"===l?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:p,interpolationFactor:Cs.interpolationFactor.bind(void 0,p),zoomStops:e.stops.map(m=>m[0]),evaluate:({zoom:m})=>c(e,t,m,h,f)}}return{kind:"source",evaluate(p,m){const _=m&&m.properties?m.properties[e.property]:void 0;return void 0===_?uu(e.default,t.default):c(e,t,_,h,f)}}}function uu(e,t,n){return void 0!==e?e:void 0!==t?t:void 0!==n?n:void 0}function Bg(e,t,n,r,s){return uu(typeof n===s?r[n]:void 0,e.default,t.default)}function Ax(e,t,n){if("number"!==Ze(n))return uu(e.default,t.default);const r=e.stops.length;if(1===r||n<=e.stops[0][0])return e.stops[0][1];if(n>=e.stops[r-1][0])return e.stops[r-1][1];const s=su(e.stops.map(l=>l[0]),n);return e.stops[s][1]}function jg(e,t,n){const r=void 0!==e.base?e.base:1;if("number"!==Ze(n))return uu(e.default,t.default);const s=e.stops.length;if(1===s||n<=e.stops[0][0])return e.stops[0][1];if(n>=e.stops[s-1][0])return e.stops[s-1][1];const l=su(e.stops.map(m=>m[0]),n),c=function(m,_,y,v){const b=v-y,E=m-y;return 0===b?0:1===_?E/b:(Math.pow(_,E)-1)/(Math.pow(_,b)-1)}(n,r,e.stops[l][0],e.stops[l+1][0]),h=e.stops[l][1],f=e.stops[l+1][1];let p=Vf[t.type]||Ng;if(e.colorSpace&&"rgb"!==e.colorSpace){const m=DD[e.colorSpace];p=(_,y)=>m.reverse(m.interpolate(m.forward(_),m.forward(y),c))}return"function"==typeof h.evaluate?{evaluate(...m){const _=h.evaluate.apply(void 0,m),y=f.evaluate.apply(void 0,m);if(void 0!==_&&void 0!==y)return p(_,y,c)}}:p(h,f,c)}function Px(e,t,n){return"color"===t.type?n=le.parse(n):"formatted"===t.type?n=kr.fromString(n.toString()):"resolvedImage"===t.type?n=Tr.fromString(n.toString()):Ze(n)===t.type||"enum"===t.type&&t.values[n]||(n=void 0),uu(n,e.default,t.default)}class Gf{constructor(t,n,r){var s;this.expression=t,this._warningHistory={},this._evaluator=new Dg(r),this._defaultValue=n?"color"===(s=n).type&&(jh(s.default)||Array.isArray(s.default))?new le(0,0,0,0):"color"===s.type?le.parse(s.default)||null:void 0===s.default?null:s.default:null,this._enumValues=n&&"enum"===n.type?n.values:null}evaluateWithoutErrorHandling(t,n,r,s,l,c,h,f){return this._evaluator.globals=t,this._evaluator.feature=n,this._evaluator.featureState=r,this._evaluator.canonical=s||null,this._evaluator.availableImages=l||null,this._evaluator.formattedSection=c,this._evaluator.featureTileCoord=h||null,this._evaluator.featureDistanceData=f||null,this.expression.evaluate(this._evaluator)}evaluate(t,n,r,s,l,c,h,f){this._evaluator.globals=t,this._evaluator.feature=n||null,this._evaluator.featureState=r||null,this._evaluator.canonical=s||null,this._evaluator.availableImages=l||null,this._evaluator.formattedSection=c||null,this._evaluator.featureTileCoord=h||null,this._evaluator.featureDistanceData=f||null;try{const p=this.expression.evaluate(this._evaluator);if(null==p||"number"==typeof p&&p!=p)return this._defaultValue;if(this._enumValues&&!(p in this._enumValues))throw new sr(`Expected value to be one of ${Object.keys(this._enumValues).map(m=>JSON.stringify(m)).join(", ")}, but found ${JSON.stringify(p)} instead.`);return p}catch(p){return this._warningHistory[p.message]||(this._warningHistory[p.message]=!0,typeof console<"u"&&console.warn(p.message)),this._defaultValue}}}function hu(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in As}function al(e,t,n){const r=new ED(As,[],t?function(l){const c={color:Xo,string:De,number:Bt,enum:De,boolean:re,formatted:Cf,resolvedImage:Ki};return"array"===l.type?ci(c[l.value]||nn,l.length):c[l.type]}(t):void 0,void 0,void 0,n),s=r.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return s?Ps(new Gf(s,t,n)):Kl(r.errors)}class Vg{constructor(t,n,r){this.kind=t,this._styleExpression=n,this.isLightConstant=r,this.isStateDependent="constant"!==t&&!Ig(n.expression),this.isConfigDependent=!fx(n.expression)}evaluateWithoutErrorHandling(t,n,r,s,l,c){return this._styleExpression.evaluateWithoutErrorHandling(t,n,r,s,l,c)}evaluate(t,n,r,s,l,c){return this._styleExpression.evaluate(t,n,r,s,l,c)}}class Dr{constructor(t,n,r,s,l){this.kind=t,this.zoomStops=r,this._styleExpression=n,this.isStateDependent="camera"!==t&&!Ig(n.expression),this.isLightConstant=l,this.isConfigDependent=!fx(n.expression),this.interpolationType=s}evaluateWithoutErrorHandling(t,n,r,s,l,c){return this._styleExpression.evaluateWithoutErrorHandling(t,n,r,s,l,c)}evaluate(t,n,r,s,l,c){return this._styleExpression.evaluate(t,n,r,s,l,c)}interpolationFactor(t,n,r){return this.interpolationType?Cs.interpolationFactor(this.interpolationType,t,n,r):0}}function Rs(e,t,n){if("error"===(e=al(e,t,n)).result)return e;const r=e.value.expression,s=Bf(r);if(!s&&!Jl(t))return Kl([new aa("","data expressions not supported")]);const l=Ph(r,["zoom","pitch","distance-from-center"]);if(!l&&!Nh(t))return Kl([new aa("","zoom expressions not supported")]);const c=Ph(r,["measure-light"]);if(!c&&!Mx(t))return Kl([new aa("","measure-light expression not supported")]);const h=t.expression&&t.expression.relaxZoomRestriction,f=qf(r);return f||l||h?f instanceof aa?Kl([f]):f instanceof Cs&&!Bh(t)?Kl([new aa("",'"interpolate" expressions cannot be used with this property')]):Ps(f?new Dr(s?"camera":"composite",e.value,f.labels,f instanceof Cs?f.interpolation:void 0,c):new Vg(s?"constant":"source",e.value,c)):Kl([new aa("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class or{constructor(t,n){this._parameters=t,this._specification=n,li(this,Ix(this._parameters,this._specification))}static deserialize(t){return new or(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function qf(e){let t=null;if(e instanceof bx)t=qf(e.result);else if(e instanceof Yl){for(const n of e.args)if(t=qf(n),t)break}else(e instanceof _x||e instanceof Cs)&&e.input instanceof Qr&&"zoom"===e.input.name&&(t=e);return t instanceof aa||e.eachChild(n=>{const r=qf(n);r instanceof aa?t=r:t&&r&&t!==r&&(t=new aa("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function Ro(e){const t=e.key,n=e.value,r=e.valueSpec||{},s=e.objectElementValidators||{},l=e.style,c=e.styleSpec;let h=[];const f=Ze(n);if("object"!==f)return[new Ut(t,n,`object expected, ${f} found`)];for(const p in n){const m=p.split(".")[0];let _;s[m]?_=s[m]:r[m]?_=Jn:s["*"]?_=s["*"]:r["*"]&&(_=Jn),_?h=h.concat(_({key:(t&&`${t}.`)+p,value:n[p],valueSpec:r[m]||r["*"],style:l,styleSpec:c,object:n,objectKey:p},n)):h.push(new Kc(t,n[p],`unknown property "${p}"`))}for(const p in r)s[p]||r[p].required&&void 0===r[p].default&&void 0===n[p]&&h.push(new Ut(t,n,`missing required property "${p}"`));return h}function Rx(e){const t=e.value,n=e.valueSpec,r=e.style,s=e.styleSpec,l=e.key,c=e.arrayElementValidator||Jn;if("array"!==Ze(t))return[new Ut(l,t,`array expected, ${Ze(t)} found`)];if(n.length&&t.length!==n.length)return[new Ut(l,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new Ut(l,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let h={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};s.$version<7&&(h.function=n.function),"object"===Ze(n.value)&&(h=n.value);let f=[];for(let p=0;p<t.length;p++)f=f.concat(c({array:t,arrayIndex:p,value:t[p],valueSpec:h,style:r,styleSpec:s,key:`${l}[${p}]`},!0));return f}function Lx(e){const t=e.key,n=e.value,r=e.valueSpec;let s=Ze(n);if("number"===s&&n!=n&&(s="NaN"),"number"!==s)return[new Ut(t,n,`number expected, ${s} found`)];if("minimum"in r){let l=r.minimum;if("array"===Ze(r.minimum)&&(l=r.minimum[e.arrayIndex]),n<l)return[new Ut(t,n,`${n} is less than the minimum value ${l}`)]}if("maximum"in r){let l=r.maximum;if("array"===Ze(r.maximum)&&(l=r.maximum[e.arrayIndex]),n>l)return[new Ut(t,n,`${n} is greater than the maximum value ${l}`)]}return[]}function kx(e){const t=e.valueSpec,n=Er(e.value.type);let r,s,l,c={};const h="categorical"!==n&&void 0===e.value.property,f=!h,p="array"===Ze(e.value.stops)&&"array"===Ze(e.value.stops[0])&&"object"===Ze(e.value.stops[0][0]),m=Ro({key:e.key,value:e.value,valueSpec:e.styleSpec.function,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{stops:function(v){if("identity"===n)return[new Ut(v.key,v.value,'identity function may not have a "stops" property')];let b=[];const E=v.value;return b=b.concat(Rx({key:v.key,value:E,valueSpec:v.valueSpec,style:v.style,styleSpec:v.styleSpec,arrayElementValidator:_})),"array"===Ze(E)&&0===E.length&&b.push(new Ut(v.key,E,"array must have at least one stop")),b},default:function(v){return Jn({key:v.key,value:v.value,valueSpec:t,style:v.style,styleSpec:v.styleSpec})}}});return"identity"===n&&h&&m.push(new Ut(e.key,e.value,'missing required property "property"')),"identity"===n||e.value.stops||m.push(new Ut(e.key,e.value,'missing required property "stops"')),"exponential"===n&&e.valueSpec.expression&&!Bh(e.valueSpec)&&m.push(new Ut(e.key,e.value,"exponential functions not supported")),e.styleSpec.$version>=8&&(f&&!Jl(e.valueSpec)?m.push(new Ut(e.key,e.value,"property functions not supported")):h&&!Nh(e.valueSpec)&&m.push(new Ut(e.key,e.value,"zoom functions not supported"))),"categorical"!==n&&!p||void 0!==e.value.property||m.push(new Ut(e.key,e.value,'"property" property is required')),m;function _(v){let b=[];const E=v.value,D=v.key;if("array"!==Ze(E))return[new Ut(D,E,`array expected, ${Ze(E)} found`)];if(2!==E.length)return[new Ut(D,E,`array length 2 expected, length ${E.length} found`)];if(p){if("object"!==Ze(E[0]))return[new Ut(D,E,`object expected, ${Ze(E[0])} found`)];if(void 0===E[0].zoom)return[new Ut(D,E,"object stop key must have zoom")];if(void 0===E[0].value)return[new Ut(D,E,"object stop key must have value")];const T=Er(E[0].zoom);if("number"!=typeof T)return[new Ut(D,E[0].zoom,"stop zoom values must be numbers")];if(l&&l>T)return[new Ut(D,E[0].zoom,"stop zoom values must appear in ascending order")];T!==l&&(l=T,s=void 0,c={}),b=b.concat(Ro({key:`${D}[0]`,value:E[0],valueSpec:{zoom:{}},style:v.style,styleSpec:v.styleSpec,objectElementValidators:{zoom:Lx,value:y}}))}else b=b.concat(y({key:`${D}[0]`,value:E[0],valueSpec:{},style:v.style,styleSpec:v.styleSpec},E));return hu(Ja(E[1]))?b.concat([new Ut(`${D}[1]`,E[1],"expressions are not allowed in function stops.")]):b.concat(Jn({key:`${D}[1]`,value:E[1],valueSpec:t,style:v.style,styleSpec:v.styleSpec}))}function y(v,b){const E=Ze(v.value),D=Er(v.value),T=null!==v.value?v.value:b;if(r){if(E!==r)return[new Ut(v.key,T,`${E} stop domain type must match previous stop domain type ${r}`)]}else r=E;if("number"!==E&&"string"!==E&&"boolean"!==E&&"number"!=typeof D&&"string"!=typeof D&&"boolean"!=typeof D)return[new Ut(v.key,T,"stop domain value must be a number, string, or boolean")];if("number"!==E&&"categorical"!==n){let C=`number expected, ${E} found`;return Jl(t)&&void 0===n&&(C+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ut(v.key,T,C)]}return"categorical"!==n||"number"!==E||"number"==typeof D&&isFinite(D)&&Math.floor(D)===D?"categorical"!==n&&"number"===E&&"number"==typeof D&&"number"==typeof s&&void 0!==s&&D<s?[new Ut(v.key,T,"stop domain values must appear in ascending order")]:(s=D,"categorical"===n&&D in c?[new Ut(v.key,T,"stop domain values must be unique")]:(c[D]=!0,[])):[new Ut(v.key,T,`integer expected, found ${String(D)}`)]}}function Ql(e){const t=("property"===e.expressionContext?Rs:al)(Ja(e.value),e.valueSpec);if("error"===t.result)return t.value.map(r=>new Ut(`${e.key}${r.key}`,e.value,r.message));const n=t.value.expression||t.value._styleExpression.expression;if("property"===e.expressionContext&&"text-font"===e.propertyKey&&!n.outputDefined())return[new Ut(e.key,e.value,`Invalid data expression for "${e.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===e.expressionContext&&"layout"===e.propertyType&&!Ig(n))return[new Ut(e.key,e.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===e.expressionContext)return Vh(n,e);if(e.expressionContext&&0===e.expressionContext.indexOf("cluster")){if(!Ph(n,["zoom","feature-state"]))return[new Ut(e.key,e.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===e.expressionContext&&!Bf(n))return[new Ut(e.key,e.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Vh(e,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const s of t.valueSpec.expression.parameters)n.delete(s);if(0===n.size)return[];const r=[];return e instanceof Qr&&n.has(e.name)?[new Ut(t.key,t.value,`["${e.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(e.eachChild(s=>{r.push(...Vh(s,t))}),r)}function tc(e){const t=e.key,n=e.value,r=e.valueSpec,s=[];return Array.isArray(r.values)?-1===r.values.indexOf(Er(n))&&s.push(new Ut(t,n,`expected one of [${r.values.join(", ")}], ${JSON.stringify(n)} found`)):-1===Object.keys(r.values).indexOf(Er(n))&&s.push(new Ut(t,n,`expected one of [${Object.keys(r.values).join(", ")}], ${JSON.stringify(n)} found`)),s}function du(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!du(t)&&"boolean"!=typeof t)return!1;return!0;default:return!0}}function fu(e,t="fill"){if(null==e)return{filter:()=>!0,needGeometry:!1,needFeature:!1};du(e)||(e=ll(e));const n=e;let r=!0;try{r=function(p){if(!yo(p))return p;let m=Ja(p);return Ox(m),m=Ug(m),m}(n)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(n,null,2)}\n        `)}const s=rt[`filter_${t}`],l=al(r,s);let c=null;if("error"===l.result)throw new Error(l.value.map(p=>`${p.key}: ${p.message}`).join(", "));c=(p,m,_)=>l.value.evaluate(p,m,{},_);let h=null,f=null;if(r!==n){const p=al(n,s);if("error"===p.result)throw new Error(p.value.map(m=>`${m.key}: ${m.message}`).join(", "));h=(m,_,y,v,b)=>p.value.evaluate(m,_,{},y,void 0,void 0,v,b),f=!Bf(p.value.expression)}return{filter:c,dynamicFilter:h||void 0,needGeometry:Fx(r),needFeature:!!f}}function Ug(e){if(!Array.isArray(e))return e;const t=function(n){if(Uh.has(n[0]))for(let r=1;r<n.length;r++)if(yo(n[r]))return!0;return n}(e);return!0===t?t:t.map(n=>Ug(n))}function Ox(e){let t=!1;const n=[];if("case"===e[0]){for(let r=1;r<e.length-1;r+=2)t=t||yo(e[r]),n.push(e[r+1]);n.push(e[e.length-1])}else if("match"===e[0]){t=t||yo(e[1]);for(let r=2;r<e.length-1;r+=2)n.push(e[r+1]);n.push(e[e.length-1])}else if("step"===e[0]){t=t||yo(e[1]);for(let r=1;r<e.length-1;r+=2)n.push(e[r+1])}t&&(e.length=0,e.push("any",...n));for(let r=1;r<e.length;r++)Ox(e[r])}function yo(e){if(!Array.isArray(e))return!1;if("pitch"===(t=e[0])||"distance-from-center"===t)return!0;var t;for(let n=1;n<e.length;n++)if(yo(e[n]))return!0;return!1}const Uh=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function RD(e,t){return e<t?-1:e>t?1:0}function Fx(e){if(!Array.isArray(e))return!1;if("within"===e[0]||"distance"===e[0])return!0;for(let t=1;t<e.length;t++)if(Fx(e[t]))return!0;return!1}function ll(e){if(!e)return!0;const t=e[0];return e.length<=1?"any"!==t:"=="===t?$h(e[1],e[2],"=="):"!="===t?$g($h(e[1],e[2],"==")):"<"===t||">"===t||"<="===t||">="===t?$h(e[1],e[2],t):"any"===t?(n=e.slice(1),["any"].concat(n.map(ll))):"all"===t?["all"].concat(e.slice(1).map(ll)):"none"===t?["all"].concat(e.slice(1).map(ll).map($g)):"in"===t?zx(e[1],e.slice(2)):"!in"===t?$g(zx(e[1],e.slice(2))):"has"===t?Nx(e[1]):"!has"!==t||$g(Nx(e[1]));var n}function $h(e,t,n){switch(e){case"$type":return[`filter-type-${n}`,t];case"$id":return[`filter-id-${n}`,t];default:return[`filter-${n}`,e,t]}}function zx(e,t){if(0===t.length)return!1;switch(e){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(n=>typeof n!=typeof t[0])?["filter-in-large",e,["literal",t.sort(RD)]]:["filter-in-small",e,["literal",t]]}}function Nx(e){switch(e){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",e]}}function $g(e){return["!",e]}function Bx(e){return du(Ja(e.value))?Ql(li({},e,{expressionContext:"filter",valueSpec:e.styleSpec[`filter_${e.layerType||"fill"}`]})):Hh(e)}function Hh(e){const t=e.value,n=e.key;if("array"!==Ze(t))return[new Ut(n,t,`array expected, ${Ze(t)} found`)];const r=e.styleSpec;let s,l=[];if(t.length<1)return[new Ut(n,t,"filter array must have at least 1 element")];switch(l=l.concat(tc({key:`${n}[0]`,value:t[0],valueSpec:r.filter_operator,style:e.style,styleSpec:e.styleSpec})),Er(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&"$type"===Er(t[1])&&l.push(new Ut(n,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":3!==t.length&&l.push(new Ut(n,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(s=Ze(t[1]),"string"!==s&&l.push(new Ut(`${n}[1]`,t[1],`string expected, ${s} found`)));for(let c=2;c<t.length;c++)s=Ze(t[c]),"$type"===Er(t[1])?l=l.concat(tc({key:`${n}[${c}]`,value:t[c],valueSpec:r.geometry_type,style:e.style,styleSpec:e.styleSpec})):"string"!==s&&"number"!==s&&"boolean"!==s&&l.push(new Ut(`${n}[${c}]`,t[c],`string, number, or boolean expected, ${s} found`));break;case"any":case"all":case"none":for(let c=1;c<t.length;c++)l=l.concat(Hh({key:`${n}[${c}]`,value:t[c],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":s=Ze(t[1]),2!==t.length?l.push(new Ut(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):"string"!==s&&l.push(new Ut(`${n}[1]`,t[1],`string expected, ${s} found`))}return l}function Hg(e,t){const n=e.key,r=e.style,s=e.layer,l=e.styleSpec,c=e.value,h=e.objectKey,f=l[`${t}_${e.layerType}`];if(!f)return[];const p=h.match(/^(.*)-transition$/);if("paint"===t&&p&&f[p[1]]&&f[p[1]].transition)return Jn({key:n,value:c,valueSpec:l.transition,style:r,styleSpec:l});const m=e.valueSpec||f[h];if(!m)return[new Kc(n,c,`unknown property "${h}"`)];let _;if("string"===Ze(c)&&Jl(m)&&!m.tokens&&(_=/^{([^}]+)}$/.exec(c))){const v=`\`{ "type": "identity", "property": ${_?JSON.stringify(_[1]):'"_"'} }\``;return[new Ut(n,c,`"${h}" does not support interpolation syntax\nUse an identity property function instead: ${v}.`)]}const y=[];if("symbol"===e.layerType)"text-field"!==h||!r||r.glyphs||r.imports||y.push(new Ut(n,c,'use of "text-field" requires a style "glyphs" property')),"text-font"===h&&jh(Ja(c))&&"identity"===Er(c.type)&&y.push(new Ut(n,c,'"text-font" does not support identity functions'));else if("model"===e.layerType&&"paint"===t&&s&&s.layout&&s.layout.hasOwnProperty("model-id")&&Jl(m)&&(Mx(m)||Nh(m))){const v=Rs(Ja(c),m),b=v.value.expression||v.value._styleExpression.expression;b&&!Ph(b,["measure-light"])&&y.push(new Ut(n,c,`${h} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`))}return y.concat(Jn({key:e.key,value:c,valueSpec:m,style:r,styleSpec:l,expressionContext:"property",propertyType:t,propertyKey:h}))}function Gg(e){return Hg(e,"paint")}function Gh(e){return Hg(e,"layout")}function qg(e){let t=[];const n=e.value,r=e.key,s=e.style,l=e.styleSpec;n.type||n.ref||t.push(new Ut(r,n,'either "type" or "ref" is required'));let c=Er(n.type);const h=Er(n.ref);if(n.id){const f=Er(n.id);for(let p=0;p<e.arrayIndex;p++){const m=s.layers[p];Er(m.id)===f&&t.push(new Ut(r,n.id,`duplicate layer id "${n.id}", previously used at line ${m.id.__line__}`))}}if("ref"in n){let f;["type","source","source-layer","filter","layout"].forEach(p=>{p in n&&t.push(new Ut(r,n[p],`"${p}" is prohibited for ref layers`))}),s.layers.forEach(p=>{Er(p.id)===h&&(f=p)}),f?f.ref?t.push(new Ut(r,n.ref,"ref cannot reference another ref layer")):c=Er(f.type):"string"==typeof h&&t.push(new Ut(r,n.ref,`ref layer "${h}" not found`))}else if("background"!==c&&"sky"!==c&&"slot"!==c)if(n.source){const f=s.sources&&s.sources[n.source],p=f&&Er(f.type);f?"vector"===p&&"raster"===c?t.push(new Ut(r,n.source,`layer "${n.id}" requires a raster source`)):"raster"===p&&"raster"!==c?t.push(new Ut(r,n.source,`layer "${n.id}" requires a vector source`)):"vector"!==p||n["source-layer"]?"raster-dem"===p&&"hillshade"!==c?t.push(new Ut(r,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==c||!n.paint||!n.paint["line-gradient"]&&!n.paint["line-trim-offset"]||"geojson"===p&&f.lineMetrics||t.push(new Ut(r,n,`layer "${n.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new Ut(r,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new Ut(r,n.source,`source "${n.source}" not found`))}else t.push(new Ut(r,n,'missing required property "source"'));return t=t.concat(Ro({key:r,value:n,valueSpec:l.layer,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Jn({key:`${r}.type`,value:n.type,valueSpec:l.layer.type,style:e.style,styleSpec:e.styleSpec,object:n,objectKey:"type"}),filter:f=>Bx(li({layerType:c},f)),layout:f=>Ro({layer:n,key:f.key,value:f.value,valueSpec:{},style:f.style,styleSpec:f.styleSpec,objectElementValidators:{"*":p=>Gh(li({layerType:c},p))}}),paint:f=>Ro({layer:n,key:f.key,value:f.value,valueSpec:{},style:f.style,styleSpec:f.styleSpec,objectElementValidators:{"*":p=>Gg(li({layerType:c,layer:n},p))}})}})),t}function ec(e){const t=e.value,n=e.key,r=Ze(t);return"string"!==r?[new Ut(n,t,`string expected, ${r} found`)]:[]}const nc={promoteId:function({key:e,value:t}){if("string"===Ze(t))return ec({key:e,value:t});{const n=[];for(const r in t)n.push(...ec({key:`${e}.${r}`,value:t[r]}));return n}}};function jx(e){const t=e.value,n=e.key,r=e.styleSpec,s=e.style;if(!t.type)return[new Ut(n,t,'"type" is required')];const l=Er(t.type);let c;switch(l){case"vector":case"raster":case"raster-dem":return c=Ro({key:n,value:t,valueSpec:r[`source_${l.replace("-","_")}`],style:e.style,styleSpec:r,objectElementValidators:nc}),c;case"geojson":if(c=Ro({key:n,value:t,valueSpec:r.source_geojson,style:s,styleSpec:r,objectElementValidators:nc}),t.cluster)for(const h in t.clusterProperties){const[f,p]=t.clusterProperties[h],m="string"==typeof f?[f,["accumulated"],["get",h]]:f;c.push(...Ql({key:`${n}.${h}.map`,value:p,expressionContext:"cluster-map"})),c.push(...Ql({key:`${n}.${h}.reduce`,value:m,expressionContext:"cluster-reduce"}))}return c;case"video":return Ro({key:n,value:t,valueSpec:r.source_video,style:s,styleSpec:r});case"image":return Ro({key:n,value:t,valueSpec:r.source_image,style:s,styleSpec:r});case"canvas":return[new Ut(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return tc({key:`${n}.type`,value:t.type,valueSpec:{values:pu(r)},style:s,styleSpec:r})}}function pu(e){return e.source.reduce((t,n)=>{const r=e[n];return"enum"===r.type.type&&(t=t.concat(Object.keys(r.type.values))),t},[])}function Wf(e){const t=e.value;let n=[];if(!t)return n;const r=Ze(t);return"string"!==r?(n=n.concat([new Ut(e.key,t,`string expected, "${r}" found`)]),n):(function(s){const l=-1===s.indexOf("://");try{return new URL(s,l?"http://example.com":void 0),!0}catch{return!1}}(t)||(n=n.concat([new Ut(e.key,t,`invalid url "${t}"`)])),n)}function qh(e){const t=e.value,n=e.styleSpec,r=n.light,s=e.style;let l=[];const c=Ze(t);if(void 0===t)return l;if("object"!==c)return l=l.concat([new Ut("light",t,`object expected, ${c} found`)]),l;for(const h in t){const f=h.match(/^(.*)-transition$/);l=l.concat(f&&r[f[1]]&&r[f[1]].transition?Jn({key:h,value:t[h],valueSpec:n.transition,style:s,styleSpec:n}):r[h]?Jn({key:h,value:t[h],valueSpec:r[h],style:s,styleSpec:n}):[new Ut(h,t[h],`unknown property "${h}"`)])}return l}function LD(e){const t=e.value;let n=[];if(!t)return n;const r=Ze(t);if("object"!==r)return n=n.concat([new Ut("light-3d",t,`object expected, ${r} found`)]),n;const s=e.styleSpec,l=s["light-3d"],c=e.key,h=e.style,f=e.style.lights;for(const _ of["type","id"])if(!(_ in t))return n=n.concat([new Ut("light-3d",t,`missing property ${_} on light`)]),n;if(t.type&&f)for(let _=0;_<e.arrayIndex;_++){const y=Er(t.type),v=f[_];Er(v.type)===y&&n.push(new Ut(c,t.id,`duplicate light type "${t.type}", previously defined at line ${v.id.__line__}`))}const p=`properties_light_${t.type}`;if(!(p in s))return n=n.concat([new Ut("light-3d",t,`Invalid light type ${t.type}`)]),n;const m=s[p];for(const _ in t)if("properties"===_){const y=t[_],v=Ze(y);if("object"!==v)return n=n.concat([new Ut("properties",y,`object expected, ${v} found`)]),n;for(const b in y)n=n.concat(m[b]?Jn({key:b,value:y[b],valueSpec:m[b],style:h,styleSpec:s}):[new Kc(e.key,y[b],`unknown property "${b}"`)])}else{const y=_.match(/^(.*)-transition$/);n=n.concat(y&&l[y[1]]&&l[y[1]].transition?Jn({key:_,value:t[_],valueSpec:s.transition,style:h,styleSpec:s}):l[_]?Jn({key:_,value:t[_],valueSpec:l[_],style:h,styleSpec:s}):[new Kc(_,t[_],`unknown property "${_}"`)])}return n}function Wg(e){const t=e.value,n=e.key,r=e.style,s=e.styleSpec,l=s.terrain;let c=[];const h=Ze(t);if(void 0===t)return c;if("object"!==h)return c=c.concat([new Ut("terrain",t,`object expected, ${h} found`)]),c;for(const f in t){const p=f.match(/^(.*)-transition$/);c=c.concat(p&&l[p[1]]&&l[p[1]].transition?Jn({key:f,value:t[f],valueSpec:s.transition,style:r,styleSpec:s}):l[f]?Jn({key:f,value:t[f],valueSpec:l[f],style:r,styleSpec:s}):[new Kc(f,t[f],`unknown property "${f}"`)])}if(t.source){const f=r.sources&&r.sources[t.source],p=f&&Er(f.type);f?"raster-dem"!==p&&c.push(new Ut(n,t.source,`terrain cannot be used with a source of type ${String(p)}, it only be used with a "raster-dem" source type`)):c.push(new Ut(n,t.source,`source "${t.source}" not found`))}else c.push(new Ut(n,t,'terrain is missing required property "source"'));return c}function Zg(e){const t=e.value,n=e.style,r=e.styleSpec,s=r.fog;let l=[];const c=Ze(t);if(void 0===t)return l;if("object"!==c)return l=l.concat([new Ut("fog",t,`object expected, ${c} found`)]),l;for(const h in t){const f=h.match(/^(.*)-transition$/);l=l.concat(f&&s[f[1]]&&s[f[1]].transition?Jn({key:h,value:t[h],valueSpec:r.transition,style:n,styleSpec:r}):s[h]?Jn({key:h,value:t[h],valueSpec:s[h],style:n,styleSpec:r}):[new Kc(h,t[h],`unknown property "${h}"`)])}return l}const Vx={"*":()=>[],array:Rx,boolean:function(e){const t=e.value,n=e.key,r=Ze(t);return"boolean"!==r?[new Ut(n,t,`boolean expected, ${r} found`)]:[]},number:Lx,color:function(e){const t=e.key,n=e.value,r=Ze(n);return"string"!==r?[new Ut(t,n,`color expected, ${r} found`)]:null===tu(n)?[new Ut(t,n,`color expected, "${n}" found`)]:[]},enum:tc,filter:Bx,function:kx,layer:qg,object:Ro,source:jx,model:Wf,light:qh,"light-3d":LD,terrain:Wg,fog:Zg,string:ec,formatted:function(e){return 0===ec(e).length?[]:Ql(e)},resolvedImage:function(e){return 0===ec(e).length?[]:Ql(e)},projection:function(e){const t=e.value,n=e.styleSpec,r=n.projection,s=e.style;let l=[];const c=Ze(t);if("object"===c)for(const h in t)l=l.concat(Jn({key:h,value:t[h],valueSpec:r[h],style:s,styleSpec:n}));else"string"!==c&&(l=l.concat([new Ut("projection",t,`object or string expected, ${c} found`)]));return l},import:function(e){const{value:t,styleSpec:n}=e,{data:r,...s}=t;Object.defineProperty(s,"__line__",{value:t.__line__,enumerable:!1});let l=Ro(li({},e,{value:s,valueSpec:n.import}));return""===Er(s.id)&&l.push(new Ut(`${e.key}.id`,s,"import id can't be an empty string")),r&&(l=l.concat(mu(r,n,{key:`${e.key}.data`}))),l}};function Jn(e,t=!1){const n=e.value,r=e.valueSpec,s=e.styleSpec;if(r.expression&&jh(Er(n)))return kx(e);if(r.expression&&hu(Ja(n)))return Ql(e);if(r.type&&Vx[r.type]){const l=Vx[r.type](e);return!0===t&&l.length>0&&"array"===Ze(e.value)?Ql(e):l}return Ro(li({},e,{valueSpec:r.type?s[r.type]:r}))}function kD(e){const t=e.value,n=e.key,r=ec(e);return r.length||(-1===t.indexOf("{fontstack}")&&r.push(new Ut(n,t,'"glyphs" url must include a "{fontstack}" token')),-1===t.indexOf("{range}")&&r.push(new Ut(n,t,'"glyphs" url must include a "{range}" token'))),r}function mu(e,t=rt,n={}){return Jn({key:n.key||"",value:e,valueSpec:t.$root,styleSpec:t,style:e,objectElementValidators:{glyphs:kD,"*":()=>[]}})}function cl(e,t=rt){return Oi(mu(e,t))}const Xg=e=>Oi(jx(e)),Zf=e=>Oi(qh(e)),Xf=e=>Oi(LD(e)),OD=e=>Oi(Wg(e)),Ux=e=>Oi(Zg(e)),$x=e=>Oi(qg(e)),Yf=e=>Oi(Bx(e)),Hx=e=>Oi(Gg(e)),FD=e=>Oi(Gh(e)),Kf=e=>Oi(Wf(e));function Oi(e){return e.slice().sort((t,n)=>t.line&&n.line?t.line-n.line:0)}function Jf(e,t){let n=!1;if(t&&t.length)for(const r of t)r instanceof Kc?Y(r.message):(e.fire(new he(new Error(r.message))),n=!0);return n}var Gx=Fi;function Fi(e,t,n){var r=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;var s=new Int32Array(this.arrayBuffer);e=s[0],this.d=(t=s[1])+2*(n=s[2]);for(var l=0;l<this.d*this.d;l++){var c=s[3+l],h=s[3+l+1];r.push(c===h?null:s.subarray(c,h))}var f=s[3+r.length+1];this.keys=s.subarray(s[3+r.length],f),this.bboxes=s.subarray(f),this.insert=this._insertReadonly}else{this.d=t+2*n;for(var p=0;p<this.d*this.d;p++)r.push([]);this.keys=[],this.bboxes=[]}this.n=t,this.extent=e,this.padding=n,this.scale=t/e,this.uid=0;var m=n/t*e;this.min=-m,this.max=e+m}Fi.prototype.insert=function(e,t,n,r,s){this._forEachCell(t,n,r,s,this._insertCell,this.uid++),this.keys.push(e),this.bboxes.push(t),this.bboxes.push(n),this.bboxes.push(r),this.bboxes.push(s)},Fi.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Fi.prototype._insertCell=function(e,t,n,r,s,l){this.cells[s].push(l)},Fi.prototype.query=function(e,t,n,r,s){var l=this.min,c=this.max;if(e<=l&&t<=l&&c<=n&&c<=r&&!s)return Array.prototype.slice.call(this.keys);var h=[];return this._forEachCell(e,t,n,r,this._queryCell,h,{},s),h},Fi.prototype._queryCell=function(e,t,n,r,s,l,c,h){var f=this.cells[s];if(null!==f)for(var p=this.keys,m=this.bboxes,_=0;_<f.length;_++){var y=f[_];if(void 0===c[y]){var v=4*y;(h?h(m[v+0],m[v+1],m[v+2],m[v+3]):e<=m[v+2]&&t<=m[v+3]&&n>=m[v+0]&&r>=m[v+1])?(c[y]=!0,l.push(p[y])):c[y]=!1}}},Fi.prototype._forEachCell=function(e,t,n,r,s,l,c,h){for(var f=this._convertToCellCoord(e),p=this._convertToCellCoord(t),m=this._convertToCellCoord(n),_=this._convertToCellCoord(r),y=f;y<=m;y++)for(var v=p;v<=_;v++){var b=this.d*v+y;if((!h||h(this._convertFromCellCoord(y),this._convertFromCellCoord(v),this._convertFromCellCoord(y+1),this._convertFromCellCoord(v+1)))&&s.call(this,e,t,n,r,b,l,c,h))return}},Fi.prototype._convertFromCellCoord=function(e){return(e-this.padding)/this.scale},Fi.prototype._convertToCellCoord=function(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))},Fi.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var e=this.cells,t=3+this.cells.length+1+1,n=0,r=0;r<this.cells.length;r++)n+=this.cells[r].length;var s=new Int32Array(t+n+this.keys.length+this.bboxes.length);s[0]=this.extent,s[1]=this.n,s[2]=this.padding;for(var l=t,c=0;c<e.length;c++){var h=e[c];s[3+c]=l,s.set(h,l),l+=h.length}return s[3+e.length]=l,s.set(this.keys,l),s[3+e.length+1]=l+=this.keys.length,s.set(this.bboxes,l),l+=this.bboxes.length,s.buffer};var gu=Zi(Gx);const Qf={};function jt(e,t,n={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writeable:!1}),Qf[t]={klass:e,omit:n.omit||[]}}jt(Object,"Object"),gu.serialize=function(e,t){const n=e.toArrayBuffer();return t&&t.add(n),{buffer:n}},gu.deserialize=function(e){return new gu(e.buffer)},Object.defineProperty(gu,"name",{value:"Grid"}),jt(gu,"Grid"),jt(le,"Color"),jt(Error,"Error"),jt(pt,"AJAXError"),jt(Tr,"ResolvedImage"),jt(or,"StylePropertyFunction"),jt(Gf,"StyleExpression",{omit:["_evaluator"]}),jt(Dr,"ZoomDependentExpression"),jt(Vg,"ZoomConstantExpression"),jt(Qr,"CompoundExpression",{omit:["_evaluate"]});for(const e in As)Qf[As[e]._classRegistryKey]||jt(As[e],`Expression${e}`);function qx(e){return e&&typeof ArrayBuffer<"u"&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}function Yg(e){return it.ImageBitmap&&e instanceof it.ImageBitmap}function Ls(e,t){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp)return e;if(qx(e)||Yg(e))return t&&t.add(e),e;if(ArrayBuffer.isView(e)){const n=e;return t&&t.add(n.buffer),n}if(e instanceof it.ImageData)return t&&t.add(e.data.buffer),e;if(Array.isArray(e)){const n=[];for(const r of e)n.push(Ls(r,t));return n}if(e instanceof Map){const n={$name:"Map"};for(const[r,s]of e.entries())n[r]=Ls(s);return n}if("object"==typeof e){const n=e.constructor,r=n._classRegistryKey;if(!r)throw new Error(`can't serialize object of unregistered class ${r}`);const s=n.serialize?n.serialize(e,t):{};if(!n.serialize){for(const l in e)e.hasOwnProperty(l)&&(Qf[r].omit.indexOf(l)>=0||(s[l]=Ls(e[l],t)));e instanceof Error&&(s.message=e.message)}if(s.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==r&&(s.$name=r),s}throw new Error("can't serialize object of type "+typeof e)}function Qo(e){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||qx(e)||Yg(e)||ArrayBuffer.isView(e)||e instanceof it.ImageData)return e;if(Array.isArray(e))return e.map(Qo);if("object"==typeof e){const t=e.$name||"Object";if("Map"===t){const s=new Map;for(const l of Object.keys(e))"$name"!==l&&s.set(l,Qo(e[l]));return s}const{klass:n}=Qf[t];if(!n)throw new Error(`can't deserialize unregistered class ${t}`);if(n.deserialize)return n.deserialize(e);const r=Object.create(n.prototype);for(const s of Object.keys(e))"$name"!==s&&(r[s]=Qo(e[s]));return r}throw new Error("can't deserialize object of type "+typeof e)}const Ht_Latin_1_Supplement=e=>e>=128&&e<=255,Ht_Arabic=e=>e>=1536&&e<=1791,Ht_Arabic_Supplement=e=>e>=1872&&e<=1919,Ht_Arabic_Extended_A=e=>e>=2208&&e<=2303,Ht_Hangul_Jamo=e=>e>=4352&&e<=4607,Ht_Unified_Canadian_Aboriginal_Syllabics=e=>e>=5120&&e<=5759,Ht_Khmer=e=>e>=6016&&e<=6143,Ht_Unified_Canadian_Aboriginal_Syllabics_Extended=e=>e>=6320&&e<=6399,Ht_General_Punctuation=e=>e>=8192&&e<=8303,Ht_Letterlike_Symbols=e=>e>=8448&&e<=8527,Ht_Number_Forms=e=>e>=8528&&e<=8591,Ht_Miscellaneous_Technical=e=>e>=8960&&e<=9215,Ht_Control_Pictures=e=>e>=9216&&e<=9279,Ht_Optical_Character_Recognition=e=>e>=9280&&e<=9311,Ht_Enclosed_Alphanumerics=e=>e>=9312&&e<=9471,Ht_Geometric_Shapes=e=>e>=9632&&e<=9727,Ht_Miscellaneous_Symbols=e=>e>=9728&&e<=9983,Ht_Miscellaneous_Symbols_and_Arrows=e=>e>=11008&&e<=11263,Ht_CJK_Radicals_Supplement=e=>e>=11904&&e<=12031,Ht_Kangxi_Radicals=e=>e>=12032&&e<=12255,Ht_Ideographic_Description_Characters=e=>e>=12272&&e<=12287,Ht_CJK_Symbols_and_Punctuation=e=>e>=12288&&e<=12351,Ht_Hiragana=e=>e>=12352&&e<=12447,Ht_Katakana=e=>e>=12448&&e<=12543,Ht_Bopomofo=e=>e>=12544&&e<=12591,Ht_Hangul_Compatibility_Jamo=e=>e>=12592&&e<=12687,Ht_Kanbun=e=>e>=12688&&e<=12703,Ht_Bopomofo_Extended=e=>e>=12704&&e<=12735,Ht_CJK_Strokes=e=>e>=12736&&e<=12783,Ht_Katakana_Phonetic_Extensions=e=>e>=12784&&e<=12799,Ht_Enclosed_CJK_Letters_and_Months=e=>e>=12800&&e<=13055,Ht_CJK_Compatibility=e=>e>=13056&&e<=13311,Ht_CJK_Unified_Ideographs_Extension_A=e=>e>=13312&&e<=19903,Ht_Yijing_Hexagram_Symbols=e=>e>=19904&&e<=19967,Ht_CJK_Unified_Ideographs=e=>e>=19968&&e<=40959,Ht_Yi_Syllables=e=>e>=40960&&e<=42127,Ht_Yi_Radicals=e=>e>=42128&&e<=42191,Ht_Hangul_Jamo_Extended_A=e=>e>=43360&&e<=43391,Ht_Hangul_Syllables=e=>e>=44032&&e<=55215,Ht_Hangul_Jamo_Extended_B=e=>e>=55216&&e<=55295,Ht_Private_Use_Area=e=>e>=57344&&e<=63743,Ht_CJK_Compatibility_Ideographs=e=>e>=63744&&e<=64255,Ht_Arabic_Presentation_Forms_A=e=>e>=64336&&e<=65023,Ht_Vertical_Forms=e=>e>=65040&&e<=65055,Ht_CJK_Compatibility_Forms=e=>e>=65072&&e<=65103,Ht_Small_Form_Variants=e=>e>=65104&&e<=65135,Ht_Arabic_Presentation_Forms_B=e=>e>=65136&&e<=65279,Ht_Halfwidth_and_Fullwidth_Forms=e=>e>=65280&&e<=65519,Ht_CJK_Unified_Ideographs_Extension_B=e=>e>=131072&&e<=173791;function ul(e){for(const t of e)if(hl(t.charCodeAt(0)))return!0;return!1}function Wx(e){for(const t of e)if(!Kg(t.charCodeAt(0)))return!1;return!0}function Kg(e){return!(Ht_Arabic(e)||Ht_Arabic_Supplement(e)||Ht_Arabic_Extended_A(e)||Ht_Arabic_Presentation_Forms_A(e)||Ht_Arabic_Presentation_Forms_B(e))}function hl(e){return!(746!==e&&747!==e&&(e<4352||!(Ht_Bopomofo_Extended(e)||Ht_Bopomofo(e)||Ht_CJK_Compatibility_Forms(e)&&!(e>=65097&&e<=65103)||Ht_CJK_Compatibility_Ideographs(e)||Ht_CJK_Compatibility(e)||Ht_CJK_Radicals_Supplement(e)||Ht_CJK_Strokes(e)||!(!Ht_CJK_Symbols_and_Punctuation(e)||e>=12296&&e<=12305||e>=12308&&e<=12319||12336===e)||Ht_CJK_Unified_Ideographs_Extension_A(e)||Ht_CJK_Unified_Ideographs(e)||Ht_Enclosed_CJK_Letters_and_Months(e)||Ht_Hangul_Compatibility_Jamo(e)||Ht_Hangul_Jamo_Extended_A(e)||Ht_Hangul_Jamo_Extended_B(e)||Ht_Hangul_Jamo(e)||Ht_Hangul_Syllables(e)||Ht_Hiragana(e)||Ht_Ideographic_Description_Characters(e)||Ht_Kanbun(e)||Ht_Kangxi_Radicals(e)||Ht_Katakana_Phonetic_Extensions(e)||Ht_Katakana(e)&&12540!==e||!(!Ht_Halfwidth_and_Fullwidth_Forms(e)||65288===e||65289===e||65293===e||e>=65306&&e<=65310||65339===e||65341===e||65343===e||e>=65371&&e<=65503||65507===e||e>=65512&&e<=65519)||!(!Ht_Small_Form_Variants(e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||Ht_Unified_Canadian_Aboriginal_Syllabics(e)||Ht_Unified_Canadian_Aboriginal_Syllabics_Extended(e)||Ht_Vertical_Forms(e)||Ht_Yijing_Hexagram_Symbols(e)||Ht_Yi_Syllables(e)||Ht_Yi_Radicals(e))))}function zD(e){return!(hl(e)||(t=e,Ht_Latin_1_Supplement(t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||Ht_General_Punctuation(t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||Ht_Letterlike_Symbols(t)||Ht_Number_Forms(t)||Ht_Miscellaneous_Technical(t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||Ht_Control_Pictures(t)&&9251!==t||Ht_Optical_Character_Recognition(t)||Ht_Enclosed_Alphanumerics(t)||Ht_Geometric_Shapes(t)||Ht_Miscellaneous_Symbols(t)&&!(t>=9754&&t<=9759)||Ht_Miscellaneous_Symbols_and_Arrows(t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Ht_CJK_Symbols_and_Punctuation(t)||Ht_Katakana(t)||Ht_Private_Use_Area(t)||Ht_CJK_Compatibility_Forms(t)||Ht_Small_Form_Variants(t)||Ht_Halfwidth_and_Fullwidth_Forms(t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t));var t}function Zx(e){return e>=1424&&e<=2303||Ht_Arabic_Presentation_Forms_A(e)||Ht_Arabic_Presentation_Forms_B(e)}function $e(e,t){return!(!t&&Zx(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||Ht_Khmer(e))}function dA(e){for(const t of e)if(Zx(t.charCodeAt(0)))return!0;return!1}const Xx="deferred",Yx="loading",Kx="loaded";let Jx=null,vo="unavailable",rc=null;const _u=function(e){e&&"string"==typeof e&&e.indexOf("NetworkError")>-1&&(vo="error"),Jx&&Jx(e)};function Qx(){t1.fire(new xt("pluginStateChange",{pluginStatus:vo,pluginURL:rc}))}const t1=new xn,Or=function(){return vo},tp=function(){if(vo!==Xx||!rc)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");vo=Yx,Qx(),rc&&Pt({url:rc},e=>{e?_u(e):(vo=Kx,Qx())})},wi={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>vo===Kx||null!=wi.applyArabicShaping,isLoading:()=>vo===Yx,setState(e){vo=e.pluginStatus,rc=e.pluginURL},isParsed:()=>null!=wi.applyArabicShaping&&null!=wi.processBidirectionalText&&null!=wi.processStyledBidirectionalText,getPluginURL:()=>rc};class Gn{constructor(t,n){this.zoom=t,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(t){return function(n,r){for(const s of n)if(!$e(s.charCodeAt(0),r))return!1;return!0}(t,wi.isLoaded())}}class ep{constructor(t,n,r){this.property=t,this.value=n,this.expression=function(s,l,c){if(jh(s))return new or(s,l);if(hu(s)||Array.isArray(s)&&s.length>0){const h=Rs(s,l,c);if("error"===h.result)throw new Error(h.value.map(f=>`${f.key}: ${f.message}`).join(", "));return h.value}{let h=s;return"string"==typeof s&&"color"===l.type&&(h=le.parse(s)),{kind:"constant",isConfigDependent:!1,evaluate:()=>h}}}(void 0===n?t.specification.default:n,t.specification,r)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(t,n,r){return this.property.possiblyEvaluate(this,t,n,r)}}class zi{constructor(t,n){this.property=t,this.value=new ep(t,void 0,n)}transitioned(t,n){return new Jg(this.property,this.value,n,Vt({},t.transition,this.transition),t.now)}untransitioned(){return new Jg(this.property,this.value,null,{},0)}}class xo{constructor(t,n){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues),this._options=n,this.isConfigDependent=!1}getValue(t){return U(this._values[t].value.value)}setValue(t,n){this._values.hasOwnProperty(t)||(this._values[t]=new zi(this._values[t].property,this._options)),this._values[t].value=new ep(this._values[t].property,null===n?void 0:U(n),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].value.expression.isConfigDependent}setTransitionOrValue(t,n){n&&(this._options=n);const r=this._properties.properties;if(t)for(const s in t){const l=t[s];if(Wa(s,"-transition")){const c=s.slice(0,-11);r[c]&&this.setTransition(c,l)}else r[s]&&this.setValue(s,l)}}getTransition(t){return U(this._values[t].transition)}setTransition(t,n){this._values.hasOwnProperty(t)||(this._values[t]=new zi(this._values[t].property)),this._values[t].transition=U(n)||void 0}serialize(){const t={};for(const n of Object.keys(this._values)){const r=this.getValue(n);void 0!==r&&(t[n]=r);const s=this.getTransition(n);void 0!==s&&(t[`${n}-transition`]=s)}return t}transitioned(t,n){const r=new Wh(this._properties);for(const s of Object.keys(this._values))r._values[s]=this._values[s].transitioned(t,n._values[s]);return r}untransitioned(){const t=new Wh(this._properties);for(const n of Object.keys(this._values))t._values[n]=this._values[n].untransitioned();return t}}class Jg{constructor(t,n,r,s,l){const c=s.delay||0,h=s.duration||0;l=l||0,this.property=t,this.value=n,this.begin=l+c,this.end=this.begin+h,t.specification.transition&&(s.delay||s.duration)&&(this.prior=r)}possiblyEvaluate(t,n,r){const s=t.now||0,l=this.value.possiblyEvaluate(t,n,r),c=this.prior;if(c){if(s>this.end)return this.prior=null,l;if(this.value.isDataDriven())return this.prior=null,l;if(s<this.begin)return c.possiblyEvaluate(t,n,r);{const h=(s-this.begin)/(this.end-this.begin);return this.property.interpolate(c.possiblyEvaluate(t,n,r),l,Ga(h))}}return l}}class Wh{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,n,r){const s=new Xh(this._properties);for(const l of Object.keys(this._values))s._values[l]=this._values[l].possiblyEvaluate(t,n,r);return s}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class Zh{constructor(t,n){this._properties=t,this._values=Object.create(t.defaultPropertyValues),this._options=n,this.isConfigDependent=!1}getValue(t){return U(this._values[t].value)}setValue(t,n){this._values[t]=new ep(this._values[t].property,null===n?void 0:U(n),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].expression.isConfigDependent}serialize(){const t={};for(const n of Object.keys(this._values)){const r=this.getValue(n);void 0!==r&&(t[n]=r)}return t}possiblyEvaluate(t,n,r){const s=new Xh(this._properties);for(const l of Object.keys(this._values))s._values[l]=this._values[l].possiblyEvaluate(t,n,r);return s}}class ic{constructor(t,n,r){this.property=t,this.value=n,this.parameters=r}isConstant(){return"constant"===this.value.kind}constantOr(t){return"constant"===this.value.kind?this.value.value:t}evaluate(t,n,r,s){return this.property.evaluate(this.value,this.parameters,t,n,r,s)}}class Xh{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class wt{constructor(t){this.specification=t}possiblyEvaluate(t,n){return t.expression.evaluate(n)}interpolate(t,n,r){const s=Vf[this.specification.type];return s?s(t,n,r):t}}class Kt{constructor(t,n){this.specification=t,this.overrides=n}possiblyEvaluate(t,n,r,s){return new ic(this,"constant"===t.expression.kind||"camera"===t.expression.kind?{kind:"constant",value:t.expression.evaluate(n,null,{},r,s)}:t.expression,n)}interpolate(t,n,r){if("constant"!==t.value.kind||"constant"!==n.value.kind)return t;if(void 0===t.value.value||void 0===n.value.value)return new ic(this,{kind:"constant",value:void 0},t.parameters);const s=Vf[this.specification.type];return s?new ic(this,{kind:"constant",value:s(t.value.value,n.value.value,r)},t.parameters):t}evaluate(t,n,r,s,l,c){return"constant"===t.kind?t.value:t.evaluate(n,r,s,l,c)}}class np{constructor(t){this.specification=t}possiblyEvaluate(t,n,r,s){return!!t.expression.evaluate(n,null,{},r,s)}interpolate(){return!1}}class qn{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const n=new Gn(0,{});for(const r in t){const s=t[r];s.specification.overridable&&this.overridableProperties.push(r);const l=this.defaultPropertyValues[r]=new ep(s,void 0),c=this.defaultTransitionablePropertyValues[r]=new zi(s);this.defaultTransitioningPropertyValues[r]=c.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=l.possiblyEvaluate(n)}}}function Wn(e,t){return t?`${e}\x1f${t}`:e}function Yh(e){const t=e.indexOf("\x1f");return t>=0?e.slice(0,t):e}jt(Kt,"DataDrivenProperty"),jt(wt,"DataConstantProperty"),jt(np,"ColorRampProperty");const oc="-transition";class Lo extends xn{constructor(t,n,r){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,"custom"!==t.type&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,"background"!==t.type&&"sky"!==t.type&&"slot"!==t.type&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),this.options=r,t.slot&&(this.slot=t.slot),n.layout&&(this._unevaluatedLayout=new Zh(n.layout,r),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),n.paint)){this._transitionablePaint=new xo(n.paint,r);for(const s in t.paint)this.setPaintProperty(s,t.paint[s],{validate:!1});for(const s in t.layout)this.setLayoutProperty(s,t.layout[s],{validate:!1});this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Xh(n.paint)}}setScope(t){this.scope=t,this.fqid=Wn(this.id,t)}getLayoutProperty(t){return"visibility"===t?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,n,r={}){if(null!=n&&this._validate(FD,`layers.${this.id}.layout.${t}`,t,n,r))return;if("custom"===this.type&&"visibility"===t)return void(this.visibility=n);const s=this._unevaluatedLayout;s._properties.properties[t]&&(s.setValue(t,n),this.isConfigDependent=this.isConfigDependent||s.isConfigDependent,"visibility"===t&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(t){return Wa(t,oc)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,n,r={}){if(null!=n&&this._validate(Hx,`layers.${this.id}.paint.${t}`,t,n,r))return!1;const s=this._transitionablePaint,l=s._properties.properties;if(Wa(t,oc)){const y=t.slice(0,-11);return l[y]&&s.setTransition(y,n||void 0),!1}if(!l[t])return!1;const c=s._values[t],h=c.value.isDataDriven(),f=c.value;s.setValue(t,n),this.isConfigDependent=this.isConfigDependent||s.isConfigDependent,this._handleSpecialPaintPropertyUpdate(t);const p=s._values[t].value,m=p.isDataDriven(),_=Wa(t,"pattern")||"line-dasharray"===t;return m||h||_||this._handleOverridablePaintPropertyUpdate(t,f,p)}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getDefaultProgramParams(t,n){return null}_handleOverridablePaintPropertyUpdate(t,n,r){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||"none"===this.visibility}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,n)}serialize(){return Tt({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(t,n)=>!(void 0===t||"layout"===n&&!Object.keys(t).length||"paint"===n&&!Object.keys(t).length))}_validate(t,n,r,s,l={}){return(!l||!1!==l.validate)&&Jf(this,t.call(cl,{key:n,layerType:this.type,objectKey:r,value:s,styleSpec:rt,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}resize(){}isStateDependent(){for(const t in this.paint._values){const n=this.paint.get(t);if(n instanceof ic&&Jl(n.property.specification)&&("source"===n.value.kind||"composite"===n.value.kind)&&n.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=fu(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}class e1{constructor(){this.changed=!1,this._updatedLayers={},this._removedLayers={},this.updatedSourceCaches={},this.updatedPaintProps=new Set,this.changedImages=new Set}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id)}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this.updatedPaintProps.delete(t.fqid)}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}reset(){this.changed=!1,this._updatedLayers={},this._removedLayers={},this.updatedSourceCaches={},this.updatedPaintProps.clear(),this.changedImages.clear()}}const ND={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class rp{constructor(t,n){this._structArray=t,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class $n{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,n){return t._trim(),n&&(t.isTransferred=!0,n.add(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const n=Object.create(this.prototype);return n.arrayBuffer=t.arrayBuffer,n.length=t.length,n.capacity=t.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function sn(e,t=1){let n=0,r=0;return{members:e.map(s=>{const l=ND[s.type].BYTES_PER_ELEMENT,c=n=n1(n,Math.max(t,l)),h=s.components||1;return r=Math.max(r,l),n+=l*h,{name:s.name,type:s.type,components:h,offset:c}}),size:n1(n,Math.max(r,t)),alignment:t}}function n1(e,t){return Math.ceil(e/t)*t}class ro extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,n)}emplace(t,n,r){const s=2*t;return this.int16[s+0]=n,this.int16[s+1]=r,t}}ro.prototype.bytesPerElement=4,jt(ro,"StructArrayLayout2i4");class yu extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r)}emplace(t,n,r,s){const l=3*t;return this.int16[l+0]=n,this.int16[l+1]=r,this.int16[l+2]=s,t}}yu.prototype.bytesPerElement=6,jt(yu,"StructArrayLayout3i6");class ks extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,s){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,r,s)}emplace(t,n,r,s,l){const c=4*t;return this.int16[c+0]=n,this.int16[c+1]=r,this.int16[c+2]=s,this.int16[c+3]=l,t}}ks.prototype.bytesPerElement=8,jt(ks,"StructArrayLayout4i8");class r1 extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,s,l)}emplace(t,n,r,s,l,c){const h=5*t;return this.int16[h+0]=n,this.int16[h+1]=r,this.int16[h+2]=s,this.int16[h+3]=l,this.int16[h+4]=c,t}}r1.prototype.bytesPerElement=10,jt(r1,"StructArrayLayout5i10");class sc extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h){const f=this.length;return this.resize(f+1),this.emplace(f,t,n,r,s,l,c,h)}emplace(t,n,r,s,l,c,h,f){const p=6*t,m=12*t,_=3*t;return this.int16[p+0]=n,this.int16[p+1]=r,this.uint8[m+4]=s,this.uint8[m+5]=l,this.uint8[m+6]=c,this.uint8[m+7]=h,this.float32[_+2]=f,t}}sc.prototype.bytesPerElement=12,jt(sc,"StructArrayLayout2i4ub1f12");class Os extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,r,s)}emplace(t,n,r,s,l){const c=4*t;return this.float32[c+0]=n,this.float32[c+1]=r,this.float32[c+2]=s,this.float32[c+3]=l,t}}Os.prototype.bytesPerElement=16,jt(Os,"StructArrayLayout4f16");class ts extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,s,l)}emplace(t,n,r,s,l,c){const h=6*t,f=3*t;return this.uint16[h+0]=n,this.uint16[h+1]=r,this.uint16[h+2]=s,this.uint16[h+3]=l,this.float32[f+2]=c,t}}ts.prototype.bytesPerElement=12,jt(ts,"StructArrayLayout4ui1f12");class ip extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,s){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,r,s)}emplace(t,n,r,s,l){const c=4*t;return this.uint16[c+0]=n,this.uint16[c+1]=r,this.uint16[c+2]=s,this.uint16[c+3]=l,t}}ip.prototype.bytesPerElement=8,jt(ip,"StructArrayLayout4ui8");class op extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,t,n,r,s,l,c)}emplace(t,n,r,s,l,c,h){const f=6*t;return this.int16[f+0]=n,this.int16[f+1]=r,this.int16[f+2]=s,this.int16[f+3]=l,this.int16[f+4]=c,this.int16[f+5]=h,t}}op.prototype.bytesPerElement=12,jt(op,"StructArrayLayout6i12");class Qg extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h,f,p,m,_,y){const v=this.length;return this.resize(v+1),this.emplace(v,t,n,r,s,l,c,h,f,p,m,_,y)}emplace(t,n,r,s,l,c,h,f,p,m,_,y,v){const b=12*t;return this.int16[b+0]=n,this.int16[b+1]=r,this.int16[b+2]=s,this.int16[b+3]=l,this.uint16[b+4]=c,this.uint16[b+5]=h,this.uint16[b+6]=f,this.uint16[b+7]=p,this.int16[b+8]=m,this.int16[b+9]=_,this.int16[b+10]=y,this.int16[b+11]=v,t}}Qg.prototype.bytesPerElement=24,jt(Qg,"StructArrayLayout4i4ui4i24");class sp extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,t,n,r,s,l,c)}emplace(t,n,r,s,l,c,h){const f=10*t,p=5*t;return this.int16[f+0]=n,this.int16[f+1]=r,this.int16[f+2]=s,this.float32[p+2]=l,this.float32[p+3]=c,this.float32[p+4]=h,t}}sp.prototype.bytesPerElement=20,jt(sp,"StructArrayLayout3i3f20");class ac extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint32[1*t+0]=n,t}}ac.prototype.bytesPerElement=4,jt(ac,"StructArrayLayout1ul4");class bo extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,n)}emplace(t,n,r){const s=2*t;return this.uint16[s+0]=n,this.uint16[s+1]=r,t}}bo.prototype.bytesPerElement=4,jt(bo,"StructArrayLayout2ui4");class t_ extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h,f,p,m,_,y,v){const b=this.length;return this.resize(b+1),this.emplace(b,t,n,r,s,l,c,h,f,p,m,_,y,v)}emplace(t,n,r,s,l,c,h,f,p,m,_,y,v,b){const E=20*t,D=10*t;return this.int16[E+0]=n,this.int16[E+1]=r,this.int16[E+2]=s,this.int16[E+3]=l,this.int16[E+4]=c,this.float32[D+3]=h,this.float32[D+4]=f,this.float32[D+5]=p,this.float32[D+6]=m,this.int16[E+14]=_,this.uint32[D+8]=y,this.uint16[E+18]=v,this.uint16[E+19]=b,t}}t_.prototype.bytesPerElement=40,jt(t_,"StructArrayLayout5i4f1i1ul2ui40");class fe extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h){const f=this.length;return this.resize(f+1),this.emplace(f,t,n,r,s,l,c,h)}emplace(t,n,r,s,l,c,h,f){const p=8*t;return this.int16[p+0]=n,this.int16[p+1]=r,this.int16[p+2]=s,this.int16[p+4]=l,this.int16[p+5]=c,this.int16[p+6]=h,this.int16[p+7]=f,t}}fe.prototype.bytesPerElement=16,jt(fe,"StructArrayLayout3i2i2i16");class ap extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,s,l)}emplace(t,n,r,s,l,c){const h=4*t,f=8*t;return this.float32[h+0]=n,this.float32[h+1]=r,this.float32[h+2]=s,this.int16[f+6]=l,this.int16[f+7]=c,t}}ap.prototype.bytesPerElement=16,jt(ap,"StructArrayLayout2f1f2i16");class yr extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,r,s)}emplace(t,n,r,s,l){const c=12*t,h=3*t;return this.uint8[c+0]=n,this.uint8[c+1]=r,this.float32[h+1]=s,this.float32[h+2]=l,t}}yr.prototype.bytesPerElement=12,jt(yr,"StructArrayLayout2ub2f12");class Fs extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r)}emplace(t,n,r,s){const l=3*t;return this.float32[l+0]=n,this.float32[l+1]=r,this.float32[l+2]=s,t}}Fs.prototype.bytesPerElement=12,jt(Fs,"StructArrayLayout3f12");class er extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r)}emplace(t,n,r,s){const l=3*t;return this.uint16[l+0]=n,this.uint16[l+1]=r,this.uint16[l+2]=s,t}}er.prototype.bytesPerElement=6,jt(er,"StructArrayLayout3ui6");class e_ extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C,I,A,M){const R=this.length;return this.resize(R+1),this.emplace(R,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C,I,A,M)}emplace(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C,I,A,M,R){const L=30*t,O=15*t,z=60*t;return this.int16[L+0]=n,this.int16[L+1]=r,this.int16[L+2]=s,this.float32[O+2]=l,this.float32[O+3]=c,this.uint16[L+8]=h,this.uint16[L+9]=f,this.uint32[O+5]=p,this.uint32[O+6]=m,this.uint32[O+7]=_,this.uint16[L+16]=y,this.uint16[L+17]=v,this.uint16[L+18]=b,this.float32[O+10]=E,this.float32[O+11]=D,this.uint8[z+48]=T,this.uint8[z+49]=C,this.uint8[z+50]=I,this.uint32[O+13]=A,this.int16[L+28]=M,this.uint8[z+58]=R,t}}e_.prototype.bytesPerElement=60,jt(e_,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class n_ extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C,I,A,M,R,L,O,z,N,V,B,$,j,Z,K){const Q=this.length;return this.resize(Q+1),this.emplace(Q,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C,I,A,M,R,L,O,z,N,V,B,$,j,Z,K)}emplace(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C,I,A,M,R,L,O,z,N,V,B,$,j,Z,K,Q){const W=20*t,X=40*t,nt=80*t;return this.float32[W+0]=n,this.float32[W+1]=r,this.int16[X+4]=s,this.int16[X+5]=l,this.int16[X+6]=c,this.int16[X+7]=h,this.int16[X+8]=f,this.int16[X+9]=p,this.int16[X+10]=m,this.int16[X+11]=_,this.int16[X+12]=y,this.uint16[X+13]=v,this.uint16[X+14]=b,this.uint16[X+15]=E,this.uint16[X+16]=D,this.uint16[X+17]=T,this.uint16[X+18]=C,this.uint16[X+19]=I,this.uint16[X+20]=A,this.uint16[X+21]=M,this.uint16[X+22]=R,this.uint16[X+23]=L,this.uint16[X+24]=O,this.uint16[X+25]=z,this.uint16[X+26]=N,this.uint16[X+27]=V,this.uint32[W+14]=B,this.float32[W+15]=$,this.float32[W+16]=j,this.float32[W+17]=Z,this.float32[W+18]=K,this.uint8[nt+76]=Q,t}}n_.prototype.bytesPerElement=80,jt(n_,"StructArrayLayout2f9i15ui1ul4f1ub80");class Kh extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.float32[1*t+0]=n,t}}Kh.prototype.bytesPerElement=4,jt(Kh,"StructArrayLayout1f4");class ma extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,s,l)}emplace(t,n,r,s,l,c){const h=5*t;return this.float32[h+0]=n,this.float32[h+1]=r,this.float32[h+2]=s,this.float32[h+3]=l,this.float32[h+4]=c,t}}ma.prototype.bytesPerElement=20,jt(ma,"StructArrayLayout5f20");class lc extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h){const f=this.length;return this.resize(f+1),this.emplace(f,t,n,r,s,l,c,h)}emplace(t,n,r,s,l,c,h,f){const p=7*t;return this.float32[p+0]=n,this.float32[p+1]=r,this.float32[p+2]=s,this.float32[p+3]=l,this.float32[p+4]=c,this.float32[p+5]=h,this.float32[p+6]=f,t}}lc.prototype.bytesPerElement=28,jt(lc,"StructArrayLayout7f28");class lp extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,s){const l=this.length;return this.resize(l+1),this.emplace(l,t,n,r,s)}emplace(t,n,r,s,l){const c=6*t;return this.uint32[3*t+0]=n,this.uint16[c+2]=r,this.uint16[c+3]=s,this.uint16[c+4]=l,t}}lp.prototype.bytesPerElement=12,jt(lp,"StructArrayLayout1ul3ui12");class ga extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint16[1*t+0]=n,t}}ga.prototype.bytesPerElement=2,jt(ga,"StructArrayLayout1ui2");class Jh extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,n)}emplace(t,n,r){const s=2*t;return this.float32[s+0]=n,this.float32[s+1]=r,t}}Jh.prototype.bytesPerElement=8,jt(Jh,"StructArrayLayout2f8");class cp extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D){const T=this.length;return this.resize(T+1),this.emplace(T,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D)}emplace(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T){const C=16*t;return this.float32[C+0]=n,this.float32[C+1]=r,this.float32[C+2]=s,this.float32[C+3]=l,this.float32[C+4]=c,this.float32[C+5]=h,this.float32[C+6]=f,this.float32[C+7]=p,this.float32[C+8]=m,this.float32[C+9]=_,this.float32[C+10]=y,this.float32[C+11]=v,this.float32[C+12]=b,this.float32[C+13]=E,this.float32[C+14]=D,this.float32[C+15]=T,t}}cp.prototype.bytesPerElement=64,jt(cp,"StructArrayLayout16f64");class dl extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,s,l,c,h){const f=this.length;return this.resize(f+1),this.emplace(f,t,n,r,s,l,c,h)}emplace(t,n,r,s,l,c,h,f){const p=10*t,m=5*t;return this.uint16[p+0]=n,this.uint16[p+1]=r,this.uint16[p+2]=s,this.uint16[p+3]=l,this.float32[m+2]=c,this.float32[m+3]=h,this.float32[m+4]=f,t}}dl.prototype.bytesPerElement=20,jt(dl,"StructArrayLayout4ui3f20");class vu extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint8[1*t+0]=n,t}}vu.prototype.bytesPerElement=1,jt(vu,"StructArrayLayout1ub1");class r_ extends rp{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}r_.prototype.size=40;class i_ extends t_{get(t){return new r_(this,t)}}jt(i_,"CollisionBoxArray");class i1 extends rp{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}i1.prototype.size=60;class cc extends e_{get(t){return new i1(this,t)}}jt(cc,"PlacedSymbolArray");class xu extends rp{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(t){this._structArray.uint32[this._pos4+14]=t}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(t){this._structArray.float32[this._pos4+18]=t}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}xu.prototype.size=80;class o1 extends n_{get(t){return new xu(this,t)}}jt(o1,"SymbolInstanceArray");class BD extends Kh{getoffsetX(t){return this.float32[1*t+0]}}jt(BD,"GlyphOffsetArray");class o_ extends ro{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}jt(o_,"SymbolLineVertexArray");class s1 extends rp{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}s1.prototype.size=12;class jD extends lp{get(t){return new s1(this,t)}}jt(jD,"FeatureIndexArray");class a1 extends bo{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}jt(a1,"FillExtrusionCentroidArray");const VD=sn([{name:"a_pos",components:2,type:"Int16"}],4),UD=sn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class ln{constructor(t=[]){this.segments=t}_prepareSegment(t,n,r,s){let l=this.segments[this.segments.length-1];return t>ln.MAX_VERTEX_ARRAY_LENGTH&&Y(`Max vertices per segment is ${ln.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!l||l.vertexLength+t>ln.MAX_VERTEX_ARRAY_LENGTH||l.sortKey!==s)&&(l={vertexOffset:n,primitiveOffset:r,vertexLength:0,primitiveLength:0},void 0!==s&&(l.sortKey=s),this.segments.push(l)),l}prepareSegment(t,n,r,s){return this._prepareSegment(t,n.length,r.length,s)}get(){return this.segments}destroy(){for(const t of this.segments)for(const n in t.vaos)t.vaos[n].destroy()}static simpleSegment(t,n,r,s){return new ln([{vertexOffset:t,primitiveOffset:n,vertexLength:r,primitiveLength:s,vaos:{},sortKey:0}])}}function s_(e,t){return 256*(e=Gt(Math.floor(e),0,255))+Gt(Math.floor(t),0,255)}ln.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,jt(ln,"SegmentVector");const $D=sn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),l1=sn([{name:"a_dash",components:4,type:"Uint16"}]);var a_={exports:{}},fA={exports:function(t,n){var r,s,l,c,h,f,p,m;for(s=t.length-(r=3&t.length),l=n,h=3432918353,f=461845907,m=0;m<s;)p=255&t.charCodeAt(m)|(255&t.charCodeAt(++m))<<8|(255&t.charCodeAt(++m))<<16|(255&t.charCodeAt(++m))<<24,++m,l=27492+(65535&(c=5*(65535&(l=(l^=p=(65535&(p=(p=(65535&p)*h+(((p>>>16)*h&65535)<<16)&4294967295)<<15|p>>>17))*f+(((p>>>16)*f&65535)<<16)&4294967295)<<13|l>>>19))+((5*(l>>>16)&65535)<<16)&4294967295))+((58964+(c>>>16)&65535)<<16);switch(p=0,r){case 3:p^=(255&t.charCodeAt(m+2))<<16;case 2:p^=(255&t.charCodeAt(m+1))<<8;case 1:l^=p=(65535&(p=(p=(65535&(p^=255&t.charCodeAt(m)))*h+(((p>>>16)*h&65535)<<16)&4294967295)<<15|p>>>17))*f+(((p>>>16)*f&65535)<<16)&4294967295}return l^=t.length,l=2246822507*(65535&(l^=l>>>16))+((2246822507*(l>>>16)&65535)<<16)&4294967295,l=3266489909*(65535&(l^=l>>>13))+((3266489909*(l>>>16)&65535)<<16)&4294967295,(l^=l>>>16)>>>0}}.exports,c1={exports:{}};c1.exports=function(t,n){for(var r,s=t.length,l=n^s,c=0;s>=4;)r=1540483477*(65535&(r=255&t.charCodeAt(c)|(255&t.charCodeAt(++c))<<8|(255&t.charCodeAt(++c))<<16|(255&t.charCodeAt(++c))<<24))+((1540483477*(r>>>16)&65535)<<16),l=1540483477*(65535&l)+((1540483477*(l>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),s-=4,++c;switch(s){case 3:l^=(255&t.charCodeAt(c+2))<<16;case 2:l^=(255&t.charCodeAt(c+1))<<8;case 1:l=1540483477*(65535&(l^=255&t.charCodeAt(c)))+((1540483477*(l>>>16)&65535)<<16)}return l=1540483477*(65535&(l^=l>>>13))+((1540483477*(l>>>16)&65535)<<16),(l^=l>>>15)>>>0};var u1=fA,c_=c1.exports;a_.exports=u1,a_.exports.murmur3=u1,a_.exports.murmur2=c_;var h1=Zi(a_.exports);class up{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(t,n,r,s){this.ids.push(hp(t)),this.positions.push(n,r,s)}eachPosition(t,n){const r=hp(t);let s=0,l=this.ids.length-1;for(;s<l;){const c=s+l>>1;this.ids[c]>=r?l=c:s=c+1}for(;this.ids[s]===r;)n(this.positions[3*s],this.positions[3*s+1],this.positions[3*s+2]),s++}static serialize(t,n){const r=new Float64Array(t.ids),s=new Uint32Array(t.positions);return d1(r,s,0,r.length-1),n&&(n.add(r.buffer),n.add(s.buffer)),{ids:r,positions:s}}static deserialize(t){const n=new up;let r;n.ids=t.ids,n.positions=t.positions;for(const s of n.ids)s!==r&&n.uniqueIds.push(s),r=s;return n.indexed=!0,n}}function hp(e){const t=+e;return!isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:h1(String(e))}function d1(e,t,n,r){for(;n<r;){const s=e[n+r>>1];let l=n-1,c=r+1;for(;;){do{l++}while(e[l]<s);do{c--}while(e[c]>s);if(l>=c)break;u_(e,l,c),u_(t,3*l,3*c),u_(t,3*l+1,3*c+1),u_(t,3*l+2,3*c+2)}c-n<r-c?(d1(e,t,n,c),n=c+1):(d1(e,t,c+1,r),r=c)}}function u_(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}jt(up,"FeaturePositionMap");class fl{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,n),this.initialized=!0),!!this.location}}class Fe extends fl{constructor(t){super(t),this.current=0}set(t,n,r){this.fetchUniformLocation(t,n)&&this.current!==r&&(this.current=r,this.gl.uniform1i(this.location,r))}}class bt extends fl{constructor(t){super(t),this.current=0}set(t,n,r){this.fetchUniformLocation(t,n)&&this.current!==r&&(this.current=r,this.gl.uniform1f(this.location,r))}}class Be extends fl{constructor(t){super(t),this.current=[0,0]}set(t,n,r){this.fetchUniformLocation(t,n)&&(r[0]===this.current[0]&&r[1]===this.current[1]||(this.current=r,this.gl.uniform2f(this.location,r[0],r[1])))}}class xe extends fl{constructor(t){super(t),this.current=[0,0,0]}set(t,n,r){this.fetchUniformLocation(t,n)&&(r[0]===this.current[0]&&r[1]===this.current[1]&&r[2]===this.current[2]||(this.current=r,this.gl.uniform3f(this.location,r[0],r[1],r[2])))}}class Ei extends fl{constructor(t){super(t),this.current=[0,0,0,0]}set(t,n,r){this.fetchUniformLocation(t,n)&&(r[0]===this.current[0]&&r[1]===this.current[1]&&r[2]===this.current[2]&&r[3]===this.current[3]||(this.current=r,this.gl.uniform4f(this.location,r[0],r[1],r[2],r[3])))}}class uc extends fl{constructor(t){super(t),this.current=le.transparent}set(t,n,r){this.fetchUniformLocation(t,n)&&(r.r===this.current.r&&r.g===this.current.g&&r.b===this.current.b&&r.a===this.current.a||(this.current=r,this.gl.uniform4f(this.location,r.r,r.g,r.b,r.a)))}}const f1=new Float32Array(16);class ye extends fl{constructor(t){super(t),this.current=f1}set(t,n,r){if(this.fetchUniformLocation(t,n)){if(r[12]!==this.current[12]||r[0]!==this.current[0])return this.current=r,void this.gl.uniformMatrix4fv(this.location,!1,r);for(let s=1;s<16;s++)if(r[s]!==this.current[s]){this.current=r,this.gl.uniformMatrix4fv(this.location,!1,r);break}}}}const io=new Float32Array(9);class p1 extends fl{constructor(t){super(t),this.current=io}set(t,n,r){if(this.fetchUniformLocation(t,n))for(let s=0;s<9;s++)if(r[s]!==this.current[s]){this.current=r,this.gl.uniformMatrix3fv(this.location,!1,r);break}}}const HD=new Float32Array(4);class h_ extends fl{constructor(t){super(t),this.current=HD}set(t,n,r){if(this.fetchUniformLocation(t,n))for(let s=0;s<4;s++)if(r[s]!==this.current[s]){this.current=r,this.gl.uniformMatrix2fv(this.location,!1,r);break}}}function dp(e){return[s_(255*e.r,255*e.g),s_(255*e.b,255*e.a)]}class hc{constructor(t,n,r){this.value=t,this.uniformNames=n.map(s=>`u_${s}`),this.type=r}setUniform(t,n,r,s,l){n.set(t,l,s.constantOr(this.value))}getBinding(t,n){return"color"===this.type?new uc(t):new bt(t)}}class bu{constructor(t,n){this.uniformNames=n.map(r=>`u_${r}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(t){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br)}setUniform(t,n,r,s,l){const c="u_pattern"===l||"u_dash"===l?this.pattern:"u_pixel_ratio"===l?this.pixelRatio:null;c&&n.set(t,l,c)}getBinding(t,n){return"u_pattern"===n||"u_dash"===n?new Ei(t):new bt(t)}}class _a{constructor(t,n,r,s){this.expression=t,this.type=r,this.maxValue=0,this.paintVertexAttributes=n.map(l=>({name:`a_${l}`,type:"Float32",components:"color"===r?2:1,offset:0})),this.paintVertexArray=new s}populatePaintArray(t,n,r,s,l,c,h){const f=this.paintVertexArray.length,p=this.expression.evaluate(new Gn(0,{brightness:c}),n,{},l,s,h);this.paintVertexArray.resize(t),this._setPaintValue(f,t,p)}updatePaintArray(t,n,r,s,l,c,h){const f=this.expression.evaluate({zoom:0,brightness:h},r,s,void 0,l);this._setPaintValue(t,n,f)}_setPaintValue(t,n,r){if("color"===this.type){const s=dp(r);for(let l=t;l<n;l++)this.paintVertexArray.emplace(l,s[0],s[1])}else{for(let s=t;s<n;s++)this.paintVertexArray.emplace(s,r);this.maxValue=Math.max(this.maxValue,Math.abs(r))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class es{constructor(t,n,r,s,l,c){this.expression=t,this.uniformNames=n.map(h=>`u_${h}_t`),this.type=r,this.useIntegerZoom=s,this.zoom=l,this.maxValue=0,this.paintVertexAttributes=n.map(h=>({name:`a_${h}`,type:"Float32",components:"color"===r?4:2,offset:0})),this.paintVertexArray=new c}populatePaintArray(t,n,r,s,l,c,h){const f=this.expression.evaluate(new Gn(this.zoom,{brightness:c}),n,{},l,s,h),p=this.expression.evaluate(new Gn(this.zoom+1,{brightness:c}),n,{},l,s,h),m=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(m,t,f,p)}updatePaintArray(t,n,r,s,l,c,h){const f=this.expression.evaluate({zoom:this.zoom,brightness:h},r,s,void 0,l),p=this.expression.evaluate({zoom:this.zoom+1,brightness:h},r,s,void 0,l);this._setPaintValue(t,n,f,p)}_setPaintValue(t,n,r,s){if("color"===this.type){const l=dp(r),c=dp(s);for(let h=t;h<n;h++)this.paintVertexArray.emplace(h,l[0],l[1],c[0],c[1])}else{for(let l=t;l<n;l++)this.paintVertexArray.emplace(l,r,s);this.maxValue=Math.max(this.maxValue,Math.abs(r),Math.abs(s))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,n,r,s,l){const c=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,h=Gt(this.expression.interpolationFactor(c,this.zoom,this.zoom+1),0,1);n.set(t,l,h)}getBinding(t,n){return new bt(t)}}class ya{constructor(t,n,r,s,l){this.expression=t,this.layerId=l,this.paintVertexAttributes=("array"===r?l1:$D).members;for(let c=0;c<n.length;++c);this.paintVertexArray=new s}populatePaintArray(t,n,r){const s=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(s,t,n.patterns&&n.patterns[this.layerId],r)}updatePaintArray(t,n,r,s,l,c,h){this._setPaintValues(t,n,r.patterns&&r.patterns[this.layerId],c)}_setPaintValues(t,n,r,s){if(!s||!r)return;const l=s[r];if(!l)return;const{tl:c,br:h,pixelRatio:f}=l;for(let p=t;p<n;p++)this.paintVertexArray.emplace(p,c[0],c[1],h[0],h[1],f)}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class dc{constructor(t,n,r=(()=>!0)){this.binders={},this._buffers=[];const s=[];for(const l in t.paint._values){const c=t.paint.get(l);if(!r(l)||!(c instanceof ic&&Jl(c.property.specification)))continue;const h=d_(l,t.type),f=c.value,p=c.property.specification.type,m=!!c.property.useIntegerZoom,_="line-dasharray"===l||l.endsWith("pattern"),y="line-dasharray"===l&&"constant"!==t.layout.get("line-cap").value.kind;if("constant"!==f.kind||y)if("source"===f.kind||y||_){const v=di(l,p,"source");this.binders[l]=_?new ya(f,h,p,v,t.id):new _a(f,h,p,v),s.push(`/a_${l}`)}else{const v=di(l,p,"composite");this.binders[l]=new es(f,h,p,m,n,v),s.push(`/z_${l}`)}else this.binders[l]=_?new bu(f.value,h):new hc(f.value,h,p),s.push(`/u_${l}`)}this.cacheKey=s.sort().join("")}getMaxValue(t){const n=this.binders[t];return n instanceof _a||n instanceof es?n.maxValue:0}populatePaintArrays(t,n,r,s,l,c,h){for(const f in this.binders){const p=this.binders[f];(p instanceof _a||p instanceof es||p instanceof ya)&&p.populatePaintArray(t,n,r,s,l,c,h)}}setConstantPatternPositions(t){for(const n in this.binders){const r=this.binders[n];r instanceof bu&&r.setConstantPatternPositions(t)}}updatePaintArrays(t,n,r,s,l,c,h,f){let p=!1;const m=Object.keys(t),_=0!==m.length,y=_?m:n.uniqueIds;for(const v in this.binders){const b=this.binders[v];if((b instanceof _a||b instanceof es||b instanceof ya)&&(!0===b.expression.isStateDependent||!1===b.expression.isLightConstant)){const E=l.paint.get(v);b.expression=E.value;for(const D of y){const T=t[D.toString()];n.eachPosition(D,(C,I,A)=>{const M=s.feature(C);b.updatePaintArray(I,A,M,T,c,h,f)})}if(!_)for(const D of r.uniqueIds){const T=t[D.toString()];r.eachPosition(D,(C,I,A)=>{const M=s.feature(C);b.updatePaintArray(I,A,M,T,c,h,f)})}p=!0}}return p}defines(){const t=[];for(const n in this.binders){const r=this.binders[n];(r instanceof hc||r instanceof bu)&&t.push(...r.uniformNames.map(s=>`#define HAS_UNIFORM_${s}`))}return t}getBinderAttributes(){const t=[];for(const n in this.binders){const r=this.binders[n];if(r instanceof _a||r instanceof es||r instanceof ya)for(let s=0;s<r.paintVertexAttributes.length;s++)t.push(r.paintVertexAttributes[s].name)}return t}getBinderUniforms(){const t=[];for(const n in this.binders){const r=this.binders[n];if(r instanceof hc||r instanceof bu||r instanceof es)for(const s of r.uniformNames)t.push(s)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const n=[];for(const r in this.binders){const s=this.binders[r];if(s instanceof hc||s instanceof bu||s instanceof es)for(const l of s.uniformNames)n.push({name:l,property:r,binding:s.getBinding(t,l)})}return n}setUniforms(t,n,r,s,l){for(const{name:c,property:h,binding:f}of r)this.binders[h].setUniform(t,f,l,s.get(h),c)}updatePaintBuffers(){this._buffers=[];for(const t in this.binders){const n=this.binders[t];(n instanceof _a||n instanceof es||n instanceof ya)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer)}}upload(t){for(const n in this.binders){const r=this.binders[n];(r instanceof _a||r instanceof es||r instanceof ya)&&r.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const n=this.binders[t];(n instanceof _a||n instanceof es||n instanceof ya)&&n.destroy()}}}class pl{constructor(t,n,r=(()=>!0)){this.programConfigurations={};for(const s of t)this.programConfigurations[s.id]=new dc(s,n,r);this.needsUpload=!1,this._featureMap=new up,this._featureMapWithoutIds=new up,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(t,n,r,s,l,c,h,f){for(const p in this.programConfigurations)this.programConfigurations[p].populatePaintArrays(t,n,s,l,c,h,f);void 0!==n.id?this._featureMap.add(n.id,r,this._bufferOffset,t):(this._featureMapWithoutIds.add(this._idlessCounter,r,this._bufferOffset,t),this._idlessCounter+=1),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,n,r,s,l,c){for(const h of r)this.needsUpload=this.programConfigurations[h.id].updatePaintArrays(t,this._featureMap,this._featureMapWithoutIds,n,h,s,l,c||0)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const n in this.programConfigurations)this.programConfigurations[n].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const Ni={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function d_(e,t){return Ni[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")]}const m1={"line-pattern":{source:ts,composite:ts},"fill-pattern":{source:ts,composite:ts},"fill-extrusion-pattern":{source:ts,composite:ts},"line-dasharray":{source:ip,composite:ip}},f_={color:{source:Jh,composite:Os},number:{source:Kh,composite:Jh}};function di(e,t,n){const r=m1[e];return r&&r[n]||f_[t][n]}jt(hc,"ConstantBinder"),jt(bu,"PatternConstantBinder"),jt(_a,"SourceExpressionBinder"),jt(ya,"PatternCompositeBinder"),jt(es,"CompositeExpressionBinder"),jt(dc,"ProgramConfiguration",{omit:["_buffers"]}),jt(pl,"ProgramConfigurationSet");class fi{constructor(t,n){t&&(n?this.setSouthWest(t).setNorthEast(n):4===t.length?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof ce?new ce(t.lng,t.lat):ce.convert(t),this}setSouthWest(t){return this._sw=t instanceof ce?new ce(t.lng,t.lat):ce.convert(t),this}extend(t){const n=this._sw,r=this._ne;let s,l;if(t instanceof ce)s=t,l=t;else{if(!(t instanceof fi))return Array.isArray(t)?4===t.length||t.every(Array.isArray)?this.extend(fi.convert(t)):this.extend(ce.convert(t)):"object"==typeof t&&null!==t&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(ce.convert(t)):this;if(s=t._sw,l=t._ne,!s||!l)return this}return n||r?(n.lng=Math.min(s.lng,n.lng),n.lat=Math.min(s.lat,n.lat),r.lng=Math.max(l.lng,r.lng),r.lat=Math.max(l.lat,r.lat)):(this._sw=new ce(s.lng,s.lat),this._ne=new ce(l.lng,l.lat)),this}getCenter(){return new ce((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new ce(this.getWest(),this.getNorth())}getSouthEast(){return new ce(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:n,lat:r}=ce.convert(t);let s=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(s=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=r&&r<=this._ne.lat&&s}static convert(t){return!t||t instanceof fi?t:new fi(t)}}var Sr={},Fr={};Object.defineProperty(Fr,"__esModule",{value:!0}),Fr.setMatrixArrayType=function(e){Fr.ARRAY_TYPE=p_=e},Fr.toRadian=function(e){return e*_1},Fr.equals=function(e,t){return Math.abs(e-t)<=g1*Math.max(1,Math.abs(e),Math.abs(t))},Fr.RANDOM=Fr.ARRAY_TYPE=Fr.EPSILON=void 0;var g1=1e-6;Fr.EPSILON=g1;var p_=typeof Float32Array<"u"?Float32Array:Array;Fr.ARRAY_TYPE=p_;var GD=Math.random;Fr.RANDOM=GD;var _1=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Hn={};function fp(e){return(fp="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(Hn,"__esModule",{value:!0}),Hn.create=function(){var e=new ml.ARRAY_TYPE(4);return ml.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},Hn.clone=function(e){var t=new ml.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Hn.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Hn.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},Hn.fromValues=function(e,t,n,r){var s=new ml.ARRAY_TYPE(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=r,s},Hn.set=function(e,t,n,r,s){return e[0]=t,e[1]=n,e[2]=r,e[3]=s,e},Hn.transpose=function(e,t){if(e===t){var n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},Hn.invert=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=n*l-s*r;return c?(e[0]=l*(c=1/c),e[1]=-r*c,e[2]=-s*c,e[3]=n*c,e):null},Hn.adjoint=function(e,t){var n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e},Hn.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},Hn.multiply=pp,Hn.rotate=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(n),f=Math.cos(n);return e[0]=r*f+l*h,e[1]=s*f+c*h,e[2]=r*-h+l*f,e[3]=s*-h+c*f,e},Hn.scale=function(e,t,n){var r=t[1],s=t[2],l=t[3],c=n[0],h=n[1];return e[0]=t[0]*c,e[1]=r*c,e[2]=s*h,e[3]=l*h,e},Hn.fromRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=-n,e[3]=r,e},Hn.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},Hn.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},Hn.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3])},Hn.LDU=function(e,t,n,r){return e[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-e[2]*n[1],[e,t,n]},Hn.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},Hn.subtract=mp,Hn.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},Hn.equals=function(e,t){var n=e[0],r=e[1],s=e[2],l=e[3],c=t[0],h=t[1],f=t[2],p=t[3];return Math.abs(n-c)<=ml.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(r-h)<=ml.EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(s-f)<=ml.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-p)<=ml.EPSILON*Math.max(1,Math.abs(l),Math.abs(p))},Hn.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},Hn.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e},Hn.sub=Hn.mul=void 0;var ml=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==fp(e)&&"function"!=typeof e)return{default:e};var n=y1(void 0);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}(Fr);function y1(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(y1=function(r){return r?n:t})(e)}function pp(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=n[0],f=n[1],p=n[2],m=n[3];return e[0]=r*h+l*f,e[1]=s*h+c*f,e[2]=r*p+l*m,e[3]=s*p+c*m,e}function mp(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}Hn.mul=pp,Hn.sub=mp;var Zn={};function gp(e){return(gp="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(Zn,"__esModule",{value:!0}),Zn.create=function(){var e=new zs.ARRAY_TYPE(6);return zs.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},Zn.clone=function(e){var t=new zs.ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},Zn.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},Zn.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},Zn.fromValues=function(e,t,n,r,s,l){var c=new zs.ARRAY_TYPE(6);return c[0]=e,c[1]=t,c[2]=n,c[3]=r,c[4]=s,c[5]=l,c},Zn.set=function(e,t,n,r,s,l,c){return e[0]=t,e[1]=n,e[2]=r,e[3]=s,e[4]=l,e[5]=c,e},Zn.invert=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=t[4],h=t[5],f=n*l-r*s;return f?(e[0]=l*(f=1/f),e[1]=-r*f,e[2]=-s*f,e[3]=n*f,e[4]=(s*h-l*c)*f,e[5]=(r*c-n*h)*f,e):null},Zn.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},Zn.multiply=v1,Zn.rotate=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=Math.sin(n),m=Math.cos(n);return e[0]=r*m+l*p,e[1]=s*m+c*p,e[2]=r*-p+l*m,e[3]=s*-p+c*m,e[4]=h,e[5]=f,e},Zn.scale=function(e,t,n){var r=t[1],s=t[2],l=t[3],c=t[4],h=t[5],f=n[0],p=n[1];return e[0]=t[0]*f,e[1]=r*f,e[2]=s*p,e[3]=l*p,e[4]=c,e[5]=h,e},Zn.translate=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=n[0],m=n[1];return e[0]=r,e[1]=s,e[2]=l,e[3]=c,e[4]=r*p+l*m+h,e[5]=s*p+c*m+f,e},Zn.fromRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=-n,e[3]=r,e[4]=0,e[5]=0,e},Zn.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},Zn.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},Zn.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},Zn.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},Zn.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e},Zn.subtract=x1,Zn.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e},Zn.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e},Zn.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},Zn.equals=function(e,t){var n=e[0],r=e[1],s=e[2],l=e[3],c=e[4],h=e[5],f=t[0],p=t[1],m=t[2],_=t[3],y=t[4],v=t[5];return Math.abs(n-f)<=zs.EPSILON*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(r-p)<=zs.EPSILON*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(s-m)<=zs.EPSILON*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(l-_)<=zs.EPSILON*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(c-y)<=zs.EPSILON*Math.max(1,Math.abs(c),Math.abs(y))&&Math.abs(h-v)<=zs.EPSILON*Math.max(1,Math.abs(h),Math.abs(v))},Zn.sub=Zn.mul=void 0;var zs=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==gp(e)&&"function"!=typeof e)return{default:e};var n=wu(void 0);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}(Fr);function wu(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(wu=function(r){return r?n:t})(e)}function v1(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=n[0],m=n[1],_=n[2],y=n[3],v=n[4],b=n[5];return e[0]=r*p+l*m,e[1]=s*p+c*m,e[2]=r*_+l*y,e[3]=s*_+c*y,e[4]=r*v+l*b+h,e[5]=s*v+c*b+f,e}function x1(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e}Zn.mul=v1,Zn.sub=x1;var fn={};function Qh(e){return(Qh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(fn,"__esModule",{value:!0}),fn.create=function(){var e=new oo.ARRAY_TYPE(9);return oo.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e},fn.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},fn.clone=function(e){var t=new oo.ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fn.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},fn.fromValues=function(e,t,n,r,s,l,c,h,f){var p=new oo.ARRAY_TYPE(9);return p[0]=e,p[1]=t,p[2]=n,p[3]=r,p[4]=s,p[5]=l,p[6]=c,p[7]=h,p[8]=f,p},fn.set=function(e,t,n,r,s,l,c,h,f,p){return e[0]=t,e[1]=n,e[2]=r,e[3]=s,e[4]=l,e[5]=c,e[6]=h,e[7]=f,e[8]=p,e},fn.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fn.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},fn.invert=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=t[4],h=t[5],f=t[6],p=t[7],m=t[8],_=m*c-h*p,y=-m*l+h*f,v=p*l-c*f,b=n*_+r*y+s*v;return b?(e[0]=_*(b=1/b),e[1]=(-m*r+s*p)*b,e[2]=(h*r-s*c)*b,e[3]=y*b,e[4]=(m*n-s*f)*b,e[5]=(-h*n+s*l)*b,e[6]=v*b,e[7]=(-p*n+r*f)*b,e[8]=(c*n-r*l)*b,e):null},fn.adjoint=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=t[4],h=t[5],f=t[6],p=t[7],m=t[8];return e[0]=c*m-h*p,e[1]=s*p-r*m,e[2]=r*h-s*c,e[3]=h*f-l*m,e[4]=n*m-s*f,e[5]=s*l-n*h,e[6]=l*p-c*f,e[7]=r*f-n*p,e[8]=n*c-r*l,e},fn.determinant=function(e){var t=e[3],n=e[4],r=e[5],s=e[6],l=e[7],c=e[8];return e[0]*(c*n-r*l)+e[1]*(-c*t+r*s)+e[2]*(l*t-n*s)},fn.multiply=fc,fn.translate=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=t[8],y=n[0],v=n[1];return e[0]=r,e[1]=s,e[2]=l,e[3]=c,e[4]=h,e[5]=f,e[6]=y*r+v*c+p,e[7]=y*s+v*h+m,e[8]=y*l+v*f+_,e},fn.rotate=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=t[8],y=Math.sin(n),v=Math.cos(n);return e[0]=v*r+y*c,e[1]=v*s+y*h,e[2]=v*l+y*f,e[3]=v*c-y*r,e[4]=v*h-y*s,e[5]=v*f-y*l,e[6]=p,e[7]=m,e[8]=_,e},fn.scale=function(e,t,n){var r=n[0],s=n[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},fn.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},fn.fromRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=-n,e[4]=r,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fn.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fn.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},fn.fromQuat=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=n+n,h=r+r,f=s+s,p=n*c,m=r*c,_=r*h,y=s*c,v=s*h,b=s*f,E=l*c,D=l*h,T=l*f;return e[0]=1-_-b,e[3]=m-T,e[6]=y+D,e[1]=m+T,e[4]=1-p-b,e[7]=v-E,e[2]=y-D,e[5]=v+E,e[8]=1-p-_,e},fn.normalFromMat4=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=t[4],h=t[5],f=t[6],p=t[7],m=t[8],_=t[9],y=t[10],v=t[11],b=t[12],E=t[13],D=t[14],T=t[15],C=n*h-r*c,I=n*f-s*c,A=n*p-l*c,M=r*f-s*h,R=r*p-l*h,L=s*p-l*f,O=m*E-_*b,z=m*D-y*b,N=m*T-v*b,V=_*D-y*E,B=_*T-v*E,$=y*T-v*D,j=C*$-I*B+A*V+M*N-R*z+L*O;return j?(e[0]=(h*$-f*B+p*V)*(j=1/j),e[1]=(f*N-c*$-p*z)*j,e[2]=(c*B-h*N+p*O)*j,e[3]=(s*B-r*$-l*V)*j,e[4]=(n*$-s*N+l*z)*j,e[5]=(r*N-n*B-l*O)*j,e[6]=(E*L-D*R+T*M)*j,e[7]=(D*A-b*L-T*I)*j,e[8]=(b*R-E*A+T*C)*j,e):null},fn.projection=function(e,t,n){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/n,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},fn.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},fn.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},fn.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e},fn.subtract=_p,fn.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e},fn.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e[6]=t[6]+n[6]*r,e[7]=t[7]+n[7]*r,e[8]=t[8]+n[8]*r,e},fn.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},fn.equals=function(e,t){var n=e[0],r=e[1],s=e[2],l=e[3],c=e[4],h=e[5],f=e[6],p=e[7],m=e[8],_=t[0],y=t[1],v=t[2],b=t[3],E=t[4],D=t[5],T=t[6],C=t[7],I=t[8];return Math.abs(n-_)<=oo.EPSILON*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(r-y)<=oo.EPSILON*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(s-v)<=oo.EPSILON*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(l-b)<=oo.EPSILON*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(c-E)<=oo.EPSILON*Math.max(1,Math.abs(c),Math.abs(E))&&Math.abs(h-D)<=oo.EPSILON*Math.max(1,Math.abs(h),Math.abs(D))&&Math.abs(f-T)<=oo.EPSILON*Math.max(1,Math.abs(f),Math.abs(T))&&Math.abs(p-C)<=oo.EPSILON*Math.max(1,Math.abs(p),Math.abs(C))&&Math.abs(m-I)<=oo.EPSILON*Math.max(1,Math.abs(m),Math.abs(I))},fn.sub=fn.mul=void 0;var oo=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==Qh(e)&&"function"!=typeof e)return{default:e};var n=qD(void 0);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}(Fr);function qD(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(qD=function(r){return r?n:t})(e)}function fc(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=t[8],y=n[0],v=n[1],b=n[2],E=n[3],D=n[4],T=n[5],C=n[6],I=n[7],A=n[8];return e[0]=y*r+v*c+b*p,e[1]=y*s+v*h+b*m,e[2]=y*l+v*f+b*_,e[3]=E*r+D*c+T*p,e[4]=E*s+D*h+T*m,e[5]=E*l+D*f+T*_,e[6]=C*r+I*c+A*p,e[7]=C*s+I*h+A*m,e[8]=C*l+I*f+A*_,e}function _p(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e}fn.mul=fc,fn.sub=_p;var we={};function m_(e){return(m_="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(we,"__esModule",{value:!0}),we.create=function(){var e=new Xn.ARRAY_TYPE(16);return Xn.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},we.clone=function(e){var t=new Xn.ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},we.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},we.fromValues=function(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E){var D=new Xn.ARRAY_TYPE(16);return D[0]=e,D[1]=t,D[2]=n,D[3]=r,D[4]=s,D[5]=l,D[6]=c,D[7]=h,D[8]=f,D[9]=p,D[10]=m,D[11]=_,D[12]=y,D[13]=v,D[14]=b,D[15]=E,D},we.set=function(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D){return e[0]=t,e[1]=n,e[2]=r,e[3]=s,e[4]=l,e[5]=c,e[6]=h,e[7]=f,e[8]=p,e[9]=m,e[10]=_,e[11]=y,e[12]=v,e[13]=b,e[14]=E,e[15]=D,e},we.identity=w1,we.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],s=t[3],l=t[6],c=t[7],h=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=l,e[11]=t[14],e[12]=s,e[13]=c,e[14]=h}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},we.invert=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=t[4],h=t[5],f=t[6],p=t[7],m=t[8],_=t[9],y=t[10],v=t[11],b=t[12],E=t[13],D=t[14],T=t[15],C=n*h-r*c,I=n*f-s*c,A=n*p-l*c,M=r*f-s*h,R=r*p-l*h,L=s*p-l*f,O=m*E-_*b,z=m*D-y*b,N=m*T-v*b,V=_*D-y*E,B=_*T-v*E,$=y*T-v*D,j=C*$-I*B+A*V+M*N-R*z+L*O;return j?(e[0]=(h*$-f*B+p*V)*(j=1/j),e[1]=(s*B-r*$-l*V)*j,e[2]=(E*L-D*R+T*M)*j,e[3]=(y*R-_*L-v*M)*j,e[4]=(f*N-c*$-p*z)*j,e[5]=(n*$-s*N+l*z)*j,e[6]=(D*A-b*L-T*I)*j,e[7]=(m*L-y*A+v*I)*j,e[8]=(c*B-h*N+p*O)*j,e[9]=(r*N-n*B-l*O)*j,e[10]=(b*R-E*A+T*C)*j,e[11]=(_*A-m*R-v*C)*j,e[12]=(h*z-c*V-f*O)*j,e[13]=(n*V-r*z+s*O)*j,e[14]=(E*I-b*M-D*C)*j,e[15]=(m*M-_*I+y*C)*j,e):null},we.adjoint=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=t[4],h=t[5],f=t[6],p=t[7],m=t[8],_=t[9],y=t[10],v=t[11],b=t[12],E=t[13],D=t[14],T=t[15];return e[0]=h*(y*T-v*D)-_*(f*T-p*D)+E*(f*v-p*y),e[1]=-(r*(y*T-v*D)-_*(s*T-l*D)+E*(s*v-l*y)),e[2]=r*(f*T-p*D)-h*(s*T-l*D)+E*(s*p-l*f),e[3]=-(r*(f*v-p*y)-h*(s*v-l*y)+_*(s*p-l*f)),e[4]=-(c*(y*T-v*D)-m*(f*T-p*D)+b*(f*v-p*y)),e[5]=n*(y*T-v*D)-m*(s*T-l*D)+b*(s*v-l*y),e[6]=-(n*(f*T-p*D)-c*(s*T-l*D)+b*(s*p-l*f)),e[7]=n*(f*v-p*y)-c*(s*v-l*y)+m*(s*p-l*f),e[8]=c*(_*T-v*E)-m*(h*T-p*E)+b*(h*v-p*_),e[9]=-(n*(_*T-v*E)-m*(r*T-l*E)+b*(r*v-l*_)),e[10]=n*(h*T-p*E)-c*(r*T-l*E)+b*(r*p-l*h),e[11]=-(n*(h*v-p*_)-c*(r*v-l*_)+m*(r*p-l*h)),e[12]=-(c*(_*D-y*E)-m*(h*D-f*E)+b*(h*y-f*_)),e[13]=n*(_*D-y*E)-m*(r*D-s*E)+b*(r*y-s*_),e[14]=-(n*(h*D-f*E)-c*(r*D-s*E)+b*(r*f-s*h)),e[15]=n*(h*y-f*_)-c*(r*y-s*_)+m*(r*f-s*h),e},we.determinant=function(e){var t=e[0],n=e[1],r=e[2],s=e[3],l=e[4],c=e[5],h=e[6],f=e[7],p=e[8],m=e[9],_=e[10],y=e[11],v=e[12],b=e[13],E=e[14],D=e[15];return(t*c-n*l)*(_*D-y*E)-(t*h-r*l)*(m*D-y*b)+(t*f-s*l)*(m*E-_*b)+(n*h-r*c)*(p*D-y*v)-(n*f-s*c)*(p*E-_*v)+(r*f-s*h)*(p*b-m*v)},we.multiply=E1,we.translate=function(e,t,n){var r,s,l,c,h,f,p,m,_,y,v,b,E=n[0],D=n[1],T=n[2];return t===e?(e[12]=t[0]*E+t[4]*D+t[8]*T+t[12],e[13]=t[1]*E+t[5]*D+t[9]*T+t[13],e[14]=t[2]*E+t[6]*D+t[10]*T+t[14],e[15]=t[3]*E+t[7]*D+t[11]*T+t[15]):(s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=t[8],y=t[9],v=t[10],b=t[11],e[0]=r=t[0],e[1]=s,e[2]=l,e[3]=c,e[4]=h,e[5]=f,e[6]=p,e[7]=m,e[8]=_,e[9]=y,e[10]=v,e[11]=b,e[12]=r*E+h*D+_*T+t[12],e[13]=s*E+f*D+y*T+t[13],e[14]=l*E+p*D+v*T+t[14],e[15]=c*E+m*D+b*T+t[15]),e},we.scale=function(e,t,n){var r=n[0],s=n[1],l=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*l,e[9]=t[9]*l,e[10]=t[10]*l,e[11]=t[11]*l,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},we.rotate=function(e,t,n,r){var s,l,c,h,f,p,m,_,y,v,b,E,D,T,C,I,A,M,R,L,O,z,N,V,B=r[0],$=r[1],j=r[2],Z=Math.hypot(B,$,j);return Z<Xn.EPSILON?null:(B*=Z=1/Z,$*=Z,j*=Z,s=Math.sin(n),l=Math.cos(n),f=t[1],p=t[2],m=t[3],y=t[5],v=t[6],b=t[7],D=t[9],T=t[10],C=t[11],R=B*$*(c=1-l)-j*s,L=$*$*c+l,O=j*$*c+B*s,z=B*j*c+$*s,N=$*j*c-B*s,V=j*j*c+l,e[0]=(h=t[0])*(I=B*B*c+l)+(_=t[4])*(A=$*B*c+j*s)+(E=t[8])*(M=j*B*c-$*s),e[1]=f*I+y*A+D*M,e[2]=p*I+v*A+T*M,e[3]=m*I+b*A+C*M,e[4]=h*R+_*L+E*O,e[5]=f*R+y*L+D*O,e[6]=p*R+v*L+T*O,e[7]=m*R+b*L+C*O,e[8]=h*z+_*N+E*V,e[9]=f*z+y*N+D*V,e[10]=p*z+v*N+T*V,e[11]=m*z+b*N+C*V,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},we.rotateX=function(e,t,n){var r=Math.sin(n),s=Math.cos(n),l=t[4],c=t[5],h=t[6],f=t[7],p=t[8],m=t[9],_=t[10],y=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=l*s+p*r,e[5]=c*s+m*r,e[6]=h*s+_*r,e[7]=f*s+y*r,e[8]=p*s-l*r,e[9]=m*s-c*r,e[10]=_*s-h*r,e[11]=y*s-f*r,e},we.rotateY=function(e,t,n){var r=Math.sin(n),s=Math.cos(n),l=t[0],c=t[1],h=t[2],f=t[3],p=t[8],m=t[9],_=t[10],y=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=l*s-p*r,e[1]=c*s-m*r,e[2]=h*s-_*r,e[3]=f*s-y*r,e[8]=l*r+p*s,e[9]=c*r+m*s,e[10]=h*r+_*s,e[11]=f*r+y*s,e},we.rotateZ=function(e,t,n){var r=Math.sin(n),s=Math.cos(n),l=t[0],c=t[1],h=t[2],f=t[3],p=t[4],m=t[5],_=t[6],y=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=l*s+p*r,e[1]=c*s+m*r,e[2]=h*s+_*r,e[3]=f*s+y*r,e[4]=p*s-l*r,e[5]=m*s-c*r,e[6]=_*s-h*r,e[7]=y*s-f*r,e},we.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},we.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},we.fromRotation=function(e,t,n){var r,s,l,c=n[0],h=n[1],f=n[2],p=Math.hypot(c,h,f);return p<Xn.EPSILON?null:(c*=p=1/p,h*=p,f*=p,r=Math.sin(t),s=Math.cos(t),e[0]=c*c*(l=1-s)+s,e[1]=h*c*l+f*r,e[2]=f*c*l-h*r,e[3]=0,e[4]=c*h*l-f*r,e[5]=h*h*l+s,e[6]=f*h*l+c*r,e[7]=0,e[8]=c*f*l+h*r,e[9]=h*f*l-c*r,e[10]=f*f*l+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},we.fromXRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=n,e[7]=0,e[8]=0,e[9]=-n,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},we.fromYRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-n,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=n,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},we.fromZRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=0,e[4]=-n,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},we.fromRotationTranslation=T1,we.fromQuat2=function(e,t){var n=new Xn.ARRAY_TYPE(3),r=-t[0],s=-t[1],l=-t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=r*r+s*s+l*l+c*c;return _>0?(n[0]=2*(h*c+m*r+f*l-p*s)/_,n[1]=2*(f*c+m*s+p*r-h*l)/_,n[2]=2*(p*c+m*l+h*s-f*r)/_):(n[0]=2*(h*c+m*r+f*l-p*s),n[1]=2*(f*c+m*s+p*r-h*l),n[2]=2*(p*c+m*l+h*s-f*r)),T1(e,t,n),e},we.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},we.getScaling=D1,we.getRotation=function(e,t){var n=new Xn.ARRAY_TYPE(3);D1(n,t);var r=1/n[0],s=1/n[1],l=1/n[2],c=t[0]*r,h=t[1]*s,f=t[2]*l,p=t[4]*r,m=t[5]*s,_=t[6]*l,y=t[8]*r,v=t[9]*s,b=t[10]*l,E=c+m+b,D=0;return E>0?(D=2*Math.sqrt(E+1),e[3]=.25*D,e[0]=(_-v)/D,e[1]=(y-f)/D,e[2]=(h-p)/D):c>m&&c>b?(D=2*Math.sqrt(1+c-m-b),e[3]=(_-v)/D,e[0]=.25*D,e[1]=(h+p)/D,e[2]=(y+f)/D):m>b?(D=2*Math.sqrt(1+m-c-b),e[3]=(y-f)/D,e[0]=(h+p)/D,e[1]=.25*D,e[2]=(_+v)/D):(D=2*Math.sqrt(1+b-c-m),e[3]=(h-p)/D,e[0]=(y+f)/D,e[1]=(_+v)/D,e[2]=.25*D),e},we.fromRotationTranslationScale=function(e,t,n,r){var s=t[0],l=t[1],c=t[2],h=t[3],f=s+s,p=l+l,m=c+c,_=s*f,y=s*p,v=s*m,b=l*p,E=l*m,D=c*m,T=h*f,C=h*p,I=h*m,A=r[0],M=r[1],R=r[2];return e[0]=(1-(b+D))*A,e[1]=(y+I)*A,e[2]=(v-C)*A,e[3]=0,e[4]=(y-I)*M,e[5]=(1-(_+D))*M,e[6]=(E+T)*M,e[7]=0,e[8]=(v+C)*R,e[9]=(E-T)*R,e[10]=(1-(_+b))*R,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e},we.fromRotationTranslationScaleOrigin=function(e,t,n,r,s){var l=t[0],c=t[1],h=t[2],f=t[3],p=l+l,m=c+c,_=h+h,y=l*p,v=l*m,b=l*_,E=c*m,D=c*_,T=h*_,C=f*p,I=f*m,A=f*_,M=r[0],R=r[1],L=r[2],O=s[0],z=s[1],N=s[2],V=(1-(E+T))*M,B=(v+A)*M,$=(b-I)*M,j=(v-A)*R,Z=(1-(y+T))*R,K=(D+C)*R,Q=(b+I)*L,W=(D-C)*L,X=(1-(y+E))*L;return e[0]=V,e[1]=B,e[2]=$,e[3]=0,e[4]=j,e[5]=Z,e[6]=K,e[7]=0,e[8]=Q,e[9]=W,e[10]=X,e[11]=0,e[12]=n[0]+O-(V*O+j*z+Q*N),e[13]=n[1]+z-(B*O+Z*z+W*N),e[14]=n[2]+N-($*O+K*z+X*N),e[15]=1,e},we.fromQuat=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=n+n,h=r+r,f=s+s,p=n*c,m=r*c,_=r*h,y=s*c,v=s*h,b=s*f,E=l*c,D=l*h,T=l*f;return e[0]=1-_-b,e[1]=m+T,e[2]=y-D,e[3]=0,e[4]=m-T,e[5]=1-p-b,e[6]=v+E,e[7]=0,e[8]=y+D,e[9]=v-E,e[10]=1-p-_,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},we.frustum=function(e,t,n,r,s,l,c){var h=1/(n-t),f=1/(s-r),p=1/(l-c);return e[0]=2*l*h,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*l*f,e[6]=0,e[7]=0,e[8]=(n+t)*h,e[9]=(s+r)*f,e[10]=(c+l)*p,e[11]=-1,e[12]=0,e[13]=0,e[14]=c*l*2*p,e[15]=0,e},we.perspectiveNO=S1,we.perspectiveZO=function(e,t,n,r,s){var l,c=1/Math.tan(t/2);return e[0]=c/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(e[10]=s*(l=1/(r-s)),e[14]=s*r*l):(e[10]=-1,e[14]=-r),e},we.perspectiveFromFieldOfView=function(e,t,n,r){var s=Math.tan(t.upDegrees*Math.PI/180),l=Math.tan(t.downDegrees*Math.PI/180),c=Math.tan(t.leftDegrees*Math.PI/180),h=Math.tan(t.rightDegrees*Math.PI/180),f=2/(c+h),p=2/(s+l);return e[0]=f,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=p,e[6]=0,e[7]=0,e[8]=-(c-h)*f*.5,e[9]=(s-l)*p*.5,e[10]=r/(n-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*n/(n-r),e[15]=0,e},we.orthoNO=g_,we.orthoZO=function(e,t,n,r,s,l,c){var h=1/(t-n),f=1/(r-s),p=1/(l-c);return e[0]=-2*h,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*f,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=p,e[11]=0,e[12]=(t+n)*h,e[13]=(s+r)*f,e[14]=l*p,e[15]=1,e},we.lookAt=function(e,t,n,r){var s,l,c,h,f,p,m,_,y,v,b=t[0],E=t[1],D=t[2],T=r[0],C=r[1],I=r[2],A=n[0],M=n[1],R=n[2];return Math.abs(b-A)<Xn.EPSILON&&Math.abs(E-M)<Xn.EPSILON&&Math.abs(D-R)<Xn.EPSILON?w1(e):(m=b-A,_=E-M,y=D-R,s=C*(y*=v=1/Math.hypot(m,_,y))-I*(_*=v),l=I*(m*=v)-T*y,c=T*_-C*m,(v=Math.hypot(s,l,c))?(s*=v=1/v,l*=v,c*=v):(s=0,l=0,c=0),h=_*c-y*l,f=y*s-m*c,p=m*l-_*s,(v=Math.hypot(h,f,p))?(h*=v=1/v,f*=v,p*=v):(h=0,f=0,p=0),e[0]=s,e[1]=h,e[2]=m,e[3]=0,e[4]=l,e[5]=f,e[6]=_,e[7]=0,e[8]=c,e[9]=p,e[10]=y,e[11]=0,e[12]=-(s*b+l*E+c*D),e[13]=-(h*b+f*E+p*D),e[14]=-(m*b+_*E+y*D),e[15]=1,e)},we.targetTo=function(e,t,n,r){var s=t[0],l=t[1],c=t[2],h=r[0],f=r[1],p=r[2],m=s-n[0],_=l-n[1],y=c-n[2],v=m*m+_*_+y*y;v>0&&(m*=v=1/Math.sqrt(v),_*=v,y*=v);var b=f*y-p*_,E=p*m-h*y,D=h*_-f*m;return(v=b*b+E*E+D*D)>0&&(b*=v=1/Math.sqrt(v),E*=v,D*=v),e[0]=b,e[1]=E,e[2]=D,e[3]=0,e[4]=_*D-y*E,e[5]=y*b-m*D,e[6]=m*E-_*b,e[7]=0,e[8]=m,e[9]=_,e[10]=y,e[11]=0,e[12]=s,e[13]=l,e[14]=c,e[15]=1,e},we.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},we.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},we.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e[9]=t[9]+n[9],e[10]=t[10]+n[10],e[11]=t[11]+n[11],e[12]=t[12]+n[12],e[13]=t[13]+n[13],e[14]=t[14]+n[14],e[15]=t[15]+n[15],e},we.subtract=yp,we.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12]*n,e[13]=t[13]*n,e[14]=t[14]*n,e[15]=t[15]*n,e},we.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e[6]=t[6]+n[6]*r,e[7]=t[7]+n[7]*r,e[8]=t[8]+n[8]*r,e[9]=t[9]+n[9]*r,e[10]=t[10]+n[10]*r,e[11]=t[11]+n[11]*r,e[12]=t[12]+n[12]*r,e[13]=t[13]+n[13]*r,e[14]=t[14]+n[14]*r,e[15]=t[15]+n[15]*r,e},we.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},we.equals=function(e,t){var n=e[0],r=e[1],s=e[2],l=e[3],c=e[4],h=e[5],f=e[6],p=e[7],m=e[8],_=e[9],y=e[10],v=e[11],b=e[12],E=e[13],D=e[14],T=e[15],C=t[0],I=t[1],A=t[2],M=t[3],R=t[4],L=t[5],O=t[6],z=t[7],N=t[8],V=t[9],B=t[10],$=t[11],j=t[12],Z=t[13],K=t[14],Q=t[15];return Math.abs(n-C)<=Xn.EPSILON*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(r-I)<=Xn.EPSILON*Math.max(1,Math.abs(r),Math.abs(I))&&Math.abs(s-A)<=Xn.EPSILON*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(l-M)<=Xn.EPSILON*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(c-R)<=Xn.EPSILON*Math.max(1,Math.abs(c),Math.abs(R))&&Math.abs(h-L)<=Xn.EPSILON*Math.max(1,Math.abs(h),Math.abs(L))&&Math.abs(f-O)<=Xn.EPSILON*Math.max(1,Math.abs(f),Math.abs(O))&&Math.abs(p-z)<=Xn.EPSILON*Math.max(1,Math.abs(p),Math.abs(z))&&Math.abs(m-N)<=Xn.EPSILON*Math.max(1,Math.abs(m),Math.abs(N))&&Math.abs(_-V)<=Xn.EPSILON*Math.max(1,Math.abs(_),Math.abs(V))&&Math.abs(y-B)<=Xn.EPSILON*Math.max(1,Math.abs(y),Math.abs(B))&&Math.abs(v-$)<=Xn.EPSILON*Math.max(1,Math.abs(v),Math.abs($))&&Math.abs(b-j)<=Xn.EPSILON*Math.max(1,Math.abs(b),Math.abs(j))&&Math.abs(E-Z)<=Xn.EPSILON*Math.max(1,Math.abs(E),Math.abs(Z))&&Math.abs(D-K)<=Xn.EPSILON*Math.max(1,Math.abs(D),Math.abs(K))&&Math.abs(T-Q)<=Xn.EPSILON*Math.max(1,Math.abs(T),Math.abs(Q))},we.sub=we.mul=we.ortho=we.perspective=void 0;var Xn=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==m_(e)&&"function"!=typeof e)return{default:e};var n=b1(void 0);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}(Fr);function b1(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(b1=function(r){return r?n:t})(e)}function w1(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function E1(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=t[8],y=t[9],v=t[10],b=t[11],E=t[12],D=t[13],T=t[14],C=t[15],I=n[0],A=n[1],M=n[2],R=n[3];return e[0]=I*r+A*h+M*_+R*E,e[1]=I*s+A*f+M*y+R*D,e[2]=I*l+A*p+M*v+R*T,e[3]=I*c+A*m+M*b+R*C,e[4]=(I=n[4])*r+(A=n[5])*h+(M=n[6])*_+(R=n[7])*E,e[5]=I*s+A*f+M*y+R*D,e[6]=I*l+A*p+M*v+R*T,e[7]=I*c+A*m+M*b+R*C,e[8]=(I=n[8])*r+(A=n[9])*h+(M=n[10])*_+(R=n[11])*E,e[9]=I*s+A*f+M*y+R*D,e[10]=I*l+A*p+M*v+R*T,e[11]=I*c+A*m+M*b+R*C,e[12]=(I=n[12])*r+(A=n[13])*h+(M=n[14])*_+(R=n[15])*E,e[13]=I*s+A*f+M*y+R*D,e[14]=I*l+A*p+M*v+R*T,e[15]=I*c+A*m+M*b+R*C,e}function T1(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=r+r,f=s+s,p=l+l,m=r*h,_=r*f,y=r*p,v=s*f,b=s*p,E=l*p,D=c*h,T=c*f,C=c*p;return e[0]=1-(v+E),e[1]=_+C,e[2]=y-T,e[3]=0,e[4]=_-C,e[5]=1-(m+E),e[6]=b+D,e[7]=0,e[8]=y+T,e[9]=b-D,e[10]=1-(m+v),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function D1(e,t){var n=t[4],r=t[5],s=t[6],l=t[8],c=t[9],h=t[10];return e[0]=Math.hypot(t[0],t[1],t[2]),e[1]=Math.hypot(n,r,s),e[2]=Math.hypot(l,c,h),e}function S1(e,t,n,r,s){var l,c=1/Math.tan(t/2);return e[0]=c/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(e[10]=(s+r)*(l=1/(r-s)),e[14]=2*s*r*l):(e[10]=-1,e[14]=-2*r),e}function g_(e,t,n,r,s,l,c){var h=1/(t-n),f=1/(r-s),p=1/(l-c);return e[0]=-2*h,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*f,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*p,e[11]=0,e[12]=(t+n)*h,e[13]=(s+r)*f,e[14]=(c+l)*p,e[15]=1,e}function yp(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e[9]=t[9]-n[9],e[10]=t[10]-n[10],e[11]=t[11]-n[11],e[12]=t[12]-n[12],e[13]=t[13]-n[13],e[14]=t[14]-n[14],e[15]=t[15]-n[15],e}we.perspective=S1,we.ortho=g_,we.mul=E1,we.sub=yp;var ge={},ve={};function __(e){return(__="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(ve,"__esModule",{value:!0}),ve.create=v_,ve.clone=function(e){var t=new va.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},ve.length=gl,ve.fromValues=function(e,t,n){var r=new va.ARRAY_TYPE(3);return r[0]=e,r[1]=t,r[2]=n,r},ve.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},ve.set=function(e,t,n,r){return e[0]=t,e[1]=n,e[2]=r,e},ve.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e},ve.subtract=x_,ve.multiply=b_,ve.divide=C1,ve.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},ve.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},ve.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e},ve.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e},ve.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},ve.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},ve.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e},ve.distance=WD,ve.squaredDistance=td,ve.squaredLength=M1,ve.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},ve.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},ve.normalize=function(e,t){var n=t[0],r=t[1],s=t[2],l=n*n+r*r+s*s;return l>0&&(l=1/Math.sqrt(l)),e[0]=t[0]*l,e[1]=t[1]*l,e[2]=t[2]*l,e},ve.dot=w_,ve.cross=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=n[0],h=n[1],f=n[2];return e[0]=s*f-l*h,e[1]=l*c-r*f,e[2]=r*h-s*c,e},ve.lerp=function(e,t,n,r){var s=t[0],l=t[1],c=t[2];return e[0]=s+r*(n[0]-s),e[1]=l+r*(n[1]-l),e[2]=c+r*(n[2]-c),e},ve.hermite=function(e,t,n,r,s,l){var c=l*l,h=c*(2*l-3)+1,f=c*(l-2)+l,p=c*(l-1),m=c*(3-2*l);return e[0]=t[0]*h+n[0]*f+r[0]*p+s[0]*m,e[1]=t[1]*h+n[1]*f+r[1]*p+s[1]*m,e[2]=t[2]*h+n[2]*f+r[2]*p+s[2]*m,e},ve.bezier=function(e,t,n,r,s,l){var c=1-l,h=c*c,f=l*l,p=h*c,m=3*l*h,_=3*f*c,y=f*l;return e[0]=t[0]*p+n[0]*m+r[0]*_+s[0]*y,e[1]=t[1]*p+n[1]*m+r[1]*_+s[1]*y,e[2]=t[2]*p+n[2]*m+r[2]*_+s[2]*y,e},ve.random=function(e,t){t=t||1;var n=2*va.RANDOM()*Math.PI,r=2*va.RANDOM()-1,s=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(n)*s,e[1]=Math.sin(n)*s,e[2]=r*t,e},ve.transformMat4=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=n[3]*r+n[7]*s+n[11]*l+n[15];return e[0]=(n[0]*r+n[4]*s+n[8]*l+n[12])/(c=c||1),e[1]=(n[1]*r+n[5]*s+n[9]*l+n[13])/c,e[2]=(n[2]*r+n[6]*s+n[10]*l+n[14])/c,e},ve.transformMat3=function(e,t,n){var r=t[0],s=t[1],l=t[2];return e[0]=r*n[0]+s*n[3]+l*n[6],e[1]=r*n[1]+s*n[4]+l*n[7],e[2]=r*n[2]+s*n[5]+l*n[8],e},ve.transformQuat=function(e,t,n){var r=n[0],s=n[1],l=n[2],c=t[0],h=t[1],f=t[2],p=s*f-l*h,m=l*c-r*f,_=r*h-s*c,y=s*_-l*m,v=l*p-r*_,b=r*m-s*p,E=2*n[3];return m*=E,_*=E,v*=2,b*=2,e[0]=c+(p*=E)+(y*=2),e[1]=h+m+v,e[2]=f+_+b,e},ve.rotateX=function(e,t,n,r){var s=[],l=[];return s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],l[0]=s[0],l[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),l[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),e[0]=l[0]+n[0],e[1]=l[1]+n[1],e[2]=l[2]+n[2],e},ve.rotateY=function(e,t,n,r){var s=[],l=[];return s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],l[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),l[1]=s[1],l[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),e[0]=l[0]+n[0],e[1]=l[1]+n[1],e[2]=l[2]+n[2],e},ve.rotateZ=function(e,t,n,r){var s=[],l=[];return s[0]=t[0]-n[0],s[1]=t[1]-n[1],s[2]=t[2]-n[2],l[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),l[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),l[2]=s[2],e[0]=l[0]+n[0],e[1]=l[1]+n[1],e[2]=l[2]+n[2],e},ve.angle=function(e,t){var n=e[0],r=e[1],s=e[2],l=t[0],c=t[1],h=t[2],f=Math.sqrt(n*n+r*r+s*s)*Math.sqrt(l*l+c*c+h*h),p=f&&w_(e,t)/f;return Math.acos(Math.min(Math.max(p,-1),1))},ve.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e},ve.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},ve.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},ve.equals=function(e,t){var n=e[0],r=e[1],s=e[2],l=t[0],c=t[1],h=t[2];return Math.abs(n-l)<=va.EPSILON*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(r-c)<=va.EPSILON*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(s-h)<=va.EPSILON*Math.max(1,Math.abs(s),Math.abs(h))},ve.forEach=ve.sqrLen=ve.len=ve.sqrDist=ve.dist=ve.div=ve.mul=ve.sub=void 0;var va=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==__(e)&&"function"!=typeof e)return{default:e};var n=y_(void 0);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}(Fr);function y_(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(y_=function(r){return r?n:t})(e)}function v_(){var e=new va.ARRAY_TYPE(3);return va.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function gl(e){return Math.hypot(e[0],e[1],e[2])}function x_(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function b_(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e}function C1(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e}function WD(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function td(e,t){var n=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return n*n+r*r+s*s}function M1(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r}function w_(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}ve.sub=x_,ve.mul=b_,ve.div=C1,ve.dist=WD,ve.sqrDist=td,ve.len=gl,ve.sqrLen=M1;var Ns,I1=(Ns=v_(),function(e,t,n,r,s,l){var c,h;for(t||(t=3),n||(n=0),h=r?Math.min(r*t+n,e.length):e.length,c=n;c<h;c+=t)Ns[0]=e[c],Ns[1]=e[c+1],Ns[2]=e[c+2],s(Ns,Ns,l),e[c]=Ns[0],e[c+1]=Ns[1],e[c+2]=Ns[2];return e});ve.forEach=I1;var Pe={};function vp(e){return(vp="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(Pe,"__esModule",{value:!0}),Pe.create=E_,Pe.clone=function(e){var t=new Bi.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Pe.fromValues=function(e,t,n,r){var s=new Bi.ARRAY_TYPE(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=r,s},Pe.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Pe.set=function(e,t,n,r,s){return e[0]=t,e[1]=n,e[2]=r,e[3]=s,e},Pe.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},Pe.subtract=xp,Pe.multiply=bp,Pe.divide=wp,Pe.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},Pe.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},Pe.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e[3]=Math.min(t[3],n[3]),e},Pe.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e[3]=Math.max(t[3],n[3]),e},Pe.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},Pe.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},Pe.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e},Pe.distance=Eu,Pe.squaredDistance=A1,Pe.length=T_,Pe.squaredLength=P1,Pe.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},Pe.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},Pe.normalize=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=n*n+r*r+s*s+l*l;return c>0&&(c=1/Math.sqrt(c)),e[0]=n*c,e[1]=r*c,e[2]=s*c,e[3]=l*c,e},Pe.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},Pe.cross=function(e,t,n,r){var s=n[0]*r[1]-n[1]*r[0],l=n[0]*r[2]-n[2]*r[0],c=n[0]*r[3]-n[3]*r[0],h=n[1]*r[2]-n[2]*r[1],f=n[1]*r[3]-n[3]*r[1],p=n[2]*r[3]-n[3]*r[2],m=t[0],_=t[1],y=t[2],v=t[3];return e[0]=_*p-y*f+v*h,e[1]=-m*p+y*c-v*l,e[2]=m*f-_*c+v*s,e[3]=-m*h+_*l-y*s,e},Pe.lerp=function(e,t,n,r){var s=t[0],l=t[1],c=t[2],h=t[3];return e[0]=s+r*(n[0]-s),e[1]=l+r*(n[1]-l),e[2]=c+r*(n[2]-c),e[3]=h+r*(n[3]-h),e},Pe.random=function(e,t){var n,r,s,l,c,h;t=t||1;do{c=(n=2*Bi.RANDOM()-1)*n+(r=2*Bi.RANDOM()-1)*r}while(c>=1);do{h=(s=2*Bi.RANDOM()-1)*s+(l=2*Bi.RANDOM()-1)*l}while(h>=1);var f=Math.sqrt((1-c)/h);return e[0]=t*n,e[1]=t*r,e[2]=t*s*f,e[3]=t*l*f,e},Pe.transformMat4=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3];return e[0]=n[0]*r+n[4]*s+n[8]*l+n[12]*c,e[1]=n[1]*r+n[5]*s+n[9]*l+n[13]*c,e[2]=n[2]*r+n[6]*s+n[10]*l+n[14]*c,e[3]=n[3]*r+n[7]*s+n[11]*l+n[15]*c,e},Pe.transformQuat=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=n[0],h=n[1],f=n[2],p=n[3],m=p*r+h*l-f*s,_=p*s+f*r-c*l,y=p*l+c*s-h*r,v=-c*r-h*s-f*l;return e[0]=m*p+v*-c+_*-f-y*-h,e[1]=_*p+v*-h+y*-c-m*-f,e[2]=y*p+v*-f+m*-h-_*-c,e[3]=t[3],e},Pe.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},Pe.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},Pe.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},Pe.equals=function(e,t){var n=e[0],r=e[1],s=e[2],l=e[3],c=t[0],h=t[1],f=t[2],p=t[3];return Math.abs(n-c)<=Bi.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(r-h)<=Bi.EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(s-f)<=Bi.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-p)<=Bi.EPSILON*Math.max(1,Math.abs(l),Math.abs(p))},Pe.forEach=Pe.sqrLen=Pe.len=Pe.sqrDist=Pe.dist=Pe.div=Pe.mul=Pe.sub=void 0;var Bi=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==vp(e)&&"function"!=typeof e)return{default:e};var n=ed(void 0);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}(Fr);function ed(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(ed=function(r){return r?n:t})(e)}function E_(){var e=new Bi.ARRAY_TYPE(4);return Bi.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function xp(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}function bp(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],e}function wp(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e[3]=t[3]/n[3],e}function Eu(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function A1(e,t){var n=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],l=t[3]-e[3];return n*n+r*r+s*s+l*l}function T_(e){return Math.hypot(e[0],e[1],e[2],e[3])}function P1(e){var t=e[0],n=e[1],r=e[2],s=e[3];return t*t+n*n+r*r+s*s}Pe.sub=xp,Pe.mul=bp,Pe.div=wp,Pe.dist=Eu,Pe.sqrDist=A1,Pe.len=T_,Pe.sqrLen=P1;var ZD=function(){var e=E_();return function(t,n,r,s,l,c){var h,f;for(n||(n=4),r||(r=0),f=s?Math.min(s*n+r,t.length):t.length,h=r;h<f;h+=n)e[0]=t[h],e[1]=t[h+1],e[2]=t[h+2],e[3]=t[h+3],l(e,e,c),t[h]=e[0],t[h+1]=e[1],t[h+2]=e[2],t[h+3]=e[3];return t}}();function Ep(e){return(Ep="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Pe.forEach=ZD,Object.defineProperty(ge,"__esModule",{value:!0}),ge.create=L1,ge.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},ge.setAxisAngle=k1,ge.getAxisAngle=function(e,t){var n=2*Math.acos(t[3]),r=Math.sin(n/2);return r>xa.EPSILON?(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r):(e[0]=1,e[1]=0,e[2]=0),n},ge.getAngle=function(e,t){var n=C_(e,t);return Math.acos(2*n*n-1)},ge.multiply=Sp,ge.rotateX=function(e,t,n){n*=.5;var r=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(n),f=Math.cos(n);return e[0]=r*f+c*h,e[1]=s*f+l*h,e[2]=l*f-s*h,e[3]=c*f-r*h,e},ge.rotateY=function(e,t,n){n*=.5;var r=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(n),f=Math.cos(n);return e[0]=r*f-l*h,e[1]=s*f+c*h,e[2]=l*f+r*h,e[3]=c*f-s*h,e},ge.rotateZ=function(e,t,n){n*=.5;var r=t[0],s=t[1],l=t[2],c=t[3],h=Math.sin(n),f=Math.cos(n);return e[0]=r*f+s*h,e[1]=s*f-r*h,e[2]=l*f+c*h,e[3]=c*f-l*h,e},ge.calculateW=function(e,t){var n=t[0],r=t[1],s=t[2];return e[0]=n,e[1]=r,e[2]=s,e[3]=Math.sqrt(Math.abs(1-n*n-r*r-s*s)),e},ge.exp=O1,ge.ln=D_,ge.pow=function(e,t,n){return D_(e,t),S_(e,e,n),O1(e,e),e},ge.slerp=pc,ge.random=function(e){var t=xa.RANDOM(),n=xa.RANDOM(),r=xa.RANDOM(),s=Math.sqrt(1-t),l=Math.sqrt(t);return e[0]=s*Math.sin(2*Math.PI*n),e[1]=s*Math.cos(2*Math.PI*n),e[2]=l*Math.sin(2*Math.PI*r),e[3]=l*Math.cos(2*Math.PI*r),e},ge.invert=function(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=n*n+r*r+s*s+l*l,h=c?1/c:0;return e[0]=-n*h,e[1]=-r*h,e[2]=-s*h,e[3]=l*h,e},ge.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},ge.fromMat3=Cp,ge.fromEuler=function(e,t,n,r){var s=.5*Math.PI/180;t*=s,n*=s,r*=s;var l=Math.sin(t),c=Math.cos(t),h=Math.sin(n),f=Math.cos(n),p=Math.sin(r),m=Math.cos(r);return e[0]=l*f*m-c*h*p,e[1]=c*h*m+l*f*p,e[2]=c*f*p-l*h*m,e[3]=c*f*m+l*h*p,e},ge.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},ge.setAxes=ge.sqlerp=ge.rotationTo=ge.equals=ge.exactEquals=ge.normalize=ge.sqrLen=ge.squaredLength=ge.len=ge.length=ge.lerp=ge.dot=ge.scale=ge.mul=ge.add=ge.set=ge.copy=ge.fromValues=ge.clone=void 0;var xa=Dp(Fr),Tp=Dp(fn),ns=Dp(ve),Wr=Dp(Pe);function R1(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(R1=function(r){return r?n:t})(e)}function Dp(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==Ep(e)&&"function"!=typeof e)return{default:e};var n=R1(t);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}function L1(){var e=new xa.ARRAY_TYPE(4);return xa.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function k1(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e}function Sp(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=n[0],f=n[1],p=n[2],m=n[3];return e[0]=r*m+c*h+s*p-l*f,e[1]=s*m+c*f+l*h-r*p,e[2]=l*m+c*p+r*f-s*h,e[3]=c*m-r*h-s*f-l*p,e}function O1(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=Math.sqrt(n*n+r*r+s*s),h=Math.exp(l),f=c>0?h*Math.sin(c)/c:0;return e[0]=n*f,e[1]=r*f,e[2]=s*f,e[3]=h*Math.cos(c),e}function D_(e,t){var n=t[0],r=t[1],s=t[2],l=t[3],c=Math.sqrt(n*n+r*r+s*s),h=c>0?Math.atan2(c,l)/c:0;return e[0]=n*h,e[1]=r*h,e[2]=s*h,e[3]=.5*Math.log(n*n+r*r+s*s+l*l),e}function pc(e,t,n,r){var s,l,c,h,f,p=t[0],m=t[1],_=t[2],y=t[3],v=n[0],b=n[1],E=n[2],D=n[3];return(l=p*v+m*b+_*E+y*D)<0&&(l=-l,v=-v,b=-b,E=-E,D=-D),1-l>xa.EPSILON?(s=Math.acos(l),c=Math.sin(s),h=Math.sin((1-r)*s)/c,f=Math.sin(r*s)/c):(h=1-r,f=r),e[0]=h*p+f*v,e[1]=h*m+f*b,e[2]=h*_+f*E,e[3]=h*y+f*D,e}function Cp(e,t){var n,r=t[0]+t[4]+t[8];if(r>0)n=Math.sqrt(r+1),e[3]=.5*n,e[0]=(t[5]-t[7])*(n=.5/n),e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var s=0;t[4]>t[0]&&(s=1),t[8]>t[3*s+s]&&(s=2);var l=(s+1)%3,c=(s+2)%3;n=Math.sqrt(t[3*s+s]-t[3*l+l]-t[3*c+c]+1),e[s]=.5*n,e[3]=(t[3*l+c]-t[3*c+l])*(n=.5/n),e[l]=(t[3*l+s]+t[3*s+l])*n,e[c]=(t[3*c+s]+t[3*s+c])*n}return e}ge.clone=Wr.clone,ge.fromValues=Wr.fromValues,ge.copy=Wr.copy,ge.set=Wr.set,ge.add=Wr.add,ge.mul=Sp;var S_=Wr.scale;ge.scale=S_;var C_=Wr.dot;ge.dot=C_,ge.lerp=Wr.lerp;var M_=Wr.length;ge.length=M_,ge.len=M_;var I_=Wr.squaredLength;ge.squaredLength=I_,ge.sqrLen=I_;var A_=Wr.normalize;ge.normalize=A_,ge.exactEquals=Wr.exactEquals,ge.equals=Wr.equals;var rs,F1,z1,XD=(rs=ns.create(),F1=ns.fromValues(1,0,0),z1=ns.fromValues(0,1,0),function(e,t,n){var r=ns.dot(t,n);return r<-.999999?(ns.cross(rs,F1,t),ns.len(rs)<1e-6&&ns.cross(rs,z1,t),ns.normalize(rs,rs),k1(e,rs,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(ns.cross(rs,t,n),e[0]=rs[0],e[1]=rs[1],e[2]=rs[2],e[3]=1+r,A_(e,e))});ge.rotationTo=XD;var Bs,mc,YD=(Bs=L1(),mc=L1(),function(e,t,n,r,s,l){return pc(Bs,t,s,l),pc(mc,n,r,l),pc(e,Bs,mc,2*l*(1-l)),e});ge.sqlerp=YD;var js,pA=(js=Tp.create(),function(e,t,n,r){return js[0]=n[0],js[3]=n[1],js[6]=n[2],js[1]=r[0],js[4]=r[1],js[7]=r[2],js[2]=-t[0],js[5]=-t[1],js[8]=-t[2],A_(e,Cp(e,js))});ge.setAxes=pA;var qe={};function N1(e){return(N1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(qe,"__esModule",{value:!0}),qe.create=function(){var e=new so.ARRAY_TYPE(8);return so.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},qe.clone=function(e){var t=new so.ARRAY_TYPE(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},qe.fromValues=function(e,t,n,r,s,l,c,h){var f=new so.ARRAY_TYPE(8);return f[0]=e,f[1]=t,f[2]=n,f[3]=r,f[4]=s,f[5]=l,f[6]=c,f[7]=h,f},qe.fromRotationTranslationValues=function(e,t,n,r,s,l,c){var h=new so.ARRAY_TYPE(8);h[0]=e,h[1]=t,h[2]=n,h[3]=r;var f=.5*s,p=.5*l,m=.5*c;return h[4]=f*r+p*n-m*t,h[5]=p*r+m*e-f*n,h[6]=m*r+f*t-p*e,h[7]=-f*e-p*t-m*n,h},qe.fromRotationTranslation=V1,qe.fromTranslation=function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},qe.fromRotation=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},qe.fromMat4=function(e,t){var n=Vs.create();B1.getRotation(n,t);var r=new so.ARRAY_TYPE(3);return B1.getTranslation(r,t),V1(e,n,r),e},qe.copy=Mp,qe.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},qe.set=function(e,t,n,r,s,l,c,h,f){return e[0]=t,e[1]=n,e[2]=r,e[3]=s,e[4]=l,e[5]=c,e[6]=h,e[7]=f,e},qe.getDual=function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},qe.setDual=function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},qe.getTranslation=function(e,t){var n=t[4],r=t[5],s=t[6],l=t[7],c=-t[0],h=-t[1],f=-t[2],p=t[3];return e[0]=2*(n*p+l*c+r*f-s*h),e[1]=2*(r*p+l*h+s*c-n*f),e[2]=2*(s*p+l*f+n*h-r*c),e},qe.translate=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=.5*n[0],f=.5*n[1],p=.5*n[2],m=t[4],_=t[5],y=t[6],v=t[7];return e[0]=r,e[1]=s,e[2]=l,e[3]=c,e[4]=c*h+s*p-l*f+m,e[5]=c*f+l*h-r*p+_,e[6]=c*p+r*f-s*h+y,e[7]=-r*h-s*f-l*p+v,e},qe.rotateX=function(e,t,n){var r=-t[0],s=-t[1],l=-t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=h*c+m*r+f*l-p*s,y=f*c+m*s+p*r-h*l,v=p*c+m*l+h*s-f*r,b=m*c-h*r-f*s-p*l;return Vs.rotateX(e,t,n),e[4]=_*(c=e[3])+b*(r=e[0])+y*(l=e[2])-v*(s=e[1]),e[5]=y*c+b*s+v*r-_*l,e[6]=v*c+b*l+_*s-y*r,e[7]=b*c-_*r-y*s-v*l,e},qe.rotateY=function(e,t,n){var r=-t[0],s=-t[1],l=-t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=h*c+m*r+f*l-p*s,y=f*c+m*s+p*r-h*l,v=p*c+m*l+h*s-f*r,b=m*c-h*r-f*s-p*l;return Vs.rotateY(e,t,n),e[4]=_*(c=e[3])+b*(r=e[0])+y*(l=e[2])-v*(s=e[1]),e[5]=y*c+b*s+v*r-_*l,e[6]=v*c+b*l+_*s-y*r,e[7]=b*c-_*r-y*s-v*l,e},qe.rotateZ=function(e,t,n){var r=-t[0],s=-t[1],l=-t[2],c=t[3],h=t[4],f=t[5],p=t[6],m=t[7],_=h*c+m*r+f*l-p*s,y=f*c+m*s+p*r-h*l,v=p*c+m*l+h*s-f*r,b=m*c-h*r-f*s-p*l;return Vs.rotateZ(e,t,n),e[4]=_*(c=e[3])+b*(r=e[0])+y*(l=e[2])-v*(s=e[1]),e[5]=y*c+b*s+v*r-_*l,e[6]=v*c+b*l+_*s-y*r,e[7]=b*c-_*r-y*s-v*l,e},qe.rotateByQuatAppend=function(e,t,n){var r=n[0],s=n[1],l=n[2],c=n[3],h=t[0],f=t[1],p=t[2],m=t[3];return e[0]=h*c+m*r+f*l-p*s,e[1]=f*c+m*s+p*r-h*l,e[2]=p*c+m*l+h*s-f*r,e[3]=m*c-h*r-f*s-p*l,e[4]=(h=t[4])*c+(m=t[7])*r+(f=t[5])*l-(p=t[6])*s,e[5]=f*c+m*s+p*r-h*l,e[6]=p*c+m*l+h*s-f*r,e[7]=m*c-h*r-f*s-p*l,e},qe.rotateByQuatPrepend=function(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=n[0],f=n[1],p=n[2],m=n[3];return e[0]=r*m+c*h+s*p-l*f,e[1]=s*m+c*f+l*h-r*p,e[2]=l*m+c*p+r*f-s*h,e[3]=c*m-r*h-s*f-l*p,e[4]=r*(m=n[7])+c*(h=n[4])+s*(p=n[6])-l*(f=n[5]),e[5]=s*m+c*f+l*h-r*p,e[6]=l*m+c*p+r*f-s*h,e[7]=c*m-r*h-s*f-l*p,e},qe.rotateAroundAxis=function(e,t,n,r){if(Math.abs(r)<so.EPSILON)return Mp(e,t);var s=Math.hypot(n[0],n[1],n[2]);r*=.5;var l=Math.sin(r),c=l*n[0]/s,h=l*n[1]/s,f=l*n[2]/s,p=Math.cos(r),m=t[0],_=t[1],y=t[2],v=t[3];e[0]=m*p+v*c+_*f-y*h,e[1]=_*p+v*h+y*c-m*f,e[2]=y*p+v*f+m*h-_*c,e[3]=v*p-m*c-_*h-y*f;var b=t[4],E=t[5],D=t[6],T=t[7];return e[4]=b*p+T*c+E*f-D*h,e[5]=E*p+T*h+D*c-b*f,e[6]=D*p+T*f+b*h-E*c,e[7]=T*p-b*c-E*h-D*f,e},qe.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e},qe.multiply=Us,qe.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e},qe.lerp=function(e,t,n,r){var s=1-r;return Tu(t,n)<0&&(r=-r),e[0]=t[0]*s+n[0]*r,e[1]=t[1]*s+n[1]*r,e[2]=t[2]*s+n[2]*r,e[3]=t[3]*s+n[3]*r,e[4]=t[4]*s+n[4]*r,e[5]=t[5]*s+n[5]*r,e[6]=t[6]*s+n[6]*r,e[7]=t[7]*s+n[7]*r,e},qe.invert=function(e,t){var n=nd(t);return e[0]=-t[0]/n,e[1]=-t[1]/n,e[2]=-t[2]/n,e[3]=t[3]/n,e[4]=-t[4]/n,e[5]=-t[5]/n,e[6]=-t[6]/n,e[7]=t[7]/n,e},qe.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},qe.normalize=function(e,t){var n=nd(t);if(n>0){n=Math.sqrt(n);var r=t[0]/n,s=t[1]/n,l=t[2]/n,c=t[3]/n,h=t[4],f=t[5],p=t[6],m=t[7],_=r*h+s*f+l*p+c*m;e[0]=r,e[1]=s,e[2]=l,e[3]=c,e[4]=(h-r*_)/n,e[5]=(f-s*_)/n,e[6]=(p-l*_)/n,e[7]=(m-c*_)/n}return e},qe.str=function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},qe.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},qe.equals=function(e,t){var n=e[0],r=e[1],s=e[2],l=e[3],c=e[4],h=e[5],f=e[6],p=e[7],m=t[0],_=t[1],y=t[2],v=t[3],b=t[4],E=t[5],D=t[6],T=t[7];return Math.abs(n-m)<=so.EPSILON*Math.max(1,Math.abs(n),Math.abs(m))&&Math.abs(r-_)<=so.EPSILON*Math.max(1,Math.abs(r),Math.abs(_))&&Math.abs(s-y)<=so.EPSILON*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(l-v)<=so.EPSILON*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(c-b)<=so.EPSILON*Math.max(1,Math.abs(c),Math.abs(b))&&Math.abs(h-E)<=so.EPSILON*Math.max(1,Math.abs(h),Math.abs(E))&&Math.abs(f-D)<=so.EPSILON*Math.max(1,Math.abs(f),Math.abs(D))&&Math.abs(p-T)<=so.EPSILON*Math.max(1,Math.abs(p),Math.abs(T))},qe.sqrLen=qe.squaredLength=qe.len=qe.length=qe.dot=qe.mul=qe.setReal=qe.getReal=void 0;var so=P_(Fr),Vs=P_(ge),B1=P_(we);function j1(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(j1=function(r){return r?n:t})(e)}function P_(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==N1(e)&&"function"!=typeof e)return{default:e};var n=j1(t);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}function V1(e,t,n){var r=.5*n[0],s=.5*n[1],l=.5*n[2],c=t[0],h=t[1],f=t[2],p=t[3];return e[0]=c,e[1]=h,e[2]=f,e[3]=p,e[4]=r*p+s*f-l*h,e[5]=s*p+l*c-r*f,e[6]=l*p+r*h-s*c,e[7]=-r*c-s*h-l*f,e}function Mp(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}function Us(e,t,n){var r=t[0],s=t[1],l=t[2],c=t[3],h=n[4],f=n[5],p=n[6],m=n[7],_=t[4],y=t[5],v=t[6],b=t[7],E=n[0],D=n[1],T=n[2],C=n[3];return e[0]=r*C+c*E+s*T-l*D,e[1]=s*C+c*D+l*E-r*T,e[2]=l*C+c*T+r*D-s*E,e[3]=c*C-r*E-s*D-l*T,e[4]=r*m+c*h+s*p-l*f+_*C+b*E+y*T-v*D,e[5]=s*m+c*f+l*h-r*p+y*C+b*D+v*E-_*T,e[6]=l*m+c*p+r*f-s*h+v*C+b*T+_*D-y*E,e[7]=c*m-r*h-s*f-l*p+b*C-_*E-y*D-v*T,e}qe.getReal=Vs.copy,qe.setReal=Vs.copy,qe.mul=Us;var Tu=Vs.dot;qe.dot=Tu;var R_=Vs.length;qe.length=R_,qe.len=R_;var nd=Vs.squaredLength;qe.squaredLength=nd,qe.sqrLen=nd;var Me={};function U1(e){return(U1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(Me,"__esModule",{value:!0}),Me.create=Ip,Me.clone=function(e){var t=new Du.ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},Me.fromValues=function(e,t){var n=new Du.ARRAY_TYPE(2);return n[0]=e,n[1]=t,n},Me.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},Me.set=function(e,t,n){return e[0]=t,e[1]=n,e},Me.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},Me.subtract=Ap,Me.multiply=JD,Me.divide=QD,Me.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},Me.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},Me.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},Me.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},Me.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},Me.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},Me.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},Me.distance=L_,Me.squaredDistance=$1,Me.length=H1,Me.squaredLength=G1,Me.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},Me.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},Me.normalize=function(e,t){var n=t[0],r=t[1],s=n*n+r*r;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e},Me.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},Me.cross=function(e,t,n){var r=t[0]*n[1]-t[1]*n[0];return e[0]=e[1]=0,e[2]=r,e},Me.lerp=function(e,t,n,r){var s=t[0],l=t[1];return e[0]=s+r*(n[0]-s),e[1]=l+r*(n[1]-l),e},Me.random=function(e,t){t=t||1;var n=2*Du.RANDOM()*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},Me.transformMat2=function(e,t,n){var r=t[0],s=t[1];return e[0]=n[0]*r+n[2]*s,e[1]=n[1]*r+n[3]*s,e},Me.transformMat2d=function(e,t,n){var r=t[0],s=t[1];return e[0]=n[0]*r+n[2]*s+n[4],e[1]=n[1]*r+n[3]*s+n[5],e},Me.transformMat3=function(e,t,n){var r=t[0],s=t[1];return e[0]=n[0]*r+n[3]*s+n[6],e[1]=n[1]*r+n[4]*s+n[7],e},Me.transformMat4=function(e,t,n){var r=t[0],s=t[1];return e[0]=n[0]*r+n[4]*s+n[12],e[1]=n[1]*r+n[5]*s+n[13],e},Me.rotate=function(e,t,n,r){var s=t[0]-n[0],l=t[1]-n[1],c=Math.sin(r),h=Math.cos(r);return e[0]=s*h-l*c+n[0],e[1]=s*c+l*h+n[1],e},Me.angle=function(e,t){var n=e[0],r=e[1],s=t[0],l=t[1],c=Math.sqrt(n*n+r*r)*Math.sqrt(s*s+l*l);return Math.acos(Math.min(Math.max(c&&(n*s+r*l)/c,-1),1))},Me.zero=function(e){return e[0]=0,e[1]=0,e},Me.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},Me.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]},Me.equals=function(e,t){var n=e[0],r=e[1],s=t[0],l=t[1];return Math.abs(n-s)<=Du.EPSILON*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-l)<=Du.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))},Me.forEach=Me.sqrLen=Me.sqrDist=Me.dist=Me.div=Me.mul=Me.sub=Me.len=void 0;var Du=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==U1(e)&&"function"!=typeof e)return{default:e};var n=KD(void 0);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}(Fr);function KD(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(KD=function(r){return r?n:t})(e)}function Ip(){var e=new Du.ARRAY_TYPE(2);return Du.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e}function Ap(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function JD(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e}function QD(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e}function L_(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1])}function $1(e,t){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function H1(e){return Math.hypot(e[0],e[1])}function G1(e){var t=e[0],n=e[1];return t*t+n*n}Me.len=H1,Me.sub=Ap,Me.mul=JD,Me.div=QD,Me.dist=L_,Me.sqrDist=$1,Me.sqrLen=G1;var tS=function(){var e=Ip();return function(t,n,r,s,l,c){var h,f;for(n||(n=2),r||(r=0),f=s?Math.min(s*n+r,t.length):t.length,h=r;h<f;h+=n)e[0]=t[h],e[1]=t[h+1],l(e,e,c),t[h]=e[0],t[h+1]=e[1];return t}}();function Pp(e){return(Pp="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Me.forEach=tS,Object.defineProperty(Sr,"__esModule",{value:!0});var an=Sr.vec4=H=Sr.vec3=Sr.vec2=Sr.quat2=Zr=Sr.quat=et=Sr.mat4=ji=Sr.mat3=Sr.mat2d=Su=Sr.mat2=Sr.glMatrix=void 0,eS=ko(Fr);Sr.glMatrix=eS;var k_=ko(Hn),Su=Sr.mat2=k_,Vr=ko(Zn);Sr.mat2d=Vr;var nS=ko(fn),ji=Sr.mat3=nS,O_=ko(we),et=Sr.mat4=O_,rS=ko(ge),Zr=Sr.quat=rS,iS=ko(qe);Sr.quat2=iS;var oS=ko(Me);Sr.vec2=oS;var sS=ko(ve),H=Sr.vec3=sS,mA=ko(Pe);function Cu(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(Cu=function(r){return r?n:t})(e)}function ko(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==Pp(e)&&"function"!=typeof e)return{default:e};var n=Cu(t);if(n&&n.has(e))return n.get(e);var r={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var c=s?Object.getOwnPropertyDescriptor(e,l):null;c&&(c.get||c.set)?Object.defineProperty(r,l,c):r[l]=e[l]}return r.default=e,n&&n.set(e,r),r}an=Sr.vec4=mA;const q1=sn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:rd}=q1,F_=sn([{name:"a_pos_3",components:3,type:"Int16"}]);var _l=sn([{name:"a_pos",type:"Int16",components:2}]),z_={};!function(n){function r(l,c,h){var f=s(256*l,256*(c=Math.pow(2,h)-c-1),h),p=s(256*(l+1),256*(c+1),h);return f[0]+","+f[1]+","+p[0]+","+p[1]}function s(l,c,h){var f=2*Math.PI*6378137/256/Math.pow(2,h);return[l*f-2*Math.PI*6378137/2,c*f-2*Math.PI*6378137/2]}n.getURL=function(l,c,h,f,p,m){return m=m||{},l+"?"+["bbox="+r(h,f,p),"format="+(m.format||"image/png"),"service="+(m.service||"WMS"),"version="+(m.version||"1.1.1"),"request="+(m.request||"GetMap"),"srs="+(m.srs||"EPSG:3857"),"width="+(m.width||256),"height="+(m.height||256),"layers="+c].join("&")},n.getTileBBox=r,n.getMercCoords=s,Object.defineProperty(n,"__esModule",{value:!0})}(z_);var W1=z_;class Oo{constructor(t,n,r){this.z=t,this.x=n,this.y=r,this.key=gc(0,t,t,n,r)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,n){const r=W1.getTileBBox(this.x,this.y,this.z),s=function(l,c,h){let f,p="";for(let m=l;m>0;m--)f=1<<m-1,p+=(c&f?1:0)+(h&f?2:0);return p}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===n?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",s).replace("{bbox-epsg-3857}",r)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Z1{constructor(t,n){this.wrap=t,this.canonical=n,this.key=gc(t,n.z,n.z,n.x,n.y)}}class tn{constructor(t,n,r,s,l){this.overscaledZ=t,this.wrap=n,this.canonical=new Oo(r,+s,+l),this.key=0===n&&t===r?this.canonical.key:gc(n,t,r,s,l)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const n=this.canonical.z-t;return t>this.canonical.z?new tn(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new tn(t,this.wrap,t,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(t,n=!0){if(this.overscaledZ===t&&n)return this.key;if(t>this.canonical.z)return gc(this.wrap*+n,t,this.canonical.z,this.canonical.x,this.canonical.y);{const r=this.canonical.z-t;return gc(this.wrap*+n,t,t,this.canonical.x>>r,this.canonical.y>>r)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const n=this.canonical.z-t.canonical.z;return 0===t.overscaledZ||t.overscaledZ<this.overscaledZ&&t.canonical.z<this.canonical.z&&t.canonical.x===this.canonical.x>>n&&t.canonical.y===this.canonical.y>>n}children(t){if(this.overscaledZ>=t)return[new tn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const n=this.canonical.z+1,r=2*this.canonical.x,s=2*this.canonical.y;return[new tn(n,this.wrap,n,r,s),new tn(n,this.wrap,n,r+1,s),new tn(n,this.wrap,n,r,s+1),new tn(n,this.wrap,n,r+1,s+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new tn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new tn(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Z1(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function gc(e,t,n,r,s){const l=1<<Math.min(n,22);let c=l*(s%l)+r%l;return e&&n<22&&(c+=l*l*((e<0?-2*e-1:2*e)%(1<<2*(22-n)))),16*(32*c+n)+(t-n)}const N_=[e=>{let t=e.canonical.x-1,n=e.wrap;return t<0&&(t=(1<<e.canonical.z)-1,n--),new tn(e.overscaledZ,n,e.canonical.z,t,e.canonical.y)},e=>{let t=e.canonical.x+1,n=e.wrap;return t===1<<e.canonical.z&&(t=0,n++),new tn(e.overscaledZ,n,e.canonical.z,t,e.canonical.y)},e=>new tn(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,(0===e.canonical.y?1<<e.canonical.z:e.canonical.y)-1),e=>new tn(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y===(1<<e.canonical.z)-1?0:e.canonical.y+1)];jt(Oo,"CanonicalTileID"),jt(tn,"OverscaledTileID",{omit:["projMatrix"]});class id{constructor(t,n){this.pos=t,this.dir=n}intersectsPlane(t,n,r){const s=H.dot(n,this.dir);if(Math.abs(s)<1e-6)return!1;const l=((t[0]-this.pos[0])*n[0]+(t[1]-this.pos[1])*n[1]+(t[2]-this.pos[2])*n[2])/s;return r[0]=this.pos[0]+this.dir[0]*l,r[1]=this.pos[1]+this.dir[1]*l,r[2]=this.pos[2]+this.dir[2]*l,!0}closestPointOnSphere(t,n,r){if(H.equals(this.pos,t)||0===n)return r[0]=r[1]=r[2]=0,!1;const[s,l,c]=this.dir,h=this.pos[0]-t[0],f=this.pos[1]-t[1],p=this.pos[2]-t[2],m=s*s+l*l+c*c,_=2*(h*s+f*l+p*c),y=_*_-4*m*(h*h+f*f+p*p-n*n);if(y<0){const v=Math.max(-_/2,0),b=h+s*v,E=f+l*v,D=p+c*v,T=Math.hypot(b,E,D);return r[0]=b*n/T,r[1]=E*n/T,r[2]=D*n/T,!1}{const v=(-_-Math.sqrt(y))/(2*m);if(v<0){const b=Math.hypot(h,f,p);return r[0]=h*n/b,r[1]=f*n/b,r[2]=p*n/b,!1}return r[0]=h+s*v,r[1]=f+l*v,r[2]=p+c*v,!0}}}class ba{constructor(t,n,r,s,l){this.TL=t,this.TR=n,this.BR=r,this.BL=s,this.horizon=l}static fromInvProjectionMatrix(t,n,r){const s=[-1,1,1],l=[1,1,1],c=[1,-1,1],h=[-1,-1,1],f=H.transformMat4(s,s,t),p=H.transformMat4(l,l,t),m=H.transformMat4(c,c,t),_=H.transformMat4(h,h,t);return new ba(f,p,m,_,n/r)}}function od(e,t,n){let r=1/0,s=-1/0;const l=[];for(const c of e){H.sub(l,c,t);const h=H.dot(l,n);r=Math.min(r,h),s=Math.max(s,h)}return[r,s]}function Rp(e,t){let n=!0;for(let r=0;r<e.planes.length;r++){const s=e.planes[r];let l=0;for(let c=0;c<t.length;c++)l+=H.dot(s,t[c])+s[3]>=0;if(0===l)return 0;l!==t.length&&(n=!1)}return n?2:1}function sd(e,t){for(const n of e.projections){const r=od(t,e.points[0],n.axis);if(n.projection[1]<r[0]||n.projection[0]>r[1])return 0}return 1}function X1(e,t){let n=0;const r=[0,0,0,0];for(let s=0;s<e.length;s++)r[0]=e[s][0],r[1]=e[s][1],r[2]=e[s][2],r[3]=1,an.dot(r,t)>=0&&n++;return n}class is{constructor(t,n){this.points=t||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=Tn.fromPoints(this.points),this.projections=[],this.frustumEdges=[H.sub([],this.points[2],this.points[3]),H.sub([],this.points[0],this.points[3]),H.sub([],this.points[4],this.points[0]),H.sub([],this.points[5],this.points[1]),H.sub([],this.points[6],this.points[2]),H.sub([],this.points[7],this.points[3])];for(const r of this.frustumEdges){const s=[0,-r[2],r[1]],l=[r[2],0,-r[0]];this.projections.push({axis:s,projection:od(this.points,this.points[0],s)}),this.projections.push({axis:l,projection:od(this.points,this.points[0],l)})}}static fromInvProjectionMatrix(t,n,r,s){const l=Math.pow(2,r),c=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(p=>{const m=an.transformMat4([],p,t),_=1/m[3]/n*l;return an.mul(m,m,[_,_,s?1/m[3]:_,_])}),h=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(p=>{const m=H.sub([],c[p[0]],c[p[1]]),_=H.sub([],c[p[2]],c[p[1]]),y=H.normalize([],H.cross([],m,_)),v=-H.dot(y,c[p[1]]);return y.concat(v)}),f=[];for(let p=0;p<c.length;p++)f.push([c[p][0],c[p][1],c[p][2]]);return new is(f,h)}intersectsPrecise(t,n,r){for(let s=0;s<n.length;s++)if(!X1(t,n[s]))return 0;for(let s=0;s<this.planes.length;s++)if(!X1(t,this.planes[s]))return 0;for(const s of r)for(const l of this.frustumEdges){const c=H.cross([],s,l),h=H.length(c);if(0===h)continue;H.scale(c,c,1/h);const f=od(this.points,this.points[0],c),p=od(t,this.points[0],c);if(f[0]>p[1]||p[0]>f[1])return 0}return 1}}class Tn{static fromPoints(t){const n=[1/0,1/0,1/0],r=[-1/0,-1/0,-1/0];for(const s of t)H.min(n,n,s),H.max(r,r,s);return new Tn(n,r)}static fromTileIdAndHeight(t,n,r){const s=1<<t.canonical.z,l=t.canonical.x,c=t.canonical.y;return new Tn([l/s,c/s,n],[(l+1)/s,(c+1)/s,r])}static applyTransform(t,n){const r=t.getCorners();for(let s=0;s<r.length;++s)H.transformMat4(r[s],r[s],n);return Tn.fromPoints(r)}static projectAabbCorners(t,n){const r=t.getCorners();for(let s=0;s<r.length;++s)H.transformMat4(r[s],r[s],n);return r}constructor(t,n){this.min=t,this.max=n,this.center=H.scale([],H.add([],this.min,this.max),.5)}quadrant(t){const n=[t%2==0,t<2],r=H.clone(this.min),s=H.clone(this.max);for(let l=0;l<n.length;l++)r[l]=n[l]?this.min[l]:this.center[l],s[l]=n[l]?this.center[l]:this.max[l];return s[2]=this.max[2],new Tn(r,s)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,n=this.max;return[[t[0],t[1],t[2]],[n[0],t[1],t[2]],[n[0],n[1],t[2]],[t[0],n[1],t[2]],[t[0],t[1],n[2]],[n[0],t[1],n[2]],[n[0],n[1],n[2]],[t[0],n[1],n[2]]]}intersects(t){return this.intersectsAabb(t.bounds)?Rp(t,this.getCorners()):0}intersectsFlat(t){return this.intersectsAabb(t.bounds)?Rp(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(t,n){return n||this.intersects(t)?sd(t,this.getCorners()):0}intersectsPreciseFlat(t,n){return n||this.intersectsFlat(t)?sd(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(t){for(let n=0;n<3;++n)if(this.min[n]>t.max[n]||t.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(t){return!(this.min[0]>t.max[0]||t.min[0]>this.max[0]||this.min[1]>t.max[1]||t.min[1]>this.max[1])}encapsulate(t){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],t.min[n]),this.max[n]=Math.max(this.max[n],t.max[n])}encapsulatePoint(t){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],t[n]),this.max[n]=Math.max(this.max[n],t[n])}closestPoint(t){return[Math.max(Math.min(this.max[0],t[0]),this.min[0]),Math.max(Math.min(this.max[1],t[1]),this.min[1]),Math.max(Math.min(this.max[2],t[2]),this.min[2])]}}jt(Tn,"Aabb");const ei=st/Math.PI/2,Lp=[64,32,16],pi=-ei,zo=ei,lS=[new Tn([pi,pi,pi],[zo,zo,zo]),new Tn([pi,pi,pi],[0,0,zo]),new Tn([0,pi,pi],[zo,0,zo]),new Tn([pi,0,pi],[0,zo,zo]),new Tn([0,0,pi],[zo,zo,zo])];function kp(e){return e*ei/ss}function Y1(e,t,n,r=!0){const s=H.scale([],e._camera.position,e.worldSize),l=[t,n,1,1];an.transformMat4(l,l,e.pixelMatrixInverse),an.scale(l,l,1/l[3]);const c=H.sub([],l,s),h=H.normalize([],c),f=e.globeMatrix,p=[f[12],f[13],f[14]],m=H.sub([],p,s),_=H.length(m),y=H.normalize([],m),v=e.worldSize/(2*Math.PI),b=H.dot(y,h),E=Math.asin(v/_);if(E<Math.acos(b)){if(!r)return null;const V=[],B=[];H.scale(V,h,_/b),H.normalize(B,H.sub(B,V,m)),H.normalize(h,H.add(h,m,H.scale(h,B,Math.tan(E)*_)))}const D=[];new id(s,h).closestPointOnSphere(p,v,D);const T=H.normalize([],Yn(f,0)),C=H.normalize([],Yn(f,1)),I=H.normalize([],Yn(f,2)),A=H.dot(T,D),M=H.dot(C,D),R=H.dot(I,D),L=xr(Math.asin(-M/v));let O=xr(Math.atan2(A,R));O=e.center.lng+function(V,B){const $=(B-V+180)%360-180;return $<-180?$+360:$}(e.center.lng,O);const z=Xr(O),N=Gt(Ur(L),0,1);return new He(z,N)}class B_{constructor(t,n,r){this.a=H.sub([],t,r),this.b=H.sub([],n,r),this.center=r;const s=H.normalize([],this.a),l=H.normalize([],this.b);this.angle=Math.acos(H.dot(s,l))}}function j_(e,t){if(0===e.angle)return null;let n;return n=0===e.a[t]?1/e.angle*.5*Math.PI:1/e.angle*Math.atan(e.b[t]/e.a[t]/Math.sin(e.angle)-1/Math.tan(e.angle)),n<0||n>1?null:function(r,s,l,c){const h=Math.sin(l);return r*(Math.sin((1-c)*l)/h)+s*(Math.sin(c*l)/h)}(e.a[t],e.b[t],e.angle,Gt(n,0,1))+e.center[t]}function wo(e){if(e.z<=1)return lS[e.z+2*e.y+e.x];const t=$_(yl(e));return Tn.fromPoints(t)}function Ea(e,t,n){return H.scale(e,e,1-n),H.scaleAndAdd(e,e,t,n)}function V_(e,t){const n=Mr(t.zoom);if(0===n)return wo(e);const r=yl(e),s=$_(r),l=Xr(r.getWest())*t.worldSize,c=Xr(r.getEast())*t.worldSize,h=Ur(r.getNorth())*t.worldSize,f=Ur(r.getSouth())*t.worldSize,p=[l,h,0],m=[c,h,0],_=[l,f,0],y=[c,f,0],v=et.invert([],t.globeMatrix);return H.transformMat4(p,p,v),H.transformMat4(m,m,v),H.transformMat4(_,_,v),H.transformMat4(y,y,v),s[0]=Ea(s[0],_,n),s[1]=Ea(s[1],y,n),s[2]=Ea(s[2],m,n),s[3]=Ea(s[3],p,n),Tn.fromPoints(s)}function cS(e,t,n){for(const r of e)H.transformMat4(r,r,t),H.scale(r,r,n)}function U_(e,t,n,r){const s=t/e.worldSize,l=e.globeMatrix;if(n.z<=1){const z=wo(n).getCorners();return cS(z,l,s),Tn.fromPoints(z)}const c=yl(n,r),h=$_(c);cS(h,l,s);const f=Number.MAX_VALUE,p=[-f,-f,-f],m=[f,f,f];if(c.contains(e.center)){for(const V of h)H.min(m,m,V),H.max(p,p,V);p[2]=0;const z=e.point,N=[z.x*s,z.y*s,0];return H.min(m,m,N),H.max(p,p,N),new Tn(m,p)}const _=[l[12]*s,l[13]*s,l[14]*s],y=c.getCenter(),v=Gt(e.center.lat,-nr,nr),b=Gt(y.lat,-nr,nr),E=Xr(e.center.lng),D=Ur(v);let T=E-Xr(y.lng);const C=D-Ur(b);T>.5?T-=1:T<-.5&&(T+=1);let I=0;if(Math.abs(T)>Math.abs(C))I=T>=0?1:3;else{I=C>=0?0:2;const z=[l[4]*s,l[5]*s,l[6]*s],N=-Math.sin(be(C>=0?c.getSouth():c.getNorth()))*ei;H.scaleAndAdd(_,_,z,N)}const A=h[I],M=h[(I+1)%4],R=new B_(A,M,_),L=[j_(R,0)||A[0],j_(R,1)||A[1],j_(R,2)||A[2]],O=Mr(e.zoom);if(O>0){const z=function({x:V,y:B,z:$},j,Z,K,Q){const W=1/(1<<$);let X=V*W,nt=X+W,ot=B*W,lt=ot+W,ht=0;const ft=(X+nt)/2-K;return ft>.5?ht=-1:ft<-.5&&(ht=1),X=((X+ht)*j-(K*=j))*Z+K,nt=((nt+ht)*j-K)*Z+K,ot=(ot*j-(Q*=j))*Z+Q,lt=(lt*j-Q)*Z+Q,[[X,lt,0],[nt,lt,0],[nt,ot,0],[X,ot,0]]}(n,t,e._pixelsPerMercatorPixel,E,D);for(let V=0;V<h.length;V++)Ea(h[V],z[V],O);const N=H.add([],z[I],z[(I+1)%4]);H.scale(N,N,.5),Ea(L,N,O)}for(const z of h)H.min(m,m,z),H.max(p,p,z);return m[2]=Math.min(A[2],M[2]),H.min(m,m,L),H.max(p,p,L),new Tn(m,p)}function yl({x:e,y:t,z:n},r=!1){const s=1/(1<<n),l=new ce(Vi(e*s),t===(1<<n)-1&&r?-90:dr((t+1)*s)),c=new ce(Vi((e+1)*s),0===t&&r?90:dr(t*s));return new fi(l,c)}function $_(e){const t=be(e.getNorth()),n=be(e.getSouth()),r=Math.cos(t),s=Math.cos(n),l=Math.sin(t),c=Math.sin(n),h=e.getWest(),f=e.getEast();return[os(s,c,h),os(s,c,f),os(r,l,f),os(r,l,h)]}function os(e,t,n,r=ei){return n=be(n),[e*Math.sin(n)*r,-t*r,e*Math.cos(n)*r]}function Cr(e,t,n){return os(Math.cos(be(e)),Math.sin(be(e)),t,n)}function ad(e,t,n,r){const s=1<<n.z,l=(e/st+n.x)/s;return Cr(dr((t/st+n.y)/s),Vi(l),r)}function H_({min:e,max:t}){return 16383/Math.max(t[0]-e[0],t[1]-e[1],t[2]-e[2])}const G_=new Float64Array(16);function $s(e){const t=H_(e),n=et.fromScaling(G_,[t,t,t]);return et.translate(n,n,H.negate([],e.min))}function q_(e){const t=et.fromTranslation(G_,e.min),n=1/H_(e);return et.scale(t,t,[n,n,n])}function W_(e){const t=st/(2*Math.PI);return e/(2*Math.PI)/t}function ld(e,t){return st/(512*Math.pow(2,e))*H_(wo(t))}function K1(e,t,n,r,s){const l=W_(n),c=[e,t,-n/(2*Math.PI)],h=et.identity(new Float64Array(16));return et.translate(h,h,c),et.scale(h,h,[l,l,l]),et.rotateX(h,h,be(-s)),et.rotateY(h,h,be(-r)),h}function Mr(e){return Ts(5,6,e)}function Op(e,t,n){const r=et.identity(new Float64Array(16)),s=(t/(1<<e)-.5)*Math.PI*2;return et.rotateY(r,n.globeMatrix,s),Float32Array.from(r)}function J1(e,t,n){const r=Mr(n.zoom),s=e.style.map._antialias,l=t.extStandardDerivativesForceOff||e.terrain&&e.terrain.exaggeration()>0;return 0===r&&!s&&!l}function Z_(e,t,n,r){const s=t.getNorth(),l=t.getSouth(),c=t.getWest(),h=t.getEast(),f=1<<e.z,p=h-c,m=s-l,_=p/64,y=-m/Lp[n],v=[0,_,0,y,0,0,s,c,0];if(e.z>0){const b=180/r;ji.multiply(v,v,[b/p+1,0,0,0,b/m+1,0,-.5*b/_,.5*b/y,1])}return v[2]=f,v[5]=e.x,v[8]=e.y,v}function Iu(e){const t=nr-5;e=Gt(e,-t,t)/t*90;const n=Math.pow(Math.abs(Math.sin(be(e))),3);return Math.round(n*(Lp.length-1))}function Q1(e){const t=[0,0,0],n=et.identity(new Float64Array(16));return et.multiply(n,e.pixelMatrix,e.globeMatrix),H.transformMat4(t,t,n),new tt(t[0],t[1])}function tb(e,t){const n=Cr(t.lat,t.lng),r=function(l){const c=Cr(l._center.lat,l._center.lng),h=H.fromValues(0,1,0);let f=H.cross([],h,c);const p=et.fromRotation([],-l.angle,c);f=H.transformMat4(f,f,p),et.fromRotation(p,-l._pitch,f);const m=H.normalize([],c);return H.scale(m,m,kp(l.cameraToCenterDistance/l.pixelsPerMeter)),H.transformMat4(m,m,p),H.add([],c,m)}(e),s=H.subtract([],r,n);return H.angle(s,n)}function Fp(e,t){return tb(e,t)>Math.PI/2*1.01}const eb=be(85),uS=Math.cos(eb),hS=Math.sin(eb);class dS{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy()}_fillGridMeshWithLods(t,n){const r=new ro,s=new er,l=[],c=t+1+2,h=n[0]+1,f=n[0]+1+(1+n.length),p=(m,_,y)=>{let v=m===c-1?m-2:0===m?m:m-1;return v+=y?24575:0,[v,_]};for(let m=0;m<c;++m)r.emplaceBack(...p(m,0,!0));for(let m=0;m<h;++m)for(let _=0;_<c;++_)r.emplaceBack(...p(_,m,(0===_||_===c-1)&&!0));for(let m=0;m<n.length;++m){const _=n[m];for(let y=0;y<c;++y)r.emplaceBack(...p(y,_,!0))}for(let m=0;m<n.length;++m){const _=s.length,y=n[m]+1+2,v=new er;for(let D=0;D<y-1;D++){const T=D===y-2,C=T?c*(f-n.length+m-D):c;for(let I=0;I<c-1;I++){const A=D*c+I;0===D||T||0===I||I===c-2?(v.emplaceBack(A+1,A,A+C),v.emplaceBack(A+C,A+C+1,A+1)):(s.emplaceBack(A+1,A,A+C),s.emplaceBack(A+C,A+C+1,A+1))}}const b=ln.simpleSegment(0,_,r.length,s.length-_);for(let D=0;D<v.uint16.length;D+=3)s.emplaceBack(v.uint16[D],v.uint16[D+1],v.uint16[D+2]);const E=ln.simpleSegment(0,_,r.length,s.length-_);l.push({withoutSkirts:b,withSkirts:E})}return{vertices:r,indices:s,segments:l}}_createGrid(t){const n=this._fillGridMeshWithLods(64,Lp);this._gridSegments=n.segments,this._gridBuffer=t.createVertexBuffer(n.vertices,_l.members),this._gridIndexBuffer=t.createIndexBuffer(n.indices,!0)}_createPoles(t){const n=new er;for(let h=0;h<=64;h++)n.emplaceBack(0,h+1,h+2);this._poleIndexBuffer=t.createIndexBuffer(n,!0);const r=new ma,s=new ma,l=new ma,c=new ma;this._poleSegments=[];for(let h=0,f=0;h<5;h++){const p=360/(1<<h);r.emplaceBack(0,-ei,0,.5,0),s.emplaceBack(0,-ei,0,.5,1),l.emplaceBack(0,-ei,0,.5,.5),c.emplaceBack(0,-ei,0,.5,.5);for(let m=0;m<=64;m++){let _=m/64,y=0;const v=de(0,p,_),[b,E,D]=os(uS,hS,v,ei);r.emplaceBack(b,E,D,_,y),s.emplaceBack(b,E,D,_,1-y);const T=be(v);_=.5+.5*Math.sin(T),y=.5+.5*Math.cos(T),l.emplaceBack(b,E,D,_,y),c.emplaceBack(b,E,D,_,1-y)}this._poleSegments.push(ln.simpleSegment(f,0,66,64)),f+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(r,rd,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(s,rd,!1),this._texturedPoleNorthVertexBuffer=t.createVertexBuffer(l,rd,!1),this._texturedPoleSouthVertexBuffer=t.createVertexBuffer(c,rd,!1)}getGridBuffers(t,n){return[this._gridBuffer,this._gridIndexBuffer,n?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t,n){return[n?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,n?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}}const ss=6371008.8,as=2*Math.PI*ss;class vl{constructor(t,n){if(isNaN(t)||isNaN(n))throw new Error(`Invalid LngLat object: (${t}, ${n})`);if(this.lng=+t,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new vl(Ds(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const n=Math.PI/180,r=this.lat*n,s=t.lat*n,l=Math.sin(r)*Math.sin(s)+Math.cos(r)*Math.cos(s)*Math.cos((t.lng-this.lng)*n);return ss*Math.acos(Math.min(l,1))}toBounds(t=0){const n=360*t/40075017,r=n/Math.cos(Math.PI/180*this.lat);return new fi(new vl(this.lng-r,this.lat-n),new vl(this.lng+r,this.lat+n))}toEcef(t){const n=kp(t);return Cr(this.lat,this.lng,ei+n)}static convert(t){if(t instanceof vl)return t;if(Array.isArray(t)&&(2===t.length||3===t.length))return new vl(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&"object"==typeof t&&null!==t)return new vl(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}var ce=vl;function cd(e){return as*Math.cos(e*Math.PI/180)}function Xr(e){return(180+e)/360}function Ur(e){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360}function gn(e,t){return e/cd(t)}function Vi(e){return 360*e-180}function dr(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function X_(e,t){return e*cd(dr(t))}const nr=85.051129;function nb(e){return Math.cos(be(Gt(e,-nr,nr)))}function ni(e,t){const n=Gt(t,0,25.5),r=Math.pow(2,n);return nb(e)*as/(512*r)}function Y_(e){return 1/Math.cos(e*Math.PI/180)}function Au(e,t=0){const n=Math.exp(Math.PI*(1-(e.y+t/st)/(1<<e.z)*2));return 80150034*n/(n*n+1)/st/(1<<e.z)}class He{constructor(t,n,r=0){this.x=+t,this.y=+n,this.z=+r}static fromLngLat(t,n=0){const r=ce.convert(t);return new He(Xr(r.lng),Ur(r.lat),gn(n,r.lat))}toLngLat(){return new ce(Vi(this.x),dr(this.y))}toAltitude(){return X_(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/as*Y_(dr(this.y))}}function K_(e,t,n,r,s,l,c,h,f){const p=(t+r)/2,m=(n+s)/2,_=new tt(p,m);h(_),function(y,v,b,E,D,T){const C=b-D,I=E-T;return Math.abs((E-v)*C-(b-y)*I)/Math.hypot(C,I)}(_.x,_.y,l.x,l.y,c.x,c.y)>=f?(K_(e,t,n,p,m,l,_,h,f),K_(e,p,m,r,s,_,c,h,f)):e.push(c)}function rb(e,t,n){let r=e[0],s=r.x,l=r.y;t(r);const c=[r];for(let h=1;h<e.length;h++){const f=e[h],{x:p,y:m}=f;t(f),K_(c,s,l,p,m,r,f,t,n),s=p,l=m,r=f}return c}function J_(e,t,n,r){if(r(t,n)){const s=t.add(n)._mult(.5);J_(e,t,s,r),J_(e,s,n,r)}else e.push(n)}function ib(e,t){let n=e[0];const r=[n];for(let s=1;s<e.length;s++){const l=e[s];J_(r,n,l,t),n=l}return r}const Q_=Math.pow(2,14)-1,ob=-Q_-1;function fS(e,t){const n=Math.round(e.x*t),r=Math.round(e.y*t);return e.x=Gt(n,ob,Q_),e.y=Gt(r,ob,Q_),(n<e.x||n>e.x+1||r<e.y||r>e.y+1)&&Y("Geometry exceeds allowed extent, reduce your vector tile buffer size"),e}function ze(e,t,n){const r=e.loadGeometry(),s=e.extent,l=st/s;if(t&&n&&n.projection.isReprojectedInTileSpace){const c=1<<t.z,{scale:h,x:f,y:p,projection:m}=n,_=y=>{const v=Vi((t.x+y.x/s)/c),b=dr((t.y+y.y/s)/c),E=m.project(v,b);y.x=(E.x*h-f)*s,y.y=(E.y*h-p)*s};for(let y=0;y<r.length;y++)if(1!==e.type)r[y]=rb(r[y],_,1);else{const v=[];for(const b of r[y])b.x<0||b.x>=s||b.y<0||b.y>=s||(_(b),v.push(b));r[y]=v}}for(const c of r)for(const h of c)fS(h,l);return r}function xl(e,t){return{type:e.type,id:e.id,properties:e.properties,geometry:t?ze(e):[]}}function ud(e,t,n,r,s){e.emplaceBack(2*t+(r+1)/2,2*n+(s+1)/2)}function hd(e,t,n){e.emplaceBack(t.x,t.y,t.z,16384*n[0],16384*n[1],16384*n[2])}class ty{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new ro,this.indexArray=new er,this.segments=new ln,this.programConfigurations=new pl(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,r,s){const l=this.layers[0],c=[];let h=null;"circle"===l.type&&(h=l.layout.get("circle-sort-key"));for(const{feature:p,id:m,index:_,sourceLayerIndex:y}of t){const v=this.layers[0]._featureFilter.needGeometry,b=xl(p,v);if(!this.layers[0]._featureFilter.filter(new Gn(this.zoom),b,r))continue;const E=h?h.evaluate(b,{},r):void 0,D={id:m,properties:p.properties,type:p.type,sourceLayerIndex:y,index:_,geometry:v?b.geometry:ze(p,r,s),patterns:{},sortKey:E};c.push(D)}h&&c.sort((p,m)=>p.sortKey-m.sortKey);let f=null;"globe"===s.projection.name&&(this.globeExtVertexArray=new op,f=s.projection);for(const p of c){const{geometry:m,index:_,sourceLayerIndex:y}=p,v=t[_].feature;this.addFeature(p,m,_,n.availableImages,r,f,n.brightness),n.featureIndex.insert(v,m,_,y,this.index)}}update(t,n,r,s,l){const c=0!==Object.keys(t).length;c&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,n,c?this.stateDependentLayers:this.layers,r,s,l)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,VD.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,UD.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,n,r,s,l,c,h){for(const f of n)for(const p of f){const m=p.x,_=p.y;if(m<0||m>=st||_<0||_>=st)continue;if(c){const b=c.projectTilePoint(m,_,l),E=c.upVector(l,m,_),D=this.globeExtVertexArray;hd(D,b,E),hd(D,b,E),hd(D,b,E),hd(D,b,E)}const y=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),v=y.vertexLength;ud(this.layoutVertexArray,m,_,-1,-1),ud(this.layoutVertexArray,m,_,1,-1),ud(this.layoutVertexArray,m,_,1,1),ud(this.layoutVertexArray,m,_,-1,1),this.indexArray.emplaceBack(v,v+1,v+2),this.indexArray.emplaceBack(v,v+2,v+3),y.vertexLength+=4,y.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,{},s,l,h)}}function sb(e,t){for(let n=0;n<e.length;n++)if(Yr(t,e[n]))return!0;for(let n=0;n<t.length;n++)if(Yr(e,t[n]))return!0;return!!ey(e,t)}function ab(e,t,n){return!!Yr(e,t)||!!ub(t,e,n)}function lb(e,t){if(1===e.length)return ry(t,e[0]);for(let n=0;n<t.length;n++){const r=t[n];for(let s=0;s<r.length;s++)if(Yr(e,r[s]))return!0}for(let n=0;n<e.length;n++)if(ry(t,e[n]))return!0;for(let n=0;n<t.length;n++)if(ey(e,t[n]))return!0;return!1}function cb(e,t,n){if(e.length>1){if(ey(e,t))return!0;for(let r=0;r<t.length;r++)if(ub(t[r],e,n))return!0}for(let r=0;r<e.length;r++)if(ub(e[r],t,n))return!0;return!1}function ey(e,t){if(0===e.length||0===t.length)return!1;for(let n=0;n<e.length-1;n++){const r=e[n],s=e[n+1];for(let l=0;l<t.length-1;l++)if(pS(r,s,t[l],t[l+1]))return!0}return!1}function pS(e,t,n,r){return gt(e,n,r)!==gt(t,n,r)&&gt(e,t,n)!==gt(e,t,r)}function ub(e,t,n){const r=n*n;if(1===t.length)return e.distSqr(t[0])<r;for(let s=1;s<t.length;s++)if(ny(e,t[s-1],t[s])<r)return!0;return!1}function ny(e,t,n){const r=t.distSqr(n);if(0===r)return e.distSqr(t);const s=((e.x-t.x)*(n.x-t.x)+(e.y-t.y)*(n.y-t.y))/r;return e.distSqr(s<0?t:s>1?n:n.sub(t)._mult(s)._add(t))}function ry(e,t){let n,r,s,l=!1;for(let c=0;c<e.length;c++){n=e[c];for(let h=0,f=n.length-1;h<n.length;f=h++)r=n[h],s=n[f],r.y>t.y!=s.y>t.y&&t.x<(s.x-r.x)*(t.y-r.y)/(s.y-r.y)+r.x&&(l=!l)}return l}function Yr(e,t){let n=!1;for(let r=0,s=e.length-1;r<e.length;s=r++){const l=e[r],c=e[s];l.y>t.y!=c.y>t.y&&t.x<(c.x-l.x)*(t.y-l.y)/(c.y-l.y)+l.x&&(n=!n)}return n}function hb(e,t,n,r,s){for(const c of e)if(t<=c.x&&n<=c.y&&r>=c.x&&s>=c.y)return!0;const l=[new tt(t,n),new tt(t,s),new tt(r,s),new tt(r,n)];if(e.length>2)for(const c of l)if(Yr(e,c))return!0;for(let c=0;c<e.length-1;c++)if(iy(e[c],e[c+1],l))return!0;return!1}function iy(e,t,n){const r=n[0],s=n[2];if(e.x<r.x&&t.x<r.x||e.x>s.x&&t.x>s.x||e.y<r.y&&t.y<r.y||e.y>s.y&&t.y>s.y)return!1;const l=gt(e,t,n[0]);return l!==gt(e,t,n[1])||l!==gt(e,t,n[2])||l!==gt(e,t,n[3])}function bl(e,t,n,r,s,l){let c=t.y-e.y,h=e.x-t.x;if(l=l||0){const f=c*c+h*h;if(0===f)return!0;const p=Math.sqrt(f);c/=p,h/=p}return!((n.x-e.x)*c+(n.y-e.y)*h-l<0||(r.x-e.x)*c+(r.y-e.y)*h-l<0||(s.x-e.x)*c+(s.y-e.y)*h-l<0)}function oy(e,t,n,r,s,l,c){return!(bl(e,t,r,s,l,c)||bl(t,n,r,s,l,c)||bl(n,e,r,s,l,c)||bl(r,s,e,t,n,c)||bl(s,l,e,t,n,c)||bl(l,r,e,t,n,c))}function dd(e,t,n){const r=t.paint.get(e).value;return"constant"===r.kind?r.value:n.programConfigurations.get(t.id).getMaxValue(e)}function sy(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function mS(e,t,n,r,s){if(!t[0]&&!t[1])return e;const l=tt.convert(t)._mult(s);"viewport"===n&&l._rotate(-r);const c=[];for(let h=0;h<e.length;h++)c.push(e[h].sub(l));return c}function db(e,t,n,r){const s=tt.convert(e)._mult(r);return"viewport"===t&&s._rotate(-n),s}jt(ty,"CircleBucket",{omit:["layers"]});const fb=new qn({"circle-sort-key":new Kt(rt.layout_circle["circle-sort-key"]),visibility:new wt(rt.layout_circle.visibility)});var yA={paint:new qn({"circle-radius":new Kt(rt.paint_circle["circle-radius"]),"circle-color":new Kt(rt.paint_circle["circle-color"]),"circle-blur":new Kt(rt.paint_circle["circle-blur"]),"circle-opacity":new Kt(rt.paint_circle["circle-opacity"]),"circle-translate":new wt(rt.paint_circle["circle-translate"]),"circle-translate-anchor":new wt(rt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new wt(rt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new wt(rt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Kt(rt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Kt(rt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Kt(rt.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new wt(rt.paint_circle["circle-emissive-strength"])}),layout:fb};const gS=et.create(),Pu=(e,t,n,r,s,l)=>{const c=e.transform,h="globe"===c.projection.name;let f;if("map"===l.paint.get("circle-pitch-alignment"))if(h){const m=ld(c.zoom,t.canonical)*c._pixelsPerMercatorPixel;f=Float32Array.from([m,0,0,m])}else f=c.calculatePixelsToTileUnitsMatrix(n);else f=new Float32Array([c.pixelsToGLUnits[0],0,0,c.pixelsToGLUnits[1]]);const p={u_camera_to_center_distance:e.transform.getCameraToCenterDistance(c.projection),u_matrix:e.translatePosMatrix(t.projMatrix,n,l.paint.get("circle-translate"),l.paint.get("circle-translate-anchor")),u_device_pixel_ratio:me.devicePixelRatio,u_extrude_scale:f,u_inv_rot_matrix:gS,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:l.paint.get("circle-emissive-strength")};if(h){p.u_inv_rot_matrix=r,p.u_merc_center=s,p.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],p.u_zoom_transition=Mr(c.zoom);const m=s[0]*st,_=s[1]*st;p.u_up_dir=c.projection.upVector(new Oo(0,0,0),m,_)}return p},pb=e=>{const t=[];return"map"===e.paint.get("circle-pitch-alignment")&&t.push("PITCH_WITH_MAP"),"map"===e.paint.get("circle-pitch-scale")&&t.push("SCALE_WITH_MAP"),t};function ay(e,t,n,r,s,l,c,h,f){if(l&&e.queryGeometry.isAboveHorizon)return!1;l&&(f*=e.pixelToTileUnitsFactor);const p=e.tileID.canonical,m=n.projection.upVectorScale(p,n.center.lat,n.worldSize).metersToTile;for(const _ of t)for(const y of _){const v=y.add(h),b=s&&n.elevation?n.elevation.exaggeration()*s.getElevationAt(v.x,v.y,!0):0,E=n.projection.projectTilePoint(v.x,v.y,p);if(b>0){const I=n.projection.upVector(p,v.x,v.y);E.x+=I[0]*m*b,E.y+=I[1]*m*b,E.z+=I[2]*m*b}const D=l?v:zp(E.x,E.y,E.z,r),T=l?e.tilespaceRays.map(I=>_S(I,b)):e.queryGeometry.screenGeometry,C=an.transformMat4([],[E.x,E.y,E.z,1],r);if(!c&&l?f*=C[3]/n.cameraToCenterDistance:c&&!l&&(f*=n.cameraToCenterDistance/C[3]),l){const I=dr((y.y/st+p.y)/(1<<p.z));f/=n.projection.pixelsPerMeter(I,1)/gn(1,I)}if(ab(T,D,f))return!0}return!1}function zp(e,t,n,r){const s=an.transformMat4([],[e,t,n,1],r);return new tt(s[0]/s[3],s[1]/s[3])}const mb=H.fromValues(0,0,0),gb=H.fromValues(0,0,1);function _S(e,t){const n=H.create();return mb[2]=t,e.intersectsPlane(mb,gb,n),new tt(n[0],n[1])}class _b extends ty{}function yb(e,{width:t,height:n},r,s){if(s){if(s instanceof Uint8ClampedArray)s=new Uint8Array(s.buffer);else if(s.length!==t*n*r)throw new RangeError("mismatched image size")}else s=new Uint8Array(t*n*r);return e.width=t,e.height=n,e.data=s,e}function vb(e,t,n){const{width:r,height:s}=t;r===e.width&&s===e.height||(ly(e,t,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,r),height:Math.min(e.height,s)},n),e.width=r,e.height=s,e.data=t.data)}function ly(e,t,n,r,s,l){if(0===s.width||0===s.height)return t;if(s.width>e.width||s.height>e.height||n.x>e.width-s.width||n.y>e.height-s.height)throw new RangeError("out of range source coordinates for image copy");if(s.width>t.width||s.height>t.height||r.x>t.width-s.width||r.y>t.height-s.height)throw new RangeError("out of range destination coordinates for image copy");const c=e.data,h=t.data;for(let f=0;f<s.height;f++){const p=((n.y+f)*e.width+n.x)*l,m=((r.y+f)*t.width+r.x)*l;for(let _=0;_<s.width*l;_++)h[m+_]=c[p+_]}return t}jt(_b,"HeatmapBucket",{omit:["layers"]});class Hs{constructor(t,n){yb(this,t,1,n)}resize(t){vb(this,new Hs(t),1)}clone(){return new Hs({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,r,s,l){ly(t,n,r,s,l,1)}}class rr{constructor(t,n){yb(this,t,4,n)}resize(t){vb(this,new rr(t),4)}replace(t,n){n?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new rr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,r,s,l){ly(t,n,r,s,l,4)}}class cy{constructor(t,n){this.width=t.width,this.height=t.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}jt(Hs,"AlphaImage"),jt(rr,"RGBAImage");const xb=new qn({visibility:new wt(rt.layout_heatmap.visibility)});var uy={paint:new qn({"heatmap-radius":new Kt(rt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Kt(rt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new wt(rt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new np(rt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new wt(rt.paint_heatmap["heatmap-opacity"])}),layout:xb};function hy(e){const t={},n=e.resolution||256,r=e.clips?e.clips.length:1,s=e.image||new rr({width:n,height:r}),l=(c,h,f)=>{t[e.evaluationKey]=f;const p=e.expression.evaluate(t);p&&(s.data[c+h+0]=Math.floor(255*p.r/p.a),s.data[c+h+1]=Math.floor(255*p.g/p.a),s.data[c+h+2]=Math.floor(255*p.b/p.a),s.data[c+h+3]=Math.floor(255*p.a))};if(e.clips)for(let c=0,h=0;c<r;++c,h+=4*n)for(let f=0,p=0;f<n;f++,p+=4){const m=f/(n-1),{start:_,end:y}=e.clips[c];l(h,p,_*(1-m)+y*m)}else for(let c=0,h=0;c<n;c++,h+=4)l(0,h,c/(n-1));return s}const dy=new qn({visibility:new wt(rt.layout_hillshade.visibility)});var yS={paint:new qn({"hillshade-illumination-direction":new wt(rt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new wt(rt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new wt(rt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new wt(rt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new wt(rt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new wt(rt.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new wt(rt.paint_hillshade["hillshade-emissive-strength"])}),layout:dy};const vA=sn([{name:"a_pos",components:2,type:"Int16"}],4),{members:Ie}=vA;var fd={exports:{}};function pd(e,t,n){n=n||2;var r,s,l,c,h,f,p,m=t&&t.length,_=m?t[0]*n:e.length,y=md(e,0,_,n,!0),v=[];if(!y||y.next===y.prev)return v;if(m&&(y=function(E,D,T,C){var I,A,M,R=[];for(I=0,A=D.length;I<A;I++)(M=md(E,D[I]*C,I<A-1?D[I+1]*C:E.length,C,!1))===M.next&&(M.steiner=!0),R.push(bA(M));for(R.sort(bb),I=0;I<R.length;I++)T=my(R[I],T);return T}(e,t,y,n)),e.length>80*n){r=l=e[0],s=c=e[1];for(var b=n;b<_;b+=n)(h=e[b])<r&&(r=h),(f=e[b+1])<s&&(s=f),h>l&&(l=h),f>c&&(c=f);p=0!==(p=Math.max(l-r,c-s))?32767/p:0}return Ru(y,v,n,r,s,p,0),v}function md(e,t,n,r,s){var l,c;if(s===_y(e,t,n,r)>0)for(l=t;l<n;l+=r)c=Eb(l,e[l],e[l+1],c);else for(l=n-r;l>=t;l-=r)c=Eb(l,e[l],e[l+1],c);return c&&Lu(c,c.next)&&(ku(c),c=c.next),c}function mi(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!Lu(r,r.next)&&0!==ar(r.prev,r,r.next))r=r.next;else{if(ku(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function Ru(e,t,n,r,s,l,c){if(e){!c&&l&&function(m,_,y,v){var b=m;do{0===b.z&&(b.z=Np(b.x,b.y,_,y,v)),b.prevZ=b.prev,b.nextZ=b.next,b=b.next}while(b!==m);b.prevZ.nextZ=null,b.prevZ=null,function(E){var D,T,C,I,A,M,R,L,O=1;do{for(T=E,E=null,A=null,M=0;T;){for(M++,C=T,R=0,D=0;D<O&&(R++,C=C.nextZ);D++);for(L=O;R>0||L>0&&C;)0!==R&&(0===L||!C||T.z<=C.z)?(I=T,T=T.nextZ,R--):(I=C,C=C.nextZ,L--),A?A.nextZ=I:E=I,I.prevZ=A,A=I;T=C}A.nextZ=null,O*=2}while(M>1)}(b)}(e,r,s,l);for(var h,f,p=e;e.prev!==e.next;)if(h=e.prev,f=e.next,l?fy(e,r,s,l):vS(e))t.push(h.i/n|0),t.push(e.i/n|0),t.push(f.i/n|0),ku(e),e=f.next,p=f.next;else if((e=f)===p){c?1===c?Ru(e=Ta(mi(e),t,n),t,n,r,s,l,2):2===c&&py(e,t,n,r,s,l):Ru(mi(e),t,n,r,s,l,1);break}}}function vS(e){var t=e.prev,n=e,r=e.next;if(ar(t,n,r)>=0)return!1;for(var s=t.x,l=n.x,c=r.x,h=t.y,f=n.y,p=r.y,m=s<l?s<c?s:c:l<c?l:c,_=h<f?h<p?h:p:f<p?f:p,y=s>l?s>c?s:c:l>c?l:c,v=h>f?h>p?h:p:f>p?f:p,b=r.next;b!==t;){if(b.x>=m&&b.x<=y&&b.y>=_&&b.y<=v&&Da(s,h,l,f,c,p,b.x,b.y)&&ar(b.prev,b,b.next)>=0)return!1;b=b.next}return!0}function fy(e,t,n,r){var s=e.prev,l=e,c=e.next;if(ar(s,l,c)>=0)return!1;for(var h=s.x,f=l.x,p=c.x,m=s.y,_=l.y,y=c.y,v=h<f?h<p?h:p:f<p?f:p,b=m<_?m<y?m:y:_<y?_:y,E=h>f?h>p?h:p:f>p?f:p,D=m>_?m>y?m:y:_>y?_:y,T=Np(v,b,t,n,r),C=Np(E,D,t,n,r),I=e.prevZ,A=e.nextZ;I&&I.z>=T&&A&&A.z<=C;){if(I.x>=v&&I.x<=E&&I.y>=b&&I.y<=D&&I!==s&&I!==c&&Da(h,m,f,_,p,y,I.x,I.y)&&ar(I.prev,I,I.next)>=0||(I=I.prevZ,A.x>=v&&A.x<=E&&A.y>=b&&A.y<=D&&A!==s&&A!==c&&Da(h,m,f,_,p,y,A.x,A.y)&&ar(A.prev,A,A.next)>=0))return!1;A=A.nextZ}for(;I&&I.z>=T;){if(I.x>=v&&I.x<=E&&I.y>=b&&I.y<=D&&I!==s&&I!==c&&Da(h,m,f,_,p,y,I.x,I.y)&&ar(I.prev,I,I.next)>=0)return!1;I=I.prevZ}for(;A&&A.z<=C;){if(A.x>=v&&A.x<=E&&A.y>=b&&A.y<=D&&A!==s&&A!==c&&Da(h,m,f,_,p,y,A.x,A.y)&&ar(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function Ta(e,t,n){var r=e;do{var s=r.prev,l=r.next.next;!Lu(s,l)&&jp(s,r,r.next,l)&&gd(s,l)&&gd(l,s)&&(t.push(s.i/n|0),t.push(r.i/n|0),t.push(l.i/n|0),ku(r),ku(r.next),r=e=l),r=r.next}while(r!==e);return mi(r)}function py(e,t,n,r,s,l){var c=e;do{for(var h=c.next.next;h!==c.prev;){if(c.i!==h.i&&Bp(c,h)){var f=wb(c,h);return c=mi(c,c.next),f=mi(f,f.next),Ru(c,t,n,r,s,l,0),void Ru(f,t,n,r,s,l,0)}h=h.next}c=c.next}while(c!==e)}function bb(e,t){return e.x-t.x}function my(e,t){var n=function(s,l){var c,h=l,f=s.x,p=s.y,m=-1/0;do{if(p<=h.y&&p>=h.next.y&&h.next.y!==h.y){var _=h.x+(p-h.y)*(h.next.x-h.x)/(h.next.y-h.y);if(_<=f&&_>m&&(m=_,c=h.x<h.next.x?h:h.next,_===f))return c}h=h.next}while(h!==l);if(!c)return null;var y,v=c,b=c.x,E=c.y,D=1/0;h=c;do{f>=h.x&&h.x>=b&&f!==h.x&&Da(p<E?f:m,p,b,E,p<E?m:f,p,h.x,h.y)&&(y=Math.abs(p-h.y)/(f-h.x),gd(h,s)&&(y<D||y===D&&(h.x>c.x||h.x===c.x&&xA(c,h)))&&(c=h,D=y)),h=h.next}while(h!==v);return c}(e,t);if(!n)return t;var r=wb(n,e);return mi(r,r.next),mi(n,n.next)}function xA(e,t){return ar(e.prev,e,t.prev)<0&&ar(t.next,e,e.next)<0}function Np(e,t,n,r,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function bA(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function Da(e,t,n,r,s,l,c,h){return(s-c)*(t-h)>=(e-c)*(l-h)&&(e-c)*(r-h)>=(n-c)*(t-h)&&(n-c)*(l-h)>=(s-c)*(r-h)}function Bp(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(n,r){var s=n;do{if(s.i!==n.i&&s.next.i!==n.i&&s.i!==r.i&&s.next.i!==r.i&&jp(s,s.next,n,r))return!0;s=s.next}while(s!==n);return!1}(e,t)&&(gd(e,t)&&gd(t,e)&&function(n,r){var s=n,l=!1,c=(n.x+r.x)/2,h=(n.y+r.y)/2;do{s.y>h!=s.next.y>h&&s.next.y!==s.y&&c<(s.next.x-s.x)*(h-s.y)/(s.next.y-s.y)+s.x&&(l=!l),s=s.next}while(s!==n);return l}(e,t)&&(ar(e.prev,e,t.prev)||ar(e,t.prev,t))||Lu(e,t)&&ar(e.prev,e,e.next)>0&&ar(t.prev,t,t.next)>0)}function ar(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function Lu(e,t){return e.x===t.x&&e.y===t.y}function jp(e,t,n,r){var s=Vp(ar(e,t,n)),l=Vp(ar(e,t,r)),c=Vp(ar(n,r,e)),h=Vp(ar(n,r,t));return s!==l&&c!==h||!(0!==s||!gy(e,n,t))||!(0!==l||!gy(e,r,t))||!(0!==c||!gy(n,e,r))||!(0!==h||!gy(n,t,r))}function gy(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function Vp(e){return e>0?1:e<0?-1:0}function gd(e,t){return ar(e.prev,e,e.next)<0?ar(e,t,e.next)>=0&&ar(e,e.prev,t)>=0:ar(e,t,e.prev)<0||ar(e,e.next,t)<0}function wb(e,t){var n=new Tb(e.i,e.x,e.y),r=new Tb(t.i,t.x,t.y),s=e.next,l=t.prev;return e.next=t,t.prev=e,n.next=s,s.prev=n,r.next=n,n.prev=r,l.next=r,r.prev=l,r}function Eb(e,t,n,r){var s=new Tb(e,t,n);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function ku(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Tb(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function _y(e,t,n,r){for(var s=0,l=t,c=n-r;l<n;l+=r)s+=(e[c]-e[l])*(e[l+1]+e[c+1]),c=l;return s}fd.exports=pd,fd.exports.default=pd,pd.deviation=function(e,t,n,r){var s=t&&t.length,l=Math.abs(_y(e,0,s?t[0]*n:e.length,n));if(s)for(var c=0,h=t.length;c<h;c++)l-=Math.abs(_y(e,t[c]*n,c<h-1?t[c+1]*n:e.length,n));var f=0;for(c=0;c<r.length;c+=3){var p=r[c]*n,m=r[c+1]*n,_=r[c+2]*n;f+=Math.abs((e[p]-e[_])*(e[m+1]-e[p+1])-(e[p]-e[m])*(e[_+1]-e[p+1]))}return 0===l&&0===f?0:Math.abs((f-l)/l)},pd.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,s=0;s<e.length;s++){for(var l=0;l<e[s].length;l++)for(var c=0;c<t;c++)n.vertices.push(e[s][l][c]);s>0&&n.holes.push(r+=e[s-1].length)}return n};var yy=Zi(fd.exports);function Up(e,t){const n=e.length;if(n<=1)return[e];const r=[];let s,l;for(let c=0;c<n;c++){const h=yt(e[c]);0!==h&&(e[c].area=Math.abs(h),void 0===l&&(l=h<0),l===h<0?(s&&r.push(s),s=[e[c]]):s.push(e[c]))}if(s&&r.push(s),t>1)for(let c=0;c<r.length;c++)r[c].length<=t||(xi(r[c],t,1,r[c].length-1,Db),r[c]=r[c].slice(0,t));return r}function Db(e,t){return t.area-e.area}function vy(e,t,n){const r=n.patternDependencies;let s=!1;for(const l of t){const c=l.paint.get(`${e}-pattern`);c.isConstant()||(s=!0);const h=c.constantOr(null);h&&(s=!0,r[h]=!0)}return s}function _d(e,t,n,r,s){const l=s.patternDependencies;for(const c of t){const h=c.paint.get(`${e}-pattern`).value;if("constant"!==h.kind){let f=h.evaluate({zoom:r},n,{},s.availableImages);f=f&&f.name?f.name:f,l[f]=!0,n.patterns[c.id]=f}}return n}class xy{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new ro,this.indexArray=new er,this.indexArray2=new bo,this.programConfigurations=new pl(t.layers,t.zoom),this.segments=new ln,this.segments2=new ln,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=t.projection}populate(t,n,r,s){this.hasPattern=vy("fill",this.layers,n);const l=this.layers[0].layout.get("fill-sort-key"),c=[];for(const{feature:h,id:f,index:p,sourceLayerIndex:m}of t){const _=this.layers[0]._featureFilter.needGeometry,y=xl(h,_);if(!this.layers[0]._featureFilter.filter(new Gn(this.zoom),y,r))continue;const v=l?l.evaluate(y,{},r,n.availableImages):void 0,b={id:f,properties:h.properties,type:h.type,sourceLayerIndex:m,index:p,geometry:_?y.geometry:ze(h,r,s),patterns:{},sortKey:v};c.push(b)}l&&c.sort((h,f)=>h.sortKey-f.sortKey);for(const h of c){const{geometry:f,index:p,sourceLayerIndex:m}=h;if(this.hasPattern){const _=_d("fill",this.layers,h,this.zoom,n);this.patternFeatures.push(_)}else this.addFeature(h,f,p,r,{},n.availableImages,n.brightness);n.featureIndex.insert(t[p].feature,f,p,m,this.index)}}update(t,n,r,s,l){const c=0!==Object.keys(t).length;c&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,n,c?this.stateDependentLayers:this.layers,r,s,l)}addFeatures(t,n,r,s,l,c){for(const h of this.patternFeatures)this.addFeature(h,h.geometry,h.index,n,r,s,c)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Ie),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,n,r,s,l,c=[],h){for(const f of Up(n,500)){let p=0;for(const E of f)p+=E.length;const m=this.segments.prepareSegment(p,this.layoutVertexArray,this.indexArray),_=m.vertexLength,y=[],v=[];for(const E of f){if(0===E.length)continue;E!==f[0]&&v.push(y.length/2);const D=this.segments2.prepareSegment(E.length,this.layoutVertexArray,this.indexArray2),T=D.vertexLength;this.layoutVertexArray.emplaceBack(E[0].x,E[0].y),this.indexArray2.emplaceBack(T+E.length-1,T),y.push(E[0].x),y.push(E[0].y);for(let C=1;C<E.length;C++)this.layoutVertexArray.emplaceBack(E[C].x,E[C].y),this.indexArray2.emplaceBack(T+C-1,T+C),y.push(E[C].x),y.push(E[C].y);D.vertexLength+=E.length,D.primitiveLength+=E.length}const b=yy(y,v);for(let E=0;E<b.length;E+=3)this.indexArray.emplaceBack(_+b[E],_+b[E+1],_+b[E+2]);m.vertexLength+=p,m.primitiveLength+=b.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,l,c,s,h)}}jt(xy,"FillBucket",{omit:["layers","patternFeatures"]});const wA=new qn({"fill-sort-key":new Kt(rt.layout_fill["fill-sort-key"]),visibility:new wt(rt.layout_fill.visibility)});var EA={paint:new qn({"fill-antialias":new wt(rt.paint_fill["fill-antialias"]),"fill-opacity":new Kt(rt.paint_fill["fill-opacity"]),"fill-color":new Kt(rt.paint_fill["fill-color"]),"fill-outline-color":new Kt(rt.paint_fill["fill-outline-color"]),"fill-translate":new wt(rt.paint_fill["fill-translate"]),"fill-translate-anchor":new wt(rt.paint_fill["fill-translate-anchor"]),"fill-pattern":new Kt(rt.paint_fill["fill-pattern"]),"fill-emissive-strength":new wt(rt.paint_fill["fill-emissive-strength"])}),layout:wA};const TA=sn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),DA=sn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),SA=sn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),CA=sn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),MA=sn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:IA}=TA;var by={},wl=Ha,$p=Ou;function Ou(e,t,n,r,s){this.properties={},this.extent=n,this.type=0,this._pbf=e,this._geometry=-1,this._keys=r,this._values=s,e.readFields(Sb,this,t)}function Sb(e,t,n){1==e?t.id=n.readVarint():2==e?function(r,s){for(var l=r.readVarint()+r.pos;r.pos<l;){var c=s._keys[r.readVarint()],h=s._values[r.readVarint()];s.properties[c]=h}}(n,t):3==e?t.type=n.readVarint():4==e&&(t._geometry=n.pos)}function wy(e){for(var t,n,r=0,s=0,l=e.length,c=l-1;s<l;c=s++)r+=((n=e[c]).x-(t=e[s]).x)*(t.y+n.y);return r}Ou.types=["Unknown","Point","LineString","Polygon"],Ou.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var t,n=e.readVarint()+e.pos,r=1,s=0,l=0,c=0,h=[];e.pos<n;){if(s<=0){var f=e.readVarint();r=7&f,s=f>>3}if(s--,1===r||2===r)l+=e.readSVarint(),c+=e.readSVarint(),1===r&&(t&&h.push(t),t=[]),t.push(new wl(l,c));else{if(7!==r)throw new Error("unknown command "+r);t&&t.push(t[0].clone())}}return t&&h.push(t),h},Ou.prototype.bbox=function(){var e=this._pbf;e.pos=this._geometry;for(var t=e.readVarint()+e.pos,n=1,r=0,s=0,l=0,c=1/0,h=-1/0,f=1/0,p=-1/0;e.pos<t;){if(r<=0){var m=e.readVarint();n=7&m,r=m>>3}if(r--,1===n||2===n)(s+=e.readSVarint())<c&&(c=s),s>h&&(h=s),(l+=e.readSVarint())<f&&(f=l),l>p&&(p=l);else if(7!==n)throw new Error("unknown command "+n)}return[c,f,h,p]},Ou.prototype.toGeoJSON=function(e,t,n){var r,s,l=this.extent*Math.pow(2,n),c=this.extent*e,h=this.extent*t,f=this.loadGeometry(),p=Ou.types[this.type];function m(v){for(var b=0;b<v.length;b++){var E=v[b];v[b]=[360*(E.x+c)/l-180,360/Math.PI*Math.atan(Math.exp((180-360*(E.y+h)/l)*Math.PI/180))-90]}}switch(this.type){case 1:var _=[];for(r=0;r<f.length;r++)_[r]=f[r][0];m(f=_);break;case 2:for(r=0;r<f.length;r++)m(f[r]);break;case 3:for(f=function(v){var b=v.length;if(b<=1)return[v];for(var E,D,T=[],C=0;C<b;C++){var I=wy(v[C]);0!==I&&(void 0===D&&(D=I<0),D===I<0?(E&&T.push(E),E=[v[C]]):E.push(v[C]))}return E&&T.push(E),T}(f),r=0;r<f.length;r++)for(s=0;s<f[r].length;s++)m(f[r][s])}1===f.length?f=f[0]:p="Multi"+p;var y={type:"Feature",geometry:{type:p,coordinates:f},properties:this.properties};return"id"in this&&(y.id=this.id),y};var Cb=$p,Hp=Mb;function Mb(e,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(El,this,t),this.length=this._features.length}function El(e,t,n){15===e?t.version=n.readVarint():1===e?t.name=n.readString():5===e?t.extent=n.readVarint():2===e?t._features.push(n.pos):3===e?t._keys.push(n.readString()):4===e&&t._values.push(function(r){for(var s=null,l=r.readVarint()+r.pos;r.pos<l;){var c=r.readVarint()>>3;s=1===c?r.readString():2===c?r.readFloat():3===c?r.readDouble():4===c?r.readVarint64():5===c?r.readVarint():6===c?r.readSVarint():7===c?r.readBoolean():null}return s}(n))}Mb.prototype.feature=function(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];var t=this._pbf.readVarint()+this._pbf.pos;return new Cb(this._pbf,t,this.extent,this._keys,this._values)};var Ib=Hp;function xS(e,t,n){if(3===e){var r=new Ib(n,n.readVarint()+n.pos);r.length&&(t[r.name]=r)}}var Ey=by.VectorTile=function(e,t){this.layers=e.readFields(xS,{},t)},yd=by.VectorTileFeature=$p;function Gp(e,t,n,r){const s=[],l=0===r?(c,h,f,p,m,_)=>{c.push(new tt(_,f+(_-h)/(p-h)*(m-f)))}:(c,h,f,p,m,_)=>{c.push(new tt(h+(_-f)/(m-f)*(p-h),_))};for(const c of e){const h=[];for(const f of c){if(f.length<=2)continue;const p=[];for(let y=0;y<f.length-1;y++){const v=f[y].x,b=f[y].y,E=f[y+1].x,D=f[y+1].y,T=0===r?v:b,C=0===r?E:D;T<t?C>t&&l(p,v,b,E,D,t):T>n?C<n&&l(p,v,b,E,D,n):p.push(f[y]),C<t&&T>=t&&l(p,v,b,E,D,t),C>n&&T<=n&&l(p,v,b,E,D,n)}let m=f[f.length-1];const _=0===r?m.x:m.y;_>=t&&_<=n&&p.push(m),p.length&&(m=p[p.length-1],p[0].x===m.x&&p[0].y===m.y||p.push(p[0]),h.push(p))}h.length&&s.push(h)}return s}by.VectorTileLayer=Hp;class Ab{constructor(t){this._stringToNumber={},this._numberToString=[];for(let n=0;n<t.length;n++){const r=t[n];this._stringToNumber[r]=n,this._numberToString[n]=r}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}var qp={read:function(e,t,n,r,s){var l,c,h=8*s-r-1,f=(1<<h)-1,p=f>>1,m=-7,_=n?s-1:0,y=n?-1:1,v=e[t+_];for(_+=y,l=v&(1<<-m)-1,v>>=-m,m+=h;m>0;l=256*l+e[t+_],_+=y,m-=8);for(c=l&(1<<-m)-1,l>>=-m,m+=r;m>0;c=256*c+e[t+_],_+=y,m-=8);if(0===l)l=1-p;else{if(l===f)return c?NaN:1/0*(v?-1:1);c+=Math.pow(2,r),l-=p}return(v?-1:1)*c*Math.pow(2,l-r)},write:function(e,t,n,r,s,l){var c,h,f,p=8*l-s-1,m=(1<<p)-1,_=m>>1,y=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,v=r?0:l-1,b=r?1:-1,E=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(h=isNaN(t)?1:0,c=m):(c=Math.floor(Math.log(t)/Math.LN2),t*(f=Math.pow(2,-c))<1&&(c--,f*=2),(t+=c+_>=1?y/f:y*Math.pow(2,1-_))*f>=2&&(c++,f/=2),c+_>=m?(h=0,c=m):c+_>=1?(h=(t*f-1)*Math.pow(2,s),c+=_):(h=t*Math.pow(2,_-1)*Math.pow(2,s),c=0));s>=8;e[n+v]=255&h,v+=b,h/=256,s-=8);for(c=c<<s|h,p+=s;p>0;e[n+v]=255&c,v+=b,c/=256,p-=8);e[n+v-b]|=128*E}},_c=bn,Fu=qp;function bn(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}bn.Varint=0,bn.Fixed64=1,bn.Bytes=2,bn.Fixed32=5;var vd=4294967296,xd=1/vd,Ty=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function Gs(e){return e.type===bn.Bytes?e.readVarint()+e.pos:e.pos+1}function Wp(e,t,n){var r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));n.realloc(r);for(var s=n.pos-1;s>=e;s--)n.buf[s+r]=n.buf[s]}function Pb(e,t){for(var n=0;n<e.length;n++)t.writeVarint(e[n])}function Dy(e,t){for(var n=0;n<e.length;n++)t.writeSVarint(e[n])}function bS(e,t){for(var n=0;n<e.length;n++)t.writeFloat(e[n])}function AA(e,t){for(var n=0;n<e.length;n++)t.writeDouble(e[n])}function wS(e,t){for(var n=0;n<e.length;n++)t.writeBoolean(e[n])}function Rb(e,t){for(var n=0;n<e.length;n++)t.writeFixed32(e[n])}function ES(e,t){for(var n=0;n<e.length;n++)t.writeSFixed32(e[n])}function Lb(e,t){for(var n=0;n<e.length;n++)t.writeFixed64(e[n])}function kb(e,t){for(var n=0;n<e.length;n++)t.writeSFixed64(e[n])}function Zp(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function ri(e,t,n){e[n]=t,e[n+1]=t>>>8,e[n+2]=t>>>16,e[n+3]=t>>>24}function Sy(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}bn.prototype={destroy:function(){this.buf=null},readFields:function(e,t,n){for(n=n||this.length;this.pos<n;){var r=this.readVarint(),s=r>>3,l=this.pos;this.type=7&r,e(s,t,this),this.pos===l&&this.skip(r)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=Zp(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=Sy(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=Zp(this.buf,this.pos)+Zp(this.buf,this.pos+4)*vd;return this.pos+=8,e},readSFixed64:function(){var e=Zp(this.buf,this.pos)+Sy(this.buf,this.pos+4)*vd;return this.pos+=8,e},readFloat:function(){var e=Fu.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=Fu.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,n,r=this.buf;return t=127&(n=r[this.pos++]),n<128?t:(t|=(127&(n=r[this.pos++]))<<7,n<128?t:(t|=(127&(n=r[this.pos++]))<<14,n<128?t:(t|=(127&(n=r[this.pos++]))<<21,n<128?t:function(s,l,c){var h,f,p=c.buf;if(h=(112&(f=p[c.pos++]))>>4,f<128||(h|=(127&(f=p[c.pos++]))<<3,f<128)||(h|=(127&(f=p[c.pos++]))<<10,f<128)||(h|=(127&(f=p[c.pos++]))<<17,f<128)||(h|=(127&(f=p[c.pos++]))<<24,f<128)||(h|=(1&(f=p[c.pos++]))<<31,f<128))return function Tl(e,t,n){return n?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}(s,h,l);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(n=r[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&Ty?Ty.decode(this.buf.subarray(t,e)):function(n,r,s){for(var l="",c=r;c<s;){var h,f,p,m=n[c],_=null,y=m>239?4:m>223?3:m>191?2:1;if(c+y>s)break;1===y?m<128&&(_=m):2===y?128==(192&(h=n[c+1]))&&(_=(31&m)<<6|63&h)<=127&&(_=null):3===y?(f=n[c+2],128==(192&(h=n[c+1]))&&128==(192&f)&&((_=(15&m)<<12|(63&h)<<6|63&f)<=2047||_>=55296&&_<=57343)&&(_=null)):4===y&&(f=n[c+2],p=n[c+3],128==(192&(h=n[c+1]))&&128==(192&f)&&128==(192&p)&&((_=(15&m)<<18|(63&h)<<12|(63&f)<<6|63&p)<=65535||_>=1114112)&&(_=null)),null===_?(_=65533,y=1):_>65535&&(_-=65536,l+=String.fromCharCode(_>>>10&1023|55296),_=56320|1023&_),l+=String.fromCharCode(_),c+=y}return l}(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==bn.Bytes)return e.push(this.readVarint(t));var n=Gs(this);for(e=e||[];this.pos<n;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==bn.Bytes)return e.push(this.readSVarint());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==bn.Bytes)return e.push(this.readBoolean());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==bn.Bytes)return e.push(this.readFloat());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==bn.Bytes)return e.push(this.readDouble());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==bn.Bytes)return e.push(this.readFixed32());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==bn.Bytes)return e.push(this.readSFixed32());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==bn.Bytes)return e.push(this.readFixed64());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==bn.Bytes)return e.push(this.readSFixed64());var t=Gs(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===bn.Varint)for(;this.buf[this.pos++]>127;);else if(t===bn.Bytes)this.pos=this.readVarint()+this.pos;else if(t===bn.Fixed32)this.pos+=4;else{if(t!==bn.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var n=new Uint8Array(t);n.set(this.buf),this.buf=n,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),ri(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),ri(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),ri(this.buf,-1&e,this.pos),ri(this.buf,Math.floor(e*xd),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),ri(this.buf,-1&e,this.pos),ri(this.buf,Math.floor(e*xd),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(t,n){var r,s,l,h;if(t>=0?(r=t%4294967296|0,s=t/4294967296|0):(s=~(-t/4294967296),4294967295^(r=~(-t%4294967296))?r=r+1|0:(r=0,s=s+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),l=r,(h=n).buf[h.pos++]=127&l|128,l>>>=7,h.buf[h.pos++]=127&l|128,l>>>=7,h.buf[h.pos++]=127&l|128,l>>>=7,h.buf[h.pos++]=127&l|128,h.buf[h.pos]=127&(l>>>=7),function(l,c){var h=(7&l)<<4;c.buf[c.pos++]|=h|((l>>>=3)?128:0),l&&(c.buf[c.pos++]=127&l|((l>>>=7)?128:0),l&&(c.buf[c.pos++]=127&l|((l>>>=7)?128:0),l&&(c.buf[c.pos++]=127&l|((l>>>=7)?128:0),l&&(c.buf[c.pos++]=127&l|((l>>>=7)?128:0),l&&(c.buf[c.pos++]=127&l)))))}(s,n)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(Boolean(e))},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(r,s,l){for(var c,h,f=0;f<s.length;f++){if((c=s.charCodeAt(f))>55295&&c<57344){if(!h){c>56319||f+1===s.length?(r[l++]=239,r[l++]=191,r[l++]=189):h=c;continue}if(c<56320){r[l++]=239,r[l++]=191,r[l++]=189,h=c;continue}c=h-55296<<10|c-56320|65536,h=null}else h&&(r[l++]=239,r[l++]=191,r[l++]=189,h=null);c<128?r[l++]=c:(c<2048?r[l++]=c>>6|192:(c<65536?r[l++]=c>>12|224:(r[l++]=c>>18|240,r[l++]=c>>12&63|128),r[l++]=c>>6&63|128),r[l++]=63&c|128)}return l}(this.buf,e,this.pos);var n=this.pos-t;n>=128&&Wp(t,n,this),this.pos=t-1,this.writeVarint(n),this.pos+=n},writeFloat:function(e){this.realloc(4),Fu.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),Fu.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var n=0;n<t;n++)this.buf[this.pos++]=e[n]},writeRawMessage:function(e,t){this.pos++;var n=this.pos;e(t,this);var r=this.pos-n;r>=128&&Wp(n,r,this),this.pos=n-1,this.writeVarint(r),this.pos+=r},writeMessage:function(e,t,n){this.writeTag(e,bn.Bytes),this.writeRawMessage(t,n)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,Pb,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,Dy,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,wS,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,bS,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,AA,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,Rb,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,ES,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,Lb,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,kb,t)},writeBytesField:function(e,t){this.writeTag(e,bn.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,bn.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,bn.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,bn.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,bn.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,bn.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,bn.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,bn.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,bn.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,bn.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t))}};var Xp=Zi(_c);const PA=["tile","layer","source","sourceLayer","state"];class Ob{constructor(t,n,r,s,l){this.type="Feature",this._vectorTileFeature=t,this._z=n,this._x=r,this._y=s,this.properties=t.properties,this.id=l}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};void 0!==this.id&&(t.id=this.id);for(const n of PA)void 0!==this[n]&&(t[n]=this[n]);return t}}class Cy{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,r){const s=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][s]=this.stateChanges[t][s]||{},Vt(this.stateChanges[t][s],r),null===this.deletedStates[t]){this.deletedStates[t]={};for(const l in this.state[t])l!==s&&(this.deletedStates[t][l]=null)}else if(this.deletedStates[t]&&null===this.deletedStates[t][s]){this.deletedStates[t][s]={};for(const l in this.state[t][s])r[l]||(this.deletedStates[t][s][l]=null)}else for(const l in r)this.deletedStates[t]&&this.deletedStates[t][s]&&null===this.deletedStates[t][s][l]&&delete this.deletedStates[t][s][l]}removeFeatureState(t,n,r){if(null===this.deletedStates[t])return;const s=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},r&&void 0!==n)null!==this.deletedStates[t][s]&&(this.deletedStates[t][s]=this.deletedStates[t][s]||{},this.deletedStates[t][s][r]=null);else if(void 0!==n)if(this.stateChanges[t]&&this.stateChanges[t][s])for(r in this.deletedStates[t][s]={},this.stateChanges[t][s])this.deletedStates[t][s][r]=null;else this.deletedStates[t][s]=null;else this.deletedStates[t]=null}getState(t,n){const r=String(n),s=Vt({},(this.state[t]||{})[r],(this.stateChanges[t]||{})[r]);if(null===this.deletedStates[t])return{};if(this.deletedStates[t]){const l=this.deletedStates[t][n];if(null===l)return{};for(const c in l)delete s[c]}return s}initializeTileState(t,n){t.setFeatureState(this.state,n)}coalesceChanges(t,n){const r={};for(const s in this.stateChanges){this.state[s]=this.state[s]||{};const l={};for(const c in this.stateChanges[s])this.state[s][c]||(this.state[s][c]={}),Vt(this.state[s][c],this.stateChanges[s][c]),l[c]=this.state[s][c];r[s]=l}for(const s in this.deletedStates){this.state[s]=this.state[s]||{};const l={};if(null===this.deletedStates[s])for(const c in this.state[s])l[c]={},this.state[s][c]={};else for(const c in this.deletedStates[s]){if(null===this.deletedStates[s][c])this.state[s][c]={};else if(this.state[s][c])for(const h of Object.keys(this.deletedStates[s][c]))delete this.state[s][c][h];l[c]=this.state[s][c]}r[s]=r[s]||{},Vt(r[s],l)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(r).length)for(const s in t)t[s].setFeatureState(r,n)}}class My{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,n){const r=this.toIdx(t,n);return{min:this.minimums[r],max:this.maximums[r]}}isLeaf(t,n){return this.leaves[this.toIdx(t,n)]}toIdx(t,n){return n*this.size+t}}function Fb(e,t,n,r){let s=0,l=Number.MAX_VALUE;for(let c=0;c<3;c++)if(Math.abs(r[c])<1e-15){if(n[c]<e[c]||n[c]>t[c])return null}else{const h=1/r[c];let f=(e[c]-n[c])*h,p=(t[c]-n[c])*h;if(f>p){const m=f;f=p,p=m}if(f>s&&(s=f),p<l&&(l=p),s>l)return null}return s}function zb(e,t,n,r,s,l,c,h,f,p,m){const _=r-e,y=s-t,v=l-n,b=c-e,E=h-t,D=f-n,T=m[1]*D-m[2]*E,C=m[2]*b-m[0]*D,I=m[0]*E-m[1]*b,A=_*T+y*C+v*I;if(Math.abs(A)<1e-15)return null;const M=1/A,R=p[0]-e,L=p[1]-t,O=p[2]-n,z=(R*T+L*C+O*I)*M;if(z<0||z>1)return null;const N=L*v-O*y,V=O*_-R*v,B=R*y-L*_,$=(m[0]*N+m[1]*V+m[2]*B)*M;return $<0||z+$>1?null:(b*N+E*V+D*B)*M}function Nb(e,t,n){return(e-t)/(n-t)}function Iy(e,t,n,r,s,l,c,h,f){const p=1<<n,m=l-r,_=c-s,y=(e+1)/p*m+r,v=(t+0)/p*_+s,b=(t+1)/p*_+s;h[0]=(e+0)/p*m+r,h[1]=v,f[0]=y,f[1]=b}class Bb{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const n=function(l){const c=Math.ceil(Math.log2(l.dim/8)),h=[];let f=Math.ceil(Math.pow(2,c));const p=1/f,m=(v,b,E,D,T)=>{const C=D?1:0,I=(v+1)*E-C,A=b*E,M=(b+1)*E-C;T[0]=v*E,T[1]=A,T[2]=I,T[3]=M};let _=new My(f);const y=[];for(let v=0;v<f*f;v++){m(v%f,Math.floor(v/f),p,!1,y);const b=Dl(y[0],y[1],l),E=Dl(y[2],y[1],l),D=Dl(y[2],y[3],l),T=Dl(y[0],y[3],l);_.minimums.push(Math.min(b,E,D,T)),_.maximums.push(Math.max(b,E,D,T)),_.leaves.push(1)}for(h.push(_),f/=2;f>=1;f/=2){const v=h[h.length-1];_=new My(f);for(let b=0;b<f*f;b++){m(b%f,Math.floor(b/f),2,!0,y);const E=v.getElevation(y[0],y[1]),D=v.getElevation(y[2],y[1]),T=v.getElevation(y[2],y[3]),C=v.getElevation(y[0],y[3]),I=v.isLeaf(y[0],y[1]),A=v.isLeaf(y[2],y[1]),M=v.isLeaf(y[2],y[3]),R=v.isLeaf(y[0],y[3]),L=Math.min(E.min,D.min,T.min,C.min),O=Math.max(E.max,D.max,T.max,C.max),z=I&&A&&M&&R;_.maximums.push(O),_.minimums.push(L),_.leaves.push(O-L<=5&&z?1:0)}h.push(_)}return h}(this.dem),r=n.length-1,s=n[r];this._addNode(s.minimums[0],s.maximums[0],s.leaves[0]),this._construct(n,0,0,r,0)}raycastRoot(t,n,r,s,l,c,h=1){return Fb([t,n,-100],[r,s,this.maximums[0]*h],l,c)}raycast(t,n,r,s,l,c,h=1){if(!this.nodeCount)return null;const f=this.raycastRoot(t,n,r,s,l,c,h);if(null==f)return null;const p=[],m=[],_=[],y=[],v=[{idx:0,t:f,nodex:0,nodey:0,depth:0}];for(;v.length>0;){const{idx:b,t:E,nodex:D,nodey:T,depth:C}=v.pop();if(this.leaves[b]){Iy(D,T,C,t,n,r,s,_,y);const A=1<<C,M=(D+0)/A,R=(D+1)/A,L=(T+0)/A,O=(T+1)/A,z=Dl(M,L,this.dem)*h,N=Dl(R,L,this.dem)*h,V=Dl(R,O,this.dem)*h,B=Dl(M,O,this.dem)*h,$=zb(_[0],_[1],z,y[0],_[1],N,y[0],y[1],V,l,c),j=zb(y[0],y[1],V,_[0],y[1],B,_[0],_[1],z,l,c),Z=Math.min(null!==$?$:Number.MAX_VALUE,null!==j?j:Number.MAX_VALUE);if(Z!==Number.MAX_VALUE)return Z;{const K=H.scaleAndAdd([],l,c,E);if(Ay(z,N,B,V,Nb(K[0],_[0],y[0]),Nb(K[1],_[1],y[1]))>=K[2])return E}continue}let I=0;for(let A=0;A<this._siblingOffset.length;A++){Iy((D<<1)+this._siblingOffset[A][0],(T<<1)+this._siblingOffset[A][1],C+1,t,n,r,s,_,y),_[2]=-100,y[2]=this.maximums[this.childOffsets[b]+A]*h;const M=Fb(_,y,l,c);if(null!=M){const R=M;p[A]=R;let L=!1;for(let O=0;O<I&&!L;O++)R>=p[m[O]]&&(m.splice(O,0,A),L=!0);L||(m[I]=A),I++}}for(let A=0;A<I;A++){const M=m[A];v.push({idx:this.childOffsets[b]+M,t:p[M],nodex:(D<<1)+this._siblingOffset[M][0],nodey:(T<<1)+this._siblingOffset[M][1],depth:C+1})}}return null}_addNode(t,n,r){return this.minimums.push(t),this.maximums.push(n),this.leaves.push(r),this.childOffsets.push(0),this.nodeCount++}_construct(t,n,r,s,l){if(1===t[s].isLeaf(n,r))return;this.childOffsets[l]||(this.childOffsets[l]=this.nodeCount);const c=s-1,h=t[c];let f=0,p=0;for(let m=0;m<this._siblingOffset.length;m++){const _=2*n+this._siblingOffset[m][0],y=2*r+this._siblingOffset[m][1],v=h.getElevation(_,y),b=h.isLeaf(_,y),E=this._addNode(v.min,v.max,b);b&&(f|=1<<m),p||(p=E)}for(let m=0;m<this._siblingOffset.length;m++)f&1<<m||this._construct(t,2*n+this._siblingOffset[m][0],2*r+this._siblingOffset[m][1],c,p+m)}}function Ay(e,t,n,r,s,l){return de(de(e,n,l),de(t,r,l),s)}function Dl(e,t,n){const r=n.dim,s=Gt(e*r-.5,0,r-1),l=Gt(t*r-.5,0,r-1),c=Math.floor(s),h=Math.floor(l),f=Math.min(c+1,r-1),p=Math.min(h+1,r-1);return Ay(n.get(c,h),n.get(f,h),n.get(c,p),n.get(f,p),s-c,l-h)}const jb={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768],float:[1,1,1,1]};function Yp(e,t,n){return(256*e*256+256*t+n)/10-1e4}function Kp(e,t,n){return 256*e+t+n/256-32768}class yc{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,n,r,s,l=!1){if(this.uid=t,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(r&&"mapbox"!==r&&"terrarium"!==r)return Y(`"${r}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;const c=this.dim=n.height-2,h=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.encoding=r||"mapbox",this.borderReady=l,this._modifiedForSources={},!l){for(let f=0;f<c;f++)h[this._idx(-1,f)]=h[this._idx(0,f)],h[this._idx(c,f)]=h[this._idx(c-1,f)],h[this._idx(f,-1)]=h[this._idx(f,0)],h[this._idx(f,c)]=h[this._idx(f,c-1)];h[this._idx(-1,-1)]=h[this._idx(0,0)],h[this._idx(c,-1)]=h[this._idx(c-1,0)],h[this._idx(-1,c)]=h[this._idx(0,c-1)],h[this._idx(c,c)]=h[this._idx(c-1,c-1)]}if(s){const f=new Float32Array(n.data.buffer),p="terrarium"===this.encoding?Kp:Yp;for(let m=0;m<h.length;++m){const _=4*m;f[m]=p(this.pixels[_],this.pixels[_+1],this.pixels[_+2])}this.encoding="float"}this._timestamp=me.now()}_buildQuadTree(){this._tree=new Bb(this)}get(t,n,r=!1){r&&(t=Gt(t,-1,this.dim),n=Gt(n,-1,this.dim));const s=this._idx(t,n);if("float"===this.encoding)return this.floatView||(this.floatView=new Float32Array(this.pixels.buffer)),this.floatView[s];const l=4*s;return("terrarium"===this.encoding?Kp:Yp)(this.pixels[l],this.pixels[l+1],this.pixels[l+2])}set(t,n,r){const s=this._idx(t,n);if("float"===this.encoding){this.floatView||(this.floatView=new Float32Array(this.pixels.buffer));const f=this.floatView[s];return this.floatView[s]=r,r-f}const l=4*s,c=("terrarium"===this.encoding?Kp:Yp)(this.pixels[l],this.pixels[l+1],this.pixels[l+2]),h=yc.pack(r,"terrarium"===this.encoding?"terrarium":"mapbox");return this.pixels[l]=h[0],this.pixels[l+1]=h[1],this.pixels[l+2]=h[2],r-c}static getUnpackVector(t){return jb[t]}get unpackVector(){return jb[this.encoding]}_idx(t,n){if(t<-1||t>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(t+1)}static pack(t,n){const r=[0,0,0,0],s=yc.getUnpackVector(n);let l=Math.floor((t+s[3])/s[2]);return r[2]=l%256,l=Math.floor(l/256),r[1]=l%256,l=Math.floor(l/256),r[0]=l,r}getPixels(){return"float"===this.encoding?new cy({width:this.stride,height:this.stride},this.pixels):new rr({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,n,r){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let s=n*this.dim,l=n*this.dim+this.dim,c=r*this.dim,h=r*this.dim+this.dim;switch(n){case-1:s=l-1;break;case 1:l=s+1}switch(r){case-1:c=h-1;break;case 1:h=c+1}const f=-n*this.dim,p=-r*this.dim;for(let m=c;m<h;m++)for(let _=s;_<l;_++){const y=4*this._idx(_,m),v=4*this._idx(_+f,m+p);this.pixels[y+0]=t.pixels[v+0],this.pixels[y+1]=t.pixels[v+1],this.pixels[y+2]=t.pixels[v+2],this.pixels[y+3]=t.pixels[v+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}jt(yc,"DEMData"),jt(Bb,"DemMinMaxQuadTree",{omit:["dem"]});class Sl{constructor(t,n,r){this._demTile=t,this._dem=this._demTile.dem,this._scale=n,this._offset=r}static create(t,n,r){const s=r||t.findDEMTileFor(n);if(!s||!s.dem)return;const l=s.dem,c=s.tileID,h=1<<n.canonical.z-c.canonical.z;return new Sl(s,l.dim/st/h,[(n.canonical.x/h-c.canonical.x)*l.dim,(n.canonical.y/h-c.canonical.y)*l.dim])}tileCoordToPixel(t,n){const r=n*this._scale+this._offset[1],s=Math.floor(t*this._scale+this._offset[0]),l=Math.floor(r);return new tt(s,l)}getElevationAt(t,n,r,s){const l=t*this._scale+this._offset[0],c=n*this._scale+this._offset[1],h=Math.floor(l),f=Math.floor(c),p=this._dem;return s=!!s,r?de(de(p.get(h,f,s),p.get(h,f+1,s),c-f),de(p.get(h+1,f,s),p.get(h+1,f+1,s),c-f),l-h):p.get(h,f,s)}getElevationAtPixel(t,n,r){return this._dem.get(t,n,!!r)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*gn(1,t)*this._dem.stride}}class Py{constructor(t,n){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new gu(st,16,0),this.featureIndexArray=new jD,this.promoteId=n}insert(t,n,r,s,l,c=0){const h=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(r,s,l,c);const f=this.grid;for(let p=0;p<n.length;p++){const m=n[p],_=[1/0,1/0,-1/0,-1/0];for(let y=0;y<m.length;y++){const v=m[y];_[0]=Math.min(_[0],v.x),_[1]=Math.min(_[1],v.y),_[2]=Math.max(_[2],v.x),_[3]=Math.max(_[3],v.y)}_[0]<st&&_[1]<st&&_[2]>=0&&_[3]>=0&&f.insert(h,_[0],_[1],_[2],_[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Ey(new Xp(this.rawTileData)).layers,this.sourceLayerCoder=new Ab(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,n,r,s){this.loadVTLayers();const l=t.params||{},c=fu(l.filter),h=t.tileResult,f=t.transform,p=h.bufferedTilespaceBounds,m=this.grid.query(p.min.x,p.min.y,p.max.x,p.max.y,(b,E,D,T)=>hb(h.bufferedTilespaceGeometry,b,E,D,T));m.sort(RA);let _=null;f.elevation&&m.length>0&&(_=Sl.create(f.elevation,this.tileID));const y={};let v;for(let b=0;b<m.length;b++){const E=m[b];if(E===v)continue;v=E;const D=this.featureIndexArray.get(E);let T=null;this.loadMatchingFeature(y,D,c,l.layers,l.availableImages,n,r,s,(C,I,A,M=0)=>(T||(T=ze(C,this.tileID.canonical,t.tileTransform)),I.queryIntersectsFeature(h,C,A,T,this.z,t.transform,t.pixelPosMatrix,_,M)))}return y}loadMatchingFeature(t,n,r,s,l,c,h,f,p){const{featureIndex:m,bucketIndex:_,sourceLayerIndex:y,layoutVertexArrayOffset:v}=n,b=this.bucketLayerIDs[_];if(s&&!function(C,I){for(let A=0;A<C.length;A++)if(I.indexOf(C[A])>=0)return!0;return!1}(s,b))return;const E=this.sourceLayerCoder.decode(y),D=this.vtLayers[E].feature(m);if(r.needGeometry){const C=xl(D,!0);if(!r.filter(new Gn(this.tileID.overscaledZ),C,this.tileID.canonical))return}else if(!r.filter(new Gn(this.tileID.overscaledZ),D))return;const T=this.getId(D,E);for(let C=0;C<b.length;C++){const I=b[C];if(s&&s.indexOf(I)<0)continue;const A=c[I];if(!A)continue;let M={};void 0!==T&&f&&(M=f.getState(A.sourceLayer||"_geojsonTileLayer",T));const R=Vt({},h[I]);R.paint=Vb(R.paint,A.paint,D,M,l),R.layout=Vb(R.layout,A.layout,D,M,l);const L=!p||p(D,A,M,v);if(!L)continue;const O=new Ob(D,this.z,this.x,this.y,T);O.layer=R;let z=t[I];void 0===z&&(z=t[I]=[]),z.push({featureIndex:m,feature:O,intersectionZ:L})}}lookupSymbolFeatures(t,n,r,s,l,c,h,f){const p={};this.loadVTLayers();const m=fu(l);for(const _ of t)this.loadMatchingFeature(p,{bucketIndex:r,sourceLayerIndex:s,featureIndex:_,layoutVertexArrayOffset:0},m,c,h,f,n);return p}loadFeature(t){const{featureIndex:n,sourceLayerIndex:r}=t;this.loadVTLayers();const s=this.sourceLayerCoder.decode(r),l=this.vtFeatures[s];if(l[n])return l[n];const c=this.vtLayers[s].feature(n);return l[n]=c,c}hasLayer(t){for(const n of this.bucketLayerIDs)for(const r of n)if(t===r)return!0;return!1}getId(t,n){let r=t.id;if(this.promoteId){const s="string"==typeof this.promoteId?this.promoteId:this.promoteId[n];null!=s&&(r=t.properties[s]),"boolean"==typeof r&&(r=Number(r))}return r}}function Vb(e,t,n,r,s){return Zc(e,(l,c)=>{const h=t instanceof Xh?t.get(c):null;return h&&h.evaluate?h.evaluate(n,r,s):h})}function RA(e,t){return t-e}jt(Py,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const Ub=sn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),TS=sn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),DS=sn([{name:"a_projected_pos",components:4,type:"Float32"}],4);sn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const SS=sn([{name:"a_z_offset",components:1,type:"Float32"}],4),Ry=sn([{name:"a_texb",components:2,type:"Uint16"}]),CS=sn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),MS=sn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);sn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const bd=sn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Ly=sn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);sn([{name:"triangle",components:3,type:"Uint16"}]),sn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),sn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),sn([{type:"Float32",name:"offsetX"}]),sn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);const Ws=128;function wd(e,t){const{expression:n}=t;if("constant"===n.kind)return{kind:"constant",layoutSize:n.evaluate(new Gn(e+1))};if("source"===n.kind)return{kind:"source"};{const{zoomStops:r,interpolationType:s}=n;let l=0;for(;l<r.length&&r[l]<=e;)l++;l=Math.max(0,l-1);let c=l;for(;c<r.length&&r[c]<e+1;)c++;c=Math.min(r.length-1,c);const h=r[l],f=r[c];return"composite"===n.kind?{kind:"composite",minZoom:h,maxZoom:f,interpolationType:s}:{kind:"camera",minZoom:h,maxZoom:f,minSize:n.evaluate(new Gn(h)),maxSize:n.evaluate(new Gn(f)),interpolationType:s}}}function Jp(e,{uSize:t,uSizeT:n},{lowerSize:r,upperSize:s}){return"source"===e.kind?r/Ws:"composite"===e.kind?de(r/Ws,s/Ws,n):t}function ls(e,t){let n=0,r=0;if("constant"===e.kind)r=e.layoutSize;else if("source"!==e.kind){const{interpolationType:s,minZoom:l,maxZoom:c}=e,h=s?Gt(Cs.interpolationFactor(s,t,l,c),0,1):0;"camera"===e.kind?r=de(e.minSize,e.maxSize,h):n=h}return{uSizeT:n,uSize:r}}var $b=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Ws,evaluateSizeForFeature:Jp,evaluateSizeForZoom:ls,getSizeData:wd});function Hb(e,t,n){return e.sections.forEach(r=>{r.text=function(s,l,c){const h=l.layout.get("text-transform").evaluate(c,{});return"uppercase"===h?s=s.toLocaleUpperCase():"lowercase"===h&&(s=s.toLocaleLowerCase()),wi.applyArabicShaping&&(s=wi.applyArabicShaping(s)),s}(r.text,t,n)}),e}const zu={"!":"\ufe15","#":"\uff03",$:"\uff04","%":"\uff05","&":"\uff06","(":"\ufe35",")":"\ufe36","*":"\uff0a","+":"\uff0b",",":"\ufe10","-":"\ufe32",".":"\u30fb","/":"\uff0f",":":"\ufe13",";":"\ufe14","<":"\ufe3f","=":"\uff1d",">":"\ufe40","?":"\ufe16","@":"\uff20","[":"\ufe47","\\":"\uff3c","]":"\ufe48","^":"\uff3e",_:"\ufe33","`":"\uff40","{":"\ufe37","|":"\u2015","}":"\ufe38","~":"\uff5e","\xa2":"\uffe0","\xa3":"\uffe1","\xa5":"\uffe5","\xa6":"\uffe4","\xac":"\uffe2","\xaf":"\uffe3","\u2013":"\ufe32","\u2014":"\ufe31","\u2018":"\ufe43","\u2019":"\ufe44","\u201c":"\ufe41","\u201d":"\ufe42","\u2026":"\ufe19","\u2027":"\u30fb","\u20a9":"\uffe6","\u3001":"\ufe11","\u3002":"\ufe12","\u3008":"\ufe3f","\u3009":"\ufe40","\u300a":"\ufe3d","\u300b":"\ufe3e","\u300c":"\ufe41","\u300d":"\ufe42","\u300e":"\ufe43","\u300f":"\ufe44","\u3010":"\ufe3b","\u3011":"\ufe3c","\u3014":"\ufe39","\u3015":"\ufe3a","\u3016":"\ufe17","\u3017":"\ufe18","\uff01":"\ufe15","\uff08":"\ufe35","\uff09":"\ufe36","\uff0c":"\ufe10","\uff0d":"\ufe32","\uff0e":"\u30fb","\uff1a":"\ufe13","\uff1b":"\ufe14","\uff1c":"\ufe3f","\uff1e":"\ufe40","\uff1f":"\ufe16","\uff3b":"\ufe47","\uff3d":"\ufe48","\uff3f":"\ufe33","\uff5b":"\ufe37","\uff5c":"\u2015","\uff5d":"\ufe38","\uff5f":"\ufe35","\uff60":"\ufe36","\uff61":"\ufe12","\uff62":"\ufe41","\uff63":"\ufe42","\u2190":"\u2191","\u2192":"\u2193"};function ky(e){return"\ufe36"===e||"\ufe48"===e||"\ufe38"===e||"\ufe44"===e||"\ufe42"===e||"\ufe3e"===e||"\ufe3c"===e||"\ufe3a"===e||"\ufe18"===e||"\ufe40"===e||"\ufe10"===e||"\ufe13"===e||"\ufe14"===e||"\uff40"===e||"\uffe3"===e||"\ufe11"===e||"\ufe12"===e}function Sa(e){return"\ufe35"===e||"\ufe47"===e||"\ufe37"===e||"\ufe43"===e||"\ufe41"===e||"\ufe3d"===e||"\ufe3b"===e||"\ufe39"===e||"\ufe17"===e||"\ufe3f"===e}function Qp(e,t,n){t.glyphs=[],1===e&&n.readMessage(Ed,t)}function Ed(e,t,n){if(3===e){const{id:r,bitmap:s,width:l,height:c,left:h,top:f,advance:p}=n.readMessage(IS,{});t.glyphs.push({id:r,bitmap:new Hs({width:l+6,height:c+6},s),metrics:{width:l,height:c,left:h,top:f,advance:p}})}else 4===e?t.ascender=n.readSVarint():5===e&&(t.descender=n.readSVarint())}function IS(e,t,n){1===e?t.id=n.readVarint():2===e?t.bitmap=n.readBytes():3===e?t.width=n.readVarint():4===e?t.height=n.readVarint():5===e?t.left=n.readSVarint():6===e?t.top=n.readSVarint():7===e&&(t.advance=n.readVarint())}function em(e){let t=0,n=0;for(const c of e)t+=c.w*c.h,n=Math.max(n,c.w);e.sort((c,h)=>h.h-c.h);const r=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),n),h:1/0}];let s=0,l=0;for(const c of e)for(let h=r.length-1;h>=0;h--){const f=r[h];if(!(c.w>f.w||c.h>f.h)){if(c.x=f.x,c.y=f.y,l=Math.max(l,c.y+c.h),s=Math.max(s,c.x+c.w),c.w===f.w&&c.h===f.h){const p=r.pop();h<r.length&&(r[h]=p)}else c.h===f.h?(f.x+=c.w,f.w-=c.w):c.w===f.w?(f.y+=c.h,f.h-=c.h):(r.push({x:f.x+c.w,y:f.y,w:f.w-c.w,h:c.h}),f.y+=c.h,f.h-=c.h);break}}return{w:s,h:l,fill:t/(s*l)||0}}class Oy{constructor(t,{pixelRatio:n,version:r,stretchX:s,stretchY:l,content:c}){this.paddedRect=t,this.pixelRatio=n,this.stretchX=s,this.stretchY=l,this.content=c,this.version=r}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Bu{constructor(t,n){const r={},s={};this.haveRenderCallbacks=[];const l=[];this.addImages(t,r,l),this.addImages(n,s,l);const{w:c,h}=em(l),f=new rr({width:c||1,height:h||1});for(const p in t){const m=t[p],_=r[p].paddedRect;rr.copy(m.data,f,{x:0,y:0},{x:_.x+1,y:_.y+1},m.data)}for(const p in n){const m=n[p],_=s[p].paddedRect,y=_.x+1,v=_.y+1,b=m.data.width,E=m.data.height;rr.copy(m.data,f,{x:0,y:0},{x:y,y:v},m.data),rr.copy(m.data,f,{x:0,y:E-1},{x:y,y:v-1},{width:b,height:1}),rr.copy(m.data,f,{x:0,y:0},{x:y,y:v+E},{width:b,height:1}),rr.copy(m.data,f,{x:b-1,y:0},{x:y-1,y:v},{width:1,height:E}),rr.copy(m.data,f,{x:0,y:0},{x:y+b,y:v},{width:1,height:E})}this.image=f,this.iconPositions=r,this.patternPositions=s}addImages(t,n,r){for(const s in t){const l=t[s],c={x:0,y:0,w:l.data.width+2,h:l.data.height+2};r.push(c),n[s]=new Oy(c,l),l.hasRenderCallback&&this.haveRenderCallbacks.push(s)}}patchUpdatedImages(t,n,r){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(s=>t.hasImage(s,r)),t.dispatchRenderCallbacks(this.haveRenderCallbacks,r);for(const s in t.getUpdatedImages(r))this.patchUpdatedImage(this.iconPositions[s],t.getImage(s,r),n),this.patchUpdatedImage(this.patternPositions[s],t.getImage(s,r),n)}patchUpdatedImage(t,n,r){if(!t||!n||t.version===n.version)return;t.version=n.version;const[s,l]=t.tl;r.update(n.data,void 0,{x:s,y:l})}}jt(Oy,"ImagePosition"),jt(Bu,"ImageAtlas");const Bn={horizontal:1,vertical:2,horizontalOnly:3};class Td{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,n){const r=new Td;return r.scale=t||1,r.fontStack=n,r}static forImage(t){const n=new Td;return n.imageName=t,n}}class Dd{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,n){const r=new Dd;for(let s=0;s<t.sections.length;s++){const l=t.sections[s];l.image?r.addImageSection(l):r.addTextSection(l,n)}return r}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCodePoint(t){return this.text.codePointAt(t)}verticalizePunctuation(t){this.text=function(n,r){let s="";for(let l=0;l<n.length;l++){const c=n.charCodeAt(l+1)||null,h=n.charCodeAt(l-1)||null;s+=!r&&(c&&zD(c)&&!zu[n[l+1]]||h&&zD(h)&&!zu[n[l-1]])||!zu[n[l]]?n[l]:zu[n[l]]}return s}(this.text,t)}trim(){let t=0;for(let r=0;r<this.text.length&&nm[this.text.charCodeAt(r)];r++)t++;let n=this.text.length;for(let r=this.text.length-1;r>=0&&r>=t&&nm[this.text.charCodeAt(r)];r--)n--;this.text=this.text.substring(t,n),this.sectionIndex=this.sectionIndex.slice(t,n)}substring(t,n){const r=new Dd;return r.text=this.text.substring(t,n),r.sectionIndex=this.sectionIndex.slice(t,n),r.sections=this.sections,r}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,n)=>Math.max(t,this.sections[n].scale),0)}addTextSection(t,n){this.text+=t.text,this.sections.push(Td.forText(t.scale,t.fontStack||n));const r=this.sections.length-1;for(let s=0;s<t.text.length;++s)this.sectionIndex.push(r)}addImageSection(t){const n=t.image?t.image.namePrimary:"";if(0===n.length)return void Y("Can't add FormattedSection with an empty image.");const r=this.getNextImageSectionCharCode();r?(this.text+=String.fromCodePoint(r),this.sections.push(Td.forImage(n)),this.sectionIndex.push(this.sections.length-1)):Y("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Fy(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b){const E=Dd.fromFeature(e,s);_===Bn.vertical&&E.verticalizePunctuation(y);let D=[];const T=function(R,L,O,z,N,V){if(!R)return[];const B=[],$=function(Q,W,X,nt,ot,lt){let ht=0;for(let ft=0;ft<Q.length();ft++){const at=Q.getSection(ft);ht+=zy(Q.getCodePoint(ft),at,nt,ot,W,lt)}return ht/Math.max(1,Math.ceil(ht/X))}(R,L,O,z,N,V),j=R.text.indexOf("\u200b")>=0;let Z=0;for(let Q=0;Q<R.length();Q++){const W=R.getSection(Q),X=R.getCodePoint(Q);if(nm[X]||(Z+=zy(X,W,z,N,L,V)),Q<R.length()-1){const nt=!((K=X)<11904||!(Ht_Bopomofo_Extended(K)||Ht_Bopomofo(K)||Ht_CJK_Compatibility_Forms(K)||Ht_CJK_Compatibility_Ideographs(K)||Ht_CJK_Compatibility(K)||Ht_CJK_Radicals_Supplement(K)||Ht_CJK_Strokes(K)||Ht_CJK_Symbols_and_Punctuation(K)||Ht_CJK_Unified_Ideographs_Extension_A(K)||Ht_CJK_Unified_Ideographs(K)||Ht_Enclosed_CJK_Letters_and_Months(K)||Ht_Halfwidth_and_Fullwidth_Forms(K)||Ht_Hiragana(K)||Ht_Ideographic_Description_Characters(K)||Ht_Kangxi_Radicals(K)||Ht_Katakana_Phonetic_Extensions(K)||Ht_Katakana(K)||Ht_Vertical_Forms(K)||Ht_Yi_Radicals(K)||Ht_Yi_Syllables(K)));(PS[X]||nt||W.imageName)&&B.push(rm(Q+1,Z,$,B,RS(X,R.getCodePoint(Q+1),nt&&j),!1))}}var K;return Gb(rm(R.length(),Z,$,B,0,!0))}(E,p,l,t,r,v),{processBidirectionalText:C,processStyledBidirectionalText:I}=wi;if(C&&1===E.sections.length){const R=C(E.toString(),T);for(const L of R){const O=new Dd;O.text=L,O.sections=E.sections;for(let z=0;z<L.length;z++)O.sectionIndex.push(0);D.push(O)}}else if(I){const R=I(E.text,E.sectionIndex,T);for(const L of R){const O=new Dd;O.text=L[0],O.sectionIndex=L[1],O.sections=E.sections,D.push(O)}}else D=function(R,L){const O=[],z=R.text;let N=0;for(const V of L)O.push(R.substring(N,V)),N=V;return N<z.length&&O.push(R.substring(N,z.length)),O}(E,T);const A=[],M={positionedLines:A,text:E.toString(),top:m[1],bottom:m[1],left:m[0],right:m[0],writingMode:_,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(R,L,O,z,N,V,B,$,j,Z,K,Q){let W=0,X=0,nt=0;const ot="right"===$?1:"left"===$?0:.5;let lt=!1;for(const Ot of N){const kt=Ot.getSections();for(const zt of kt){if(zt.imageName)continue;const Zt=L[zt.fontStack];if(Zt&&(lt=void 0!==Zt.ascender&&void 0!==Zt.descender,!lt))break}if(!lt)break}let ht=0;for(const Ot of N){Ot.trim();const kt=Ot.getMaxScale(),zt=24*(kt-1),Zt={positionedGlyphs:[],lineOffset:0};R.positionedLines[ht]=Zt;const oe=Zt.positionedGlyphs;let Se=0;if(!Ot.length()){X+=V,++ht;continue}let We=0,Ee=0;for(let ie=0;ie<Ot.length();ie++){const te=Ot.getSection(ie),Ne=Ot.getSectionIndex(ie),Xe=Ot.getCodePoint(ie);let Ce=te.scale,yn=null,On=null,Rn=null,Dn=24,lr=0;const Fn=!(j===Bn.horizontal||!K&&!hl(Xe)||K&&(nm[Xe]||(ft=Xe,Ht_Arabic(ft)||Ht_Arabic_Supplement(ft)||Ht_Arabic_Extended_A(ft)||Ht_Arabic_Presentation_Forms_A(ft)||Ht_Arabic_Presentation_Forms_B(ft))));if(te.imageName){const jn=z[te.imageName];if(!jn)continue;Rn=te.imageName,R.iconsInText=R.iconsInText||!0,On=jn.paddedRect;const pn=jn.displaySize;Ce=24*Ce/Q,yn={width:pn[0],height:pn[1],left:1,top:-3,advance:Fn?pn[1]:pn[0],localGlyph:!1},lr=lt?-yn.height*Ce:24*kt-17-pn[1]*Ce,Dn=yn.advance;const Si=(Fn?pn[0]:pn[1])*Ce-24*kt;Si>0&&Si>Se&&(Se=Si)}else{const jn=O[te.fontStack];if(!jn)continue;jn[Xe]&&(On=jn[Xe]);const pn=L[te.fontStack];if(!pn)continue;const Si=pn.glyphs[Xe];if(!Si)continue;if(yn=Si.metrics,Dn=8203!==Xe?24:0,lt){const ta=void 0!==pn.ascender?Math.abs(pn.ascender):0,Ol=void 0!==pn.descender?Math.abs(pn.descender):0,ea=(ta+Ol)*Ce;We<ea&&(We=ea,Ee=(ta-Ol)/2*Ce),lr=-ta*Ce}else lr=24*(kt-Ce)-17}Fn?(R.verticalizable=!0,oe.push({glyph:Xe,imageName:Rn,x:W,y:X+lr,vertical:Fn,scale:Ce,localGlyph:yn.localGlyph,fontStack:te.fontStack,sectionIndex:Ne,metrics:yn,rect:On}),W+=Dn*Ce+Z):(oe.push({glyph:Xe,imageName:Rn,x:W,y:X+lr,vertical:Fn,scale:Ce,localGlyph:yn.localGlyph,fontStack:te.fontStack,sectionIndex:Ne,metrics:yn,rect:On}),W+=yn.advance*Ce+Z)}0!==oe.length&&(nt=Math.max(W-Z,nt),lt?qb(oe,ot,Se,Ee,V*kt/2):qb(oe,ot,Se,0,V/2)),W=0;const pe=V*kt+Se;Zt.lineOffset=Math.max(Se,zt),X+=pe,++ht}var ft;const at=X,{horizontalAlign:ut,verticalAlign:Et}=im(B);(function(Ot,kt,zt,Zt,oe,Se){const We=(kt-zt)*oe,Ee=-Se*Zt;for(const pe of Ot)for(const ie of pe.positionedGlyphs)ie.x+=We,ie.y+=Ee})(R.positionedLines,ot,ut,Et,nt,at),R.top+=-Et*at,R.bottom=R.top+at,R.left+=-ut*nt,R.right=R.left+nt,R.hasBaseline=lt}(M,t,n,r,D,c,h,f,_,p,y,b),!function(R){for(const L of R)if(0!==L.positionedGlyphs.length)return!1;return!0}(A)&&M}const nm={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},PS={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function zy(e,t,n,r,s,l){if(t.imageName){const c=r[t.imageName];return c?c.displaySize[0]*t.scale*24/l+s:0}{const c=n[t.fontStack],h=c&&c.glyphs[e];return h?h.metrics.advance*t.scale+s:0}}function Ny(e,t,n,r){const s=Math.pow(e-t,2);return r?e<t?s/2:2*s:s+Math.abs(n)*n}function RS(e,t,n){let r=0;return 10===e&&(r-=1e4),n&&(r+=150),40!==e&&65288!==e||(r+=50),41!==t&&65289!==t||(r+=50),r}function rm(e,t,n,r,s,l){let c=null,h=Ny(t,n,s,l);for(const f of r){const p=Ny(t-f.x,n,s,l)+f.badness;p<=h&&(c=f,h=p)}return{index:e,x:t,priorBreak:c,badness:h}}function Gb(e){return e?Gb(e.priorBreak).concat(e.index):[]}function im(e){let t=.5,n=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(e){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:t,verticalAlign:n}}function qb(e,t,n,r,s){if(!(t||n||r||s))return;const l=e.length-1,c=e[l],h=(c.x+c.metrics.advance*c.scale)*t;for(let f=0;f<=l;f++)e[f].x-=h,e[f].y+=n+r+s}function LS(e,t,n,r){const{horizontalAlign:s,verticalAlign:l}=im(r),c=n[0]-e.displaySize[0]*s,h=n[1]-e.displaySize[1]*l;return{imagePrimary:e,imageSecondary:t,top:h,bottom:h+e.displaySize[1],left:c,right:c+e.displaySize[0]}}function Wb(e,t,n,r,s,l){const c=e.imagePrimary;let h;if(c.content){const D=c.content,T=c.pixelRatio||1;h=[D[0]/T,D[1]/T,c.displaySize[0]-D[2]/T,c.displaySize[1]-D[3]/T]}const f=t.left*l,p=t.right*l;let m,_,y,v;"width"===n||"both"===n?(v=s[0]+f-r[3],_=s[0]+p+r[1]):(v=s[0]+(f+p-c.displaySize[0])/2,_=v+c.displaySize[0]);const b=t.top*l,E=t.bottom*l;return"height"===n||"both"===n?(m=s[1]+b-r[0],y=s[1]+E+r[2]):(m=s[1]+(b+E-c.displaySize[1])/2,y=m+c.displaySize[1]),{imagePrimary:c,imageSecondary:void 0,top:m,right:_,bottom:y,left:v,collisionPadding:h}}class Ca extends tt{constructor(t,n,r,s,l){super(t,n),this.angle=s,this.z=r,void 0!==l&&(this.segment=l)}clone(){return new Ca(this.x,this.y,this.z,this.angle,this.segment)}}function Sd(e,t,n,r,s){if(void 0===t.segment)return!0;let l=t,c=t.segment+1,h=0;for(;h>-n/2;){if(c--,c<0)return!1;h-=e[c].dist(l),l=e[c]}h+=e[c].dist(e[c+1]),c++;const f=[];let p=0;for(;h<n/2;){const m=e[c],_=e[c+1];if(!_)return!1;let y=e[c-1].angleTo(m)-m.angleTo(_);for(y=Math.abs((y+3*Math.PI)%(2*Math.PI)-Math.PI),f.push({distance:h,angleDelta:y}),p+=y;h-f[0].distance>r;)p-=f.shift().angleDelta;if(p>s)return!1;c++,h+=m.dist(_)}return!0}function Cl(e){let t=0;for(let n=0;n<e.length-1;n++)t+=e[n].dist(e[n+1]);return t}function kS(e,t,n){return e?.6*t*n:0}function ju(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0)}function OS(e,t,n,r,s,l){const c=kS(n,s,l),h=ju(n,r)*l;let f=0;const p=Cl(e)/2;for(let m=0;m<e.length-1;m++){const _=e[m],y=e[m+1],v=_.dist(y);if(f+v>p){const b=(p-f)/v,E=de(_.x,y.x,b),D=de(_.y,y.y,b),T=new Ca(E,D,0,y.angleTo(_),m);return!c||Sd(e,T,h,c,t)?T:void 0}f+=v}}function FS(e,t,n,r,s,l,c,h,f){const p=kS(r,l,c),m=ju(r,s),_=m*c,y=0===e[0].x||e[0].x===f||0===e[0].y||e[0].y===f;return t-_<t/4&&(t=_+t/4),om(e,y?t/2*h%t:(m/2+2*l)*c*h%t,t,p,n,_,y,!1,f)}function om(e,t,n,r,s,l,c,h,f){const p=l/2,m=Cl(e);let _=0,y=t-n,v=[];for(let b=0;b<e.length-1;b++){const E=e[b],D=e[b+1],T=E.dist(D),C=D.angleTo(E);for(;y+n<_+T;){y+=n;const I=(y-_)/T,A=de(E.x,D.x,I),M=de(E.y,D.y,I);if(A>=0&&A<f&&M>=0&&M<f&&y-p>=0&&y+p<=m){const R=new Ca(A,M,0,C,b);r&&!Sd(e,R,l,r,s)||v.push(R)}}_+=T}return h||v.length||c||(v=om(e,_/2,n,r,s,l,c,!0,f)),v}function Zb(e,t,n,r,s){const l=[];for(let c=0;c<e.length;c++){const h=e[c];let f;for(let p=0;p<h.length-1;p++){let m=h[p],_=h[p+1];m.x<t&&_.x<t||(m.x<t?m=new tt(t,m.y+(t-m.x)/(_.x-m.x)*(_.y-m.y))._round():_.x<t&&(_=new tt(t,m.y+(t-m.x)/(_.x-m.x)*(_.y-m.y))._round()),m.y<n&&_.y<n||(m.y<n?m=new tt(m.x+(n-m.y)/(_.y-m.y)*(_.x-m.x),n)._round():_.y<n&&(_=new tt(m.x+(n-m.y)/(_.y-m.y)*(_.x-m.x),n)._round()),m.x>=r&&_.x>=r||(m.x>=r?m=new tt(r,m.y+(r-m.x)/(_.x-m.x)*(_.y-m.y))._round():_.x>=r&&(_=new tt(r,m.y+(r-m.x)/(_.x-m.x)*(_.y-m.y))._round()),m.y>=s&&_.y>=s||(m.y>=s?m=new tt(m.x+(s-m.y)/(_.y-m.y)*(_.x-m.x),s)._round():_.y>=s&&(_=new tt(m.x+(s-m.y)/(_.y-m.y)*(_.x-m.x),s)._round()),f&&m.equals(f[f.length-1])||(f=[m],l.push(f)),f.push(_)))))}}return l}jt(Ca,"Anchor");const ao=1e20;function Vu(e,t,n,r,s,l,c,h,f){for(let p=t;p<t+r;p++)gi(e,n*l+p,l,s,c,h,f);for(let p=n;p<n+s;p++)gi(e,p*l+t,1,r,c,h,f)}function gi(e,t,n,r,s,l,c){l[0]=0,c[0]=-ao,c[1]=ao,s[0]=e[t];for(let h=1,f=0,p=0;h<r;h++){s[h]=e[t+h*n];const m=h*h;do{const _=l[f];p=(s[h]-s[_]+m-_*_)/(h-_)/2}while(p<=c[f]&&--f>-1);f++,l[f]=h,c[f]=p,c[f+1]=ao}for(let h=0,f=0;h<r;h++){for(;c[f+1]<h;)f++;const p=l[f],m=h-p;e[t+h*n]=s[p]+m*m}}class Ma{constructor(t,n,r){this.requestManager=t,this.localGlyphMode=n,this.localFontFamily=r,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t,n){this.urls[n]=t}getGlyphs(t,n,r){const s=[],l=this.urls[n]||Ae.GLYPHS_URL;for(const c in t)for(const h of t[c])s.push({stack:c,id:h});Ul(s,({stack:c,id:h},f)=>{let p=this.entries[c];p||(p=this.entries[c]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let m=p.glyphs[h];if(void 0!==m)return void f(null,{stack:c,id:h,glyph:m});if(m=this._tinySDF(p,c,h),m)return p.glyphs[h]=m,void f(null,{stack:c,id:h,glyph:m});const _=Math.floor(h/256);if(256*_>65535)return void f(new Error("glyphs > 65535 not supported"));if(p.ranges[_])return void f(null,{stack:c,id:h,glyph:m});let y=p.requests[_];y||(y=p.requests[_]=[],Ma.loadGlyphRange(c,_,l,this.requestManager,(v,b)=>{if(b){p.ascender=b.ascender,p.descender=b.descender;for(const E in b.glyphs)this._doesCharSupportLocalGlyph(+E)||(p.glyphs[+E]=b.glyphs[+E]);p.ranges[_]=!0}for(const E of y)E(v,b);delete p.requests[_]})),y.push((v,b)=>{v?f(v):b&&f(null,{stack:c,id:h,glyph:b.glyphs[h]||null})})},(c,h)=>{if(c)r(c);else if(h){const f={};for(const{stack:p,id:m,glyph:_}of h)void 0===f[p]&&(f[p]={}),void 0===f[p].glyphs&&(f[p].glyphs={}),f[p].glyphs[m]=_&&{id:_.id,bitmap:_.bitmap.clone(),metrics:_.metrics},f[p].ascender=this.entries[p].ascender,f[p].descender=this.entries[p].descender;r(null,f)}})}_doesCharSupportLocalGlyph(t){return 0!==this.localGlyphMode&&(2===this.localGlyphMode?!!this.localFontFamily:!!this.localFontFamily&&(Ht_CJK_Unified_Ideographs(t)||Ht_Hangul_Syllables(t)||Ht_Hiragana(t)||Ht_Katakana(t)||Ht_CJK_Symbols_and_Punctuation(t)||Ht_CJK_Unified_Ideographs_Extension_A(t)||Ht_CJK_Unified_Ideographs_Extension_B(t)))}_tinySDF(t,n,r){const s=this.localFontFamily;if(!s||!this._doesCharSupportLocalGlyph(r))return;let l=t.tinySDF;if(!l){let E="400";/bold/i.test(n)?E="900":/medium/i.test(n)?E="500":/light/i.test(n)&&(E="200"),l=t.tinySDF=new Ma.TinySDF({fontFamily:s,fontWeight:E,fontSize:48,buffer:6,radius:16}),l.fontWeight=E}if(this.localGlyphs[l.fontWeight][r])return this.localGlyphs[l.fontWeight][r];const c=String.fromCodePoint(r),{data:h,width:f,height:p,glyphWidth:m,glyphHeight:_,glyphLeft:y,glyphTop:v,glyphAdvance:b}=l.draw(c);return this.localGlyphs[l.fontWeight][r]={id:r,bitmap:new Hs({width:f,height:p},h),metrics:{width:m/2,height:_/2,left:y/2,top:v/2-27,advance:b/2,localGlyph:!0}}}}Ma.loadGlyphRange=function(e,t,n,r,s){const l=256*t,c=l+255,h=r.transformRequest(r.normalizeGlyphsURL(n).replace("{fontstack}",e).replace("{range}",`${l}-${c}`),dt.Glyphs);Pt(h,(f,p)=>{if(f)s(f);else if(p){const m={},_=new Xp(p).readFields(Qp,{});for(const y of _.glyphs)m[y.id]=y;s(null,{glyphs:m,ascender:_.ascender,descender:_.descender})}})},Ma.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:n=8,cutoff:r=.25,fontFamily:s="sans-serif",fontWeight:l="normal",fontStyle:c="normal"}={}){this.buffer=t,this.cutoff=r,this.radius=n;const h=this.size=e+4*t,f=this._createCanvas(h),p=this.ctx=f.getContext("2d",{willReadFrequently:!0});p.font=`${c} ${l} ${e}px ${s}`,p.textBaseline="alphabetic",p.textAlign="left",p.fillStyle="black",this.gridOuter=new Float64Array(h*h),this.gridInner=new Float64Array(h*h),this.f=new Float64Array(h),this.z=new Float64Array(h+1),this.v=new Uint16Array(h)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:n,actualBoundingBoxDescent:r,actualBoundingBoxLeft:s,actualBoundingBoxRight:l}=this.ctx.measureText(e),c=Math.ceil(n),h=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(l-s))),f=Math.min(this.size-this.buffer,c+Math.ceil(r)),p=h+2*this.buffer,m=f+2*this.buffer,_=Math.max(p*m,0),y=new Uint8ClampedArray(_),v={data:y,width:p,height:m,glyphWidth:h,glyphHeight:f,glyphTop:c,glyphLeft:0,glyphAdvance:t};if(0===h||0===f)return v;const{ctx:b,buffer:E,gridInner:D,gridOuter:T}=this;b.clearRect(E,E,h,f),b.fillText(e,E,E+c);const C=b.getImageData(E,E,h,f);T.fill(ao,0,_),D.fill(0,0,_);for(let I=0;I<f;I++)for(let A=0;A<h;A++){const M=C.data[4*(I*h+A)+3]/255;if(0===M)continue;const R=(I+E)*p+A+E;if(1===M)T[R]=0,D[R]=ao;else{const L=.5-M;T[R]=L>0?L*L:0,D[R]=L<0?L*L:0}}Vu(T,0,0,p,m,p,this.f,this.v,this.z),Vu(D,E,E,h,f,p,this.f,this.v,this.z);for(let I=0;I<_;I++){const A=Math.sqrt(T[I])-Math.sqrt(D[I]);y[I]=Math.round(255-255*(A/this.radius+this.cutoff))}return v}};function sm(e,t,n,r){const s=[],l=e.imagePrimary,c=l.pixelRatio,h=l.paddedRect.w-2,f=l.paddedRect.h-2,p=e.right-e.left,m=e.bottom-e.top,_=l.stretchX||[[0,h]],y=l.stretchY||[[0,f]],v=(V,B)=>V+B[1]-B[0],b=_.reduce(v,0),E=y.reduce(v,0),D=h-b,T=f-E;let C=0,I=b,A=0,M=E,R=0,L=D,O=0,z=T;if(l.content&&r){const V=l.content;C=Ia(_,0,V[0]),A=Ia(y,0,V[1]),I=Ia(_,V[0],V[2]),M=Ia(y,V[1],V[3]),R=V[0]-C,O=V[1]-A,L=V[2]-V[0]-I,z=V[3]-V[1]-M}const N=(V,B,$,j)=>{const Z=Aa(V.stretch-C,I,p,e.left),K=Pa(V.fixed-R,L,V.stretch,b),Q=Aa(B.stretch-A,M,m,e.top),W=Pa(B.fixed-O,z,B.stretch,E),X=Aa($.stretch-C,I,p,e.left),nt=Pa($.fixed-R,L,$.stretch,b),ot=Aa(j.stretch-A,M,m,e.top),lt=Pa(j.fixed-O,z,j.stretch,E),ht=new tt(Z,Q),ft=new tt(X,Q),at=new tt(X,ot),ut=new tt(Z,ot),Et=new tt(K/c,W/c),Ot=new tt(nt/c,lt/c),kt=t*Math.PI/180;if(kt){const Ee=Math.sin(kt),pe=Math.cos(kt),ie=[pe,-Ee,Ee,pe];ht._matMult(ie),ft._matMult(ie),ut._matMult(ie),at._matMult(ie)}const zt=V.stretch+V.fixed,Zt=$.stretch+$.fixed,oe=B.stretch+B.fixed,Se=j.stretch+j.fixed,We=e.imageSecondary;return{tl:ht,tr:ft,bl:ut,br:at,texPrimary:{x:l.paddedRect.x+1+zt,y:l.paddedRect.y+1+oe,w:Zt-zt,h:Se-oe},texSecondary:We?{x:We.paddedRect.x+1+zt,y:We.paddedRect.y+1+oe,w:Zt-zt,h:Se-oe}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Et,pixelOffsetBR:Ot,minFontScaleX:L/c/p,minFontScaleY:z/c/m,isSDF:n}};if(r&&(l.stretchX||l.stretchY)){const V=vc(_,D,b),B=vc(y,T,E);for(let $=0;$<V.length-1;$++){const j=V[$],Z=V[$+1];for(let K=0;K<B.length-1;K++)s.push(N(j,B[K],Z,B[K+1]))}}else s.push(N({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:h+1},{fixed:0,stretch:f+1}));return s}function Ia(e,t,n){let r=0;for(const s of e)r+=Math.max(t,Math.min(n,s[1]))-Math.max(t,Math.min(n,s[0]));return r}function vc(e,t,n){const r=[{fixed:-1,stretch:0}];for(const[s,l]of e){const c=r[r.length-1];r.push({fixed:s-c.stretch,stretch:c.stretch}),r.push({fixed:s-c.stretch,stretch:c.stretch+(l-s)})}return r.push({fixed:t+1,stretch:n}),r}function Aa(e,t,n,r){return e/t*n+r}function Pa(e,t,n,r){return e-t*n/r}function Uu(e,t,n,r){const s=t+e.positionedLines[r].lineOffset;return 0===r?n+s/2:n+(s+(t+e.positionedLines[r-1].lineOffset))/2}function $u(e,t=1,n=!1){let r=1/0,s=1/0,l=-1/0,c=-1/0;const h=e[0];for(let v=0;v<h.length;v++){const b=h[v];(!v||b.x<r)&&(r=b.x),(!v||b.y<s)&&(s=b.y),(!v||b.x>l)&&(l=b.x),(!v||b.y>c)&&(c=b.y)}const f=Math.min(l-r,c-s);let p=f/2;const m=new Zl([],Hu);if(0===f)return new tt(r,s);for(let v=r;v<l;v+=f)for(let b=s;b<c;b+=f)m.push(new cs(v+p,b+p,p,e));let _=function(v){let b=0,E=0,D=0;const T=v[0];for(let C=0,I=T.length,A=I-1;C<I;A=C++){const M=T[C],R=T[A],L=M.x*R.y-R.x*M.y;E+=(M.x+R.x)*L,D+=(M.y+R.y)*L,b+=3*L}return new cs(E/b,D/b,0,v)}(e),y=m.length;for(;m.length;){const v=m.pop();(v.d>_.d||!_.d)&&(_=v,n&&console.log("found best %d after %d probes",Math.round(1e4*v.d)/1e4,y)),v.max-_.d<=t||(p=v.h/2,m.push(new cs(v.p.x-p,v.p.y-p,p,e)),m.push(new cs(v.p.x+p,v.p.y-p,p,e)),m.push(new cs(v.p.x-p,v.p.y+p,p,e)),m.push(new cs(v.p.x+p,v.p.y+p,p,e)),y+=4)}return n&&(console.log(`num probes: ${y}`),console.log(`best distance: ${_.d}`)),_.p}function Hu(e,t){return t.max-e.max}class cs{constructor(t,n,r,s){this.p=new tt(t,n),this.h=r,this.d=function(l,c){let h=!1,f=1/0;for(let p=0;p<c.length;p++){const m=c[p];for(let _=0,y=m.length,v=y-1;_<y;v=_++){const b=m[_],E=m[v];b.y>l.y!=E.y>l.y&&l.x<(E.x-b.x)*(l.y-b.y)/(E.y-b.y)+b.x&&(h=!h),f=Math.min(f,ny(l,b,E))}}return(h?1:-1)*Math.sqrt(f)}(this.p,s),this.max=this.d+this.h*Math.SQRT2}}const am=Number.POSITIVE_INFINITY,Xb=Math.sqrt(2);function lm(e,[t,n]){let r=0,s=0;if(n===am){t<0&&(t=0);const l=t/Xb;switch(e){case"top-right":case"top-left":s=l-7;break;case"bottom-right":case"bottom-left":s=7-l;break;case"bottom":s=7-t;break;case"top":s=t-7}switch(e){case"top-right":case"bottom-right":r=-l;break;case"top-left":case"bottom-left":r=l;break;case"left":r=t;break;case"right":r=-t}}else{switch(t=Math.abs(t),n=Math.abs(n),e){case"top-right":case"top-left":case"top":s=n-7;break;case"bottom-right":case"bottom-left":case"bottom":s=7-n}switch(e){case"top-right":case"bottom-right":case"right":r=-t;break;case"top-left":case"bottom-left":case"left":r=t}}return[r,s]}function Yb(e,t,n,r,s,l,c,h,f,p,m){e.createArrays(),e.tilePixelRatio=st/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;const _=e.layers[0].layout,y=e.layers[0]._unevaluatedLayout._values,v={};if("composite"===e.textSizeData.kind){const{minZoom:T,maxZoom:C}=e.textSizeData;v.compositeTextSizes=[y["text-size"].possiblyEvaluate(new Gn(T),h),y["text-size"].possiblyEvaluate(new Gn(C),h)]}if("composite"===e.iconSizeData.kind){const{minZoom:T,maxZoom:C}=e.iconSizeData;v.compositeIconSizes=[y["icon-size"].possiblyEvaluate(new Gn(T),h),y["icon-size"].possiblyEvaluate(new Gn(C),h)]}v.layoutTextSize=y["text-size"].possiblyEvaluate(new Gn(f+1),h),v.layoutIconSize=y["icon-size"].possiblyEvaluate(new Gn(f+1),h),v.textMaxSize=y["text-size"].possiblyEvaluate(new Gn(18),h);const b="map"===_.get("text-rotation-alignment")&&"point"!==_.get("symbol-placement"),E=_.get("text-size");let D=!1;for(const T of e.features)if(T.icon&&T.icon.nameSecondary){D=!0;break}for(const T of e.features){const C=_.get("text-font").evaluate(T,{},h).join(","),I=E.evaluate(T,{},h),A=v.layoutTextSize.evaluate(T,{},h),M=(v.layoutIconSize.evaluate(T,{},h),{horizontal:{},vertical:void 0}),R=T.text;let L,O=[0,0];if(R){const V=R.toString(),B=24*_.get("text-letter-spacing").evaluate(T,{},h),$=24*_.get("text-line-height").evaluate(T,{},h),j=Wx(V)?B:0,Z=_.get("text-anchor").evaluate(T,{},h),K=_.get("text-variable-anchor");if(!K){const ot=_.get("text-radial-offset").evaluate(T,{},h);O=ot?lm(Z,[24*ot,am]):_.get("text-offset").evaluate(T,{},h).map(lt=>24*lt)}let Q=b?"center":_.get("text-justify").evaluate(T,{},h);const W="point"===_.get("symbol-placement"),X=W?24*_.get("text-max-width").evaluate(T,{},h):1/0,nt=ot=>{e.allowVerticalPlacement&&ul(V)&&(M.vertical=Fy(R,t,n,s,C,X,$,Z,ot,j,O,Bn.vertical,!0,A,I))};if(!b&&K){const ot="auto"===Q?K.map(ht=>cm(ht)):[Q];let lt=!1;for(let ht=0;ht<ot.length;ht++){const ft=ot[ht];if(!M.horizontal[ft])if(lt)M.horizontal[ft]=M.horizontal[0];else{const at=Fy(R,t,n,s,C,X,$,"center",ft,j,O,Bn.horizontal,!1,A,I);at&&(M.horizontal[ft]=at,lt=1===at.positionedLines.length)}}nt("left")}else{if("auto"===Q&&(Q=cm(Z)),W||_.get("text-writing-mode").indexOf("horizontal")>=0||!ul(V)){const ot=Fy(R,t,n,s,C,X,$,Z,Q,j,O,Bn.horizontal,!1,A,I);ot&&(M.horizontal[Q]=ot)}nt(W?"left":Q)}}let z=!1;if(T.icon&&T.icon.namePrimary){const V=r[T.icon.namePrimary];V&&(L=LS(s[T.icon.namePrimary],T.icon.nameSecondary?s[T.icon.nameSecondary]:void 0,_.get("icon-offset").evaluate(T,{},h),_.get("icon-anchor").evaluate(T,{},h)),z=V.sdf,void 0===e.sdfIcons?e.sdfIcons=V.sdf:e.sdfIcons!==V.sdf&&Y("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(V.pixelRatio!==e.pixelRatio||0!==_.get("icon-rotate").constantOr(1))&&(e.iconsNeedLinear=!0))}const N=Jb(M.horizontal)||M.vertical;e.iconsInText||(e.iconsInText=!!N&&N.iconsInText),(N||L)&&Kb(e,T,M,L,r,v,A,0,O,z,c,h,p,m,D)}l&&e.generateCollisionDebugBuffers(f,e.collisionBoxArray)}function cm(e){switch(e){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Kb(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b){let E=l.textMaxSize.evaluate(t,{},_);void 0===E&&(E=c);const D=e.layers[0].layout,T=D.get("icon-offset").evaluate(t,{},_),C=Jb(n.horizontal)||n.vertical,I="globe"===y.name,M=c/24,R=e.tilePixelRatio*E/24,L=(Z=e.overscaling,e.zoom>18&&Z>2&&(Z>>=1),Math.max(st/(512*Z),1)*D.get("symbol-spacing")),O=D.get("text-padding")*e.tilePixelRatio,z=D.get("icon-padding")*e.tilePixelRatio,N=be(D.get("text-max-angle")),V="map"===D.get("text-rotation-alignment")&&"point"!==D.get("symbol-placement"),B="map"===D.get("icon-rotation-alignment")&&"point"!==D.get("symbol-placement"),$=D.get("symbol-placement"),j=L/2;var Z;const K=D.get("icon-text-fit").evaluate(t,{},_),Q=D.get("icon-text-fit-padding").evaluate(t,{},_),W="none"!==K;let X;!1===e.hasAnyIconTextFit&&W&&(e.hasAnyIconTextFit=!0),r&&W&&(e.allowVerticalPlacement&&n.vertical&&(X=Wb(r,n.vertical,K,Q,T,M)),C&&(r=Wb(r,C,K,Q,T,M)));const nt=(ot,lt,ht)=>{if(lt.x<0||lt.x>=st||lt.y<0||lt.y>=st)return;let ft=null;if(I){const{x:at,y:ut,z:Et}=y.projectTilePoint(lt.x,lt.y,ht);ft={anchor:new Ca(at,ut,Et,0,void 0),up:y.upVector(ht,lt.x,lt.y)}}!function(at,ut,Et,Ot,kt,zt,Zt,oe,Se,We,Ee,pe,ie,te,Ne,Xe,Ce,yn,On,Rn,Dn,lr,Fn,jn,pn,Si,ta){const Ol=at.addToLineVertexArray(ut,Ot);let ea,hf,df,lg,QM,Ho,PT,RT=0,LT=0,kT=0,OT=0,Sv=-1,Cv=-1;const na={};let FT=h1("");const Bc=Et?Et.anchor:ut,Mv="none"!==Se.layout.get("icon-text-fit").evaluate(Dn,{},pn);let Iv=0,Av=0;if(void 0===Se._unevaluatedLayout.getValue("text-radial-offset")?[Iv,Av]=Se.layout.get("text-offset").evaluate(Dn,{},pn).map(fo=>24*fo):(Iv=24*Se.layout.get("text-radial-offset").evaluate(Dn,{},pn),Av=am),at.allowVerticalPlacement&&kt.vertical){const fo=kt.vertical;if(Ne)Ho=jy(fo),oe&&(PT=jy(oe));else{const Gi=Se.layout.get("text-rotate").evaluate(Dn,{},pn)+90;df=um(We,Bc,ut,Ee,pe,ie,fo,te,Gi,Xe),oe&&(lg=um(We,Bc,ut,Ee,pe,ie,oe,yn,Gi))}}if(zt){const fo=Se.layout.get("icon-rotate").evaluate(Dn,{},pn),Gi=sm(zt,fo,Fn,Mv),ph=oe?sm(oe,fo,Fn,Mv):void 0;hf=um(We,Bc,ut,Ee,pe,ie,zt,yn,fo),RT=4*Gi.length;const zT=at.iconSizeData;let jc=null;"source"===zT.kind?(jc=[Ws*Se.layout.get("icon-size").evaluate(Dn,{},pn)],jc[0]>Ra&&Y(`${at.layerIds[0]}: Value for "icon-size" is >= ${Gu}. Reduce your "icon-size".`)):"composite"===zT.kind&&(jc=[Ws*lr.compositeIconSizes[0].evaluate(Dn,{},pn),Ws*lr.compositeIconSizes[1].evaluate(Dn,{},pn)],(jc[0]>Ra||jc[1]>Ra)&&Y(`${at.layerIds[0]}: Value for "icon-size" is >= ${Gu}. Reduce your "icon-size".`)),at.addSymbols(at.icon,Gi,jc,Rn,On,Dn,!1,Et,ut,Ol.lineStartIndex,Ol.lineLength,-1,jn,pn,Si,ta),Sv=at.icon.placedSymbolArray.length-1,ph&&(LT=4*ph.length,at.addSymbols(at.icon,ph,jc,Rn,On,Dn,Bn.vertical,Et,ut,Ol.lineStartIndex,Ol.lineLength,-1,jn,pn,Si,ta),Cv=at.icon.placedSymbolArray.length-1)}for(const fo in kt.horizontal){const Gi=kt.horizontal[fo];ea||(FT=h1(Gi.text),Ne?QM=jy(Gi):ea=um(We,Bc,ut,Ee,pe,ie,Gi,te,Se.layout.get("text-rotate").evaluate(Dn,{},pn),Xe));const ph=1===Gi.positionedLines.length;if(kT+=By(at,Et,ut,Gi,Zt,Se,Ne,Dn,Xe,Ol,kt.vertical?Bn.horizontal:Bn.horizontalOnly,ph?Object.keys(kt.horizontal):[fo],na,Sv,lr,jn,pn,Si),ph)break}kt.vertical&&(OT+=By(at,Et,ut,kt.vertical,Zt,Se,Ne,Dn,Xe,Ol,Bn.vertical,["vertical"],na,Cv,lr,jn,pn,Si));let Fl=-1;const Pv=(fo,Gi)=>fo?Math.max(fo,Gi):Gi;Fl=Pv(QM,Fl),Fl=Pv(Ho,Fl),Fl=Pv(PT,Fl);const tI=Fl>-1?1:0;at.glyphOffsetArray.length>=Zu.MAX_GLYPHS&&Y("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Dn.sortKey&&at.addToSortKeyRanges(at.symbolInstances.length,Dn.sortKey),at.symbolInstances.emplaceBack(ut.x,ut.y,Bc.x,Bc.y,Bc.z,na.right>=0?na.right:-1,na.center>=0?na.center:-1,na.left>=0?na.left:-1,na.vertical>=0?na.vertical:-1,Sv,Cv,FT,void 0!==ea?ea:at.collisionBoxArray.length,void 0!==ea?ea+1:at.collisionBoxArray.length,void 0!==df?df:at.collisionBoxArray.length,void 0!==df?df+1:at.collisionBoxArray.length,void 0!==hf?hf:at.collisionBoxArray.length,void 0!==hf?hf+1:at.collisionBoxArray.length,lg||at.collisionBoxArray.length,lg?lg+1:at.collisionBoxArray.length,Ee,kT,OT,RT,LT,tI,0,Iv,Av,Fl,0,Mv?1:0)}(e,lt,ft,ot,n,r,s,X,e.layers[0],e.collisionBoxArray,t.index,t.sourceLayerIndex,e.index,O,V,f,0,z,B,T,t,l,p,m,_,v,b)};if("line"===$)for(const ot of Zb(t.geometry,0,0,st,st)){const lt=FS(ot,L,N,n.vertical||C,r,24,R,e.overscaling,st);for(const ht of lt)C&&zS(e,C.text,j,ht)||nt(ot,ht,_)}else if("line-center"===$){for(const ot of t.geometry)if(ot.length>1){const lt=OS(ot,N,n.vertical||C,r,24,R);lt&&nt(ot,lt,_)}}else if("Polygon"===t.type)for(const ot of Up(t.geometry,0)){const lt=$u(ot,16);nt(ot[0],new Ca(lt.x,lt.y,0,0,void 0),_)}else if("LineString"===t.type)for(const ot of t.geometry)nt(ot,new Ca(ot[0].x,ot[0].y,0,0,void 0),_);else if("Point"===t.type)for(const ot of t.geometry)for(const lt of ot)nt([lt],new Ca(lt.x,lt.y,0,0,void 0),_)}const Gu=255,Ra=Gu*Ws;function By(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T){const C=function(M,R,L,O,z,N,V,B){const $=[];if(0===R.positionedLines.length)return $;const j=O.layout.get("text-rotate").evaluate(N,{})*Math.PI/180,Z=function(nt){const ot=nt[0],lt=nt[1],ht=ot*lt;return ht>0?[ot,-lt]:ht<0?[-ot,lt]:0===ot?[lt,ot]:[lt,-ot]}(L);let K=Math.abs(R.top-R.bottom);for(const nt of R.positionedLines)K-=nt.lineOffset;const Q=R.positionedLines.length,W=K/Q;let X=R.top-L[1];for(let nt=0;nt<Q;++nt){const ot=R.positionedLines[nt];X=Uu(R,W,X,nt);for(const lt of ot.positionedGlyphs){if(!lt.rect)continue;const ht=lt.rect||{};let ft=4,at=!0,ut=1,Et=0;if(lt.imageName){const Rn=V[lt.imageName];if(!Rn)continue;if(Rn.sdf){Y("SDF images are not supported in formatted text and will be ignored.");continue}at=!1,ut=Rn.pixelRatio,ft=1/ut}const Ot=(z||B)&&lt.vertical,kt=lt.metrics.advance*lt.scale/2,zt=lt.metrics,Zt=lt.rect;if(null===Zt)continue;B&&R.verticalizable&&(Et=lt.imageName?kt-lt.metrics.width*lt.scale/2:0);const oe=z?[lt.x+kt,lt.y]:[0,0];let Se=[0,0],We=[0,0],Ee=!1;z||(Ot?(We=[lt.x+kt+Z[0],lt.y+Z[1]-Et],Ee=!0):Se=[lt.x+kt+L[0],lt.y+L[1]-Et]);const pe=Zt.w*lt.scale/(ut*(lt.localGlyph?2:1)),ie=Zt.h*lt.scale/(ut*(lt.localGlyph?2:1));let te,Ne,Xe,Ce;if(Ot){const Rn=lt.y-X,Dn=new tt(-kt,kt-Rn),lr=-Math.PI/2,Fn=new tt(...We);te=new tt(-kt+Se[0],Se[1]),te._rotateAround(lr,Dn)._add(Fn),te.x+=-Rn+kt,te.y-=(zt.left-ft)*lt.scale;const jn=lt.imageName?zt.advance*lt.scale:24*lt.scale,pn=String.fromCodePoint(lt.glyph);ky(pn)?te.x+=(1-ft)*lt.scale:Sa(pn)?te.x+=jn-zt.height*lt.scale+(-ft-1)*lt.scale:te.x+=lt.imageName||zt.width+2*ft===Zt.w&&zt.height+2*ft===Zt.h?(jn-ie)/2:(jn-(zt.height+2*ft)*lt.scale)/2,Ne=new tt(te.x,te.y-pe),Xe=new tt(te.x+ie,te.y),Ce=new tt(te.x+ie,te.y-pe)}else{const Rn=(zt.left-ft)*lt.scale-kt+Se[0],Dn=(-zt.top-ft)*lt.scale+Se[1],lr=Rn+pe,Fn=Dn+ie;te=new tt(Rn,Dn),Ne=new tt(lr,Dn),Xe=new tt(Rn,Fn),Ce=new tt(lr,Fn)}if(j){let Rn;Rn=z?new tt(0,0):Ee?new tt(Z[0],Z[1]):new tt(L[0],L[1]),te._rotateAround(j,Rn),Ne._rotateAround(j,Rn),Xe._rotateAround(j,Rn),Ce._rotateAround(j,Rn)}const yn=new tt(0,0),On=new tt(0,0);$.push({tl:te,tr:Ne,bl:Xe,br:Ce,texPrimary:ht,texSecondary:void 0,writingMode:R.writingMode,glyphOffset:oe,sectionIndex:lt.sectionIndex,isSDF:at,pixelOffsetTL:yn,pixelOffsetBR:On,minFontScaleX:0,minFontScaleY:0})}}return $}(0,r,f,l,c,h,s,e.allowVerticalPlacement),I=e.textSizeData;let A=null;"source"===I.kind?(A=[Ws*l.layout.get("text-size").evaluate(h,{},D)],A[0]>Ra&&Y(`${e.layerIds[0]}: Value for "text-size" is >= ${Gu}. Reduce your "text-size".`)):"composite"===I.kind&&(A=[Ws*b.compositeTextSizes[0].evaluate(h,{},D),Ws*b.compositeTextSizes[1].evaluate(h,{},D)],(A[0]>Ra||A[1]>Ra)&&Y(`${e.layerIds[0]}: Value for "text-size" is >= ${Gu}. Reduce your "text-size".`)),e.addSymbols(e.text,C,A,f,c,h,m,t,n,p.lineStartIndex,p.lineLength,v,E,D,T,!1);for(const M of _)y[M]=e.text.placedSymbolArray.length-1;return 4*C.length}function Jb(e){for(const t in e)return e[t];return null}function um(e,t,n,r,s,l,c,h,f,p){let m=c.top,_=c.bottom,y=c.left,v=c.right;const b=c.collisionPadding;if(b&&(y-=b[0],m-=b[1],v+=b[2],_+=b[3]),f){const E=new tt(y,m),D=new tt(v,m),T=new tt(y,_),C=new tt(v,_),I=be(f);let A=new tt(0,0);p&&(A=new tt(p[0],p[1])),E._rotateAround(I,A),D._rotateAround(I,A),T._rotateAround(I,A),C._rotateAround(I,A),y=Math.min(E.x,D.x,T.x,C.x),v=Math.max(E.x,D.x,T.x,C.x),m=Math.min(E.y,D.y,T.y,C.y),_=Math.max(E.y,D.y,T.y,C.y)}return e.emplaceBack(t.x,t.y,t.z,n.x,n.y,y,m,v,_,h,r,s,l),e.length-1}function jy(e){e.collisionPadding&&(e.top-=e.collisionPadding[1],e.bottom+=e.collisionPadding[3]);const t=e.bottom-e.top;return t>0?Math.max(10,t):null}function zS(e,t,n,r){const s=e.compareText;if(t in s){const l=s[t];for(let c=l.length-1;c>=0;c--)if(r.dist(l[c])<n)return!0}else s[t]=[];return s[t].push(r),!1}function Qb(e,t){const n=e.fovAboveCenter,r=e.elevation?e.elevation.getMinElevationBelowMSL()*t:0,s=(e._camera.position[2]*e.worldSize-r)/Math.cos(e._pitch),l=Math.sin(n)*s/Math.sin(Math.max(Math.PI/2-e._pitch-n,.01)),c=Math.sin(e._pitch)*l+s;return Math.min(1.01*c,s*(1/e._horizonShift))}function Ml(e,t){if(!t.isReprojectedInTileSpace)return{scale:1<<e.z,x:e.x,y:e.y,x2:e.x+1,y2:e.y+1,projection:t};const n=Math.pow(2,-e.z),r=e.x*n,s=(e.x+1)*n,l=e.y*n,c=(e.y+1)*n,h=Vi(r),f=Vi(s),p=dr(l),m=dr(c),_=t.project(h,p),y=t.project(f,p),v=t.project(f,m),b=t.project(h,m);let E=Math.min(_.x,y.x,v.x,b.x),D=Math.min(_.y,y.y,v.y,b.y),T=Math.max(_.x,y.x,v.x,b.x),C=Math.max(_.y,y.y,v.y,b.y);const I=n/16;function A(R,L,O,z,N,V){const B=(O+N)/2,$=(z+V)/2,j=t.project(Vi(B),dr($)),Z=Math.max(0,E-j.x,D-j.y,j.x-T,j.y-C);E=Math.min(E,j.x),T=Math.max(T,j.x),D=Math.min(D,j.y),C=Math.max(C,j.y),Z>I&&(A(R,j,O,z,B,$),A(j,L,B,$,N,V))}A(_,y,r,l,s,l),A(y,v,s,l,s,c),A(v,b,s,c,r,c),A(b,_,r,c,r,l),E-=I,D-=I,T+=I,C+=I;const M=1/Math.max(T-E,C-D);return{scale:M,x:E*M,y:D*M,x2:T*M,y2:C*M,projection:t}}function hm(e,t,n,r,s,l,c,h,f){if("globe"===f.name)return U_(e,t,new Oo(n,r,s),!1);const p=Ml({z:n,x:r,y:s},f);return new Tn([(l+p.x/p.scale)*t,t*(p.y/p.scale),c],[(l+p.x2/p.scale)*t,t*(p.y2/p.scale),h])}function tw(e,{x:t,y:n},r=0){return new tt(((t-r)*e.scale-e.x)*st,(n*e.scale-e.y)*st)}function lo(e,t,n=0){return H.fromValues(((t.x-n)*e.scale-e.x)*st,(t.y*e.scale-e.y)*st,X_(t.z,t.y))}const Eo=et.identity(new Float32Array(16));class Ti{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,n){return{x:0,y:0,z:0}}unproject(t,n){return new ce(0,0)}projectTilePoint(t,n,r){return{x:t,y:n,z:0}}locationPoint(t,n,r=!0){return t._coordinatePoint(t.locationCoordinate(n),r)}pixelsPerMeter(t,n){return gn(1,t)*n}pixelSpaceConversion(t,n,r){return 1}farthestPixelDistance(t){return Qb(t,t.pixelsPerMeter)}pointCoordinate(t,n,r,s){const l=t.horizonLineFromTop(!1),c=new tt(n,Math.max(l,r));return t.rayIntersectionCoordinate(t.pointRayIntersection(c,s))}pointCoordinate3D(t,n,r){const s=new tt(n,r);if(t.elevation)return t.elevation.pointCoordinate(s);{const l=this.pointCoordinate(t,s.x,s.y,0);return[l.x,l.y,l.z]}}isPointAboveHorizon(t,n){if(t.elevation)return!this.pointCoordinate3D(t,n.x,n.y);const r=t.horizonLineFromTop();return n.y<r}createInversionMatrix(t,n){return Eo}createTileMatrix(t,n,r){let s,l,c;const h=r.canonical,f=et.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const p=Ml(h,this);s=1,l=p.x+r.wrap*p.scale,c=p.y,et.scale(f,f,[s/p.scale,s/p.scale,t.pixelsPerMeter/n])}else s=n/t.zoomScale(h.z),l=(h.x+Math.pow(2,h.z)*r.wrap)*s,c=h.y*s;return et.translate(f,f,[l,c,0]),et.scale(f,f,[s/st,s/st,1]),f}upVector(t,n,r){return[0,0,1]}upVectorScale(t,n,r){return{metersToTile:1}}}class NS extends Ti{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[n,r]=this.parallels=t.parallels||[29.5,45.5],s=Math.sin(be(n));this.n=(s+Math.sin(be(r)))/2,this.c=1+s*(2*this.n-s),this.r0=Math.sqrt(this.c)/this.n}project(t,n){const{n:r,c:s,r0:l}=this,c=be(t-this.center[0]),h=be(n),f=Math.sqrt(s-2*r*Math.sin(h))/r;return{x:f*Math.sin(c*r),y:f*Math.cos(c*r)-l,z:0}}unproject(t,n){const{n:r,c:s,r0:l}=this,c=l+n;let h=Math.atan2(t,Math.abs(c))*Math.sign(c);c*r<0&&(h-=Math.PI*Math.sign(t)*Math.sign(c));const f=be(this.center[0])*r;h=Ds(h,-Math.PI-f,Math.PI-f);const p=Gt(xr(h/r)+this.center[0],-180,180),m=Math.asin(Gt((s-(t*t+c*c)*r*r)/(2*r),-1,1)),_=Gt(xr(m),-nr,nr);return new ce(p,_)}}const xc=1.340264,bc=-.081106,qu=893e-6,Cd=.003796,wc=Math.sqrt(3)/2;class ew extends Ti{project(t,n){n=n/180*Math.PI,t=t/180*Math.PI;const r=Math.asin(wc*Math.sin(n)),s=r*r,l=s*s*s;return{x:.5*(t*Math.cos(r)/(wc*(xc+3*bc*s+l*(7*qu+9*Cd*s)))/Math.PI+.5),y:1-.5*(r*(xc+bc*s+l*(qu+Cd*s))/Math.PI+1),z:0}}unproject(t,n){t=(2*t-.5)*Math.PI;let r=n=(2*(1-n)-1)*Math.PI,s=r*r,l=s*s*s;for(let m,_,y,v=0;v<12&&(_=r*(xc+bc*s+l*(qu+Cd*s))-n,y=xc+3*bc*s+l*(7*qu+9*Cd*s),m=_/y,r=Gt(r-m,-Math.PI/3,Math.PI/3),s=r*r,l=s*s*s,!(Math.abs(m)<1e-12));++v);const c=wc*t*(xc+3*bc*s+l*(7*qu+9*Cd*s))/Math.cos(r),h=Math.asin(Math.sin(r)/wc),f=Gt(180*c/Math.PI,-180,180),p=Gt(180*h/Math.PI,-nr,nr);return new ce(f,p)}}class nw extends Ti{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,n){return{x:.5+t/360,y:.5-n/360,z:0}}unproject(t,n){const r=360*(t-.5),s=Gt(360*(.5-n),-nr,nr);return new ce(r,s)}}const La=Math.PI/2;function Md(e){return Math.tan((La+e)/2)}class BS extends Ti{constructor(t){super(t),this.center=t.center||[0,30];const[n,r]=this.parallels=t.parallels||[30,30];let s=be(n),l=be(r);this.southernCenter=s+l<0,this.southernCenter&&(s=-s,l=-l);const c=Math.cos(s),h=Md(s);this.n=s===l?Math.sin(s):Math.log(c/Math.cos(l))/Math.log(Md(l)/h),this.f=c*Math.pow(Md(s),this.n)/this.n}project(t,n){n=be(n),this.southernCenter&&(n=-n),t=be(t-this.center[0]);const r=1e-6,{n:s,f:l}=this;l>0?n<-La+r&&(n=-La+r):n>La-r&&(n=La-r);const c=l/Math.pow(Md(n),s);let h=c*Math.sin(s*t),f=l-c*Math.cos(s*t);return h=.5*(h/Math.PI+.5),f=.5*(f/Math.PI+.5),{x:h,y:this.southernCenter?f:1-f,z:0}}unproject(t,n){t=(2*t-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;const{n:r,f:s}=this,l=s-n,c=Math.sign(l),h=Math.sign(r)*Math.sqrt(t*t+l*l);let f=Math.atan2(t,Math.abs(l))*c;l*r<0&&(f-=Math.PI*Math.sign(t)*c);const p=Gt(xr(f/r)+this.center[0],-180,180),m=Gt(xr(2*Math.atan(Math.pow(s/h,1/r))-La),-nr,nr);return new ce(p,this.southernCenter?-m:m)}}class Vy extends Ti{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,n){return{x:Xr(t),y:Ur(n),z:0}}unproject(t,n){const r=Vi(t),s=dr(n);return new ce(r,s)}}const Uy=be(nr);class rw extends Ti{project(t,n){const r=(n=be(n))*n,s=r*r;return{x:.5*((t=be(t))*(.8707-.131979*r+s*(s*(.003971*r-.001529*s)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+r*(.015085+s*(.028874*r-.044475-.005916*s)))/Math.PI+1),z:0}}unproject(t,n){t=(2*t-.5)*Math.PI;let r=n=(2*(1-n)-1)*Math.PI,s=25,l=0,c=r*r;do{c=r*r;const p=c*c;l=(r*(1.007226+c*(.015085+p*(.028874*c-.044475-.005916*p)))-n)/(1.007226+c*(.045255+p*(.259866*c-.311325-.005916*11*p))),r=Gt(r-l,-Uy,Uy)}while(Math.abs(l)>1e-6&&--s>0);c=r*r;const h=Gt(xr(t/(.8707+c*(c*(c*c*c*(.003971-.001529*c)-.013791)-.131979))),-180,180),f=xr(r);return new ce(h,f)}}const iw=be(nr);class jS extends Ti{project(t,n){n=be(n),t=be(t);const r=Math.cos(n),s=2/Math.PI,l=Math.acos(r*Math.cos(t/2)),c=Math.sin(l)/l,h=.5*(t*s+2*r*Math.sin(t/2)/c)||0,f=.5*(n+Math.sin(n)/c)||0;return{x:.5*(h/Math.PI+.5),y:1-.5*(f/Math.PI+1),z:0}}unproject(t,n){let r=t=(2*t-.5)*Math.PI,s=n=(2*(1-n)-1)*Math.PI,l=25;const c=1e-6;let h=0,f=0;do{const p=Math.cos(s),m=Math.sin(s),_=2*m*p,y=m*m,v=p*p,b=Math.cos(r/2),E=Math.sin(r/2),D=2*b*E,T=E*E,C=1-v*b*b,I=C?1/C:0,A=C?Math.acos(p*b)*Math.sqrt(1/C):0,M=.5*(2*A*p*E+2*r/Math.PI)-t,R=.5*(A*m+s)-n,L=.5*I*(v*T+A*p*b*y)+1/Math.PI,O=I*(D*_/4-A*m*E),z=.125*I*(_*E-A*m*v*D),N=.5*I*(y*b+A*T*p)+.5,V=O*z-N*L;h=(R*O-M*N)/V,f=(M*z-R*L)/V,r=Gt(r-h,-Math.PI,Math.PI),s=Gt(s-f,-iw,iw)}while((Math.abs(h)>c||Math.abs(f)>c)&&--l>0);return new ce(xr(r),xr(s))}}class ow extends Ti{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(be(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,n){const{scale:r,cosPhi:s}=this;return{x:be(t)*s*r+.5,y:-Math.sin(be(n))/s*r+.5,z:0}}unproject(t,n){const{scale:r,cosPhi:s}=this,l=-(n-.5)/r,c=Gt(xr((t-.5)/r)/s,-180,180),h=Math.asin(Gt(l*s,-1,1)),f=Gt(xr(h),-nr,nr);return new ce(c,f)}}class VS extends Vy{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,n,r){const s=ad(t,n,r),l=$s(wo(r));return H.transformMat4(s,s,l),{x:s[0],y:s[1],z:s[2]}}locationPoint(t,n){const r=Cr(n.lat,n.lng),s=H.normalize([],r),l=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(n),t._centerAltitude):t._centerAltitude,c=gn(1,0)*st*l;H.scaleAndAdd(r,r,s,c);const h=et.identity(new Float64Array(16));return et.multiply(h,t.pixelMatrix,t.globeMatrix),H.transformMat4(r,r,h),new tt(r[0],r[1])}pixelsPerMeter(t,n){return gn(1,0)*n}pixelSpaceConversion(t,n,r){const s=gn(1,t)*n,l=de(gn(1,45)*n,s,r);return this.pixelsPerMeter(t,n)/l}createTileMatrix(t,n,r){const s=q_(wo(r.canonical));return et.multiply(new Float64Array(16),t.globeMatrix,s)}createInversionMatrix(t,n){const{center:r}=t,s=$s(wo(n));return et.rotateY(s,s,be(r.lng)),et.rotateX(s,s,be(r.lat)),et.scale(s,s,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(s)}pointCoordinate(t,n,r,s){return Y1(t,n,r,!0)||new He(0,0)}pointCoordinate3D(t,n,r){const s=this.pointCoordinate(t,n,r,0);return[s.x,s.y,s.z]}isPointAboveHorizon(t,n){return!Y1(t,n.x,n.y,!1)}farthestPixelDistance(t){const n=function(s,l){const c=s.cameraToCenterDistance,h=s._centerAltitude*l,f=s._camera,p=s._camera.forward(),m=H.add([],H.scale([],p,-c),[0,0,h]),_=s.worldSize/(2*Math.PI),y=[0,0,-_],v=s.width/s.height,b=Math.tan(s.fovAboveCenter),E=H.scale([],f.up(),b),D=H.scale([],f.right(),b*v),T=H.normalize([],H.add([],H.add([],p,E),D)),C=[];let I;if(new id(m,T).closestPointOnSphere(y,_,C)){const A=H.add([],C,y),M=H.sub([],A,m);I=Math.cos(s.fovAboveCenter)*H.length(M)}else{const A=H.sub([],m,y),M=H.sub([],y,m);H.normalize(M,M);const R=H.length(A)-_;I=Math.sqrt(R*(R+2*_));const L=Math.acos(I/(_+R))-Math.acos(H.dot(p,M));I*=Math.cos(L)}return 1.01*I}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),r=Mr(t.zoom);if(r>0){const s=Qb(t,gn(1,t.center.lat)*t.worldSize),l=t.worldSize/(2*Math.PI),c=Math.max(t.width,t.height)/t.worldSize*Math.PI;return de(n,s+l*(1-Math.cos(c)),Math.pow(r,10))}return n}upVector(t,n,r){return ad(n,r,t,1)}upVectorScale(t){return{metersToTile:kp(H_(wo(t)))}}}function Id(e){const t=e.parallels,n=!!t&&Math.abs(t[0]+t[1])<.01;switch(e.name){case"mercator":return new Vy(e);case"equirectangular":return new nw(e);case"naturalEarth":return new rw(e);case"equalEarth":return new ew(e);case"winkelTripel":return new jS(e);case"albers":return n?new ow(e):new NS(e);case"lambertConformalConic":return n?new ow(e):new BS(e);case"globe":return new VS(e)}throw new Error(`Invalid projection name: ${e.name}`)}const $y=new qn({"symbol-placement":new wt(rt.layout_symbol["symbol-placement"]),"symbol-spacing":new wt(rt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new wt(rt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Kt(rt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new wt(rt.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new wt(rt.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new wt(rt.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new wt(rt.layout_symbol["icon-ignore-placement"]),"icon-optional":new wt(rt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new wt(rt.layout_symbol["icon-rotation-alignment"]),"icon-size":new Kt(rt.layout_symbol["icon-size"]),"icon-text-fit":new Kt(rt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Kt(rt.layout_symbol["icon-text-fit-padding"]),"icon-image":new Kt(rt.layout_symbol["icon-image"]),"icon-rotate":new Kt(rt.layout_symbol["icon-rotate"]),"icon-padding":new wt(rt.layout_symbol["icon-padding"]),"icon-keep-upright":new wt(rt.layout_symbol["icon-keep-upright"]),"icon-offset":new Kt(rt.layout_symbol["icon-offset"]),"icon-anchor":new Kt(rt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new wt(rt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new wt(rt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new wt(rt.layout_symbol["text-rotation-alignment"]),"text-field":new Kt(rt.layout_symbol["text-field"]),"text-font":new Kt(rt.layout_symbol["text-font"]),"text-size":new Kt(rt.layout_symbol["text-size"]),"text-max-width":new Kt(rt.layout_symbol["text-max-width"]),"text-line-height":new Kt(rt.layout_symbol["text-line-height"]),"text-letter-spacing":new Kt(rt.layout_symbol["text-letter-spacing"]),"text-justify":new Kt(rt.layout_symbol["text-justify"]),"text-radial-offset":new Kt(rt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new wt(rt.layout_symbol["text-variable-anchor"]),"text-anchor":new Kt(rt.layout_symbol["text-anchor"]),"text-max-angle":new wt(rt.layout_symbol["text-max-angle"]),"text-writing-mode":new wt(rt.layout_symbol["text-writing-mode"]),"text-rotate":new Kt(rt.layout_symbol["text-rotate"]),"text-padding":new wt(rt.layout_symbol["text-padding"]),"text-keep-upright":new wt(rt.layout_symbol["text-keep-upright"]),"text-transform":new Kt(rt.layout_symbol["text-transform"]),"text-offset":new Kt(rt.layout_symbol["text-offset"]),"text-allow-overlap":new wt(rt.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new wt(rt.layout_symbol["text-ignore-placement"]),"text-optional":new wt(rt.layout_symbol["text-optional"]),visibility:new wt(rt.layout_symbol.visibility)});var dm={paint:new qn({"icon-opacity":new Kt(rt.paint_symbol["icon-opacity"]),"icon-emissive-strength":new Kt(rt.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Kt(rt.paint_symbol["text-emissive-strength"]),"icon-color":new Kt(rt.paint_symbol["icon-color"]),"icon-halo-color":new Kt(rt.paint_symbol["icon-halo-color"]),"icon-halo-width":new Kt(rt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Kt(rt.paint_symbol["icon-halo-blur"]),"icon-translate":new wt(rt.paint_symbol["icon-translate"]),"icon-translate-anchor":new wt(rt.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Kt(rt.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Kt(rt.paint_symbol["text-opacity"]),"text-color":new Kt(rt.paint_symbol["text-color"],{runtimeType:Xo,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new Kt(rt.paint_symbol["text-halo-color"]),"text-halo-width":new Kt(rt.paint_symbol["text-halo-width"]),"text-halo-blur":new Kt(rt.paint_symbol["text-halo-blur"]),"text-translate":new wt(rt.paint_symbol["text-translate"]),"text-translate-anchor":new wt(rt.paint_symbol["text-translate-anchor"])}),layout:$y};class Hy{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:Jc,this.defaultValue=t}evaluate(t){if(t.formattedSection){const n=this.defaultValue.property.overrides;if(n&&n.hasOverride(t.formattedSection))return n.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}jt(Hy,"FormatSectionOverride",{omit:["defaultValue"]});class Ad extends Lo{constructor(t,n){super(t,dm,n)}recalculate(t,n){super.recalculate(t,n),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const r=this.layout.get("text-writing-mode");if(r){const s=[];for(const l of r)s.indexOf(l)<0&&s.push(l);this.layout._values["text-writing-mode"]=s}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,n,r,s){const l=this.layout.get(t).evaluate(n,{},r,s),c=this._unevaluatedLayout._values[t];return c.isDataDriven()||hu(c.value)||!l?l:(h=n.properties,l.replace(/{([^{}]+)}/g,(p,m)=>m in h?String(h[m]):""));var h}createBucket(t){return new Zu(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of dm.paint.overridableProperties){if(!Ad.hasPaintOverride(this.layout,t))continue;const n=this.paint.get(t),r=new Hy(n),s=new Gf(r,n.property.specification);let l=null;l="constant"===n.value.kind||"source"===n.value.kind?new Vg("source",s):new Dr("composite",s,n.value.zoomStops,n.value._interpolationType),this.paint._values[t]=new ic(n.property,l,n.parameters)}}_handleOverridablePaintPropertyUpdate(t,n,r){return!(!this.layout||n.isDataDriven()||r.isDataDriven())&&Ad.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,n){const r=t.get("text-field"),s=dm.paint.properties[n];let l=!1;const c=h=>{for(const f of h)if(s.overrides&&s.overrides.hasOverride(f))return void(l=!0)};if("constant"===r.value.kind&&r.value.value instanceof kr)c(r.value.value.sections);else if("source"===r.value.kind){const h=p=>{l||(p instanceof Af&&Vn(p.value)===Cf?c(p.value.sections):p instanceof ql?c(p.sections):p.eachChild(h))},f=r.value;f._styleExpression&&h(f._styleExpression.expression)}return l}getProgramIds(){const t=0!==this.paint.get("icon-opacity").constantOr(1),n=0!==this.paint.get("text-opacity").constantOr(1),r=[];return t&&r.push("symbolIcon"),n&&r.push("symbolSDF"),r}getDefaultProgramParams(t,n){return{config:new dc(this,n),overrideFog:!1}}}const sw=yd.types,aw=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Pd(e,t,n,r,s,l,c,h,f,p,m,_,y){const v=h?Math.min(Ra,Math.round(h[0])):0,b=h?Math.min(Ra,Math.round(h[1])):0;e.emplaceBack(t,n,Math.round(32*r),Math.round(32*s),l,c,(v<<1)+(f?1:0),b,16*p,16*m,256*_,256*y)}function Rd(e,t,n){e.emplaceBack(t,n)}function Ld(e,t,n,r,s,l,c){e.emplaceBack(t,n,r,s,l,c)}function Gy(e,t,n,r,s){const l=5*t+2;e.float32[l+0]=n,e.float32[l+1]=r,e.float32[l+2]=s}function Wu(e,t,n,r,s){e.emplaceBack(t,n,r,s),e.emplaceBack(t,n,r,s),e.emplaceBack(t,n,r,s),e.emplaceBack(t,n,r,s)}function US(e){for(const t of e.sections)if(dA(t.text))return!0;return!1}class fm{constructor(t){this.layoutVertexArray=new Qg,this.indexArray=new er,this.programConfigurations=t,this.segments=new ln,this.dynamicLayoutVertexArray=new Os,this.opacityVertexArray=new ac,this.placedSymbolArray=new cc,this.iconTransitioningVertexArray=new bo,this.globeExtVertexArray=new sp,this.zOffsetVertexArray=new Kh}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(t,n,r,s,l){this.isEmpty()||(r&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Ub.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,DS.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,aw,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=t.createVertexBuffer(this.iconTransitioningVertexArray,Ry.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,TS.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||l)&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,SS.members,!0)),this.opacityVertexBuffer.itemSize=1),(r||s)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}jt(fm,"SymbolBuffers");class qy{constructor(t,n,r){this.layoutVertexArray=new t,this.layoutAttributes=n,this.indexArray=new r,this.segments=new ln,this.collisionVertexArray=new yr,this.collisionVertexArrayExt=new Fs}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,CS.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,MS.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}jt(qy,"CollisionBuffers");class Ir{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(c=>c.fqid),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=et.identity([]),this.placementViewportMatrix=et.identity([]);const n=this.layers[0]._unevaluatedLayout._values;this.textSizeData=wd(this.zoom,n["text-size"]),this.iconSizeData=wd(this.zoom,n["icon-size"]);const r=this.layers[0].layout,s=r.get("symbol-sort-key"),l=r.get("symbol-z-order");this.canOverlap=r.get("text-allow-overlap")||r.get("icon-allow-overlap")||r.get("text-ignore-placement")||r.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==l&&void 0!==s.constantOr(1),this.sortFeaturesByY=("viewport-y"===l||"auto"===l&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=r.get("text-writing-mode").map(c=>Bn[c]),this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id),this.sourceID=t.sourceID,this.projection=t.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=r.get("symbol-z-elevate")}createArrays(){this.text=new fm(new pl(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new fm(new pl(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new BD,this.lineVertexArray=new o_,this.symbolInstances=new o1}calculateGlyphDependencies(t,n,r,s,l){for(let c=0;c<t.length;c++){const h=t.codePointAt(c);if(void 0===h)break;if(n[h]=!0,s&&l&&h<=65535){const f=zu[t.charAt(c)];f&&(n[f.charCodeAt(0)]=!0)}}}populate(t,n,r,s){const l=this.layers[0],c=l.layout,h="globe"===this.projection.name,f=c.get("text-font"),p=c.get("text-field"),m=c.get("icon-image"),_=("constant"!==p.value.kind||p.value.value instanceof kr&&!p.value.value.isEmpty()||p.value.value.toString().length>0)&&("constant"!==f.value.kind||f.value.value.length>0),y="constant"!==m.value.kind||!!m.value.value||Object.keys(m.parameters).length>0,v=c.get("symbol-sort-key");if(this.features=[],!_&&!y)return;const b=n.iconDependencies,E=n.glyphDependencies,D=n.availableImages,T=new Gn(this.zoom);for(const{feature:C,id:I,index:A,sourceLayerIndex:M}of t){const R=l._featureFilter.needGeometry,L=xl(C,R);if(!l._featureFilter.filter(T,L,r))continue;if(R||(L.geometry=ze(C,r,s)),h&&1!==C.type&&r.z<=5){const V=L.geometry,B=.98078528056,$=(j,Z)=>{const K=ad(j.x,j.y,r,1),Q=ad(Z.x,Z.y,r,1);return H.dot(K,Q)<B};for(let j=0;j<V.length;j++)V[j]=ib(V[j],$)}let O,z;if(_){const V=l.getValueAndResolveTokens("text-field",L,r,D),B=kr.factory(V);US(B)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Or()||this.hasRTLText&&wi.isParsed())&&(O=Hb(B,l,L))}if(y){const V=l.getValueAndResolveTokens("icon-image",L,r,D);z=V instanceof Tr?V:Tr.fromString(V)}if(!O&&!z)continue;const N=this.sortFeaturesByKey?v.evaluate(L,{},r):void 0;if(this.features.push({id:I,text:O,icon:z,index:A,sourceLayerIndex:M,geometry:L.geometry,properties:C.properties,type:sw[C.type],sortKey:N}),z&&(b[z.namePrimary]=!0,z.nameSecondary&&(b[z.nameSecondary]=!0)),O){const V=f.evaluate(L,{},r).join(","),B="map"===c.get("text-rotation-alignment")&&"point"!==c.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Bn.vertical)>=0;for(const $ of O.sections)if($.image)b[$.image.namePrimary]=!0;else{const j=ul(O.toString()),Z=$.fontStack||V,K=E[Z]=E[Z]||{};this.calculateGlyphDependencies($.text,K,B,this.allowVerticalPlacement,j)}}}"line"===c.get("symbol-placement")&&(this.features=function(C){const I={},A={},M=[];let R=0;function L(V){M.push(C[V]),R++}function O(V,B,$){const j=A[V];return delete A[V],A[B]=j,M[j].geometry[0].pop(),M[j].geometry[0]=M[j].geometry[0].concat($[0]),j}function z(V,B,$){const j=I[B];return delete I[B],I[V]=j,M[j].geometry[0].shift(),M[j].geometry[0]=$[0].concat(M[j].geometry[0]),j}function N(V,B,$){const j=$?B[0][B[0].length-1]:B[0][0];return`${V}:${j.x}:${j.y}`}for(let V=0;V<C.length;V++){const B=C[V],$=B.geometry,j=B.text?B.text.toString():null;if(!j){L(V);continue}const Z=N(j,$),K=N(j,$,!0);if(Z in A&&K in I&&A[Z]!==I[K]){const Q=z(Z,K,$),W=O(Z,K,M[Q].geometry);delete I[Z],delete A[K],A[N(j,M[W].geometry,!0)]=W,M[Q].geometry=null}else Z in A?O(Z,K,$):K in I?z(Z,K,$):(L(V),I[Z]=R-1,A[K]=R-1)}return M.filter(V=>V.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((C,I)=>C.sortKey-I.sortKey)}update(t,n,r,s,l){const c=0!==Object.keys(t).length;if(c&&!this.stateDependentLayers.length)return;const h=c?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(t,n,h,r,s,l),this.icon.programConfigurations.updatePaintArrays(t,n,h,r,s,l)}updateZOffset(){const t=(l,c,h)=>{r+=c,r>l.length&&l.resize(r);for(let f=-c;f<0;f++)l.emplace(f+r,h)},n=(l,c,h)=>{s+=c,s>l.length&&l.resize(s);for(let f=-c;f<0;f++)l.emplace(f+s,h)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let r=0,s=0;for(let l=0;l<this.symbolInstances.length;l++){const c=this.symbolInstances.get(l),{numHorizontalGlyphVertices:h,numVerticalGlyphVertices:f,numIconVertices:p}=c,m=c.zOffset,_=p>0;if((h>0||f>0)&&(t(this.text.zOffsetVertexArray,h,m),t(this.text.zOffsetVertexArray,f,m)),_){const{placedIconSymbolIndex:y,verticalPlacedIconSymbolIndex:v}=c;y>=0&&n(this.icon.zOffsetVertexArray,p,m),v>=0&&n(this.icon.zOffsetVertexArray,c.numVerticalIconVertices,m)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Id(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,n){const r=this.lineVertexArray.length;if(void 0!==t.segment)for(const{x:s,y:l}of n)this.lineVertexArray.emplaceBack(s,l);return{lineStartIndex:r,lineLength:this.lineVertexArray.length-r}}addSymbols(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D){const T=t.indexArray,C=t.layoutVertexArray,I=t.globeExtVertexArray,A=t.segments.prepareSegment(4*n.length,C,T,this.canOverlap?c.sortKey:void 0),M=this.glyphOffsetArray.length,R=A.vertexLength,L=this.allowVerticalPlacement&&h===Bn.vertical?Math.PI/2:0,O=c.text&&c.text.sections;for(let N=0;N<n.length;N++){const{tl:V,tr:B,bl:$,br:j,texPrimary:Z,texSecondary:K,pixelOffsetTL:Q,pixelOffsetBR:W,minFontScaleX:X,minFontScaleY:nt,glyphOffset:ot,isSDF:lt,sectionIndex:ht}=n[N],ft=A.vertexLength,at=ot[1];if(Pd(C,p.x,p.y,V.x,at+V.y,Z.x,Z.y,r,lt,Q.x,Q.y,X,nt),Pd(C,p.x,p.y,B.x,at+B.y,Z.x+Z.w,Z.y,r,lt,W.x,Q.y,X,nt),Pd(C,p.x,p.y,$.x,at+$.y,Z.x,Z.y+Z.h,r,lt,Q.x,W.y,X,nt),Pd(C,p.x,p.y,j.x,at+j.y,Z.x+Z.w,Z.y+Z.h,r,lt,W.x,W.y,X,nt),f){const{x:ut,y:Et,z:Ot}=f.anchor,[kt,zt,Zt]=f.up;Ld(I,ut,Et,Ot,kt,zt,Zt),Ld(I,ut,Et,Ot,kt,zt,Zt),Ld(I,ut,Et,Ot,kt,zt,Zt),Ld(I,ut,Et,Ot,kt,zt,Zt),Wu(t.dynamicLayoutVertexArray,ut,Et,Ot,L)}else Wu(t.dynamicLayoutVertexArray,p.x,p.y,p.z,L);if(D){const ut=K||Z;Rd(t.iconTransitioningVertexArray,ut.x,ut.y),Rd(t.iconTransitioningVertexArray,ut.x+ut.w,ut.y),Rd(t.iconTransitioningVertexArray,ut.x,ut.y+ut.h),Rd(t.iconTransitioningVertexArray,ut.x+ut.w,ut.y+ut.h)}T.emplaceBack(ft,ft+1,ft+2),T.emplaceBack(ft+1,ft+2,ft+3),A.vertexLength+=4,A.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ot[0]),N!==n.length-1&&ht===n[N+1].sectionIndex||t.programConfigurations.populatePaintArrays(C.length,c,c.index,{},v,b,E,O&&O[ht])}const z=f?f.anchor:p;t.placedSymbolArray.emplaceBack(z.x,z.y,z.z,p.x,p.y,M,this.glyphOffsetArray.length-M,R,m,_,p.segment,r?r[0]:0,r?r[1]:0,s[0],s[1],h,0,!1,0,y,0)}_commitLayoutVertex(t,n,r,s,l,c,h){t.emplaceBack(n,r,s,l,c,Math.round(h.x),Math.round(h.y))}_addCollisionDebugVertices(t,n,r,s,l,c,h){const f=r.segments.prepareSegment(4,r.layoutVertexArray,r.indexArray),p=f.vertexLength,m=h.tileAnchorX,_=h.tileAnchorY;for(let v=0;v<4;v++)r.collisionVertexArray.emplaceBack(0,0,0,0);r.collisionVertexArrayExt.emplaceBack(n,-t.padding,-t.padding),r.collisionVertexArrayExt.emplaceBack(n,t.padding,-t.padding),r.collisionVertexArrayExt.emplaceBack(n,t.padding,t.padding),r.collisionVertexArrayExt.emplaceBack(n,-t.padding,t.padding),this._commitLayoutVertex(r.layoutVertexArray,s,l,c,m,_,new tt(t.x1,t.y1)),this._commitLayoutVertex(r.layoutVertexArray,s,l,c,m,_,new tt(t.x2,t.y1)),this._commitLayoutVertex(r.layoutVertexArray,s,l,c,m,_,new tt(t.x2,t.y2)),this._commitLayoutVertex(r.layoutVertexArray,s,l,c,m,_,new tt(t.x1,t.y2)),f.vertexLength+=4;const y=r.indexArray;y.emplaceBack(p,p+1),y.emplaceBack(p+1,p+2),y.emplaceBack(p+2,p+3),y.emplaceBack(p+3,p),f.primitiveLength+=4}_addTextDebugCollisionBoxes(t,n,r,s,l,c){for(let h=s;h<l;h++){const f=r.get(h),p=this.getSymbolInstanceTextSize(t,c,n,h);this._addCollisionDebugVertices(f,p,this.textCollisionBox,f.projectedAnchorX,f.projectedAnchorY,f.projectedAnchorZ,c)}}_addIconDebugCollisionBoxes(t,n,r,s,l,c){for(let h=s;h<l;h++){const f=r.get(h),p=this.getSymbolInstanceIconSize(t,n,c.placedIconSymbolIndex);this._addCollisionDebugVertices(f,p,this.iconCollisionBox,f.projectedAnchorX,f.projectedAnchorY,f.projectedAnchorZ,c)}}generateCollisionDebugBuffers(t,n){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new qy(fe,bd.members,bo),this.iconCollisionBox=new qy(fe,bd.members,bo);const r=ls(this.iconSizeData,t),s=ls(this.textSizeData,t);for(let l=0;l<this.symbolInstances.length;l++){const c=this.symbolInstances.get(l);this._addTextDebugCollisionBoxes(s,t,n,c.textBoxStartIndex,c.textBoxEndIndex,c),this._addTextDebugCollisionBoxes(s,t,n,c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c),this._addIconDebugCollisionBoxes(r,t,n,c.iconBoxStartIndex,c.iconBoxEndIndex,c),this._addIconDebugCollisionBoxes(r,t,n,c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex,c)}}getSymbolInstanceTextSize(t,n,r,s){const l=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:s),c=Jp(this.textSizeData,t,l)/24;return this.tilePixelRatio*c}getSymbolInstanceIconSize(t,n,r){const s=this.icon.placedSymbolArray.get(r),l=Jp(this.iconSizeData,t,s);return this.tilePixelRatio*l}_commitDebugCollisionVertexUpdate(t,n,r){t.emplaceBack(n,-r,-r),t.emplaceBack(n,r,-r),t.emplaceBack(n,r,r),t.emplaceBack(n,-r,r)}_updateTextDebugCollisionBoxes(t,n,r,s,l,c){for(let h=s;h<l;h++){const f=r.get(h),p=this.getSymbolInstanceTextSize(t,c,n,h);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,p,f.padding)}}_updateIconDebugCollisionBoxes(t,n,r,s,l,c){for(let h=s;h<l;h++){const f=r.get(h),p=this.getSymbolInstanceIconSize(t,n,c);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,p,f.padding)}}updateCollisionDebugBuffers(t,n){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const r=ls(this.iconSizeData,t),s=ls(this.textSizeData,t);for(let l=0;l<this.symbolInstances.length;l++){const c=this.symbolInstances.get(l);this._updateTextDebugCollisionBoxes(s,t,n,c.textBoxStartIndex,c.textBoxEndIndex,c),this._updateTextDebugCollisionBoxes(s,t,n,c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c),this._updateIconDebugCollisionBoxes(r,t,n,c.iconBoxStartIndex,c.iconBoxEndIndex,c.placedIconSymbolIndex),this._updateIconDebugCollisionBoxes(r,t,n,c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex,c.placedIconSymbolIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,n,r,s,l,c,h,f,p){const m={};if(n<r){const{x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A,featureIndex:M}=t.get(n);m.textBox={x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A},m.textFeatureIndex=M}if(s<l){const{x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A,featureIndex:M}=t.get(s);m.verticalTextBox={x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A},m.verticalTextFeatureIndex=M}if(c<h){const{x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A,featureIndex:M}=t.get(c);m.iconBox={x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A},m.iconFeatureIndex=M}if(f<p){const{x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A,featureIndex:M}=t.get(f);m.verticalIconBox={x1:_,y1:y,x2:v,y2:b,padding:E,projectedAnchorX:D,projectedAnchorY:T,projectedAnchorZ:C,tileAnchorX:I,tileAnchorY:A},m.verticalIconFeatureIndex=M}return m}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){const r=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,r.textBoxStartIndex,r.textBoxEndIndex,r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r.iconBoxStartIndex,r.iconBoxEndIndex,r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(t,n){const r=t.placedSymbolArray.get(n),s=r.vertexStartIndex+4*r.numGlyphs;for(let l=r.vertexStartIndex;l<s;l+=4)t.indexArray.emplaceBack(l,l+1,l+2),t.indexArray.emplaceBack(l+1,l+2,l+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const n=Math.sin(t),r=Math.cos(t),s=[],l=[],c=[];for(let h=0;h<this.symbolInstances.length;++h){c.push(h);const f=this.symbolInstances.get(h);s.push(0|Math.round(n*f.tileAnchorX+r*f.tileAnchorY)),l.push(f.featureIndex)}return c.sort((h,f)=>s[h]-s[f]||l[f]-l[h]),c}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let t=0;t<this.symbolInstances.length;++t)this.symbolInstanceIndexesSortedZOffset.push(t)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((t,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(t).zOffset)}addToSortKeyRanges(t,n){const r=this.sortKeyRanges[this.sortKeyRanges.length-1];r&&r.sortKey===n?r.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const n of this.symbolInstanceIndexes){const r=this.symbolInstances.get(n);this.featureSortOrder.push(r.featureIndex);const{rightJustifiedTextSymbolIndex:s,centerJustifiedTextSymbolIndex:l,leftJustifiedTextSymbolIndex:c,verticalPlacedTextSymbolIndex:h,placedIconSymbolIndex:f,verticalPlacedIconSymbolIndex:p}=r;s>=0&&this.addIndicesForPlacedSymbol(this.text,s),l>=0&&l!==s&&this.addIndicesForPlacedSymbol(this.text,l),c>=0&&c!==l&&c!==s&&this.addIndicesForPlacedSymbol(this.text,c),h>=0&&this.addIndicesForPlacedSymbol(this.text,h),f>=0&&this.addIndicesForPlacedSymbol(this.icon,f),p>=0&&this.addIndicesForPlacedSymbol(this.icon,p)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}jt(Ir,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Ir.MAX_GLYPHS=65535,Ir.addDynamicAttributes=Wu;var Zu=Ir;const $S=sn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:HS}=$S,lw=sn([{name:"a_packed",components:4,type:"Float32"}]),{members:GS}=lw,cw=yd.types,uw=Math.cos(Math.PI/180*37.5);class ka{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new sc,this.layoutVertexArray2=new Os,this.indexArray=new er,this.programConfigurations=new pl(t.layers,t.zoom),this.segments=new ln,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,r,s){this.hasPattern=vy("line",this.layers,n);const l=this.layers[0].layout.get("line-sort-key"),c=[];for(const{feature:m,id:_,index:y,sourceLayerIndex:v}of t){const b=this.layers[0]._featureFilter.needGeometry,E=xl(m,b);if(!this.layers[0]._featureFilter.filter(new Gn(this.zoom),E,r))continue;const D=l?l.evaluate(E,{},r):void 0,T={id:_,properties:m.properties,type:m.type,sourceLayerIndex:v,index:y,geometry:b?E.geometry:ze(m,r,s),patterns:{},sortKey:D};c.push(T)}l&&c.sort((m,_)=>m.sortKey-_.sortKey);const{lineAtlas:h,featureIndex:f}=n,p=this.addConstantDashes(h);for(const m of c){const{geometry:_,index:y,sourceLayerIndex:v}=m;if(p&&this.addFeatureDashes(m,h),this.hasPattern){const b=_d("line",this.layers,m,this.zoom,n);this.patternFeatures.push(b)}else this.addFeature(m,_,y,r,h.positions,n.availableImages,n.brightness);f.insert(t[y].feature,_,y,v,this.index)}}addConstantDashes(t){let n=!1;for(const r of this.layers){const s=r.paint.get("line-dasharray").value,l=r.layout.get("line-cap").value;if("constant"!==s.kind||"constant"!==l.kind)n=!0;else{const c=l.value,h=s.value;if(!h)continue;t.addDash(h,c)}}return n}addFeatureDashes(t,n){const r=this.zoom;for(const s of this.layers){const l=s.paint.get("line-dasharray").value,c=s.layout.get("line-cap").value;if("constant"===l.kind&&"constant"===c.kind)continue;let h,f;if("constant"===l.kind){if(h=l.value,!h)continue}else h=l.evaluate({zoom:r},t);f="constant"===c.kind?c.value:c.evaluate({zoom:r},t),n.addDash(h,f),t.patterns[s.id]=n.getKey(h,f)}}update(t,n,r,s,l){const c=0!==Object.keys(t).length;c&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,n,c?this.stateDependentLayers:this.layers,r,s,l)}addFeatures(t,n,r,s,l,c){for(const h of this.patternFeatures)this.addFeature(h,h.geometry,h.index,n,r,s,c)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,GS)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,HS),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,n,r,s,l,c,h){const f=this.layers[0].layout,p=f.get("line-join").evaluate(t,{}),m=f.get("line-cap").evaluate(t,{}),_=f.get("line-miter-limit"),y=f.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const v of n)this.addLine(v,t,p,m,_,y);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,l,c,s,h)}addLine(t,n,r,s,l,c){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let T=0;T<t.length-1;T++)this.totalDistance+=t[T].dist(t[T+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const h="Polygon"===cw[n.type];let f=t.length;for(;f>=2&&t[f-1].equals(t[f-2]);)f--;let p=0;for(;p<f-1&&t[p].equals(t[p+1]);)p++;if(f<(h?3:2))return;"bevel"===r&&(l=1.05);const m=this.overscaling<=16?15*st/(512*this.overscaling):0,_=this.segments.prepareSegment(10*f,this.layoutVertexArray,this.indexArray);let y,v,b,E,D;this.e1=this.e2=-1,h&&(y=t[f-2],D=t[p].sub(y)._unit()._perp());for(let T=p;T<f;T++){if(b=T===f-1?h?t[p+1]:void 0:t[T+1],b&&t[T].equals(b))continue;D&&(E=D),y&&(v=y),y=t[T],D=b?b.sub(y)._unit()._perp():E,E=E||D;let C=E.add(D);0===C.x&&0===C.y||C._unit();const I=E.x*D.x+E.y*D.y,A=C.x*D.x+C.y*D.y,M=0!==A?1/A:1/0,R=2*Math.sqrt(2-2*A),L=A<uw&&v&&b,O=E.x*D.y-E.y*D.x>0;if(L&&T>p){const V=y.dist(v);if(V>2*m){const B=y.sub(y.sub(v)._mult(m/V)._round());this.updateDistance(v,B),this.addCurrentVertex(B,E,0,0,_),v=B}}const z=v&&b;let N=z?r:h?"butt":s;if(z&&"round"===N&&(M<c?N="miter":M<=2&&(N="fakeround")),"miter"===N&&M>l&&(N="bevel"),"bevel"===N&&(M>2&&(N="flipbevel"),M<l&&(N="miter")),v&&this.updateDistance(v,y),"miter"===N)C._mult(M),this.addCurrentVertex(y,C,0,0,_);else if("flipbevel"===N){if(M>100)C=D.mult(-1);else{const V=M*E.add(D).mag()/E.sub(D).mag();C._perp()._mult(V*(O?-1:1))}this.addCurrentVertex(y,C,0,0,_),this.addCurrentVertex(y,C.mult(-1),0,0,_)}else if("bevel"===N||"fakeround"===N){const V=-Math.sqrt(M*M-1),B=O?V:0,$=O?0:V;if(v&&this.addCurrentVertex(y,E,B,$,_),"fakeround"===N){const j=Math.round(180*R/Math.PI/20);for(let Z=1;Z<j;Z++){let K=Z/j;if(.5!==K){const W=K-.5;K+=K*W*(K-1)*((1.0904+I*(I*(3.55645-1.43519*I)-3.2452))*W*W+(.848013+I*(.215638*I-1.06021)))}const Q=D.sub(E)._mult(K)._add(E)._unit()._mult(O?-1:1);this.addHalfVertex(y,Q.x,Q.y,!1,O,0,_)}}b&&this.addCurrentVertex(y,D,-B,-$,_)}else if("butt"===N)this.addCurrentVertex(y,C,0,0,_);else if("square"===N){const V=v?1:-1;v||this.addCurrentVertex(y,C,V,V,_),this.addCurrentVertex(y,C,0,0,_),v&&this.addCurrentVertex(y,C,V,V,_)}else"round"===N&&(v&&(this.addCurrentVertex(y,E,0,0,_),this.addCurrentVertex(y,E,1,1,_,!0)),b&&(this.addCurrentVertex(y,D,-1,-1,_,!0),this.addCurrentVertex(y,D,0,0,_)));if(L&&T<f-1){const V=y.dist(b);if(V>2*m){const B=y.add(b.sub(y)._mult(m/V)._round());this.updateDistance(y,B),this.addCurrentVertex(B,D,0,0,_),y=B}}}}addCurrentVertex(t,n,r,s,l,c=!1){const h=n.y*s-n.x,f=-n.y-n.x*s;this.addHalfVertex(t,n.x+n.y*r,n.y-n.x*r,c,!1,r,l),this.addHalfVertex(t,h,f,c,!0,-s,l)}addHalfVertex({x:t,y:n},r,s,l,c,h,f){this.layoutVertexArray.emplaceBack((t<<1)+(l?1:0),(n<<1)+(c?1:0),Math.round(63*r)+128,Math.round(63*s)+128,1+(0===h?0:h<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const p=f.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,p),f.primitiveLength++),c?this.e2=p:this.e1=p}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,n){this.distance+=t.dist(n),this.updateScaledDistance()}}jt(ka,"LineBucket",{omit:["layers","patternFeatures"]});class pr{constructor(t,n,r,s){this.context=t,this.format=r,this.texture=t.gl.createTexture(),this.update(n,s)}update(t,n,r){const{width:s,height:l}=t,{context:c}=this,{gl:h}=c,{HTMLImageElement:f,HTMLCanvasElement:p,HTMLVideoElement:m,ImageData:_,ImageBitmap:y}=it;if(h.bindTexture(h.TEXTURE_2D,this.texture),c.pixelStoreUnpackFlipY.set(!1),c.pixelStoreUnpack.set(1),c.pixelStoreUnpackPremultiplyAlpha.set(this.format===h.RGBA&&(!n||!1!==n.premultiply)),r||this.size&&this.size[0]===s&&this.size[1]===l){const{x:v,y:b}=r||{x:0,y:0};if(t instanceof f||t instanceof p||t instanceof m||t instanceof _||y&&t instanceof y)h.texSubImage2D(h.TEXTURE_2D,0,v,b,h.RGBA,h.UNSIGNED_BYTE,t);else{let E=this.format,D=h.UNSIGNED_BYTE;this.format===h.R32F&&(E=h.RED,D=h.FLOAT),h.texSubImage2D(h.TEXTURE_2D,0,v,b,s,l,E,D,t.data)}}else if(this.size=[s,l],t instanceof f||t instanceof p||t instanceof m||t instanceof _||y&&t instanceof y){let v=this.format;this.format===h.R8&&(v=h.RED),h.texImage2D(h.TEXTURE_2D,0,this.format,v,h.UNSIGNED_BYTE,t)}else{let v=this.format,b=this.format,E=h.UNSIGNED_BYTE;this.format===h.DEPTH_COMPONENT&&(v=h.DEPTH_COMPONENT16,E=h.UNSIGNED_SHORT),this.format===h.R32F&&(E=h.FLOAT,b=h.RED),h.texImage2D(h.TEXTURE_2D,0,v,s,l,0,b,E,t.data)}this.useMipmap=Boolean(n&&n.useMipmap),this.useMipmap&&h.generateMipmap(h.TEXTURE_2D)}bind(t,n){const{context:r}=this,{gl:s}=r;s.bindTexture(s.TEXTURE_2D,this.texture),t!==this.minFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,this.useMipmap?t===s.NEAREST?s.NEAREST_MIPMAP_NEAREST:s.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),n!==this.wrapS&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(t,n,r,s){const{context:l}=this,{gl:c}=l;c.bindTexture(c.TEXTURE_2D,this.texture),n!==this.magFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,n),this.magFilter=n),t!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,this.useMipmap?t===c.NEAREST?c.NEAREST_MIPMAP_NEAREST:c.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),r!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,r),this.wrapS=r),s!==this.wrapT&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,s),this.wrapT=s)}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class pm{constructor(t,n){this.context=t,this.texture=n}bind(t,n){const{context:r}=this,{gl:s}=r;s.bindTexture(s.TEXTURE_2D,this.texture),t!==this.minFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,t),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,t),this.minFilter=t),n!==this.wrapS&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,n),this.wrapS=n)}}const Oa=new Uint16Array(8184);for(let e=0;e<2046;e++){let t=e+2,n=0,r=0,s=0,l=0,c=0,h=0;for(1&t?s=l=c=32:n=r=h=32;(t>>=1)>1;){const p=n+s>>1,m=r+l>>1;1&t?(s=n,l=r,n=c,r=h):(n=s,r=l,s=c,l=h),c=p,h=m}const f=4*e;Oa[f+0]=n,Oa[f+1]=r,Oa[f+2]=s,Oa[f+3]=l}const Fa=new Uint16Array(2178),za=new Uint8Array(1089),kd=new Uint16Array(1089);function hs(e){return 0===e?-.03125:32===e?.03125:0}var Wy=sn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const hw={type:2,extent:st,loadGeometry:()=>[[new tt(0,0),new tt(8193,0),new tt(8193,8193),new tt(0,8193),new tt(0,0)]]};class co{constructor(t,n,r,s,l){this.tileID=t,this.uid=mr(),this.uses=0,this.tileSize=n,this.tileZoom=r,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=l,s&&s.style&&(this._lastUpdatedBrightness=s.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",s&&s.transform&&(this.projection=s.transform.projection)}registerFadeDuration(t){const n=t+this.timeAdded;n<me.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=Ml(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,r){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(s,l){const c={};if(!l)return c;for(const h of s){const f=h.layerIds.map(p=>l.getLayer(p)).filter(Boolean);if(0!==f.length){h.layers=f,h.stateDependentLayerIds&&(h.stateDependentLayers=h.stateDependentLayerIds.map(p=>f.filter(m=>m.id===p)[0]));for(const p of f)c[p.fqid]=h}}return c}(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const s in this.buckets){const l=this.buckets[s];if(l instanceof Zu){if(this.hasSymbolBuckets=!0,!r)break;l.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const s in this.buckets){const l=this.buckets[s];if(l instanceof Zu&&l.hasRTLText){this.hasRTLText=!0,wi.isLoading()||wi.isLoaded()||"deferred"!==Or()||tp();break}}this.queryPadding=0;for(const s in this.buckets){const l=this.buckets[s],c=n.style.getOwnLayer(s);if(!c)continue;const h=c.queryRadius(l);this.queryPadding=Math.max(this.queryPadding,h)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new i_}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const r in this.buckets){const s=this.buckets[r];s.uploadPending()&&s.upload(t)}const n=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new pr(t,this.imageAtlas.image,n.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new pr(t,this.glyphAtlasImage,n.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new pr(t,this.lineAtlas.image,n.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t,n,r){if(this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,r),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const s=n.style.getBrightness();(this._lastUpdatedBrightness||s)&&(this._lastUpdatedBrightness&&s&&Math.abs(this._lastUpdatedBrightness-s)<.001||(this._lastUpdatedBrightness=s,this.updateBuckets(void 0,n)))}queryRenderedFeatures(t,n,r,s,l,c,h,f){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:s,pixelPosMatrix:h,transform:c,params:l,tileTransform:this.tileTransform},t,n,r):{}}querySourceFeatures(t,n){const r=this.latestFeatureIndex;if(!r||!r.rawTileData)return;const s=r.loadVTLayers(),l=n?n.sourceLayer:"",c=s._geojsonTileLayer||s[l];if(!c)return;const h=fu(n&&n.filter),{z:f,x:p,y:m}=this.tileID.canonical,_={z:f,x:p,y:m};for(let y=0;y<c.length;y++){const v=c.feature(y);if(h.needGeometry){const D=xl(v,!0);if(!h.filter(new Gn(this.tileID.overscaledZ),D,this.tileID.canonical))continue}else if(!h.filter(new Gn(this.tileID.overscaledZ),v))continue;const b=r.getId(v,l),E=new Ob(v,f,p,m,b);E.tile=_,t.push(E)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}bucketsLoaded(){for(const t in this.buckets)if(this.buckets[t].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const r=Yt(t.cacheControl);r["max-age"]&&(this.expirationTime=Date.now()+1e3*r["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const r=Date.now();let s=!1;if(this.expirationTime>r)s=!1;else if(n)if(this.expirationTime<n)s=!0;else{const l=this.expirationTime-n;l?this.expirationTime=r+Math.max(l,3e4):s=!0}else s=!0;s?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(t,n){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(t).length&&n&&this.updateBuckets(t,n)}updateBuckets(t,n){if(!this.latestFeatureIndex)return;const r=this.latestFeatureIndex.loadVTLayers(),s=n.style.listImages(),l=n.style.getBrightness();for(const c in this.buckets){if(!n.style.hasLayer(c))continue;const h=this.buckets[c],f=h.layers[0].sourceLayer||"_geojsonTileLayer",p=r[f];let m={};if(t&&(m=t[f],!p||!m||0===Object.keys(m).length))continue;if(h.update(m,p,s,this.imageAtlas&&this.imageAtlas.patternPositions||{},l),h instanceof ka||h instanceof xy){const y=n.style.getOwnSourceCache(h.layers[0].source);n._terrain&&n._terrain.enabled&&y&&h.programConfigurations.needsUpload&&n._terrain._clearRenderCacheForTile(y.id,this.tileID)}const _=n&&n.style&&n.style.getOwnLayer(c);_&&(this.queryPadding=Math.max(this.queryPadding,_.queryRadius(h)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<me.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=me.now()+t}setTexture(t,n){const r=n.context,s=r.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture?this.texture.update(t,{useMipmap:!0}):(this.texture=new pr(r,t,s.RGBA,{useMipmap:!0}),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE))}setDependencies(t,n){const r={};for(const s of n)r[s]=!0;this.dependencies[t]=r}hasDependency(t,n){for(const r of t){const s=this.dependencies[r];if(s)for(const l of n)if(s[l])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||"mercator"===n.name||this._tileDebugBuffer)return;const r=ze(hw,this.tileID.canonical,this.tileTransform)[0],s=new ro,l=new ga;for(let c=0;c<r.length;c++){const{x:h,y:f}=r[c];s.emplaceBack(h,f),l.emplaceBack(c)}l.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(l),this._tileDebugBuffer=t.createVertexBuffer(s,_l.members),this._tileDebugSegments=ln.simpleSegment(0,0,s.length,l.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||"mercator"===n.name)return;const r=ze(hw,this.tileID.canonical,this.tileTransform)[0];let s,l;if(this.isRaster){const c=function(h,f){const p=Ml(h,f),m=Math.pow(2,h.z);for(let D=0;D<33;D++)for(let T=0;T<33;T++){const C=Vi((h.x+(T+hs(T))/32)/m),I=dr((h.y+(D+hs(D))/32)/m),A=f.project(C,I),M=33*D+T;Fa[2*M+0]=Math.round((A.x*p.scale-p.x)*st),Fa[2*M+1]=Math.round((A.y*p.scale-p.y)*st)}za.fill(0),kd.fill(0);for(let D=2045;D>=0;D--){const T=4*D,C=Oa[T+0],I=Oa[T+1],A=Oa[T+2],M=Oa[T+3],R=C+A>>1,L=I+M>>1,O=R+L-I,z=L+C-R,N=33*I+C,V=33*M+A,B=33*L+R,$=Math.hypot((Fa[2*N+0]+Fa[2*V+0])/2-Fa[2*B+0],(Fa[2*N+1]+Fa[2*V+1])/2-Fa[2*B+1])>=16;za[B]=za[B]||($?1:0),D<1022&&(za[B]=za[B]||za[33*(I+z>>1)+(C+O>>1)]||za[33*(M+z>>1)+(A+O>>1)])}const _=new ks,y=new er;let v=0;function b(D,T){const C=33*T+D;return 0===kd[C]&&(_.emplaceBack(Fa[2*C+0],Fa[2*C+1],D*st/32,T*st/32),kd[C]=++v),kd[C]-1}function E(D,T,C,I,A,M){const R=D+C>>1,L=T+I>>1;if(Math.abs(D-A)+Math.abs(T-M)>1&&za[33*L+R])E(A,M,D,T,R,L),E(C,I,A,M,R,L);else{const O=b(D,T),z=b(C,I),N=b(A,M);y.emplaceBack(O,z,N)}}return E(0,0,32,32,32,0),E(32,32,0,0,0,32),{vertices:_,indices:y}}(this.tileID.canonical,n);s=c.vertices,l=c.indices}else{s=new ks,l=new er;for(const{x:h,y:f}of r)s.emplaceBack(h,f,0,0);const c=yy(s.int16,void 0,4);for(let h=0;h<c.length;h+=3)l.emplaceBack(c[h],c[h+1],c[h+2])}this._tileBoundsBuffer=t.createVertexBuffer(s,Wy.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(l),this._tileBoundsSegments=ln.simpleSegment(0,0,s.length,l.length)}_makeGlobeTileDebugBuffers(t,n){const r=n.projection;if(!r||"globe"!==r.name||n.freezeTileCoverage)return;const s=this.tileID.canonical,l=$s(V_(s,n)),c=Mr(n.zoom);let h;c>0&&(h=et.invert(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,s,n,l,h,c),this._makeGlobeTileDebugTextBuffer(t,s,n,l,h,c)}_globePoint(t,n,r,s,l,c,h){let f=ad(t,n,r);if(c){const p=1<<r.z,m=Xr(s.center.lng),_=Ur(s.center.lat),y=(r.x+.5)/p-m;let v=0;y>.5?v=-1:y<-.5&&(v=1);let b=(t/st+r.x)/p+v,E=(n/st+r.y)/p;b=(b-m)*s._pixelsPerMercatorPixel+m,E=(E-_)*s._pixelsPerMercatorPixel+_;const D=[b*s.worldSize,E*s.worldSize,0];H.transformMat4(D,D,c),f=Ea(f,D,h)}return H.transformMat4(f,f,l)}_makeGlobeTileDebugBorderBuffer(t,n,r,s,l,c){const h=new ro,f=new ga,p=new yu,m=(y,v,b,E,D)=>{const T=(b-y)/(D-1),C=(E-v)/(D-1),I=h.length;for(let A=0;A<D;A++){const M=y+A*T,R=v+A*C;h.emplaceBack(M,R);const L=this._globePoint(M,R,n,r,s,l,c);p.emplaceBack(L[0],L[1],L[2]),f.emplaceBack(I+A)}},_=st;m(0,0,_,0,16),m(_,0,_,_,16),m(_,_,0,_,16),m(0,_,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(f),this._tileDebugBuffer=t.createVertexBuffer(h,_l.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(p,F_.members),this._tileDebugSegments=ln.simpleSegment(0,0,h.length,f.length)}_makeGlobeTileDebugTextBuffer(t,n,r,s,l,c){const f=new ro,p=new er,m=new yu,_=25;p.reserve(32),f.reserve(_),m.reserve(_);const y=(v,b)=>_*v+b;for(let v=0;v<_;v++){const b=2048*v;for(let E=0;E<_;E++){const D=2048*E;f.emplaceBack(D,b);const T=this._globePoint(D,b,n,r,s,l,c);m.emplaceBack(T[0],T[1],T[2])}}for(let v=0;v<4;v++)for(let b=0;b<4;b++){const E=y(v,b),D=y(v,b+1),T=y(v+1,b),C=y(v+1,b+1);p.emplaceBack(E,D,T),p.emplaceBack(T,D,C)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(p),this._tileDebugTextBuffer=t.createVertexBuffer(f,_l.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(m,F_.members),this._tileDebugTextSegments=ln.simpleSegment(0,0,_,32)}}class ds{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,r){const s=t.wrapped().key;void 0===this.data[s]&&(this.data[s]=[]);const l={value:n,timeout:void 0};if(void 0!==r&&(l.timeout=setTimeout(()=>{this.remove(t,l)},r)),this.data[s].push(l),this.order.push(s),this.order.length>this.max){const c=this._getAndRemoveByKey(this.order[0]);c&&this.onRemove(c)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),0===this.data[t].length&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const r=t.wrapped().key,s=void 0===n?0:this.data[r].indexOf(n),l=this.data[r][s];return this.data[r].splice(s,1),l.timeout&&clearTimeout(l.timeout),0===this.data[r].length&&delete this.data[r],this.onRemove(l.value),this.order.splice(this.order.indexOf(r),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const r in this.data)for(const s of this.data[r])t(s.value)||n.push(s);for(const r of n)this.remove(r.value.tileID,r)}}let No=(()=>{class e{constructor(n,r,s,l){this.id=e.uniqueIdxCounter,e.uniqueIdxCounter++,this.context=n;const c=n.gl;this.buffer=c.createBuffer(),this.dynamicDraw=Boolean(s),this.context.unbindVAO(),n.bindElementBuffer.set(this.buffer),c.bufferData(c.ELEMENT_ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?c.DYNAMIC_DRAW:c.STATIC_DRAW),this.dynamicDraw||l||r.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(n){this.id=e.uniqueIdxCounter,e.uniqueIdxCounter++;const r=this.context.gl;this.context.unbindVAO(),this.bind(),r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,0,n.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return e.uniqueIdxCounter=0,e})();const dw={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class fw{constructor(t,n,r,s,l,c){this.length=n.length,this.attributes=r,this.itemSize=n.bytesPerElement,this.dynamicDraw=s,this.instanceCount=c,this.context=t;const h=t.gl;this.buffer=h.createBuffer(),t.bindVertexBuffer.set(this.buffer),h.bufferData(h.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?h.DYNAMIC_DRAW:h.STATIC_DRAW),this.dynamicDraw||l||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let r=0;r<this.attributes.length;r++){const s=n.attributes[this.attributes[r].name];void 0!==s&&t.enableVertexAttribArray(s)}}setVertexAttribPointers(t,n,r){for(let s=0;s<this.attributes.length;s++){const l=this.attributes[s],c=n.attributes[l.name];void 0!==c&&t.vertexAttribPointer(c,l.components,t[dw[l.type]],!1,this.itemSize,l.offset+this.itemSize*(r||0))}}setVertexAttribDivisor(t,n,r){for(let s=0;s<this.attributes.length;s++){const l=n.attributes[this.attributes[s].name];void 0!==l&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(l,r)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class kn{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class qS extends kn{getDefault(){return le.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class WS extends kn{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class ZS extends kn{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Zy extends kn{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Od extends kn{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class XS extends kn{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class pw extends kn{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class YS extends kn{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class mw extends kn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class gw extends kn{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class mm extends kn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class KS extends kn{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class _w extends kn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class Ec extends kn{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class yw extends kn{getDefault(){return le.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Xy extends kn{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class vw extends kn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class xw extends kn{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class bw extends kn{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let ww=class extends kn{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}};class Ew extends kn{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Tw extends kn{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Dw extends kn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Sw extends kn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class JS extends kn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class QS extends kn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class tC extends kn{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class eC extends kn{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class nC extends kn{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class rC extends kn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class iC extends kn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Yy extends kn{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class oC extends Yy{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Cw extends Yy{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class sC extends Yy{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class aC extends Cw{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class lC{constructor(t,n,r,s,l){this.context=t,this.width=n,this.height=r;const c=this.framebuffer=t.gl.createFramebuffer();s&&(this.colorAttachment=new oC(t,c)),l&&(this.depthAttachmentType=l,this.depthAttachment="renderbuffer"===l?new Cw(t,c):new sC(t,c))}destroy(){const t=this.context.gl;if(this.colorAttachment){const n=this.colorAttachment.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class ue{constructor(t,n,r){this.func=t,this.mask=n,this.range=r}}ue.ReadOnly=!1,ue.ReadWrite=!0,ue.disabled=new ue(519,ue.ReadOnly,[0,1]);class Re{constructor(t,n,r,s,l,c){this.test=t,this.ref=n,this.mask=r,this.fail=s,this.depthFail=l,this.pass=c}}Re.disabled=new Re({func:519,mask:0},0,0,7680,7680,7680);class Ye{constructor(t,n,r,s){this.blendFunction=t,this.blendColor=n,this.mask=r,this.blendEquation=s}}Ye.Replace=[1,0,1,0],Ye.disabled=new Ye(Ye.Replace,le.transparent,[!1,!1,!1,!1]),Ye.unblended=new Ye(Ye.Replace,le.transparent,[!0,!0,!0,!0]),Ye.alphaBlended=new Ye([1,771,1,771],le.transparent,[!0,!0,!0,!0]),Ye.multiply=new Ye([774,0,774,0],le.transparent,[!0,!0,!0,!0]);class Le{constructor(t,n,r){this.enable=t,this.mode=n,this.frontFace=r}}Le.disabled=new Le(!1,1029,2305),Le.backCCW=new Le(!0,1029,2305),Le.backCW=new Le(!0,1029,2304),Le.frontCW=new Le(!0,1028,2304),Le.frontCCW=new Le(!0,1028,2305);class Mw{constructor(t){this.gl=t,this.clearColor=new qS(this),this.clearDepth=new WS(this),this.clearStencil=new ZS(this),this.colorMask=new Zy(this),this.depthMask=new Od(this),this.stencilMask=new XS(this),this.stencilFunc=new pw(this),this.stencilOp=new YS(this),this.stencilTest=new mw(this),this.depthRange=new gw(this),this.depthTest=new mm(this),this.depthFunc=new KS(this),this.blend=new _w(this),this.blendFunc=new Ec(this),this.blendColor=new yw(this),this.blendEquation=new Xy(this),this.cullFace=new vw(this),this.cullFaceSide=new xw(this),this.frontFace=new bw(this),this.program=new ww(this),this.activeTexture=new Ew(this),this.viewport=new Tw(this),this.bindFramebuffer=new Dw(this),this.bindRenderbuffer=new Sw(this),this.bindTexture=new JS(this),this.bindVertexBuffer=new QS(this),this.bindElementBuffer=new tC(this),this.bindVertexArrayOES=new eC(this),this.pixelStoreUnpack=new nC(this),this.pixelStoreUnpackPremultiplyAlpha=new rC(this),this.pixelStoreUnpackFlipY=new iC(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extStandardDerivativesForceOff=!1,this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear"),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,r){return new No(this,t,n,r)}createVertexBuffer(t,n,r,s,l){return new fw(this,t,n,r,s,l)}createRenderbuffer(t,n,r){const s=this.gl,l=s.createRenderbuffer();return this.bindRenderbuffer.set(l),s.renderbufferStorage(s.RENDERBUFFER,t,n,r),this.bindRenderbuffer.set(null),l}createFramebuffer(t,n,r,s){return new lC(this,t,n,r,s)}clear({color:t,depth:n,stencil:r,colorMask:s}){const l=this.gl;let c=0;t&&(c|=l.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(s||[!0,!0,!0,!0])),void 0!==n&&(c|=l.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),void 0!==r&&(c|=l.STENCIL_BUFFER_BIT,this.clearStencil.set(r),this.stencilMask.set(255)),l.clear(c)}setCullFace(t){!1===t.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){Ke(t.blendFunction,Ye.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class Bo extends xn{constructor(t,n,r){super(),this.id=t,this._onlySymbols=r,n.on("data",s=>{"source"===s.dataType&&"metadata"===s.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===s.dataType&&"content"===s.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),n.on("error",()=>{this._sourceErrored=!0}),this._source=n,this._tiles={},this._cache=new ds(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Cy,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(t){this.map=t,this._minTileCacheSize=void 0===this._minTileCacheSize&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const n=this._tiles[t];if("errored"!==n.state&&("loaded"!==n.state||!n.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,()=>{})}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const r=this._tiles[n];r.upload(t),r.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return yi(this._tiles).map(t=>t.tileID).sort(Jy).map(t=>t.key)}getRenderableIds(t,n){const r=[];for(const s in this._tiles)this._isIdRenderable(+s,t,n)&&r.push(this._tiles[s]);return t?r.sort((s,l)=>{const c=s.tileID,h=l.tileID,f=new tt(c.canonical.x,c.canonical.y)._rotate(this.transform.angle),p=new tt(h.canonical.x,h.canonical.y)._rotate(this.transform.angle);return c.overscaledZ-h.overscaledZ||p.y-f.y||p.x-f.x}).map(s=>s.tileID.key):r.map(s=>s.tileID).sort(Jy).map(s=>s.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,r){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(r||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)"errored"!==this._tiles[t].state&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const r=this._tiles[t];r&&("loading"!==r.state&&(r.state=n),this._loadTile(r,this._tileLoaded.bind(this,r,t,n)))}_tileLoaded(t,n,r,s){if(s)if(t.state="errored",404!==s.status)this._source.fire(new he(s,{tile:t}));else if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const l=this.map.painter.terrain;this.update(this.transform,l.getScaledDemTileSize(),!0),l.resetTileLookupCache(this.id)}else this.update(this.transform);else t.timeAdded=me.now(),"expired"===r&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),"raster-dem"===this._source.type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new xt("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const n=this.getRenderableIds();for(let s=0;s<n.length;s++){const l=n[s];if(t.neighboringTiles&&t.neighboringTiles[l]){const c=this.getTileByID(l);r(t,c),r(c,t)}}function r(s,l){if(!s.dem||s.dem.borderReady)return;s.needsHillshadePrepare=!0,s.needsDEMTextureUpload=!0;let c=l.tileID.canonical.x-s.tileID.canonical.x;const h=l.tileID.canonical.y-s.tileID.canonical.y,f=Math.pow(2,s.tileID.canonical.z),p=l.tileID.key;0===c&&0===h||Math.abs(h)>1||(Math.abs(c)>1&&(1===Math.abs(c+f)?c+=f:1===Math.abs(c-f)&&(c-=f)),l.dem&&s.dem&&(s.dem.backfillBorder(l.dem,c,h),s.neighboringTiles&&s.neighboringTiles[p]&&(s.neighboringTiles[p].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,r,s){for(const l in this._tiles){let c=this._tiles[l];if(s[l]||!c.hasData()||c.tileID.overscaledZ<=n||c.tileID.overscaledZ>r)continue;let h=c.tileID;for(;c&&c.tileID.overscaledZ>n+1;){const p=c.tileID.scaledTo(c.tileID.overscaledZ-1);c=this._tiles[p.key],c&&c.hasData()&&(h=p)}let f=h;for(;f.overscaledZ>n;)if(f=f.scaledTo(f.overscaledZ-1),t[f.key]){s[h.key]=h;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const r=this._loadedParentTiles[t.key];return r&&r.tileID.overscaledZ>=n?r:null}for(let r=t.overscaledZ-1;r>=n;r--){const s=t.scaledTo(r),l=this._getLoadedTile(s);if(l)return l}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const r=Math.ceil(t.width/n)+1,s=Math.ceil(t.height/n)+1,l=Math.floor(r*s*5),c="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,l):l,h="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,c):c;this._cache.setMaxSize(h)}handleWrapJump(t){const n=Math.round((t-(void 0===this._prevLng?t:this._prevLng))/360);if(this._prevLng=t,n){const r={};for(const s in this._tiles){const l=this._tiles[s];l.tileID=l.tileID.unwrapTo(l.tileID.wrap+n),r[l.tileID.key]=l}this._tiles=r;for(const s in this._timers)clearTimeout(this._timers[s]),delete this._timers[s];for(const s in this._tiles)this._setTileReloadTimer(+s,this._tiles[s])}}update(t,n,r,s){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!r)return;let l;if(this.updateCacheSize(t,n),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?l=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(f=>new tn(f.canonical.z,f.wrap,f.canonical.z,f.canonical.x,f.canonical.y)):(l=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!r,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(l=l.filter(f=>this._source.hasTile(f)))):l=[],l.length>0&&this.castsShadows&&s&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!vm(this._source.type)){const f=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!r}),p=Math.min(f,this._source.maxzoom),m=t.extendTileCoverForShadows(l,s,p);for(const _ of m)this._shadowCasterTiles[_.key]=!0,l.push(_)}const c=this._updateRetainedTiles(l);if(vm(this._source.type)&&0!==l.length){const f={},p={},m=Object.keys(c);for(const y of m){const v=c[y],b=this._tiles[y];if(!b||b.fadeEndTime&&b.fadeEndTime<=me.now())continue;const E=this.findLoadedParent(v,Math.max(v.overscaledZ-Bo.maxOverzooming,this._source.minzoom));E&&(this._addTile(E.tileID),f[E.tileID.key]=E.tileID),p[y]=v}const _=l[l.length-1].overscaledZ;for(const y in this._tiles){const v=this._tiles[y];if(c[y]||!v.hasData())continue;let b=v.tileID;for(;b.overscaledZ>_;){b=b.scaledTo(b.overscaledZ-1);const E=this._tiles[b.key];if(E&&E.hasData()&&p[b.key]){c[y]=v.tileID;break}}}for(const y in f)c[y]||(this._coveredTiles[y]=!0,c[y]=f[y])}for(const f in c)this._tiles[f].clearFadeHold();const h=function(f,p){const m=[];for(const _ in f)_ in p||m.push(_);return m}(this._tiles,c);for(const f of h){const p=this._tiles[f];p.hasSymbolBuckets&&!p.holdingForFade()?p.setHoldDuration(this.map._fadeDuration):p.hasSymbolBuckets&&!p.symbolFadeFinished()||this._removeTile(+f)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(0===t.length)return n;const r={},s=t.reduce((p,m)=>Math.min(p,m.overscaledZ),1/0),l=t[0].overscaledZ,c=Math.max(l-Bo.maxOverzooming,this._source.minzoom),h=Math.max(l+Bo.maxUnderzooming,this._source.minzoom),f={};for(const p of t){const m=this._addTile(p);n[p.key]=p,m.hasData()||s<this._source.maxzoom&&(f[p.key]=p)}this._retainLoadedChildren(f,s,h,n);for(const p of t){let m=this._tiles[p.key];if(m.hasData())continue;if(p.canonical.z>=this._source.maxzoom){const y=p.children(this._source.maxzoom)[0],v=this.getTile(y);if(v&&v.hasData()){n[y.key]=y;continue}}else{const y=p.children(this._source.maxzoom);if(n[y[0].key]&&n[y[1].key]&&n[y[2].key]&&n[y[3].key])continue}let _=m.wasRequested();for(let y=p.overscaledZ-1;y>=c;--y){const v=p.scaledTo(y);if(r[v.key]||(r[v.key]=!0,m=this.getTile(v),!m&&_&&(m=this._addTile(v)),m&&(n[v.key]=v,_=m.wasRequested(),m.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let r,s=this._tiles[t].tileID;for(;s.overscaledZ>0;){if(s.key in this._loadedParentTiles){r=this._loadedParentTiles[s.key];break}n.push(s.key);const l=s.scaledTo(s.overscaledZ-1);if(r=this._getLoadedTile(l),r)break;s=l}for(const l of n)this._loadedParentTiles[l]=r}}_addTile(t){let n=this._tiles[t.key];if(n)return!0!==n.isExtraShadowCaster||!!this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const r=Boolean(n);if(!r){const s=this.map?this.map.painter:null;n=new co(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,s,this._isRaster),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n?(n.uses++,this._tiles[t.key]=n,r||this._source.fire(new xt("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n):null}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const r=n.getExpiryTimeout();r&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},r))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&"reloading"!==n.state?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,r){const s=[],l=this.transform;if(!l)return s;const c="globe"===l.projection.name,h=Xr(l.center.lng);for(const f in this._tiles){const p=this._tiles[f];if(r&&p.clearQueryDebugViz(),p.holdingForFade())continue;let m;if(c){const _=p.tileID.canonical;if(0===_.z){const y=[Math.abs(Gt(h,...Xu(_,-1))-h),Math.abs(Gt(h,...Xu(_,1))-h)];m=[0,2*y.indexOf(Math.min(...y))-1]}else{const y=[Math.abs(Gt(h,...Xu(_,-1))-h),Math.abs(Gt(h,...Xu(_,0))-h),Math.abs(Gt(h,...Xu(_,1))-h)];m=[y.indexOf(Math.min(...y))-1]}}else m=[0];for(const _ of m){const y=t.containsTile(p,l,n,_);y&&s.push(y)}}return s}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const r=this.getRenderableIds(t,n).map(s=>this._tiles[s].tileID);for(const s of r)s.projMatrix=this.transform.calculateProjMatrix(s.toUnwrapped());return r}sortCoordinatesByDistance(t){const n=t.slice(),r=this.transform._camera.position,s=this.transform._camera.forward(),l={};for(const c of n){const h=1/(1<<c.canonical.z);l[c.key]=((c.canonical.x+.5)*h+c.wrap-r[0])*s[0]+((c.canonical.y+.5)*h-r[1])*s[1]-r[2]*s[2]}return n.sort((c,h)=>l[c.key]-l[h.key]),n}hasTransition(){if(this._source.hasTransition())return!0;if(vm(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(void 0!==n.fadeEndTime&&n.fadeEndTime>=me.now())return!0}return!1}setFeatureState(t,n,r){this._state.updateState(t=t||"_geojsonTileLayer",n,r)}removeFeatureState(t,n,r){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,r)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,r){const s=this._tiles[t];s&&s.setDependencies(n,r)}reloadTilesForDependencies(t,n){for(const r in this._tiles)this._tiles[r].hasDependency(t,n)&&this._reloadTile(+r,"reloading");this._cache.filter(r=>!r.hasDependency(t,n))}_preloadTiles(t,n){if(!this._sourceLoaded){const h=()=>{this._sourceLoaded&&(this._source.off("data",h),this._preloadTiles(t,n))};return void this._source.on("data",h)}const r=new Map,s=Array.isArray(t)?t:[t],l=this.map.painter.terrain,c=this.usedForTerrain&&l?l.getScaledDemTileSize():this._source.tileSize;for(const h of s){const f=h.coveringTiles({tileSize:c,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const p of f)r.set(p.key,p);this.usedForTerrain&&h.updateElevation(!1)}Ul(Array.from(r.values()),(h,f)=>{const p=new co(h,this._source.tileSize*h.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(p,m=>{"raster-dem"===this._source.type&&p.dem&&this._backfillDEM(p),f(m,p)})},n)}}function Jy(e,t){const n=Math.abs(2*e.wrap)-+(e.wrap<0),r=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||r-n||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x}function vm(e){return"raster"===e||"image"===e||"video"===e||"custom"===e}function Xu(e,t){const n=1<<e.z;return[e.x/n+t,(e.x+1)/n+t]}Bo.maxOverzooming=10,Bo.maxUnderzooming=3;const Iw=sn([{name:"a_pos_3f",components:3,type:"Float32"}]),Aw=sn([{name:"a_color_3f",components:3,type:"Float32"}]),Pw=sn([{name:"a_color_4f",components:4,type:"Float32"}]),Tc=sn([{name:"a_uv_2f",components:2,type:"Float32"}]),cC=sn([{name:"a_normal_3f",components:3,type:"Float32"}]),uC=sn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Yu=sn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class Rw{constructor(t=0,n=0,r=0,s=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(r)||r<0||isNaN(s)||s<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=r,this.right=s}interpolate(t,n,r){return null!=n.top&&null!=t.top&&(this.top=de(t.top,n.top,r)),null!=n.bottom&&null!=t.bottom&&(this.bottom=de(t.bottom,n.bottom,r)),null!=n.left&&null!=t.left&&(this.left=de(t.left,n.left,r)),null!=n.right&&null!=t.right&&(this.right=de(t.right,n.right,r)),this}getCenter(t,n){const r=Gt((this.left+t-this.right)/2,0,t),s=Gt((this.top+n-this.bottom)/2,0,n);return new tt(r,s)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Rw(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Di(e,t){const n=Yn(e,3);et.fromQuat(e,t),jr(e,3,n)}function Lw(e,t){const n=Zr.identity([]);return Zr.rotateZ(n,n,-t),Zr.rotateX(n,n,-e),n}function Qy(e,t){const n=[e[0],e[1],0],r=[t[0],t[1],0];if(H.length(n)>=1e-15){const c=H.normalize([],n);H.scale(r,c,H.dot(r,c)),t[0]=r[0],t[1]=r[1]}const s=H.cross([],t,e);if(H.len(s)<1e-15)return null;const l=Math.atan2(-s[1],s[0]);return Lw(Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2]),l)}class t0{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof He?t:new He(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=Ds(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n){if(this.orientation=null,!this.position)return;const r=this.position,s=this._elevation?this._elevation.getAtPointOrZero(He.fromLngLat(t)):0,l=He.fromLngLat(t,s),c=[l.x-r.x,l.y-r.y,l.z-r.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=Qy(c,n)}setPitchBearing(t,n){this.orientation=Lw(be(t),be(-n))}}class e0{constructor(t,n){this._transform=et.identity([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new He(t[0],t[1],t[2])}get position(){const t=Yn(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&jr(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||Zr.identity([]),t&&Di(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=Lw(t,n),Di(this._transform,this._orientation)}forward(){const t=Yn(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=Yn(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=Yn(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const r=new Float64Array(16);return et.invert(r,this.getWorldToCamera(t,n)),r}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,r){const s=this.position;H.scale(s,s,-t);const l=new Float64Array(16);return et.fromScaling(l,[r,r,r]),et.translate(l,l,s),l[10]*=n,l}getWorldToCamera(t,n){const r=new Float64Array(16),s=new Float64Array(4),l=this.position;return Zr.conjugate(s,this._orientation),H.scale(l,l,-t),et.fromQuat(r,s),et.translate(r,r,l),r[1]*=-1,r[5]*=-1,r[9]*=-1,r[13]*=-1,r[8]*=n,r[9]*=n,r[10]*=n,r[11]*=n,r}getCameraToClipPerspective(t,n,r,s){const l=new Float64Array(16);return et.perspective(l,t,n,r,s),l}getCameraToClipOrthographic(t,n,r,s,l,c){const h=new Float64Array(16);return et.ortho(h,t,n,r,s,l,c),h}getDistanceToElevation(t,n=!1){const r=0===t?0:gn(t,n?dr(this.position[1]):this.position[1]),s=this.forward();return(r-this.position[2])/s[2]}clone(){return new e0([...this.position],[...this.orientation])}}function ee(e,t){const n=Fd(e.projection,e.zoom,e.width,e.height),r=function(l,c,h,f,p){const m=new ce(h.lng-180*Il,h.lat),_=new ce(h.lng+180*Il,h.lat),y=l.project(m.lng,m.lat),v=l.project(_.lng,_.lat),b=-Math.atan2(v.y-y.y,v.x-y.x),E=He.fromLngLat(h);E.y=Gt(E.y,-1+Il,1-Il);const D=E.toLngLat(),T=l.project(D.lng,D.lat),C=He.fromLngLat(D);C.x+=Il;const I=C.toLngLat(),A=l.project(I.lng,I.lat),M=Ow(A.x-T.x,A.y-T.y,b),R=He.fromLngLat(D);R.y+=Il;const L=R.toLngLat(),O=l.project(L.lng,L.lat),z=Ow(O.x-T.x,O.y-T.y,b),N=Math.abs(M.x)/Math.abs(z.y),V=et.identity([]);et.rotateZ(V,V,-b*(1-(p?0:f)));const B=et.identity([]);return et.scale(B,B,[1,1-(1-N)*f,1]),B[4]=-z.x/z.y*f,et.rotateZ(B,B,b),et.multiply(B,V,B),B}(e.projection,0,e.center,n,t),s=kw(e);return et.scale(r,r,[s,s,1]),r}function kw(e){const t=e.projection,n=Fd(e.projection,e.zoom,e.width,e.height),r=Dc(t,e.center),s=Dc(t,ce.convert(t.center));return Math.pow(2,r*n+(1-n)*s)}function Fd(e,t,n,r,s=1/0){const l=e.range;if(!l)return 0;const c=Math.min(s,Math.max(n,r)),h=Math.log(c/1024)/Math.LN2;return Ts(l[0]+h,l[1]+h,t)}const Il=1/4e4;function Dc(e,t){const n=Gt(t.lat,-nr,nr),r=new ce(t.lng-180*Il,n),s=new ce(t.lng+180*Il,n),l=e.project(r.lng,n),c=e.project(s.lng,n),h=He.fromLngLat(r),f=He.fromLngLat(s),p=c.x-l.x,m=c.y-l.y,_=f.x-h.x,y=f.y-h.y,v=Math.sqrt((_*_+y*y)/(p*p+m*m));return Math.log(v)/Math.LN2}function Ow(e,t,n){const r=Math.cos(n),s=Math.sin(n);return{x:e*r-t*s,y:e*s+t*r}}function Xs(e,t,n){return t*(st/(e.tileSize*Math.pow(2,n-e.tileID.overscaledZ)))}const Na_unknown=0,Na_flipRequired=1,Na_flipNotRequired=2,Ar=Math.tan(85*Math.PI/180);function n0(e,t,n,r,s,l,c){const h=et.create();if(n)if("globe"===l.name){const f=function(p,m){const{x:_,y}=p.point,v=K1(_,y,p.worldSize/p._pixelsPerMercatorPixel,0,0);return et.multiply(v,v,q_(wo(m)))}(s,t);et.multiply(h,h,f)}else{const f=Su.invert([],c);h[0]=f[0],h[1]=f[1],h[4]=f[2],h[5]=f[3],r||et.rotateZ(h,h,s.angle)}else et.multiply(h,s.labelPlaneMatrix,e);return h}function r0(e,t,n,r,s,l,c){const h=n0(e,t,n,r,s,l,c);return"globe"===l.name&&n||(h[2]=h[6]=h[10]=h[14]=0),h}function o0(e,t,n,r,s,l,c){if(n){if("globe"===l.name){const h=n0(e,t,n,r,s,l,c);return et.invert(h,h),et.multiply(h,e,h),h}{const h=et.clone(e),f=et.identity([]);return f[0]=c[0],f[1]=c[1],f[4]=c[2],f[5]=c[3],et.multiply(h,h,f),r||et.rotateZ(h,h,-s.angle),h}}return s.glCoordMatrix}function fs(e,t,n,r){const s=[e,t,n,1];n?an.transformMat4(s,s,r):Vw(s,s,r);const l=s[3];return s[0]/=l,s[1]/=l,s[2]/=l,s}function s0(e,t){return Math.min(.5+e/t*.5,1.5)}function Fw(e,t){const n=e[0]/e[3],r=e[1]/e[3];return n>=-t[0]&&n<=t[0]&&r>=-t[1]&&r<=t[1]}function zw(e,t,n,r,s,l,c,h,f,p){const m=n.transform,_=r?e.textSizeData:e.iconSizeData,y=ls(_,n.transform.zoom),v="globe"===m.projection.name,b=[256/n.width*2+1,256/n.height*2+1],E=r?e.text.dynamicLayoutVertexArray:e.icon.dynamicLayoutVertexArray;E.clear();let D=null;v&&(D=r?e.text.globeExtVertexArray:e.icon.globeExtVertexArray);const T=e.lineVertexArray,C=r?e.text.placedSymbolArray:e.icon.placedSymbolArray,I=n.transform.width/n.transform.height;let A,M=!1;for(let R=0;R<C.length;R++){const L=C.get(R),{numGlyphs:O,writingMode:z}=L;if(z!==Bn.vertical||M||A===Bn.horizontal||(M=!0),A=z,(L.hidden||z===Bn.vertical)&&!M){Ju(O,E);continue}M=!1;const N=new tt(L.tileAnchorX,L.tileAnchorY);let{x:V,y:B,z:$}=m.projection.projectTilePoint(N.x,N.y,p.canonical);if(f){const[ht,ft,at]=f(N);V+=ht,B+=ft,$+=at}const j=[V,B,$,1];if(an.transformMat4(j,j,t),!Fw(j,b)){Ju(O,E);continue}const Z=j[3],K=s0(n.transform.getCameraToCenterDistance(m.projection),Z),Q=Jp(_,y,L),W=c?Q/K:Q*K,X=fs(V,B,$,s);if(X[3]<=0){Ju(O,E);continue}let nt={};const ot=c?null:f,lt=Bw(L,W,!1,h,t,s,l,e.glyphOffsetArray,T,E,D,X,N,nt,I,ot,m.projection,p,c);M=lt.useVertical,ot&&lt.needsFlipping&&(nt={}),(lt.notEnoughRoom||M||lt.needsFlipping&&Bw(L,W,!0,h,t,s,l,e.glyphOffsetArray,T,E,D,X,N,nt,I,ot,m.projection,p,c).notEnoughRoom)&&Ju(O,E)}r?(e.text.dynamicLayoutVertexBuffer.updateData(E),D&&e.text.globeExtVertexBuffer&&e.text.globeExtVertexBuffer.updateData(D)):(e.icon.dynamicLayoutVertexBuffer.updateData(E),D&&e.icon.globeExtVertexBuffer&&e.icon.globeExtVertexBuffer.updateData(D))}function a0(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E){const{lineStartIndex:D,glyphStartIndex:T,segment:C}=h,I=T+h.numGlyphs,A=D+h.lineLength,M=t.getoffsetX(T),R=t.getoffsetX(I-1),L=xm(e*M,n,r,s,l,c,C,D,A,f,p,m,_,y,!0,v,b,E);if(!L)return null;const O=xm(e*R,n,r,s,l,c,C,D,A,f,p,m,_,y,!0,v,b,E);return O?{first:L,last:O}:null}function Nw(e,t,n,r){return e===Bn.horizontal&&Math.abs(r)>Math.abs(n)?{useVertical:!0}:e===Bn.vertical?r>0?{needsFlipping:!0}:null:t!==Na_unknown&&(0===(s=n)||Math.abs(r/s)>Ar)?t===Na_flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null;var s}function Bw(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C){const I=t/24,A=e.lineOffsetX*I,M=e.lineOffsetY*I,{lineStartIndex:R,glyphStartIndex:L,numGlyphs:O,segment:z,writingMode:N,flipState:V}=e,B=R+e.lineLength,$=j=>{if(m){const[W,X,nt]=j.up,ot=p.length;Gy(m,ot+0,W,X,nt),Gy(m,ot+1,W,X,nt),Gy(m,ot+2,W,X,nt),Gy(m,ot+3,W,X,nt)}const[Z,K,Q]=j.point;Wu(p,Z,K,Q,j.angle)};if(O>1){const j=a0(I,h,A,M,n,_,y,e,f,l,v,E,!1,D,T,C);if(!j)return{notEnoughRoom:!0};if(r&&!n){let[Z,K,Q]=j.first.point,[W,X,nt]=j.last.point;[Z,K]=fs(Z,K,Q,c),[W,X]=fs(W,X,nt,c);const ot=Nw(N,V,(W-Z)*b,X-K);if(e.flipState=ot&&ot.needsFlipping?Na_flipRequired:Na_flipNotRequired,ot)return ot}$(j.first);for(let Z=L+1;Z<L+O-1;Z++){const K=xm(I*h.getoffsetX(Z),A,M,n,_,y,z,R,B,f,l,v,E,!1,!1,D,T,C);if(!K)return p.length-=4*(Z-L),{notEnoughRoom:!0};$(K)}$(j.last)}else{if(r&&!n){const Z=fs(y.x,y.y,0,s),K=R+z+1,Q=new tt(f.getx(K),f.gety(K)),W=fs(Q.x,Q.y,0,s),X=W[3]>0?W:Ku(y,Q,Z,1,s,void 0,D,T.canonical),nt=Nw(N,V,(X[0]-Z[0])*b,X[1]-Z[1]);if(e.flipState=nt&&nt.needsFlipping?Na_flipRequired:Na_flipNotRequired,nt)return nt}const j=xm(I*h.getoffsetX(L),A,M,n,_,y,z,R,B,f,l,v,E,!1,!1,D,T,C);if(!j)return{notEnoughRoom:!0};$(j)}return{}}function jw(e,t,n,r,s){const{x:l,y:c,z:h}=r.projectTilePoint(e.x,e.y,t);if(!s)return fs(l,c,h,n);const[f,p,m]=s(e);return fs(l+f,c+p,h+m,n)}function Ku(e,t,n,r,s,l,c,h){const f=jw(e.sub(t)._unit()._add(e),h,s,c,l);return H.sub(f,n,f),H.normalize(f,f),H.scaleAndAdd(f,n,f,r)}function xm(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T){const C=r?e-t:e+t;let I=C>0?1:-1,A=0;r&&(I*=-1,A=Math.PI),I<0&&(A+=Math.PI);let M=h+c+(I>0?0:1)|0,R=s,L=s,O=0,z=0;const N=Math.abs(C),V=[],B=[];let $=l,j=$;const Z=()=>Ku(j,$,L,N-O+1,m,y,E,D.canonical);for(;O+z<=N;){if(M+=I,M<h||M>=f)return null;if(L=R,j=$,V.push(L),v&&B.push(j),$=new tt(p.getx(M),p.gety(M)),R=_[M],!R){const ft=jw($,D.canonical,m,E,y);R=ft[3]>0?_[M]=ft:Z()}O+=z,z=H.distance(L,R)}b&&y&&(_[M]&&(R=Z(),z=H.distance(L,R)),_[M]=R);const K=(N-O)/z,Q=$.sub(j)._mult(K)._add(j),W=H.sub([],R,L),X=H.scaleAndAdd([],L,W,K);let nt=[0,0,1],ot=W[0],lt=W[1];if(T&&(nt=E.upVector(D.canonical,Q.x,Q.y),0!==nt[0]||0!==nt[1]||1!==nt[2])){const ft=[nt[2],0,-nt[0]],at=H.cross([],nt,ft);H.normalize(ft,ft),H.normalize(at,at),ot=H.dot(W,ft),lt=H.dot(W,at)}if(n){const ft=H.cross([],nt,W);H.normalize(ft,ft),H.scaleAndAdd(X,X,ft,n*I)}const ht=A+Math.atan2(lt,ot);return V.push(X),v&&B.push(Q),{point:X,angle:ht,path:V,tilePath:B,up:nt}}function Ju(e,t){const n=t.length,r=n+4*e;t.resize(r),t.float32.fill(-1/0,4*n,4*r)}function Vw(e,t,n){const r=t[0],s=t[1];return e[0]=n[0]*r+n[4]*s+n[12],e[1]=n[1]*r+n[5]*s+n[13],e[3]=n[3]*r+n[7]*s+n[15],e}const zd=(e,t,n)=>(1-n)*e+n*t,l0=e=>e*e*e*e*e;class bm{constructor(t,n,r,s,l,c,h){this.tileSize=512,this._renderWorldCopies=void 0===l||l,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=r??0,this._maxPitch=s??60,this.setProjection(c),this.setMaxBounds(h),this.width=0,this.height=0,this._center=new ce(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Rw,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new e0,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const t=new bm(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(t,n=!1){const r=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||r)&&this._updateCameraOnTerrain(),(t||r)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return Ci(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=Id(this.projectionOptions);const r=!Ke(n,this.getProjection());return r&&this._calcMatrices(),this.mercatorFromTransition=!1,r}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=Id({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(t){void 0===t?t=!0:null===t&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return gn(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new tt(this.width,this.height)}get bearing(){return Ds(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=Su.create(),Su.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=Gt(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=be(t),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const r=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&r.exaggeration()&&this._centerAltitudeValidForExaggeration!==r.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*r.exaggeration(),this._centerAltitudeValidForExaggeration=r.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=r.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],r=this.horizonLineFromTop();let s=0,l=0;for(let c=0;c<n.length;c++){const h=new tt(n[c][0]*this.width,r+n[c][1]*(this.height-r)),f=t.pointCoordinate(h);if(!f)continue;const p=1/Math.hypot(f[0]-this._camera.position[0],f[1]-this._camera.position[1]);s+=f[3]*p,l+=p}return 0===l?NaN:s/l}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),r=this.pixelsPerMeter/this.worldSize*n,s=this._mercatorZfromZoom(t),l=this._mercatorZfromZoom(this._maxZoom),c=Math.max(s-r,l);this._setZoom(this._zoomFromMercatorZ(c))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let r;r=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const s=H.length(H.sub([],this._camera.position,r));return Gt(this._zoomFromMercatorZ(s),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!Zr.exactEquals(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const r=[t.position.x,t.position.y,t.position.z];H.exactEquals(r,this._camera.position)||(this._setCameraPosition(r),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new t0;return n.position=new He(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!Zr.length(t))return!1;Zr.normalize(t,t);const n=H.transformQuat([],[0,0,-1],t),r=H.transformQuat([],[0,-1,0],t);if(r[2]<0)return!1;const s=Qy(n,r);return!!s&&(this._camera.orientation=s,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,r=this.zoomScale(this.maxZoom)*this.tileSize,s=this.cameraToCenterDistance;t[2]=Gt(t[2],s/r,s/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,r){this._unmodified=!1,this._edgeInsets.interpolate(t,n,r),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new Z1(0,t)];if(this.renderWorldCopies){const r=this.pointCoordinate(new tt(0,0)),s=this.pointCoordinate(new tt(this.width,0)),l=this.pointCoordinate(new tt(this.width,this.height)),c=this.pointCoordinate(new tt(0,this.height)),h=Math.floor(Math.min(r.x,s.x,l.x,c.x)),f=Math.floor(Math.max(r.x,s.x,l.x,c.x)),p=1;for(let m=h-p;m<=f+p;m++)0!==m&&n.push(new Z1(m,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(t,n,r){let s=[];if(0===n[0]&&0===n[1])return s;for(const c of t){const h=c.canonical,f=c.overscaledZ,p=c.wrap,m=1<<h.z,_=h.x+1<m,y=h.x>0,v=h.y+1<m,b=h.y>0,E=c.wrap-(y?0:1),D=c.wrap+(_?0:1),T=y?h.x-1:m-1,C=_?h.x+1:0;n[0]<0?(s.push(new tn(f,D,h.z,C,h.y)),n[1]<0&&v&&(s.push(new tn(f,p,h.z,h.x,h.y+1)),s.push(new tn(f,D,h.z,C,h.y+1))),n[1]>0&&b&&(s.push(new tn(f,p,h.z,h.x,h.y-1)),s.push(new tn(f,D,h.z,C,h.y-1)))):n[0]>0?(s.push(new tn(f,E,h.z,T,h.y)),n[1]<0&&v&&(s.push(new tn(f,p,h.z,h.x,h.y+1)),s.push(new tn(f,E,h.z,T,h.y+1))),n[1]>0&&b&&(s.push(new tn(f,p,h.z,h.x,h.y-1)),s.push(new tn(f,E,h.z,T,h.y-1)))):n[1]<0&&v?s.push(new tn(f,p,h.z,h.x,h.y+1)):b&&s.push(new tn(f,p,h.z,h.x,h.y-1))}if(s.length>1){s.sort((f,p)=>f.overscaledZ-p.overscaledZ||f.wrap-p.wrap||f.canonical.z-p.canonical.z||f.canonical.x-p.canonical.x||f.canonical.y-p.canonical.y);let c=0,h=0;for(;h<s.length;)s[h].equals(s[c])?++h:s[++c]=s[h++];s.length=c+1}const l=[];for(const c of s)s.some(h=>c.isChildOf(h))||l.push(c);return s=l.filter(c=>!t.some(h=>!!(c.overscaledZ<r&&h.isChildOf(c))||c.equals(h)||c.isChildOf(h))),s}coveringTiles(t){let n=this.coveringZoomLevel(t);const r=n,s=this.elevation&&this.elevation.exaggeration(),l=s&&!t.isTerrainDEM,c="mercator"===this.projection.name;if(void 0!==t.minzoom&&n<t.minzoom)return[];void 0!==t.maxzoom&&n>t.maxzoom&&(n=t.maxzoom);const h=this.locationCoordinate(this.center),f=this.center.lat,p=1<<n,m=[p*h.x,p*h.y,0],_="globe"===this.projection.name,y=!_,v=is.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,y),b=_?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),E=p*gn(1,this.center.lat),D=this._camera.position[2]/gn(1,this.center.lat),T=[p*b.x,p*b.y,D*(y?1:E)],C=_||s,I=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),A=this.isLODDisabled(!0)?n:0,M=t.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,R=t.isTerrainDEM?-M:this._elevation?this._elevation.getMinElevationBelowMSL():0,L=this.projection.isReprojectedInTileSpace?kw(this):1,O=W=>{const nt=new He(W.x+25e-6,W.y,W.z),ot=new He(W.x,W.y+25e-6,W.z),lt=W.toLngLat(),ht=nt.toLngLat(),ft=ot.toLngLat(),at=this.locationCoordinate(lt),ut=this.locationCoordinate(ht),Et=this.locationCoordinate(ft),Ot=Math.hypot(ut.x-at.x,ut.y-at.y),kt=Math.hypot(Et.x-at.x,Et.y-at.y);return Math.sqrt(Ot*kt)*L/25e-6},z=W=>{const X=M,nt=R;return{aabb:hm(this,p,0,0,0,W,nt,X,this.projection),zoom:0,x:0,y:0,minZ:nt,maxZ:X,wrap:W,fullyVisible:!1}},N=[];let V=[];const B=n,$=t.reparseOverscaled?r:n,j=W=>W*W,Z=j((D-this._centerAltitude)*E),K=W=>{if(!this._elevation||!W.tileID||!c)return;const X=this._elevation.getMinMaxForTile(W.tileID),nt=W.aabb;X?(nt.min[2]=X.min,nt.max[2]=X.max,nt.center[2]=(nt.min[2]+nt.max[2])/2):(W.shouldSplit=Q(W),W.shouldSplit||(nt.min[2]=nt.max[2]=nt.center[2]=this._centerAltitude))},Q=W=>{if(W.zoom<A)return!0;if(W.zoom===B)return!1;if(null!=W.shouldSplit)return W.shouldSplit;const X=W.aabb.distanceX(T),nt=W.aabb.distanceY(T);let ot=Z,lt=1;if(_){ot=j(W.aabb.distanceZ(T));const at=Math.pow(2,W.zoom),ut=dr((W.y+1)/at),Et=dr(W.y/at),Ot=Math.min(Math.max(f,ut),Et),kt=cd(Ot)/cd(f);if(lt=Ot===f?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,kt/this._mercatorScaleRatio),this.zoom<=5&&W.zoom===B-1&&kt>=.9)return!0}else if(l&&(ot=j(W.aabb.distanceZ(T)*E)),this.projection.isReprojectedInTileSpace&&r<=5){const at=Math.pow(2,W.zoom),ut=O(new He((W.x+.5)/at,(W.y+.5)/at));lt=ut>.85?1:ut}const ht=X*X+nt*nt+ot;return ht<j((1<<B-W.zoom)*I*lt*((at,ut)=>{if(ut*j(.707)<at)return 1;const Et=Math.sqrt(ut/at);return Et/(1.4144271570014144+(Math.pow(1.1,Et-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(ot,Z),ht))};if(this.renderWorldCopies)for(let W=1;W<=3;W++)N.push(z(-W)),N.push(z(W));for(N.push(z(0));N.length>0;){const W=N.pop(),X=W.x,nt=W.y;let ot=W.fullyVisible;const lt=()=>"globe"===this.projection.name&&(0===W.y||W.y===(1<<W.zoom)-1);if(!ot){let ht=C?W.aabb.intersects(v):W.aabb.intersectsFlat(v);if(0===ht&&lt()){const ft=new Oo(W.zoom,X,nt);ht=U_(this,p,ft,!0).intersects(v)}if(0===ht)continue;ot=2===ht}if(W.zoom!==B&&Q(W))for(let ht=0;ht<4;ht++){const ft=(X<<1)+ht%2,at=(nt<<1)+(ht>>1),ut={aabb:c?W.aabb.quadrant(ht):hm(this,p,W.zoom+1,ft,at,W.wrap,W.minZ,W.maxZ,this.projection),zoom:W.zoom+1,x:ft,y:at,wrap:W.wrap,fullyVisible:ot,tileID:void 0,shouldSplit:void 0,minZ:W.minZ,maxZ:W.maxZ};l&&!_&&(ut.tileID=new tn(W.zoom+1===B?$:W.zoom+1,W.wrap,W.zoom+1,ft,at),K(ut)),N.push(ut)}else{const ht=W.zoom===B?$:W.zoom;if(t.minzoom&&t.minzoom>ht)continue;if(!ot){let Et=C?W.aabb.intersectsPrecise(v):W.aabb.intersectsPreciseFlat(v);if(0===Et&&lt()){const Ot=new Oo(W.zoom,X,nt);Et=U_(this,p,Ot,!0).intersectsPrecise(v)}if(0===Et)continue}const ft=m[0]-(.5+X+(W.wrap<<W.zoom))*(1<<n-W.zoom),at=m[1]-.5-nt,ut=W.tileID?W.tileID:new tn(ht,W.wrap,W.zoom,X,nt);V.push({tileID:ut,distanceSq:ft*ft+at*at})}}if(this.fogCullDistSq){const W=this.fogCullDistSq,X=this.horizonLineFromTop();V=V.filter(nt=>{const ot=[0,0,0,1],lt=[st,st,0,1],ht=this.calculateFogTileMatrix(nt.tileID.toUnwrapped());an.transformMat4(ot,ot,ht),an.transformMat4(lt,lt,ht);const ft=function(Et,Ot,kt){let zt=0;for(let Zt=0;Zt<2;++Zt)Et[Zt]>0&&(zt+=(Et[Zt]-0)*(Et[Zt]-0)),Ot[Zt]<0&&(zt+=(0-Ot[Zt])*(0-Ot[Zt]));return zt}(an.min([],ot,lt),an.max([],ot,lt));if(0===ft)return!0;let at=!1;const ut=this._elevation;if(ut&&ft>W&&0!==X){const Et=this.calculateProjMatrix(nt.tileID.toUnwrapped());let Ot;t.isTerrainDEM||(Ot=ut.getMinMaxForTile(nt.tileID)),Ot||(Ot={min:R,max:M});const kt=function(Zt){const oe=Math.round((Zt+45+360)%360/90)%4;return yg[oe]}(this.rotation),zt=[kt[0]*st,kt[1]*st,Ot.max];H.transformMat4(zt,zt,Et),at=(1-zt[1])*this.height*.5<X}return ft<W||at})}return V.sort((W,X)=>W.distanceSq-X.distanceSq).map(W=>W.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=Gt(t.lat,-nr,nr),r=this.projection.project(t.lng,n);return new tt(r.x*this.worldSize,r.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/gn(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let r,s;const l=this.centerPoint;if("globe"===this.projection.name){const h=this.worldSize;r=(n.x-l.x)/h,s=(n.y-l.y)/h}else{const h=this.pointCoordinate(n),f=this.pointCoordinate(l);r=h.x-f.x,s=h.y-f.y}const c=this.locationCoordinate(t);this.setLocation(new He(c.x-r,c.y-s))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this.projection.locationPoint(this,t,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(t,n){const r=n?gn(n,t.lat):void 0,s=this.projection.project(t.lng,t.lat);return new He(s.x,s.y,r)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const r=n??this._centerAltitude,s=[t.x,t.y,0,1],l=[t.x,t.y,1,1];an.transformMat4(s,s,this.pixelMatrixInverse),an.transformMat4(l,l,this.pixelMatrixInverse);const c=l[3];an.scale(s,s,1/s[3]),an.scale(l,l,1/c);const h=s[2],f=l[2];return{p0:s,p1:l,t:h===f?0:(r-h)/(f-h)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],r=[t.x,t.y,1,1];return an.transformMat4(n,n,this.pixelMatrixInverse),an.transformMat4(r,r,this.pixelMatrixInverse),an.scale(n,n,1/n[3]),an.scale(r,r,1/r[3]),n[2]=gn(n[2],this._center.lat)*this.worldSize,r[2]=gn(r[2],this._center.lat)*this.worldSize,an.scale(n,n,1/this.worldSize),an.scale(r,r,1/this.worldSize),new id([n[0],n[1],n[2]],H.normalize([],H.sub([],r,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:r,t:s}=t,l=gn(n[2],this._center.lat),c=gn(r[2],this._center.lat);return new He(de(n[0],r[0],s)/this.worldSize,de(n[1],r[1],s)/this.worldSize,de(l,c,s))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t){if(!this.elevation)return this.pointCoordinate(t);let n=this.projection.pointCoordinate3D(this,t.x,t.y);if(n)return new He(n[0],n[1],n[2]);let r=0,s=this.horizonLineFromTop();if(t.y>s)return this.pointCoordinate(t);const l=.02*s,c=t.clone();for(let h=0;h<10&&s-r>l;h++){c.y=de(r,s,.66);const f=this.projection.pointCoordinate3D(this,c.x,c.y);f?(s=c.y,n=f):r=c.y}return n?new He(n[0],n[1],n[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=6)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const r=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,s=[t.x*this.worldSize,t.y*this.worldSize,r+t.toAltitude(),1];return an.transformMat4(s,s,this.pixelMatrix),s[3]>0?new tt(s[0]/s[3],s[1]/s[3]):new tt(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,r=this.height-this._edgeInsets.bottom,s=this.width-this._edgeInsets.right,l=this.pointLocation3D(new tt(n,t)),c=this.pointLocation3D(new tt(s,t)),h=this.pointLocation3D(new tt(s,r)),f=this.pointLocation3D(new tt(n,r));let p=Math.min(l.lng,c.lng,h.lng,f.lng),m=Math.max(l.lng,c.lng,h.lng,f.lng),_=Math.min(l.lat,c.lat,h.lat,f.lat),y=Math.max(l.lat,c.lat,h.lat,f.lat);const v=Math.pow(2,-this.zoom)/16*270,b="globe"===this.projection.name?1:4,E=(D,T,C,I,A)=>{const M=(D+C)/2,R=(T+I)/2,L=new tt(M,R),{lng:O,lat:z}=this.pointLocation3D(L),N=Math.max(0,p-O,_-z,O-m,z-y);p=Math.min(p,O),m=Math.max(m,O),_=Math.min(_,z),y=Math.max(y,z),(A<b||N>v)&&(E(D,T,M,R,A+1),E(M,R,C,I,A+1))};if(E(n,t,s,t,1),E(s,t,s,r,1),E(s,r,n,r,1),E(n,r,n,t,1),"globe"===this.projection.name){const[D,T]=function(C){const I=et.identity(new Float64Array(16));et.multiply(I,C.pixelMatrix,C.globeMatrix);const A=[0,pi,0],M=[0,zo,0];return H.transformMat4(A,A,I),H.transformMat4(M,M,I),[A[0]>0&&A[0]<=C.width&&A[1]>0&&A[1]<=C.height&&!Fp(C,new ce(C.center.lat,90)),M[0]>0&&M[0]<=C.width&&M[1]>0&&M[1]<=C.height&&!Fp(C,new ce(C.center.lat,-90))]}(this);D?(y=90,m=180,p=-180):T&&(_=-90,m=180,p=-180)}return new fi(new ce(p,_),new ce(m,y))}_getBoundsRectangular(t,n){const{top:r,left:s}=this._edgeInsets,l=this.height-this._edgeInsets.bottom,c=this.width-this._edgeInsets.right,h=new tt(s,r),f=new tt(c,r),p=new tt(c,l),m=new tt(s,l);let _=this.pointCoordinate(h,t),y=this.pointCoordinate(f,t);const v=this.pointCoordinate(p,n),b=this.pointCoordinate(m,n),E=(D,T)=>(T.y-D.y)/(T.x-D.x);return _.y>1&&y.y>=0?_=new He((1-b.y)/E(b,_)+b.x,1):_.y<0&&y.y<=1&&(_=new He(-b.y/E(b,_)+b.x,0)),y.y>1&&_.y>=0?y=new He((1-v.y)/E(v,y)+v.x,1):y.y<0&&_.y<=1&&(y=new He(-v.y/E(v,y)+v.x,0)),(new fi).extend(this.coordinateLocation(_)).extend(this.coordinateLocation(y)).extend(this.coordinateLocation(b)).extend(this.coordinateLocation(v))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce((r,s)=>{if(s.dem){const l=s.dem.tree;r.min=Math.min(r.min,l.minimums[0]),r.max=Math.max(r.max,l.maximums[0])}return r},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,r=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,r):r}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-nr,this.maxLat=nr,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=Xr(this.minLng)*this.tileSize,this.worldMaxX=Xr(this.maxLng)*this.tileSize,this.worldMinY=Ur(this.maxLat)*this.tileSize,this.worldMaxY=Ur(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,r=this._distanceTileDataCache;if(r[n])return r[n];const s=t.canonical,l=1/this.height,c=this.cameraWorldSize,h=c/this.zoomScale(s.z),f=(s.x+Math.pow(2,s.z)*t.wrap)*h,p=s.y*h,m=this.point;m.x*=c/this.worldSize,m.y*=c/this.worldSize;const _=this.angle,y=Math.sin(-_),v=-Math.cos(-_);return r[n]={bearing:[y,v],center:[(m.x-f)*l,(m.y-p)*l],scale:h/st*l},r[n]}calculateFogTileMatrix(t){const n=t.key,r=this._fogTileMatrixCache;if(r[n])return r[n];const s=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return et.multiply(s,this.worldToFogMatrix,s),r[n]=new Float32Array(s),r[n]}calculateProjMatrix(t,n=!1){const r=t.key,s=n?this._alignedProjMatrixCache:this._projMatrixCache;if(s[r])return s[r];const l=this.calculatePosMatrix(t,this.worldSize);return et.multiply(l,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:n?this.alignedProjMatrix:this.projMatrix,l),s[r]=new Float32Array(l),s[r]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,r=this._pixelsToTileUnitsCache;if(r[n])return r[n];const s=function(l,c){const{scale:h}=l.tileTransform,f=h*st/(l.tileSize*Math.pow(2,c.zoom-l.tileID.overscaledZ+l.tileID.canonical.z));return Su.scale(new Float32Array(4),c.inverseAdjustmentMatrix,[f,f])}(t,this);return r[n]=s,r[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const t=1/this.worldSize,n=et.fromScaling([],[t,t,t]);return et.multiply(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const t=this._elevation;this._updateCameraState();const n=gn(1,this._center.lat)*this.worldSize,r=this._computeCameraPosition(n),s=this._camera.forward(),l=gn(1,this._center.lat);r[2]/=l,s[2]/=l,H.normalize(s,s);const c=t.raycast(r,s,t.exaggeration());if(c){const h=H.scaleAndAdd([],r,s,c),f=new He(h[0],h[1],gn(h[2],dr(h[1]))),p=(f.z+H.length([f.x-r[0],f.y-r[1],f.z-r[2]*l]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(p),this._centerAltitude=f.toAltitude(),this._center=this.coordinateLocation(f),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,r=gn(1,this._center.lat)*this.worldSize,s=this._computeCameraPosition(r),l=n.getAtPointOrZero(new He(...s)),c=this.pixelsPerMeter/this.worldSize*l,h=this._minimumHeightOverTerrain(),f=s[2]-c;if(f<=h)if(f<0||t){const p=this.locationCoordinate(this._center,this._centerAltitude),m=[s[0],s[1],p.z-s[2]],_=H.length(m);m[2]-=(h-f)/this._pixelsPerMercatorPixel;const y=H.length(m);if(0===y)return;H.scale(m,m,_/y*this._pixelsPerMercatorPixel),this._camera.position=[s[0],s[1],p.z*this._pixelsPerMercatorPixel-m[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const y=this.center;return y.lat=Gt(y.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(y.lng=Gt(y.lng,this.minLng,this.maxLng)),this.center=y,void(this._constraining=!1)}const n=this._unmodified,{x:r,y:s}=this.point;let l=0,c=r,h=s;const f=this.width/2,p=this.height/2,m=this.worldMinY*this.scale,_=this.worldMaxY*this.scale;if(s-p<m&&(h=m+p),s+p>_&&(h=_-p),_-m<this.height&&(l=Math.max(l,this.height/(_-m)),h=(_+m)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const y=this.worldMinX*this.scale,v=this.worldMaxX*this.scale,b=this.worldSize/2-(y+v)/2;c=(r+b+this.worldSize)%this.worldSize-b,c-f<y&&(c=y+f),c+f>v&&(c=v-f),v-y<this.width&&(l=Math.max(l,this.width/(v-y)),c=(v+y)/2)}c===r&&h===s||(this.center=this.unproject(new tt(c,h))),l&&(this.zoom+=this.scaleZoom(l)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n="globe"===this.projection.name,r=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=gn(1,this.center.lat)/gn(1,45));const s=Fd(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,s),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const l="meters"===this.projection.zAxisUnit?r:1,c=this._camera.getWorldToCamera(this.worldSize,l);let h;const f=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(f[8]=2*-t.x/this.width,f[9]=2*t.y/this.height,this.isOrthographic){let z=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),N=z*this.aspect,V=-N,B=-z;N-=t.x,V-=t.x,z+=t.y,B+=t.y,h=this._camera.getCameraToClipOrthographic(V,N,B,z,this._nearZ,this._farZ),(($,j,Z,K)=>{for(let Q=0;Q<16;Q++)$[Q]=zd(j[Q],Z[Q],K)})(h,h,f,l0(this.pitch>=15?1:this.pitch/15))}else h=f;const p=et.mul([],f,c);let m=et.mul([],h,c);if(this.projection.isReprojectedInTileSpace){const z=this.locationCoordinate(this.center),N=et.identity([]);et.translate(N,N,[z.x*this.worldSize,z.y*this.worldSize,0]),et.multiply(N,N,ee(this)),et.translate(N,N,[-z.x*this.worldSize,-z.y*this.worldSize,0]),et.multiply(m,m,N),et.multiply(p,p,N),this.inverseAdjustmentMatrix=function(V){const B=ee(V,!0);return Su.invert([],[B[0],B[1],B[4],B[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=et.scale([],m,[this.worldSize,this.worldSize,this.worldSize/l,1]),this.projMatrix=m,this.invProjMatrix=et.invert(new Float64Array(16),this.projMatrix);const _=et.invert([],h);this.frustumCorners=ba.fromInvProjectionMatrix(_,this.horizonLineFromTop(),this.height),this.cameraFrustum=is.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const y=new Float32Array(16);et.identity(y),et.scale(y,y,[1,-1,1]),et.rotateX(y,y,this._pitch),et.rotateZ(y,y,this.angle);const v=et.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=et.clone(v);const b=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;v[8]=2*-t.x/this.width,v[9]=2*(t.y+b)/this.height,this.skyboxMatrix=et.multiply(y,v,y);const E=this.point,D=E.x,T=E.y,C=this.width%2/2,I=this.height%2/2,A=Math.cos(this.angle),M=Math.sin(this.angle),R=D-Math.round(D)+A*C+M*I,L=T-Math.round(T)+A*I+M*C,O=new Float64Array(m);if(et.translate(O,O,[R>.5?R-1:R,L>.5?L-1:L,0]),this.alignedProjMatrix=O,m=et.create(),et.scale(m,m,[this.width/2,-this.height/2,1]),et.translate(m,m,[1,-1,0]),this.labelPlaneMatrix=m,m=et.create(),et.scale(m,m,[1,-1,1]),et.translate(m,m,[-1,-1,0]),et.scale(m,m,[2/this.width,2/this.height,1]),this.glCoordMatrix=m,this.pixelMatrix=et.multiply(new Float64Array(16),this.labelPlaneMatrix,p),this._calcFogMatrices(),this._distanceTileDataCache={},m=et.invert(new Float64Array(16),this.pixelMatrix),!m)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=m,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=function(N){const{x:V,y:B}=N.point,{lng:$,lat:j}=N._center;return K1(V,B,N.worldSize,$,j)}(this);const z=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=H.transformMat4(z,z,c),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=m;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,r=this._camera.position,s=1/this.height/this._pixelsPerMercatorPixel,l=[t,t,n];H.scale(l,l,s),H.scale(r,r,-1),H.multiply(r,r,l);const c=et.create();et.translate(c,c,r),et.scale(c,c,l),this.mercatorFogMatrix=c,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,s)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,r=this._camera.forward(),s=this.point,l=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[s.x/this.worldSize-r[0]*l,s.y/this.worldSize-r[1]*l,t/this.worldSize*this._centerAltitude-r[2]*l]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),r=this._camera.position[2],s=t[2];let l=1;this.projection.wrap&&(this.center=this.center.wrap()),s>0&&(l=Math.min((n-r)/s,1)),this._camera.position=H.scaleAndAdd([],this._camera.position,t,l),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:r,bearing:s}=this._camera.getPitchBearing(),l=gn(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,c=this._mercatorZfromZoom(this._maxZoom)*Math.cos(be(this._maxPitch)),h=Math.max((t[2]-l)/Math.cos(r),c),f=this._zoomFromMercatorZ(h);H.scaleAndAdd(t,t,n,h),this._pitch=Gt(r,be(this.minPitch),be(this.maxPitch)),this.angle=Ds(s,-Math.PI,Math.PI),this._setZoom(Gt(f,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new He(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min((null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,r=6,s=0,l=1/0;for(;r-n>1e-6&&r>n;){const c=n+.5*(r-n),h=this.tileSize*Math.pow(2,c),f=this.getCameraToCenterDistance(this.projection,c,h),p=this.scaleZoom(f/(t*this.tileSize)),m=Math.abs(c-p);m<l&&(l=m,s=c),c<p?n=c:r=c}return s}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(Y("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const r=Math.min(t.x,n.x),s=Math.max(t.x,n.x),l=Math.min(t.y,n.y),c=Math.max(t.y,n.y);if(l<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const h=[new tt(r,l),new tt(s,c),new tt(r,c),new tt(s,l)],f=this.renderWorldCopies?-3:0,p=this.renderWorldCopies?4:1;for(const m of h){const _=this.pointRayIntersection(m);if(_.t<0)return!0;const y=this.rayIntersectionCoordinate(_);if(y.x<f||y.y<0||y.x>p||y.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+xr(this.fovAboveCenter)>88||this.anyCornerOffEdge(new tt(0,0),new tt(this.width,this.height))}zoomDeltaToMovement(t,n){const r=H.length(H.sub([],this._camera.position,t)),s=this._zoomFromMercatorZ(r)+n;return r-this._mercatorZfromZoom(s)}getCameraPoint(){if("globe"===this.projection.name){const t=function([n,r,s],l){const c=[n,r,s,1];an.transformMat4(c,c,l);const h=c[3]=Math.max(c[3],1e-6);return c[0]/=h,c[1]/=h,c[2]/=h,c}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new tt(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new tt(0,t))}}getCameraToCenterDistance(t,n=this.zoom,r=this.worldSize){const s=Fd(t,n,this.width,this.height,1024),l=t.pixelSpaceConversion(this.center.lat,r,s);let c=.5/Math.tan(.5*this._fov)*this.height*l;return this.isOrthographic&&(c=zd(1,c,l0(this.pitch>=15?1:this.pitch/15))),c}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&et.multiply(t,t,this.globeMatrix),t}getFrustum(t){return is.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,"meters"===this.projection.zAxisUnit)}}function c0(e,t,n){et.identity(e),et.rotateZ(e,e,be(t[2])),et.rotateX(e,e,be(t[0])),et.rotateY(e,e,be(t[1])),et.scale(e,e,n),et.multiply(e,e,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function wm(e,t,n,r,s,l,c,h){const f=[n[0]-t[0],n[1]-t[1],0],p=[r[0]-t[0],r[1]-t[1],0];if(H.length(f)<1e-12||H.length(p)<1e-12)return Zr.identity(e);const m=H.cross([],f,p);H.normalize(m,m),H.subtract(p,r,t),f[2]=(l-s)*h,p[2]=(c-s)*h;const _=f;return H.cross(_,f,p),H.normalize(_,_),Zr.rotationTo(e,m,_)}function Qu(e,t,n=!1){const r=Mr(t.zoom),s=function(l,c,h){const f=c.worldSize,p=[l[12],l[13],l[14]],m=dr(p[1]/f),_=Vi(p[0]/f),y=et.identity([]),v=gn(1,m)*f,b=gn(1,0)*f*ni(m,c.zoom),E=1/W_(f);let D=b*E;if(h){const A=Fd(c.projection,c.zoom,c.width,c.height,1024);D=E*c.projection.pixelSpaceConversion(c.center.lat,f,A)}const T=Cr(m,_);H.add(T,T,H.scale([],H.normalize([],T),v*D*p[2]));const C=function(A){const M=[A[0],A[1],A[2]];let R=[0,1,0];const L=H.cross([],R,M);return H.cross(R,M,L),0===H.squaredLength(R)&&(R=[0,1,0],H.cross(L,M,R)),H.normalize(L,L),H.normalize(R,R),H.normalize(M,M),[L[0],L[1],L[2],0,R[0],R[1],R[2],0,M[0],M[1],M[2],0,A[0],A[1],A[2],1]}(T);et.scale(y,y,[D,D,D*v]),et.translate(y,y,[-p[0],-p[1],-p[2]]);const I=et.multiply([],c.globeMatrix,C);return et.multiply(I,I,y),et.multiply(I,I,l),I}(e,t,n);return r>0?function(c,h,f){const p=(b,E,D)=>{const T=H.length(b),C=H.length(E),I=Ea(b,E,D);return H.scale(I,I,1/H.length(I)*de(T,C,D))},m=p([c[0],c[1],c[2]],[h[0],h[1],h[2]],f),_=p([c[4],c[5],c[6]],[h[4],h[5],h[6]],f),y=p([c[8],c[9],c[10]],[h[8],h[9],h[10]],f),v=Ea([c[12],c[13],c[14]],[h[12],h[13],h[14]],f);return[m[0],m[1],m[2],0,_[0],_[1],_[2],0,y[0],y[1],y[2],0,v[0],v[1],v[2],1]}(s,function(c,h){const f=h.worldSize,p=gn(1,0)*f*ni(h.center.lat,h.zoom)/W_(f),m=gn(1,h.center.lat)*f,_=et.identity([]);return et.rotateY(_,_,be(h.center.lng)),et.rotateX(_,_,be(h.center.lat)),et.translate(_,_,[0,0,ei]),et.scale(_,_,[p,p,p*m]),et.translate(_,_,[h.point.x-.5*f,h.point.y-.5*f,0]),et.multiply(_,_,c),et.multiply(_,h.globeMatrix,_)}(e,t),r):s}const hC=[1,1,1];class Uw{constructor(t,n,r,s){this.id=t,this.position=null!=n?new ce(n[0],n[1]):new ce(0,0),this.orientation=r??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new Tn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,n){if(et.multiply(t.matrix,n,t.matrix),t.meshes)for(const r of t.meshes){const s=Tn.applyTransform(r.aabb,t.matrix);this.aabb.encapsulate(s)}if(t.children)for(const r of t.children)this._applyTransformations(r,t.matrix)}computeBoundsAndApplyParent(){const t=et.identity([]);for(const n of this.nodes)this._applyTransformations(n,t)}_positionModelOnTerrain(t,n){const r=t.elevation;if(!r)return 0;const s=Tn.projectAabbCorners(this.aabb,this.matrix),l=gn(1,this.position.lat)*t.worldSize,c=function(T,C){const I=[0,0,1],A=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const M of A){const R=T[M.corners[0]],L=T[M.corners[1]],O=T[M.corners[2]],z=[L[0]-R[0],L[1]-R[1],C*(L[2]-R[2])],N=H.cross(z,z,[O[0]-R[0],O[1]-R[1],C*(O[2]-R[2])]);H.normalize(N,N),M.dotProductWithUp=H.dot(N,I)}return A.sort((M,R)=>M.dotProductWithUp-R.dotProductWithUp),A[0].corners}(s,l),h=s[c[0]],f=s[c[1]],p=s[c[2]],m=s[c[3]],_=r.getAtPointOrZero(new He(h[0]/t.worldSize,h[1]/t.worldSize),0),y=r.getAtPointOrZero(new He(f[0]/t.worldSize,f[1]/t.worldSize),0),v=r.getAtPointOrZero(new He(p[0]/t.worldSize,p[1]/t.worldSize),0),b=r.getAtPointOrZero(new He(m[0]/t.worldSize,m[1]/t.worldSize),0),E=(_+b)/2,D=(y+v)/2;return E>D?y<v?wm(n,f,m,h,y,b,_,l):wm(n,p,h,m,v,_,b,l):_<b?wm(n,h,f,p,_,y,v,l):wm(n,m,p,f,b,v,y,l),Math.max(E,D)}computeModelMatrix(t,n,r,s,l,c,h=!1){const f=t.transform,p=f.zoom,m=f.project(this.position),_=ni(this.position.lat,p),y=1/_;et.identity(this.matrix),et.translate(this.matrix,this.matrix,[m.x+s[0]*y,m.y+s[1]*y,s[2]]);let v=1,b=1;const E=f.worldSize;if(h){if("mercator"===f.projection.name){let I=0;f.elevation&&(I=f.elevation.getAtPointOrZero(new He(m.x/E,m.y/E),0));const A=an.transformMat4([],[m.x,m.y,I,1],f.projMatrix)[3]/f.cameraToCenterDistance;v=A,b=A*ni(f.center.lat,p)}else if("globe"===f.projection.name){const I=Qu(this.matrix,f),A=et.multiply([],f.projMatrix,I),M=[0,0,0,1];an.transformMat4(M,M,A);const R=M[3]/f.cameraToCenterDistance,L=Mr(p),O=f.projection.pixelsPerMeter(this.position.lat,E)*ni(this.position.lat,p),z=f.projection.pixelsPerMeter(f.center.lat,E)*ni(f.center.lat,p);v=R/de(O,nb(f.center.lat),L),b=R*_/O,v*=z,b*=z}}else v=y;et.scale(this.matrix,this.matrix,[v,v,b]);const D=[...this.matrix],T=this.orientation,C=[];if(c0(C,[T[0]+n[0],T[1]+n[1],T[2]+n[2]],r),et.multiply(this.matrix,D,C),l&&f.elevation){let I=0;const A=[];if(c&&f.elevation){I=this._positionModelOnTerrain(f,A);const M=et.fromQuat([],A),R=et.multiply([],M,C);et.multiply(this.matrix,D,R)}else I=f.elevation.getAtPointOrZero(new He(m.x/E,m.y/E),0);0!==I&&(this.matrix[14]+=I)}}upload(t){if(!this.uploaded){for(const n of this.nodes)Em(n,t);for(const n of this.nodes)Bd(n);this.uploaded=!0}}destroy(){for(const t of this.nodes)Tm(t)}}function Nd(e,t,n=!1){e.uploaded||(e.gfxTexture=new pr(t,e.image,n?t.gl.R8:t.gl.RGBA,{useMipmap:e.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),e.uploaded=!0,e.image=null)}function $w(e,t,n){e.indexBuffer=t.createIndexBuffer(e.indexArray,!1,!0),e.vertexBuffer=t.createVertexBuffer(e.vertexArray,Iw.members,!1,!0),e.normalArray&&(e.normalBuffer=t.createVertexBuffer(e.normalArray,cC.members,!1,!0)),e.texcoordArray&&(e.texcoordBuffer=t.createVertexBuffer(e.texcoordArray,Tc.members,!1,!0)),e.colorArray&&(e.colorBuffer=t.createVertexBuffer(e.colorArray,(12===e.colorArray.bytesPerElement?Aw:Pw).members,!1,!0)),e.featureArray&&(e.pbrBuffer=t.createVertexBuffer(e.featureArray,Yu.members,!0)),e.segments=ln.simpleSegment(0,0,e.vertexArray.length,e.indexArray.length);const r=e.material;r.pbrMetallicRoughness.baseColorTexture&&Nd(r.pbrMetallicRoughness.baseColorTexture,t),r.pbrMetallicRoughness.metallicRoughnessTexture&&Nd(r.pbrMetallicRoughness.metallicRoughnessTexture,t),r.normalTexture&&Nd(r.normalTexture,t),r.occlusionTexture&&Nd(r.occlusionTexture,t,n),r.emissionTexture&&Nd(r.emissionTexture,t)}function Em(e,t,n){if(e.meshes)for(const r of e.meshes)$w(r,t,n);if(e.children)for(const r of e.children)Em(r,t,n)}function Bd(e){if(e.meshes)for(const t of e.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(e.children)for(const t of e.children)Bd(t)}function Tm(e){if(e.meshes)for(const n of e.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((t=n.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(e.children)for(const n of e.children)Tm(n)}class u0{constructor(t,n){this.feature=t,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Hw{constructor(){this.instancedDataArray=new cp,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Gw{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=t.projection,this.index=t.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(t,n,r,s){this.tileToMeter=Au(r);const l=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:c,id:h,index:f,sourceLayerIndex:p}of t){const m=xl(c,l);if(!this.layers[0]._featureFilter.filter(new Gn(this.zoom),m,r))continue;const _={id:h,sourceLayerIndex:p,index:f,geometry:l?m.geometry:ze(c,r,s),properties:c.properties,type:c.type,patterns:{}},y=this.addFeature(_,_.geometry,m);y&&n.featureIndex.insert(c,_.geometry,f,p,this.index,this.instancesPerModel[y].instancedDataArray.length)}this.lookup=null}update(t,n,r,s){for(const l in this.instancesPerModel){const c=this.instancesPerModel[l];for(const h in t)c.idToFeaturesIndex.hasOwnProperty(h)&&this.evaluate(c.features[c.idToFeaturesIndex[h]],t[h],c,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let t=!1;for(const n in this.instancesPerModel){const r=this.instancesPerModel[n];for(const s of r.features){const l=this.layers[0],c=s.feature,h=this.canonical,f=l.paint.get("model-rotation").evaluate(c,{},h),p=l.paint.get("model-scale").evaluate(c,{},h),m=l.paint.get("model-translation").evaluate(c,{},h);H.exactEquals(s.rotation,f)&&H.exactEquals(s.scale,p)&&H.exactEquals(s.translation,m)||(this.evaluate(s,s.featureStates,r,!0),t=!0)}}return t}isEmpty(){for(const t in this.instancesPerModel)if(0!==this.instancesPerModel[t].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(t){if(!this.uploaded)for(const n in this.instancesPerModel){const r=this.instancesPerModel[n];r.instancedDataArray.length<0||0===r.instancedDataArray.length||(r.instancedDataBuffer?r.instancedDataBuffer.updateData(r.instancedDataArray):r.instancedDataBuffer=t.createVertexBuffer(r.instancedDataArray,uC.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const t in this.instancesPerModel){const n=this.instancesPerModel[t];0!==n.instancedDataArray.length&&n.instancedDataBuffer&&n.instancedDataBuffer.destroy()}}addFeature(t,n,r){const s=this.layers[0],l=s.layout.get("model-id").evaluate(r,{},this.canonical);if(!l)return Y(`modelId is not evaluated for layer ${s.id} and it is not going to get rendered.`),l;this.instancesPerModel[l]||(this.instancesPerModel[l]=new Hw);const c=this.instancesPerModel[l],h=c.instancedDataArray,f=new u0(r,h.length);for(const p of n)for(const m of p){if(m.x<0||m.x>=st||m.y<0||m.y>=st)continue;const _=(this.lookupDim-1)/st,y=this.lookupDim*(m.y*_|0)+m.x*_|0;if(this.lookup){if(0!==this.lookup[y])continue;this.lookup[y]=1}this.instanceCount++;const v=h.length;h.resize(v+1),c.instancesEvaluatedElevation.push(0),h.float32[16*v]=m.x,h.float32[16*v+1]=m.y}return f.instancedDataCount=c.instancedDataArray.length-f.instancedDataOffset,f.instancedDataCount>0&&(t.id&&(c.idToFeaturesIndex[t.id]=c.features.length),c.features.push(f),this.evaluate(f,{},c,!1)),l}evaluate(t,n,r,s){const l=this.layers[0],c=t.feature,h=this.canonical,f=t.rotation=l.paint.get("model-rotation").evaluate(c,n,h),p=t.scale=l.paint.get("model-scale").evaluate(c,n,h),m=t.translation=l.paint.get("model-translation").evaluate(c,n,h),_=l.paint.get("model-color").evaluate(c,n,h);_.a=l.paint.get("model-color-mix-intensity").evaluate(c,n,h);const y=[];this.maxVerticalOffset<m[2]&&(this.maxVerticalOffset=m[2]),this.maxScale=Math.max(Math.max(this.maxScale,p[0]),Math.max(p[1],p[2])),c0(y,f,p);const v=Math.round(100*_.a)+_.b/1.05;for(let b=0;b<t.instancedDataCount;++b){const E=t.instancedDataOffset+b,D=16*E,T=r.instancedDataArray.float32;let C=0;s&&(C=T[D+6]-r.instancesEvaluatedElevation[E]);const I=0|T[D+1];T[D]=(0|T[D])+_.r/1.05,T[D+1]=I+_.g/1.05,T[D+2]=v,T[D+3]=1/(h.z>10?this.tileToMeter:Au(h,I)),T[D+4]=m[0],T[D+5]=m[1],T[D+6]=m[2]+C,T[D+7]=y[0],T[D+8]=y[1],T[D+9]=y[2],T[D+10]=y[4],T[D+11]=y[5],T[D+12]=y[6],T[D+13]=y[8],T[D+14]=y[9],T[D+15]=y[10],r.instancesEvaluatedElevation[E]=m[2]}}}jt(Gw,"ModelBucket",{omit:["layers"]}),jt(Hw,"PerModelAttributes"),jt(u0,"ModelFeature");const LA=new qn({visibility:new wt(rt.layout_model.visibility),"model-id":new Kt(rt.layout_model["model-id"])});var kA={paint:new qn({"model-opacity":new wt(rt.paint_model["model-opacity"]),"model-rotation":new Kt(rt.paint_model["model-rotation"]),"model-scale":new Kt(rt.paint_model["model-scale"]),"model-translation":new Kt(rt.paint_model["model-translation"]),"model-color":new Kt(rt.paint_model["model-color"]),"model-color-mix-intensity":new Kt(rt.paint_model["model-color-mix-intensity"]),"model-type":new wt(rt.paint_model["model-type"]),"model-cast-shadows":new wt(rt.paint_model["model-cast-shadows"]),"model-receive-shadows":new wt(rt.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new wt(rt.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Kt(rt.paint_model["model-emissive-strength"]),"model-roughness":new Kt(rt.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Kt(rt.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new wt(rt.paint_model["model-cutoff-fade-range"])}),layout:LA};const qw=new Float32Array(262144),th=new Uint8Array(262144);function h0(e){let t=0;if(e.meshes)for(const n of e.meshes)t=Math.max(t,n.aabb.max[2]);if(e.children)for(const n of e.children)t=Math.max(t,h0(n));return t}const jd=["","wall","door","roof","window","lamp","logo"];class Ww{constructor(t){this.node=t,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:t.id,geometry:[],properties:{height:h0(t)}}}}class Zw{constructor(t,n,r,s){this.nodes=t,this.id=n,this.modelTraits|=1,this.uploaded=!1,this.hasPattern=!1,r&&(this.modelTraits|=4),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=s,this.dirty=!0,this.needsUpload=!1}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(t){if(!this.needsUpload)return;const n=this.getNodesInfo();for(const r of n){const s=r.node;this.uploaded?this.updatePbrBuffer(s):Em(s,t,!0)}for(const r of n)Bd(r.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(t){let n=!1;if(!t.meshes)return n;for(const r of t.meshes)r.pbrBuffer&&(r.pbrBuffer.updateData(r.featureArray),n=!0);return n}needsReEvaluation(t,n,r){const s=t.transform.projectionOptions,l=t.style.getBrightness(),c=this.brightness!==l;return!!(!this.uploaded||this.dirty||s.name!==this.projection.name||eh(r.paint.get("model-color").value,c)||eh(r.paint.get("model-color-mix-intensity").value,c)||eh(r.paint.get("model-roughness").value,c)||eh(r.paint.get("model-emissive-strength").value,c)||eh(r.paint.get("model-height-based-emissive-strength-multiplier").value,c))&&(this.projection=s,this.brightness=l,!0)}evaluateScale(t,n){if(t.transform.zoom===this.zoom)return;this.zoom=t.transform.zoom;const r=this.getNodesInfo(),s=this.id.canonical;for(const l of r){const c=l.feature;l.evaluatedScale=n.paint.get("model-scale").evaluate(c,{},s)}}evaluate(t){const n=this.getNodesInfo();for(const r of n){if(!r.node.meshes)continue;const s=r.feature,l=r.node.meshes&&r.node.meshes[0].featureData,c=r.evaluatedColor[2],h=r.evaluatedRMEA[2],f=this.id.canonical;if(r.hasTranslucentParts=!1,l){for(let p=0;p<jd.length;p++){const m=jd[p];m.length&&(s.properties.part=m);const _=t.paint.get("model-color").evaluate(s,{},f),y=t.paint.get("model-color-mix-intensity").evaluate(s,{},f);r.evaluatedColor[p]=[_.r,_.g,_.b,y],r.evaluatedRMEA[p][0]=t.paint.get("model-roughness").evaluate(s,{},f),r.evaluatedRMEA[p][2]=t.paint.get("model-emissive-strength").evaluate(s,{},f),r.evaluatedRMEA[p][3]=_.a,r.emissionHeightBasedParams[p]=t.paint.get("model-height-based-emissive-strength-multiplier").evaluate(s,{},f),!r.hasTranslucentParts&&_.a<1&&(r.hasTranslucentParts=!0)}delete s.properties.part,dC(r,c!==r.evaluatedColor[2]||h!==r.evaluatedRMEA[2])}r.evaluatedScale=t.paint.get("model-scale").evaluate(s,{},f),this.updatePbrBuffer(r.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(t,n,r,s){const l=t.findDEMTileFor(r);if(l&&(l.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(l.dem&&l.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=l.tileID.overscaledZ;const c=Sl.create(t,r,l);if(!c)return;4&this.modelTraits&&this.updateDEM(t,c,r,s);for(const h of this.getNodesInfo()){const f=h.node;if(!f.footprint||!f.footprint.vertices||!f.footprint.vertices.length)continue;const p=f.footprint.vertices;let m=c.getElevationAt(p[0].x,p[0].y,!0,!0);for(let _=1;_<p.length;_++)m=Math.min(m,c.getElevationAt(p[_].x,p[_].y,!0,!0));f.elevation=m}}this.terrainTile=l.tileID.canonical,this.terrainExaggeration=n}}updateDEM(t,n,r,s){let l=n._dem._modifiedForSources[s];if(void 0===l&&(n._dem._modifiedForSources[s]=[],l=n._dem._modifiedForSources[s]),l.includes(r.canonical))return;const c=n._dem.dim;l.push(r.canonical);let h=!1;for(const f of this.getNodesInfo()){const p=f.node;if(!p.footprint||!p.footprint.grid)continue;const m=p.footprint.grid,_=n.tileCoordToPixel(m.min.x,m.min.y),y=n.tileCoordToPixel(m.max.x,m.max.y),v=Math.min(Math.min(c-y.y,_.x),Math.min(_.y,c-y.x));if(v<0)continue;const b=Gt(v,2,5);let E=Math.max(0,_.x-b),D=Math.max(0,_.y-b),T=Math.min(y.x+b,c-1),C=Math.min(y.y+b,c-1);for(let R=D;R<=C;++R)for(let L=E;L<=T;++L)th[R*c+L]=255;let I=0,A=0;for(let R=0;R<m.cellsY;++R)for(let L=0;L<m.cellsX;++L){if(!m.cells[R*m.cellsX+L])continue;const O=n.tileCoordToPixel(m.min.x+L/m.xScale,m.min.y+R/m.yScale),z=n.tileCoordToPixel(m.min.x+(L+1)/m.xScale,m.min.y+(R+1)/m.yScale);for(let N=O.y;N<=Math.min(z.y+1,c-1);++N)for(let V=O.x;V<=Math.min(z.x+1,c-1);++V)255===th[N*c+V]&&(th[N*c+V]=0,I+=n.getElevationAtPixel(V,N),A++)}const M=I/A;E=Math.max(1,_.x-b),D=Math.max(1,_.y-b),T=Math.min(y.x+b,c-2),C=Math.min(y.y+b,c-2),h=!0;for(let R=D;R<=C;++R)for(let L=E;L<=T;++L)0===th[R*c+L]&&(qw[R*c+L]=n._dem.set(L,R,M));for(let R=1;R<b;++R){E=Math.max(1,_.x-R),D=Math.max(1,_.y-R),T=Math.min(y.x+R,c-2),C=Math.min(y.y+R,c-2);for(let L=D;L<=C;++L)for(let O=E;O<=T;++O){const z=L*c+O;if(255===th[z]){let N=0,V=0,B=-1,$=-1;for(let j=-1;j<=1;++j)for(let Z=-1;Z<=1;++Z){const K=(L+j)*c+O+Z;if(th[K]>=R)continue;const Q=qw[K],W=Math.abs(Q);W>V&&(N=Q,V=W,B=Z,$=j)}if(V>.1){const j=1-(R+.5*Math.abs(B*$))/b;let Z=n._dem.get(O,L)+N*j;const K=n._dem.get(O+B,L+$),Q=n._dem.get(O-B,L-$,!0);(Z-K)*(Z-Q)>0&&(Z=(K+Q)/2),qw[z]=n._dem.set(O,L,Z),th[z]=R}}}}}h&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=me.now())}getNodesInfo(){if(!this.nodesInfo){this.nodesInfo=[];for(const t of this.nodes)this.nodesInfo.push(new Ww(t));this.freeNodes()}return this.nodesInfo}freeNodes(){if(this.nodes){for(const t of this.nodes)Tm(t);this.nodes.splice(0,this.nodes.length)}}destroy(){this.freeNodes();const t=this.getNodesInfo();for(const n of t)Bd(n.node),Tm(n.node)}isEmpty(){return!this.nodes.length}updateReplacement(t,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;const r=n.getReplacementRegionsForTile(t.toUnwrapped()),s=this.getNodesInfo();for(let l=0;l<this.nodesInfo.length;l++){const c=s[l].node;s[l].hiddenByReplacement=!!c.footprint&&!r.find(h=>h.footprint===c.footprint)}}getHeightAtTileCoord(t,n){const r=this.getNodesInfo(),s=[];for(let l=0;l<this.nodesInfo.length;l++){const c=r[l],h=c.node.meshes[0];if(t<h.aabb.min[0]||n<h.aabb.min[1]||t>h.aabb.max[0]||n>h.aabb.max[1])continue;const f=(t-h.aabb.min[0])/(h.aabb.max[0]-h.aabb.min[0])*64|0,p=64*Math.min(63,(n-h.aabb.min[1])/(h.aabb.max[1]-h.aabb.min[1])*64|0)+Math.min(63,f);if(!(h.heightmap[p]<0&&c.node.footprint))return c.hiddenByReplacement?void 0:{height:h.heightmap[p],maxHeight:c.feature.properties.height,hidden:!1,verticalScale:c.evaluatedScale[2]};if(c.node.footprint.grid.query(new tt(t,n),new tt(t,n),s),s.length>0)return{height:void 0,maxHeight:c.feature.properties.height,hidden:c.hiddenByReplacement,verticalScale:c.evaluatedScale[2]}}}}function eh(e,t){return!e.isLightConstant&&t}function Vd(e,t,n,r,s,l,c,h){let f=(61440&t|(61440&t)>>4)>>8,p=(3840&t|(3840&t)>>4)>>4,m=240&t|(240&t)>>4;n[3]>0&&(f=de(f,255*n[0],n[3]),p=de(p,255*n[1],n[3]),m=de(m,255*n[2],n[3]));const _=f<<8|p,y=m<<8|Math.floor(255*r[3]),v=function(R){const L=Gt(R,0,2);return Math.min(Math.round(.5*L*255),255)}(r[2])<<8|15*r[0]<<4|15*r[1],b=Gt(s[0],0,1),E=Gt(s[1],0,1),D=Gt(s[2],0,1),T=Gt(s[3],0,1);let C,I,A,M;if(b!==E&&c!==l&&E!==b){const R=c-l;I=1/(R*(E-b)),A=-(l+R*b)/(R*(E-b));const L=Gt(s[4],-1,1);M=Math.pow(10,L),C=255*D<<8|255*T}else C=65535,I=0,A=1,M=1;if(e.emplaceBack(_,y,v,C,I,A,M),h){const R=h.length;h.clear();for(let L=0;L<R;L++)h.emplaceBack(_,y,v,C,I,A,M)}}function dC(e,t){const n=e.node;let r=0;for(const s of n.meshes){if(n.lights&&n.lightMeshIndex===r||!s.featureData)continue;s.featureArray=new dl,s.featureArray.reserve(s.featureData.length);let l=t;for(const c of s.featureData){let h;const f=65535&c,p=(15&f)<8?15&f:0,m=c>>16&65535,_=e.evaluatedRMEA[p],y=e.evaluatedColor[p],v=e.emissionHeightBasedParams[p];if(l&&2===p&&n.lights&&(h=new dl,h.resize(10*n.lights.length)),Vd(s.featureArray,m,y,_,v,s.aabb.min[2],s.aabb.max[2],h),h&&l){l=!1;const b=n.meshes[n.lightMeshIndex];b.featureArray=h,b.featureArray._trim()}}s.featureArray._trim(),r++}}jt(Zw,"Tiled3dModelBucket",{omit:["layers"]}),jt(Ww,"Tiled3dModelFeature");class fC{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(t){const n=d0(new tt(0,0),new tt(st,st),t),r=[];for(const s of this._activeRegions){if(s.hiddenByOverlap||!Yw(n,s))continue;const l=pC(s.min,s.max,t);r.push({min:l.min,max:l.max,sourceId:this._sourceIds[s.priority],footprint:s.footprint,footprintTileId:s.tileId})}return r}setSources(t){this._setSources(t.map(n=>({getSourceId:()=>n.cache.id,getFootprints:()=>{const r=[];for(const s of n.cache.getVisibleCoordinates()){const l=n.cache.getTile(s).buckets[n.layer];if(l)for(const c of l.getNodesInfo()){const h=c.node;h.footprint&&r.push({footprint:h.footprint,id:s.toUnwrapped()})}}return r}})))}_addSource(t){const n=t.getFootprints();if(0!==n.length){for(const r of n){if(!r.footprint)continue;const s=d0(r.footprint.min,r.footprint.max,r.id);this._activeRegions.push({min:s.min,max:s.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:r.id,footprint:r.footprint})}this._sourceIds.push(t.getSourceId())}}_computeReplacement(){this._activeRegions.sort((n,r)=>n.priority-r.priority||Dm(n.min,r.min)||Dm(n.max,r.max));let t=this._activeRegions.length!==this._prevRegions.length;if(!t){let n=0,r=0;for(;!t&&n!==this._activeRegions.length;){const s=this._activeRegions[n],l=this._prevRegions[r];t=s.priority!==l.priority||!Xw(s,l),++n,++r}}if(t){++this._updateTime;const n=r=>{const s=this._activeRegions;if(r>=s.length)return r;const l=s[r].priority;for(;r<s.length&&s[r].priority===l;)++r;return r};if(this._sourceIds.length>1){let r=0,s=n(r);for(;r!==s;){let l=r;const c=r;for(;l!==s;){const h=this._activeRegions[l];h.hiddenByOverlap=!1;for(let f=0;f<c;f++){const p=this._activeRegions[f];if(!p.hiddenByOverlap&&Yw(h,p)&&(h.hiddenByOverlap=nh(h.footprint,h.tileId,p.footprint,p.tileId),h.hiddenByOverlap))break}++l}r=s,s=n(r)}}}}_setSources(t){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let n=t.length-1;n>=0;n--)this._addSource(t[n]);this._computeReplacement()}}function Dm(e,t){return e.x-t.x||e.y-t.y}function Xw(e,t){return 0===Dm(e.min,t.min)&&0===Dm(e.max,t.max)}function Yw(e,t){return!(e.min.x>t.max.x||e.max.x<t.min.x||e.min.y>t.max.y||e.max.y<t.min.y)}function d0(e,t,n){const r=1/st,s=1/(1<<n.canonical.z),l=(t.x*r+n.canonical.x)*s+n.wrap,c=(t.y*r+n.canonical.y)*s;return{min:new tt((e.x*r+n.canonical.x)*s+n.wrap,(e.y*r+n.canonical.y)*s),max:new tt(l,c)}}function pC(e,t,n){const r=1<<n.canonical.z,s=((t.x-n.wrap)*r-n.canonical.x)*st,l=(t.y*r-n.canonical.y)*st;return{min:new tt(((e.x-n.wrap)*r-n.canonical.x)*st,(e.y*r-n.canonical.y)*st),max:new tt(s,l)}}function Kw(e,t,n,r,s,l,c){const h=e.indices,f=e.vertices,p=[];for(let m=r;m<r+s;m+=3){const _=t[n[m+0]+l],y=t[n[m+1]+l],v=t[n[m+2]+l],b=Math.min(_.x,y.x,v.x),E=Math.max(_.x,y.x,v.x),D=Math.min(_.y,y.y,v.y),T=Math.max(_.y,y.y,v.y);p.length=0,e.grid.query(new tt(b,D),new tt(E,T),p);for(let C=0;C<p.length;C++){const I=p[C];if(oy(f[h[3*I+0]],f[h[3*I+1]],f[h[3*I+2]],_,y,v,c))return!0}}return!1}function nh(e,t,n,r){if(!e||!n)return!1;let s=e.vertices;if(!t.canonical.equals(r.canonical)||t.wrap!==r.wrap){if(n.vertices.length<e.vertices.length)return nh(n,r,e,t);const l=t.canonical,c=r.canonical,h=Math.pow(2,c.z-l.z);s=e.vertices.map(f=>new tt(f.x*l.x*st*h-c.x*st,f.y*l.y*st*h-c.y*st))}return Kw(n,s,e.indices,0,e.indices.length,0,0)}const mC=yd.types,Jw=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],gC=["fill-extrusion-flood-light-ground-radius"],Qw=Math.pow(2,13),_C=Math.pow(2,15)-1,f0=new tt(0,1),Ys=2147483648;function Sc(e,t,n,r,s,l,c,h){e.emplaceBack((t<<1)+c,(n<<1)+l,(Math.floor(r*Qw)<<1)+s,Math.round(h))}function Sm(e,t,n,r,s,l){e.emplaceBack(t.x,t.y,(n.x<<1)+r,(n.y<<1)+s,l)}function rh(e,t,n){e.emplaceBack(t.x,t.y,t.z,16384*n[0],16384*n[1],16384*n[2])}class p0{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class tE{constructor(){this.centroidXY=new tt(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.min=new tt(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new tt(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new tt(this.max.x-this.min.x,this.max.y-this.min.y)}}class eE{constructor(){this.acc=new tt(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(t,n){t.min.x===Number.MAX_VALUE&&(t.min.x=t.max.x=n.x,t.min.y=t.max.y=n.y)}appendEdge(t,n,r){this.accCount++,this.acc._add(n);let s=!!this.borders;n.x<t.min.x?(t.min.x=n.x,s=!0):n.x>t.max.x&&(t.max.x=n.x,s=!0),n.y<t.min.y?(t.min.y=n.y,s=!0):n.y>t.max.y&&(t.max.y=n.y,s=!0),((0===n.x||n.x===st)&&n.x===r.x)!=((0===n.y||n.y===st)&&n.y===r.y)&&this.processBorderOverlap(n,r),s&&this.checkBorderIntersection(n,r)}checkBorderIntersection(t,n){n.x<0!=t.x<0&&this.addBorderIntersection(0,de(n.y,t.y,(0-n.x)/(t.x-n.x))),n.x>st!=t.x>st&&this.addBorderIntersection(1,de(n.y,t.y,(st-n.x)/(t.x-n.x))),n.y<0!=t.y<0&&this.addBorderIntersection(2,de(n.x,t.x,(0-n.y)/(t.y-n.y))),n.y>st!=t.y>st&&this.addBorderIntersection(3,de(n.x,t.x,(st-n.y)/(t.y-n.y)))}addBorderIntersection(t,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const r=this.borders[t];n<r[0]&&(r[0]=n),n>r[1]&&(r[1]=n)}processBorderOverlap(t,n){if(t.x===n.x){if(t.y===n.y)return;const r=0===t.x?0:1;this.addBorderIntersection(r,n.y),this.addBorderIntersection(r,t.y)}else{const r=0===t.y?2:3;this.addBorderIntersection(r,n.x),this.addBorderIntersection(r,t.x)}}centroid(){return 0===this.accCount?new tt(0,0):new tt(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((t,n)=>t+ +(n[0]!==Number.MAX_VALUE),0):0}}function nE(e,t){const n=e.add(t)._unit(),r=Gt(e.x*n.x+e.y*n.y,-1,1);var s,l,c;return s=Math.acos(r),Math.min(4,Math.max(-4,Math.tan(s)))/4*_C*((l=e).x*(c=t).y-l.y*c.x<0?-1:1)}const m0=[e=>e.x<0,e=>e.x>st,e=>e.y<0,e=>e.y>st];function yC(e,t,n,r){const s=[4];if(0===r)return s;n._mult(r);const l=e.sub(n),c=t.sub(n),h=[e,t,l,c];for(let f=0;f<4;f++)for(const p of h)if(m0[f](p)){s.push(f);break}return s}class g0{constructor(t){this.vertexArray=new r1,this.indexArray=new er,this.programConfigurations=new pl(t.layers,t.zoom,n=>gC.includes(n)),this._segments=new ln,this.hiddenByLandmarkVertexArray=new vu,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new ln}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(t,n,r,s=!1){const l=t.length;if(l>2){let c=Math.max(0,this._segments.get().length-1);const h=this._segments._prepareSegment(4*l,this.vertexArray.length,2*this._segmentToGroundQuads[c].length);let f;c!==this._segments.get().length-1&&(c++,this._segmentToGroundQuads[c]=[],this._segmentToRegionTriCounts[c]=[0,0,0,0,0]);{const p=t[0],m=t[1];f=nE(p.sub(t[l-1])._perp()._unit(),m.sub(p)._perp()._unit())}for(let p=0;p<l;p++){const m=p===l-1?0:p+1,_=t[p],y=t[m],v=t[m===l-1?0:m+1],b=y.sub(_)._perp()._unit(),E=nE(b,v.sub(y)._perp()._unit()),D=f,T=E;if(_0(_,y,n)||s&&oE(_,n)&&oE(y,n)){f=E;continue}const C=h.vertexLength;Sm(this.vertexArray,_,y,1,1,D),Sm(this.vertexArray,_,y,1,0,D),Sm(this.vertexArray,_,y,0,1,T),Sm(this.vertexArray,_,y,0,0,T),h.vertexLength+=4;const I=yC(_,y,b,r);for(const A of I)this._segmentToGroundQuads[c].push({id:C,region:A}),this._segmentToRegionTriCounts[c][A]+=2,h.primitiveLength+=2;f=E}}}prepareBorderSegments(){if(!this.hasData())return;const t=this._segments.get(),n=t.length;for(let r=0;r<n;r++)this._segmentToGroundQuads[r].sort((s,l)=>s.region-l.region);for(let r=0;r<n;r++){const s=this._segmentToGroundQuads[r],l=t[r],c=this._segmentToRegionTriCounts[r];c.reduce((f,p)=>f+p,0);let h=0;for(let f=0;f<=4;f++){const p=c[f];if(0!==p){let m=this.regionSegments[f];m||(m=this.regionSegments[f]=new ln);const _={vertexOffset:l.vertexOffset,primitiveOffset:l.primitiveOffset+h,vertexLength:l.vertexLength,primitiveLength:p};m.get().push(_)}h+=p}for(let f=0;f<s.length;f++){const p=s[f].id;this.indexArray.emplaceBack(p,p+1,p+3),this.indexArray.emplaceBack(p,p+3,p+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(t,n,r,s,l,c){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,t,n,r,s,l,c)}upload(t){this.hasData()&&(this.vertexBuffer=t.createVertexBuffer(this.vertexArray,DA.members),this.indexBuffer=t.createIndexBuffer(this.indexArray))}uploadPaintProperties(t){this.hasData()&&this.programConfigurations.upload(t)}update(t,n,r,s,l,c){this.hasData()&&this.programConfigurations.updatePaintArrays(t,n,r,s,l,c)}updateHiddenByLandmark(t){if(!this.hasData())return;const n=t.groundVertexCount+t.groundVertexArrayOffset;if(0===t.groundVertexCount)return;const r=t.flags&Ys?1:0;for(let s=t.groundVertexArrayOffset;s<n;++s)this.hiddenByLandmarkVertexArray.emplace(s,r);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(t){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=t.createVertexBuffer(this.hiddenByLandmarkVertexArray,CA.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let t=0;t<=4;t++){const n=this.regionSegments[t];n&&n.destroy()}}}}class Ud{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new er,this.footprintVertices=new ro,this.footprintSegments=[],this.layoutVertexArray=new ks,this.centroidVertexArray=new a1,this.indexArray=new er,this.programConfigurations=new pl(t.layers,t.zoom,n=>Jw.includes(n)),this.segments=new ln,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new g0(t),this.maxHeight=0,this.partLookup={}}populate(t,n,r,s){this.features=[],this.hasPattern=vy("fill-extrusion",this.layers,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=Au(r),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:l,id:c,index:h,sourceLayerIndex:f}of t){const p=this.layers[0]._featureFilter.needGeometry,m=xl(l,p);if(!this.layers[0]._featureFilter.filter(new Gn(this.zoom),m,r))continue;const _={id:c,sourceLayerIndex:f,index:h,geometry:p?m.geometry:ze(l,r,s),properties:l.properties,type:l.type,patterns:{}},y=this.layoutVertexArray.length;this.hasPattern?this.features.push(_d("fill-extrusion",this.layers,_,this.zoom,n)):this.addFeature(_,_.geometry,h,r,{},n.availableImages,s,n.brightness),n.featureIndex.insert(l,_.geometry,h,f,this.index,y)}this.sortBorders(),this.groundEffect.prepareBorderSegments()}addFeatures(t,n,r,s,l,c){for(const h of this.features){const{geometry:f}=h;this.addFeature(h,f,h.index,n,r,s,l,c)}this.sortBorders()}update(t,n,r,s,l){const c=0!==Object.keys(t).length;if(c&&!this.stateDependentLayers.length)return;const h=c?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(t,n,h,r,s,l),this.groundEffect.update(t,n,h,r,s,l)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,IA),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,MA.members,!0)),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.groundEffect.uploadHiddenByLandmark(t),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,SA.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,n,r,s,l,c,h,f){const p=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(t,{})/this.tileToMeter,m=[new tt(0,0),new tt(st,st)],_=h.projection,y="globe"===_.name,v="Polygon"===mC[t.type],b=new eE;b.centroidDataIndex=this.centroidData.length;const E=new tE,D=this.layers[0].paint.get("fill-extrusion-base").evaluate(t,{},s)<=0,T=this.layers[0].paint.get("fill-extrusion-height").evaluate(t,{},s);E.height=T,E.vertexArrayOffset=this.layoutVertexArray.length,E.groundVertexArrayOffset=this.groundEffect.vertexArray.length,y&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new op);const C=Up(n,500);for(let O=C.length-1;O>=0;O--){const z=C[O];(0===z.length||(I=z[0]).every(N=>N.x<=0)||I.every(N=>N.x>=st)||I.every(N=>N.y<=0)||I.every(N=>N.y>=st))&&C.splice(O,1)}var I;let A;if(y)A=v0(C,m,s);else{A=[];for(const O of C)A.push({polygon:O,bounds:m})}const M=v?this.edgeRadius:0,R=M>0&&this.zoom<17,L=(O,z)=>{if(0===O.length)return!1;const N=O[O.length-1];return z.x===N.x&&z.y===N.y};for(const{polygon:O,bounds:z}of A){let N=0,V=0;for(const j of O)v&&!j[0].equals(j[j.length-1])&&j.push(j[0]),V+=v?j.length-1:j.length;const B=this.segments.prepareSegment((v?5:4)*V,this.layoutVertexArray,this.indexArray);E.footprintSegIdx<0&&(E.footprintSegIdx=this.footprintSegments.length);const $=new p0;if($.vertexOffset=this.footprintVertices.length,$.indexOffset=3*this.footprintIndices.length,$.ringIndices=[],v){const j=[],Z=[];N=B.vertexLength;for(let Q=0;Q<O.length;Q++){const W=O[Q];W.length&&0!==Q&&Z.push(j.length/2);const X=[];let nt,ot;nt=W[1].sub(W[0])._perp()._unit(),$.ringIndices.push(W.length-1);for(let lt=1;lt<W.length;lt++){const ht=W[lt],ft=W[lt===W.length-1?1:lt+1],at=ht.clone();if(M){ot=ft.sub(ht)._perp()._unit();const ut=nt.add(ot)._unit(),Et=M*Math.min(4,1/(nt.x*ut.x+nt.y*ut.y));at.x+=Et*ut.x,at.y+=Et*ut.y,at.x=Math.round(at.x),at.y=Math.round(at.y),nt=ot}!D||0!==M&&!R||L(X,at)||X.push(at),Sc(this.layoutVertexArray,at.x,at.y,0,0,1,1,0),B.vertexLength++,this.footprintVertices.emplaceBack(ht.x,ht.y),j.push(ht.x,ht.y),y&&rh(this.layoutVertexExtArray,_.projectTilePoint(at.x,at.y,s),_.upVector(s,at.x,at.y))}D&&(0===M||R)&&(0!==X.length&&L(X,X[0])&&X.pop(),this.groundEffect.addData(X,z,p))}const K=yy(j,Z);for(let Q=0;Q<K.length;Q+=3)this.footprintIndices.emplaceBack($.vertexOffset+K[Q+0],$.vertexOffset+K[Q+1],$.vertexOffset+K[Q+2]),this.indexArray.emplaceBack(N+K[Q],N+K[Q+2],N+K[Q+1]),B.primitiveLength++;$.indexCount+=K.length,$.vertexCount+=this.footprintVertices.length-$.vertexOffset}for(let j=0;j<O.length;j++){const Z=O[j];b.startRing(E,Z[0]);let K=Z.length>4&&sE(Z[Z.length-2],Z[0],Z[1]),Q=M?vC(Z[Z.length-2],Z[0],Z[1],M):0;const W=[];let X,nt,ot;nt=Z[1].sub(Z[0])._perp()._unit();let lt=!0;for(let ht=1,ft=0;ht<Z.length;ht++){let at=Z[ht-1],ut=Z[ht];const Et=Z[ht===Z.length-1?1:ht+1];if(b.appendEdge(E,ut,at),_0(ut,at,z)){M&&(nt=Et.sub(ut)._perp()._unit(),lt=!lt);continue}const Ot=ut.sub(at)._perp(),kt=Ot.x/(Math.abs(Ot.x)+Math.abs(Ot.y)),zt=Ot.y>0?1:0,Zt=at.dist(ut);if(ft+Zt>32768&&(ft=0),M){ot=Et.sub(ut)._perp()._unit();let Ee=iE(at,ut,Et,rE(nt,ot),M);isNaN(Ee)&&(Ee=0);const pe=ut.sub(at)._unit();at=at.add(pe.mult(Q))._round(),ut=ut.add(pe.mult(-Ee))._round(),Q=Ee,nt=ot,D&&this.zoom>=17&&(L(W,at)||W.push(at),L(W,ut)||W.push(ut))}const oe=B.vertexLength,Se=Z.length>4&&sE(at,ut,Et);let We=aE(ft,K,lt);if(Sc(this.layoutVertexArray,at.x,at.y,kt,zt,0,0,We),Sc(this.layoutVertexArray,at.x,at.y,kt,zt,0,1,We),ft+=Zt,We=aE(ft,Se,!lt),K=Se,Sc(this.layoutVertexArray,ut.x,ut.y,kt,zt,0,0,We),Sc(this.layoutVertexArray,ut.x,ut.y,kt,zt,0,1,We),B.vertexLength+=4,this.indexArray.emplaceBack(oe+0,oe+1,oe+2),this.indexArray.emplaceBack(oe+1,oe+3,oe+2),B.primitiveLength+=2,M){const Ee=N+(1===ht?Z.length-2:ht-2),pe=1===ht?N:Ee+1;if(this.indexArray.emplaceBack(oe+1,Ee,oe+3),this.indexArray.emplaceBack(Ee,pe,oe+3),B.primitiveLength+=2,void 0===X&&(X=oe),!_0(Et,Z[ht],z)){const ie=ht===Z.length-1?X:B.vertexLength;this.indexArray.emplaceBack(oe+2,oe+3,ie),this.indexArray.emplaceBack(oe+3,ie+1,ie),this.indexArray.emplaceBack(oe+3,pe,ie+1),B.primitiveLength+=3}lt=!lt}if(y){const Ee=this.layoutVertexExtArray,pe=_.projectTilePoint(at.x,at.y,s),ie=_.projectTilePoint(ut.x,ut.y,s),te=_.upVector(s,at.x,at.y),Ne=_.upVector(s,ut.x,ut.y);rh(Ee,pe,te),rh(Ee,pe,te),rh(Ee,ie,Ne),rh(Ee,ie,Ne)}}v&&(N+=Z.length-1),D&&M&&this.zoom>=17&&(0!==W.length&&L(W,W[0])&&W.pop(),this.groundEffect.addData(W,z,p,M>0))}this.footprintSegments.push($),++E.footprintSegLen}if(E.vertexCount=this.layoutVertexArray.length-E.vertexArrayOffset,E.groundVertexCount=this.groundEffect.vertexArray.length-E.groundVertexArrayOffset,0!==E.vertexCount){if(E.centroidXY=b.borders?f0:this.encodeCentroid(b,E),this.centroidData.push(E),b.borders){this.featuresOnBorder.push(b);const O=this.featuresOnBorder.length-1;for(let z=0;z<b.borders.length;z++)b.borders[z][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[z].push(O)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,l,c,s,f),this.groundEffect.addPaintPropertiesData(t,r,l,c,s,f),this.maxHeight=Math.max(this.maxHeight,T)}}sortBorders(){for(let t=0;t<this.borderFeatureIndices.length;t++)this.borderFeatureIndices[t].sort((n,r)=>this.featuresOnBorder[n].borders[t][0]-this.featuresOnBorder[r].borders[t][0])}encodeCentroid(t,n){const r=t.centroid(),s=n.span(),l=Math.min(7,Math.round(s.x*this.tileToMeter/10)),c=Math.min(7,Math.round(s.y*this.tileToMeter/10));return new tt(Gt(r.x,1,8191)<<3|l,Gt(r.y,1,8191)<<3|c)}showCentroid(t){const n=this.centroidData[t.centroidDataIndex];n.flags&=Ys,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(t){this.groundEffect.updateHiddenByLandmark(t);const n=t.vertexArrayOffset,r=t.vertexCount+t.vertexArrayOffset,s=t.flags&Ys?f0:t.centroidXY,l=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==s.y||l!==s.x){for(let c=n;c<r;++c)this.centroidVertexArray.emplace(c,s.x,s.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of this.centroidData)this.writeCentroidToBuffer(t)}updateReplacement(t,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;const r=n.getReplacementRegionsForTile(t.toUnwrapped());if(function(l,c){if(l.length!==c.length)return!1;for(let h=0;h<l.length;h++)if(l[h].sourceId!==c[h].sourceId||!Xw(l[h],c[h]))return!1;return!0}(this.activeReplacements,r))return;if(this.activeReplacements=r,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const l of this.centroidData)l.flags&=2147483647;const s=[];for(const l of this.activeReplacements){const c=Math.pow(2,l.footprintTileId.canonical.z-t.canonical.z);for(const h of this.centroidData)if(!(h.flags&Ys||l.min.x>h.max.x||h.min.x>l.max.x||l.min.y>h.max.y||h.min.y>l.max.y))for(let f=0;f<h.footprintSegLen;f++){const p=this.footprintSegments[h.footprintSegIdx+f];if(s.length=0,xC(this.footprintVertices,p.vertexOffset,p.vertexCount,l.footprintTileId.canonical,t.canonical,s),Kw(l.footprint,s,this.footprintIndices.uint16,p.indexOffset,p.indexCount,-p.vertexOffset,-c)){h.flags|=Ys;break}}}for(const l of this.centroidData)this.writeCentroidToBuffer(l);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(t,n,r){let s=!1;for(let l=0;l<r.footprintSegLen;l++){const c=this.footprintSegments[r.footprintSegIdx+l];let h=0;for(const f of c.ringIndices){for(let p=h,m=f+h-1;p<f+h;m=p++){const _=this.footprintVertices.int16[2*(p+c.vertexOffset)+0],y=this.footprintVertices.int16[2*(p+c.vertexOffset)+1],v=this.footprintVertices.int16[2*(m+c.vertexOffset)+1];y>n!=v>n&&t<(this.footprintVertices.int16[2*(m+c.vertexOffset)+0]-_)*(n-y)/(v-y)+_&&(s=!s)}h=f}}return s}getHeightAtTileCoord(t,n){let r=Number.NEGATIVE_INFINITY,s=!0;const l=4*(t+st)*st+(n+st);if(this.partLookup.hasOwnProperty(l)){const c=this.partLookup[l];return c?{height:c.height,hidden:!!(c.flags&Ys)}:void 0}for(const c of this.centroidData)t>c.max.x||c.min.x>t||n>c.max.y||c.min.y>n||this.footprintContainsPoint(t,n,c)&&c&&c.height>r&&(r=c.height,this.partLookup[l]=c,s=!!(c.flags&Ys));if(r!==Number.NEGATIVE_INFINITY)return{height:r,hidden:s};this.partLookup[l]=void 0}}function rE(e,t){const n=e.add(t)._unit();return e.x*n.x+e.y*n.y}function vC(e,t,n,r){const s=t.sub(e)._perp()._unit(),l=n.sub(t)._perp()._unit();return iE(e,t,n,rE(s,l),r)}function iE(e,t,n,r,s){const l=Math.sqrt(1-r*r);return Math.min(e.dist(t)/3,t.dist(n)/3,s*l/r)}function _0(e,t,n){return e.x<n[0].x&&t.x<n[0].x||e.x>n[1].x&&t.x>n[1].x||e.y<n[0].y&&t.y<n[0].y||e.y>n[1].y&&t.y>n[1].y}function oE(e,t){return e.x<t[0].x||e.x>t[1].x||e.y<t[0].y||e.y>t[1].y}function sE(e,t,n){if(e.x<0||e.x>=st||t.x<0||t.x>=st||n.x<0||n.x>=st)return!1;const r=n.sub(t),s=r.perp(),l=e.sub(t);return(r.x*l.x+r.y*l.y)/Math.sqrt((r.x*r.x+r.y*r.y)*(l.x*l.x+l.y*l.y))>-.866&&s.x*l.x+s.y*l.y<0}function aE(e,t,n){const r=t?2|e:-3&e;return n?1|r:-2&r}function y0(){const e=Math.PI/32,t=Math.tan(e),n=ss;return n*Math.sqrt(1+2*t*t)-n}function v0(e,t,n){const r=1<<n.z,s=Vi(n.x/r),l=Vi((n.x+1)/r),c=dr(n.y/r),h=dr((n.y+1)/r);return function(f,p,m,_,y=0,v){const b=[];if(!f.length||!m||!_)return b;const E=(R,L)=>{for(const O of R)b.push({polygon:O,bounds:L})},D=Math.ceil(Math.log2(m)),T=Math.ceil(Math.log2(_)),C=D-T,I=[];for(let R=0;R<Math.abs(C);R++)I.push(C>0?0:1);for(let R=0;R<Math.min(D,T);R++)I.push(0),I.push(1);let A=f;if(A=Gp(A,p[0].y-y,p[1].y+y,1),A=Gp(A,p[0].x-y,p[1].x+y,0),!A.length)return b;const M=[];for(I.length?M.push({polygons:A,bounds:p,depth:0}):E(A,p);M.length;){const R=M.pop(),L=R.depth,O=I[L],z=R.bounds[0],N=R.bounds[1],V=0===O?z.x:z.y,B=0===O?N.x:N.y,$=v?v(O,V,B):.5*(V+B),j=Gp(R.polygons,V-y,$+y,O),Z=Gp(R.polygons,$-y,B+y,O);if(j.length){const K=[z,new tt(0===O?$:N.x,1===O?$:N.y)];I.length>L+1?M.push({polygons:j,bounds:K,depth:L+1}):E(j,K)}if(Z.length){const K=[new tt(0===O?$:z.x,1===O?$:z.y),N];I.length>L+1?M.push({polygons:Z,bounds:K,depth:L+1}):E(Z,K)}}return b}(e,t,Math.ceil((l-s)/11.25),Math.ceil((c-h)/11.25),1,(f,p,m)=>{if(0===f)return.5*(p+m);{const _=dr((n.y+p/st)/r);return(Ur(.5*(dr((n.y+m/st)/r)+_))*r-n.y)*st}})}function xC(e,t,n,r,s,l){const c=Math.pow(2,r.z-s.z);for(let h=0;h<n;h++){let f=e.int16[2*(h+t)+0],p=e.int16[2*(h+t)+1];f=(f+s.x*st)*c-r.x*st,p=(p+s.y*st)*c-r.y*st,l.push(new tt(f,p))}}jt(Ud,"FillExtrusionBucket",{omit:["layers","features"]}),jt(tE,"PartData"),jt(p0,"FootprintSegment"),jt(eE,"BorderCentroidData"),jt(g0,"GroundEffect");const bC=new qn({visibility:new wt(rt["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new wt(rt["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var lE={paint:new qn({"fill-extrusion-opacity":new wt(rt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Kt(rt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new wt(rt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new wt(rt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Kt(rt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Kt(rt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Kt(rt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new wt(rt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new wt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new wt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new wt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new wt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new wt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new wt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new wt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Kt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Kt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new wt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new wt(rt["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new wt(rt["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new wt(rt["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"])}),layout:bC};class ih extends tt{constructor(t,n,r){super(t,n),this.z=r}}function $d(e,t){return e.x*t.x+e.y*t.y}function cE(e,t){if(1===e.length){let n=0;const r=t[n++];let s;for(;!s||r.equals(s);)if(s=t[n++],!s)return 1/0;for(;n<t.length;n++){const l=t[n],c=e[0],h=s.sub(r),f=l.sub(r),p=c.sub(r),m=$d(h,h),_=$d(h,f),y=$d(f,f),v=$d(p,h),b=$d(p,f),E=m*y-_*_,D=(y*v-_*b)/E,T=(m*b-_*v)/E,C=r.z*(1-D-T)+s.z*D+l.z*T;if(isFinite(C))return C}return 1/0}{let n=1/0;for(const r of t)n=Math.min(n,r.z);return n}}function Cm(e,t,n,r,s,l,c,h){const f=c*s.getElevationAt(e,t,!0,!0),p=0!==l[0],m=p?0===l[1]?c*(l[0]/7-450):c*function(_,y,v){const b=Math.floor(y[0]/8),E=Math.floor(y[1]/8),D=10*(y[0]-8*b),T=10*(y[1]-8*E),C=_.getElevationAt(b,E,!0,!0),I=_.getMeterToDEM(v),A=Math.floor(.5*(D*I-1)),M=Math.floor(.5*(T*I-1)),R=_.tileCoordToPixel(b,E),L=2*A+1,O=2*M+1,z=(W=L,X=O,[(Z=_).getElevationAtPixel(K=R.x-A,Q=R.y-M,!0),Z.getElevationAtPixel(K+X,Q,!0),Z.getElevationAtPixel(K,Q+X,!0),Z.getElevationAtPixel(K+W,Q+X,!0)]),N=Math.abs(z[0]-z[1]),V=Math.abs(z[2]-z[3]),B=Math.abs(z[0]-z[2])+Math.abs(z[1]-z[3]),$=Math.min(.25,.5*I*(N+V)/L),j=Math.min(.25,.5*I*B/O);var Z,K,Q,W,X;return C+Math.max($*D,j*T)}(s,l,h):f;return{base:f+(0===n)?-1:n,top:p?Math.max(m+r,f+n+2):f+r}}const x0=new qn({"line-cap":new Kt(rt.layout_line["line-cap"]),"line-join":new Kt(rt.layout_line["line-join"]),"line-miter-limit":new wt(rt.layout_line["line-miter-limit"]),"line-round-limit":new wt(rt.layout_line["line-round-limit"]),"line-sort-key":new Kt(rt.layout_line["line-sort-key"]),visibility:new wt(rt.layout_line.visibility)});var b0={paint:new qn({"line-opacity":new Kt(rt.paint_line["line-opacity"]),"line-color":new Kt(rt.paint_line["line-color"]),"line-translate":new wt(rt.paint_line["line-translate"]),"line-translate-anchor":new wt(rt.paint_line["line-translate-anchor"]),"line-width":new Kt(rt.paint_line["line-width"]),"line-gap-width":new Kt(rt.paint_line["line-gap-width"]),"line-offset":new Kt(rt.paint_line["line-offset"]),"line-blur":new Kt(rt.paint_line["line-blur"]),"line-dasharray":new Kt(rt.paint_line["line-dasharray"]),"line-pattern":new Kt(rt.paint_line["line-pattern"]),"line-gradient":new np(rt.paint_line["line-gradient"]),"line-trim-offset":new wt(rt.paint_line["line-trim-offset"]),"line-emissive-strength":new wt(rt.paint_line["line-emissive-strength"]),"line-border-width":new Kt(rt.paint_line["line-border-width"]),"line-border-color":new Kt(rt.paint_line["line-border-color"])}),layout:x0};const w0=(e,t,n,r,s,l,c)=>{const h=e.transform,f=h.calculatePixelsToTileUnitsMatrix(t);return{u_matrix:Mm(e,t,n,r),u_pixels_to_tile_units:f,u_device_pixel_ratio:l,u_units_to_pixels:[1/h.pixelsToGLUnits[0],1/h.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:s,u_texsize:dE(n)?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:uE(t,e.transform),u_alpha_discard_threshold:0,u_trim_offset:c,u_emissive_strength:n.paint.get("line-emissive-strength")}},wC=(e,t,n,r,s)=>{const l=e.transform;return{u_matrix:Mm(e,t,n,r),u_texsize:t.imageAtlasTexture.size,u_pixels_to_tile_units:l.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:s,u_image:0,u_tile_units_to_pixels:uE(t,l),u_units_to_pixels:[1/l.pixelsToGLUnits[0],1/l.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function uE(e,t){return 1/Xs(e,1,t.tileZoom)}function Mm(e,t,n,r){return e.translatePosMatrix(r||t.tileID.projMatrix,t,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}const hE=e=>{const t=[];dE(e)&&t.push("RENDER_LINE_DASH"),e.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const n=e.paint.get("line-trim-offset");return 0===n[0]&&0===n[1]||t.push("RENDER_LINE_TRIM_OFFSET"),0!==e.paint.get("line-border-width").constantOr(1)&&t.push("RENDER_LINE_BORDER"),t};function dE(e){const t=e.paint.get("line-dasharray").value;return t.value||"constant"!==t.kind}const Al=new class extends Kt{possiblyEvaluate(e,t){return t=new Gn(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,transition:t.transition}),super.possiblyEvaluate(e,t)}evaluate(e,t,n,r){return t=Vt({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,n,r)}}(b0.paint.properties["line-width"].specification);function E0(e,t){return t>0?t+2*e:e}Al.useIntegerZoom=!0;const EC=new qn({visibility:new wt(rt.layout_background.visibility)});var OA={paint:new qn({"background-color":new wt(rt.paint_background["background-color"]),"background-pattern":new wt(rt.paint_background["background-pattern"]),"background-opacity":new wt(rt.paint_background["background-opacity"]),"background-emissive-strength":new wt(rt.paint_background["background-emissive-strength"])}),layout:EC};const fE=new qn({visibility:new wt(rt.layout_raster.visibility)});var T0={paint:new qn({"raster-opacity":new wt(rt.paint_raster["raster-opacity"]),"raster-color":new np(rt.paint_raster["raster-color"]),"raster-color-mix":new wt(rt.paint_raster["raster-color-mix"]),"raster-color-range":new wt(rt.paint_raster["raster-color-range"]),"raster-hue-rotate":new wt(rt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new wt(rt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new wt(rt.paint_raster["raster-brightness-max"]),"raster-saturation":new wt(rt.paint_raster["raster-saturation"]),"raster-contrast":new wt(rt.paint_raster["raster-contrast"]),"raster-resampling":new wt(rt.paint_raster["raster-resampling"]),"raster-fade-duration":new wt(rt.paint_raster["raster-fade-duration"])}),layout:fE};function pE(e,t,n,r,s,l,c,h){const f=[e,n,s,t,r,l,1,1,1],p=[c,h,1],m=ji.adjoint([],f),[_,y,v]=H.transformMat3(p,p,ji.transpose(m,m));return ji.multiply(f,[_,0,0,0,y,0,0,0,v],f)}class Do extends xn{constructor(t,n,r,s){super(),this.id=t,this.dispatcher=r,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(s),this.options=n,this._dirty=!1}load(t,n){if(this._loaded=n||!1,this.fire(new xt("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return t&&(this.coordinates=t),this._loaded=!0,void this._finishLoading();this._imageRequest=Te(this.map._requestManager.transformRequest(this.url,dt.Image),(r,s)=>{if(this._imageRequest=null,this._loaded=!0,r)this.fire(new he(r));else if(s){const{HTMLImageElement:l}=it;this.image=s instanceof l?me.getImageData(s):s,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),this._finishLoading()}})}loaded(){return this._loaded}updateImage(t){return this.image&&t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}setTexture(t){if(!(t.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new pm(this.map.painter.context,t.handle),this.width=t.dimensions[0],this.height=t.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new xt("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof pm||this.texture.destroy()}setCoordinates(t){if(this.coordinates=t,this._boundsArray=void 0,!t.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=t[0][1],r=t[0][1];for(const l of t)l[1]>r&&(r=l[1]),l[1]<n&&(n=l[1]);const s=(r+n)/2;if(s>nr?this.onNorthPole=!0:s<-nr&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const l=t.map(He.fromLngLat);this.tileID=function(c){let h=1/0,f=1/0,p=-1/0,m=-1/0;for(const b of c)h=Math.min(h,b.x),f=Math.min(f,b.y),p=Math.max(p,b.x),m=Math.max(m,b.y);const _=Math.max(p-h,m-f),y=Math.max(0,Math.floor(-Math.log(_)/Math.LN2)),v=Math.pow(2,y);return new Oo(y,Math.floor((h+p)/2*v),Math.floor((f+m)/2*v))}(l),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new xt("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(t){for(const f in this.tiles){const p=this.tiles[f];"loaded"!==p.state&&(p.state="loaded",p.texture=this.texture)}if(this._boundsArray)return;const n=Ml(this.tileID,this.map.transform.projection),[r,s,l,c]=this.coordinates.map(f=>{const p=n.projection.project(f[0],f[1]);return tw(n,p)._round()});this.perspectiveTransform=function(f,p,m,_,y,v,b,E,D,T){const C=pE(0,0,f,0,0,p,f,p),I=pE(m,_,y,v,b,E,D,T);return ji.multiply(I,ji.adjoint(C,C),I),[I[6]/I[8]*f/st,I[7]/I[8]*p/st]}(this.width,this.height,r.x,r.y,s.x,s.y,c.x,c.y,l.x,l.y);const h=this._boundsArray=new ks;h.emplaceBack(r.x,r.y,0,0),h.emplaceBack(s.x,s.y,st,0),h.emplaceBack(c.x,c.y,0,st),h.emplaceBack(l.x,l.y,st,st),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=t.createVertexBuffer(h,Wy.members),this.boundsSegments=ln.simpleSegment(0,0,4,2)}prepare(){const t=0!==Object.keys(this.tiles).length;if(this.tileID&&!t)return;const n=this.map.painter.context,r=n.gl;!this._dirty||this.texture instanceof pm||(this.texture?this.texture.update(this.image):(this.texture=new pr(n,this.image,r.RGBA),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE)),this._dirty=!1),t&&this._prepareData(n)}loadTile(t,n){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},n(null)):(t.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class TC extends Lo{constructor(t){super(t,{}),this.implementation=t,t.slot&&(this.slot=t.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isLayerDraped(t){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}const mE=new qn({visibility:new wt(rt.layout_sky.visibility)});var D0={paint:new qn({"sky-type":new wt(rt.paint_sky["sky-type"]),"sky-atmosphere-sun":new wt(rt.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new wt(rt.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new wt(rt.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new wt(rt.paint_sky["sky-gradient-radius"]),"sky-gradient":new np(rt.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new wt(rt.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new wt(rt.paint_sky["sky-atmosphere-color"]),"sky-opacity":new wt(rt.paint_sky["sky-opacity"])}),layout:mE};function Im(e,t,n){const r=[0,0,1],s=Zr.identity([]);return Zr.rotateY(s,s,n?-be(e)+Math.PI:be(e)),Zr.rotateX(s,s,-be(t)),H.transformQuat(r,r,s),H.normalize(r,r)}var gE={paint:new qn({})};const _E={circle:class extends Lo{constructor(e,t){super(e,yA,t)}createBucket(e){return new ty(e)}queryRadius(e){const t=e;return dd("circle-radius",this,t)+dd("circle-stroke-width",this,t)+sy(this.paint.get("circle-translate"))}queryIntersectsFeature(e,t,n,r,s,l,c,h){const f=db(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),p=this.paint.get("circle-radius").evaluate(t,n)+this.paint.get("circle-stroke-width").evaluate(t,n);return ay(e,r,l,c,h,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),f,p)}getProgramIds(){return["circle"]}getDefaultProgramParams(e,t){const n=pb(this);return{config:new dc(this,t),defines:n,overrideFog:!1}}},heatmap:class extends Lo{createBucket(e){return new _b(e)}constructor(e,t){super(e,uy,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){"heatmap-color"===e&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=hy({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(e){return dd("heatmap-radius",this,e)}queryIntersectsFeature(e,t,n,r,s,l,c,h){const f=this.paint.get("heatmap-radius").evaluate(t,n);return ay(e,r,l,c,h,!0,!0,new tt(0,0),f)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(e,t){return"heatmap"===e?{config:new dc(this,t),overrideFog:!1}:{}}},hillshade:class extends Lo{constructor(e,t){super(e,yS,t)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(e,t){return{overrideFog:!1}}},fill:class extends Lo{constructor(e,t){super(e,EA,t)}getProgramIds(){const e=this.paint.get("fill-pattern"),t=e&&e.constantOr(1),n=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(e,t){return{config:new dc(this,t),overrideFog:!1}}recalculate(e,t){super.recalculate(e,t);const n=this.paint._values["fill-outline-color"];"constant"===n.value.kind&&void 0===n.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new xy(e)}queryRadius(){return sy(this.paint.get("fill-translate"))}queryIntersectsFeature(e,t,n,r,s,l){return!e.queryGeometry.isAboveHorizon&&lb(mS(e.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),r)}isTileClipped(){return!0}},"fill-extrusion":class extends Lo{constructor(e,t){super(e,lE,t)}createBucket(e){return new Ud(e)}queryRadius(){return sy(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(e,t,n,r,s,l,c,h,f){const p=db(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),m=this.paint.get("fill-extrusion-height").evaluate(t,n),_=this.paint.get("fill-extrusion-base").evaluate(t,n),y=[0,0],v=h&&l.elevation,b=l.elevation?l.elevation.exaggeration():1,E=e.tile.getBucket(this);if(v&&E instanceof Ud){const A=E.centroidVertexArray,M=f+1;M<A.length&&(y[0]=A.geta_centroid_pos0(M),y[1]=A.geta_centroid_pos1(M))}if(0===y[0]&&1===y[1])return!1;"globe"===l.projection.name&&(r=v0([r],[new tt(0,0),new tt(st,st)],e.tileID.canonical).map(A=>A.polygon).flat());const D=v?h:null,[T,C]=(M=r,R=_,L=m,O=p,z=c,N=D,V=y,B=b,$=l.center.lat,"globe"===(A=l).projection.name?function(Z,K,Q,W,X,nt,ot,lt,ht,ft,at){const ut=[],Et=[],Ot=Z.projection.upVectorScale(at,Z.center.lat,Z.worldSize).metersToTile,kt=[0,0,0,1],zt=[0,0,0,1],Zt=(Se,We,Ee,pe)=>{Se[0]=We,Se[1]=Ee,Se[2]=pe,Se[3]=1},oe=y0();Q>0&&(Q+=oe),W+=oe;for(const Se of K){const We=[],Ee=[];for(const pe of Se){const ie=pe.x+X.x,te=pe.y+X.y,Ne=Z.projection.projectTilePoint(ie,te,at),Xe=Z.projection.upVector(at,pe.x,pe.y);let Ce=Q,yn=W;if(ot){const On=Cm(ie,te,Q,W,ot,lt,ht,ft);Ce+=On.base,yn+=On.top}0!==Q?Zt(kt,Ne.x+Xe[0]*Ot*Ce,Ne.y+Xe[1]*Ot*Ce,Ne.z+Xe[2]*Ot*Ce):Zt(kt,Ne.x,Ne.y,Ne.z),Zt(zt,Ne.x+Xe[0]*Ot*yn,Ne.y+Xe[1]*Ot*yn,Ne.z+Xe[2]*Ot*yn),H.transformMat4(kt,kt,nt),H.transformMat4(zt,zt,nt),We.push(new ih(kt[0],kt[1],kt[2])),Ee.push(new ih(zt[0],zt[1],zt[2]))}ut.push(We),Et.push(Ee)}return[ut,Et]}(A,M,R,L,O,z,N,V,B,$,e.tileID.canonical):N?function(Z,K,Q,W,X,nt,ot,lt,ht){const ft=[],at=[],ut=[0,0,0,1];for(const Et of Z){const Ot=[],kt=[];for(const zt of Et){const Zt=zt.x+W.x,oe=zt.y+W.y,Se=Cm(Zt,oe,K,Q,nt,ot,lt,ht);ut[0]=Zt,ut[1]=oe,ut[2]=Se.base,ut[3]=1,an.transformMat4(ut,ut,X),ut[3]=Math.max(ut[3],1e-5);const We=new ih(ut[0]/ut[3],ut[1]/ut[3],ut[2]/ut[3]);ut[0]=Zt,ut[1]=oe,ut[2]=Se.top,ut[3]=1,an.transformMat4(ut,ut,X),ut[3]=Math.max(ut[3],1e-5);const Ee=new ih(ut[0]/ut[3],ut[1]/ut[3],ut[2]/ut[3]);Ot.push(We),kt.push(Ee)}ft.push(Ot),at.push(kt)}return[ft,at]}(M,R,L,O,z,N,V,B,$):function(Z,K,Q,W,X){const nt=[],ot=[],lt=X[8]*K,ht=X[9]*K,ft=X[10]*K,at=X[11]*K,ut=X[8]*Q,Et=X[9]*Q,Ot=X[10]*Q,kt=X[11]*Q;for(const zt of Z){const Zt=[],oe=[];for(const Se of zt){const We=Se.x+W.x,Ee=Se.y+W.y,pe=X[0]*We+X[4]*Ee+X[12],ie=X[1]*We+X[5]*Ee+X[13],te=X[2]*We+X[6]*Ee+X[14],Ne=X[3]*We+X[7]*Ee+X[15],Xe=pe+lt,Ce=ie+ht,yn=te+ft,On=Math.max(Ne+at,1e-5),Rn=pe+ut,Dn=ie+Et,lr=te+Ot,Fn=Math.max(Ne+kt,1e-5);Zt.push(new ih(Xe/On,Ce/On,yn/On)),oe.push(new ih(Rn/Fn,Dn/Fn,lr/Fn))}nt.push(Zt),ot.push(oe)}return[nt,ot]}(M,R,L,O,z)),I=e.queryGeometry;var A,M,R,L,O,z,N,V,B,$;return function(A,M,R){let L=1/0;lb(R,M)&&(L=cE(R,M[0]));for(let O=0;O<M.length;O++){const z=M[O],N=A[O];for(let V=0;V<z.length-1;V++){const B=z[V],$=[B,z[V+1],N[V+1],N[V],B];sb(R,$)&&(L=Math.min(L,cE(R,$)))}}return L!==1/0&&L}(T,C,I.isPointQuery()?I.screenBounds:I.screenGeometry)}},line:class extends Lo{constructor(e,t){super(e,b0,t),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(e){if("line-gradient"===e){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof _x,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=Al.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new ka(e)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(e,t){const n=hE(this);return{config:new dc(this,t),defines:n,overrideFog:!1}}queryRadius(e){const t=e,n=E0(dd("line-width",this,t),dd("line-gap-width",this,t)),r=dd("line-offset",this,t);return n/2+Math.abs(r)+sy(this.paint.get("line-translate"))}queryIntersectsFeature(e,t,n,r,s,l){if(e.queryGeometry.isAboveHorizon)return!1;const c=mS(e.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),l.angle,e.pixelToTileUnitsFactor),h=e.pixelToTileUnitsFactor/2*E0(this.paint.get("line-width").evaluate(t,n),this.paint.get("line-gap-width").evaluate(t,n)),f=this.paint.get("line-offset").evaluate(t,n);return f&&(r=function(p,m){const _=[],y=new tt(0,0);for(let v=0;v<p.length;v++){const b=p[v],E=[];for(let D=0;D<b.length;D++){const T=b[D],C=b[D+1],I=0===D?y:T.sub(b[D-1])._unit()._perp(),A=D===b.length-1?y:C.sub(T)._unit()._perp(),M=I._add(A)._unit();M._mult(1/(M.x*A.x+M.y*A.y)),E.push(M._mult(m)._add(T))}_.push(E)}return _}(r,f*e.pixelToTileUnitsFactor)),function(p,m,_){for(let y=0;y<m.length;y++){const v=m[y];if(p.length>=3)for(let b=0;b<v.length;b++)if(Yr(p,v[b]))return!0;if(cb(p,v,_))return!0}return!1}(c,r,h)}isTileClipped(){return!0}},symbol:Ad,background:class extends Lo{constructor(e,t){super(e,OA,t)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(e,t){return{overrideFog:!1}}},raster:class extends Lo{constructor(e,t){super(e,T0,t),this._updateColorRamp()}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}isLayerDraped(e){return!(e&&e._source instanceof Do&&(e._source.onNorthPole||e._source.onSouthPole))}_handleSpecialPaintPropertyUpdate(e){"raster-color"!==e&&"raster-color-range"!==e||this._updateColorRamp()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-color"].value.expression,[t,n]=this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0});this.colorRamp=hy({expression:e,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:t,end:n}],resolution:256}),this.colorRampTexture=null}},sky:class extends Lo{constructor(e,t){super(e,D0,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){"sky-gradient"===e?this._updateColorRamp():"sky-atmosphere-sun"!==e&&"sky-atmosphere-halo-color"!==e&&"sky-atmosphere-color"!==e&&"sky-atmosphere-sun-intensity"!==e||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=hy({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(e){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=e.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(e,t){if("atmosphere"===this.paint.get("sky-type")){const r=this.paint.get("sky-atmosphere-sun"),s=!r,l=e.style.light,c=l.properties.get("position");return s&&"viewport"===l.properties.get("anchor")&&Y("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),s?Im(c.azimuthal,90-c.polar,t):Im(r[0],90-r[1],t)}const n=this.paint.get("sky-gradient-center");return Im(n[0],90-n[1],t)}isSky(){return!0}markSkyboxValid(e){this._skyboxInvalidated=!1,this._lightPosition=e.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const e=this.paint.get("sky-type");return"atmosphere"===e?["skyboxCapture","skybox"]:"gradient"===e?["skyboxGradient"]:null}},slot:class extends Lo{constructor(e,t){super(e,gE)}},model:class extends Lo{constructor(e,t){super(e,kA,t)}createBucket(e){return new Gw(e)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(){return 0}queryIntersectsFeature(){return!1}_handleOverridablePaintPropertyUpdate(e,t,n){return!(!this.layout||t.isDataDriven()||n.isDataDriven()||"model-color"!==e&&"model-color-mix-intensity"!==e&&"model-rotation"!==e&&"model-scale"!==e&&"model-translation"!==e&&"model-emissive-strength"!==e)}_isPropertyZoomDependent(e){const t=this._transitionablePaint._values[e];return null!=t&&null!=t.value&&null!=t.value.expression&&t.value.expression instanceof Dr}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}}};function Hd(e,t){return"custom"===e.type?new TC(e):new _E[e.type](e,t)}function DC(e){const{userImage:t}=e;return!!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0)}class SC extends xn{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(t){this.images[t]={},this.loaded[t]=!1,this.updatedImages[t]={},this.patterns[t]={},this.callbackDispatchedThisFrame[t]={},this.atlasImage[t]=new rr({width:1,height:1})}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}setLoaded(t,n){if(this.loaded[n]!==t&&(this.loaded[n]=t,t)){for(const{ids:r,callback:s}of this.requestors)this._notify(r,n,s);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images[n][t]}addImage(t,n,r){this._validate(t,r)&&(this.images[n][t]=r)}_validate(t,n){let r=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new he(new Error(`Image "${t}" has invalid "stretchX" value`))),r=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new he(new Error(`Image "${t}" has invalid "stretchY" value`))),r=!1),this._validateContent(n.content,n)||(this.fire(new he(new Error(`Image "${t}" has invalid "content" value`))),r=!1),r}_validateStretch(t,n){if(!t)return!0;let r=0;for(const s of t){if(s[0]<r||s[1]<s[0]||n<s[1])return!1;r=s[1]}return!0}_validateContent(t,n){return!(t&&(4!==t.length||t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))}updateImage(t,n,r){r.version=this.images[n][t].version+1,this.images[n][t]=r,this.updatedImages[n][t]=!0}removeImage(t,n){const r=this.images[n][t];delete this.images[n][t],delete this.patterns[n][t],r.userImage&&r.userImage.onRemove&&r.userImage.onRemove()}listImages(t){return Object.keys(this.images[t])}getImages(t,n,r){let s=!0;const l=!!this.loaded[n];if(!l)for(const c of t)this.images[n][c]||(s=!1);l||s?this._notify(t,n,r):this.requestors.push({ids:t,scope:n,callback:r})}getUpdatedImages(t){return this.updatedImages[t]}_notify(t,n,r){const s={};for(const l of t){this.images[n][l]||this.fire(new xt("styleimagemissing",{id:l}));const c=this.images[n][l];c?s[l]={data:c.data.clone(),pixelRatio:c.pixelRatio,sdf:c.sdf,version:c.version,stretchX:c.stretchX,stretchY:c.stretchY,content:c.content,hasRenderCallback:Boolean(c.userImage&&c.userImage.render)}:Y(`Image "${l}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}r(null,s)}getPixelSize(t){const{width:n,height:r}=this.atlasImage[t];return{width:n,height:r}}getPattern(t,n){const r=this.patterns[n][t],s=this.getImage(t,n);if(!s)return null;if(r&&r.position.version===s.version)return r.position;if(r)r.position.version=s.version;else{const l={w:s.data.width+2,h:s.data.height+2,x:0,y:0},c=new Oy(l,s);this.patterns[n][t]={bin:l,position:c}}return this._updatePatternAtlas(n),this.patterns[n][t].position}bind(t,n){const r=t.gl;let s=this.atlasTexture[n];s?this.dirty&&(s.update(this.atlasImage[n]),this.dirty=!1):(s=new pr(t,this.atlasImage[n],r.RGBA),this.atlasTexture[n]=s),s.bind(r.LINEAR,r.CLAMP_TO_EDGE)}_updatePatternAtlas(t){const n=[];for(const c in this.patterns[t])n.push(this.patterns[t][c].bin);const{w:r,h:s}=em(n),l=this.atlasImage[t];l.resize({width:r||1,height:s||1});for(const c in this.patterns[t]){const{bin:h}=this.patterns[t][c],f=h.x+1,p=h.y+1,m=this.images[t][c].data,_=m.width,y=m.height;rr.copy(m,l,{x:0,y:0},{x:f,y:p},{width:_,height:y}),rr.copy(m,l,{x:0,y:y-1},{x:f,y:p-1},{width:_,height:1}),rr.copy(m,l,{x:0,y:0},{x:f,y:p+y},{width:_,height:1}),rr.copy(m,l,{x:_-1,y:0},{x:f-1,y:p},{width:1,height:y}),rr.copy(m,l,{x:0,y:0},{x:f+_,y:p},{width:1,height:y})}this.dirty=!0}beginFrame(){for(const t in this.images)this.callbackDispatchedThisFrame[t]={}}dispatchRenderCallbacks(t,n){for(const r of t){if(this.callbackDispatchedThisFrame[n][r])continue;this.callbackDispatchedThisFrame[n][r]=!0;const s=this.images[n][r];DC(s)&&this.updateImage(r,n,s)}}}const CC=new qn({anchor:new wt(rt.light.anchor),position:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return Nt(e.expression.evaluate(t))}interpolate(e,t,n){return{x:de(e.x,t.x,n),y:de(e.y,t.y,n),z:de(e.z,t.z,n),azimuthal:de(e.azimuthal,t.azimuthal,n),polar:de(e.polar,t.polar,n)}}}(rt.light.position),color:new wt(rt.light.color),intensity:new wt(rt.light.intensity)});class yE extends xn{constructor(t,n="flat"){super(),this._transitionable=new xo(CC),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,r={}){this._validate(Zf,t,r)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,r){return(!r||!1!==r.validate)&&Jf(this,t.call(cl,Vt({value:n,style:{glyphs:!0,sprite:!0},styleSpec:rt})))}}const vE=new qn({source:new wt(rt.terrain.source),exaggeration:new wt(rt.terrain.exaggeration)});let FA=class extends xn{constructor(e,t){super(),this._transitionable=new xo(vE),this.set(e),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}setScope(e){this.scope=e}get(){return this._transitionable.serialize()}set(e){this._transitionable.setTransitionOrValue(e)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}getExaggeration(e){return this._transitioning.possiblyEvaluate(new Gn(e)).get("exaggeration")}isZoomDependent(){const e=this._transitionable._values.exaggeration;return null!=e&&null!=e.value&&null!=e.value.expression&&e.value.expression instanceof Dr}};const Cc=.05;function C0(e,t,n,r){const s=Ts(45,65,n),[l,c]=MC(e,r);let h=1-Math.min(1,Math.exp((t-l)/(c-l)*-6));return h*=h*h,h=Math.min(1,1.00747*h),h*s*e.alpha}function MC(e,t){const n=.5/Math.tan(.5*t);return[e.range[0]+n,e.range[1]+n]}function bE(e,t,n,r,s){const l=H.transformMat4([],[t,n,r],s.mercatorFogMatrix);return C0(e,H.length(l),s.pitch,s._fov)}function wE(e,t,n,r,s,l,c){const h=[[n,r,0],[s,r,0],[s,l,0],[n,l,0]];let f=Number.MAX_VALUE,p=-Number.MAX_VALUE;for(const m of h){const _=H.transformMat4([],m,t),y=H.length(_);f=Math.min(f,y),p=Math.max(p,y)}return[C0(e,f,c.pitch,c._fov),C0(e,p,c.pitch,c._fov)]}const IC=new qn({range:new wt(rt.fog.range),color:new wt(rt.fog.color),"high-color":new wt(rt.fog["high-color"]),"space-color":new wt(rt.fog["space-color"]),"horizon-blend":new wt(rt.fog["horizon-blend"]),"star-intensity":new wt(rt.fog["star-intensity"]),"vertical-range":new wt(rt.fog["vertical-range"])});class AC extends xn{constructor(t,n){super(),this._transitionable=new xo(IC),this.set(t),this._transitioning=this._transitionable.untransitioned(),this._transform=n}get state(){const t=this._transform,n="globe"===t.projection.name,r=Mr(t.zoom),s=this.properties.get("range"),l=[.5,3];return{range:n?[de(l[0],s[0],r),de(l[1],s[1],r)]:s,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n={}){if(this._validate(Ux,t,n))return;const r=Vt({},t);for(const s of Object.keys(rt.fog))void 0===r[s]&&(r[s]=rt.fog[s].default);this._transitionable.setTransitionOrValue(r)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:Ts(45,65,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?function(r,s,l){const c=He.fromLngLat(s),h=l.elevation?l.elevation.getAtPointOrZero(c):0;return bE(r,c.x,c.y,h,l)}(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return wE(this.state,n,0,0,st,st,this._transform)}getOpacityForBounds(t,n,r,s,l){return this._transform.projection.supportsFog?wE(this.state,t,n,r,s,l,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?MC(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const r of n){const s=t.points[r];let l;if(s[2]>=0)l=s;else{const c=t.points[r-4];l=il(c,s,c[2]/(c[2]-s[2]))}if(bE(this.state,l[0],l[1],0,this._transform)>=Cc)return!0}return!1}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,r){return(!r||!1!==r.validate)&&Jf(this,t.call(cl,Vt({value:n,style:{glyphs:!0,sprite:!0},styleSpec:rt})))}}class PC{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class RC{constructor(){this.tasks={},this.taskQueue=[],Rr(["process"],this),this.invoker=new PC(this.process),this.nextId=0}add(t,n){const r=this.nextId++,s=function({type:l,isSymbolTile:c,zoom:h}){return h=h||0,"message"===l?0:"maybePrepare"!==l||c?"parseTile"!==l||c?"parseTile"===l&&c?300-h:"maybePrepare"===l&&c?400-h:500:200-h:100-h}(n);if(0===s){_t();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[r]={fn:t,metadata:n,priority:s,id:r},this.taskQueue.push(r),this.invoker.trigger(),{cancel:()=>{delete this.tasks[r]}}}process(){_t();try{if(this.taskQueue=this.taskQueue.filter(r=>!!this.tasks[r]),!this.taskQueue.length)return;const t=this.pick();if(null===t)return;const n=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let t=null,n=1/0;for(let s=0;s<this.taskQueue.length;s++){const l=this.tasks[this.taskQueue[s]];l.priority<n&&(n=l.priority,t=s)}if(null===t)return null;const r=this.taskQueue[t];return this.taskQueue.splice(t,1),r}remove(){this.invoker.remove()}}class EE{constructor(t,n,r){this.target=t,this.parent=n,this.mapId=r,this.callbacks={},this.cancelCallbacks={},Rr(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new RC}send(t,n,r,s,l=!1,c){const h=Math.round(1e18*Math.random()).toString(36).substring(0,10);r&&(r.metadata=c,this.callbacks[h]=r);const f=new Set;return this.target.postMessage({id:h,type:t,hasCallback:!!r,targetMapId:s,mustQueue:l,sourceMapId:this.mapId,data:Ls(n,f)},f),{cancel:()=>{r&&delete this.callbacks[h],this.target.postMessage({id:h,type:"<cancel>",targetMapId:s,sourceMapId:this.mapId})}}}receive(t){const n=t.data,r=n.id;if(r&&(!n.targetMapId||this.mapId===n.targetMapId))if("<cancel>"===n.type){const s=this.cancelCallbacks[r];delete this.cancelCallbacks[r],s&&s.cancel()}else if(n.mustQueue||_t()){const s=this.callbacks[r];this.cancelCallbacks[r]=this.scheduler.add(()=>this.processTask(r,n),s&&s.metadata||{type:"message"})}else this.processTask(r,n)}processTask(t,n){if("<response>"===n.type){const r=this.callbacks[t];delete this.callbacks[t],r&&(n.error?r(Qo(n.error)):r(null,Qo(n.data)))}else{const r=new Set,s=n.hasCallback?(c,h)=>{delete this.cancelCallbacks[t],this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:c?Ls(c):null,data:Ls(h,r)},r)}:c=>{},l=Qo(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,l,s);else if(this.parent.getWorkerSource){const c=n.type.split(".");this.parent.getWorkerSource(n.sourceMapId,c[0],l.source,l.scope)[c[1]](l,s)}else s(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}let Am=(()=>{class e{constructor(n,r){this.workerPool=n,this.actors=[],this.currentActor=0,this.id=mr();const s=this.workerPool.acquire(this.id);for(let l=0;l<s.length;l++){const c=new e.Actor(s[l],r,this.id);c.name=`Worker ${l}`,this.actors.push(c)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(n,r,s){Ul(this.actors,(l,c)=>{l.send(n,r,c)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(n=>{n.remove()}),this.actors=[],this.workerPool.release(this.id)}}return e.Actor=EE,e})();class TE extends xn{constructor(t,n,r,s){super(),this.scope=r,this._options=t,this.properties=new Xh(n),this._transitionable=new xo(n,new Map(s)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}const LC=new qn({color:new wt(rt.properties_light_ambient.color),intensity:new wt(rt.properties_light_ambient.intensity)}),kC=new qn({direction:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return function([n,r]){const s=Nt([1,n,r]);return{x:s.x,y:s.y,z:s.z}}(e.expression.evaluate(t))}interpolate(e,t,n){return{x:de(e.x,t.x,n),y:de(e.y,t.y,n),z:de(e.z,t.z,n)}}}(rt.properties_light_directional.direction),color:new wt(rt.properties_light_directional.color),intensity:new wt(rt.properties_light_directional.intensity),"cast-shadows":new wt(rt.properties_light_directional["cast-shadows"]),"shadow-intensity":new wt(rt.properties_light_directional["shadow-intensity"])});class M0{constructor(t,n,r,s){this.screenBounds=t,this.cameraPoint=n,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=r,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,s)}static createFromScreenPoints(t,n){let r,s;if(t instanceof tt||"number"==typeof t[0]){const l=tt.convert(t);r=[l],s=n.isPointAboveHorizon(l)}else{const l=tt.convert(t[0]),c=tt.convert(t[1]);r=[l,c],s=Vl(l,c).every(h=>n.isPointAboveHorizon(h))}return new M0(r,n.getCameraPoint(),s,n)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(t){return Vl(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],r=1===this.screenBounds.length?this.screenBounds[0].add(new tt(1,1)):this.screenBounds[1],s=Vl(n,r,0,!1);return this.cameraPoint.y>r.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<r.x?s.splice(3,0,this.cameraPoint):this.cameraPoint.x>=r.x?s[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(s[3]=this.cameraPoint)),function(l,c){const h=[];for(let f=0;f<l.length;f++){const p=Ds(f-1,-1,l.length-1),m=Ds(f+1,-1,l.length-1),_=l[f],y=l[m],v=l[p].sub(_).unit(),b=y.sub(_).unit(),E=b.angleWithSep(v.x,v.y),D=v.add(b).unit().mult(-1*c/Math.sin(E/2));h.push(_.add(D))}return h}(s,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],r=1===this.screenBounds.length?this.screenBounds[0].add(new tt(1,1)):this.screenBounds[1],s=Vl(n,r,t),l=this.cameraPoint.clone();switch(3*((l.y>n.y)+(l.y>r.y))+((l.x>n.x)+(l.x>r.x))){case 0:s[0]=l,s[4]=l.clone();break;case 1:s.splice(1,0,l);break;case 2:s[1]=l;break;case 3:s.splice(4,0,l);break;case 5:s.splice(2,0,l);break;case 6:s[3]=l;break;case 7:s.splice(3,0,l);break;case 8:s[2]=l}return s}containsTile(t,n,r,s=0){const l=t.queryPadding/n._pixelsPerMercatorPixel+1,c=r?this._bufferedCameraMercator(l,n):this._bufferedScreenMercator(l,n);let h=t.tileID.wrap+(c.unwrapped?s:0);const f=c.polygon.map(D=>tw(t.tileTransform,D,h));if(!hb(f,0,0,st,st))return;h=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?s:0);const p=this.screenGeometryMercator.polygon.map(D=>lo(t.tileTransform,D,h)),m=p.map(D=>new tt(D[0],D[1])),_=n.getFreeCameraOptions().position||new He(0,0,0),y=lo(t.tileTransform,_,h),v=p.map(D=>{const T=H.sub(D,D,y);return H.normalize(T,T),new id(y,T)}),b=Xs(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:m,tilespaceRays:v,bufferedTilespaceGeometry:f,bufferedTilespaceBounds:(E=oa(f),E.min.x=Gt(E.min.x,0,st),E.min.y=Gt(E.min.y,0,st),E.max.x=Gt(E.max.x,0,st),E.max.y=Gt(E.max.y,0,st),E),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:b};var E}_bufferedScreenMercator(t,n){const r=I0(t);if(this._screenRaycastCache[r])return this._screenRaycastCache[r];{let s;return s="globe"===n.projection.name?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map(l=>n.pointCoordinate3D(l)),unwrapped:!0},this._screenRaycastCache[r]=s,s}}_bufferedCameraMercator(t,n){const r=I0(t);if(this._cameraRaycastCache[r])return this._cameraRaycastCache[r];{let s;return s="globe"===n.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map(l=>n.pointCoordinate3D(l)),unwrapped:!0},this._cameraRaycastCache[r]=s,s}}_projectAndResample(t,n){const r=function(l,c){const h=et.multiply([],c.pixelMatrix,c.globeMatrix),f=[0,-ei,0,1],p=[0,ei,0,1],m=[0,0,0,1];an.transformMat4(f,f,h),an.transformMat4(p,p,h),an.transformMat4(m,m,h);const _=new tt(f[0]/f[3],f[1]/f[3]),y=new tt(p[0]/p[3],p[1]/p[3]),v=Yr(l,_)&&f[3]<m[3],b=Yr(l,y)&&p[3]<m[3];if(!v&&!b)return null;const E=function(L,O,z){for(let N=1;N<L.length;N++){const V=oh(O.pointCoordinate3D(L[N-1]).x),B=oh(O.pointCoordinate3D(L[N]).x);if(z<0){if(V<B)return{idx:N,t:-V/(B-1-V)}}else if(B<V)return{idx:N,t:(1-V)/(B+1-V)}}return null}(l,c,v?-1:1);if(!E)return null;const{idx:D,t:T}=E;let C=D>1?Mc(l.slice(0,D),c):[],I=D<l.length?Mc(l.slice(D),c):[];C=C.map(L=>new tt(oh(L.x),L.y)),I=I.map(L=>new tt(oh(L.x),L.y));const A=[...C];0===A.length&&A.push(I[I.length-1]);const M=de(A[A.length-1].y,(0===I.length?C[0]:I[0]).y,T);let R;return R=v?[new tt(0,M),new tt(0,0),new tt(1,0),new tt(1,M)]:[new tt(1,M),new tt(1,1),new tt(0,1),new tt(0,M)],A.push(...R),0===I.length?A.push(C[0]):A.push(...I),{polygon:A.map(L=>new He(L.x,L.y)),unwrapped:!1}}(t,n);if(r)return r;const s=function(l,c){let h=!1,f=-1/0,p=0;for(let _=0;_<l.length-1;_++)l[_].x>f&&(f=l[_].x,p=_);for(let _=0;_<l.length-1;_++){const y=(p+_)%(l.length-1),v=l[y],b=l[y+1];Math.abs(v.x-b.x)>.5&&(v.x<b.x?(v.x+=1,0===y&&(l[l.length-1].x+=1)):(b.x+=1,y+1===l.length-1&&(l[0].x+=1)),h=!0)}const m=Xr(c.center.lng);return h&&m<Math.abs(m-1)&&l.forEach(_=>{_.x-=1}),{polygon:l,unwrapped:h}}(Mc(t,n).map(l=>new tt(oh(l.x),l.y)),n);return{polygon:s.polygon.map(l=>new He(l.x,l.y)),unwrapped:s.unwrapped}}}function Mc(e,t){return rb(e,n=>{const r=t.pointCoordinate3D(n);n.x=r.x,n.y=r.y},1/256)}function oh(e){return e<0?1+e%1:e%1}function I0(e){return 100*e|0}function Pm(e,t,n,r,s){const l=function(c,h){if(c)return s(c);if(h){e.url&&h.tiles&&e.tiles&&delete e.tiles;const f=Ci(Vt(h,e),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);h.vector_layers&&(f.vectorLayers=h.vector_layers,f.vectorLayerIds=f.vectorLayers.map(p=>p.id)),f.tiles=t.canonicalizeTileset(f,e.url),s(null,f)}};return e.url?Dt(t.transformRequest(t.normalizeSourceURL(e.url,null,n,r),dt.Source),l):me.frame(()=>l(null,e))}class Gd{constructor(t,n,r){this.bounds=fi.convert(this.validateBounds(t)),this.minzoom=n||0,this.maxzoom=r||24}validateBounds(t){return Array.isArray(t)&&4===t.length?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const n=Math.pow(2,t.z),r=Math.floor(Xr(this.bounds.getWest())*n),s=Math.floor(Ur(this.bounds.getNorth())*n),l=Math.ceil(Xr(this.bounds.getEast())*n),c=Math.ceil(Ur(this.bounds.getSouth())*n);return t.x>=r&&t.x<l&&t.y>=s&&t.y<c}}class A0{constructor(t,n){this.width=t,this.height=n,this.nextRow=0,this.image=new Hs({width:t,height:n}),this.positions={},this.uploaded=!1}getDash(t,n){const r=this.getKey(t,n);return this.positions[r]}trim(){const t=this.width,n=this.height=un(this.nextRow);this.image.resize({width:t,height:n})}getKey(t,n){return t.join(",")+n}getDashRanges(t,n,r){const s=[];let l=t.length%2==1?-t[t.length-1]*r:0,c=t[0]*r,h=!0;s.push({left:l,right:c,isDash:h,zeroLength:0===t[0]});let f=t[0];for(let p=1;p<t.length;p++){h=!h;const m=t[p];l=f*r,f+=m,c=f*r,s.push({left:l,right:c,isDash:h,zeroLength:0===m})}return s}addRoundDash(t,n,r){const s=n/2;for(let l=-r;l<=r;l++){const c=this.width*(this.nextRow+r+l);let h=0,f=t[h];for(let p=0;p<this.width;p++){p/f.right>1&&(f=t[++h]);const m=Math.abs(p-f.left),_=Math.abs(p-f.right),y=Math.min(m,_);let v;const b=l/r*(s+1);if(f.isDash){const E=s-Math.abs(b);v=Math.sqrt(y*y+E*E)}else v=s-Math.sqrt(y*y+b*b);this.image.data[c+p]=Math.max(0,Math.min(255,v+128))}}}addRegularDash(t,n){for(let f=t.length-1;f>=0;--f){const p=t[f],m=t[f+1];p.zeroLength?t.splice(f,1):m&&m.isDash===p.isDash&&(m.left=p.left,t.splice(f,1))}const r=t[0],s=t[t.length-1];r.isDash===s.isDash&&(r.left=s.left-this.width,s.right=r.right+this.width);const l=this.width*this.nextRow;let c=0,h=t[c];for(let f=0;f<this.width;f++){f/h.right>1&&(h=t[++c]);const p=Math.abs(f-h.left),m=Math.abs(f-h.right),_=Math.min(p,m);this.image.data[l+f]=Math.max(0,Math.min(255,(h.isDash?_:-_)+n+128))}}addDash(t,n){const r=this.getKey(t,n);if(this.positions[r])return this.positions[r];const s="round"===n,l=s?7:0,c=2*l+1;if(this.nextRow+c>this.height)return Y("LineAtlas out of space"),null;0===t.length&&t.push(1);let h=0;for(let m=0;m<t.length;m++)t[m]<0&&(Y("Negative value is found in line dasharray, replacing values with 0"),t[m]=0),h+=t[m];if(0!==h){const m=this.width/h,_=this.getDashRanges(t,this.width,m);s?this.addRoundDash(_,m,l):this.addRegularDash(_,"square"===n?.5*m:0)}const f=this.nextRow+l;this.nextRow+=c;const p={tl:[f,l],br:[h,0]};return this.positions[r]=p,p}}jt(A0,"LineAtlas");class SE{constructor(t){const n={},r=[];for(const h in t){const f=t[h],p=n[h]={};for(const m in f.glyphs){const _=f.glyphs[+m];if(!_||0===_.bitmap.width||0===_.bitmap.height)continue;const y=_.metrics.localGlyph?2:1,v={x:0,y:0,w:_.bitmap.width+2*y,h:_.bitmap.height+2*y};r.push(v),p[m]=v}}const{w:s,h:l}=em(r),c=new Hs({width:s||1,height:l||1});for(const h in t){const f=t[h];for(const p in f.glyphs){const m=f.glyphs[+p];if(!m||0===m.bitmap.width||0===m.bitmap.height)continue;const _=n[h][p],y=m.metrics.localGlyph?2:1;Hs.copy(m.bitmap,c,{x:0,y:0},{x:_.x+y,y:_.y+y},m.bitmap)}}this.image=c,this.positions=n}}jt(SE,"GlyphAtlas");class zA{constructor(t){this.tileID=new tn(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.scope=t.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.promoteId=t.promoteId,this.isSymbolTile=t.isSymbolTile,this.tileTransform=Ml(t.tileID.canonical,t.projection),this.projection=t.projection,this.brightness=t.brightness,this.extraShadowCaster=!!t.extraShadowCaster}parse(t,n,r,s,l){this.status="parsing",this.data=t,this.collisionBoxArray=new i_;const c=new Ab(Object.keys(t.layers).sort()),h=new Py(this.tileID,this.promoteId);h.bucketLayerIDs=[];const f={},p=new A0(256,256),m={featureIndex:h,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:p,availableImages:r,brightness:this.brightness},_=n.familiesBySource[this.source];for(const C in _){const I=t.layers[C];if(!I)continue;let A=!1,M=!1,R=!1;for(const z of _[C])"symbol"===z[0].type?A=!0:M=!0,z[0].is3D()&&"model"!==z[0].type&&(R=!0);if(this.extraShadowCaster&&!R||!0===this.isSymbolTile&&!A||!1===this.isSymbolTile&&!M)continue;1===I.version&&Y(`Vector tile source "${this.source}" layer "${C}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const L=c.encode(C),O=[];for(let z=0;z<I.length;z++){const N=I.feature(z),V=h.getId(N,C);O.push({feature:N,id:V,index:z,sourceLayerIndex:L})}for(const z of _[C]){const N=z[0];(!this.extraShadowCaster||N.is3D()&&"model"!==N.type)&&(void 0!==this.isSymbolTile&&"symbol"===N.type!==this.isSymbolTile||N.minzoom&&this.zoom<Math.floor(N.minzoom)||N.maxzoom&&this.zoom>=N.maxzoom||"none"!==N.visibility&&(P0(z,this.zoom,m.brightness,r),(f[N.id]=N.createBucket({index:h.bucketLayerIDs.length,layers:z,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:L,sourceID:this.source,projection:this.projection.spec})).populate(O,m,this.tileID.canonical,this.tileTransform),h.bucketLayerIDs.push(z.map(V=>V.id))))}}let y,v,b,E;p.trim();const D={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},T=()=>{if(y)return l(y);if(this.extraShadowCaster)this.status="done",l(null,{buckets:yi(f).filter(C=>!C.isEmpty()),featureIndex:h,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:m.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(v&&b&&E){const C=new SE(v),I=new Bu(b,E);for(const A in f){const M=f[A];M instanceof Zu?(P0(M.layers,this.zoom,m.brightness,r),Yb(M,v,C.positions,b,I.iconPositions,this.showCollisionBoxes,r,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):M.hasPattern&&(M instanceof ka||M instanceof xy||M instanceof Ud)&&(P0(M.layers,this.zoom,m.brightness,r),M.addFeatures(m,this.tileID.canonical,I.patternPositions,r,this.tileTransform,this.brightness))}this.status="done",l(null,{buckets:yi(f).filter(A=>!A.isEmpty()),featureIndex:h,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:C.image,lineAtlas:p,imageAtlas:I,brightness:m.brightness})}};if(!this.extraShadowCaster){const C=Zc(m.glyphDependencies,M=>Object.keys(M).map(Number));Object.keys(C).length?s.send("getGlyphs",{uid:this.uid,stacks:C,scope:this.scope},(M,R)=>{y||(y=M,v=R,T())},void 0,!1,D):v={};const I=Object.keys(m.iconDependencies);I.length?s.send("getImages",{icons:I,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(M,R)=>{y||(y=M,b=R,T())},void 0,!1,D):b={};const A=Object.keys(m.patternDependencies);A.length?s.send("getImages",{icons:A,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(M,R)=>{y||(y=M,E=R,T())},void 0,!1,D):E={}}T()}}function P0(e,t,n,r){const s=new Gn(t,{brightness:n});for(const l of e)l.recalculate(s,r)}class CE{constructor(t){this.entries={},this.scheduler=t}request(t,n,r,s){const l=this.entries[t]=this.entries[t]||{callbacks:[]};if(l.result){const[c,h]=l.result;return this.scheduler?this.scheduler.add(()=>{s(c,h)},n):s(c,h),()=>{}}return l.callbacks.push(s),l.cancel||(l.cancel=r((c,h)=>{l.result=[c,h];for(const f of l.callbacks)this.scheduler?this.scheduler.add(()=>{f(c,h)},n):f(c,h);setTimeout(()=>delete this.entries[t],3e3)})),()=>{l.result||(l.callbacks=l.callbacks.filter(c=>c!==s),l.callbacks.length||(l.cancel(),delete this.entries[t]))}}}function ME(e,t,n){const r=JSON.stringify(e.request);return e.data&&(this.deduped.entries[r]={result:[null,e.data]}),this.deduped.request(r,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom},s=>{const l=Pt(e.request,(c,h,f,p)=>{c?s(c):h&&s(null,{vectorTile:n?void 0:new Ey(new Xp(h)),rawData:h,cacheControl:f,expires:p})});return()=>{l.cancel(),s()}},t)}class IE extends xn{constructor(t,n,r,s){if(super(),this.id=t,this.dispatcher=r,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Vt(this,Ci(n,["url","scheme","tileSize","promoteId"])),this._options=Vt({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(s),this._tileWorkers={},this._deduped=new CE}load(t){this._loaded=!1,this.fire(new xt("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,r=this.map._worldview;this._tileJSONRequest=Pm(this._options,this.map._requestManager,n,r,(s,l)=>{this._tileJSONRequest=null,this._loaded=!0,s?(n&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${n}`),r&&2!==r.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${r}`),this.fire(new he(s))):l&&(Vt(this,l),l.bounds&&(this.tileBounds=new Gd(l.bounds,this.minzoom,this.maxzoom)),Ya(l.tiles,this.map._requestManager._customAccessToken),this.fire(new xt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new xt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(s)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=Wn(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Vt({},this._options)}loadTile(t,n){const r=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),s={request:this.map._requestManager.transformRequest(r,dt.Tile),data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:me.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster};if(s.request.collectResourceTiming=this._collectResourceTiming,t.actor&&"expired"!==t.state)"loading"===t.state?t.reloadCallback=n:t.request=t.actor.send("reloadTile",s,l.bind(this));else if(t.actor=this._tileWorkers[r]=this._tileWorkers[r]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",s,l.bind(this),void 0,!0);else{const c=ME.call({deduped:this._deduped},s,(h,f)=>{h||!f?l.call(this,h):(s.data={cacheControl:f.cacheControl,expires:f.expires,rawData:f.rawData.slice(0)},t.actor&&t.actor.send("loadTile",s,l.bind(this),void 0,!0))},!0);t.request={cancel:c}}function l(c,h){return delete t.request,t.aborted?n(null):c&&404!==c.status?n(c):(h&&h.resourceTiming&&(t.resourceTiming=h.resourceTiming),this.map._refreshExpiredTiles&&h&&t.setExpiryData(h),t.loadVectorData(h,this.map.painter),Yc(this.dispatcher),n(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t){t.unloadVectorData(),t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class qd extends xn{constructor(t,n,r,s){super(),this.id=t,this.dispatcher=r,this.setEventedParent(s),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Vt({type:"raster"},n),Vt(this,Ci(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new xt("dataloading",{dataType:"source"})),this._tileJSONRequest=Pm(this._options,this.map._requestManager,null,null,(n,r)=>{this._tileJSONRequest=null,this._loaded=!0,n?this.fire(new he(n)):r&&(Vt(this,r),r.bounds&&(this.tileBounds=new Gd(r.bounds,this.minzoom,this.maxzoom)),Ya(r.tiles),this.fire(new xt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new xt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(n)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=Wn(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Vt({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const r=me.devicePixelRatio>=2,s=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),r,this.tileSize);t.request=Te(this.map._requestManager.transformRequest(s,dt.Tile),(l,c,h,f)=>(delete t.request,t.aborted?(t.state="unloaded",n(null)):l?(t.state="errored",n(l)):c?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:h,expires:f}),t.setTexture(c,this.map.painter),t.state="loaded",Yc(this.dispatcher),void n(null)):n(null)))}static loadTileData(t,n,r){t.setTexture(n,r)}static unloadTileData(t,n){t.texture&&n.saveTileTexture(t.texture)}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n()}unloadTile(t,n){t.texture&&this.map.painter.saveTileTexture(t.texture),n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}let Ic;function OC(){return null!=ag.workerClass?new ag.workerClass:new it.Worker(ag.workerUrl)}const Wd="mapboxgl_preloaded_worker_pool";class $r{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<$r.workerCount;)this.workers.push(new OC);return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.workers&&0===this.numActive()&&(this.workers.forEach(n=>{n.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Wd]}numActive(){return Object.keys(this.active).length}}let Zd;function Ac(){return Zd||(Zd=new $r),Zd}$r.workerCount=2;let jo,R0,ms,L0=null;function Xd(){return _t()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:R0||Ae.DRACO_URL}const O0={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},AE={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Rm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Lm(e,t,n){const r=n.json.bufferViews.length,s=n.buffers.length;t.bufferView=r,n.json.bufferViews[r]={buffer:s,byteLength:e.byteLength},n.buffers[s]=e}const km="KHR_draco_mesh_compression";function FC(e,t){const n=e.extensions&&e.extensions[km];if(!n)return;const r=new ms.Decoder,s=z0(t,n.bufferView),l=new ms.Mesh;if(!r.DecodeArrayToMesh(s,s.byteLength,l))throw new Error("Failed to decode Draco mesh");const c=t.json.accessors[e.indices],h=O0[c.componentType],f=c.count*h.BYTES_PER_ELEMENT,p=ms._malloc(f);h===Uint16Array?r.GetTrianglesUInt16Array(l,f,p):r.GetTrianglesUInt32Array(l,f,p),Lm(ms.memory.buffer.slice(p,p+f),c,t),ms._free(p);for(const m of Object.keys(n.attributes)){const _=r.GetAttributeByUniqueId(l,n.attributes[m]),y=t.json.accessors[e.attributes[m]],v=AE[y.componentType],b=y.count*Rm[y.type]*O0[y.componentType].BYTES_PER_ELEMENT,E=ms._malloc(b);r.GetAttributeDataArrayForAllPoints(l,_,ms[v],b,E),Lm(ms.memory.buffer.slice(E,E+b),y,t),ms._free(E)}r.destroy(),l.destroy(),delete e.extensions[km]}const PE=1179937895,zC=new TextDecoder("utf8");function Om(e,t){return new URL(e,t).href}function F0(e,t,n,r){return fetch(Om(e.uri,r)).then(s=>s.arrayBuffer()).then(s=>{t.buffers[n]=s})}function z0(e,t){const n=e.json.bufferViews[t];return new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function N0(e,t,n,r){if(e.uri){const s=Om(e.uri,r);return fetch(s).then(l=>l.blob()).then(l=>it.createImageBitmap(l)).then(l=>{t.images[n]=l})}if(void 0!==e.bufferView){const s=z0(t,e.bufferView),l=new it.Blob([s],{type:e.mimeType});return it.createImageBitmap(l).then(c=>{t.images[n]=c})}}function Fm(e,t=0,n){const r={json:null,images:[],buffers:[]};if(new Uint32Array(e,t,1)[0]===PE){const p=new Uint32Array(e,t);let m=2;const _=(p[m++]>>2)-3,y=p[m++]>>2;if(m++,r.json=JSON.parse(zC.decode(p.subarray(m,m+y))),m+=y,m<_){const v=p[m++];m++;const b=t+(m<<2);r.buffers[0]=e.slice(b,b+v)}}else r.json=JSON.parse(zC.decode(new Uint8Array(e,t)));const{buffers:s,images:l,meshes:c,extensionsUsed:h}=r.json;let f=Promise.resolve();if(s){const p=[];for(let m=0;m<s.length;m++){const _=s[m];_.uri?p.push(F0(_,r,m,n)):r.buffers[m]||(r.buffers[m]=null)}f=Promise.all(p)}return f.then(()=>{const p=[],m=h&&h.includes(km);if(m&&p.push(function(){if(!ms)return jo||(jo=function(_){let y,v=null;function b(){y=new Uint8Array(v.buffer)}function E(){throw new Error("Unexpected Draco error.")}const D={a:{a:E,d:function(T,C,I){return y.copyWithin(T,C,C+I)},c:function(T){const C=y.length,I=Math.max(T>>>0,Math.ceil(1.2*C)),A=Math.ceil((I-C)/65536);try{return v.grow(A),b(),!0}catch{return!1}},b:E}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(_,D):_.then(T=>T.arrayBuffer()).then(T=>WebAssembly.instantiate(T,D))).then(T=>{const{Rb:C,Qb:I,P:A,T:M,X:R,Ja:L,La:O,Qa:z,Va:N,Wa:V,eb:B,jb:$,f:j,e:Z,yb:K,zb:Q,Ab:W,Bb:X,Db:nt,Gb:ot}=T.instance.exports;v=Z;const lt=(()=>{let ht=0,ft=0,at=0,ut=0;return Et=>{at&&(C(ut),C(ht),ft+=at,at=ht=0),ht||(ft+=128,ht=I(ft));const Ot=Et.length+7&-8;let kt=ht;Ot>=ft&&(at=Ot,kt=ut=I(Ot));for(let zt=0;zt<Et.length;zt++)y[kt+zt]=Et[zt];return kt}})();return b(),j(),{memory:Z,_free:C,_malloc:I,Mesh:class{constructor(){this.ptr=A()}destroy(){M(this.ptr)}},Decoder:class{constructor(){this.ptr=L()}destroy(){$(this.ptr)}DecodeArrayToMesh(ht,ft,at){const ut=lt(ht),Et=O(this.ptr,ut,ft,at.ptr);return!!R(Et)}GetAttributeByUniqueId(ht,ft){return{ptr:z(this.ptr,ht.ptr,ft)}}GetTrianglesUInt16Array(ht,ft,at){N(this.ptr,ht.ptr,ft,at)}GetTrianglesUInt32Array(ht,ft,at){V(this.ptr,ht.ptr,ft,at)}GetAttributeDataArrayForAllPoints(ht,ft,at,ut,Et){B(this.ptr,ht.ptr,ft.ptr,at,ut,Et)}},DT_INT8:K(),DT_UINT8:Q(),DT_INT16:W(),DT_UINT16:X(),DT_UINT32:nt(),DT_FLOAT32:ot()}})}(fetch(Xd())),jo.then(_=>{ms=_,jo=void 0}))}()),l)for(let _=0;_<l.length;_++)p.push(N0(l[_],r,_,n));return(p.length?Promise.all(p):Promise.resolve()).then(()=>{if(m&&c)for(const{primitives:_}of c)for(const y of _)FC(y,r);return r})})}function RE(e){return fetch(e).then(t=>t.arrayBuffer()).then(t=>Fm(t,0,e))}class LE{constructor(t,n,r){if(this.triangleCount=n.length/3,this.min=new tt(0,0),this.max=new tt(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===t.length||0===r)return;const s=t.map(m=>m.x),l=t.map(m=>m.y);this.min=new tt(Math.min(...s),Math.min(...l)),this.max=new tt(Math.max(...s),Math.max(...l));const c=this.max.sub(this.min);c.x=Math.max(c.x,1),c.y=Math.max(c.y,1);const h=Math.max(c.x,c.y)/r;this.cellsX=Math.max(1,Math.ceil(c.x/h)),this.cellsY=Math.max(1,Math.ceil(c.y/h)),this.xScale=1/h,this.yScale=1/h;const f=[];for(let m=0;m<this.triangleCount;m++){const _=t[n[3*m+0]].sub(this.min),y=t[n[3*m+1]].sub(this.min),v=t[n[3*m+2]].sub(this.min),b=Pl(Math.floor(Math.min(_.x,y.x,v.x)),this.xScale,this.cellsX),E=Pl(Math.floor(Math.max(_.x,y.x,v.x)),this.xScale,this.cellsX),D=Pl(Math.floor(Math.min(_.y,y.y,v.y)),this.yScale,this.cellsY),T=Pl(Math.floor(Math.max(_.y,y.y,v.y)),this.yScale,this.cellsY),C=new tt(0,0),I=new tt(0,0),A=new tt(0,0),M=new tt(0,0);for(let R=D;R<=T;++R){C.y=I.y=R*h,A.y=M.y=(R+1)*h;for(let L=b;L<=E;++L)C.x=A.x=L*h,I.x=M.x=(L+1)*h,(oy(_,y,v,C,I,M)||oy(_,y,v,C,M,A))&&f.push({cellIdx:R*this.cellsX+L,triIdx:m})}}if(0===f.length)return;f.sort((m,_)=>m.cellIdx-_.cellIdx||m.triIdx-_.triIdx);let p=0;for(;p<f.length;){const m=f[p].cellIdx,_={start:this.payload.length,len:0};for(;p<f.length&&f[p].cellIdx===m;)++_.len,this.payload.push(f[p++].triIdx);this.cells[m]=_}}query(t,n,r){if(0===this.triangleCount||0===this.cells.length||t.x>this.max.x||this.min.x>n.x||t.y>this.max.y||this.min.y>n.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let f=0;f<this.lookup.length;f++)this.lookup[f]=0;const s=Pl(t.x-this.min.x,this.xScale,this.cellsX),l=Pl(n.x-this.min.x,this.xScale,this.cellsX),c=Pl(t.y-this.min.y,this.yScale,this.cellsY),h=Pl(n.y-this.min.y,this.yScale,this.cellsY);for(let f=c;f<=h;f++)for(let p=s;p<=l;p++){const m=this.cells[f*this.cellsX+p];if(m)for(let _=0;_<m.len;_++){const y=this.payload[m.start+_],v=Math.floor(y/8),b=1<<y%8;if(!(this.lookup[v]&b)&&(this.lookup[v]|=b,r.push(y),r.length===this.triangleCount))return}}}}function Pl(e,t,n){return Math.max(0,Math.min(n-1,Math.floor(e*t)))}function Pc(e,t){const n=e.json.bufferViews[t.bufferView];return new O0[t.componentType](e.buffers[n.buffer],(t.byteOffset||0)+(n.byteOffset||0),t.count*Rm[t.type])}function kE(e,t,n){const r=e.indices,s=e.attributes,l={};l.indexArray=new er;const c=t.json.accessors[r],h=c.count/3;l.indexArray.reserve(h);const f=Pc(t,c);for(let y=0;y<h;y++)l.indexArray.emplaceBack(f[3*y],f[3*y+1],f[3*y+2]);l.indexArray._trim(),l.vertexArray=new Fs;const p=t.json.accessors[s.POSITION];l.vertexArray.reserve(p.count);const m=Pc(t,p);for(let y=0;y<p.count;y++)l.vertexArray.emplaceBack(m[3*y],m[3*y+1],m[3*y+2]);if(l.vertexArray._trim(),l.aabb=new Tn(p.min,p.max),l.centroid=function(y,v){const b=[0,0,0],E=y.length;if(E>0){for(let D=0;D<E;D++){const T=3*y[D];b[0]+=v[T],b[1]+=v[T+1],b[2]+=v[T+2]}b[0]/=E,b[1]/=E,b[2]/=E}return b}(f,m),void 0!==s.COLOR_0){const y=t.json.accessors[s.COLOR_0],v=Rm[y.type];if(5126===y.componentType){l.colorArray=3===v?new Fs:new Os,l.colorArray.reserve(y.count);const b=Pc(t,y);if(3===v)for(let E=0;E<y.count;E++)l.colorArray.emplaceBack(b[3*E],b[3*E+1],b[3*E+2]);else for(let E=0;E<y.count;E++)l.colorArray.emplaceBack(b[4*E],b[4*E+1],b[4*E+2],b[4*E+3]);l.colorArray._trim()}else if(5123===y.componentType&&4===v){l.colorArray=new Os,l.colorArray.resize(y.count);const b=Pc(t,y),E=1/65535,D=l.colorArray.float32;for(let T=0;T<4*b.length;++T)D[T]=b[T]*E}else Y(`glTF color buffer parsing for accessor ${JSON.stringify(y)} is not supported`)}if(void 0!==s.NORMAL){l.normalArray=new Fs;const y=t.json.accessors[s.NORMAL];l.normalArray.reserve(y.count);const v=Pc(t,y);for(let b=0;b<y.count;b++)l.normalArray.emplaceBack(v[3*b],v[3*b+1],v[3*b+2]);l.normalArray._trim()}if(void 0!==s.TEXCOORD_0&&n.length>0){l.texcoordArray=new Jh;const y=t.json.accessors[s.TEXCOORD_0];l.texcoordArray.reserve(y.count);const v=Pc(t,y);for(let b=0;b<y.count;b++)l.texcoordArray.emplaceBack(v[2*b],v[2*b+1]);l.texcoordArray._trim()}const _=e.material;return l.material=function(y,v){const{emissiveFactor:b=[0,0,0],alphaMode:E="OPAQUE",alphaCutoff:D=.5,normalTexture:T,occlusionTexture:C,emissiveTexture:I,doubleSided:A}=y,{baseColorFactor:M=[1,1,1,1],metallicFactor:R=1,roughnessFactor:L=1,baseColorTexture:O,metallicRoughnessTexture:z}=y.pbrMetallicRoughness||{};return{pbrMetallicRoughness:{baseColorFactor:new le(...M),metallicFactor:R,roughnessFactor:L,baseColorTexture:O?v[O.index]:void 0,metallicRoughnessTexture:z?v[z.index]:void 0},doubleSided:A,emissiveFactor:b,alphaMode:E,alphaCutoff:D,normalTexture:T?v[T.index]:void 0,occlusionTexture:C?v[C.index]:void 0,emissionTexture:I?v[I.index]:void 0,defined:void 0===y.defined}}(void 0!==_?t.json.materials[_]:{defined:!1},n),void 0!==s._FEATURE_RGBA4444&&(l.featureData=new Uint32Array(Pc(t,t.json.accessors[s._FEATURE_RGBA4444]).buffer)),l}function zm(e,t,n){const{matrix:r,rotation:s,translation:l,scale:c,mesh:h,extras:f,children:p}=e,m={};if(m.matrix=r||et.fromRotationTranslationScale([],s||[0,0,0,1],l||[0,0,0],c||[1,1,1]),void 0!==h){m.meshes=n[h];const _=m.anchor=[0,0];for(const y of m.meshes){const{min:v,max:b}=y.aabb;_[0]+=v[0]+b[0],_[1]+=v[1]+b[1]}_[0]=Math.floor(_[0]/m.meshes.length/2),_[1]=Math.floor(_[1]/m.meshes.length/2)}if(f&&(f.id&&(m.id=f.id),f.lights&&(m.lights=function(_){if(!_.length)return[];const y=function(T){const C=atob(T),I=new Uint8Array(C.length);for(let A=0;A<C.length;A++)I[A]=C.codePointAt(A);return I}(_),v=[],b=y.length/24,E=new Uint16Array(y.buffer),D=new Float32Array(y.buffer);for(let T=0;T<b;T++){const C=E[2*T*6]/30,I=E[2*T*6+1]/30,A=E[2*T*6+10]/100,M=D[6*T+1],R=D[6*T+2],L=D[6*T+3],O=D[6*T+4],z=L-M,N=O-R,V=Math.hypot(z,N);v.push({pos:[M+.5*z,R+.5*N,I],normal:[N/V,-z/V,0],width:V,height:C,depth:A,points:[M,R,L,O]})}return v}(f.lights))),p){const _=[];for(const y of p)_.push(zm(t.json.nodes[y],t,n));m.children=_}return m}function B0(e){if(0===e.vertices.length||0===e.indices.length)return null;const[t,n]=[e.vertices[0].clone(),e.vertices[0].clone()];for(let c=1;c<e.vertices.length;++c){const h=e.vertices[c];t.x=Math.min(t.x,h.x),t.y=Math.min(t.y,h.y),n.x=Math.max(n.x,h.x),n.y=Math.max(n.y,h.y)}const r=Math.ceil(Math.max(n.x-t.x,n.y-t.y)/256),s=Math.max(8,r),l=new LE(e.vertices,e.indices,s);return{vertices:e.vertices,indices:e.indices,grid:l,min:t,max:n}}function NC(e){if(!e.extras||!e.extras.ground)return null;const t=e.extras.ground;if(!t||!Array.isArray(t)||0===t.length)return null;const n=t[0];if(!n||!Array.isArray(n)||0===n.length)return null;const r=[];for(const c of n){if(!Array.isArray(c)||2!==c.length)continue;const h=c[0],f=c[1];"number"==typeof h&&"number"==typeof f&&r.push(new tt(h,f))}if(r.length<3)return null;r.length>1&&r[r.length-1].equals(r[0])&&r.pop();let s=0;for(let c=0;c<r.length;c++){const h=r[c],f=r[(c+1)%r.length],p=r[(c+2)%r.length];s+=(h.x-f.x)*(p.y-f.y)-(p.x-f.x)*(h.y-f.y)}s>0&&r.reverse();const l=yy(r.flatMap(c=>[c.x,c.y]),[]);return 0===l.length?null:{vertices:r,indices:l}}function j0(e){const t=[],n=[];let r=0;for(const s of e){r=t.length;const l=s.vertexArray.float32,c=s.indexArray.uint16;for(let h=0;h<s.vertexArray.length;h++)t.push(new tt(l[3*h+0],l[3*h+1]));for(let h=0;h<3*s.indexArray.length;h++)n.push(c[h]+r)}if(n.length%3!=0)return null;for(let s=0;s<n.length;s+=3){const l=t[n[s+0]],c=t[n[s+1]],h=t[n[s+2]];(l.x-c.x)*(h.y-c.y)-(h.x-c.x)*(l.y-c.y)>0&&([n[s+1],n[s+2]]=[n[s+2],n[s+1]])}return{vertices:t,indices:n}}function Yd(e){const n=function(f,p){const m=[];for(const _ of f.json.meshes){const y=[];for(const v of _.primitives)y.push(kE(v,f,p));m.push(y)}return m}(e,function(f,p){const m=[],_=it.WebGL2RenderingContext;if(f.json.textures)for(const y of f.json.textures){const v={magFilter:_.LINEAR,minFilter:_.NEAREST,wrapS:_.REPEAT,wrapT:_.REPEAT};void 0!==y.sampler&&Object.assign(v,f.json.samplers[y.sampler]),m.push({image:p[y.source],sampler:v,uploaded:!1})}return m}(e,e.images)),{scenes:r,scene:s,nodes:l}=e.json,c=r?r[s||0].nodes:l,h=[];for(const f of c)h.push(zm(l[f],e,n));return function(f,p,m){const _={},y=new Set;for(let v=0;v<f.length;v++){const b=m[p[v]];if(!b.extras)continue;const E=b.extras["mapbox:footprint:version"],D=b.extras["mapbox:footprint:id"];(E||D)&&y.add(v),"1.0.0"===E&&D&&(_[D]=v)}for(let v=0;v<f.length;v++){if(y.has(v))continue;const b=f[v],E=m[p[v]];if(!E.extras)continue;let D=null;b.id in _&&(D=j0(f[_[b.id]].meshes)),D||(D=NC(E)),D&&(b.footprint=B0(D))}if(y.size>0){const v=Array.from(y.values()).sort((b,E)=>b-E);for(let b=v.length-1;b>=0;b--)f.splice(v[b],1)}}(h,c,e.json.nodes),h}function BC(e){e.heightmap=new Float32Array(4096),e.heightmap.fill(-1);const t=e.vertexArray.float32,n=e.aabb.min[0]-1,r=e.aabb.min[1]-1,s=64/(e.aabb.max[0]-n+2),l=64/(e.aabb.max[1]-r+2);for(let c=0;c<t.length;c+=3){const h=t[c+2],f=(t[c+0]-n)*s|0,p=(t[c+1]-r)*l|0;h>e.heightmap[64*p+f]&&(e.heightmap[64*p+f]=h)}}function OE(e,t){const n={};n.indexArray=new er,n.indexArray.reserve(4*e.length),n.vertexArray=new Fs,n.vertexArray.reserve(10*e.length),n.colorArray=new Os,n.vertexArray.reserve(10*e.length);let r=0;for(const c of e){const h=Math.min(10,Math.max(4,1.3*c.height))*t,f=[-c.normal[1],c.normal[0],0],p=Math.min(.29,.1*c.width/c.depth),m=c.width-2*c.depth*t*(p+.01),_=H.scaleAndAdd([],c.pos,f,m/2),y=H.scaleAndAdd([],c.pos,f,-m/2),v=[_[0],_[1],_[2]+c.height],b=[y[0],y[1],y[2]+c.height],E=H.scaleAndAdd([],c.normal,f,p);H.scale(E,E,h);const D=H.scaleAndAdd([],c.normal,f,-p);H.scale(D,D,h),H.add(E,_,E),H.add(D,y,D),_[2]+=.1,y[2]+=.1,n.vertexArray.emplaceBack(E[0],E[1],E[2]),n.vertexArray.emplaceBack(D[0],D[1],D[2]),n.vertexArray.emplaceBack(_[0],_[1],_[2]),n.vertexArray.emplaceBack(y[0],y[1],y[2]),n.vertexArray.emplaceBack(v[0],v[1],v[2]),n.vertexArray.emplaceBack(b[0],b[1],b[2]),n.vertexArray.emplaceBack(_[0],_[1],_[2]),n.vertexArray.emplaceBack(y[0],y[1],y[2]),n.vertexArray.emplaceBack(E[0],E[1],E[2]),n.vertexArray.emplaceBack(D[0],D[1],D[2]);const T=m/h/2;n.colorArray.emplaceBack(-T-p,-1,T,.8),n.colorArray.emplaceBack(T+p,-1,T,.8),n.colorArray.emplaceBack(-T,0,T,1.3),n.colorArray.emplaceBack(T,0,T,1.3),n.colorArray.emplaceBack(T+p,-.8,T,.7),n.colorArray.emplaceBack(T+p,-.8,T,.7),n.colorArray.emplaceBack(0,0,T,1.3),n.colorArray.emplaceBack(0,0,T,1.3),n.colorArray.emplaceBack(T+p,-1.2,T,.8),n.colorArray.emplaceBack(T+p,-1.2,T,.8),n.indexArray.emplaceBack(6+r,4+r,8+r),n.indexArray.emplaceBack(7+r,9+r,5+r),n.indexArray.emplaceBack(0+r,1+r,2+r),n.indexArray.emplaceBack(1+r,3+r,2+r),r+=10}const s={defined:!0,emissiveFactor:[0,0,0]},l={};return l.baseColorFactor=le.white,s.pbrMetallicRoughness=l,n.material=s,n.aabb=new Tn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}jt(LE,"TriangleGridIndex");const Nm={vector:IE,raster:qd,"raster-dem":class extends qd{constructor(e,t,n,r){super(e,t,n,r),this.type="raster-dem",this.maxzoom=22,this._options=Vt({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(e,t){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);e.request=Te(this.map._requestManager.transformRequest(n,dt.Tile),function(l,c,h,f){if(delete e.request,e.aborted)e.state="unloaded",t(null);else if(l)e.state="errored",t(l);else if(c){this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:h,expires:f});const m=it.ImageBitmap&&c instanceof it.ImageBitmap&&(null==Ic&&(Ic=it.OffscreenCanvas&&new it.OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof it.createImageBitmap),Ic),_=1-(c.width-((p=c.width)<=1?1:Math.pow(2,Math.floor(Math.log(p)/Math.LN2))))/2;_<1||e.neighboringTiles||(e.neighboringTiles=this._getNeighboringTiles(e.tileID));const y=m?c:me.getImageData(c,_),v={uid:e.uid,coord:e.tileID,source:this.id,scope:this.scope,rawImageData:y,encoding:this.encoding,padding:_,convertToFloat:r};e.actor&&"expired"!==e.state||(e.actor=this.dispatcher.getActor(),e.actor.send("loadDEMTile",v,s.bind(this),void 0,!0))}var p}.bind(this));const r=this.map?.painter?.terrainUseFloatDEM();function s(l,c){l&&(e.state="errored",t(l)),c&&(e.dem=c,e.dem.onDeserialize(),e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0,e.state="loaded",t(null))}}_getNeighboringTiles(e){const t=e.canonical,n=Math.pow(2,t.z),r=(t.x-1+n)%n,s=0===t.x?e.wrap-1:e.wrap,l=(t.x+1+n)%n,c=t.x+1===n?e.wrap+1:e.wrap,h={};return h[new tn(e.overscaledZ,s,t.z,r,t.y).key]={backfilled:!1},h[new tn(e.overscaledZ,c,t.z,l,t.y).key]={backfilled:!1},t.y>0&&(h[new tn(e.overscaledZ,s,t.z,r,t.y-1).key]={backfilled:!1},h[new tn(e.overscaledZ,e.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},h[new tn(e.overscaledZ,c,t.z,l,t.y-1).key]={backfilled:!1}),t.y+1<n&&(h[new tn(e.overscaledZ,s,t.z,r,t.y+1).key]={backfilled:!1},h[new tn(e.overscaledZ,e.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},h[new tn(e.overscaledZ,c,t.z,l,t.y+1).key]={backfilled:!1}),h}unloadTile(e){e.demTexture&&this.map.painter.saveTileTexture(e.demTexture),e.hillshadeFBO&&(e.hillshadeFBO.destroy(),delete e.hillshadeFBO),e.dem&&delete e.dem,delete e.neighboringTiles,e.state="unloaded"}},geojson:class extends xn{constructor(e,t,n,r){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(r),this._data=t.data,this._options=Vt({},t),this._collectResourceTiming=t.collectResourceTiming,void 0!==t.maxzoom&&(this.maxzoom=t.maxzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const s=st/this.tileSize;this.workerOptions=Vt({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(void 0!==t.buffer?t.buffer:128)*s,tolerance:(void 0!==t.tolerance?t.tolerance:.375)*s,extent:st,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:void 0!==t.clusterMaxZoom?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:st,radius:(void 0!==t.clusterRadius?t.clusterRadius:50)*s,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter},t.workerOptions)}onAdd(e){this.map=e,this.setData(this._data)}setData(e){return this._data=e,this._updateWorkerData(),this}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterLeaves(e,t,n,r){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:e,limit:t,offset:n},r),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new xt("dataloading",{dataType:"source"})),this._loaded=!1;const e=Vt({},this.workerOptions);e.scope=this.scope;const t=this._data;"string"==typeof t?(e.request=this.map._requestManager.transformRequest(me.resolveURL(t),dt.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(t),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,(n,r)=>{if(this._loaded=!0,this._pendingLoad=null,n)this.fire(new he(n));else{const s={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&r&&r.resourceTiming&&r.resourceTiming[this.id]&&(s.resourceTiming=r.resourceTiming[this.id]),this.fire(new xt("data",s)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(e,t){const n=e.actor?"reloadTile":"loadTile";e.actor=this.actor;const r={type:this.type,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:me.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};e.request=this.actor.send(n,r,(s,l)=>(delete e.request,e.unloadVectorData(),e.aborted?t(null):s?t(s):(e.loadVectorData(l,this.map.painter,"reloadTile"===n),t(null))),void 0,"loadTile"===n)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0}unloadTile(e){e.unloadVectorData(),this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Vt({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Do{constructor(e,t,n,r){super(e,t,n,r),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const e=this.options;this.urls=[];for(const t of e.urls)this.urls.push(this.map._requestManager.transformRequest(t,dt.Source).url);!function(t,n){const r=it.document.createElement("video");r.muted=!0,r.onloadstart=function(){n(null,r)};for(let s=0;s<t.length;s++){const l=it.document.createElement("source");Ft(t[s])||(r.crossOrigin="Anonymous"),l.src=t[s],r.appendChild(l)}}(this.urls,(t,n)=>{this._loaded=!0,t?this.fire(new he(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const t=this.video.seekable;e<t.start(0)||e>t.end(0)?this.fire(new he(new Ut(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const e=this.map.painter.context,t=e.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new pr(e,this.video,t.RGBA),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(e)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Do,model:class extends xn{constructor(e,t,n,r){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const e=[];for(const t in this._options.models){const n=this._options.models[t],r=RE(this.map._requestManager.transformRequest(n.uri,dt.Model).url).then(s=>{if(!s)return;const l=Yd(s),c=new Uw(t,n.position,n.orientation,l);c.computeBoundsAndApplyParent(),this.models.push(c)}).catch(s=>{this.fire(new he(new Error(`Could not load model ${t} from ${n.uri}: ${s.message}`)))});e.push(r)}return Promise.allSettled(e).then(()=>{this._loaded=!0,this.fire(new xt("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this.fire(new he(new Error(`Could not load models: ${t.message}`)))})}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,t){}serialize(){return{type:"model"}}},"batched-model":class extends xn{constructor(e,t,n,r){super(),this.type="batched-model",this.id=e,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(r)}onAdd(e){this.map=e,this.load()}load(e){this._loaded=!1,this.fire(new xt("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map._worldview;this._tileJSONRequest=Pm(this._options,this.map._requestManager,t,n,(r,s)=>{this._tileJSONRequest=null,this._loaded=!0,r?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),n&&2!==n.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new he(r))):s&&(Vt(this,s),s.bounds&&(this.tileBounds=new Gd(s.bounds,this.minzoom,this.maxzoom)),Ya(s.tiles,this.map._requestManager._customAccessToken),this.fire(new xt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new xt("data",{dataType:"source",sourceDataType:"content"}))),e&&e(r)})}hasTransition(){return!1}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loaded(){return this._loaded}loadTile(e,t){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),r={request:this.map._requestManager.transformRequest(n,dt.Tile),data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:e.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(e.actor&&"expired"!==e.state)if("loading"===e.state)e.reloadCallback=t;else{if(e.buckets){const l=Object.values(e.buckets);for(const c of l)c.dirty=!0;return void(e.state="loaded")}e.request=e.actor.send("reloadTile",r,s.bind(this))}else e.actor=this.dispatcher.getActor(),e.request=e.actor.send("loadTile",r,s.bind(this),void 0,!0);function s(l,c){return e.aborted?t(null):l&&404!==l.status?t(l):(c&&(c.resourceTiming&&(e.resourceTiming=c.resourceTiming),this.map._refreshExpiredTiles&&e.setExpiryData(c),e.buckets={...e.buckets,...c.buckets}),e.state="loaded",void t(null))}}serialize(){return Vt({},this._options)}},canvas:class extends Do{constructor(e,t,n,r){super(e,t,n,r),t.coordinates?Array.isArray(t.coordinates)&&4===t.coordinates.length&&!t.coordinates.some(s=>!Array.isArray(s)||2!==s.length||s.some(l=>"number"!=typeof l))||this.fire(new he(new Ut(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new he(new Ut(`sources.${e}`,null,'missing required property "coordinates"'))),t.animate&&"boolean"!=typeof t.animate&&this.fire(new he(new Ut(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),t.canvas?"string"==typeof t.canvas||t.canvas instanceof it.HTMLCanvasElement||this.fire(new he(new Ut(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new he(new Ut(`sources.${e}`,null,'missing required property "canvas"'))),this.options=t,this.animate=void 0===t.animate||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof it.HTMLCanvasElement?this.options.canvas:it.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new he(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions()||0===Object.keys(this.tiles).length)return;const t=this.map.painter.context;this.texture?!e&&!this._playing||this.texture instanceof pm||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new pr(t,this.canvas,t.gl.RGBA,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}},custom:class extends xn{constructor(e,t,n,r){super(),this.id=e,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(r),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new he(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new he(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Gd(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Vt(this,Ci(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return Ci(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new xt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new xt("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(e){this._map=e,this._loaded=!1,this.fire(new xt("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(e),this.load()}onRemove(e){this._implementation.onRemove&&this._implementation.onRemove(e)}hasTile(e){if(this._implementation.hasTile){const{x:t,y:n,z:r}=e.canonical;return this._implementation.hasTile({x:t,y:n,z:r})}return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,t){const{x:n,y:r,z:s}=e.tileID.canonical,l=new it.AbortController;e.request=Promise.resolve(this._implementation.loadTile({x:n,y:r,z:s},{signal:l.signal})).then(function(c){return delete e.request,e.aborted?(e.state="unloaded",t(null)):void 0===c?(e.state="errored",t(null)):null===c?(this.loadTileData(e,{width:this.tileSize,height:this.tileSize,data:null}),e.state="loaded",t(null)):(h=c)instanceof it.ImageData||h instanceof it.HTMLCanvasElement||h instanceof it.ImageBitmap||h instanceof it.HTMLImageElement?(this.loadTileData(e,c),e.state="loaded",void t(null)):(e.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)));var h}.bind(this)).catch(c=>{20!==c.code&&(e.state="errored",t(c))}),e.request.cancel=()=>l.abort()}loadTileData(e,t){qd.loadTileData(e,t,this._map.painter)}unloadTileData(e){qd.unloadTileData(e,this._map.painter)}unloadTile(e,t){if(this.unloadTileData(e),this._implementation.unloadTile){const{x:n,y:r,z:s}=e.tileID.canonical;this._implementation.unloadTile({x:n,y:r,z:s})}t()}abortTile(e,t){e.request&&e.request.cancel&&(e.request.cancel(),delete e.request),t()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(e=>({x:e.canonical.x,y:e.canonical.y,z:e.canonical.z}))}_clearTiles(){const e=Wn(this.id,this.scope);this._map.style.clearSource(e)}_update(){this.fire(new xt("data",{dataType:"source",sourceDataType:"content"}))}}},V0=function(e,t,n,r){const s=new Nm[t.type](e,t,n,r);if(s.id!==e)throw new Error(`Expected Source id to be ${e} instead of ${s.id}`);return Rr(["load","abort","unload","serialize","prepare"],s),s};function FE(e,t){const n=et.identity([]);return et.scale(n,n,[.5*e.width,.5*-e.height,1]),et.translate(n,n,[1,-1,0]),et.multiply(n,n,e.calculateProjMatrix(t.toUnwrapped())),Float32Array.from(n)}function jC(e,t,n,r,s,l,c,h=!1){const f=e.tilesIn(r,c,h);f.sort(Rc);const p=[];for(const _ of f)p.push({wrappedTileID:_.tile.tileID.wrapped().key,queryResults:_.tile.queryRenderedFeatures(t,n,e._state,_,s,l,FE(e.transform,_.tile.tileID),h)});const m=function(_){const y={},v={};for(const b of _){const E=b.queryResults,D=b.wrappedTileID,T=v[D]=v[D]||{};for(const C in E){const I=E[C],A=T[C]=T[C]||{},M=y[C]=y[C]||[];for(const R of I)A[R.featureIndex]||(A[R.featureIndex]=!0,M.push(R))}}return y}(p);for(const _ in m)m[_].forEach(y=>{const v=y.feature,b=v.layer;b&&"background"!==b.type&&"sky"!==b.type&&"slot"!==b.type&&(v.source=b.source,b["source-layer"]&&(v.sourceLayer=b["source-layer"]),v.state=void 0!==v.id?e.getFeatureState(b["source-layer"],v.id):{})});return m}function $i(e,t){const n=e.getRenderableIds().map(l=>e.getTileByID(l)),r=[],s={};for(let l=0;l<n.length;l++){const c=n[l],h=c.tileID.canonical.key;s[h]||(s[h]=!0,c.querySourceFeatures(r,t))}return r}function Rc(e,t){const n=e.tileID,r=t.tileID;return n.overscaledZ-r.overscaledZ||n.canonical.y-r.canonical.y||n.wrap-r.wrap||n.canonical.x-r.canonical.x}class VC{constructor(t){this.style=t}processLayersChanged(){this.layers=[];for(const t in this.style._mergedLayers){const n=this.style._mergedLayers[t];if("fill-extrusion"===n.type)this.layers.push(n);else if("model"===n.type){const r=this.style.getLayerSource(n);r&&"batched-model"===r.type&&this.layers.push(n)}}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(let s=0;s<this.layers.length;++s){const l=this.layers[s],c=this.style.getLayerSourceCache(l);let h=1;"fill-extrusion"===l.type&&(h=l.paint.get("fill-extrusion-opacity")>0?l.paint.get("fill-extrusion-vertical-scale"):0);let f=c?c.getTile(n):null;if(!f&&c&&n.canonical.z>c.getSource().minzoom){let p=n.scaledTo(Math.min(c.getSource().maxzoom,n.overscaledZ-1));for(;p.overscaledZ>=c.getSource().minzoom&&(f=c.getTile(p),!f&&0!==p.overscaledZ);)p=p.scaledTo(p.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:f?f.getBucket(l):null,tileID:f?f.tileID:n,verticalScale:h})}t.hasAnyZOffset=!1;let r=!1;for(let s=0;s<t.symbolInstances.length;s++){const l=t.symbolInstances.get(s),c=l.zOffset,h=this._getHeightAtTileOffset(n,l.tileAnchorX,l.tileAnchorY);l.zOffset=-1!==h?h:c,r||c===l.zOffset||(r=!0),t.hasAnyZOffset||0===l.zOffset||(t.hasAnyZOffset=!0)}r&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,r,s){let l=n,c=r;if(t.canonical.z!==s.canonical.z){const h=s.canonical,f=1/(1<<t.canonical.z-h.z);l=(n+t.canonical.x*st)*f-h.x*st|0,c=(r+t.canonical.y*st)*f-h.y*st|0}return{tileX:l,tileY:c}}_getHeightAtTileOffset(t,n,r){let s;for(let l=0;l<this.layers.length;++l){if("fill-extrusion"!==this.layers[l].type)continue;const{bucket:c,tileID:h,verticalScale:f}=this.currentBuildingBuckets[l];if(!c)continue;const{tileX:p,tileY:m}=this._mapCoordToOverlappingTile(t,n,r,h),_=c.getHeightAtTileCoord(p,m);if(_&&void 0!==_.height){if(!_.hidden)return _.height*f;s=_.height}}for(let l=0;l<this.layers.length;++l){if("model"!==this.layers[l].type)continue;const{bucket:c,tileID:h}=this.currentBuildingBuckets[l];if(!c)continue;const{tileX:f,tileY:p}=this._mapCoordToOverlappingTile(t,n,r,h),m=c.getHeightAtTileCoord(f,p);if(m&&!m.hidden)return void 0===m.height&&void 0!==s?Math.min(m.maxHeight,s)*m.verticalScale:(m.height||0)*m.verticalScale}return-1}}var zE=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function NA(e,t){const n={};for(const r in e)"ref"!==r&&(n[r]=e[r]);return zE.forEach(r=>{r in t&&(n[r]=t[r])}),n}function UC(e){e=e.slice();const t=Object.create(null);for(let n=0;n<e.length;n++)t[e[n].id]=e[n];for(let n=0;n<e.length;n++)"ref"in e[n]&&(e[n]=NA(e[n],t[e[n].ref]));return e}const en={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",setImportUrl:"setImportUrl",setImportData:"setImportData",setImportConfig:"setImportConfig"};function U0(e,t,n){n.push({command:en.addSource,args:[e,t[e]]})}function sh(e,t,n){t.push({command:en.removeSource,args:[e]}),n[e]=!0}function $C(e,t,n,r){sh(e,n,r),U0(e,t,n)}function $0(e,t,n){let r;for(r in e[n])if(e[n].hasOwnProperty(r)&&"data"!==r&&!Ke(e[n][r],t[n][r]))return!1;for(r in t[n])if(t[n].hasOwnProperty(r)&&"data"!==r&&!Ke(e[n][r],t[n][r]))return!1;return!0}function Bm(e,t,n,r,s,l){let c;for(c in t=t||{},e=e||{})e.hasOwnProperty(c)&&(Ke(e[c],t[c])||n.push({command:l,args:[r,c,t[c],s]}));for(c in t)t.hasOwnProperty(c)&&!e.hasOwnProperty(c)&&(Ke(e[c],t[c])||n.push({command:l,args:[r,c,t[c],s]}))}function Kd(e){return e.id}function jm(e,t){return e[t.id]=t,e}class HC{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let r=1;r<this.points.length;r++)this._distances[r]=this._distances[r-1]+this.points[r].dist(this.points[r-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(1===this.points.length)return this.points[0];t=Gt(t,0,1);let n=1,r=this._distances[n];const s=t*this.paddedLength+this.padding;for(;r<s&&n<this._distances.length;)r=this._distances[++n];const l=n-1,c=this._distances[l],h=r-c,f=h>0?(s-c)/h:0;return this.points[l].mult(1-f).add(this.points[n].mult(f))}}class NE{constructor(t,n,r){const s=this.boxCells=[],l=this.circleCells=[];this.xCellCount=Math.ceil(t/r),this.yCellCount=Math.ceil(n/r);for(let c=0;c<this.xCellCount*this.yCellCount;c++)s.push([]),l.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,r,s,l){this._forEachCell(n,r,s,l,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(r),this.bboxes.push(s),this.bboxes.push(l)}insertCircle(t,n,r,s){this._forEachCell(n-s,r-s,n+s,r+s,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(r),this.circles.push(s)}_insertBoxCell(t,n,r,s,l,c){this.boxCells[l].push(c)}_insertCircleCell(t,n,r,s,l,c){this.circleCells[l].push(c)}_query(t,n,r,s,l,c){if(r<0||t>this.width||s<0||n>this.height)return!l&&[];const h=[];if(t<=0&&n<=0&&this.width<=r&&this.height<=s){if(l)return!0;for(let f=0;f<this.boxKeys.length;f++)h.push({key:this.boxKeys[f],x1:this.bboxes[4*f],y1:this.bboxes[4*f+1],x2:this.bboxes[4*f+2],y2:this.bboxes[4*f+3]});for(let f=0;f<this.circleKeys.length;f++){const p=this.circles[3*f],m=this.circles[3*f+1],_=this.circles[3*f+2];h.push({key:this.circleKeys[f],x1:p-_,y1:m-_,x2:p+_,y2:m+_})}return c?h.filter(c):h}return this._forEachCell(t,n,r,s,this._queryCell,h,{hitTest:l,seenUids:{box:{},circle:{}}},c),l?h.length>0:h}_queryCircle(t,n,r,s,l){const c=t-r,h=t+r,f=n-r,p=n+r;if(h<0||c>this.width||p<0||f>this.height)return!s&&[];const m=[];return this._forEachCell(c,f,h,p,this._queryCellCircle,m,{hitTest:s,circle:{x:t,y:n,radius:r},seenUids:{box:{},circle:{}}},l),s?m.length>0:m}query(t,n,r,s,l){return this._query(t,n,r,s,!1,l)}hitTest(t,n,r,s,l){return this._query(t,n,r,s,!0,l)}hitTestCircle(t,n,r,s){return this._queryCircle(t,n,r,!0,s)}_queryCell(t,n,r,s,l,c,h,f){const p=h.seenUids,m=this.boxCells[l];if(null!==m){const y=this.bboxes;for(const v of m)if(!p.box[v]){p.box[v]=!0;const b=4*v;if(t<=y[b+2]&&n<=y[b+3]&&r>=y[b+0]&&s>=y[b+1]&&(!f||f(this.boxKeys[v]))){if(h.hitTest)return c.push(!0),!0;c.push({key:this.boxKeys[v],x1:y[b],y1:y[b+1],x2:y[b+2],y2:y[b+3]})}}}const _=this.circleCells[l];if(null!==_){const y=this.circles;for(const v of _)if(!p.circle[v]){p.circle[v]=!0;const b=3*v;if(this._circleAndRectCollide(y[b],y[b+1],y[b+2],t,n,r,s)&&(!f||f(this.circleKeys[v]))){if(h.hitTest)return c.push(!0),!0;{const E=y[b],D=y[b+1],T=y[b+2];c.push({key:this.circleKeys[v],x1:E-T,y1:D-T,x2:E+T,y2:D+T})}}}}}_queryCellCircle(t,n,r,s,l,c,h,f){const p=h.circle,m=h.seenUids,_=this.boxCells[l];if(null!==_){const v=this.bboxes;for(const b of _)if(!m.box[b]){m.box[b]=!0;const E=4*b;if(this._circleAndRectCollide(p.x,p.y,p.radius,v[E+0],v[E+1],v[E+2],v[E+3])&&(!f||f(this.boxKeys[b])))return c.push(!0),!0}}const y=this.circleCells[l];if(null!==y){const v=this.circles;for(const b of y)if(!m.circle[b]){m.circle[b]=!0;const E=3*b;if(this._circlesCollide(v[E],v[E+1],v[E+2],p.x,p.y,p.radius)&&(!f||f(this.circleKeys[b])))return c.push(!0),!0}}}_forEachCell(t,n,r,s,l,c,h,f){const p=this._convertToXCellCoord(t),m=this._convertToYCellCoord(n),_=this._convertToXCellCoord(r),y=this._convertToYCellCoord(s);for(let v=p;v<=_;v++)for(let b=m;b<=y;b++)if(l.call(this,t,n,r,s,this.xCellCount*b+v,c,h,f))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,r,s,l,c){const h=s-t,f=l-n,p=r+c;return p*p>h*h+f*f}_circleAndRectCollide(t,n,r,s,l,c,h){const f=(c-s)/2,p=Math.abs(t-(s+f));if(p>f+r)return!1;const m=(h-l)/2,_=Math.abs(n-(l+m));if(_>m+r)return!1;if(p<=f||_<=m)return!0;const y=p-f,v=_-m;return y*y+v*v<=r*r}}const Vo=100;class BE{constructor(t,n,r=new NE(t.width+200,t.height+200,25),s=new NE(t.width+200,t.height+200,25)){this.transform=t,this.grid=r,this.ignoredGrid=s,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Vo,this.screenBottomBoundary=t.height+Vo,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,r,s,l,c,h,f){let p=r.projectedAnchorX,m=r.projectedAnchorY,_=r.projectedAnchorZ;const y=r.elevation,v=r.tileID,b=t.getProjection();if(y&&v){const[R,L,O]=b.upVector(v.canonical,r.tileAnchorX,r.tileAnchorY),z=b.upVectorScale(v.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;p+=R*y*z,m+=L*y*z,_+=O*y*z}const E=this.projectAndGetPerspectiveRatio(h,p,m,_,r.tileID,"globe"===b.name||!!y||this.transform.pitch>0,b),D=c*E.perspectiveRatio,T=(r.x1*n+s.x-r.padding)*D+E.point.x,C=(r.y1*n+s.y-r.padding)*D+E.point.y,I=(r.x2*n+s.x+r.padding)*D+E.point.x,A=(r.y2*n+s.y+r.padding)*D+E.point.y,M=E.perspectiveRatio<=.55||E.occluded;return!this.isInsideGrid(T,C,I,A)||!l&&this.grid.hitTest(T,C,I,A,f)||M?{box:[],offscreen:!1,occluded:E.occluded}:{box:[T,C,I,A],offscreen:this.isOffscreen(T,C,I,A),occluded:!1}}placeCollisionCircles(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E){const D=[],T=this.transform.elevation,C=t.getProjection(),I=T?T.getAtTileOffsetFunc(E,this.transform.center.lat,this.transform.worldSize,C):null,A=new tt(r.tileAnchorX,r.tileAnchorY);let{x:M,y:R,z:L}=C.projectTilePoint(A.x,A.y,E.canonical);if(I){const[Q,W,X]=I(A);M+=Q,R+=W,L+=X}const O="globe"===C.name,z=this.projectAndGetPerspectiveRatio(h,M,R,L,E,O||!!T||this.transform.pitch>0,C),{perspectiveRatio:N}=z,V=(_?c/N:c*N)/24,B=fs(M,R,L,f),$=z.signedDistanceFromCamera>0?a0(V,l,r.lineOffsetX*V,r.lineOffsetY*V,!1,B,A,r,s,f,{},T&&!_?I:null,_&&!!T,C,E,_):null;let j=!1,Z=!1,K=!0;if($&&!z.occluded){const Q=.5*v*N+b,W=new tt(-100,-100),X=new tt(this.screenRightBoundary,this.screenBottomBoundary),nt=new HC,{first:ot,last:lt}=$,ht=ot.path.length;let ft=[];for(let Et=ht-1;Et>=1;Et--)ft.push(ot.path[Et]);for(let Et=1;Et<lt.path.length;Et++)ft.push(lt.path[Et]);const at=2.5*Q;p&&(ft=ft.map(([Et,Ot,kt],zt)=>(I&&!O&&(kt=I(zt<ht-1?ot.tilePath[ht-1-zt]:lt.tilePath[zt-ht+2])[2]),fs(Et,Ot,kt,p))),ft.some(Et=>Et[3]<=0)&&(ft=[]));let ut=[];if(ft.length>0){let Et=1/0,Ot=-1/0,kt=1/0,zt=-1/0;for(const Zt of ft)Et=Math.min(Et,Zt[0]),kt=Math.min(kt,Zt[1]),Ot=Math.max(Ot,Zt[0]),zt=Math.max(zt,Zt[1]);Ot>=W.x&&Et<=X.x&&zt>=W.y&&kt<=X.y&&(ut=[ft.map(Zt=>new tt(Zt[0],Zt[1]))],(Et<W.x||Ot>X.x||kt<W.y||zt>X.y)&&(ut=Zb(ut,W.x,W.y,X.x,X.y)))}for(const Et of ut){nt.reset(Et,.25*Q);let Ot=0;Ot=nt.length<=.5*Q?1:Math.ceil(nt.paddedLength/at)+1;for(let kt=0;kt<Ot;kt++){const zt=kt/Math.max(Ot-1,1),Zt=nt.lerp(zt),oe=Zt.x+Vo,Se=Zt.y+Vo;D.push(oe,Se,Q,0);const We=oe-Q,Ee=Se-Q,pe=oe+Q,ie=Se+Q;if(K=K&&this.isOffscreen(We,Ee,pe,ie),Z=Z||this.isInsideGrid(We,Ee,pe,ie),!n&&this.grid.hitTestCircle(oe,Se,Q,y)&&(j=!0,!m))return{circles:[],offscreen:!1,collisionDetected:j,occluded:!1}}}}return{circles:!m&&j||!Z?[]:D,offscreen:K,collisionDetected:j,occluded:z.occluded}}queryRenderedSymbols(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const n=[];let r=1/0,s=1/0,l=-1/0,c=-1/0;for(const m of t){const _=new tt(m.x+Vo,m.y+Vo);r=Math.min(r,_.x),s=Math.min(s,_.y),l=Math.max(l,_.x),c=Math.max(c,_.y),n.push(_)}const h=this.grid.query(r,s,l,c).concat(this.ignoredGrid.query(r,s,l,c)),f={},p={};for(const m of h){const _=m.key;void 0===f[_.bucketInstanceId]&&(f[_.bucketInstanceId]={}),f[_.bucketInstanceId][_.featureIndex]||sb(n,[new tt(m.x1,m.y1),new tt(m.x2,m.y1),new tt(m.x2,m.y2),new tt(m.x1,m.y2)])&&(f[_.bucketInstanceId][_.featureIndex]=!0,void 0===p[_.bucketInstanceId]&&(p[_.bucketInstanceId]=[]),p[_.bucketInstanceId].push(_.featureIndex))}return p}insertCollisionBox(t,n,r,s,l){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:r,featureIndex:s,collisionGroupID:l},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,r,s,l){const c=n?this.ignoredGrid:this.grid,h={bucketInstanceId:r,featureIndex:s,collisionGroupID:l};for(let f=0;f<t.length;f+=4)c.insertCircle(h,t[f],t[f+1],t[f+2])}projectAndGetPerspectiveRatio(t,n,r,s,l,c,h){const f=[n,r,s,1];let p=!1;s||this.transform.pitch>0?(an.transformMat4(f,f,t),this.fogState&&l&&"globe"!==h.name&&(p=function(y,v,b,E,D,T){const C=T.calculateFogTileMatrix(D),I=[v,b,E];return H.transformMat4(I,I,C),C0(y,H.length(I),T.pitch,T._fov)}(this.fogState,n,r,s,l.toUnwrapped(),this.transform)>.9)):Vw(f,f,t);const m=f[3];return{point:new tt((f[0]/m+1)/2*this.transform.width+Vo,(-f[1]/m+1)/2*this.transform.height+Vo),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(h)/m*.5,1.5),signedDistanceFromCamera:m,occluded:c&&f[2]>m||p}}isOffscreen(t,n,r,s){return r<Vo||t>=this.screenRightBoundary||s<Vo||n>this.screenBottomBoundary}isInsideGrid(t,n,r,s){return r>=0&&t<this.gridRightBoundary&&s>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=et.identity([]);return et.translate(t,t,[-100,-100,0]),t}}function Vm(e,t,n){const r=t.createTileMatrix(e,e.worldSize,n.toUnwrapped());return et.multiply(new Float32Array(16),e.projMatrix,r)}function Um(e,t,n){if(t.projection.name===n.projection.name)return e.projMatrix;const r=n.clone();return r.setProjection(t.projection),Vm(r,t.getProjection(),e)}function Jd(e,t,n){return t.name===n.projection.name?e.projMatrix:Vm(n,t,e)}class GC{constructor(t,n,r,s){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):s&&r?1:0,this.placed=r}isHidden(){return 0===this.opacity&&!this.placed}}class ah{constructor(t,n,r,s,l,c=!1){this.text=new GC(t?t.text:null,n,r,l),this.icon=new GC(t?t.icon:null,n,s,l),this.clipped=c}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class H0{constructor(t,n,r,s=!1){this.text=t,this.icon=n,this.skipFade=r,this.clipped=s}}class jE{constructor(){this.invProjMatrix=et.create(),this.viewportMatrix=et.create(),this.circles=[]}}class lh{constructor(t,n,r,s,l){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=r,this.bucketIndex=s,this.tileID=l}}class qC{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:r=>r.collisionGroupID===n}}return this.collisionGroups[t]}}function G0(e,t,n,r,s){const{horizontalAlign:l,verticalAlign:c}=im(e),h=-(l-.5)*t,f=-(c-.5)*n,p=lm(e,r);return new tt(h+p[0]*s,f+p[1]*s)}function Qd(e,t,n,r,s){const l=new tt(e,t);return n&&l._rotate(r?s:-s),l}class BA{constructor(t,n,r,s,l,c){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new BE(this.transform,l),this.buildingIndex=c,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new qC(r),this.collisionCircleArrays={},this.prevPlacement=s,s&&(s.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,r,s){const l=r.getBucket(n),c=r.latestFeatureIndex;if(!l||!c||n.fqid!==l.layerIds[0])return;const h=l.layers[0].layout,f=r.collisionBoxArray,p=Math.pow(2,this.transform.zoom-r.tileID.overscaledZ),m=r.tileSize/st,_=r.tileID.toUnwrapped();this.transform.setProjection(l.projection);const y=(v=r.tileID,b=l.getProjection(),E=this.transform,b.name===this.projection?E.calculateProjMatrix(v.toUnwrapped()):Vm(E,b,v));var v,b,E;const D="map"===h.get("text-pitch-alignment"),T="map"===h.get("text-rotation-alignment");n.compileFilter();const C=n.dynamicFilter(),I=n.dynamicFilterNeedsFeature(),A=this.transform.calculatePixelsToTileUnitsMatrix(r),M=r0(y,r.tileID.canonical,D,T,this.transform,l.getProjection(),A);let R=null;if(D){const z=o0(y,r.tileID.canonical,D,T,this.transform,l.getProjection(),A);R=et.multiply([],this.transform.labelPlaneMatrix,z)}let L=null;C&&r.latestFeatureIndex&&(L={unwrappedTileID:_,dynamicFilter:C,dynamicFilterNeedsFeature:I,featureIndex:r.latestFeatureIndex}),this.retainedQueryData[l.bucketInstanceId]=new lh(l.bucketInstanceId,c,l.sourceLayerIndex,l.index,r.tileID);const O={bucket:l,layout:h,posMatrix:y,textLabelPlaneMatrix:M,labelToScreenMatrix:R,clippingData:L,scale:p,textPixelRatio:m,holdingForFade:r.holdingForFade(),collisionBoxArray:f,partiallyEvaluatedTextSize:ls(l.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:ls(l.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(l.sourceID)};if(s)for(const z of l.sortKeyRanges){const{sortKey:N,symbolInstanceStart:V,symbolInstanceEnd:B}=z;t.push({sortKey:N,symbolInstanceStart:V,symbolInstanceEnd:B,parameters:O})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:l.symbolInstances.length,parameters:O})}attemptAnchorPlacement(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C){const{textOffset0:I,textOffset1:A,crossTileID:M}=y,R=[I,A],L=G0(t,r,s,R,l),O=this.collisionIndex.placeCollisionBox(b,l,n,Qd(L.x,L.y,c,h,this.transform.angle),_,f,p,m.predicate);if(D){const z=b.getSymbolInstanceIconSize(C,this.transform.zoom,y.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(b,z,D,Qd(L.x,L.y,c,h,this.transform.angle),_,f,p,m.predicate).box.length)return}if(O.box.length>0){let z;return this.prevPlacement&&this.prevPlacement.variableOffsets[M]&&this.prevPlacement.placements[M]&&this.prevPlacement.placements[M].text&&(z=this.prevPlacement.variableOffsets[M].anchor),this.variableOffsets[M]={textOffset:R,width:r,height:s,anchor:t,textScale:l,prevAnchor:z},this.markUsedJustification(b,t,y,E),b.allowVerticalPlacement&&(this.markUsedOrientation(b,E,y),this.placedOrientations[M]=E),{shift:L,placedGlyphBoxes:O}}}placeLayerBucketPart(t,n,r,s){const{bucket:l,layout:c,posMatrix:h,textLabelPlaneMatrix:f,labelToScreenMatrix:p,clippingData:m,textPixelRatio:_,holdingForFade:y,collisionBoxArray:v,partiallyEvaluatedTextSize:b,partiallyEvaluatedIconSize:E,collisionGroup:D}=t.parameters,T=c.get("text-optional"),C=c.get("icon-optional"),I=c.get("text-allow-overlap"),A=c.get("icon-allow-overlap"),M="map"===c.get("text-rotation-alignment"),R="map"===c.get("text-pitch-alignment"),L="viewport-y"===c.get("symbol-z-order"),O=c.get("symbol-z-elevate");this.transform.setProjection(l.projection);let z=I&&(A||!l.hasIconData()||C),N=A&&(I||!l.hasTextData()||T);!l.collisionArrays&&v&&l.deserializeCollisionBoxes(v),r&&s&&l.updateCollisionDebugBuffers(this.transform.zoom,v);const V=(B,$,j)=>{const{crossTileID:Z,numVerticalGlyphVertices:K}=B;if(m){const pe={zoom:this.transform.zoom,pitch:this.transform.pitch};let ie=null;if(m.dynamicFilterNeedsFeature){const te=this.retainedQueryData[l.bucketInstanceId];ie=m.featureIndex.loadFeature({featureIndex:B.featureIndex,bucketIndex:te.bucketIndex,sourceLayerIndex:te.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,m.dynamicFilter)(pe,ie,this.retainedQueryData[l.bucketInstanceId].tileID.canonical,new tt(B.tileAnchorX,B.tileAnchorY),this.transform.calculateDistanceTileData(m.unwrappedTileID)))return this.placements[Z]=new H0(!1,!1,!1,!0),void n.add(Z)}if(n.has(Z))return;if(y)return void(this.placements[Z]=new H0(!1,!1,!1));let Q=!1,W=!1,X=!0,nt=!1,ot=!1,lt=null,ht={box:null,offscreen:null,occluded:null},ft={box:null,offscreen:null,occluded:null},at=null,ut=null,Et=null,Ot=0,kt=0,zt=0;j.textFeatureIndex?Ot=j.textFeatureIndex:B.useRuntimeCollisionCircles&&(Ot=B.featureIndex),j.verticalTextFeatureIndex&&(kt=j.verticalTextFeatureIndex);const Zt=pe=>{pe.tileID=this.retainedQueryData[l.bucketInstanceId].tileID;const ie=this.transform.elevation;pe.elevation=B.zOffset+(ie?ie.getAtTileOffset(pe.tileID,pe.tileAnchorX,pe.tileAnchorY):0)},oe=j.textBox;if(oe){Zt(oe);const pe=te=>{let Ne=Bn.horizontal;if(l.allowVerticalPlacement&&!te&&this.prevPlacement){const Xe=this.prevPlacement.placedOrientations[Z];Xe&&(this.placedOrientations[Z]=Xe,Ne=Xe,this.markUsedOrientation(l,Ne,B))}return Ne},ie=(te,Ne)=>{if(l.allowVerticalPlacement&&K>0&&j.verticalTextBox){for(const Xe of l.writingModes)if(Xe===Bn.vertical?(ht=Ne(),ft=ht):ht=te(),ht&&ht.box&&ht.box.length)break}else ht=te()};if(c.get("text-variable-anchor")){let te=c.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Z]){const Ce=this.prevPlacement.variableOffsets[Z];te.indexOf(Ce.anchor)>0&&(te=te.filter(yn=>yn!==Ce.anchor),te.unshift(Ce.anchor))}const Ne=(Ce,yn,On)=>{const Rn=l.getSymbolInstanceTextSize(b,B,this.transform.zoom,$),Dn=(Ce.x2-Ce.x1)*Rn+2*Ce.padding,lr=(Ce.y2-Ce.y1)*Rn+2*Ce.padding,Fn=B.hasIconTextFit&&!A?yn:null;Fn&&Zt(Fn);let jn={box:[],offscreen:!1,occluded:!1};const pn=I?2*te.length:te.length;for(let Si=0;Si<pn;++Si){const ta=this.attemptAnchorPlacement(te[Si%te.length],Ce,Dn,lr,Rn,M,R,_,h,D,Si>=te.length,B,$,l,On,Fn,b,E);if(ta&&(jn=ta.placedGlyphBoxes,jn&&jn.box&&jn.box.length)){Q=!0,lt=ta.shift;break}}return jn};ie(()=>Ne(oe,j.iconBox,Bn.horizontal),()=>{const Ce=j.verticalTextBox;return Ce&&Zt(Ce),l.allowVerticalPlacement&&!(ht&&ht.box&&ht.box.length)&&K>0&&Ce?Ne(Ce,j.verticalIconBox,Bn.vertical):{box:null,offscreen:null,occluded:null}}),ht&&(Q=ht.box,X=ht.offscreen,nt=ht.occluded);const Xe=pe(!(!ht||!ht.box));if(!Q&&this.prevPlacement){const Ce=this.prevPlacement.variableOffsets[Z];Ce&&(this.variableOffsets[Z]=Ce,this.markUsedJustification(l,Ce.anchor,B,Xe))}}else{const te=(Ne,Xe)=>{const Ce=l.getSymbolInstanceTextSize(b,B,this.transform.zoom,$),yn=this.collisionIndex.placeCollisionBox(l,Ce,Ne,new tt(0,0),I,_,h,D.predicate);return yn&&yn.box&&yn.box.length&&(this.markUsedOrientation(l,Xe,B),this.placedOrientations[Z]=Xe),yn};ie(()=>te(oe,Bn.horizontal),()=>{const Ne=j.verticalTextBox;return l.allowVerticalPlacement&&K>0&&Ne?(Zt(Ne),te(Ne,Bn.vertical)):{box:null,offscreen:null,occluded:null}}),pe(!!(ht&&ht.box&&ht.box.length))}}if(at=ht,Q=at&&at.box&&at.box.length>0,X=at&&at.offscreen,nt=at&&at.occluded,B.useRuntimeCollisionCircles){const pe=l.text.placedSymbolArray.get(B.centerJustifiedTextSymbolIndex>=0?B.centerJustifiedTextSymbolIndex:B.verticalPlacedTextSymbolIndex),ie=Jp(l.textSizeData,b,pe),te=c.get("text-padding");ut=this.collisionIndex.placeCollisionCircles(l,I,pe,l.lineVertexArray,l.glyphOffsetArray,ie,h,f,p,r,R,D.predicate,B.collisionCircleDiameter*ie/24,te,this.retainedQueryData[l.bucketInstanceId].tileID),Q=I||ut.circles.length>0&&!ut.collisionDetected,X=X&&ut.offscreen,nt=ut.occluded}if(j.iconFeatureIndex&&(zt=j.iconFeatureIndex),j.iconBox){const pe=ie=>{Zt(ie);const te=B.hasIconTextFit&&lt?Qd(lt.x,lt.y,M,R,this.transform.angle):new tt(0,0),Ne=l.getSymbolInstanceIconSize(E,this.transform.zoom,B.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(l,Ne,ie,te,A,_,h,D.predicate)};ft&&ft.box&&ft.box.length&&j.verticalIconBox?(Et=pe(j.verticalIconBox),W=Et.box.length>0):(Et=pe(j.iconBox),W=Et.box.length>0),X=X&&Et.offscreen,ot=Et.occluded}const Se=T||0===B.numHorizontalGlyphVertices&&0===K,We=C||0===B.numIconVertices;if(Se||We?We?Se||(W=W&&Q):Q=W&&Q:W=Q=W&&Q,Q&&at&&at.box&&this.collisionIndex.insertCollisionBox(at.box,c.get("text-ignore-placement"),l.bucketInstanceId,ft&&ft.box&&kt?kt:Ot,D.ID),W&&Et&&this.collisionIndex.insertCollisionBox(Et.box,c.get("icon-ignore-placement"),l.bucketInstanceId,zt,D.ID),ut&&(Q&&this.collisionIndex.insertCollisionCircles(ut.circles,c.get("text-ignore-placement"),l.bucketInstanceId,Ot,D.ID),r)){const pe=l.bucketInstanceId;let ie=this.collisionCircleArrays[pe];void 0===ie&&(ie=this.collisionCircleArrays[pe]=new jE);for(let te=0;te<ut.circles.length;te+=4)ie.circles.push(ut.circles[te+0]),ie.circles.push(ut.circles[te+1]),ie.circles.push(ut.circles[te+2]),ie.circles.push(ut.collisionDetected?1:0)}const Ee="globe"!==l.projection.name;z=z&&(Ee||!nt),N=N&&(Ee||!ot),this.placements[Z]=new H0(Q||z,W||N,X||l.justReloaded),n.add(Z)};if(O&&this.buildingIndex&&(this.buildingIndex.updateZOffset(l,this.retainedQueryData[l.bucketInstanceId].tileID),l.updateZOffset()),L){const B=l.getSortedSymbolIndexes(this.transform.angle);for(let $=B.length-1;$>=0;--$){const j=B[$];V(l.symbolInstances.get(j),j,l.collisionArrays[j])}l.hasAnyZOffset&&Y(`${l.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(l.hasAnyZOffset){const B=l.getSortedIndexesByZOffset();for(let $=0;$<B.length;++$){const j=B[$];V(l.symbolInstances.get(j),j,l.collisionArrays[j])}}else for(let B=t.symbolInstanceStart;B<t.symbolInstanceEnd;B++)V(l.symbolInstances.get(B),B,l.collisionArrays[B]);if(r&&l.bucketInstanceId in this.collisionCircleArrays){const B=this.collisionCircleArrays[l.bucketInstanceId];et.invert(B.invProjMatrix,h),B.viewportMatrix=this.collisionIndex.getViewportMatrix()}l.justReloaded=!1}markUsedJustification(t,n,r,s){const{leftJustifiedTextSymbolIndex:l,centerJustifiedTextSymbolIndex:c,rightJustifiedTextSymbolIndex:h,verticalPlacedTextSymbolIndex:f,crossTileID:p}=r,m=cm(n),_=s===Bn.vertical?f:"left"===m?l:"center"===m?c:"right"===m?h:-1;l>=0&&(t.text.placedSymbolArray.get(l).crossTileID=_>=0&&l!==_?0:p),c>=0&&(t.text.placedSymbolArray.get(c).crossTileID=_>=0&&c!==_?0:p),h>=0&&(t.text.placedSymbolArray.get(h).crossTileID=_>=0&&h!==_?0:p),f>=0&&(t.text.placedSymbolArray.get(f).crossTileID=_>=0&&f!==_?0:p)}markUsedOrientation(t,n,r){const s=n===Bn.horizontal||n===Bn.horizontalOnly?n:0,l=n===Bn.vertical?n:0,{leftJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:h,rightJustifiedTextSymbolIndex:f,verticalPlacedTextSymbolIndex:p}=r,m=t.text.placedSymbolArray;c>=0&&(m.get(c).placedOrientation=s),h>=0&&(m.get(h).placedOrientation=s),f>=0&&(m.get(f).placedOrientation=s),p>=0&&(m.get(p).placedOrientation=l)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let r=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const s=n?n.symbolFadeChange(t):1,l=n?n.opacities:{},c=n?n.variableOffsets:{},h=n?n.placedOrientations:{};for(const f in this.placements){const p=this.placements[f],m=l[f];m?(this.opacities[f]=new ah(m,s,p.text,p.icon,null,p.clipped),r=r||p.text!==m.text.placed||p.icon!==m.icon.placed):(this.opacities[f]=new ah(null,s,p.text,p.icon,p.skipFade,p.clipped),r=r||p.text||p.icon)}for(const f in l){const p=l[f];if(!this.opacities[f]){const m=new ah(p,s,!1,!1);m.isHidden()||(this.opacities[f]=m,r=r||p.text.placed||p.icon.placed)}}for(const f in c)this.variableOffsets[f]||!this.opacities[f]||this.opacities[f].isHidden()||(this.variableOffsets[f]=c[f]);for(const f in h)this.placedOrientations[f]||!this.opacities[f]||this.opacities[f].isHidden()||(this.placedOrientations[f]=h[f]);r?this.lastPlacementChangeTime=t:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n){const r=new Set;for(const s of n){const l=s.getBucket(t);l&&s.latestFeatureIndex&&t.fqid===l.layerIds[0]&&(this.updateBucketOpacities(l,r,s.collisionBoxArray),l.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(l,s.tileID),l.updateZOffset()))}}updateBucketOpacities(t,n,r){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const s=t.layers[0].layout,l=!!t.layers[0].dynamicFilter(),c=new ah(null,0,!1,!1,!0),h=s.get("text-allow-overlap"),f=s.get("icon-allow-overlap"),p=s.get("text-variable-anchor"),m="map"===s.get("text-rotation-alignment"),_="map"===s.get("text-pitch-alignment"),y=new ah(null,0,h&&(f||!t.hasIconData()||s.get("icon-optional")),f&&(h||!t.hasTextData()||s.get("text-optional")),!0);!t.collisionArrays&&r&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(r);const v=(E,D,T)=>{for(let C=0;C<D/4;C++)E.opacityVertexArray.emplaceBack(T)};let b=0;for(let E=0;E<t.symbolInstances.length;E++){const D=t.symbolInstances.get(E),{numHorizontalGlyphVertices:T,numVerticalGlyphVertices:C,crossTileID:I,numIconVertices:A}=D,M=n.has(I);let R=this.opacities[I];M?R=c:R||(R=y,this.opacities[I]=R),n.add(I);const L=T>0||C>0,O=A>0,z=this.placedOrientations[I],N=z===Bn.vertical,V=z===Bn.horizontal||z===Bn.horizontalOnly;if(!L&&!O||R.isHidden()||b++,L){const B=q0(R.text);v(t.text,T,N?tf:B),v(t.text,C,V?tf:B);const $=R.text.isHidden(),{leftJustifiedTextSymbolIndex:j,centerJustifiedTextSymbolIndex:Z,rightJustifiedTextSymbolIndex:K,verticalPlacedTextSymbolIndex:Q}=D,W=t.text.placedSymbolArray,X=$||N?1:0;j>=0&&(W.get(j).hidden=X),Z>=0&&(W.get(Z).hidden=X),K>=0&&(W.get(K).hidden=X),Q>=0&&(W.get(Q).hidden=$||V?1:0);const nt=this.variableOffsets[I];nt&&this.markUsedJustification(t,nt.anchor,D,z);const ot=this.placedOrientations[I];ot&&(this.markUsedJustification(t,"left",D,ot),this.markUsedOrientation(t,ot,D))}if(O){const B=q0(R.icon),{placedIconSymbolIndex:$,verticalPlacedIconSymbolIndex:j}=D,Z=t.icon.placedSymbolArray,K=R.icon.isHidden()?1:0;$>=0&&(v(t.icon,A,N?tf:B),Z.get($).hidden=K),j>=0&&(v(t.icon,D.numVerticalIconVertices,V?tf:B),Z.get(j).hidden=K)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const B=t.collisionArrays[E];if(B){let $=new tt(0,0),j=!0;if(B.textBox||B.verticalTextBox){if(p){const K=this.variableOffsets[I];K?($=G0(K.anchor,K.width,K.height,K.textOffset,K.textScale),m&&$._rotate(_?this.transform.angle:-this.transform.angle)):j=!1}l&&(j=!R.clipped),B.textBox&&$m(t.textCollisionBox.collisionVertexArray,R.text.placed,!j||N,$.x,$.y),B.verticalTextBox&&$m(t.textCollisionBox.collisionVertexArray,R.text.placed,!j||V,$.x,$.y)}const Z=j&&Boolean(!V&&B.verticalIconBox);B.iconBox&&$m(t.iconCollisionBox.collisionVertexArray,R.icon.placed,Z,D.hasIconTextFit?$.x:0,D.hasIconTextFit?$.y:0),B.verticalIconBox&&$m(t.iconCollisionBox.collisionVertexArray,R.icon.placed,!Z,D.hasIconTextFit?$.x:0,D.hasIconTextFit?$.y:0)}}}if(t.fullyClipped=0===b,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const E=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=E.invProjMatrix,t.placementViewportMatrix=E.viewportMatrix,t.collisionCircleArray=E.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return 0===this.fadeDuration?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const r=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*r>t}setStale(){this.stale=!0}}function $m(e,t,n,r,s){e.emplaceBack(t?1:0,n?1:0,r||0,s||0),e.emplaceBack(t?1:0,n?1:0,r||0,s||0),e.emplaceBack(t?1:0,n?1:0,r||0,s||0),e.emplaceBack(t?1:0,n?1:0,r||0,s||0)}const jA=Math.pow(2,25),WC=Math.pow(2,24),ZC=Math.pow(2,17),XC=Math.pow(2,16),VE=Math.pow(2,9),UE=Math.pow(2,8),YC=Math.pow(2,1);function q0(e){if(0===e.opacity&&!e.placed)return 0;if(1===e.opacity&&e.placed)return 4294967295;const t=e.placed?1:0,n=Math.floor(127*e.opacity);return n*jA+t*WC+n*ZC+t*XC+n*VE+t*UE+n*YC+t}const tf=0;class KC{constructor(t){this._sortAcrossTiles="viewport-y"!==t.layout.get("symbol-z-order")&&void 0!==t.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,r,s,l){const c=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(c,s,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,l())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,c.sort((h,f)=>h.sortKey-f.sortKey));this._currentPartIndex<c.length;){const h=c[this._currentPartIndex];if(n.placeLayerBucketPart(h,this._seenCrossTileIDs,r,0===h.symbolInstanceStart),this._currentPartIndex++,l())return!0}return!1}}class JC{constructor(t,n,r,s,l,c,h,f,p){this.placement=new BA(t,l,c,h,f,p),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=r,this._showCollisionBoxes=s,this._done=!1}isDone(){return this._done}continuePlacement(t,n,r,s){const l=me.now(),c=()=>{const h=me.now()-l;return!this._forceFullPlacement&&h>2};for(;this._currentPlacementIndex>=0;){const h=n[t[this._currentPlacementIndex]],f=this.placement.collisionIndex.transform.zoom;if("symbol"===h.type&&(!h.minzoom||h.minzoom<=f)&&(!h.maxzoom||h.maxzoom>f)){const p=h,m=p.layout.get("symbol-z-elevate"),_=this._inProgressLayer=this._inProgressLayer||new KC(p),y=Wn(h.source,h.scope);if(_.continuePlacement(m?s[y]:r[y],this.placement,this._showCollisionBoxes,h,c))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const W0=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Hm{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[n,r]=new Uint8Array(t,0,2);if(219!==n)throw new Error("Data does not appear to be in a KDBush format.");const s=r>>4;if(1!==s)throw new Error(`Got v${s} data when expected v1.`);const l=W0[15&r];if(!l)throw new Error("Unrecognized array type.");const[c]=new Uint16Array(t,2,1),[h]=new Uint32Array(t,4,1);return new Hm(h,c,l,t)}constructor(t,n=64,r=Float64Array,s){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=r,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const l=W0.indexOf(this.ArrayType),c=2*t*this.ArrayType.BYTES_PER_ELEMENT,h=t*this.IndexArrayType.BYTES_PER_ELEMENT,f=(8-h%8)%8;if(l<0)throw new Error(`Unexpected typed array class: ${r}.`);s&&s instanceof ArrayBuffer?(this.data=s,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+h+f,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+c+h+f),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+h+f,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+l]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=t)}add(t,n){const r=this._pos>>1;return this.ids[r]=r,this.coords[this._pos++]=t,this.coords[this._pos++]=n,r}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Gm(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,n,r,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:l,coords:c,nodeSize:h}=this,f=[0,l.length-1,0],p=[];for(;f.length;){const m=f.pop()||0,_=f.pop()||0,y=f.pop()||0;if(_-y<=h){for(let D=y;D<=_;D++){const T=c[2*D],C=c[2*D+1];T>=t&&T<=r&&C>=n&&C<=s&&p.push(l[D])}continue}const v=y+_>>1,b=c[2*v],E=c[2*v+1];b>=t&&b<=r&&E>=n&&E<=s&&p.push(l[v]),(0===m?t<=b:n<=E)&&(f.push(y),f.push(v-1),f.push(1-m)),(0===m?r>=b:s>=E)&&(f.push(v+1),f.push(_),f.push(1-m))}return p}within(t,n,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:l,nodeSize:c}=this,h=[0,s.length-1,0],f=[],p=r*r;for(;h.length;){const m=h.pop()||0,_=h.pop()||0,y=h.pop()||0;if(_-y<=c){for(let D=y;D<=_;D++)$E(l[2*D],l[2*D+1],t,n)<=p&&f.push(s[D]);continue}const v=y+_>>1,b=l[2*v],E=l[2*v+1];$E(b,E,t,n)<=p&&f.push(s[v]),(0===m?t-r<=b:n-r<=E)&&(h.push(y),h.push(v-1),h.push(1-m)),(0===m?t+r>=b:n+r>=E)&&(h.push(v+1),h.push(_),h.push(1-m))}return f}}function Gm(e,t,n,r,s,l){if(s-r<=n)return;const c=r+s>>1;Z0(e,t,c,r,s,l),Gm(e,t,n,r,c-1,1-l),Gm(e,t,n,c+1,s,1-l)}function Z0(e,t,n,r,s,l){for(;s>r;){if(s-r>600){const p=s-r+1,m=n-r+1,_=Math.log(p),y=.5*Math.exp(2*_/3),v=.5*Math.sqrt(_*y*(p-y)/p)*(m-p/2<0?-1:1);Z0(e,t,n,Math.max(r,Math.floor(n-m*y/p+v)),Math.min(s,Math.floor(n+(p-m)*y/p+v)),l)}const c=t[2*n+l];let h=r,f=s;for(ch(e,t,r,n),t[2*s+l]>c&&ch(e,t,r,s);h<f;){for(ch(e,t,h,f),h++,f--;t[2*h+l]<c;)h++;for(;t[2*f+l]>c;)f--}t[2*r+l]===c?ch(e,t,r,f):(f++,ch(e,t,f,s)),f<=n&&(r=f+1),n<=f&&(s=f-1)}}function ch(e,t,n,r){qm(e,n,r),qm(t,2*n,2*r),qm(t,2*n+1,2*r+1)}function qm(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}function $E(e,t,n,r){const s=e-n,l=t-r;return s*s+l*l}const X0=.03125;class VA{constructor(t,n,r){this.tileID=t,this.bucketInstanceId=r,this.index=new Hm(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const s=t.canonical.x*st,l=t.canonical.y*st;for(let c=0;c<n.length;c++){const{key:h,crossTileID:f,tileAnchorX:p,tileAnchorY:m}=n.get(c),_=Math.floor((s+p)*X0),y=Math.floor((l+m)*X0);this.index.add(_,y),this.keys.push(h),this.crossTileIDs.push(f)}this.index.finish()}findMatches(t,n,r){const s=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),l=X0/Math.pow(2,n.canonical.z-this.tileID.canonical.z),c=n.canonical.x*st,h=n.canonical.y*st;for(let f=0;f<t.length;f++){const p=t.get(f);if(p.crossTileID)continue;const{key:m,tileAnchorX:_,tileAnchorY:y}=p,v=Math.floor((c+_)*l),b=Math.floor((h+y)*l),E=this.index.range(v-s,b-s,v+s,b+s);for(const D of E){const T=this.crossTileIDs[D];if(this.keys[D]===m&&!r.has(T)){r.add(T),p.crossTileID=T;break}}}}}class HE{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class UA{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(0!==n)for(const r in this.indexes){const s=this.indexes[r],l={};for(const c in s){const h=s[c];h.tileID=h.tileID.unwrapTo(h.tileID.wrap+n),l[h.tileID.key]=h}this.indexes[r]=l}this.lng=t}addBucket(t,n,r){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let l=0;l<n.symbolInstances.length;l++)n.symbolInstances.get(l).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const s=this.usedCrossTileIDs[t.overscaledZ];for(const l in this.indexes){const c=this.indexes[l];if(Number(l)>t.overscaledZ)for(const h in c){const f=c[h];f.tileID.isChildOf(t)&&f.findMatches(n.symbolInstances,t,s)}else{const h=c[t.scaledTo(Number(l)).key];h&&h.findMatches(n.symbolInstances,t,s)}}for(let l=0;l<n.symbolInstances.length;l++){const c=n.symbolInstances.get(l);c.crossTileID||(c.crossTileID=r.generate(),s.add(c.crossTileID))}return void 0===this.indexes[t.overscaledZ]&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new VA(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const r of n.crossTileIDs)this.usedCrossTileIDs[t].delete(r)}removeStaleBuckets(t){let n=!1;for(const r in this.indexes){const s=this.indexes[r];for(const l in s)t[s[l].bucketInstanceId]||(this.removeBucketCrossTileIDs(r,s[l]),delete s[l],n=!0)}return n}}class $A{constructor(){this.layerIndexes={},this.crossTileIDs=new HE,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,r,s){let l=this.layerIndexes[t.fqid];void 0===l&&(l=this.layerIndexes[t.fqid]=new UA);let c=!1;const h={};"globe"!==s.name&&l.handleWrapJump(r);for(const f of n){const p=f.getBucket(t);p&&t.fqid===p.layerIds[0]&&(p.bucketInstanceId||(p.bucketInstanceId=++this.maxBucketInstanceId),l.addBucket(f.tileID,p,this.crossTileIDs)&&(c=!0),h[p.bucketInstanceId]=!0)}return l.removeStaleBuckets(h)&&(c=!0),c}pruneUnusedLayers(t){const n={};t.forEach(r=>{n[r]=!0});for(const r in this.layerIndexes)n[r]||delete this.layerIndexes[r]}}var QC="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#define EXTENT 8192.0\n#define HALF_PI PI/2.0\n#define QUARTER_PI PI/4.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nvec3 linearTosRGB(vec3 color)\n{return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn)\n{return pow(srgbIn,vec3(2.2));}vec3 linearProduct(vec3 srgbIn,vec3 k)\n{return srgbIn*pow(k,vec3(1./2.2));}\n#if __VERSION__ >=300\n#define _HANDLE_WIREFRAME_DEPTH gl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define _HANDLE_WIREFRAME_DEPTH\n#endif\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\ngl_FragColor=vec4(0.7,0.0,0.0,0.7); \\\n_HANDLE_WIREFRAME_DEPTH;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w-0.0001;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",tM="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",eM="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\nconst float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}\n#ifdef TERRAIN\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;\n#else\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;\n#endif\nuniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));float tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nfloat tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;\n#else\nvec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);\n#endif\nreturn vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",nM="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",rM="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;varying vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",iM="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",ef="#ifdef RENDER_SHADOWS\n#if defined(NATIVE) && __VERSION__ >=300\n#define TEXTURE_GATHER\n#endif\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture2D(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture2D(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture2D(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture2D(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const oM=[];hh(QC,oM);const Lc={"_prelude_fog.vertex.glsl":nM,"_prelude_terrain.vertex.glsl":eM,"_prelude_shadow.vertex.glsl":iM,"_prelude_fog.fragment.glsl":rM,"_prelude_shadow.fragment.glsl":ef,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE"},kc={};cn("",eM),cn(rM,nM),cn(ef,iM);const uh=cn("\n#if __VERSION__ >=300\n#define varying in\n#define gl_FragColor glFragColor\n#define texture2D texture\n#define textureCube texture\nout vec4 glFragColor;\n#endif\nhighp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color) {\n#ifdef INDICATOR_CUTOUT\nfloat holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;varying float v_cutoff_opacity;\n#endif","\n#if __VERSION__ >=300\n#define attribute in\n#define varying out\n#define texture2D texture\n#endif\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;varying float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered."),Y0=QC;var sM={background:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nvarying vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nattribute vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;varying vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;varying vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nvarying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\ngl_FragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:cn("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:cn('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:cn("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:cn("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nattribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:cn("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:cn("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nattribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;\n#endif\nvarying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nattribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutline:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nvarying vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nattribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;varying vec2 v_pos;varying vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;varying vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;varying vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nvarying vec4 v_color;\n#ifdef RENDER_SHADOWS\nvarying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nvarying vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvarying highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nvarying float v_flood_radius;varying float v_has_floodlight;\n#endif\nvarying float v_height;void main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef RENDER_CUTOFF\ncolor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#if __VERSION__ >=300\n#ifdef RENDER_CUTOFF\ninvariant gl_Position;\n#endif\n#endif\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nuniform highp float u_vertical_scale;varying vec4 v_color;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nvarying vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvarying highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nvarying float v_flood_radius;varying float v_has_floodlight;\n#endif\nvarying float v_height;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),fillExtrusionDepth:cn("varying highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\ngl_FragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\nvarying highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nvarying vec3 v_normal;\n#endif\nvarying vec2 v_pos;varying vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec2 v_pos;varying vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nvarying vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:cn('#include "_prelude_shadow.fragment.glsl"\n#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 u_ground_shadow_factor;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,v_depth));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);\n#endif\ngl_FragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;attribute vec2 a_pos;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);v_depth=gl_Position.w;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:cn("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nvarying highp vec2 v_pos;varying highp vec4 v_line_segment;varying highp float v_flood_light_radius_tile;varying highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nvarying highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture2D(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\ngl_FragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\ngl_FragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\ngl_FragColor=color;HANDLE_WIREFRAME_DEBUG;\n#endif\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nattribute highp vec4 a_pos_end;attribute highp float a_angular_offset_factor;attribute highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nvarying highp vec2 v_pos;varying highp vec4 v_line_segment;varying highp float v_flood_light_radius_tile;varying highp vec2 v_ao;\n#ifdef FOG\nvarying highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;\n#ifdef FORCE_ABS_FL_GROUND_RADIUS\nfl_ground_radius=abs(flood_light_ground_radius);\n#endif\nfloat flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:cn("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nreturn texture(u_image,coord).r/4.0;\n#else\nvec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;\n#endif\n}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\ngl_FragColor=apply_lighting_with_emission_ground(gl_FragColor,u_emissive_strength);\n#endif\n#ifdef FOG\ngl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;varying vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture2D(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture2D(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trimmed=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    \nfloat Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nattribute highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nattribute float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;varying vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),linePattern:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_ground(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),raster:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec2 u_colorization_scale;uniform highp vec4 u_colorization_mix;highp vec4 colormap (highp float value) {highp float scaled_value=value*u_colorization_scale.y+u_colorization_scale.x;highp vec2 coords=vec2(scaled_value,0.5);return texture2D(u_color_ramp,coords);}\n#endif\nvoid main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);vec4 color;\n#ifdef RASTER_COLOR\nhighp vec4 fadedColor=mix(color0,color1,u_fade_t);color=colormap(dot(vec4(fadedColor.rgb,1),u_colorization_mix));color.a*=fadedColor.a;if (color.a > 0.0) {color.rgb/=color.a;}\n#else\nif (color0.a > 0.0) {color0.rgb/=color0.a;}if (color1.a > 0.0) {color1.rgb/=color1.a;}color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_ground(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply(out_color,v_fog_pos));\n#endif\ngl_FragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_pos;attribute vec2 a_uv;\n#else\nattribute vec2 a_pos;attribute vec2 a_texture_pos;\n#endif\nvarying vec2 v_pos0;varying vec2 v_pos1;void main() {vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*u_globe_matrix*vec4(a_globe_pos,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\nuv=a_texture_pos/8192.0;\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),symbolIcon:cn('#include "_prelude_lighting.glsl"\nuniform sampler2D u_texture;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\nvarying float v_fade_opacity;varying vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nvarying vec2 v_tex_b;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nlowp float alpha=opacity*v_fade_opacity;vec4 out_color;\n#ifdef ICON_TRANSITION\nvec4 a=texture2D(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture2D(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;\n#else\nout_color=texture2D(u_texture,v_tex_a)*alpha;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nattribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef Z_OFFSET\nattribute float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nattribute vec2 a_texb;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nvarying vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nvarying vec2 v_tex_b;\n#endif\nvarying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nv_tex_a=a_tex/u_texsize;\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\nv_fade_opacity=out_fade_opacity;}'),symbolSDF:cn('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo;\n#if __VERSION__ >=300\ndraw_halo=v_draw_halo > 0.0;\n#else\ndraw_halo=u_is_halo;\n#endif\nif (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nattribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef Z_OFFSET\nattribute float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;\n#if __VERSION__ >=300\nv_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;\n#endif\nv_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}'),symbolTextAndIcon:cn('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo;\n#if __VERSION__ >=300\ndraw_halo=v_draw_halo > 0.0;\n#else\ndraw_halo=u_is_halo;\n#endif\nif (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nattribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef Z_OFFSET\nattribute float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\n#if __VERSION__ >=300\nflat varying float v_draw_halo;\n#endif\nvarying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nfloat out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;\n#if __VERSION__ >=300\nv_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;\n#endif\nv_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}'),terrainRaster:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvarying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture2D(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,v_depth,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;\n#endif\n}'),terrainDepth:cn("#ifdef GL_ES\nprecision highp float;\n#endif\nvarying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;attribute vec2 a_pos;varying float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:cn('#include "_prelude_fog.fragment.glsl"\nvarying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}',tM),skyboxGradient:cn('#include "_prelude_fog.fragment.glsl"\nvarying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}',tM),skyboxCapture:cn("\nvarying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;\n#ifdef GL_ES\nprecision highp float;\n#endif\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}","attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;varying vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture2D(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture2D(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nattribute vec3 a_globe_pos;attribute vec2 a_uv;\n#else\nattribute vec2 a_pos;\n#endif\nvarying vec2 v_pos0;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:cn('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\ngl_FragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\ngl_FragColor=vec4(1,1,1,1);\n#else\ngl_FragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);gl_FragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\ngl_FragColor=vec4(c*t,t);\n#endif\n}',"attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:cn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;varying highp vec4 v_position_height;varying lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nvarying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth_shadows;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nvarying lowp vec4 v_roughness_metallic_emissive_alpha;varying mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nvarying highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture2D(u_depthTexture,coord));return v_depth > depth+0.0005;}\n#endif\nconst float M_PI=3.141592653589793;\n#define saturate(_x) clamp(_x,0.,1.)\nfloat calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture2D(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\ntexColor.rgb=sRGBToLinear(texColor.rgb);if(u_baseTextureIsAlpha) {if (texColor.w < 0.5) {discard;}albedo*=mix(vec4(texColor.rgb,texColor.a),vec4(texColor.a),float(u_baseTextureIsAlpha));} else {albedo*=texColor;}\n#endif\nreturn vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture2D( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture2D(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(M_PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/M_PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/M_PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 diffuse=getDiffuseShadedColor(getBaseColor().rgb,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture2D(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(diffuse,1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nfloat ao=(texture2D(u_occlusionTexture,uv_2f).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture2D(u_emissionTexture,uv_2f).rgb);\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\ncolor=mix(color,mat.baseColor.rgb,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor);\n#endif\ngl_FragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nattribute vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nattribute vec4 a_normal_matrix0;attribute vec4 a_normal_matrix1;attribute vec4 a_normal_matrix2;attribute vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth_shadows;\n#endif\nvarying vec4 v_position_height;varying lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nvarying highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nvarying lowp vec4 v_roughness_metallic_emissive_alpha;varying mediump vec4 v_height_based_emission_params;\n#endif\nvoid main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=local_pos;\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:cn("varying highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\ngl_FragColor=pack_depth(v_depth);\n#endif\n}","attribute vec3 a_pos_3f;uniform mat4 u_matrix;varying highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nattribute vec4 a_normal_matrix0;attribute vec4 a_normal_matrix1;attribute vec4 a_normal_matrix2;attribute vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:cn("varying highp vec2 v_uv;varying mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;gl_FragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nattribute vec3 a_pos_3f;attribute vec2 a_uv;attribute float a_size_scale;attribute float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;varying highp vec2 v_uv;varying mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}")};function hh(e,t){const n=e.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let r of n)if(r=r.trim(),"#"===r[0]&&r.includes("if")&&!r.includes("endif")){r=r.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const s=r.split(" ");for(const l of s)t.includes(l)||t.push(l)}}function cn(e,t){const n=/#include\s+"([^"]+)"/g,r=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let s=t.match(/attribute(\S*) (highp |mediump |lowp )?([\w]+) ([\w]+)/g);s&&(s=s.filter((p,m)=>s.indexOf(p)===m));const l={},c=[],h=[];e=e.replace(n,(p,m)=>(h.push(m),"")),t=t.replace(n,(p,m)=>(c.push(m),""));let f=[...oM];hh(e,f),hh(t,f);for(const p of[...c,...h])Lc[p]||console.error(`Undefined include: ${p}`),kc[p]||(kc[p]=[],hh(Lc[p],kc[p])),f=[...f,...kc[p]];return{fragmentSource:e=e.replace(r,(p,m,_,y,v)=>(l[v]=!0,"define"===m?`\n#ifndef HAS_UNIFORM_u_${v}\nvarying ${_} ${y} ${v};\n#else\nuniform ${_} ${y} u_${v};\n#endif\n`:"initialize"===m?`\n#ifdef HAS_UNIFORM_u_${v}\n    ${_} ${y} ${v} = u_${v};\n#endif\n`:"define-attribute"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    varying ${_} ${y} ${v};\n#endif\n`:"initialize-attribute"===m?"":void 0)),vertexSource:t=t.replace(r,(p,m,_,y,v)=>{const b="float"===y?"vec2":y,E=v.match(/color/)?"color":b;return"define-attribute-vertex-shader-only"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\nattribute ${_} ${y} a_${v};\n#endif\n`:l[v]?"define"===m?`\n#ifndef HAS_UNIFORM_u_${v}\nuniform lowp float u_${v}_t;\nattribute ${_} ${b} a_${v};\nvarying ${_} ${y} ${v};\n#else\nuniform ${_} ${y} u_${v};\n#endif\n`:"initialize"===m?"vec4"===E?`\n#ifndef HAS_UNIFORM_u_${v}\n    ${v} = a_${v};\n#else\n    ${_} ${y} ${v} = u_${v};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${v}\n    ${v} = unpack_mix_${E}(a_${v}, u_${v}_t);\n#else\n    ${_} ${y} ${v} = u_${v};\n#endif\n`:"define-attribute"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    attribute ${_} ${y} a_${v};\n    varying ${_} ${y} ${v};\n#endif\n`:"initialize-attribute"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    ${v} = a_${v};\n#endif\n`:void 0:"define"===m?`\n#ifndef HAS_UNIFORM_u_${v}\nuniform lowp float u_${v}_t;\nattribute ${_} ${b} a_${v};\n#else\nuniform ${_} ${y} u_${v};\n#endif\n`:"define-instanced"===m?"mat4"===E?`\n#ifdef INSTANCED_ARRAYS\nattribute vec4 a_${v}0;\nattribute vec4 a_${v}1;\nattribute vec4 a_${v}2;\nattribute vec4 a_${v}3;\n#else\nuniform ${_} ${y} u_${v};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nattribute ${_} ${b} a_${v};\n#else\nuniform ${_} ${y} u_${v};\n#endif\n`:"initialize-attribute-custom"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    ${_} ${y} ${v} = a_${v};\n#endif\n`:"vec4"===E?`\n#ifndef HAS_UNIFORM_u_${v}\n    ${_} ${y} ${v} = a_${v};\n#else\n    ${_} ${y} ${v} = u_${v};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${v}\n    ${_} ${y} ${v} = unpack_mix_${E}(a_${v}, u_${v}_t);\n#else\n    ${_} ${y} ${v} = u_${v};\n#endif\n`}),staticAttributes:s,usedDefines:f,vertexIncludes:c,fragmentIncludes:h}}class K0{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,r,s,l,c,h,f){this.context=t;let p=this.boundPaintVertexBuffers.length!==s.length;for(let _=0;!p&&_<s.length;_++)this.boundPaintVertexBuffers[_]!==s[_]&&(p=!0);let m=this.boundDynamicVertexBuffers.length!==h.length;for(let _=0;!m&&_<h.length;_++)this.boundDynamicVertexBuffers[_]!==h[_]&&(m=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==r||p||m||this.boundIndexBuffer!==l||this.boundVertexOffset!==c)this.freshBind(n,r,s,l,c,h,f);else{t.bindVertexArrayOES.set(this.vao);for(const _ of h)_&&(_.bind(),f&&_.instanceCount&&_.setVertexAttribDivisor(t.gl,n,f));l&&l.dynamicDraw&&l.bind()}}freshBind(t,n,r,s,l,c,h){const f=t.numAttributes,p=this.context,m=p.gl;this.vao&&this.destroy(),this.vao=p.gl.createVertexArray(),p.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=r,this.boundIndexBuffer=s,this.boundVertexOffset=l,this.boundDynamicVertexBuffers=c,n.enableAttributes(m,t),n.bind(),n.setVertexAttribPointers(m,t,l);for(const _ of r)_.enableAttributes(m,t),_.bind(),_.setVertexAttribPointers(m,t,l);for(const _ of c)_&&(_.enableAttributes(m,t),_.bind(),_.setVertexAttribPointers(m,t,l),h&&_.instanceCount&&_.setVertexAttribDivisor(m,t,h));s&&s.bind(),p.currentNumAttributes=f}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function GE(e,t){const n=Math.pow(2,t.canonical.z),r=t.canonical.y;return[new He(0,r/n).toLngLat().lat,new He(0,(r+1)/n).toLngLat().lat]}function HA(e,t,n,r,s,l,c){const h=e.context,f=h.gl,p=n.hillshadeFBO;if(!p)return;e.prepareDrawTile();const m=e.isTileAffectedByFog(t),_=e.getOrCreateProgram("hillshade",{overrideFog:m});h.activeTexture.set(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,p.colorAttachment.get());const y=((D,T,C,I)=>{const A=C.paint.get("hillshade-shadow-color"),M=C.paint.get("hillshade-highlight-color"),R=C.paint.get("hillshade-accent-color"),L=C.paint.get("hillshade-emissive-strength");let O=be(C.paint.get("hillshade-illumination-direction"));if("viewport"===C.paint.get("hillshade-illumination-anchor"))O-=D.transform.angle;else if(D.style&&D.style.enable3dLights()&&D.style.directionalLight){const N=D.style.directionalLight.properties.get("direction");O=be(Wt(N.x,N.y,N.z)[1])}const z=!D.options.moving;return{u_matrix:I||D.transform.calculateProjMatrix(T.tileID.toUnwrapped(),z),u_image:0,u_latrange:GE(0,T.tileID),u_light:[C.paint.get("hillshade-exaggeration"),O],u_shadow:A,u_highlight:M,u_emissive_strength:L,u_accent:R}})(e,n,r,e.terrain?t.projMatrix:null);e.uploadCommonUniforms(h,_,t.toUnwrapped());const{tileBoundsBuffer:v,tileBoundsIndexBuffer:b,tileBoundsSegments:E}=e.getTileBoundsBuffers(n);_.draw(e,f.TRIANGLES,s,l,c,Le.disabled,y,r.id,v,b,E)}function aM(e,t,n){if(!t.needsDEMTextureUpload)return;const r=e.context,s=r.gl;r.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||e.getTileTexture(n.stride);const l=n.getPixels();t.demTexture?t.demTexture.update(l,{premultiply:!1}):t.demTexture=new pr(r,l,e.terrainUseFloatDEM()?s.R32F:s.RGBA,{premultiply:!1}),t.needsDEMTextureUpload=!1}function lM(e,t,n){const r=e.context,s=r.gl;if(!t.dem)return;const l=t.dem;if(r.activeTexture.set(s.TEXTURE1),aM(e,t,l),!t.demTexture)return;t.demTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE);const c=l.dim;r.activeTexture.set(s.TEXTURE0);let h=t.hillshadeFBO;if(!h){const y=new pr(r,{width:c,height:c,data:null},s.RGBA);y.bind(s.LINEAR,s.CLAMP_TO_EDGE),h=t.hillshadeFBO=r.createFramebuffer(c,c,!0,"renderbuffer"),h.colorAttachment.set(y.texture)}r.bindFramebuffer.set(h.framebuffer),r.viewport.set([0,0,c,c]);const{tileBoundsBuffer:f,tileBoundsIndexBuffer:p,tileBoundsSegments:m}=e.getMercatorTileBoundsBuffers(),_=[];e.terrainUseFloatDEM()&&_.push("TERRAIN_DEM_FLOAT_FORMAT"),e.getOrCreateProgram("hillshadePrepare",{defines:_}).draw(e,s.TRIANGLES,ue.disabled,Re.disabled,Ye.unblended,Le.disabled,((y,v)=>{const b=v.stride,E=et.create();return et.ortho(E,0,st,-st,0,0,1),et.translate(E,E,[0,-st,0]),{u_matrix:E,u_image:1,u_dimension:[b,b],u_zoom:y.overscaledZ,u_unpack:v.unpackVector}})(t.tileID,l),n.id,f,p,m),t.needsHillshadePrepare=!1}const qE=e=>({u_matrix:new ye(e),u_image0:new Fe(e),u_skirt_height:new bt(e),u_ground_shadow_factor:new xe(e)}),Ks=(e,t,n)=>({u_matrix:e,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:n}),WE=(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b)=>({u_proj_matrix:Float32Array.from(e),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(r),u_merc_matrix:n,u_zoom_transition:s,u_merc_center:l,u_image0:0,u_frustum_tl:c,u_frustum_tr:h,u_frustum_br:f,u_frustum_bl:p,u_globe_pos:m,u_globe_radius:_,u_viewport:y,u_grid_matrix:b?Float32Array.from(b):new Float32Array(9),u_skirt_height:v}),nf=(e,t)=>{if(t>0&&e.terrain&&Y("Cutoff is currently disabled on terrain"),t<=0||e.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,0]}};const n=e.transform,r=Math.max(Math.abs(n._zoom-(e.minCutoffZoom-1)),1),s=n.isLODDisabled(!1)?Ts(60,45,n.pitch):Ts(30,15,n.pitch),l=n._farZ-n._nearZ,c=t*n.height,h=((1-(f=s))*(.75*n.cameraToCenterDistance)+f*(n._farZ+c))*r;var f;return{shouldRenderCutoff:s<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(h-n._nearZ)/l,(h-c-n._nearZ)/l]}}};function cM(e,t){return null!=e&&null!=t&&!(!e.hasData()||!t.hasData())&&null!=e.demTexture&&null!=t.demTexture&&e.tileID.key!==t.tileID.key}const rf=new class{constructor(){this.operations={}}newMorphing(e,t,n,r,s){if(e in this.operations){const l=this.operations[e];l.to.tileID.key!==n.tileID.key&&(l.queued=n)}else this.operations[e]={startTime:r,phase:0,duration:s,from:t,to:n,queued:null}}getMorphValuesForProxy(e){if(!(e in this.operations))return null;const t=this.operations[e];return{from:t.from,to:t.to,phase:t.phase}}update(e){for(const t in this.operations){const n=this.operations[t];for(n.phase=(e-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,e)){delete this.operations[t];break}}}_nextOp(e,t){return!!e.queued&&(e.from=e.to,e.to=e.queued,e.queued=null,e.phase=0,e.startTime=t,!0)}_validOp(e){return e.from.hasData()&&e.to.hasData()}},ZE={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Wm(e,t,n){if(0===t)return 0;const r=t<1&&514===n?.25/t:1;return 6*Math.pow(1.5,22-e)*Math.max(t,1)*r}function uM(e,t){const n=1<<e.z;return!t&&(0===e.x||e.x===n-1)||0===e.y||e.y===n-1}const XE=e=>({u_matrix:e});function YE(e,t,n,r,s){if(s>0){const l=me.now(),c=(l-e.timeAdded)/s,h=t?(l-t.timeAdded)/s:-1,f=n.getSource(),p=r.coveringZoomLevel({tileSize:f.tileSize,roundZoom:f.roundZoom}),m=!t||Math.abs(t.tileID.overscaledZ-p)>Math.abs(e.tileID.overscaledZ-p),_=m&&e.refreshedUponExpiration?1:Gt(m?c:1-h,0,1);return e.refreshedUponExpiration&&c>=1&&(e.refreshedUponExpiration=!1),t?{opacity:1,mix:1-_}:{opacity:_,mix:0}}return{opacity:1,mix:0}}class KE extends Bo{constructor(t){const n={type:"raster-dem",maxzoom:t.transform.maxZoom},r=new Am(Ac(),null),s=V0("mock-dem",n,r,t.style);super("mock-dem",s,!1),s.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class JE extends Bo{constructor(t){const n=V0("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new Am(Ac(),null),t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,r){if(t.freezeTileCoverage)return;this.transform=t;const s=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((l,c)=>{if(l[c.key]="",!this._tiles[c.key]){const h=new co(c,this._source.tileSize*c.overscaleFactor(),t.tileZoom);h.state="loaded",this._tiles[c.key]=h}return l},{});for(const l in this._tiles)l in s||(this.freeFBO(l),this._tiles[l].unloadVectorData(),delete this._tiles[l])}freeFBO(t){const n=this.proxyCachedFBO[t];if(void 0!==n){const r=Object.values(n);this.renderCachePool.push(...r),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class hM extends tn{constructor(t,n,r){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=r}}class gs extends class qs{isDataAvailableAtPoint(t){const n=this._source();if(this.isUsingMockSource()||!n||t.y<0||t.y>1)return!1;const r=n.getSource().maxzoom,s=1<<r,l=Math.floor(t.x),c=Math.floor((t.x-l)*s),h=Math.floor(t.y*s),f=this.findDEMTileFor(new tn(r,l,r,c,h));return!(!f||!f.dem)}getAtPointOrZero(t,n=0){return this.getAtPoint(t,n)||0}getAtPoint(t,n,r=!0){if(this.isUsingMockSource())return null;null==n&&(n=null);const s=this._source();if(!s||t.y<0||t.y>1)return n;const l=s.getSource().maxzoom,c=1<<l,h=Math.floor(t.x),f=t.x-h,p=new tn(l,h,l,Math.floor(f*c),Math.floor(t.y*c)),m=this.findDEMTileFor(p);if(!m||!m.dem)return n;const _=m.dem,y=1<<m.tileID.canonical.z,v=(f*y-m.tileID.canonical.x)*_.dim,b=(t.y*y-m.tileID.canonical.y)*_.dim,E=Math.floor(v),D=Math.floor(b);return(r?this.exaggeration():1)*de(de(_.get(E,D),_.get(E,D+1),b-D),de(_.get(E+1,D),_.get(E+1,D+1),b-D),v-E)}getAtTileOffset(t,n,r){const s=1<<t.canonical.z;return this.getAtPointOrZero(new He(t.wrap+(t.canonical.x+n/st)/s,(t.canonical.y+r/st)/s))}getAtTileOffsetFunc(t,n,r,s){return l=>{const c=this.getAtTileOffset(t,l.x,l.y),h=s.upVector(t.canonical,l.x,l.y),f=s.upVectorScale(t.canonical,n,r).metersToTile;return H.scale(h,h,c*f),h}}getForTilePoints(t,n,r,s){if(this.isUsingMockSource())return!1;const l=Sl.create(this,t,s);return!!l&&(n.forEach(c=>{c[2]=this.exaggeration()*l.getElevationAt(c[0],c[1],r)}),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const n=this.findDEMTileFor(t);if(!n||!n.dem)return null;const r=n.dem.tree,s=n.tileID,l=1<<t.canonical.z-s.canonical.z;let c=t.canonical.x/l-s.canonical.x,h=t.canonical.y/l-s.canonical.y,f=0;for(let p=0;p<t.canonical.z-s.canonical.z&&!r.leaves[f];p++){c*=2,h*=2;const m=2*Math.floor(h)+Math.floor(c);f=r.childOffsets[f]+m,c%=1,h%=1}return{min:this.exaggeration()*r.minimums[f],max:this.exaggeration()*r.maximums[f]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,n,r){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}}{constructor(t,n){super(),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[r,s,l]=function(f){const p=new ro,m=new er,_=131;p.reserve(17161),m.reserve(33800);const y=64,v=8224;for(let D=-y;D<8288;D+=y)for(let T=-y;T<8288;T+=y){const C=T<0||T>v||D<0||D>v?24575:0,I=Gt(Math.round(T),0,st),A=Gt(Math.round(D),0,st);p.emplaceBack(I+C,A)}const E=(D,T)=>{const C=T*_+D;m.emplaceBack(C+1,C,C+_),m.emplaceBack(C+_,C+_+1,C+1)};for(let D=1;D<129;D++)for(let T=1;T<129;T++)E(T,D);return[0,129].forEach(D=>{for(let T=0;T<130;T++)E(T,D),E(D,T)}),[p,m,32768]}(),c=t.context;this.gridBuffer=c.createVertexBuffer(r,_l.members),this.gridIndexBuffer=c.createIndexBuffer(s),this.gridSegments=ln.simpleSegment(0,0,r.length,s.length),this.gridNoSkirtSegments=ln.simpleSegment(0,0,r.length,l),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new JE(n.map),this.orthoMatrix=et.create(),et.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,st,0,st,0,1);const h=c.gl;this._overlapStencilMode=new Re({func:h.GEQUAL,mask:255},0,255,h.KEEP,h.KEEP,h.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new KE(n.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,n,r){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const s=t.terrain.properties,l=0===t.terrain.drapeRenderMode,c=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=me.now();const h=t.terrain&&t.terrain.scope,f=s.get("source"),p=l?this._mockSourceCache:t.getSourceCache(f,h);if(!p)return void Y(`Couldn't find terrain source "${f}".`);if(this.sourceCache=p,this._exaggeration=c?this.calculateExaggeration(n):s.get("exaggeration"),!n.projection.requiresDraping&&c&&0===this._exaggeration)return void this._disable();this.enabled=!0;const m=()=>{this.sourceCache.used&&Y(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const _=this.getScaledDemTileSize();this.sourceCache.update(n,_,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,m(),this._initializing=!0),m(),n.updateElevation(!0,r),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){const n=this._previousCameraAltitude,r=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=r;const s=null!=n?r-n:Number.MAX_VALUE;if(Math.abs(s)<2)return this._exaggeration;const l=t.zoom,c=this._style.terrain;if(!this._previousUpdateTimestamp)return c.getExaggeration(l);let h=l-this._previousZoom;const f=this._previousUpdateTimestamp;let p=l;null!=this._evaluationZoom&&(p=this._evaluationZoom,Math.abs(l-p)>.5&&(h=.5*(l-p+h)),h*s<0&&(p+=h)),this._evaluationZoom=p;const m=c.getExaggeration(p),_=m===c.getExaggeration(Math.max(0,p-.1));if(_&&Math.abs(m-this._exaggeration)<.01)return m;let y=Math.min(.1,.00375*(this._updateTimestamp-f));return(_||m<.1||Math.abs(h)<1e-4)&&(y=Math.min(.2,4*y)),de(this._exaggeration,m,y)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&"source"===t.dataType?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):"style"===t.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,r=this.painter.transform;this._initializing&&(this._initializing=0===r._centerAltitude&&-1===this.getAtPointOrZero(He.fromLngLat(r.center),-1),this._emptyDEMTextureDirty=!this._initializing);const s=this.proxyCoords=n.getIds().map(f=>{const p=n.getTileByID(f).tileID;return p.projMatrix=r.calculateProjMatrix(p.toUnwrapped()),p});!function(f,p){const m=p.transform.pointCoordinate(p.transform.getCameraPoint()),_=new tt(m.x,m.y);f.sort((y,v)=>{if(v.overscaledZ-y.overscaledZ)return v.overscaledZ-y.overscaledZ;const b=new tt(y.canonical.x+(1<<y.canonical.z)*y.wrap,y.canonical.y),E=new tt(v.canonical.x+(1<<v.canonical.z)*v.wrap,v.canonical.y),D=_.mult(1<<y.canonical.z);return D.x-=.5,D.y-=.5,D.distSqr(b)-D.distSqr(E)})}(s,this.painter);const l=this.proxyToSource||{};this.proxyToSource={},s.forEach(f=>{this.proxyToSource[f.key]={}}),this.terrainTileForTile={};const c=this._style._mergedSourceCaches;for(const f in c){const p=c[f];if(!p.used||(p!==this.sourceCache&&this.resetTileLookupCache(p.id),this._setupProxiedCoordsForOrtho(p,t[f],l),p.usedForTerrain))continue;const m=t[f];p.getSource().reparseOverscaled&&this._assignTerrainTiles(m)}this.proxiedCoords[n.id]=s.map(f=>new hM(f,f.key,this.orthoMatrix)),this._assignTerrainTiles(s),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(l),this.renderingToTexture=!1;const h={};this._visibleDemTiles=[];for(const f of this.proxyCoords){const p=this.terrainTileForTile[f.key];if(!p)continue;const m=p.tileID.key;m in h||(this._visibleDemTiles.push(p),h[m]=m)}}_assignTerrainTiles(t){this._initializing||t.forEach(n=>{if(this.terrainTileForTile[n.key])return;const r=this._findTileCoveringTileID(n,this.sourceCache);r&&(this.terrainTileForTile[n.key]=r)})}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const r in this.terrainTileForTile){const s=this.terrainTileForTile[r],l=s.dem;!l||s.demTexture&&!s.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),aM(this.painter,s,l))}}_prepareDemTileUniforms(t,n,r,s){if(!n||null==n.demTexture)return!1;const l=t.tileID.canonical,c=Math.pow(2,n.tileID.canonical.z-l.z),h=s||"";return r[`u_dem_tl${h}`]=[l.x*c%1,l.y*c%1],r[`u_dem_scale${h}`]=c,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const t=this.painter.context,n=t.gl;if(!this._emptyDepthBufferTexture){const r=new rr({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new pr(t,r,n.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let t=0;const n=this._visibleDemTiles.reduce((r,s)=>{if(!s.dem)return r;const l=s.dem.tree.minimums[0];return l>0&&t++,r+l},0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const r=this._getLoadedAreaMinimum(),[s,l]=(()=>{if(this.painter.terrainUseFloatDEM()){const h=new cy({width:1,height:1},new Float32Array([r]));return[n.R32F,h]}{const h=new rr({width:1,height:1},new Uint8Array(yc.pack(r,this.sourceCache.getSource().encoding)));return[n.RGBA,h]}})();this._emptyDEMTextureDirty=!1;let c=this._emptyDEMTexture;return c?c.update(l,{premultiply:!1}):c=this._emptyDEMTexture=new pr(t,l,s,{premultiply:!1}),c}setupElevationDraw(t,n,r){const s=this.painter.context,l=s.gl,c=(h=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:yc.getUnpackVector(h),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0});var h;c.u_exaggeration=this.exaggeration();let f=null,p=null,m=1;if(r&&r.morphing&&this._useVertexMorphing){const v=r.morphing.srcDemTile,b=r.morphing.dstDemTile;m=r.morphing.phase,v&&b&&(this._prepareDemTileUniforms(t,v,c,"_prev")&&(p=v),this._prepareDemTileUniforms(t,b,c)&&(f=b))}const _=v=>v&&v.demTexture&&this.painter.terrainUseFloatDEM()?l.LINEAR:l.NEAREST,y=v=>{c.u_dem_size=1===v.size[0]?1:v.size[0]-2};if(p&&f)s.activeTexture.set(l.TEXTURE2),f.demTexture.bind(_(f),l.CLAMP_TO_EDGE),s.activeTexture.set(l.TEXTURE4),p.demTexture.bind(_(p),l.CLAMP_TO_EDGE),f.demTexture&&y(f.demTexture),c.u_dem_lerp=m;else{f=this.terrainTileForTile[t.tileID.key],s.activeTexture.set(l.TEXTURE2);const v=this._prepareDemTileUniforms(t,f,c)?f.demTexture:this.emptyDEMTexture;v.bind(_(f),l.CLAMP_TO_EDGE),y(v)}if(s.activeTexture.set(l.TEXTURE3),r&&r.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE),this._depthFBO&&(c.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE),c.u_depth_size_inv=[1,1]),r&&r.useMeterToDem&&f){const v=(1<<f.tileID.canonical.z)*gn(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;c.u_meter_to_dem=v}if(r&&r.labelPlaneMatrixInv&&(c.u_label_plane_matrix_inv=r.labelPlaneMatrixInv),n.setTerrainUniformValues(s,c),"globe"===this.painter.transform.projection.name){const v=this.globeUniformValues(this.painter.transform,t.tileID.canonical,r&&r.useDenormalizedUpVectorScale);n.setGlobeUniformValues(s,v)}}globeUniformValues(t,n,r){const s=t.projection;return{u_tile_tl_up:s.upVector(n,0,0),u_tile_tr_up:s.upVector(n,st,0),u_tile_br_up:s.upVector(n,st,st),u_tile_bl_up:s.upVector(n,0,st),u_tile_up_scale:r?kp(1):s.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,r=this.painter.context;0!==t.length&&(r.bindFramebuffer.set(null),r.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(s,l,c,h,f){if("globe"===s.transform.projection.name)!function(p,m,_,y,v){const b=p.context,E=b.gl;let D,T;const C=p.transform,I=J1(p,b,C),A=($,j)=>{if(T===j)return;const Z=[ZE[j],"PROJECTION_GLOBE_VIEW"];I&&Z.push("CUSTOM_ANTIALIASING");const K=p.isTileAffectedByFog($);D=p.getOrCreateProgram("globeRaster",{defines:Z,overrideFog:K}),T=j},M=p.colorModeForRenderPass(),R=new ue(E.LEQUAL,ue.ReadWrite,p.depthRangeFor3D);rf.update(v);const L=function($){const j=$.pixelsPerMeter,Z=j/gn(1,$.center.lat),K=et.identity(new Float64Array(16));return et.translate(K,K,[$.point.x,$.point.y,0]),et.scale(K,K,[Z,Z,j]),Float32Array.from(K)}(C),O=[Xr(C.center.lng),Ur(C.center.lat)],z=p.globeSharedBuffers,N=[C.width*me.devicePixelRatio,C.height*me.devicePixelRatio],V=Float32Array.from(C.globeMatrix),B={useDenormalizedUpVectorScale:!0};{const $=p.transform,j=Wm($.zoom,m.exaggeration(),m.sourceCache._source.tileSize);T=-1;const Z=E.TRIANGLES;for(const K of y){const Q=_.getTile(K),W=Re.disabled,X=m.prevTerrainTileForTile[K.key],nt=m.terrainTileForTile[K.key];cM(X,nt)&&rf.newMorphing(K.key,X,nt,v,250),b.activeTexture.set(E.TEXTURE0),Q.texture.bind(E.LINEAR,E.CLAMP_TO_EDGE);const ot=rf.getMorphValuesForProxy(K.key),lt=ot?1:0;ot&&li(B,{morphing:{srcDemTile:ot.from,dstDemTile:ot.to,phase:Ga(ot.phase)}});const ht=yl(K.canonical),ft=Iu(ht.getCenter().lat),at=Z_(K.canonical,ht,ft,$.worldSize/$._pixelsPerMercatorPixel),ut=$s(wo(K.canonical)),Et=WE($.projMatrix,V,L,ut,Mr($.zoom),O,$.frustumCorners.TL,$.frustumCorners.TR,$.frustumCorners.BR,$.frustumCorners.BL,$.globeCenterInViewSpace,$.globeRadius,N,j,at);if(A(K,lt),D&&(m.setupElevationDraw(Q,D,B),p.uploadCommonUniforms(b,D,K.toUnwrapped()),z)){const[Ot,kt,zt]=z.getGridBuffers(ft,0!==j);D.draw(p,Z,R,W,M,Le.backCCW,Et,"globe_raster",Ot,kt,zt)}}}if(z&&(p.renderDefaultNorthPole||p.renderDefaultSouthPole)){const $=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];I&&$.push("CUSTOM_ANTIALIASING"),D=p.getOrCreateProgram("globeRaster",{defines:$});for(const j of y){const{x:Z,y:K,z:Q}=j.canonical,W=0===K,X=K===(1<<Q)-1,[nt,ot,lt,ht]=z.getPoleBuffers(Q,!1);if(ht&&(W||X)){const ft=_.getTile(j);b.activeTexture.set(E.TEXTURE0),ft.texture.bind(E.LINEAR,E.CLAMP_TO_EDGE);let at=Op(Q,Z,C);const ut=$s(wo(j.canonical)),Et=(Ot,kt)=>Ot.draw(p,E.TRIANGLES,R,Re.disabled,M,Le.disabled,WE(C.projMatrix,at,at,ut,0,O,C.frustumCorners.TL,C.frustumCorners.TR,C.frustumCorners.BR,C.frustumCorners.BL,C.globeCenterInViewSpace,C.globeRadius,N,0),"globe_pole_raster",kt,lt,ht);m.setupElevationDraw(ft,D,B),p.uploadCommonUniforms(b,D,j.toUnwrapped()),W&&p.renderDefaultNorthPole&&Et(D,nt),X&&p.renderDefaultSouthPole&&(at=et.scale(et.create(),at,[1,-1,1]),Et(D,ot))}}}}(s,l,c,h,f);else{const p=s.context,m=p.gl;let _,y;const v=s.shadowRenderer,b=nf(s,s.longestCutoffRange),E=M=>{if(y===M)return;const R=[];R.push(ZE[M]),b.shouldRenderCutoff&&R.push("RENDER_CUTOFF"),_=s.getOrCreateProgram("terrainRaster",{defines:R}),y=M},D=s.colorModeForRenderPass(),T=new ue(m.LEQUAL,ue.ReadWrite,s.depthRangeFor3D);rf.update(f);const C=s.transform,I=Wm(C.zoom,l.exaggeration(),l.sourceCache._source.tileSize);let A=[0,0,0];if(v){const M=s.style.directionalLight,R=s.style.ambientLight;M&&R&&(A=fh(M,R))}{y=-1;const M=m.TRIANGLES,[R,L]=[l.gridIndexBuffer,l.gridSegments];for(const O of h){const z=c.getTile(O),N=Re.disabled,V=l.prevTerrainTileForTile[O.key],B=l.terrainTileForTile[O.key];cM(V,B)&&rf.newMorphing(O.key,V,B,f,250),p.activeTexture.set(m.TEXTURE0),z.texture.bind(m.LINEAR,m.CLAMP_TO_EDGE,m.LINEAR_MIPMAP_NEAREST);const $=rf.getMorphValuesForProxy(O.key),j=$?1:0;let Z;$&&(Z={morphing:{srcDemTile:$.from,dstDemTile:$.to,phase:Ga($.phase)}});const K=Ks(O.projMatrix,uM(O.canonical,C.renderWorldCopies)?I/10:I,A);if(E(j),!_)continue;l.setupElevationDraw(z,_,Z);const Q=O.toUnwrapped();v&&v.setupShadows(Q,_),s.uploadCommonUniforms(p,_,Q,null,b),_.draw(s,M,T,N,D,Le.backCCW,K,"terrain_raster",l.gridBuffer,R,L)}}}}(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(0===this._drapedRenderBatches.length)return t+1;this.renderingToTexture=!0;const n=this.painter,r=this.painter.context,s=this.proxySourceCache,l=this.proxiedCoords[s.id],c=this._drapedRenderBatches.shift(),h=n.style.order,f=[];let p=0;for(const m of l){const _=s.getTileByID(m.proxyTileKey),y=s.proxyCachedFBO[m.key]?s.proxyCachedFBO[m.key][t]:void 0,v=void 0!==y?s.renderCache[y]:this.pool[p++],b=void 0!==y;if(_.texture=v.tex,b&&!v.dirty){f.push(_.tileID);continue}let E;r.bindFramebuffer.set(v.fb.framebuffer),this.renderedToTile=!1,v.dirty&&(r.clear({color:le.transparent,stencil:0}),v.dirty=!1);for(let D=c.start;D<=c.end;++D){const T=n.style._mergedLayers[h[D]];if(T.isHidden(n.transform.zoom))continue;const C=n.style.getLayerSourceCache(T),I=C?this.proxyToSource[m.key][C.id]:[m];if(!I)continue;const A=I;r.viewport.set([0,0,v.fb.width,v.fb.height]),E!==(C?C.id:null)&&(this._setupStencil(v,I,T,C),E=C?C.id:null),n.renderLayer(n,C,T,A)}if(0===this._drapedRenderBatches.length)for(const D of this._pendingGroundEffectLayers){const T=n.style._mergedLayers[h[D]];if(T.isHidden(n.transform.zoom))continue;const C=n.style.getLayerSourceCache(T),I=C?this.proxyToSource[m.key][C.id]:[m];if(!I)continue;const A=I;r.viewport.set([0,0,v.fb.width,v.fb.height]),E!==(C?C.id:null)&&(this._setupStencil(v,I,T,C),E=C?C.id:null),n.renderLayer(n,C,T,A)}this.renderedToTile?(v.dirty=!0,f.push(_.tileID)):b||--p,5===p&&(p=0,this.renderToBackBuffer(f))}return this.renderToBackBuffer(f),this.renderingToTexture=!1,r.bindFramebuffer.set(null),r.viewport.set([0,0,n.width,n.height]),c.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let r=-1,s=n;for(let l=0;l<n;++l)this._style.isLayerDraped(t._mergedLayers[t.order[l]])?r=Math.max(r,l):s=Math.min(s,l);return s>r}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(n=>n.dem).forEach(n=>{t=Math.min(t,n.dem.tree.minimums[0])}),0===t?t:(t-30)*this._exaggeration}raycast(t,n,r){if(!this._visibleDemTiles)return null;const s=this._visibleDemTiles.filter(l=>l.dem).map(l=>{const c=l.tileID,h=1<<c.overscaledZ,{x:f,y:p}=c.canonical,m=f/h,_=(f+1)/h,y=p/h,v=(p+1)/h;return{minx:m,miny:y,maxx:_,maxy:v,t:l.dem.tree.raycastRoot(m,y,_,v,t,n,r),tile:l}});s.sort((l,c)=>(null!==l.t?l.t:Number.MAX_VALUE)-(null!==c.t?c.t:Number.MAX_VALUE));for(const l of s){if(null==l.t)return null;const c=l.tile.dem.tree.raycast(l.minx,l.miny,l.maxx,l.maxy,t,n,r);if(null!=c)return c}return null}_createFBO(){const t=this.painter.context,n=t.gl,r=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const s=new pr(t,{width:r[0],height:r[1],data:null},n.RGBA);s.bind(n.LINEAR,n.CLAMP_TO_EDGE);const l=t.createFramebuffer(r[0],r[1],!0,null);return l.colorAttachment.set(s.texture),l.depthAttachment=new aC(t,l.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,r[0],r[1]),this._stencilRef=0,l.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):l.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&!t.extTextureFilterAnisotropicForceOff&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:l,tex:s,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const n=this._style._mergedLayers[t],r=n.isHidden(this.painter.transform.zoom);return"custom"===n.type?!r&&n.shouldRedrape():!r&&n.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const r of this._style.getSources())if(r instanceof IE){t=!0;break}if(!t)return;const n={};for(let r=0;r<this._style.order.length;++r){const s=this._style._mergedLayers[this._style.order[r]],l=this._style.getLayerSourceCache(s);if(l&&!n[l.id]&&!s.isHidden(this.painter.transform.zoom)&&"line"===s.type&&s.widthExpression()instanceof Dr){n[l.id]=!0;for(const c of this.proxyCoords){const h=this.proxyToSource[c.key][l.id];if(h)for(const f of h)this._clearRenderCacheForTile(l.id,f)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const r in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[r]._source instanceof qd){t=!0;break}if(!t)return;const n={};for(let r=0;r<this._style.order.length;++r){const s=this._style._mergedLayers[this._style.order[r]],l=this._style.getLayerSourceCache(s);if(!l||n[l.id]||s.isHidden(this.painter.transform.zoom)||"raster"!==s.type)continue;const c=s.paint.get("raster-fade-duration");for(const h of this.proxyCoords){const f=this.proxyToSource[h.key][l.id];if(f)for(const p of f){const m=YE(l.getTile(p),l.findLoadedParent(p,0),l,this.painter.transform,c);(1!==m.opacity||0!==m.mix)&&this._clearRenderCacheForTile(l.id,p)}}}}_setupDrapedRenderBatches(){const t=this._style.order,n=t.length;if(0===n)return;const r=[];this._pendingGroundEffectLayers=[];let s,l=0,c=this._style._mergedLayers[t[l]];for(;!this._style.isLayerDraped(c)&&c.isHidden(this.painter.transform.zoom)&&++l<n;)c=this._style._mergedLayers[t[l]];for(;l<n;++l){const h=this._style._mergedLayers[t[l]];h.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(h)?void 0===s&&(s=l):("fill-extrusion"===h.type&&this._pendingGroundEffectLayers.push(l),void 0!==s&&(r.push({start:s,end:l-1}),s=void 0)))}if(void 0!==s&&r.push({start:s,end:l-1}),0!==r.length){const h=r[r.length-1];this._pendingGroundEffectLayers.every(p=>p>h.end)||Y("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=r}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const c=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let h=0;h<c.length;++h){const f=Object.values(c[h]);n.renderCachePool.push(...f)}}return}this._clearRasterLayersFromRenderCache();const r=this.proxyCoords,s=this._tilesDirty;for(let c=r.length-1;c>=0;c--){const h=r[c];if(n.getTileByID(h.key),void 0!==n.proxyCachedFBO[h.key]){const f=t[h.key],p=this.proxyToSource[h.key];let m=0;for(const _ in p){const y=p[_],v=f[_];if(!v||v.length!==y.length||y.some((b,E)=>b!==v[E]||s[_]&&s[_].hasOwnProperty(b.key))){m=-1;break}++m}for(const _ in n.proxyCachedFBO[h.key])n.renderCache[n.proxyCachedFBO[h.key][_]].dirty=m<0||m!==Object.values(f).length}}const l=[...this._drapedRenderBatches];l.sort((c,h)=>h.end-h.start-(c.end-c.start));for(const c of l)for(const h of r){if(n.proxyCachedFBO[h.key])continue;let f=n.renderCachePool.pop();void 0===f&&n.renderCache.length<50&&(f=n.renderCache.length,n.renderCache.push(this._createFBO())),void 0!==f&&(n.proxyCachedFBO[h.key]={},n.proxyCachedFBO[h.key][c.start]=f,n.renderCache[f].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,r,s){if(!s||!this._sourceTilesOverlap[s.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const l=this.painter.context,c=l.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let h;if(r.isTileClipped())h=n.length,this._overlapStencilMode.test={func:c.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);h=1,this._overlapStencilMode.test={func:c.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+h>255&&(l.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=h,this._overlapStencilMode.ref=this._stencilRef,r.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Re.disabled}_renderTileClippingMasks(t,n){const r=this.painter,s=this.painter.context,l=s.gl;r._tileClippingMaskIDs={},s.setColorMode(Ye.disabled),s.setDepthMode(ue.disabled);const c=r.getOrCreateProgram("clippingMask");for(const h of t){const f=r._tileClippingMaskIDs[h.key]=--n;c.draw(r,l.TRIANGLES,ue.disabled,new Re({func:l.ALWAYS,mask:0},f,255,l.KEEP,l.KEEP,l.REPLACE),Ye.disabled,Le.disabled,XE(h.projMatrix),"$clipping",r.tileExtentBuffer,r.quadTriangleIndexBuffer,r.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const r=[t.x,t.y,1,1];an.transformMat4(r,r,n.pixelMatrixInverse),an.scale(r,r,1/r[3]),r[0]/=n.worldSize,r[1]/=n.worldSize;const s=n._camera.position,l=gn(1,n.center.lat),c=[s[0],s[1],s[2]/l,0],h=H.subtract([],r.slice(0,3),c);H.normalize(h,h);const f=this.raycast(c,h,this._exaggeration);return null!==f&&f?(H.scaleAndAdd(c,c,h,f),c[3]=c[2],c[2]*=l,c):null}drawDepth(){const t=this.painter,n=t.context,r=this.proxySourceCache,s=Math.ceil(t.width),l=Math.ceil(t.height);if(!this._depthFBO||this._depthFBO.width===s&&this._depthFBO.height===l||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const c=n.gl,h=n.createFramebuffer(s,l,!0,"renderbuffer");n.activeTexture.set(c.TEXTURE0);const f=new pr(n,{width:s,height:l,data:null},c.RGBA);f.bind(c.NEAREST,c.CLAMP_TO_EDGE),h.colorAttachment.set(f.texture);const p=n.createRenderbuffer(n.gl.DEPTH_COMPONENT16,s,l);h.depthAttachment.set(p),this._depthFBO=h,this._depthTexture=f}n.bindFramebuffer.set(this._depthFBO.framebuffer),n.viewport.set([0,0,s,l]),function(c,h,f,p){if("globe"===c.transform.projection.name)return;const m=c.context,_=m.gl;m.clear({depth:1});const y=c.getOrCreateProgram("terrainDepth"),v=new ue(_.LESS,ue.ReadWrite,c.depthRangeFor3D);for(const b of p){const E=f.getTile(b),D=Ks(b.projMatrix,0,[0,0,0]);h.setupElevationDraw(E,y),y.draw(c,_.TRIANGLES,v,Re.disabled,Ye.unblended,Le.backCCW,D,"terrain_depth",h.gridBuffer,h.gridIndexBuffer,h.gridNoSkirtSegments)}}(t,this,r,this.proxyCoords)}_setupProxiedCoordsForOrtho(t,n,r){if(t.getSource()instanceof Do)return this._setupProxiedCoordsForImageSource(t,n,r);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const s=this.proxiedCoords[t.id]=[],l=this.proxyCoords;for(let h=0;h<l.length;h++){const f=l[h],p=this._findTileCoveringTileID(f,t);if(p){const m=this._createProxiedId(f,p,r[f.key]&&r[f.key][t.id]);s.push(m),this.proxyToSource[f.key][t.id]=[m]}}let c=!1;for(let h=0;h<n.length;h++){const f=t.getTile(n[h]);if(!f||!f.hasData())continue;const p=this._findTileCoveringTileID(f.tileID,this.proxySourceCache);if(p&&p.tileID.canonical.z!==f.tileID.canonical.z){const m=this.proxyToSource[p.tileID.key][t.id],_=this._createProxiedId(p.tileID,f,r[p.tileID.key]&&r[p.tileID.key][t.id]);m?m.splice(m.length-1,0,_):this.proxyToSource[p.tileID.key][t.id]=[_],s.push(_),c=!0}}this._sourceTilesOverlap[t.id]=c}_setupProxiedCoordsForImageSource(t,n,r){if(!t.getSource().loaded())return;const s=this.proxiedCoords[t.id]=[],l=this.proxyCoords,c=t.getSource(),h=c.tileID;if(!h)return;const f=new tt(h.x,h.y)._div(1<<h.z),p=c.coordinates.map(He.fromLngLat).reduce((_,y)=>(_.min.x=Math.min(_.min.x,y.x-f.x),_.min.y=Math.min(_.min.y,y.y-f.y),_.max.x=Math.max(_.max.x,y.x-f.x),_.max.y=Math.max(_.max.y,y.y-f.y),_),{min:new tt(Number.MAX_VALUE,Number.MAX_VALUE),max:new tt(-Number.MAX_VALUE,-Number.MAX_VALUE)}),m=(_,y)=>{const v=_.wrap+_.canonical.x/(1<<_.canonical.z),b=_.canonical.y/(1<<_.canonical.z),E=st/(1<<_.canonical.z),D=y.wrap+y.canonical.x/(1<<y.canonical.z),T=y.canonical.y/(1<<y.canonical.z);return v+E<D+p.min.x||v>D+p.max.x||b+E<T+p.min.y||b>T+p.max.y};for(let _=0;_<l.length;_++){const y=l[_];for(let v=0;v<n.length;v++){const b=t.getTile(n[v]);if(!b||!b.hasData()||m(y,b.tileID))continue;const E=this._createProxiedId(y,b,r[y.key]&&r[y.key][t.id]),D=this.proxyToSource[y.key][t.id];D?D.push(E):this.proxyToSource[y.key][t.id]=[E],s.push(E)}}}_createProxiedId(t,n,r){let s=this.orthoMatrix;if(r){const l=r.find(c=>c.key===n.tileID.key);if(l)return l}if(n.tileID.key!==t.key){const l=t.canonical.z-n.tileID.canonical.z;let c,h,f;s=et.create();const p=n.tileID.wrap-t.wrap<<t.overscaledZ;l>0?(c=st>>l,h=c*((n.tileID.canonical.x<<l)-t.canonical.x+p),f=c*((n.tileID.canonical.y<<l)-t.canonical.y)):(c=st<<-l,h=st*(n.tileID.canonical.x-(t.canonical.x+p<<-l)),f=st*(n.tileID.canonical.y-(t.canonical.y<<-l))),et.ortho(s,0,c,0,c,0,1),et.translate(s,s,[h,f,0])}return new hM(n.tileID,t.key,s)}_findTileCoveringTileID(t,n){let r=n.getTile(t);if(r&&r.hasData())return r;const s=this._findCoveringTileCache[n.id],l=s[t.key];if(r=l?n.getTileByID(l):null,r&&r.hasData()||null===l)return r;let c=r?r.tileID:t,h=c.overscaledZ;const f=n.getSource().minzoom,p=[];if(!l){const _=n.getSource().maxzoom;if(t.canonical.z>=_){const y=t.canonical.z-_;n.getSource().reparseOverscaled?(h=Math.max(t.canonical.z+2,n.transform.tileZoom),c=new tn(h,t.wrap,_,t.canonical.x>>y,t.canonical.y>>y)):0!==y&&(h=_,c=new tn(h,t.wrap,_,t.canonical.x>>y,t.canonical.y>>y))}c.key!==t.key&&(p.push(c.key),r=n.getTile(c))}const m=_=>{p.forEach(y=>{s[y]=_}),p.length=0};for(h-=1;h>=f&&(!r||!r.hasData());h--){r&&m(r.tileID.key);const _=c.calculateScaledKey(h);if(r=n.getTileByID(_),r&&r.hasData())break;const y=s[_];if(null===y)break;void 0===y?p.push(_):r=n.getTileByID(y)}return m(r?r.tileID.key:null),r&&r.hasData()?r:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let r=this._tilesDirty[t];r||(r=this._tilesDirty[t]={}),r[n.key]=!0}}function dM(e,t,n){const r=function(h,f,p){const m=H.dot(f,h),_=H.dot(p,[.2126,.7152,.0722]),y=(b,E,D)=>(1-D)*b+D*E,v=y(1-.3*Math.min(_,1),1,Math.min(m+1,1));return y(.92,1,Math.asin(Gt(f[2],-1,1))/Math.PI+.5)*v}(e,[0,0,1],t),s=[0,0,0];H.scale(s,n.slice(0,3),r);const l=[0,0,0];H.scale(l,t.slice(0,3),e[2]);const c=[0,0,0];return H.add(c,s,l),Cn(c)}const J0=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],fM=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class Hr{static cacheKey(t,n,r,s){let l=`${n}${s?s.cacheKey:""}`;for(const c of r)t.usedDefines.includes(c)&&(l+=`/${c}`);return l}constructor(t,n,r,s,l,c){const h=t.gl;this.program=h.createProgram(),this.configuration=s,this.name=n,this.fixedDefines=[...c];const f=function(T){const C=[];for(let I=0;I<T.length;I++){if(null===T[I])continue;const A=T[I].split(" ");C.push(A.pop())}return C}(r.staticAttributes),p=s?s.getBinderAttributes():[],m=f.concat(p);let _=s?s.defines():[];_=_.concat(c.map(T=>`#define ${T}`));const y="#version 300 es\n";let v=y+_.concat("\n#ifdef GL_ES\nprecision mediump float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",Y0,uh.fragmentSource).join("\n");for(const T of r.fragmentIncludes)v+=`\n${Lc[T]}`;v+=`\n${r.fragmentSource}`;let b=y+_.concat("\n#ifdef GL_ES\nprecision highp float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",Y0,uh.vertexSource).join("\n");for(const T of r.vertexIncludes)b+=`\n${Lc[T]}`;b+=`\n${r.vertexSource}`;const E=h.createShader(h.FRAGMENT_SHADER);if(h.isContextLost())return void(this.failedToCreate=!0);h.shaderSource(E,v),h.compileShader(E),h.attachShader(this.program,E);const D=h.createShader(h.VERTEX_SHADER);if(h.isContextLost())this.failedToCreate=!0;else{h.shaderSource(D,b),h.compileShader(D),h.attachShader(this.program,D),this.attributes={},this.numAttributes=m.length;for(let T=0;T<this.numAttributes;T++)if(m[T]){const C=m[T].startsWith("a_")?m[T]:`a_${m[T]}`;h.bindAttribLocation(this.program,T,C),this.attributes[C]=T}h.linkProgram(this.program),h.deleteShader(D),h.deleteShader(E),this.fixedUniforms=l(t),this.binderUniforms=s?s.getUniforms(t):[],c.includes("TERRAIN")&&(this.terrainUniforms={u_dem:new Fe(T=t),u_dem_prev:new Fe(T),u_dem_unpack:new Ei(T),u_dem_tl:new Be(T),u_dem_scale:new bt(T),u_dem_tl_prev:new Be(T),u_dem_scale_prev:new bt(T),u_dem_size:new bt(T),u_dem_lerp:new bt(T),u_exaggeration:new bt(T),u_depth:new Fe(T),u_depth_size_inv:new Be(T),u_meter_to_dem:new bt(T),u_label_plane_matrix_inv:new ye(T)}),c.includes("GLOBE")&&(this.globeUniforms=(T=>({u_tile_tl_up:new xe(T),u_tile_tr_up:new xe(T),u_tile_br_up:new xe(T),u_tile_bl_up:new xe(T),u_tile_up_scale:new bt(T)}))(t)),c.includes("FOG")&&(this.fogUniforms=(T=>({u_fog_matrix:new ye(T),u_fog_range:new Be(T),u_fog_color:new Ei(T),u_fog_horizon_blend:new bt(T),u_fog_vertical_limit:new Be(T),u_fog_temporal_offset:new bt(T),u_frustum_tl:new xe(T),u_frustum_tr:new xe(T),u_frustum_br:new xe(T),u_frustum_bl:new xe(T),u_globe_pos:new xe(T),u_globe_radius:new bt(T),u_globe_transition:new bt(T),u_is_globe:new Fe(T),u_viewport:new Be(T)}))(t)),c.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(T=>({u_cutoff_params:new Ei(T)}))(t)),c.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(T=>({u_lighting_ambient_color:new xe(T),u_lighting_directional_dir:new xe(T),u_lighting_directional_color:new xe(T),u_ground_radiance:new xe(T)}))(t)),c.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(T=>({u_light_matrix_0:new ye(T),u_light_matrix_1:new ye(T),u_fade_range:new Be(T),u_shadow_normal_offset:new xe(T),u_shadow_intensity:new bt(T),u_shadow_texel_size:new bt(T),u_shadow_map_resolution:new bt(T),u_shadow_direction:new xe(T),u_shadow_bias:new xe(T),u_shadowmap_0:new Fe(T),u_shadowmap_1:new Fe(T)}))(t))}var T}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const r=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const s in n)r[s]&&r[s].set(this.program,s,n[s])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const r=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const s in n)r[s]&&r[s].set(this.program,s,n[s])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const r=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const s in n)r[s].set(this.program,s,n[s])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const r=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const s in n)r[s].set(this.program,s,n[s])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const r=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const s in n)r[s].set(this.program,s,n[s])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const r=this.shadowUniforms;t.program.set(this.program);for(const s in n)r[s].set(this.program,s,n[s])}_drawDebugWireframe(t,n,r,s,l,c,h,f,p,m){const _=t.options.wireframe;if(!1===_.terrain&&!1===_.layers2D&&!1===_.layers3D)return;const y=t.context;if(!(()=>!(!_.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!_.layers2D||t._terrain&&t._terrain.renderingToTexture||!J0.includes(this.name))||!(!_.layers3D||!fM.includes(this.name)))())return;const v=y.gl,b=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,l,y);if(!b)return;const E=[...this.fixedDefines];E.push("DEBUG_WIREFRAME");const D=t.getOrCreateProgram(this.name,{config:this.configuration,defines:E});y.program.set(D.program);const T=(A,M,R)=>{if(M[A]&&R[A])for(const L in M[A])R[A][L]&&R[A][L].set(R.program,L,M[A][L].current)};p&&p.setUniforms(D.program,y,D.binderUniforms,h,{zoom:f}),T("fixedUniforms",this,D),T("terrainUniforms",this,D),T("globeUniforms",this,D),T("fogUniforms",this,D),T("lightsUniforms",this,D),T("shadowUniforms",this,D),b.bind(),y.setColorMode(new Ye([v.ONE,v.ONE_MINUS_SRC_ALPHA,v.ZERO,v.ONE],le.transparent,[!0,!0,!0,!1])),y.setDepthMode(new ue(n.func===v.LESS?v.LEQUAL:n.func,ue.ReadOnly,n.range)),y.setStencilMode(Re.disabled);const C=3*c.primitiveLength*2,I=3*c.primitiveOffset*2*2;m&&m>1?v.drawElementsInstanced(v.LINES,C,v.UNSIGNED_SHORT,I,m):v.drawElements(v.LINES,C,v.UNSIGNED_SHORT,I),l.bind(),y.program.set(this.program),y.setDepthMode(n),y.setStencilMode(r),y.setColorMode(s)}draw(t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D){const T=t.context,C=T.gl;if(this.failedToCreate)return;T.program.set(this.program),T.setDepthMode(r),T.setStencilMode(s),T.setColorMode(l),T.setCullFace(c);for(const M of Object.keys(this.fixedUniforms))this.fixedUniforms[M].set(this.program,M,h[M]);b&&b.setUniforms(this.program,T,this.binderUniforms,y,{zoom:v});const I={[C.LINES]:2,[C.TRIANGLES]:3,[C.LINE_STRIP]:1}[n],A=D&&D>0?1:void 0;for(const M of _.get()){const R=M.vaos||(M.vaos={});(R[f]||(R[f]=new K0)).bind(T,this,p,b?b.getPaintVertexBuffers():[],m,M.vertexOffset,E||[],A),D&&D>1?C.drawElementsInstanced(n,M.primitiveLength*I,C.UNSIGNED_SHORT,M.primitiveOffset*I*2,D):C.drawElements(n,M.primitiveLength*I,C.UNSIGNED_SHORT,M.primitiveOffset*I*2),n===C.TRIANGLES&&this._drawDebugWireframe(t,r,s,l,m,M,y,v,b,D)}}}function QE(e,t){const n=Math.pow(2,t.tileID.overscaledZ),r=t.tileSize*Math.pow(2,e.transform.tileZoom)/n,s=r*(t.tileID.canonical.x+t.tileID.wrap*n),l=r*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture.size,u_tile_units_to_pixels:1/Xs(t,1,e.transform.tileZoom),u_pixel_coord_upper:[s>>16,l>>16],u_pixel_coord_lower:[65535&s,65535&l]}}const Q0=et.create(),tT=(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b)=>{const E=t.style.light,D=E.properties.get("position"),T=[D.x,D.y,D.z],C=ji.create();"viewport"===E.properties.get("anchor")&&(ji.fromRotation(C,-t.transform.angle),H.transformMat3(T,T,C));const I=E.properties.get("color"),A=t.transform,M={u_matrix:e,u_lightpos:T,u_lightintensity:E.properties.get("intensity"),u_lightcolor:[I.r,I.g,I.b],u_vertical_gradient:+n,u_opacity:r,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Q0,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:s,u_edge_radius:l,u_flood_light_color:_,u_vertical_scale:y,u_flood_light_intensity:v,u_ground_shadow_factor:b};return"globe"===A.projection.name&&(M.u_tile_id=[c.canonical.x,c.canonical.y,1<<c.canonical.z],M.u_zoom_transition=f,M.u_inv_rot_matrix=m,M.u_merc_center=p,M.u_up_dir=A.projection.upVector(new Oo(0,0,0),p[0]*st,p[1]*st),M.u_height_lift=h),M},pM=(e,t,n)=>({u_matrix:e,u_edge_radius:t,u_vertical_scale:n}),tv=(e,t,n,r,s,l,c,h,f,p,m,_,y,v)=>{const b=tT(e,t,n,r,s,l,c,f,p,m,_,y,v,1,[0,0,0]),E={u_height_factor:-Math.pow(2,c.overscaledZ)/h.tileSize/8};return Vt(b,QE(t,h),E)},ev=(e,t)=>({u_matrix:e,u_emissive_strength:t}),nv=(e,t,n,r)=>Vt(ev(e,t),QE(n,r)),mM=(e,t,n)=>({u_matrix:e,u_world:n,u_emissive_strength:t}),eT=(e,t,n,r,s)=>Vt(nv(e,t,n,r),{u_world:s}),Zm=(e,t,n,r)=>{const s=st/n.tileSize;return{u_matrix:e,u_camera_to_center_distance:t.getCameraToCenterDistance(r),u_extrude_scale:[t.pixelsToGLUnits[0]/s,t.pixelsToGLUnits[1]/s]}},Xm=(e,t,n=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:n}),rv=et.create(),gM=(e,t,n,r,s,l,c)=>{const h=e.transform,f="globe"===h.projection.name,p=f?ld(h.zoom,t.canonical)*h._pixelsPerMercatorPixel:Xs(n,1,l),m={u_matrix:t.projMatrix,u_extrude_scale:p,u_intensity:c,u_inv_rot_matrix:rv,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(f){m.u_inv_rot_matrix=r,m.u_merc_center=s,m.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],m.u_zoom_transition=Mr(h.zoom);const _=s[0]*st,y=s[1]*st;m.u_up_dir=h.projection.upVector(new Oo(0,0,0),_,y)}return m},Ym=(e,t,n,r,s,l,c,h,f,p,m)=>{return{u_matrix:e,u_normalize_matrix:t,u_globe_matrix:n,u_tl_parent:r,u_scale_parent:s,u_fade_t:l.mix,u_opacity:l.opacity*c.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:c.paint.get("raster-brightness-min"),u_brightness_high:c.paint.get("raster-brightness-max"),u_saturation_factor:(y=c.paint.get("raster-saturation"),y>0?1-1/(1.001-y):-y),u_contrast_factor:(_=c.paint.get("raster-contrast"),_>0?1/(1-_):1+_),u_spin_weights:Rl(c.paint.get("raster-hue-rotate")),u_perspective_transform:h,u_colorization_mix:p,u_colorization_scale:nT(m),u_color_ramp:f};var _,y};function Rl(e){e*=Math.PI/180;const t=Math.sin(e),n=Math.cos(e);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}function nT([e,t]){if(e===t)return[e,t];const n=(t+e)/2,r=(t-e)/2*256/255;return[-(e=n-r)/((t=n+r)-e),1/(t-e)]}const Km=et.create(),Js=(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D)=>{const T=s.transform,C={u_is_size_zoom_constant:+("constant"===e||"source"===e),u_is_size_feature_constant:+("constant"===e||"camera"===e),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:T.getCameraToCenterDistance(E),u_rotate_symbol:+n,u_aspect_ratio:T.width/T.height,u_fade_change:s.options.fadeDuration?s.symbolFadeChange:1,u_matrix:l,u_label_plane_matrix:c,u_coord_matrix:h,u_is_text:+f,u_pitch_with_map:+r,u_texsize:p,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Km,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Km,u_up_vector:[0,-1,0],u_icon_transition:D||0};return"globe"===E.name&&(C.u_tile_id=[m.canonical.x,m.canonical.y,1<<m.canonical.z],C.u_zoom_transition=_,C.u_inv_rot_matrix=v,C.u_merc_center=y,C.u_camera_forward=T._camera.forward(),C.u_ecef_origin=function(I,A){const M=[0,0,0],R=$s(wo(A.canonical));return H.transformMat4(M,M,R),H.transformMat4(M,M,I),M}(T.globeMatrix,m.toUnwrapped()),C.u_tile_matrix=Float32Array.from(T.globeMatrix),C.u_up_vector=b),C},rT=(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D)=>Vt(Js(e,t,n,r,s,l,c,h,f,p,_,y,v,b,E,D),{u_gamma_scale:r?s.transform.getCameraToCenterDistance(D)*Math.cos(s.terrain?0:s.transform._pitch):1,u_device_pixel_ratio:me.devicePixelRatio,u_is_halo:+m,undefined:void 0}),GA=(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E)=>Vt(rT(e,t,n,r,s,l,c,h,!0,f,!0,m,_,y,v,b,E),{u_texsize_icon:p,u_texture_icon:1}),_M=(e,t,n,r)=>({u_matrix:e,u_emissive_strength:t,u_opacity:n,u_color:r}),iT=(e,t,n,r,s,l,c)=>Vt(function(h,f,p,m){const _=p.imageManager.getPattern(h.toString(),f),{width:y,height:v}=p.imageManager.getPixelSize(f),b=Math.pow(2,m.tileID.overscaledZ),E=m.tileSize*Math.pow(2,p.transform.tileZoom)/b,D=E*(m.tileID.canonical.x+m.tileID.wrap*b),T=E*m.tileID.canonical.y;return{u_image:0,u_pattern_tl:_.tl,u_pattern_br:_.br,u_texsize:[y,v],u_pattern_size:_.displaySize,u_tile_units_to_pixels:1/Xs(m,1,p.transform.tileZoom),u_pixel_coord_upper:[D>>16,T>>16],u_pixel_coord_lower:[65535&D,65535&T]}}(s,l,r,c),{u_matrix:e,u_emissive_strength:t,u_opacity:n}),uo_BaseColor=5,uo_MetallicRoughness=6,uo_Normal=7,uo_Occlusion=8,uo_Emission=9,uo_ShadowMap0=10,iv=(e,t,n,r,s,l,c,h,f,p,m,_=[0,0,0])=>{const y=r.style.light,v=y.properties.get("position"),b=[-v.x,-v.y,v.z],E=ji.create();"viewport"===y.properties.get("anchor")&&(ji.fromRotation(E,-r.transform.angle),H.transformMat3(b,b,E));const D="MASK"===p.alphaMode,T=y.properties.get("color"),C=m.paint.get("model-ambient-occlusion-intensity"),I=m.paint.get("model-color").constantOr(le.white),A=m.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:e,u_lighting_matrix:t,u_normal_matrix:n,u_lightpos:b,u_lightintensity:y.properties.get("intensity"),u_lightcolor:[T.r,T.g,T.b],u_camera_pos:_,u_opacity:s,u_baseTextureIsAlpha:0,u_alphaMask:+D,u_alphaCutoff:p.alphaCutoff,u_baseColorFactor:[l.r,l.g,l.b,l.a],u_emissiveFactor:[c[0],c[1],c[2],1],u_metallicFactor:h,u_roughnessFactor:f,u_baseColorTexture:uo_BaseColor,u_metallicRoughnessTexture:uo_MetallicRoughness,u_normalTexture:uo_Normal,u_occlusionTexture:uo_Occlusion,u_emissionTexture:uo_Emission,u_color_mix:[I.r,I.g,I.b,A],u_aoIntensity:C}},ov=new Float32Array(16),yM=(e,t=ov,n=ov)=>({u_matrix:e,u_instance:t,u_node_matrix:n}),oT={fillExtrusion:e=>({u_matrix:new ye(e),u_lightpos:new xe(e),u_lightintensity:new bt(e),u_lightcolor:new xe(e),u_vertical_gradient:new bt(e),u_opacity:new bt(e),u_edge_radius:new bt(e),u_ao:new Be(e),u_tile_id:new xe(e),u_zoom_transition:new bt(e),u_inv_rot_matrix:new ye(e),u_merc_center:new Be(e),u_up_dir:new xe(e),u_height_lift:new bt(e),u_flood_light_color:new xe(e),u_vertical_scale:new bt(e),u_flood_light_intensity:new bt(e),u_ground_shadow_factor:new xe(e)}),fillExtrusionDepth:e=>({u_matrix:new ye(e),u_edge_radius:new bt(e),u_vertical_scale:new bt(e)}),fillExtrusionPattern:e=>({u_matrix:new ye(e),u_lightpos:new xe(e),u_lightintensity:new bt(e),u_lightcolor:new xe(e),u_vertical_gradient:new bt(e),u_height_factor:new bt(e),u_edge_radius:new bt(e),u_ao:new Be(e),u_tile_id:new xe(e),u_zoom_transition:new bt(e),u_inv_rot_matrix:new ye(e),u_merc_center:new Be(e),u_up_dir:new xe(e),u_height_lift:new bt(e),u_image:new Fe(e),u_texsize:new Be(e),u_pixel_coord_upper:new Be(e),u_pixel_coord_lower:new Be(e),u_tile_units_to_pixels:new bt(e),u_opacity:new bt(e)}),fillExtrusionGroundEffect:e=>({u_matrix:new ye(e),u_opacity:new bt(e),u_ao_pass:new bt(e),u_meter_to_tile:new bt(e),u_ao:new Be(e),u_flood_light_intensity:new bt(e),u_flood_light_color:new xe(e),u_attenuation:new bt(e),u_edge_radius:new bt(e),u_fb:new Fe(e),u_fb_size:new bt(e)}),fill:e=>({u_matrix:new ye(e),u_emissive_strength:new bt(e)}),fillPattern:e=>({u_matrix:new ye(e),u_emissive_strength:new bt(e),u_image:new Fe(e),u_texsize:new Be(e),u_pixel_coord_upper:new Be(e),u_pixel_coord_lower:new Be(e),u_tile_units_to_pixels:new bt(e)}),fillOutline:e=>({u_matrix:new ye(e),u_emissive_strength:new bt(e),u_world:new Be(e)}),fillOutlinePattern:e=>({u_matrix:new ye(e),u_emissive_strength:new bt(e),u_world:new Be(e),u_image:new Fe(e),u_texsize:new Be(e),u_pixel_coord_upper:new Be(e),u_pixel_coord_lower:new Be(e),u_tile_units_to_pixels:new bt(e)}),circle:e=>({u_camera_to_center_distance:new bt(e),u_extrude_scale:new h_(e),u_device_pixel_ratio:new bt(e),u_matrix:new ye(e),u_inv_rot_matrix:new ye(e),u_merc_center:new Be(e),u_tile_id:new xe(e),u_zoom_transition:new bt(e),u_up_dir:new xe(e),u_emissive_strength:new bt(e)}),collisionBox:e=>({u_matrix:new ye(e),u_camera_to_center_distance:new bt(e),u_extrude_scale:new Be(e)}),collisionCircle:e=>({u_matrix:new ye(e),u_inv_matrix:new ye(e),u_camera_to_center_distance:new bt(e),u_viewport_size:new Be(e)}),debug:e=>({u_color:new uc(e),u_matrix:new ye(e),u_overlay:new Fe(e),u_overlay_scale:new bt(e)}),clippingMask:e=>({u_matrix:new ye(e)}),heatmap:e=>({u_extrude_scale:new bt(e),u_intensity:new bt(e),u_matrix:new ye(e),u_inv_rot_matrix:new ye(e),u_merc_center:new Be(e),u_tile_id:new xe(e),u_zoom_transition:new bt(e),u_up_dir:new xe(e)}),heatmapTexture:e=>({u_image:new Fe(e),u_color_ramp:new Fe(e),u_opacity:new bt(e)}),hillshade:e=>({u_matrix:new ye(e),u_image:new Fe(e),u_latrange:new Be(e),u_light:new Be(e),u_shadow:new uc(e),u_highlight:new uc(e),u_emissive_strength:new bt(e),u_accent:new uc(e)}),hillshadePrepare:e=>({u_matrix:new ye(e),u_image:new Fe(e),u_dimension:new Be(e),u_zoom:new bt(e),u_unpack:new Ei(e)}),line:e=>({u_matrix:new ye(e),u_pixels_to_tile_units:new h_(e),u_device_pixel_ratio:new bt(e),u_units_to_pixels:new Be(e),u_dash_image:new Fe(e),u_gradient_image:new Fe(e),u_image_height:new bt(e),u_texsize:new Be(e),u_tile_units_to_pixels:new bt(e),u_alpha_discard_threshold:new bt(e),u_trim_offset:new Be(e),u_emissive_strength:new bt(e)}),linePattern:e=>({u_matrix:new ye(e),u_texsize:new Be(e),u_pixels_to_tile_units:new h_(e),u_device_pixel_ratio:new bt(e),u_image:new Fe(e),u_units_to_pixels:new Be(e),u_tile_units_to_pixels:new bt(e),u_alpha_discard_threshold:new bt(e)}),raster:e=>({u_matrix:new ye(e),u_normalize_matrix:new ye(e),u_globe_matrix:new ye(e),u_tl_parent:new Be(e),u_scale_parent:new bt(e),u_fade_t:new bt(e),u_opacity:new bt(e),u_image0:new Fe(e),u_image1:new Fe(e),u_brightness_low:new bt(e),u_brightness_high:new bt(e),u_saturation_factor:new bt(e),u_contrast_factor:new bt(e),u_spin_weights:new xe(e),u_perspective_transform:new Be(e),u_colorization_mix:new Ei(e),u_colorization_scale:new Be(e),u_color_ramp:new Fe(e)}),symbolIcon:e=>({u_is_size_zoom_constant:new Fe(e),u_is_size_feature_constant:new Fe(e),u_size_t:new bt(e),u_size:new bt(e),u_camera_to_center_distance:new bt(e),u_rotate_symbol:new Fe(e),u_aspect_ratio:new bt(e),u_fade_change:new bt(e),u_matrix:new ye(e),u_label_plane_matrix:new ye(e),u_coord_matrix:new ye(e),u_is_text:new Fe(e),u_pitch_with_map:new Fe(e),u_texsize:new Be(e),u_tile_id:new xe(e),u_zoom_transition:new bt(e),u_inv_rot_matrix:new ye(e),u_merc_center:new Be(e),u_camera_forward:new xe(e),u_tile_matrix:new ye(e),u_up_vector:new xe(e),u_ecef_origin:new xe(e),u_texture:new Fe(e),u_icon_transition:new bt(e)}),symbolSDF:e=>({u_is_size_zoom_constant:new Fe(e),u_is_size_feature_constant:new Fe(e),u_size_t:new bt(e),u_size:new bt(e),u_camera_to_center_distance:new bt(e),u_rotate_symbol:new Fe(e),u_aspect_ratio:new bt(e),u_fade_change:new bt(e),u_matrix:new ye(e),u_label_plane_matrix:new ye(e),u_coord_matrix:new ye(e),u_is_text:new Fe(e),u_pitch_with_map:new Fe(e),u_texsize:new Be(e),u_texture:new Fe(e),u_gamma_scale:new bt(e),u_device_pixel_ratio:new bt(e),u_tile_id:new xe(e),u_zoom_transition:new bt(e),u_inv_rot_matrix:new ye(e),u_merc_center:new Be(e),u_camera_forward:new xe(e),u_tile_matrix:new ye(e),u_up_vector:new xe(e),u_ecef_origin:new xe(e),u_is_halo:new Fe(e)}),symbolTextAndIcon:e=>({u_is_size_zoom_constant:new Fe(e),u_is_size_feature_constant:new Fe(e),u_size_t:new bt(e),u_size:new bt(e),u_camera_to_center_distance:new bt(e),u_rotate_symbol:new Fe(e),u_aspect_ratio:new bt(e),u_fade_change:new bt(e),u_matrix:new ye(e),u_label_plane_matrix:new ye(e),u_coord_matrix:new ye(e),u_is_text:new Fe(e),u_pitch_with_map:new Fe(e),u_texsize:new Be(e),u_texsize_icon:new Be(e),u_texture:new Fe(e),u_texture_icon:new Fe(e),u_gamma_scale:new bt(e),u_device_pixel_ratio:new bt(e),u_is_halo:new Fe(e)}),background:e=>({u_matrix:new ye(e),u_emissive_strength:new bt(e),u_opacity:new bt(e),u_color:new uc(e)}),backgroundPattern:e=>({u_matrix:new ye(e),u_emissive_strength:new bt(e),u_opacity:new bt(e),u_image:new Fe(e),u_pattern_tl:new Be(e),u_pattern_br:new Be(e),u_texsize:new Be(e),u_pattern_size:new Be(e),u_pixel_coord_upper:new Be(e),u_pixel_coord_lower:new Be(e),u_tile_units_to_pixels:new bt(e)}),terrainRaster:qE,terrainDepth:qE,skybox:e=>({u_matrix:new ye(e),u_sun_direction:new xe(e),u_cubemap:new Fe(e),u_opacity:new bt(e),u_temporal_offset:new bt(e)}),skyboxGradient:e=>({u_matrix:new ye(e),u_color_ramp:new Fe(e),u_center_direction:new xe(e),u_radius:new bt(e),u_opacity:new bt(e),u_temporal_offset:new bt(e)}),skyboxCapture:e=>({u_matrix_3f:new p1(e),u_sun_direction:new xe(e),u_sun_intensity:new bt(e),u_color_tint_r:new Ei(e),u_color_tint_m:new Ei(e),u_luminance:new bt(e)}),globeRaster:e=>({u_proj_matrix:new ye(e),u_globe_matrix:new ye(e),u_normalize_matrix:new ye(e),u_merc_matrix:new ye(e),u_zoom_transition:new bt(e),u_merc_center:new Be(e),u_image0:new Fe(e),u_grid_matrix:new p1(e),u_skirt_height:new bt(e),u_frustum_tl:new xe(e),u_frustum_tr:new xe(e),u_frustum_br:new xe(e),u_frustum_bl:new xe(e),u_globe_pos:new xe(e),u_globe_radius:new bt(e),u_viewport:new Be(e)}),globeAtmosphere:e=>({u_frustum_tl:new xe(e),u_frustum_tr:new xe(e),u_frustum_br:new xe(e),u_frustum_bl:new xe(e),u_horizon:new bt(e),u_transition:new bt(e),u_fadeout_range:new bt(e),u_color:new Ei(e),u_high_color:new Ei(e),u_space_color:new Ei(e),u_temporal_offset:new bt(e),u_horizon_angle:new bt(e)}),model:e=>({u_matrix:new ye(e),u_lighting_matrix:new ye(e),u_normal_matrix:new ye(e),u_lightpos:new xe(e),u_lightintensity:new bt(e),u_lightcolor:new xe(e),u_camera_pos:new xe(e),u_opacity:new bt(e),u_baseColorFactor:new Ei(e),u_emissiveFactor:new Ei(e),u_metallicFactor:new bt(e),u_roughnessFactor:new bt(e),u_baseTextureIsAlpha:new Fe(e),u_alphaMask:new Fe(e),u_alphaCutoff:new bt(e),u_baseColorTexture:new Fe(e),u_metallicRoughnessTexture:new Fe(e),u_normalTexture:new Fe(e),u_occlusionTexture:new Fe(e),u_emissionTexture:new Fe(e),u_color_mix:new Ei(e),u_aoIntensity:new bt(e)}),modelDepth:e=>({u_matrix:new ye(e),u_instance:new ye(e),u_node_matrix:new ye(e)}),groundShadow:e=>({u_matrix:new ye(e),u_ground_shadow_factor:new xe(e)}),stars:e=>({u_matrix:new ye(e),u_up:new xe(e),u_right:new xe(e),u_intensity_multiplier:new bt(e)})};let Jm;function sv(e,t,n,r,s,l,c){const h=e.context,f=h.gl,p=e.transform,m=e.getOrCreateProgram("collisionBox"),_=[];let y=0,v=0;for(let A=0;A<r.length;A++){const M=r[A],R=t.getTile(M),L=R.getBucket(n);if(!L)continue;const O=Um(M,L,p);let z=O;0===s[0]&&0===s[1]||(z=e.translatePosMatrix(O,R,s,l));const N=c?L.textCollisionBox:L.iconCollisionBox,V=L.collisionCircleArray;if(V.length>0){const B=et.create(),$=z;et.mul(B,L.placementInvProjMatrix,p.glCoordMatrix),et.mul(B,B,L.placementViewportMatrix),_.push({circleArray:V,circleOffset:v,transform:$,invTransform:B,projection:L.getProjection()}),y+=V.length/4,v=y}N&&(e.terrain&&e.terrain.setupElevationDraw(R,m),m.draw(e,f.LINES,ue.disabled,Re.disabled,e.colorModeForRenderPass(),Le.disabled,Zm(z,p,R,L.getProjection()),n.id,N.layoutVertexBuffer,N.indexBuffer,N.segments,null,p.zoom,null,[N.collisionVertexBuffer,N.collisionVertexBufferExt]))}if(!c||!_.length)return;const b=e.getOrCreateProgram("collisionCircle"),E=new ap;E.resize(4*y),E._trim();let D=0;for(const A of _)for(let M=0;M<A.circleArray.length/4;M++){const R=4*M,L=A.circleArray[R+0],O=A.circleArray[R+1],z=A.circleArray[R+2],N=A.circleArray[R+3];E.emplace(D++,L,O,z,N,0),E.emplace(D++,L,O,z,N,1),E.emplace(D++,L,O,z,N,2),E.emplace(D++,L,O,z,N,3)}(!Jm||Jm.length<2*y)&&(Jm=function(A){const M=2*A,R=new er;R.resize(M),R._trim();for(let L=0;L<M;L++){const O=6*L;R.uint16[O+0]=4*L+0,R.uint16[O+1]=4*L+1,R.uint16[O+2]=4*L+2,R.uint16[O+3]=4*L+2,R.uint16[O+4]=4*L+3,R.uint16[O+5]=4*L+0}return R}(y));const T=h.createIndexBuffer(Jm,!0),C=h.createVertexBuffer(E,Ly.members,!0);for(const A of _){const M={u_matrix:A.transform,u_inv_matrix:A.invTransform,u_camera_to_center_distance:(I=p).getCameraToCenterDistance(A.projection),u_viewport_size:[I.width,I.height]};b.draw(e,f.TRIANGLES,ue.disabled,Re.disabled,e.colorModeForRenderPass(),Le.disabled,M,n.id,C,T,ln.simpleSegment(0,2*A.circleOffset,A.circleArray.length,A.circleArray.length/2),null,p.zoom)}var I;C.destroy(),T.destroy()}const vM=et.create();function av({width:e,height:t,anchor:n,textOffset:r,textScale:s},l){const{horizontalAlign:c,verticalAlign:h}=im(n),f=-(c-.5)*e,p=-(h-.5)*t,m=lm(n,r);return new tt((f/s+m[0])*l,(p/s+m[1])*l)}function sT(e,t,n,r,s,l,c,h,f,p,m){const _=e.text.placedSymbolArray,y=e.text.dynamicLayoutVertexArray,v=e.icon.dynamicLayoutVertexArray,b={},E=e.getProjection(),D=Jd(h,E,l),T=l.elevation,C=E.upVectorScale(h.canonical,l.center.lat,l.worldSize).metersToTile;y.clear();for(let I=0;I<_.length;I++){const A=_.get(I),{tileAnchorX:M,tileAnchorY:R,numGlyphs:L}=A,O=A.hidden||!A.crossTileID||e.allowVerticalPlacement&&!A.placedOrientation?null:r[A.crossTileID];if(O){let z=0,N=0,V=0;if(T){const nt=T?T.getAtTileOffset(h,M,R):0,[ot,lt,ht]=E.upVector(h.canonical,M,R);z=nt*ot*C,N=nt*lt*C,V=nt*ht*C}let[B,$,j,Z]=fs(A.projectedAnchorX+z,A.projectedAnchorY+N,A.projectedAnchorZ+V,n?D:c);const K=s0(l.getCameraToCenterDistance(E),Z);let Q=s.evaluateSizeForFeature(e.textSizeData,p,A)*K/24;n&&(Q*=e.tilePixelRatio/f);const W=av(O,Q);n?(({x:B,y:$,z:j}=E.projectTilePoint(M+W.x,R+W.y,h.canonical)),[B,$,j]=fs(B+z,$+N,j+V,c)):(t&&W._rotate(-l.angle),B+=W.x,$+=W.y,j=0);const X=e.allowVerticalPlacement&&A.placedOrientation===Bn.vertical?Math.PI/2:0;for(let nt=0;nt<L;nt++)Wu(y,B,$,j,X);m&&A.associatedIconIndex>=0&&(b[A.associatedIconIndex]={x:B,y:$,z:j,angle:X})}else Ju(L,y)}if(m){v.clear();const I=e.icon.placedSymbolArray;for(let A=0;A<I.length;A++){const M=I.get(A),{numGlyphs:R}=M,L=b[A];if(M.hidden||!L)Ju(R,v);else{const{x:O,y:z,z:N,angle:V}=L;for(let B=0;B<R;B++)Wu(v,O,z,N,V)}}e.icon.dynamicLayoutVertexBuffer.updateData(v)}e.text.dynamicLayoutVertexBuffer.updateData(y)}function aT(e,t,n){return n.iconsInText&&t?"symbolTextAndIcon":e?"symbolSDF":"symbolIcon"}function lv(e,t,n,r,s,l,c,h,f,p,m,_){const y=e.context,v=y.gl,b=e.transform,E="map"===h,D="map"===f,T=E&&"point"!==n.layout.get("symbol-placement"),C=E&&!D&&!T,I=void 0!==n.layout.get("symbol-sort-key").constantOr(1);let A=!1;const M=e.depthModeForSublayer(0,ue.ReadOnly),R=[Xr(b.center.lng),Ur(b.center.lat)],L=n.layout.get("text-variable-anchor"),O="globe"===b.projection.name,z=[],N=[0,-1,0];let V=N;!O&&!b.mercatorFromTransition||E||(V=function(B){const $=B._camera.getWorldToCamera(B.worldSize,1),j=et.multiply([],$,B.globeMatrix);et.invert(j,j);const Z=[0,0,0],K=[0,1,0,0];return an.transformMat4(K,K,j),Z[0]=K[0],Z[1]=K[1],Z[2]=K[2],H.normalize(Z,Z),Z}(b));for(const B of r){const $=t.getTile(B),j=$.getBucket(n);if(!j||"mercator"===j.projection.name&&O)continue;const Z=s?j.text:j.icon;if(!Z||j.fullyClipped||!Z.segments.get().length)continue;const K=Z.programConfigurations.get(n.id),Q=s||j.sdfIcons,W=s?j.textSizeData:j.iconSizeData,X=D||0!==b.pitch,nt=ls(W,b.zoom);let ot,lt,ht,ft,at=[0,0],ut=null;if(s)lt=$.glyphAtlasTexture,ht=v.LINEAR,ot=$.glyphAtlasTexture.size,j.iconsInText&&(at=$.imageAtlasTexture.size,ut=$.imageAtlasTexture,ft=X||e.options.rotating||e.options.zooming||"composite"===W.kind||"camera"===W.kind?v.LINEAR:v.NEAREST);else{const Fn=1!==n.layout.get("icon-size").constantOr(0)||j.iconsNeedLinear;lt=$.imageAtlasTexture,ht=Q||e.options.rotating||e.options.zooming||Fn||X?v.LINEAR:v.NEAREST,ot=$.imageAtlasTexture.size}const Et="globe"===j.projection.name,Ot=Et?V:N,kt=Et?Mr(b.zoom):0,zt=Jd(B,j.getProjection(),b),Zt=b.calculatePixelsToTileUnitsMatrix($),oe=n0(zt,$.tileID.canonical,D,E,b,j.getProjection(),Zt),Se=e.terrain&&D&&T?et.invert(et.create(),oe):vM,We=o0(zt,$.tileID.canonical,D,E,b,j.getProjection(),Zt),Ee=L&&j.hasTextData(),pe=j.hasIconTextFit()&&Ee&&j.hasIconData();if(T){const Fn=b.elevation,jn=Fn?Fn.getAtTileOffsetFunc(B,b.center.lat,b.worldSize,j.getProjection()):null,pn=r0(zt,$.tileID.canonical,D,E,b,j.getProjection(),Zt);zw(j,zt,e,s,pn,We,D,p,jn,B)}const ie=T||s&&L||pe,te=e.translatePosMatrix(zt,$,l,c),Ne=ie?vM:oe,Xe=e.translatePosMatrix(We,$,l,c,!0),Ce=j.getProjection().createInversionMatrix(b,B.canonical),yn=n.paint.get("icon-image-cross-fade").constantOr(0),On=[];e.terrainRenderModeElevated()&&D&&On.push("PITCH_WITH_MAP_TERRAIN"),Et&&(On.push("PROJECTION_GLOBE_VIEW"),ie&&On.push("PROJECTED_POS_ON_VIEWPORT")),yn>0&&On.push("ICON_TRANSITION"),Z.zOffsetVertexBuffer&&On.push("Z_OFFSET");const Rn=Q&&0!==n.paint.get(s?"text-halo-width":"icon-halo-width").constantOr(1);let Dn;Dn=Q?j.iconsInText?GA(W.kind,nt,C,D,e,te,Ne,Xe,ot,at,B,kt,R,Ce,Ot,j.getProjection()):rT(W.kind,nt,C,D,e,te,Ne,Xe,s,ot,!0,B,kt,R,Ce,Ot,j.getProjection()):Js(W.kind,nt,C,D,e,te,Ne,Xe,s,ot,B,kt,R,Ce,Ot,j.getProjection(),yn);const lr={program:e.getOrCreateProgram(aT(Q,s,j),{config:K,defines:On}),buffers:Z,uniformValues:Dn,atlasTexture:lt,atlasTextureIcon:ut,atlasInterpolation:ht,atlasInterpolationIcon:ft,isSDF:Q,hasHalo:Rn,tile:$,labelPlaneMatrixInv:Se};if(I&&j.canOverlap){A=!0;const Fn=Z.segments.get();for(const jn of Fn)z.push({segments:new ln([jn]),sortKey:jn.sortKey,state:lr})}else z.push({segments:Z.segments,sortKey:0,state:lr})}A&&z.sort((B,$)=>B.sortKey-$.sortKey);for(const B of z){const $=B.state;if(e.terrain&&e.terrain.setupElevationDraw($.tile,$.program,{useDepthForOcclusion:b.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:$.labelPlaneMatrixInv}),y.activeTexture.set(v.TEXTURE0),$.atlasTexture.bind($.atlasInterpolation,v.CLAMP_TO_EDGE),$.atlasTextureIcon&&(y.activeTexture.set(v.TEXTURE1),$.atlasTextureIcon&&$.atlasTextureIcon.bind($.atlasInterpolationIcon,v.CLAMP_TO_EDGE)),e.uploadCommonLightUniforms(e.context,$.program),$.hasHalo){const j=$.uniformValues;j.u_is_halo=1,Qm($.buffers,B.segments,n,e,$.program,M,m,_,j,2),j.u_is_halo=0}else{if($.isSDF){const j=$.uniformValues;$.hasHalo&&(j.u_is_halo=1,Qm($.buffers,B.segments,n,e,$.program,M,m,_,j,1)),j.u_is_halo=0}Qm($.buffers,B.segments,n,e,$.program,M,m,_,$.uniformValues,1)}}}function Qm(e,t,n,r,s,l,c,h,f,p){const m=[e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer,e.iconTransitioningVertexBuffer,e.globeExtVertexBuffer,e.zOffsetVertexBuffer];s.draw(r,r.context.gl.TRIANGLES,l,c,h,Le.disabled,f,n.id,e.layoutVertexBuffer,e.indexBuffer,t,n.paint,r.transform.zoom,e.programConfigurations.get(n.id),m,p)}function cv(e,t,n,r,s,l,c){const h=e.context.gl,f=n.paint.get("fill-pattern"),p=f&&f.constantOr(1);let m,_,y,v,b;c?(_=p&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",m=h.LINES):(_=p?"fillPattern":"fill",m=h.TRIANGLES);for(const E of r){const D=t.getTile(E);if(p&&!D.patternsLoaded())continue;const T=D.getBucket(n);if(!T)continue;e.prepareDrawTile();const C=T.programConfigurations.get(n.id),I=e.isTileAffectedByFog(E),A=e.getOrCreateProgram(_,{config:C,overrideFog:I});p&&(e.context.activeTexture.set(h.TEXTURE0),D.imageAtlasTexture.bind(h.LINEAR,h.CLAMP_TO_EDGE),C.updatePaintBuffers());const M=f.constantOr(null);if(M&&D.imageAtlas){const O=D.imageAtlas.patternPositions[M.toString()];O&&C.setConstantPatternPositions(O)}const R=e.translatePosMatrix(E.projMatrix,D,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),L=n.paint.get("fill-emissive-strength");if(c){v=T.indexBuffer2,b=T.segments2;const O=e.terrain&&e.terrain.renderingToTexture?e.terrain.drapeBufferSize:[h.drawingBufferWidth,h.drawingBufferHeight];y="fillOutlinePattern"===_&&p?eT(R,L,e,D,O):mM(R,L,O)}else v=T.indexBuffer,b=T.segments,y=p?nv(R,L,e,D):ev(R,L);e.uploadCommonUniforms(e.context,A,E.toUnwrapped()),A.draw(e,m,s,e.stencilModeForClipping(E),l,Le.disabled,y,n.id,T.layoutVertexBuffer,v,b,n.paint,e.transform.zoom,C,void 0)}}function Oc(e,t,n,r,s,l,c,h){const f=e.context,p=f.gl,m=e.transform,_=n.paint.get("fill-extrusion-pattern"),y=_.constantOr(1),v=n.paint.get("fill-extrusion-opacity"),b=e.style.enable3dLights(),E=n.paint.get(b&&!y?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),D=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),E],T=n.layout.get("fill-extrusion-edge-radius"),C=T>0&&!n.paint.get("fill-extrusion-rounded-roof"),I=C?0:T,A="globe"===m.projection.name?y0():0,M="globe"===m.projection.name,R=M?Mr(m.zoom):0,L=[Xr(m.center.lng),Ur(m.center.lat)],O=n.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),z=n.paint.get("fill-extrusion-flood-light-intensity"),N=n.paint.get("fill-extrusion-vertical-scale"),V=nf(e,n.paint.get("fill-extrusion-cutoff-fade-range")),B=[];let $;M&&B.push("PROJECTION_GLOBE_VIEW"),D[0]>0&&B.push("FAUX_AO"),C&&B.push("ZERO_ROOF_RADIUS"),h&&B.push("HAS_CENTROID"),z>0&&B.push("FLOOD_LIGHT"),V.shouldRenderCutoff&&B.push("RENDER_CUTOFF");const j="shadow"===e.renderPass,Z=e.shadowRenderer,K=j&&!!Z;e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!0);let Q=[0,0,0];if(Z){const X=e.style.directionalLight,nt=e.style.ambientLight;X&&nt&&(Q=fh(X,nt)),$=B.concat(["SHADOWS_SINGLE_CASCADE"])}const W=K?"fillExtrusionDepth":y?"fillExtrusionPattern":"fillExtrusion";for(const X of r){const nt=t.getTile(X),ot=nt.getBucket(n);if(!ot||ot.projection.name!==m.projection.name)continue;let lt=!1;Z&&(lt=0===Z.getMaxCascadeForTile(X.toUnwrapped()));const ht=e.isTileAffectedByFog(X),ft=ot.programConfigurations.get(n.id),at=e.getOrCreateProgram(W,{config:ft,defines:lt?$:B,overrideFog:ht});if(e.terrain){const zt=e.terrain;e.style.terrainSetForDrapingOnly(),zt.setupElevationDraw(nt,at,{useMeterToDem:!0})}if(!ot.centroidVertexBuffer){const zt=at.attributes.a_centroid_pos;void 0!==zt&&p.vertexAttrib2f(zt,0,0)}!j&&Z&&Z.setupShadows(nt.tileID.toUnwrapped(),at,"vector-tile",nt.tileID.overscaledZ),y&&(e.context.activeTexture.set(p.TEXTURE0),nt.imageAtlasTexture.bind(p.LINEAR,p.CLAMP_TO_EDGE),ft.updatePaintBuffers());const ut=_.constantOr(null);if(ut&&nt.imageAtlas){const zt=nt.imageAtlas.patternPositions[ut.toString()];zt&&ft.setConstantPatternPositions(zt)}const Et=n.paint.get("fill-extrusion-vertical-gradient");let Ot;if(j&&Z){if(qA(nt.tileID,ot,e))continue;const zt=Z.calculateShadowPassMatrixFromTile(nt.tileID.toUnwrapped());Ot=pM(zt,I,N)}else{const zt=e.translatePosMatrix(X.projMatrix,nt,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Zt=m.projection.createInversionMatrix(m,X.canonical);Ot=y?tv(zt,e,Et,v,D,I,X,nt,A,R,L,Zt,O,N):tT(zt,e,Et,v,D,I,X,A,R,L,Zt,O,N,z,Q)}e.uploadCommonUniforms(f,at,X.toUnwrapped(),null,V);const kt=[];(e.terrain||h)&&kt.push(ot.centroidVertexBuffer),M&&kt.push(ot.layoutVertexExtBuffer),at.draw(e,f.gl.TRIANGLES,s,l,c,Le.backCCW,Ot,n.id,ot.layoutVertexBuffer,ot.indexBuffer,ot.segments,n.paint,e.transform.zoom,ft,kt)}e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!1)}function Ba(e,t,n,r,s,l,c,h,f,p,m,_,y,v,b,E,D,T,C){const I=e.context,A=I.gl,M=e.transform,R=e.transform.zoom,L=[],O=nf(e,n.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===p?(L.push("CLEAR_SUBPASS"),C&&(L.push("CLEAR_FROM_TEXTURE"),I.activeTexture.set(A.TEXTURE0),C.bind(A.LINEAR,A.CLAMP_TO_EDGE))):"sdf"===p&&L.push("SDF_SUBPASS"),D&&L.push("HAS_CENTROID"),O.shouldRenderCutoff&&L.push("RENDER_CUTOFF");const z=n.layout.get("fill-extrusion-edge-radius"),N=(V,B,$,j,Z)=>{const K=B.programConfigurations.get(n.id),Q=e.isTileAffectedByFog(V),W=e.getOrCreateProgram("fillExtrusionGroundEffect",{config:K,defines:L,overrideFog:Q}),X={u_matrix:j,u_opacity:m,u_ao_pass:f?1:0,u_meter_to_tile:Z,u_ao:[_,y*Z],u_flood_light_intensity:v,u_flood_light_color:b,u_attenuation:E,u_edge_radius:R>=17?0:z*Z,u_fb:0,u_fb_size:C?C.size[0]:0},nt=[];D&&nt.push(B.hiddenByLandmarkVertexBuffer),e.uploadCommonUniforms(I,W,V.toUnwrapped(),null,O),W.draw(e,I.gl.TRIANGLES,s,l,c,h,X,n.id,B.vertexBuffer,B.indexBuffer,$,n.paint,R,K,nt)};for(const V of r){const B=t.getTile(V),$=B.getBucket(n);if(!$||$.projection.name!==M.projection.name||!$.groundEffect||$.groundEffect&&!$.groundEffect.hasData())continue;const j=$.groundEffect,Z=1/$.tileToMeter;{const K=e.translatePosMatrix(V.projMatrix,B,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Q=j.getDefaultSegment();N(V,j,Q,K,Z)}if(T)for(let K=0;K<4;K++){const Q=N_[K](V),W=t.getTile(Q);if(!W)continue;const X=W.getBucket(n);if(!X||X.projection.name!==M.projection.name||!X.groundEffect||X.groundEffect&&!X.groundEffect.hasData())continue;const nt=X.groundEffect;let ot,lt;0===K?(ot=[-st,0,0],lt=1):1===K?(ot=[st,0,0],lt=0):2===K?(ot=[0,-st,0],lt=3):(ot=[0,st,0],lt=2);const ht=nt.regionSegments[lt];if(!ht)continue;const ft=new Float32Array(16);et.translate(ft,V.projMatrix,ot),N(V,nt,ht,e.translatePosMatrix(ft,B,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Z)}}}function lT(e,t,n,r,s,l,c){0===r.centroidVertexArray.length&&r.createCentroidsBuffer();const h=l?l.findDEMTileFor(n):null;if(!(h&&h.dem||c))return;const f=T=>{const C=t.getSource().minzoom,I=M=>{const R=t.getTileByID(M);if(R&&R.hasData())return R.getBucket(s)},A=[0,-1,1];for(const M of A){if(T.overscaledZ+M<C)continue;const R=I(T.calculateScaledKey(T.overscaledZ+M));if(R)return R}},p=[0,0,0],m=(T,C)=>(p[0]=Math.min(T.min.y,C.min.y),p[1]=Math.max(T.max.y,C.max.y),p[2]=st-C.min.x>T.max.x?C.min.x-st:T.max.x,p),_=(T,C)=>(p[0]=Math.min(T.min.x,C.min.x),p[1]=Math.max(T.max.x,C.max.x),p[2]=st-C.min.y>T.max.y?C.min.y-st:T.max.y,p),y=[(T,C)=>m(T,C),(T,C)=>m(C,T),(T,C)=>_(T,C),(T,C)=>_(C,T)],v=(T,C,I,A,M,R,L)=>{if(!l)return 0;const O=[[R?I:T,R?T:I,0],[R?I:C,R?C:I,0]],z=L<0?st+L:L,N=[R?z:(T+C)/2,R?(T+C)/2:z,0];return 0===I&&L<0||0!==I&&L>0?l.getForTilePoints(M,[N],!0,A):O.push(N),l.getForTilePoints(n,O,!0,h),Math.max(O[0][2],O[1][2],N[2])/l.exaggeration()};for(let T=0;T<4;T++){const C=r.borderFeatureIndices[T];if(0===C.length)continue;const I=N_[T](n),A=f(I);if(!(A&&A instanceof Ud)||r.borderDoneWithNeighborZ[T]===A.canonical.z)continue;0===A.centroidVertexArray.length&&A.createCentroidsBuffer();const M=l?l.findDEMTileFor(I):null;if(!(M&&M.dem||c))continue;const R=(T<2?1:5)-T,L=A.borderDoneWithNeighborZ[R]!==r.canonical.z,O=A.borderFeatureIndices[R];let z=0;if(r.canonical.z!==A.canonical.z){for(const N of C)r.showCentroid(r.featuresOnBorder[N]);if(L)for(const N of O)A.showCentroid(A.featuresOnBorder[N]);r.borderDoneWithNeighborZ[T]=A.canonical.z,A.borderDoneWithNeighborZ[R]=r.canonical.z}for(const N of C){const V=r.featuresOnBorder[N],B=r.centroidData[V.centroidDataIndex],$=V.borders[T];let j;for(;z<O.length;){j=A.featuresOnBorder[O[z]];const Z=j.borders[R];if(Z[1]>$[0]+3||Z[0]>$[0]-3)break;A.showCentroid(j),z++}if(j&&z<O.length){const Z=z;let K=0;for(;!(j.borders[R][0]>$[1]-3)&&(K++,++z!==O.length);)j=A.featuresOnBorder[O[z]];if(j=A.featuresOnBorder[O[Z]],K>1){const X=j.borders[R];Math.abs($[0]-X[0])<3&&Math.abs($[1]-X[1])<3&&(K=1,z=Z+1)}else if(0===K){r.showCentroid(V);continue}const Q=A.centroidData[j.centroidDataIndex];c&&1===K&&(((E=B).flags|(D=Q).flags)&Ys?(E.flags|=Ys,D.flags|=Ys):(E.flags&=2147483647,D.flags&=2147483647));let W=new tt(0,0);if(K>1)z=Z;else if(M&&M.dem&&!(V.intersectsCount()>1||j.intersectsCount()>1)){const X=y[T](B,Q),nt=T%2?8191:0;b=v(X[0],Math.min(8191,X[1]),nt,M,I,T<2,X[2]),W=new tt(Math.ceil(7*(b+450)),0)}B.centroidXY=Q.centroidXY=W,r.writeCentroidToBuffer(B),A.writeCentroidToBuffer(Q)}else r.showCentroid(V)}r.borderDoneWithNeighborZ[T]=A.canonical.z,A.borderDoneWithNeighborZ[R]=r.canonical.z}var b,E,D;(r.needsCentroidUpdate||!r.centroidVertexBuffer&&0!==r.centroidVertexArray.length)&&r.uploadCentroid(e)}const xM=[1,0,0],cT=[0,1,0],uT=[0,0,1];function qA(e,t,n){const r=n.transform,s=n.shadowRenderer;if(!s)return!0;const l=e.toUnwrapped(),c=r.tileSize*s._cascades[n.currentShadowCascade].scale;let h=t.maxHeight;if(r.elevation){const E=r.elevation.getMinMaxForTile(e);E&&(h+=E.max)}const f=[...s.shadowDirection];f[2]=-f[2];const p=s.computeSimplifiedTileShadowVolume(l,h,c,f);if(!p)return!1;const m=[xM,cT,uT,f,[f[0],0,f[2]],[0,f[1],f[2]]],_="globe"===r.projection.name,y=r.scaleZoom(c),v=is.fromInvProjectionMatrix(r.invProjMatrix,r.worldSize,y,!_),b=s.getCurrentCascadeFrustum();return 0===v.intersectsPrecise(p.vertices,p.planes,m)||0===b.intersectsPrecise(p.vertices,p.planes,m)}const bM=new le(1,0,0,1),WA=new le(0,1,0,1),ZA=new le(0,0,1,1),hT=new le(1,0,1,1),uv=new le(0,1,1,1);function wM(e,t,n){const r=e.context,s=e.transform,l=r.gl,c="globe"===s.projection.name,h=c?["PROJECTION_GLOBE_VIEW"]:[];let f=n.projMatrix;if(c&&Mr(s.zoom)>0){const N=q_(V_(n.canonical,s));f=et.multiply(new Float32Array(16),s.globeMatrix,N),et.multiply(f,s.projMatrix,f)}const p=e.getOrCreateProgram("debug",{defines:h}),m=t.getTileByID(n.key);e.terrain&&e.terrain.setupElevationDraw(m,p);const _=ue.disabled,y=Re.disabled,v=e.colorModeForRenderPass(),b="$debug";r.activeTexture.set(l.TEXTURE0),e.emptyTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE),c?m._makeGlobeTileDebugBuffers(e.context,s):m._makeDebugTileBoundsBuffers(e.context,s.projection);const E=m._tileDebugBuffer||e.debugBuffer,D=m._tileDebugIndexBuffer||e.debugIndexBuffer,T=m._tileDebugSegments||e.debugSegments;p.draw(e,l.LINE_STRIP,_,y,v,Le.disabled,Xm(f,le.red),b,E,D,T,null,null,null,[m._globeTileDebugBorderBuffer]);const C=m.latestRawTileData,I=Math.floor((C&&C.byteLength||0)/1024),A=t.getTile(n).tileSize,M=512/Math.min(A,512)*(n.overscaledZ/s.zoom)*.5;let R=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(R+=` => ${n.overscaledZ}`),R+=` ${I}kb`,function(N,V){N.initDebugOverlayCanvas();const B=N.debugOverlayCanvas,$=N.context.gl,j=N.debugOverlayCanvas.getContext("2d");j.clearRect(0,0,B.width,B.height),j.shadowColor="white",j.shadowBlur=2,j.lineWidth=1.5,j.strokeStyle="white",j.textBaseline="top",j.font="bold 36px Open Sans, sans-serif",j.fillText(V,5,5),j.strokeText(V,5,5),N.debugOverlayTexture.update(B),N.debugOverlayTexture.bind($.LINEAR,$.CLAMP_TO_EDGE)}(e,R);const L=m._tileDebugTextBuffer||e.debugBuffer,O=m._tileDebugTextIndexBuffer||e.quadTriangleIndexBuffer,z=m._tileDebugTextSegments||e.debugSegments;p.draw(e,l.TRIANGLES,_,y,Ye.alphaBlended,Le.disabled,Xm(f,le.transparent,M),b,L,O,z,null,null,null,[m._globeTileDebugTextBuffer])}function dT(e,t,n,r){hv(e,0,t+n/2,e.transform.width,n,r)}function EM(e,t,n,r){hv(e,t-n/2,0,n,e.transform.height,r)}function hv(e,t,n,r,s,l){const c=e.context,h=c.gl;h.enable(h.SCISSOR_TEST),h.scissor(t*me.devicePixelRatio,n*me.devicePixelRatio,r*me.devicePixelRatio,s*me.devicePixelRatio),c.clear({color:l}),h.disable(h.SCISSOR_TEST)}const XA=sn([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:YA}=XA;function Fc(e,t,n,r){e.emplaceBack(t,n,r)}class fT{constructor(t){this.vertexArray=new Fs,this.indices=new er,Fc(this.vertexArray,-1,-1,1),Fc(this.vertexArray,1,-1,1),Fc(this.vertexArray,-1,1,1),Fc(this.vertexArray,1,1,1),Fc(this.vertexArray,-1,-1,-1),Fc(this.vertexArray,1,-1,-1),Fc(this.vertexArray,-1,1,-1),Fc(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,YA),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=ln.simpleSegment(0,0,36,12)}}function ja(e,t,n,r,s,l){const c=e.context.gl,h=t.paint.get("sky-atmosphere-color"),f=t.paint.get("sky-atmosphere-halo-color"),p=t.paint.get("sky-atmosphere-sun-intensity"),m={u_matrix_3f:ji.fromMat4(ji.create(),r),u_sun_direction:s,u_sun_intensity:p,u_color_tint_r:[(b=h).r,b.g,b.b,b.a],u_color_tint_m:[(E=f).r,E.g,E.b,E.a],u_luminance:5e-5};var b,E;c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+l,t.skyboxTexture,0),n.draw(e,c.TRIANGLES,ue.disabled,Re.disabled,Ye.unblended,Le.frontCW,m,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const TM=sn([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class DM{constructor(t){const n=new ma;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const r=new er;r.emplaceBack(0,1,2),r.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,TM.members),this.indexBuffer=t.createIndexBuffer(r),this.segments=ln.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const pT=sn([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class zc{constructor(){this.colorModeAlphaBlendedWriteRGB=new Ye([1,771,1,771],le.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Ye([1,0,1,0],le.transparent,[!1,!1,!1,!0])}update(t){const n=t.context;if(!this.atmosphereBuffer){this.atmosphereBuffer=new DM(n);const r=100,s=200,l=function(m){const _=zh(30),y=[];for(let v=0;v<16e3;++v){const b=2*Math.PI*_(),E=Math.acos(1-2*_())-.5*Math.PI;y.push(H.fromValues(Math.cos(E)*Math.cos(b),Math.cos(E)*Math.sin(b),Math.sin(E)))}return y}(),c=zh(300),h=new lc,f=new er;let p=0;for(let m=0;m<l.length;++m){const _=H.scale([],l[m],200),y=Math.max(0,1+.01*r*(1*c()-.5)),v=Math.max(0,1+.01*s*(1*c()-.5));h.emplaceBack(_[0],_[1],_[2],-1,-1,y,v),h.emplaceBack(_[0],_[1],_[2],1,-1,y,v),h.emplaceBack(_[0],_[1],_[2],1,1,y,v),h.emplaceBack(_[0],_[1],_[2],-1,1,y,v),f.emplaceBack(p+0,p+1,p+2),f.emplaceBack(p+0,p+2,p+3),p+=4}this.starsVx=n.createVertexBuffer(h,pT.members),this.starsIdx=n.createIndexBuffer(f),this.starsSegments=ln.simpleSegment(0,0,h.length,f.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const r=t.context,s=r.gl,l=t.transform,c=new ue(s.LEQUAL,ue.ReadOnly,[0,1]),h=Mr(l.zoom),f=n.properties.get("color").toArray01(),p=n.properties.get("high-color").toArray01(),m=n.properties.get("space-color").toArray01PremultipliedAlpha(),_=5e-4,y=Gt((n.properties.get("horizon-blend")-0)/1*.2495+_,5e-4,.25),v=J1(t,r,l)&&y===_?l.worldSize/(2*Math.PI*1.025)-1:l.globeRadius,b=t.frameCounter/1e3%1,E=H.length(l.globeCenterInViewSpace),D=Math.sqrt(Math.pow(E,2)-Math.pow(v,2)),T=Math.acos(D/E),C=I=>{const A="globe"===l.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];I&&A.push("ALPHA_PASS");const M=t.getOrCreateProgram("globeAtmosphere",{defines:A}),R={u_frustum_tl:l.frustumCorners.TL,u_frustum_tr:l.frustumCorners.TR,u_frustum_br:l.frustumCorners.BR,u_frustum_bl:l.frustumCorners.BL,u_horizon:l.frustumCorners.horizon,u_transition:h,u_fadeout_range:y,u_color:f,u_high_color:p,u_space_color:m,u_temporal_offset:b,u_horizon_angle:T};t.uploadCommonUniforms(r,M);const L=this.atmosphereBuffer;L&&M.draw(t,s.TRIANGLES,c,Re.disabled,I?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Le.backCW,R,I?"atmosphere_glow_alpha":"atmosphere_glow",L.vertexBuffer,L.indexBuffer,L.segments)};C(!1),C(!0)}drawStars(t,n){const r=Gt(n.properties.get("star-intensity"),0,1);if(0===r)return;const s=t.context,l=s.gl,c=t.transform,h=t.getOrCreateProgram("stars"),f=Zr.identity([]);Zr.rotateX(f,f,-c._pitch),Zr.rotateZ(f,f,-c.angle),Zr.rotateX(f,f,be(c._center.lat)),Zr.rotateY(f,f,-be(c._center.lng));const p=et.fromQuat(new Float32Array(16),f),m=et.multiply([],c.starsProjMatrix,p),_=ji.fromMat4([],p),y=ji.invert([],_),v=[0,1,0];H.transformMat3(v,v,y),H.scale(v,v,.15);const b=[1,0,0];H.transformMat3(b,b,y),H.scale(b,b,.15);const E=(T=v,C=b,I=r,{u_matrix:Float32Array.from(m),u_up:T,u_right:C,u_intensity_multiplier:I});var T,C,I;t.uploadCommonUniforms(s,h),this.starsVx&&this.starsIdx&&h.draw(t,l.TRIANGLES,ue.disabled,Re.disabled,this.colorModeAlphaBlendedWriteRGB,Le.disabled,E,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function dv(e,t){const n=[...e],r=t.cameraWorldSizeForFog/t.worldSize,s=et.identity([]);return et.scale(s,s,[r,r,1]),et.multiply(n,s,n),et.multiply(n,t.worldToFogMatrix,n),n}function sf(e,t,n,r){const s=n.material,l=r.context,{baseColorTexture:c,metallicRoughnessTexture:h}=s.pbrMetallicRoughness,{normalTexture:f,occlusionTexture:p,emissionTexture:m}=s;function _(y,v,b){if(y&&(e.push(v),l.activeTexture.set(l.gl.TEXTURE0+b),y.gfxTexture)){const{minFilter:E,magFilter:D,wrapS:T,wrapT:C}=y.sampler;y.gfxTexture.bindExtraParam(E,D,T,C)}}_(c,"HAS_TEXTURE_u_baseColorTexture",uo_BaseColor),_(h,"HAS_TEXTURE_u_metallicRoughnessTexture",uo_MetallicRoughness),_(f,"HAS_TEXTURE_u_normalTexture",uo_Normal),_(p,"HAS_TEXTURE_u_occlusionTexture",uo_Occlusion),_(m,"HAS_TEXTURE_u_emissionTexture",uo_Emission),n.texcoordBuffer&&(e.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(e.push(12===n.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(e.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(e.push("HAS_ATTRIBUTE_a_pbr"),e.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),"OPAQUE"!==s.alphaMode&&"MASK"!==s.alphaMode||e.push("UNPREMULT_TEXTURE_IN_SHADER"),s.defined||e.push("DIFFUSE_SHADED"),e.push("USE_STANDARD_DERIVATIVES")}function dh(e,t,n,r,s,l){const c=n.paint.get("model-opacity"),h=t.context,f=new ue(t.context.gl.LEQUAL,ue.ReadWrite,t.depthRangeFor3D),p=t.transform,m=e.mesh,_=m.material,y=_.pbrMetallicRoughness,v=t.style.fog;let b;b="pixels"===t.transform.projection.zAxisUnit?[...e.nodeModelMatrix]:et.multiply([],r.zScaleMatrix,e.nodeModelMatrix),et.multiply(b,r.negCameraPosMatrix,b);const E=et.invert([],b);et.transpose(E,E);const D=iv(new Float32Array(e.worldViewProjection),new Float32Array(b),new Float32Array(E),t,c,y.baseColorFactor,_.emissiveFactor,y.metallicFactor,y.roughnessFactor,_,n),T={defines:[]},C=[];sf(T.defines,C,m,t);const I=t.shadowRenderer;I&&(I.useNormalOffset=!1);let A=null;if(v){const L=dv(e.nodeModelMatrix,t.transform);if(A=new Float32Array(L),"globe"!==p.projection.name){const O=m.aabb.min,z=m.aabb.max,[N,V]=v.getOpacityForBounds(L,O[0],O[1],z[0],z[1]);T.overrideFog=N>=Cc||V>=Cc}}const M=nf(t,n.paint.get("model-cutoff-fade-range"));M.shouldRenderCutoff&&T.defines.push("RENDER_CUTOFF");const R=t.getOrCreateProgram("model",T);t.uploadCommonUniforms(h,R,null,A,M),"shadow"!==t.renderPass&&I&&I.setupShadowsFromMatrix(e.nodeModelMatrix,R),R.draw(t,h.gl.TRIANGLES,f,s,l,m.material.doubleSided?Le.disabled:Le.backCCW,D,n.id,m.vertexBuffer,m.indexBuffer,m.segments,n.paint,t.transform.zoom,void 0,C)}function mT(e,t,n,r,s,l,c){let h;h="globe"===e.projection.name?Qu(n,e):[...n],et.multiply(h,h,t.matrix);const f=et.multiply([],r,h);if(t.meshes)for(const p of t.meshes){if("BLEND"!==p.material.alphaMode){c.push({mesh:p,depth:0,modelIndex:s,worldViewProjection:f,nodeModelMatrix:h});continue}const m=H.transformMat4([],p.centroid,f);m[2]>0&&l.push({mesh:p,depth:m[2],modelIndex:s,worldViewProjection:f,nodeModelMatrix:h})}if(t.children)for(const p of t.children)mT(e,p,n,r,s,l,c)}function af(e,t,n,r){const s=n.shadowRenderer;if(!s)return;const l=s.getShadowPassDepthMode(),c=s.getShadowPassColorMode(),h=s.calculateShadowPassMatrixFromMatrix(t),f=yM(h);n.getOrCreateProgram("modelDepth",{defines:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,l,Re.disabled,c,Le.backCCW,f,r.id,e.vertexBuffer,e.indexBuffer,e.segments,r.paint,n.transform.zoom,void 0,void 0)}function fv(e,t,n){const r=t.updateZoomBasedPaintProperties(),s=function(l,c,h){let f,p,m,_=l.terrain?l.terrain.exaggeration():0;if(l.terrain&&_>0){const y=l.terrain,v=y.findDEMTileFor(h);v&&v.dem?f=Sl.create(y,h,v):_=0}if(0===_&&(c.terrainElevationMin=0,c.terrainElevationMax=0),_===c.validForExaggeration&&(0===_||f&&f._demTile&&f._demTile.tileID===c.validForDEMTile.id&&f._dem._timestamp===c.validForDEMTile.timestamp))return!1;for(const y in c.instancesPerModel){const v=c.instancesPerModel[y];for(let b=0;b<v.instancedDataArray.length;++b){const E=(f?_*f.getElevationAt(0|v.instancedDataArray.float32[16*b],0|v.instancedDataArray.float32[16*b+1],!0,!0):0)+v.instancesEvaluatedElevation[b];v.instancedDataArray.float32[16*b+6]=E,p=p?Math.min(c.terrainElevationMin,E):E,m=m?Math.max(c.terrainElevationMax,E):E}}return c.terrainElevationMin=p||0,c.terrainElevationMax=m||0,c.validForExaggeration=_,c.validForDEMTile=f&&f._demTile?{id:f._demTile.tileID,timestamp:f._dem._timestamp}:{id:void 0,timestamp:0},!0}(e,t,n);(r||s)&&(t.uploaded=!1,t.upload(e.context))}const Co={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new Tn([0,0,0],[st,st,0])};function KA(e,t){const n=1<<e.canonical.z,r=t.getFreeCameraOptions().position,s=t.elevation,l=e.canonical.x/n,c=(e.canonical.x+1)/n,h=e.canonical.y/n,f=(e.canonical.y+1)/n;let p=t._centerAltitude;if(s){const v=s.getMinMaxForTile(e);v&&v.max>p&&(p=v.max)}const m=Gt(r.x,l,c)-r.x,_=Gt(r.y,h,f)-r.y,y=gn(p,t.center.lat)-r.z;return t._zoomFromMercatorZ(Math.sqrt(m*m+_*_+y*y))}function SM(e,t,n,r,s,l,c){const h=e.context,f="shadow"===e.renderPass,p=e.shadowRenderer,m=f&&p?p.getShadowPassDepthMode():new ue(h.gl.LEQUAL,ue.ReadWrite,e.depthRangeFor3D),_=e.isTileAffectedByFog(l);if(n.meshes)for(const y of n.meshes){const v=["MODEL_POSITION_ON_GPU"],b=[];let E,D,T;r.instancedDataArray.length>20&&v.push("INSTANCED_ARRAYS");const C=nf(e,t.paint.get("model-cutoff-fade-range"));if(C.shouldRenderCutoff&&v.push("RENDER_CUTOFF"),f&&p)E=e.getOrCreateProgram("modelDepth",{defines:v}),D=yM(c.shadowTileMatrix,c.shadowTileMatrix,Float32Array.from(n.matrix)),T=p.getShadowPassColorMode();else{sf(v,b,y,e),E=e.getOrCreateProgram("model",{defines:v,overrideFog:_});const A=y.material,M=A.pbrMetallicRoughness,R=t.paint.get("model-opacity");D=iv(l.projMatrix,Float32Array.from(n.matrix),new Float32Array(16),e,R,M.baseColorFactor,A.emissiveFactor,M.metallicFactor,M.roughnessFactor,A,t,s),p&&(c.shadowUniformsInitialized?E.setShadowUniformValues(h,p.getShadowUniformValues()):(p.setupShadows(l.toUnwrapped(),E,"model-tile",l.overscaledZ),c.shadowUniformsInitialized=!0)),T=C.shouldRenderCutoff||R<1||"OPAQUE"!==A.alphaMode?Ye.alphaBlended:Ye.unblended}e.uploadCommonUniforms(h,E,l.toUnwrapped(),null,C);const I=y.material.doubleSided?Le.disabled:Le.backCCW;if(r.instancedDataArray.length>20)b.push(r.instancedDataBuffer),E.draw(e,h.gl.TRIANGLES,m,Re.disabled,T,I,D,t.id,y.vertexBuffer,y.indexBuffer,y.segments,t.paint,e.transform.zoom,void 0,b,r.instancedDataArray.length);else{const A=f?"u_instance":"u_normal_matrix";for(let M=0;M<r.instancedDataArray.length;++M)D[A]=new Float32Array(r.instancedDataArray.arrayBuffer,64*M,16),E.draw(e,h.gl.TRIANGLES,m,Re.disabled,T,I,D,t.id,y.vertexBuffer,y.indexBuffer,y.segments,t.paint,e.transform.zoom,void 0,b)}}if(n.children)for(const y of n.children)SM(e,t,y,r,s,l,c)}const JA=[1,-1,1];function QA(e,t,n,r){if(!n.modelManager)return!0;const s=n.modelManager;if(!n.shadowRenderer)return!0;const l=n.shadowRenderer,c=t.aabb;let h=!0,f=e.maxHeight;if(0===f){let m=0;for(const _ in e.instancesPerModel){const y=s.getModel(_,r);y?m=Math.max(m,Math.max(Math.max(y.aabb.max[0],y.aabb.max[1]),y.aabb.max[2])):h=!1}f=e.maxScale*m*1.41+e.maxVerticalOffset,h&&(e.maxHeight=f)}c.max[2]=f,c.min[2]+=e.terrainElevationMin,c.max[2]+=e.terrainElevationMax,H.transformMat4(c.min,c.min,t.tileMatrix),H.transformMat4(c.max,c.max,t.tileMatrix);const p=c.intersects(l.getCurrentCascadeFrustum());return 0===n.currentShadowCascade&&(e.isInsideFirstShadowMapFrustum=2===p),0===p}class gT{}class CM{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,r){{const _=this._storage.get(n.id);if(_)return _.lastUsedFrameIdx=t,_.buf}const s=r.gl,l=s.getBufferParameter(s.ELEMENT_ARRAY_BUFFER,s.BUFFER_SIZE),c=new ArrayBuffer(l),h=new Int16Array(c);s.getBufferSubData(s.ELEMENT_ARRAY_BUFFER,0,new Int16Array(c));const f=new bo;for(let _=0;_<l/2;_+=3){const y=h[_],v=h[_+1],b=h[_+2];f.emplaceBack(y,v),f.emplaceBack(v,b),f.emplaceBack(b,y)}const p=r.bindVertexArrayOES.current,m=new gT;return m.buf=new No(r,f),m.lastUsedFrameIdx=t,this._storage.set(n.id,m),r.bindVertexArrayOES.set(p),m.buf}update(t){for(const[n,r]of this._storage)t-r.lastUsedFrameIdx>30&&(r.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}const _T={symbol:function(e,t,n,r,s){if("translucent"!==e.renderPass)return;const l=Re.disabled,c=e.colorModeForRenderPass();n.layout.get("text-variable-anchor")&&function(h,f,p,m,_,y,v){const b=f.transform,E="map"===_,D="map"===y;for(const T of h){const C=m.getTile(T),I=C.getBucket(p);if(!I||!I.text||!I.text.segments.get().length)continue;const A=ls(I.textSizeData,b.zoom),M=Jd(T,I.getProjection(),b),R=b.calculatePixelsToTileUnitsMatrix(C),L=n0(M,C.tileID.canonical,D,E,b,I.getProjection(),R),O=I.hasIconTextFit()&&I.hasIconData();if(A){const z=Math.pow(2,b.zoom-C.tileID.overscaledZ);sT(I,E,D,v,$b,b,L,T,z,A,O)}}}(r,e,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),s),0!==n.paint.get("icon-opacity").constantOr(1)&&lv(e,t,n,r,!1,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),n.layout.get("icon-rotation-alignment"),n.layout.get("icon-pitch-alignment"),n.layout.get("icon-keep-upright"),l,c),0!==n.paint.get("text-opacity").constantOr(1)&&lv(e,t,n,r,!0,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),n.layout.get("text-keep-upright"),l,c),t.map.showCollisionBoxes&&(sv(e,t,n,r,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),sv(e,t,n,r,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(e,t,n,r){if("translucent"!==e.renderPass)return;const s=n.paint.get("circle-opacity"),l=n.paint.get("circle-stroke-width"),c=n.paint.get("circle-stroke-opacity"),h=void 0!==n.layout.get("circle-sort-key").constantOr(1),f=n.paint.get("circle-emissive-strength");if(0===s.constantOr(1)&&(0===l.constantOr(1)||0===c.constantOr(1)))return;const p=e.context,m=p.gl,_=e.transform,y=e.depthModeForSublayer(0,ue.ReadOnly),v=Re.disabled,b=e.colorModeForDrapableLayerRenderPass(f),E="globe"===_.projection.name,D=[Xr(_.center.lng),Ur(_.center.lat)],T=[];for(let I=0;I<r.length;I++){const A=r[I],M=t.getTile(A),R=M.getBucket(n);if(!R||R.projection.name!==_.projection.name)continue;const L=R.programConfigurations.get(n.id),O=pb(n),z=e.isTileAffectedByFog(A);E&&O.push("PROJECTION_GLOBE_VIEW");const N=e.getOrCreateProgram("circle",{config:L,defines:O,overrideFog:z}),V=R.layoutVertexBuffer,B=R.globeExtVertexBuffer,$=R.indexBuffer,j=_.projection.createInversionMatrix(_,A.canonical),Z={programConfiguration:L,program:N,layoutVertexBuffer:V,globeExtVertexBuffer:B,indexBuffer:$,uniformValues:Pu(e,A,M,j,D,n),tile:M};if(h){const K=R.segments.get();for(const Q of K)T.push({segments:new ln([Q]),sortKey:Q.sortKey,state:Z})}else T.push({segments:R.segments,sortKey:0,state:Z})}h&&T.sort((I,A)=>I.sortKey-A.sortKey);const C={useDepthForOcclusion:_.depthOcclusionForSymbolsAndCircles};for(const I of T){const{programConfiguration:A,program:M,layoutVertexBuffer:R,globeExtVertexBuffer:L,indexBuffer:O,uniformValues:z,tile:N}=I.state,V=I.segments;e.terrain&&e.terrain.setupElevationDraw(N,M,C),e.uploadCommonUniforms(p,M,N.tileID.toUnwrapped()),M.draw(e,m.TRIANGLES,y,v,b,Le.disabled,z,n.id,R,O,V,n.paint,_.zoom,A,[L])}},heatmap:function(e,t,n,r){if(0!==n.paint.get("heatmap-opacity"))if("offscreen"===e.renderPass){const s=e.context,l=s.gl,c=Re.disabled,h=new Ye([l.ONE,l.ONE,l.ONE,l.ONE],le.transparent,[!0,!0,!0,!0]);(function(v,b,E,D){const T=v.gl,C=b.width*D,I=b.height*D;v.activeTexture.set(T.TEXTURE1),v.viewport.set([0,0,C,I]);let A=E.heatmapFbo;if(!A||A&&(A.width!==C||A.height!==I)){A&&A.destroy();const M=T.createTexture();T.bindTexture(T.TEXTURE_2D,M),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_S,T.CLAMP_TO_EDGE),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_WRAP_T,T.CLAMP_TO_EDGE),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MIN_FILTER,T.LINEAR),T.texParameteri(T.TEXTURE_2D,T.TEXTURE_MAG_FILTER,T.LINEAR),A=E.heatmapFbo=v.createFramebuffer(C,I,!0,null),function(R,L,O,z,N,V){const B=R.gl;B.texImage2D(B.TEXTURE_2D,0,R.extRenderToTextureHalfFloat?B.RGBA16F:B.RGBA,N,V,0,B.RGBA,R.extRenderToTextureHalfFloat?B.HALF_FLOAT:B.UNSIGNED_BYTE,null),z.colorAttachment.set(O)}(v,0,M,A,C,I)}else T.bindTexture(T.TEXTURE_2D,A.colorAttachment.get()),v.bindFramebuffer.set(A.framebuffer)})(s,e,n,"globe"===e.transform.projection.name?.5:.25),s.clear({color:le.transparent});const f=e.transform,p="globe"===f.projection.name,m=p?["PROJECTION_GLOBE_VIEW"]:[],_=p?Le.frontCCW:Le.disabled,y=[Xr(f.center.lng),Ur(f.center.lat)];for(let v=0;v<r.length;v++){const b=r[v];if(t.hasRenderableParent(b))continue;const E=t.getTile(b),D=E.getBucket(n);if(!D||D.projection.name!==f.projection.name)continue;const T=e.isTileAffectedByFog(b),C=D.programConfigurations.get(n.id),I=e.getOrCreateProgram("heatmap",{config:C,defines:m,overrideFog:T}),{zoom:A}=e.transform;e.terrain&&e.terrain.setupElevationDraw(E,I),e.uploadCommonUniforms(s,I,b.toUnwrapped());const M=f.projection.createInversionMatrix(f,b.canonical);I.draw(e,l.TRIANGLES,ue.disabled,c,h,_,gM(e,b,E,M,y,A,n.paint.get("heatmap-intensity")),n.id,D.layoutVertexBuffer,D.indexBuffer,D.segments,n.paint,e.transform.zoom,C,p?[D.globeExtVertexBuffer]:null)}s.viewport.set([0,0,e.width,e.height])}else"translucent"===e.renderPass&&(e.context.setColorMode(e.colorModeForRenderPass()),function(s,l){const c=s.context,h=c.gl,f=l.heatmapFbo;if(!f)return;c.activeTexture.set(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,f.colorAttachment.get()),c.activeTexture.set(h.TEXTURE1);let p=l.colorRampTexture;p||(p=l.colorRampTexture=new pr(c,l.colorRamp,h.RGBA)),p.bind(h.LINEAR,h.CLAMP_TO_EDGE),s.getOrCreateProgram("heatmapTexture").draw(s,h.TRIANGLES,ue.disabled,Re.disabled,s.colorModeForRenderPass(),Le.disabled,{u_image:0,u_color_ramp:1,u_opacity:l.paint.get("heatmap-opacity")},l.id,s.viewportBuffer,s.quadTriangleIndexBuffer,s.viewportSegments,l.paint,s.transform.zoom)}(e,n))},line:function(e,t,n,r){if("translucent"!==e.renderPass)return;const s=n.paint.get("line-opacity"),l=n.paint.get("line-width");if(0===s.constantOr(1)||0===l.constantOr(1))return;const c=n.paint.get("line-emissive-strength"),h=e.depthModeForSublayer(0,ue.ReadOnly),f=e.colorModeForDrapableLayerRenderPass(c),p=e.terrain&&e.terrain.renderingToTexture?1:me.devicePixelRatio,m=n.paint.get("line-dasharray"),_=m.constantOr(1),y=n.layout.get("line-cap"),v=n.paint.get("line-pattern"),b=v.constantOr(1),E=n.paint.get("line-pattern").constantOr(1),D=1!==n.paint.get("line-opacity").constantOr(1);let T=!E&&D;const C=n.paint.get("line-gradient"),I=b?"linePattern":"line",A=e.context,M=A.gl,R=hE(n);e.terrain&&e.terrain.clipOrMaskOverlapStencilType()&&(T=!1);for(const L of r){const O=t.getTile(L);if(b&&!O.patternsLoaded())continue;const z=O.getBucket(n);if(!z)continue;e.prepareDrawTile();const N=z.programConfigurations.get(n.id),V=e.isTileAffectedByFog(L),B=e.getOrCreateProgram(I,{config:N,defines:R,overrideFog:V}),$=v.constantOr(null);if($&&O.imageAtlas){const ot=O.imageAtlas.patternPositions[$.toString()];ot&&N.setConstantPatternPositions(ot)}const j=m.constantOr(null),Z=y.constantOr(null);if(!b&&j&&Z&&O.lineAtlas){const ot=O.lineAtlas.getDash(j,Z);ot&&N.setConstantPatternPositions(ot)}let[K,Q]=n.paint.get("line-trim-offset");("round"===Z||"square"===Z)&&K!==Q&&(0===K&&(K-=1),1===Q&&(Q+=1));const W=e.terrain?L.projMatrix:null,X=b?wC(e,O,n,W,p):w0(e,O,n,W,z.lineClipsArray.length,p,[K,Q]);if(C){const ot=z.gradients[n.id];let lt=ot.texture;if(n.gradientVersion!==ot.version){let ht=256;if(n.stepInterpolant){const ft=t.getSource().maxzoom,at=L.canonical.z===ft?Math.ceil(1<<e.transform.maxZoom-L.canonical.z):1;ht=Gt(un(z.maxLineLength/st*1024*at),256,A.maxTextureSize)}ot.gradient=hy({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:ht,image:ot.gradient||void 0,clips:z.lineClipsArray}),ot.texture?ot.texture.update(ot.gradient):ot.texture=new pr(A,ot.gradient,M.RGBA),ot.version=n.gradientVersion,lt=ot.texture}A.activeTexture.set(M.TEXTURE1),lt.bind(n.stepInterpolant?M.NEAREST:M.LINEAR,M.CLAMP_TO_EDGE)}_&&(A.activeTexture.set(M.TEXTURE0),O.lineAtlasTexture.bind(M.LINEAR,M.REPEAT),N.updatePaintBuffers()),b&&(A.activeTexture.set(M.TEXTURE0),O.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),N.updatePaintBuffers()),e.uploadCommonUniforms(A,B,L.toUnwrapped());const nt=ot=>{B.draw(e,M.TRIANGLES,h,ot,f,Le.disabled,X,n.id,z.layoutVertexBuffer,z.indexBuffer,z.segments,n.paint,e.transform.zoom,N,[z.layoutVertexBuffer2])};if(T){const ot=e.stencilModeForClipping(L).ref;0===ot&&e.terrain&&A.clear({stencil:0});const lt={func:M.EQUAL,mask:255};X.u_alpha_discard_threshold=.8,nt(new Re(lt,ot,255,M.KEEP,M.KEEP,M.INVERT)),X.u_alpha_discard_threshold=0,nt(new Re(lt,ot,255,M.KEEP,M.KEEP,M.KEEP))}else nt(e.stencilModeForClipping(L))}T&&(e.resetStencilClippingMasks(),e.terrain&&A.clear({stencil:0}))},fill:function(e,t,n,r){const s=n.paint.get("fill-color"),l=n.paint.get("fill-opacity");if(0===l.constantOr(1))return;const c=n.paint.get("fill-emissive-strength"),h=e.colorModeForDrapableLayerRenderPass(c),f=n.paint.get("fill-pattern"),p=e.opaquePassEnabledForLayer()&&!f.constantOr(1)&&1===s.constantOr(le.transparent).a&&1===l.constantOr(0)?"opaque":"translucent";if(e.renderPass===p){const m=e.depthModeForSublayer(1,"opaque"===e.renderPass?ue.ReadWrite:ue.ReadOnly);cv(e,t,n,r,m,h,!1)}if("translucent"===e.renderPass&&n.paint.get("fill-antialias")){const m=e.depthModeForSublayer(n.getPaintProperty("fill-outline-color")?2:0,ue.ReadOnly);cv(e,t,n,r,m,h,!0)}},"fill-extrusion":function(e,t,n,r){const s=n.paint.get("fill-extrusion-opacity"),l=e.context,c=l.gl,h=e.terrain,f=h&&h.renderingToTexture,p=n.paint.get("fill-extrusion-cutoff-fade-range");if(0===s)return;const m=e.conflationActive&&e.layerUsedInConflation(n,t.getSource());if(m&&function(_,y,v,b){for(const E of b){const D=y.getTile(E).getBucket(v);D&&(D.updateReplacement(E,_.replacementSource),D.uploadCentroid(_.context))}}(e,t,n,r),h||m)for(const _ of r){const y=t.getTile(_).getBucket(n);y&&lT(e.context,t,_,y,n,h,m)}if("shadow"===e.renderPass&&e.shadowRenderer){const _=e.shadowRenderer;if(h&&s<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof Dr)return;const y=_.getShadowPassDepthMode(),v=_.getShadowPassColorMode();Oc(e,t,n,r,y,Re.disabled,v,m)}else if("translucent"===e.renderPass){const _=!n.paint.get("fill-extrusion-pattern").constantOr(1);if(!f){const y=new ue(e.context.gl.LEQUAL,ue.ReadWrite,e.depthRangeFor3D);0===p&&1===s&&_?Oc(e,t,n,r,y,Re.disabled,Ye.unblended,m):(Oc(e,t,n,r,y,Re.disabled,Ye.disabled,m),Oc(e,t,n,r,y,e.stencilModeFor3D(),e.colorModeForRenderPass(),m),e.resetStencilClippingMasks())}if(e.style.enable3dLights()&&_&&(!h&&"globe"!==e.transform.projection.name||f)){const y=n.paint.get("fill-extrusion-opacity"),v=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),b=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),E=n.paint.get("fill-extrusion-flood-light-intensity"),D=n.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),T=v>0&&b>0,C=E>0,I=(M,R,L)=>(1-L)*M+L*R,A=M=>{const R=e.depthModeForSublayer(1,ue.ReadOnly,c.LEQUAL,!0),L=n.paint.get(M?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),O=I(.1,3,L),z=e._showOverdrawInspector;if(!z){const N=new Re({func:c.ALWAYS,mask:255},255,255,c.KEEP,c.KEEP,c.REPLACE),V=new Ye([c.ONE,c.ONE,c.ONE,c.ONE],le.transparent,[!1,!1,!1,!0],c.MIN);Ba(e,t,n,r,R,N,V,Le.disabled,M,"sdf",y,v,b,E,D,O,m,!1)}{const N=z?Re.disabled:new Re({func:c.EQUAL,mask:255},255,255,c.KEEP,c.DECR,c.DECR),V=z?e.colorModeForRenderPass():new Ye([c.ONE_MINUS_DST_ALPHA,c.DST_ALPHA,c.ONE,c.ONE],le.transparent,[!0,!0,!0,!0]);Ba(e,t,n,r,R,N,V,Le.disabled,M,"color",y,v,b,E,D,O,m,!1)}};if(f){const M=(R,L,O)=>{const z=e.depthModeForSublayer(1,ue.ReadOnly,c.LEQUAL,!1),N=n.paint.get(R?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),V=I(.1,3,N);{const B=new Ye([c.ONE,c.ONE,c.ONE,c.ONE],le.transparent,[!1,!1,!1,!0]);Ba(e,t,n,r,z,Re.disabled,B,Le.disabled,R,"clear",y,v,b,E,D,V,m,L)}{const B=new Re({func:c.ALWAYS,mask:255},255,255,c.KEEP,c.KEEP,c.REPLACE),$=new Ye([c.ONE,c.ONE,c.ONE,c.ONE],le.transparent,[!1,!1,!1,!0],c.MIN);Ba(e,t,n,r,z,B,$,Le.disabled,R,"sdf",y,v,b,E,D,V,m,L)}{const B=R?c.ZERO:c.ONE_MINUS_DST_ALPHA,$=new Re({func:c.EQUAL,mask:255},255,255,c.KEEP,c.DECR,c.DECR),j=new Ye([B,c.DST_ALPHA,c.ONE_MINUS_DST_ALPHA,c.ZERO],le.transparent,[!0,!0,!0,!0]);Ba(e,t,n,r,z,$,j,Le.disabled,R,"color",y,v,b,E,D,V,m,L)}{const B=new Ye([c.ONE,c.ONE,c.ONE,R?c.ZERO:c.ONE],le.transparent,[!1,!1,!1,!0],R?c.FUNC_ADD:c.MAX);Ba(e,t,n,r,z,Re.disabled,B,Le.disabled,R,"clear",y,v,b,E,D,V,m,L,O)}};if(T||C){let R;if(e.prepareDrawTile(),h){const L=h.drapeBufferSize[0],O=h.drapeBufferSize[1];R=h.framebufferCopyTexture,R&&(!R||R.size[0]===L&&R.size[1]===O)||(R&&R.destroy(),R=h.framebufferCopyTexture=new pr(l,new rr({width:L,height:O}),c.RGBA)),R.bind(c.LINEAR,c.CLAMP_TO_EDGE),c.copyTexImage2D(c.TEXTURE_2D,0,c.RGBA,0,0,L,O,0)}T&&M(!0,!1,R),C&&M(!1,!0,R)}}else T&&A(!0),C&&A(!1)}}},hillshade:function(e,t,n,r){if("offscreen"!==e.renderPass&&"translucent"!==e.renderPass)return;const s=e.context,l=e.terrain&&e.terrain.renderingToTexture,[c,h]="translucent"!==e.renderPass||l?[{},r]:e.stencilConfigForOverlap(r);for(const f of h){const p=t.getTile(f);if(p.needsHillshadePrepare&&"offscreen"===e.renderPass)lM(e,p,n);else if("translucent"===e.renderPass){const m=e.depthModeForSublayer(0,ue.ReadOnly),_=n.paint.get("hillshade-emissive-strength"),y=e.colorModeForDrapableLayerRenderPass(_),v=l&&e.terrain?e.terrain.stencilModeForRTTOverlap(f):c[f.overscaledZ];HA(e,f,p,n,m,v,y)}}s.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(e,t,n,r,s,l){if("translucent"!==e.renderPass||0===n.paint.get("raster-opacity"))return;const c=e.context,h=c.gl,f=t.getSource(),p=function(I,A,M){const R=[];let L,O;if(I.paint.get("raster-color")){R.push("RASTER_COLOR"),L=I.paint.get("raster-color-mix"),O=I.paint.get("raster-color-range"),A.activeTexture.set(M.TEXTURE2);let z=I.colorRampTexture;z||(z=I.colorRampTexture=new pr(A,I.colorRamp,M.RGBA)),z.bind(M.LINEAR,M.CLAMP_TO_EDGE)}return{mix:L,range:O,defines:R}}(n,c,h),m=p.defines;let _=!1;if(f instanceof Do&&!r.length){if("globe"!==e.transform.projection.name)return;if(f.onNorthPole)_=!0,m.push("PROJECTION_GLOBE_VIEW");else{if(!f.onSouthPole)return;_=!0,m.push("PROJECTION_GLOBE_VIEW")}}const y=e.colorModeForDrapableLayerRenderPass(),v=e.terrain&&e.terrain.renderingToTexture,b=!e.options.moving,E="nearest"===n.paint.get("raster-resampling")?h.NEAREST:h.LINEAR;if(_){const I=t.getSource();if(!(I instanceof Do))return;const A=I.texture;if(!A)return;const M=e.globeSharedBuffers;if(!M)return;const R=new ue(h.LEQUAL,ue.ReadWrite,e.depthRangeFor3D),L=Float32Array.from(e.transform.projMatrix);let O=Op(0,0,e.transform);const z=Float32Array.from($s(wo(new Oo(0,0,0)))),N={opacity:1,mix:0};e.terrain&&e.terrain.prepareDrawTile(),c.activeTexture.set(h.TEXTURE0),A.bind(E,h.CLAMP_TO_EDGE),c.activeTexture.set(h.TEXTURE1),A.bind(E,h.CLAMP_TO_EDGE),A.useMipmap&&c.extTextureFilterAnisotropic&&e.transform.pitch>20&&h.texParameterf(h.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax);const[V,B,$,j]=M.getPoleBuffers(0,!0);let Z;I.onNorthPole?(Z=V,e.renderDefaultNorthPole=!1):(O=et.scale(et.create(),O,[1,-1,1]),Z=B,e.renderDefaultSouthPole=!1);const K=Ym(L,z,O,[0,0],1,N,n,I.perspectiveTransform||[0,0],2,p.mix||[0,0,0,0],p.range||[0,0]),Q=e.getOrCreateProgram("raster",{defines:p.defines});return e.uploadCommonUniforms(c,Q,null),void Q.draw(e,h.TRIANGLES,R,Re.disabled,y,Le.disabled,K,n.id,Z,$,j)}if(!r.length)return;const[D,T]=f instanceof Do||v?[{},r]:e.stencilConfigForOverlap(r),C=T[T.length-1].overscaledZ;for(const I of T){const A=v?ue.disabled:e.depthModeForSublayer(I.overscaledZ-C,1===n.paint.get("raster-opacity")?ue.ReadWrite:ue.ReadOnly,h.LESS),M=I.toUnwrapped(),R=t.getTile(I);if(v&&(!R||!R.hasData())||!R.texture)continue;const L=v?I.projMatrix:e.transform.calculateProjMatrix(M,b),O=e.terrain&&v?e.terrain.stencilModeForRTTOverlap(I):D[I.overscaledZ],z=l?0:n.paint.get("raster-fade-duration");R.registerFadeDuration(z);const N=t.findLoadedParent(I,0),V=YE(R,N,t,e.transform,z);let B,$;e.terrain&&e.terrain.prepareDrawTile(),c.activeTexture.set(h.TEXTURE0),R.texture.bind(E,h.CLAMP_TO_EDGE),c.activeTexture.set(h.TEXTURE1),N?(N.texture.bind(E,h.CLAMP_TO_EDGE),B=Math.pow(2,N.tileID.overscaledZ-R.tileID.overscaledZ),$=[R.tileID.canonical.x*B%1,R.tileID.canonical.y*B%1]):R.texture.bind(E,h.CLAMP_TO_EDGE),R.texture.useMipmap&&c.extTextureFilterAnisotropic&&e.transform.pitch>20&&h.texParameterf(h.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax);const j=f instanceof Do?f.perspectiveTransform:[0,0],Z=new Float32Array(16),K=Ym(L,Z,Z,$||[0,0],B||1,V,n,j,2,p.mix||[0,0,0,0],p.range||[0,0]),Q=e.isTileAffectedByFog(I),W=e.getOrCreateProgram("raster",{defines:p.defines,overrideFog:Q});if(e.uploadCommonUniforms(c,W,M),f instanceof Do)f.boundsBuffer&&f.boundsSegments&&W.draw(e,h.TRIANGLES,A,Re.disabled,y,Le.disabled,K,n.id,f.boundsBuffer,e.quadTriangleIndexBuffer,f.boundsSegments);else{const{tileBoundsBuffer:X,tileBoundsIndexBuffer:nt,tileBoundsSegments:ot}=e.getTileBoundsBuffers(R);W.draw(e,h.TRIANGLES,A,O,y,Le.disabled,K,n.id,X,nt,ot)}}e.resetStencilClippingMasks()},background:function(e,t,n,r){const s=n.paint.get("background-color"),l=n.paint.get("background-opacity"),c=n.paint.get("background-emissive-strength");if(0===l)return;const h=e.context,f=h.gl,p=e.transform,m=p.tileSize,_=n.paint.get("background-pattern");if(e.isPatternMissing(_,n.scope))return;const y=!_&&1===s.a&&1===l&&e.opaquePassEnabledForLayer()?"opaque":"translucent";if(e.renderPass!==y)return;const v=Re.disabled,b=e.depthModeForSublayer(0,"opaque"===y?ue.ReadWrite:ue.ReadOnly),E=e.colorModeForDrapableLayerRenderPass(c),D=_?"backgroundPattern":"background";let T,C=r;C||(T=e.getBackgroundTiles(),C=Object.values(T).map(I=>I.tileID)),_&&(h.activeTexture.set(f.TEXTURE0),e.imageManager.bind(e.context,n.scope));for(const I of C){const A=e.isTileAffectedByFog(I),M=e.getOrCreateProgram(D,{overrideFog:A}),R=I.toUnwrapped(),L=r?I.projMatrix:e.transform.calculateProjMatrix(R);e.prepareDrawTile();const O=t?t.getTile(I):T?T[I.key]:new co(I,m,p.zoom,e),z=_?iT(L,c,l,e,_,n.scope,{tileID:I,tileSize:m}):_M(L,c,l,s);e.uploadCommonUniforms(h,M,R);const{tileBoundsBuffer:N,tileBoundsIndexBuffer:V,tileBoundsSegments:B}=e.getTileBoundsBuffers(O);M.draw(e,f.TRIANGLES,b,v,E,Le.disabled,z,n.id,N,V,B)}},sky:function(e,t,n){const r=e._atmosphere?Mr(e.transform.zoom):1,s=n.paint.get("sky-opacity")*r;if(0===s)return;const l=e.context,c=n.paint.get("sky-type"),h=new ue(l.gl.LEQUAL,ue.ReadOnly,[0,1]),f=e.frameCounter/1e3%1;"atmosphere"===c?"offscreen"===e.renderPass?n.needsSkyboxCapture(e)&&(function(p,m,_,y){const v=p.context,b=v.gl;let E=m.skyboxFbo;if(!E){E=m.skyboxFbo=v.createFramebuffer(32,32,!0,null),m.skyboxGeometry=new fT(v),m.skyboxTexture=v.gl.createTexture(),b.bindTexture(b.TEXTURE_CUBE_MAP,m.skyboxTexture),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_CUBE_MAP,b.TEXTURE_MAG_FILTER,b.LINEAR);for(let I=0;I<6;++I)b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+I,0,b.RGBA,32,32,0,b.RGBA,b.UNSIGNED_BYTE,null)}v.bindFramebuffer.set(E.framebuffer),v.viewport.set([0,0,32,32]);const D=m.getCenter(p,!0),T=p.getOrCreateProgram("skyboxCapture"),C=new Float64Array(16);et.identity(C),et.rotateY(C,C,.5*-Math.PI),ja(p,m,T,C,D,0),et.identity(C),et.rotateY(C,C,.5*Math.PI),ja(p,m,T,C,D,1),et.identity(C),et.rotateX(C,C,.5*-Math.PI),ja(p,m,T,C,D,2),et.identity(C),et.rotateX(C,C,.5*Math.PI),ja(p,m,T,C,D,3),et.identity(C),ja(p,m,T,C,D,4),et.identity(C),et.rotateY(C,C,Math.PI),ja(p,m,T,C,D,5),v.viewport.set([0,0,p.width,p.height])}(e,n),n.markSkyboxValid(e)):"sky"===e.renderPass&&function(p,m,_,y,v){const b=p.context,E=b.gl,D=p.transform,T=p.getOrCreateProgram("skybox");b.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_CUBE_MAP,m.skyboxTexture);const C={u_matrix:D.skyboxMatrix,u_sun_direction:m.getCenter(p,!1),u_cubemap:0,u_opacity:y,u_temporal_offset:v};p.uploadCommonUniforms(b,T),T.draw(p,E.TRIANGLES,_,Re.disabled,p.colorModeForRenderPass(),Le.backCW,C,"skybox",m.skyboxGeometry.vertexBuffer,m.skyboxGeometry.indexBuffer,m.skyboxGeometry.segment)}(e,n,h,s,f):"gradient"===c&&"sky"===e.renderPass&&function(p,m,_,y,v){const b=p.context,E=b.gl,D=p.transform,T=p.getOrCreateProgram("skyboxGradient");m.skyboxGeometry||(m.skyboxGeometry=new fT(b)),b.activeTexture.set(E.TEXTURE0);let C=m.colorRampTexture;C||(C=m.colorRampTexture=new pr(b,m.colorRamp,E.RGBA)),C.bind(E.LINEAR,E.CLAMP_TO_EDGE);const I=(L=y,O=v,{u_matrix:D.skyboxMatrix,u_color_ramp:0,u_center_direction:m.getCenter(p,!1),u_radius:be(m.paint.get("sky-gradient-radius")),u_opacity:L,u_temporal_offset:O});var L,O;p.uploadCommonUniforms(b,T),T.draw(p,E.TRIANGLES,_,Re.disabled,p.colorModeForRenderPass(),Le.backCW,I,"skyboxGradient",m.skyboxGeometry.vertexBuffer,m.skyboxGeometry.indexBuffer,m.skyboxGeometry.segment)}(e,n,h,s,f)},debug:function(e,t,n){for(let r=0;r<n.length;r++)wM(e,t,n[r])},custom:function(e,t,n,r){const s=e.context,l=n.implementation;if(!e.transform.projection.unsupportedLayers||!e.transform.projection.unsupportedLayers.includes("custom")||e.terrain&&(e.terrain.renderingToTexture||"offscreen"===e.renderPass)&&n.isLayerDraped(t)){if("offscreen"===e.renderPass){const c=l.prerender;if(c){if(e.setCustomLayerDefaults(),s.setColorMode(e.colorModeForRenderPass()),"globe"===e.transform.projection.name){const h=e.transform.pointMerc;c.call(l,s.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),Mr(e.transform.zoom),[h.x,h.y],e.transform.pixelsPerMeterRatio)}else c.call(l,s.gl,e.transform.customLayerMatrix());s.setDirty(),e.setBaseState()}}else if("translucent"===e.renderPass){if(e.terrain&&e.terrain.renderingToTexture){const h=l.renderToTile;if(h){const f=r[0].canonical,p=new He(f.x+r[0].wrap*(1<<f.z),f.y,f.z);s.setDepthMode(ue.disabled),s.setStencilMode(Re.disabled),s.setColorMode(e.colorModeForRenderPass()),e.setCustomLayerDefaults(),h.call(l,s.gl,p),s.setDirty(),e.setBaseState()}return}e.setCustomLayerDefaults(),s.setColorMode(e.colorModeForRenderPass()),s.setStencilMode(Re.disabled);const c="3d"===l.renderingMode?new ue(e.context.gl.LEQUAL,ue.ReadWrite,e.depthRangeFor3D):e.depthModeForSublayer(0,ue.ReadOnly);if(s.setDepthMode(c),"globe"===e.transform.projection.name){const h=e.transform.pointMerc;l.render(s.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),Mr(e.transform.zoom),[h.x,h.y],e.transform.pixelsPerMeterRatio)}else l.render(s.gl,e.transform.customLayerMatrix());s.setDirty(),e.setBaseState(),s.bindFramebuffer.set(null)}}else Y("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(e,t,n,r){if("opaque"===e.renderPass)return;const s=n.paint.get("model-opacity");if(0===s)return;const l=n.paint.get("model-cast-shadows");if("shadow"===e.renderPass&&(!l||e.terrain&&s<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof Dr))return;const c=e.shadowRenderer,h=n.paint.get("model-receive-shadows");c&&(c.useNormalOffset=!0,h||(c.enabled=!1));const f=()=>{c&&(c.useNormalOffset=!0,h||(c.enabled=!0))},p=t.getSource();if("light-beam"===e.renderPass&&"batched-model"!==p.type)return;if("vector"===p.type||"geojson"===p.type)return function(T,C,I,A){const M=T.transform;if("mercator"!==M.projection.name)return void Y(`Drawing 3D models for ${M.projection.name} projection is not yet implemented`);const R=M.getFreeCameraOptions().position;if(!T.modelManager)return;const L=T.modelManager,O=T.shadowRenderer;if(!I._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const z=I._unevaluatedLayout._values["model-id"],N={...I.layout.get("model-id").parameters};for(const V of A){const B=C.getTile(V).getBucket(I);if(!B||B.projection.name!==M.projection.name)continue;const $=KA(V,M);N.zoom=$;const j=z.possiblyEvaluate(N);if(fv(T,B,V),Co.shadowUniformsInitialized=!1,Co.useSingleShadowCascade=!!O&&0===O.getMaxCascadeForTile(V.toUnwrapped()),"shadow"===T.renderPass&&O){if(1===T.currentShadowCascade&&B.isInsideFirstShadowMapFrustum)continue;const Q=M.calculatePosMatrix(V.toUnwrapped(),M.worldSize);if(Co.tileMatrix.set(Q),Co.shadowTileMatrix=Float32Array.from(O.calculateShadowPassMatrixFromMatrix(Q)),Co.aabb.min.fill(0),Co.aabb.max[0]=Co.aabb.max[1]=st,Co.aabb.max[2]=0,QA(B,Co,T,I.scope))continue}const Z=1<<V.canonical.z,K=[((R.x-V.wrap)*Z-V.canonical.x)*st,(R.y*Z-V.canonical.y)*st,R.z*Z*st];for(let Q in B.instancesPerModel){const W=B.instancesPerModel[Q];W.features.length>0&&(Q=j.evaluate(W.features[0].feature,{}));const X=L.getModel(Q,I.scope);if(X&&X.uploaded)for(const nt of X.nodes)SM(T,I,nt,W,K,V,Co)}}}(e,t,n,r),void f();if(!p.loaded())return;if("batched-model"===p.type)return function(T,C,I,A){const M=T.context,R=T.transform,L=T.style.fog,O=T.shadowRenderer;if("mercator"!==R.projection.name)return void Y(`Drawing 3D landmark models for ${R.projection.name} projection is not yet implemented`);const z=T.transform.getFreeCameraOptions().position,N=H.scale([],[z.x,z.y,z.z],T.transform.worldSize);H.negate(N,N);const V=et.identity([]),B=ni(R.center.lat,R.zoom),$=et.fromScaling([],[1,1,1/B]);et.translate(V,V,N);const j=I.paint.get("model-opacity"),Z=new ue(M.gl.LEQUAL,ue.ReadWrite,T.depthRangeFor3D),K=new ue(M.gl.LEQUAL,ue.ReadOnly,T.depthRangeFor3D),Q=function(W,X){for(const nt of A){const ot=C.getTile(nt).getBucket(I);if(!ot||!ot.uploaded)continue;let lt=!1;O&&(lt=0===O.getMaxCascadeForTile(nt.toUnwrapped()));const ht=R.calculatePosMatrix(nt.toUnwrapped(),R.worldSize),ft=ot.modelTraits;for(const at of ot.getNodesInfo()){if(at.hiddenByReplacement||!at.node.meshes)continue;const ut=at.node,Et="light-beam"===T.renderPass,Ot=[...ht],kt=at.evaluatedScale;let zt=0;T.terrain&&ut.elevation&&(zt=ut.elevation*T.terrain.exaggeration()),et.translate(Ot,Ot,[(ut.anchor?ut.anchor[0]:0)*(kt[0]-1),(ut.anchor?ut.anchor[1]:0)*(kt[1]-1),zt]),kt!==hC&&et.scale(Ot,Ot,kt),et.multiply(Ot,Ot,ut.matrix);const Zt=et.multiply([],$,Ot);et.multiply(Zt,V,Zt);const oe=et.invert([],Zt);et.transpose(oe,oe),et.scale(oe,oe,JA);const Se=et.multiply([],R.projMatrix,Ot);for(let We=0;We<ut.meshes.length;++We){const Ee=ut.meshes[We],pe=We===ut.lightMeshIndex;if(pe){if(!Et&&!T.terrain&&T.shadowRenderer){T.currentLayer<T.firstLightBeamLayer&&(T.firstLightBeamLayer=T.currentLayer);continue}}else if(Et)continue;const ie={defines:[]},te=[];sf(ie.defines,te,Ee,T),4&ft||ie.defines.push("DIFFUSE_SHADED"),lt&&ie.defines.push("SHADOWS_SINGLE_CASCADE");const Ne="shadow"===T.renderPass;if(Ne){af(Ee,Ot,T,I);continue}let Xe=null;if(L){const Dn=dv(Ot,T.transform);if(Xe=new Float32Array(Dn),"globe"!==R.projection.name){const lr=Ee.aabb.min,Fn=Ee.aabb.max,[jn,pn]=L.getOpacityForBounds(Dn,lr[0],lr[1],Fn[0],Fn[1]);ie.overrideFog=jn>=Cc||pn>=Cc}}const Ce=T.getOrCreateProgram("model",ie);!Ne&&O&&(O.useNormalOffset=!!Ee.normalBuffer,O.setupShadowsFromMatrix(Ot,Ce,O.useNormalOffset)),T.uploadCommonUniforms(M,Ce,nt.toUnwrapped(),Xe);const yn=Ee.material,On=yn.pbrMetallicRoughness;On.metallicFactor=.9,On.roughnessFactor=.5;const Rn=iv(new Float32Array(Se),new Float32Array(Zt),new Float32Array(oe),T,j,On.baseColorFactor,yn.emissiveFactor,On.metallicFactor,On.roughnessFactor,yn,I);Ce.draw(T,M.gl.TRIANGLES,X&&!pe?Z:K,Re.disabled,W?pe||j<1||at.hasTranslucentParts?Ye.alphaBlended:Ye.unblended:Ye.disabled,Le.backCCW,Rn,I.id,Ee.vertexBuffer,Ee.indexBuffer,Ee.segments,I.paint,T.transform.zoom,void 0,te)}}}};(function(W,X,nt,ot){const lt=W.terrain?W.terrain.exaggeration():0,ht=W.transform.zoom;for(const ft of ot){const at=X.getTile(ft).getBucket(nt);at&&(W.conflationActive&&at.updateReplacement(ft,W.replacementSource),at.evaluateScale(W,nt),W.terrain&&lt>0&&at.elevationUpdate(W.terrain,lt,ft,nt.source),at.needsReEvaluation(W,ht,nt)&&at.evaluate(nt))}})(T,C,I,A),1===j?Q(!0,!0):(Q(!1,!0),Q(!0,!1))}(e,t,n,r),void f();const m=p.getModels(),_=[],y=e.transform.getFreeCameraOptions().position,v=H.scale([],[y.x,y.y,y.z],e.transform.worldSize);H.negate(v,v);const b=[],E=[];let D=0;for(const T of m){const C=n.paint.get("model-rotation").constantOr(null),I=n.paint.get("model-scale").constantOr(null),A=n.paint.get("model-translation").constantOr(null);T.computeModelMatrix(e,C,I,A,!0,!0,!1);const M=et.identity([]),R=ni(T.position.lat,e.transform.zoom),L=et.fromScaling([],[1,1,1/R]);et.translate(M,M,v),_.push({zScaleMatrix:L,negCameraPosMatrix:M});for(const O of T.nodes)mT(e.transform,O,T.matrix,e.transform.projMatrix,D,b,E);D++}if(b.sort((T,C)=>C.depth-T.depth),"shadow"!==e.renderPass){if(1===s)for(const T of E)dh(T,e,n,_[T.modelIndex],Re.disabled,e.colorModeForRenderPass());else{for(const T of E)dh(T,e,n,_[T.modelIndex],Re.disabled,Ye.disabled);for(const T of E)dh(T,e,n,_[T.modelIndex],e.stencilModeFor3D(),e.colorModeForRenderPass());e.resetStencilClippingMasks()}for(const T of b)dh(T,e,n,_[T.modelIndex],Re.disabled,e.colorModeForRenderPass());f()}else{for(const T of E)af(T.mesh,T.nodeModelMatrix,e,n);for(const T of b)af(T.mesh,T.nodeModelMatrix,e,n);f()}}},yT={modelUpload:function(e,t,n){const r=t.getSource();if(!r.loaded())return;if("vector"===r.type||"geojson"===r.type)return void(e.modelManager&&e.modelManager.upload(e,n));if("batched-model"===r.type)return;const s=r.getModels();for(const l of s)l.upload(e.context)}};class MM{constructor(t,n){this.context=new Mw(t),this.transform=n,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=Bo.maxUnderzooming+Bo.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new fC,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new IM(this),this._wireframeDebugCache=new CM,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(t,n){const r=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(r||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new gs(this,t));const s=this._terrain;this.transform.elevation=r?s:null,s.update(t,this.transform,n),this.transform.elevation&&!s.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||"globe"===this.transform.projection.name||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[r,s]=n.getFovAdjustedRange(this.transform._fov);if(r>s)return void(this.transform.fogCullDistSq=null);const l=r+.78*(s-r);this.transform.fogCullDistSq=l*l}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*me.devicePixelRatio,this.height=n*me.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const r of this.style.order)this.style._mergedLayers[r].resize()}setup(){const t=this.context,n=new ro;n.emplaceBack(0,0),n.emplaceBack(st,0),n.emplaceBack(0,st),n.emplaceBack(st,st),this.tileExtentBuffer=t.createVertexBuffer(n,_l.members),this.tileExtentSegments=ln.simpleSegment(0,0,4,2);const r=new ro;r.emplaceBack(0,0),r.emplaceBack(st,0),r.emplaceBack(0,st),r.emplaceBack(st,st),this.debugBuffer=t.createVertexBuffer(r,_l.members),this.debugSegments=ln.simpleSegment(0,0,4,5);const s=new ro;s.emplaceBack(-1,-1),s.emplaceBack(1,-1),s.emplaceBack(-1,1),s.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(s,_l.members),this.viewportSegments=ln.simpleSegment(0,0,4,2);const l=new ks;l.emplaceBack(0,0,0,0),l.emplaceBack(st,0,st,0),l.emplaceBack(0,st,0,st),l.emplaceBack(st,st,st,st),this.mercatorBoundsBuffer=t.createVertexBuffer(l,Wy.members),this.mercatorBoundsSegments=ln.simpleSegment(0,0,4,2);const c=new er;c.emplaceBack(0,1,2),c.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(c);const h=new ga;for(const p of[0,1,3,2,0])h.emplaceBack(p);this.debugIndexBuffer=t.createIndexBuffer(h),this.emptyTexture=new pr(t,new rr({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA),this.identityMat=et.create();const f=this.context.gl;this.stencilClearMode=new Re({func:f.ALWAYS,mask:0},0,255,f.ZERO,f.ZERO,f.ZERO),this.loadTimeStamps.push(it.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,ue.disabled,this.stencilClearMode,Ye.disabled,Le.disabled,XE(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,r){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!r||0===r.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let h=!1;for(const f of r)if(void 0===this._tileClippingMaskIDs[f.key]){h=!0;break}if(!h)return}this.currentStencilSource=n.id;const s=this.context,l=s.gl;this.nextStencilID+r.length>256&&this.clearStencil(),s.setColorMode(Ye.disabled),s.setDepthMode(ue.disabled);const c=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const h of r){const f=n.getTile(h),p=this._tileClippingMaskIDs[h.key]=this.nextStencilID++,{tileBoundsBuffer:m,tileBoundsIndexBuffer:_,tileBoundsSegments:y}=this.getTileBoundsBuffers(f);c.draw(this,l.TRIANGLES,ue.disabled,new Re({func:l.ALWAYS,mask:0},p,255,l.KEEP,l.KEEP,l.REPLACE),Ye.disabled,Le.disabled,XE(h.projMatrix),"$clipping",m,_,y)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new Re({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new Re({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,r=t.sort((c,h)=>h.overscaledZ-c.overscaledZ),s=r[r.length-1].overscaledZ,l=r[0].overscaledZ-s+1;if(l>1){this.currentStencilSource=void 0,this.nextStencilID+l>256&&this.clearStencil();const c={};for(let h=0;h<l;h++)c[h+s]=new Re({func:n.GEQUAL,mask:255},h+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=l,[c,r]}return[{[s]:Re.disabled},r]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new Ye([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new le(.125,.125,.125,0),[!0,!0,!0,!0]):"opaque"===this.renderPass?Ye.unblended:Ye.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new Ye([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new le(0,0,0,void 0===t?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,n,r,s=!1){if(!this.opaquePassEnabledForLayer()&&!s)return ue.disabled;const l=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new ue(r||this.context.gl.LEQUAL,n,[l,l])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,n){this._wireframeDebugCache.update(this.frameCounter),this.style=t,this.options=n;const r=this.style._mergedLayers,s=this.style.order,l=s.map(M=>r[M]),c=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(me.now()),this.imageManager.beginFrame();let h=0,f=!1;for(const M in c){const R=c[M];R.used&&(R.prepare(this.context),R.getSource().usedInConflation&&++h)}const p={},m={},_={},y={},v={};for(const M in c){const R=c[M];p[M]=R.getVisibleCoordinates(),m[M]=p[M].slice().reverse(),_[M]=R.getVisibleCoordinates(!0).reverse(),y[M]=R.getShadowCasterCoordinates(),v[M]=R.sortCoordinatesByDistance(p[M])}const b=M=>{const R=this.style.getLayerSourceCache(M);return R&&R.used?R.getSource():null};if(h){const M=[];for(const R of l)this.layerUsedInConflation(R,b(R))&&M.push(R);if(M&&M.length>1){const R=[];for(const L of M){const O=this.style.getLayerSourceCache(L);O&&O.used&&O.getSource().usedInConflation&&R.push({layer:L.fqid,cache:O})}this.replacementSource.setSources(R),f=!0}}f||this.replacementSource.clear(),this.conflationActive=f,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const M of l){const R=M.cutoffRange();if(this.longestCutoffRange=Math.max(R,this.longestCutoffRange),R>0){const L=b(M);L&&(this.minCutoffZoom=Math.max(L.minzoom,this.minCutoffZoom)),M.minzoom&&(this.minCutoffZoom=Math.max(M.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let M=0;M<l.length;M++)if(l[M].is3D()){this.opaquePassCutoff=M;break}const E=this.style&&this.style.fog;E?(this._fogVisible=0!==E.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=E.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(_),this.opaquePassCutoff=0);const D=this._shadowRenderer;if(D){D.updateShadowParameters(this.transform,this.style.directionalLight);for(const M in c)for(const R of p[M]){let L={min:0,max:0};this.terrain&&(L=this.terrain.getMinMaxForTile(R)||L),D.addShadowReceiver(R.toUnwrapped(),L.min,L.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new dS(this.context));for(const M of l){if(M.isHidden(this.transform.zoom))continue;const R=t.getLayerSourceCache(M);this.uploadLayer(this,M,R)}if(this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new zc),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!Ka.has(this.context.gl))return;this.renderPass="offscreen";for(const M of l){const R=t.getLayerSourceCache(M);if(!M.hasOffscreenPass()||M.isHidden(this.transform.zoom))continue;const L=R?m[R.id]:void 0;("custom"===M.type||"raster"===M.type||M.isSky()||L&&L.length)&&this.renderLayer(this,R,M,L)}this.depthRangeFor3D=[0,1-(l.length+2)*this.numSublayers*this.depthEpsilon];const T=this.terrain;T&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&T.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,y)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const C="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),I=(()=>{if(n.showOverdrawInspector)return le.black;if(this.style.fog&&this.transform.projection.supportsFog&&!C){const M=this.style.fog.properties.get("color").toArray01();return new le(...M)}if(this.style.fog&&this.transform.projection.supportsFog&&C){const M=this.style.fog.properties.get("space-color").toArray01();return new le(...M)}return le.transparent})();if(this.context.clear({color:I,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&C&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=s.length-1;this.currentLayer>=0;this.currentLayer--){const M=l[this.currentLayer],R=t.getLayerSourceCache(M);if(M.isSky())continue;const L=R?(M.is3D()?v:m)[R.id]:void 0;this._renderTileClippingMasks(M,R,L),this.renderLayer(this,R,M,L)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&C&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||Mr(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<s.length;this.currentLayer++){const M=l[this.currentLayer],R=t.getLayerSourceCache(M);M.isSky()&&this.renderLayer(this,R,M,R?m[R.id]:void 0)}this.renderPass="translucent",this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let A=0;for(D&&(A=D.getShadowCastingLayerCount());this.currentLayer<s.length;){const M=l[this.currentLayer],R=t.getLayerSourceCache(M);if(M.isSky()){++this.currentLayer;continue}if(T&&this.style.isLayerDraped(M)){if(M.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=T.renderBatch(this.currentLayer);continue}let L;if(R&&(L=("symbol"===M.type?_:M.is3D()?v:m)[R.id]),this._renderTileClippingMasks(M,R,R?p[R.id]:void 0),this.renderLayer(this,R,M,L),!T&&D&&A>0&&M.hasShadowPass()&&0==--A&&(D.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const O=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=O;this.currentLayer++){const z=l[this.currentLayer];if(!z.hasLightBeamPass())continue;const N=t.getLayerSourceCache(z);this.renderLayer(this,N,z,N?m[N.id]:void 0)}this.currentLayer=O,this.renderPass="translucent"}++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let M=null;l.forEach(R=>{const L=t.getLayerSourceCache(R);L&&!R.isHidden(this.transform.zoom)&&L.getVisibleCoordinates().length&&(!M||M.getSource().maxzoom<L.getSource().maxzoom)&&(M=L)}),M&&this.options.showTileBoundaries&&_T.debug(this,M,M.getVisibleCoordinates())}this.options.showPadding&&function(M){const R=M.transform.padding;dT(M,M.transform.height-(R.top||0),3,bM),dT(M,R.bottom||0,3,WA),EM(M,R.left||0,3,ZA),EM(M,M.transform.width-(R.right||0),3,hT);const L=M.transform.centerPoint;var O,z,N,V;hv(O=M,(z=L.x)-1,(N=M.transform.height-L.y)-10,2,20,V=uv),hv(O,z-10,N-1,20,2,V)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(it.performance.now()),this.saveCanvasCopy()),f||(this.conflationActive=!1)}uploadLayer(t,n,r){this.gpuTimingStart(n),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(n.type)||t.terrain&&"custom"===n.type)&&yT[`${n.type}Upload`]&&yT[`${n.type}Upload`](t,r,n.scope),this.gpuTimingEnd()}renderLayer(t,n,r,s){r.isHidden(this.transform.zoom)||("background"===r.type||"sky"===r.type||"custom"===r.type||"model"===r.type||"raster"===r.type||s&&s.length)&&(this.id=r.id,this.gpuTimingStart(r),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(r.type)||t.terrain&&"custom"===r.type)&&_T[r.type](t,n,r,s,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,r=this.context.gl;let s=this.gpuTimers[t.id];s||(s=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:r.createQuery()}),s.calls++,r.beginQuery(n.TIME_ELAPSED_EXT,s.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,r=n.createQuery();this.deferredRenderGpuTimeQueries.push(r),n.beginQuery(t.TIME_ELAPSED_EXT,r)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const r in t){const s=t[r],l=this.context.extTimerQuery,c=l.getQueryParameter(s.query,this.context.gl.QUERY_RESULT)/1e6;l.deleteQueryEXT(s.query),n[r]=c}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.extTimerQuery,r=this.context.gl;let s=0;for(const l of t)s+=n.getQueryParameter(l,r.QUERY_RESULT)/1e6,n.deleteQueryEXT(l);return s}translatePosMatrix(t,n,r,s,l){if(!r[0]&&!r[1])return t;const c=l?"map"===s?this.transform.angle:0:"viewport"===s?-this.transform.angle:0;if(c){const p=Math.sin(c),m=Math.cos(c);r=[r[0]*m-r[1]*p,r[0]*p+r[1]*m]}const h=[l?r[0]:Xs(n,r[0],this.transform.zoom),l?r[1]:Xs(n,r[1],this.transform.zoom),0],f=new Float32Array(16);return et.translate(f,t,h),f}saveTileTexture(t){const n=this._tileTextures[t.size[0]];n?n.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}isPatternMissing(t,n){return null===t||void 0!==t&&!this.imageManager.getPattern(t.toString(),n)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}terrainUseFloatDEM(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(t,n,r){const s=void 0===r?this.terrain&&this.terrain.renderingToTexture:r,l=this.terrain&&0===this.terrain.exaggeration(),c=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===t||"terrainRaster"===t?(c.push("LIGHTING_3D_MODE"),c.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):s||c.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass?this._shadowMapDebug||c.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?c.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):c.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(c.push("TERRAIN"),this.terrainUseFloatDEM()&&c.push("TERRAIN_DEM_FLOAT_FORMAT"),l&&c.push("ZERO_EXAGGERATION")),"globe"===this.transform.projection.name&&c.push("GLOBE"),!this._fogVisible||s||void 0!==n&&!n||c.push("FOG","FOG_DITHERING"),s&&c.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&c.push("OVERDRAW_INSPECTOR"),c}getOrCreateProgram(t,n){this.cache=this.cache||{};const r=n&&n.defines||[],s=n&&n.config,l=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(r),c=Hr.cacheKey(sM[t],t,l,s);return this.cache[c]||(this.cache[c]=new Hr(this.context,t,sM[t],s,oT[t],l)),this.cache[c]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=it.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new pr(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const r=this.style.directionalLight,s=this.style.ambientLight;if(r&&s){const l=((c,h)=>{const f=c.properties.get("direction"),p=c.properties.get("color").toArray01(),m=c.properties.get("intensity"),_=h.properties.get("color").toArray01(),y=h.properties.get("intensity"),v=[f.x,f.y,f.z],b=Kn(_,y),E=Kn(p,m);return{u_lighting_ambient_color:b,u_lighting_directional_dir:v,u_lighting_directional_color:E,u_ground_radiance:dM(v,E,b)}})(r,s);n.setLightsUniformValues(t,l)}}}uploadCommonUniforms(t,n,r,s,l){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const c=this.style.fog;if(c){const h=c.getOpacity(this.transform.pitch),f=((p,m,_,y,v,b,E,D,T,C,I,A)=>{const M=p.transform,R=m.properties.get("color").toArray01();R[3]=y;const L=p.frameCounter/1e3%1,[O,z]=m.properties.get("vertical-range");return{u_fog_matrix:_?M.calculateFogTileMatrix(_):A||p.identityMat,u_fog_range:m.getFovAdjustedRange(M._fov),u_fog_color:R,u_fog_horizon_blend:m.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(O,z),z],u_fog_temporal_offset:L,u_frustum_tl:v,u_frustum_tr:b,u_frustum_br:E,u_frustum_bl:D,u_globe_pos:T,u_globe_radius:C,u_viewport:I,u_globe_transition:Mr(M.zoom),u_is_globe:+("globe"===M.projection.name)}})(this,c,r,h,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*me.devicePixelRatio,this.transform.height*me.devicePixelRatio],s);n.setFogUniformValues(t,f)}l&&n.setCutoffUniformValues(t,l.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&0!==t.getOpacity(this.transform.pitch)}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},r=this.transform.coveringTiles({tileSize:512});for(const s of r)n[s.key]=t[s.key]||new co(s,512,this.transform.tileZoom,this);return n}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(t,n){return!(!t.is3D()||t.minzoom&&t.minzoom>this.transform.zoom||"building"!==t.sourceLayer&&(!n||"batched-model"!==n.type))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=Cc||n[1]>=Cc}}const Ll=2048;class vT{constructor(t,n){this.aabb=t,this.lastCascade=n}}class xT{add(t,n){const r=this.receivers[t.key];void 0!==r?(r.aabb.min[0]=Math.min(r.aabb.min[0],n.min[0]),r.aabb.min[1]=Math.min(r.aabb.min[1],n.min[1]),r.aabb.min[2]=Math.min(r.aabb.min[2],n.min[2]),r.aabb.max[0]=Math.max(r.aabb.max[0],n.max[0]),r.aabb.max[1]=Math.max(r.aabb.max[1],n.max[1]),r.aabb.max[2]=Math.max(r.aabb.max[2],n.max[2])):this.receivers[t.key]=new vT(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,r){const s=Tn.fromPoints(t.points);let l=0;for(const c in this.receivers){const h=this.receivers[c];if(!h||!s.intersectsAabb(h.aabb))continue;h.aabb.min=s.closestPoint(h.aabb.min),h.aabb.max=s.closestPoint(h.aabb.max);const f=h.aabb.getCorners();for(let p=0;p<r.length;p++){let m=!0;for(const _ of f){const y=[_[0]*n,_[1]*n,_[2]];if(H.transformMat4(y,y,r[p].matrix),y[0]<-1||y[0]>1||y[1]<-1||y[1]>1){m=!1;break}}if(h.lastCascade=p,l=Math.max(l,p),m)break}}return l+1}}class IM{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new xT,this._depthMode=new ue(t.context.gl.LEQUAL,ue.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const r=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const s=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||s<=0||(this._shadowLayerCount=r.style.order.reduce((v,b)=>{const E=r.style._mergedLayers[b];return v+(E.hasShadowPass()&&!E.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this._enabled))return;const l=r.context,c=Ll,h=Ll;if(0===this._cascades.length)for(let v=0;v<2;++v){const b=r._shadowMapDebug,E=l.gl,D=l.createFramebuffer(c,h,b,"texture"),T=new pr(l,{width:c,height:h,data:null},E.DEPTH_COMPONENT);if(D.depthAttachment.set(T.texture),b){const C=new pr(l,{width:c,height:h,data:null},E.RGBA);D.colorAttachment.set(C.texture)}this._cascades.push({framebuffer:D,texture:T,matrix:[],far:0,boundingSphereRadius:0,frustum:new is,scale:0})}this.shadowDirection=pv(n);let f=0;if(t.elevation){const v=t.elevation,b=[1e4,-1e4];v.visibleDemTiles.filter(E=>E.dem).forEach(E=>{const D=E.dem.tree;b[0]=Math.min(b[0],D.minimums[0]),b[1]=Math.max(b[1],D.maximums[0])}),1e4!==b[0]&&(f=(b[1]-b[0])*v.exaggeration())}const p=1.5*t.cameraToCenterDistance,m=3*p,_=new Float64Array(16);for(let v=0;v<2;++v){const b=this._cascades[v];let E=t.height/50,D=1;0===v?D=p:(E=p,D=m);const[T,C]=t2(t,this.shadowDirection,E,D,Ll,f);b.scale=t.scale,b.matrix=T,b.boundingSphereRadius=C,et.invert(_,b.matrix),b.frustum=is.fromInvProjectionMatrix(_,1,0,!0),b.far=D}this._uniformValues.u_fade_range=[.75*this._cascades[1].far,this._cascades[1].far],this._uniformValues.u_shadow_intensity=s,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=Ll,this._uniformValues.u_shadowmap_0=uo_ShadowMap0,this._uniformValues.u_shadowmap_1=uo_ShadowMap0+1,this._groundShadowTiles=r.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const y=r.transform.elevation;for(const v of this._groundShadowTiles){let b={min:0,max:0};if(y){const E=y.getMinMaxForTile(v);E&&(b=E)}this.addShadowReceiver(v.toUnwrapped(),b.min,b.max)}}get enabled(){return this._enabled}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this._enabled)return;const r=this.painter,s=r.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(r.transform.getFrustum(0),r.transform.worldSize,this._cascades),s.viewport.set([0,0,Ll,Ll]);for(let l=0;l<this._numCascadesToRender;++l){r.currentShadowCascade=l,s.bindFramebuffer.set(this._cascades[l].framebuffer.framebuffer),s.clear({color:le.white,depth:1});for(const c of t.order){const h=t._mergedLayers[c];if(!h.hasShadowPass()||h.isHidden(r.transform.zoom))continue;const f=t.getLayerSourceCache(h),p=f?n[f.id]:void 0;("model"===h.type||p&&p.length)&&r.renderLayer(r,f,h,p)}}r.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const t=this.painter,n=t.style,r=t.context,s=n.directionalLight,l=n.ambientLight;if(!s||!l)return;const c=[],h=nf(t,t.longestCutoffRange);h.shouldRenderCutoff&&c.push("RENDER_CUTOFF");const f=fh(s,l),p=new ue(r.gl.LEQUAL,ue.ReadOnly,t.depthRangeFor3D);for(const m of this._groundShadowTiles){const _=m.toUnwrapped(),y=t.isTileAffectedByFog(m),v=t.getOrCreateProgram("groundShadow",{defines:c,overrideFog:y});this.setupShadows(_,v),t.uploadCommonUniforms(r,v,_,null,h);const b={u_matrix:t.transform.calculateProjMatrix(_),u_ground_shadow_factor:f};v.draw(t,r.gl.TRIANGLES,p,Re.disabled,Ye.multiply,Le.disabled,b,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,{},t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Ye.unblended:Ye.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,r=n.calculatePosMatrix(t,n.worldSize);return et.multiply(r,this._cascades[this.painter.currentShadowCascade].matrix,r),Float32Array.from(r)}calculateShadowPassMatrixFromMatrix(t){return et.multiply(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,n,r,s=0){if(!this._enabled)return;const l=this.painter.transform,c=this.painter.context,h=c.gl,f=this._uniformValues,p=new Float64Array(16),m=l.calculatePosMatrix(t,l.worldSize);for(let _=0;_<2;_++)et.multiply(p,this._cascades[_].matrix,m),f[0===_?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(p),c.activeTexture.set(h.TEXTURE0+uo_ShadowMap0+_),this._cascades[_].texture.bind(h.NEAREST,h.CLAMP_TO_EDGE);if(this.useNormalOffset=!!r,this.useNormalOffset){const _=Au(t.canonical),y=2/l.tileSize*st/Ll,v=y*this._cascades[0].boundingSphereRadius,b=y*this._cascades[1].boundingSphereRadius,E=("vector-tile"===r?1:3)/Math.pow(2,s-t.canonical.z-(1-l.zoom+Math.floor(l.zoom)));f.u_shadow_normal_offset=[_,v*E,b*E],f.u_shadow_bias=[6e-5,.0012,.012]}else f.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(c,f)}setupShadowsFromMatrix(t,n,r=!1){if(!this._enabled)return;const s=this.painter.context,l=s.gl,c=this._uniformValues,h=new Float64Array(16);for(let f=0;f<2;f++)et.multiply(h,this._cascades[f].matrix,t),c[0===f?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(h),s.activeTexture.set(l.TEXTURE0+uo_ShadowMap0+f),this._cascades[f].texture.bind(l.NEAREST,l.CLAMP_TO_EDGE);this.useNormalOffset=r,r?(c.u_shadow_normal_offset=[1,5,5],c.u_shadow_bias=[6e-5,.0012,.012]):c.u_shadow_bias=[36e-5,.0012,.012],n.setShadowUniformValues(s,c)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,r,s){if(s[2]>=0)return{};const l=function(f,p,m){const _=m/(1<<f.canonical.z);return new Tn([f.canonical.x*_+f.wrap*m,f.canonical.y*_+f.wrap*m,0],[(f.canonical.x+1)*_+f.wrap*m,(f.canonical.y+1)*_+f.wrap*m,p])}(t,n,r).getCorners(),c=n/-s[2];s[0]<0?(H.add(l[0],l[0],[s[0]*c,0,0]),H.add(l[3],l[3],[s[0]*c,0,0])):s[0]>0&&(H.add(l[1],l[1],[s[0]*c,0,0]),H.add(l[2],l[2],[s[0]*c,0,0])),s[1]<0?(H.add(l[0],l[0],[0,s[1]*c,0]),H.add(l[1],l[1],[0,s[1]*c,0])):s[1]>0&&(H.add(l[2],l[2],[0,s[1]*c,0]),H.add(l[3],l[3],[0,s[1]*c,0]));const h={};return h.vertices=l,h.planes=[tg(l[1],l[0],l[4]),tg(l[2],l[1],l[5]),tg(l[3],l[2],l[6]),tg(l[0],l[3],l[7])],h}addShadowReceiver(t,n,r){this._receivers.add(t,Tn.fromTileIdAndHeight(t,n,r))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function tg(e,t,n){const r=H.sub([],n,t),s=H.sub([],e,t),l=H.cross([],r,s),c=H.length(l);return 0===c?[0,0,1,0]:(H.scale(l,l,1/c),[l[0],l[1],l[2],-H.dot(l,t)])}function pv(e){const t=e.properties.get("direction"),n=Wt(t.x,t.y,t.z);n[2]=Gt(n[2],0,75);const r=Nt([n[0],n[1],n[2]]);return H.fromValues(r.x,r.y,r.z)}function fh(e,t){const n=e.properties.get("color"),r=e.properties.get("intensity"),s=e.properties.get("direction"),l=[s.x,s.y,s.z],c=t.properties.get("color"),h=t.properties.get("intensity"),f=Math.max(H.dot([0,0,1],l),0),p=[0,0,0];H.scale(p,c.toArray01Linear().slice(0,3),h);const m=[0,0,0];return H.scale(m,n.toArray01Linear().slice(0,3),f*r),Cn([p[0]>0?p[0]/(p[0]+m[0]):0,p[1]>0?p[1]/(p[1]+m[1]):0,p[2]>0?p[2]/(p[2]+m[2]):0])}function t2(e,t,n,r,s,l){const c=e.zoom,h=e.scale,f=e.worldSize,p=1/f,m=e.aspect,_=Math.sqrt(1+m*m)*Math.tan(.5*e.fovX),y=_*_,v=r-n,b=r+n;let E,D;y>v/b?(E=r,D=r*_):(E=.5*b*(1+y),D=.5*Math.sqrt(v*v+2*(r*r+n*n)*y+b*b*y*y));const T=e.projection.pixelsPerMeter(e.center.lat,f),C=e._camera.getCameraToWorldMercator(),I=[0,0,-E*p];H.transformMat4(I,I,C);let A=D*p;const M=e._edgeInsets;if(!(0===M.left&&0===M.top&&0===M.right&&0===M.bottom||M.left===M.right&&M.top===M.bottom)){const ot=e._camera.getWorldToCamera(e.worldSize,"meters"===e.projection.zAxisUnit?T:1),lt=e._camera.getCameraToClipPerspective(e._fov,e.width/e.height,n,r);lt[8]=2*-e.centerOffset.x/e.width,lt[9]=2*e.centerOffset.y/e.height;const ht=new Float64Array(16);et.mul(ht,lt,ot);const ft=new Float64Array(16);et.invert(ft,ht);const at=is.fromInvProjectionMatrix(ft,f,c,!0);for(const ut of at.points){const Et=((R=ut)[0]/=h,R[1]/=h,R[2]=gn(R[2],e._center.lat),R);A=Math.max(A,H.len(H.subtract([],I,Et)))}}var R;A*=s/(s-1);const L=Math.acos(t[2]),O=Math.atan2(-t[0],-t[1]),z=new e0;z.position=I,z.setPitchBearing(L,O);const N=z.getWorldToCamera(f,T),V=A*f,B=Math.min(e._mercatorZfromZoom(17)*f*-2,-2*V),$=z.getCameraToClipOrthographic(-V,V,-V,V,B,(V+l*T)/t[2]),j=new Float64Array(16);et.multiply(j,$,N);const Z=H.fromValues(Math.floor(1e6*I[0])/1e6*f,Math.floor(1e6*I[1])/1e6*f,0),K=.5*s,Q=[0,0,0];H.transformMat4(Q,Z,j),H.scale(Q,Q,K);const W=[Math.floor(Q[0]),Math.floor(Q[1]),Math.floor(Q[2])],X=[0,0,0];H.sub(X,Q,W),H.scale(X,X,-1/K);const nt=new Float64Array(16);return et.identity(nt),et.translate(nt,nt,X),et.multiply(j,nt,j),[j,V]}class bT extends xn{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.numModelsLoading={}}loadModel(t,n){return RE(this.requestManager.transformRequest(n,dt.Model).url).then(r=>{if(!r)return;const s=Yd(r),l=new Uw(t,void 0,void 0,s);return l.computeBoundsAndApplyParent(),l}).catch(r=>{this.fire(new he(new Error(`Could not load model ${t} from ${n}: ${r.message}`)))})}load(t,n){this.models[n]||(this.models[n]={});const r=Object.keys(t);this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+r.length;const s=[];for(const l of r)s.push(this.loadModel(l,t[l]));Promise.allSettled(s).then(l=>{for(let c=0;c<l.length;c++){const{status:h,value:f}=l[c];"fulfilled"===h&&f&&(this.models[n][r[c]]=f)}this.numModelsLoading[n]-=r.length,this.fire(new xt("data",{dataType:"style"}))}).catch(l=>{this.fire(new he(new Error(`Could not load models: ${l.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n){return!!this.getModel(t,n)}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]}addModel(t,n,r){this.models[r]||(this.models[r]={}),this.hasModel(t,r)&&this.removeModel(t,r),this.load({[t]:this.requestManager.normalizeModelURL(n)},r)}addModels(t,n){const r={};for(const s in t)r[s]=this.requestManager.normalizeModelURL(t[s]);this.load(r,n)}removeModel(t,n){this.models[n]||(this.models[n]={});const r=this.models[n][t];delete this.models[n][t],r.destroy()}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const r in this.models[n])this.models[n][r].upload(t.context)}}const Va=(e,t)=>Jf(e,t&&t.filter(n=>"source.canvas"!==n.identifier)),AM=Ci(en,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","setImportUrl","setImportData","setImportConfig"]),PM=Ci(en,["setCenter","setZoom","setBearing","setPitch"]),RM={version:8,layers:[],sources:{}},LM={duration:300,delay:0},kM=new Set(["fill","line","background","hillshade","raster"]);class _s extends xn{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=Vt({},LM),this._buildingIndex=new VC(this),this.crossTileSymbolIndex=new $A,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=n.styleChanges||new e1,this.dispatcher=n.dispatcher?n.dispatcher:new Am(Ac(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new SC,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new Ma(t._requestManager,n.localFontFamily?2:n.localIdeographFontFamily?1:0,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new bT(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=new Map,this._configDependentLayers=new Set,this.dispatcher.broadcast("setReferrer",vt());const r=this;this._rtlTextPluginCallback=_s.registerForPluginStateChange(s=>{r.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:s.pluginStatus,pluginURL:s.pluginURL},(l,c)=>{if(_u(l),c&&c.every(h=>h))for(const h in r._sourceCaches){const f=r._sourceCaches[h],p=f.getSource().type;"vector"!==p&&"geojson"!==p||f.reload()}})}),this.on("data",s=>{if("source"!==s.dataType||"metadata"!==s.sourceDataType)return;const l=this.getOwnSource(s.sourceId);if(l&&l.vectorLayerIds)for(const c in this._layers){const h=this._layers[c];h.source===l.id&&this._validateLayer(h)}})}loadURL(t,n={}){this.fire(new xt("dataloading",{dataType:"style"}));const r="boolean"==typeof n.validate?n.validate:!hn(t);t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const s=this.importsCache.get(t);if(s)return this._load(s,r);const l=this.map._requestManager.transformRequest(t,dt.Style);this._request=Dt(l,(c,h)=>{if(this._request=null,c)this.fire(new he(c));else if(h)return this.importsCache.set(t,h),this._load(h,r)})}loadJSON(t,n={}){this.fire(new xt("dataloading",{dataType:"style"})),this._request=me.frame(()=>{this._request=null,this._load(t,!1!==n.validate)})}loadEmpty(){this.fire(new xt("dataloading",{dataType:"style"})),this._load(RM,!1)}_loadImports(t,n){if(this.importDepth>=4)return Y("Style doesn't support nesting deeper than 5"),this._reloadImports();const r=[];for(const s of t){const l=this._createFragmentStyle(s),c=new Promise(f=>l.on("style.import.load",f));if(r.push(c),this.resolvedImports.has(s.url)){l.loadEmpty();continue}const h=s.data||this.importsCache.get(s.url);h?l.loadJSON(h,{validate:n}):s.url?l.loadURL(s.url,{validate:n}):l.loadEmpty(),this.fragments.push({style:l,id:s.id,config:s.config})}Promise.all(r).then(()=>this._reloadImports())}_createFragmentStyle(t){const n=this.scope?Wn(t.id,this.scope):t.id,r=new _s(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager});return r.setEventedParent(this.map,{style:r}),r.setConfig(t.config),r}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const t=this.isRootStyle();this._shouldPrecompile=t,this.fire(new xt("data",{dataType:"style"})),this.fire(new xt(t?"style.load":"style.import.load"))}_load(t,n){const r=t.schema;if(this.isRootStyle()&&(t.fragment||r&&!1!==t.fragment)){const c=Vt({},RM,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(c,n)}if(this.updateSchema(r),n&&Va(this,cl(t)))return;this._loaded=!0,this.stylesheet=U(t);for(const c in t.sources)this.addSource(c,t.sources[c],{validate:!1});this._changes.changed=!1,t.sprite?this._loadSprite(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(t.glyphs,this.scope);const s=UC(this.stylesheet.layers);if(this._order=s.map(c=>c.id),this.stylesheet.light&&Y("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const c=this.stylesheet.lights[0];this.light=new yE(c.properties,c.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new yE(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const c of s){const h=Hd(c,this.options);h.setScope(this.scope),h.isConfigDependent&&this._configDependentLayers.add(h.fqid),h.setEventedParent(this,{layer:{id:h.id}}),this._layers[h.id]=h,this._layers[h.id]=h,this._serializedLayers[h.id]=h.serialize();const f=this.getOwnLayerSourceCache(h),p=!!this.directionalLight&&this.directionalLight.shadowsEnabled();f&&h.canCastShadows()&&p&&(f.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const l=this.stylesheet.terrain;if(l&&!this.terrainSetForDrapingOnly()&&this._createTerrain(l,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.mergeAll(),this._updateMapProjection(),this.map._triggerCameraUpdate(this.camera),this.fire(new xt("data",{dataType:"style"})),t.imports)this._loadImports(t.imports,n);else{this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const c=this.isRootStyle();this._shouldPrecompile=c,this.fire(new xt(c?"style.load":"style.import.load"))}}isRootStyle(){return 0===this.importDepth}mergeAll(){let t,n,r,s,l,c,h,f;this.forEachFragmentStyle(p=>{if(p.stylesheet){if(null!=p.light&&(t=p.light),p.stylesheet.lights)for(const m of p.stylesheet.lights)"ambient"===m.type&&null!=p.ambientLight&&(n=p.ambientLight),"directional"===m.type&&null!=p.directionalLight&&(r=p.directionalLight);(p.stylesheet.terrain||p.stylesheet.projection&&"globe"===p.stylesheet.projection.name)&&null!=p.terrain&&(!s||s&&0===s.drapeRenderMode||1===p.terrain.drapeRenderMode)&&(s=p.terrain),p.stylesheet.fog&&null!=p.fog&&(l=p.fog),null!=p.stylesheet.camera&&(f=p.stylesheet.camera),null!=p.stylesheet.projection&&(c=p.stylesheet.projection),null!=p.stylesheet.transition&&(h=p.stylesheet.transition)}}),this.light=t,this.ambientLight=n,this.directionalLight=r,this.terrain=s,this.fog=l,this.camera=f||{"camera-projection":"perspective"},this.projection=c||{name:"mercator"},this.transition=Vt({},LM,h),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const n=r=>{for(const s of r.fragments)n(s.style);t(r)};n(this)}mergeTerrain(){let t;this.forEachFragmentStyle(n=>{null!=n.terrain&&(!t||t&&0===t.drapeRenderMode||1===n.terrain.drapeRenderMode)&&(t=n.terrain)}),this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(n=>{null!=n.stylesheet.projection&&(t=n.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},r={};this.forEachFragmentStyle(s=>{for(const l in s._sourceCaches){const c=Wn(l,s.scope);t[c]=s._sourceCaches[l]}for(const l in s._otherSourceCaches){const c=Wn(l,s.scope);n[c]=s._otherSourceCaches[l]}for(const l in s._symbolSourceCaches){const c=Wn(l,s.scope);r[c]=s._symbolSourceCaches[l]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=r}mergeLayers(){const t={},n=[],r={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(l=>{for(const c of l._order){const h=l._layers[c];if("slot"===h.type){const f=Yh(c);if(t[f])continue;t[f]=[]}h.slot&&t[h.slot]?t[h.slot].push(h):n.push(h)}}),this._mergedOrder=[];const s=(l=[])=>{for(const c of l)if("slot"===c.type){const h=Yh(c.id);t[h]&&s(t[h])}else{const h=Wn(c.id,c.scope);this._mergedOrder.push(h),r[h]=c,c.is3D()&&(this._has3DLayers=!0),"circle"===c.type&&(this._hasCircleLayers=!0),"symbol"===c.type&&(this._hasSymbolLayers=!0)}};s(n),this._mergedLayers=r,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Vt({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(n,r,s){let l,c,h;const f=me.devicePixelRatio>1?"@2x":"";let p=Dt(r.transformRequest(r.normalizeSpriteURL(n,f,".json"),dt.SpriteJSON),(y,v)=>{p=null,h||(h=y,l=v,_())}),m=Te(r.transformRequest(r.normalizeSpriteURL(n,f,".png"),dt.SpriteImage),(y,v)=>{m=null,h||(h=y,c=v,_())});function _(){if(h)s(h);else if(l&&c){const y=me.getImageData(c),v={};for(const b in l){const{width:E,height:D,x:T,y:C,sdf:I,pixelRatio:A,stretchX:M,stretchY:R,content:L}=l[b],O=new rr({width:E,height:D});rr.copy(y,O,{x:T,y:C},{x:0,y:0},{width:E,height:D}),v[b]={data:O,pixelRatio:A,sdf:I,stretchX:M,stretchY:R,content:L}}s(null,v)}}return{cancel(){p&&(p.cancel(),p=null),m&&(m.cancel(),m=null)}}}(t,this.map._requestManager,(n,r)=>{if(this._spriteRequest=null,n)this.fire(new he(n));else if(r)for(const s in r)this.imageManager.addImage(s,this.scope,r[s]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new xt("data",{dataType:"style"}))})}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const r=t.sourceLayer;r&&("geojson"===n.type||n.vectorLayerIds&&-1===n.vectorLayerIds.indexOf(r))&&this.fire(new he(new Error(`Source layer "${r}" does not exist on source "${n.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.updatedSourceCaches).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded())return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,n)=>{const r=this.fragments[n];return r&&r.style&&(t.data=r.style.serialize()),t})}_serializeSources(){const t={};for(const n in this._sourceCaches){const r=this._sourceCaches[n].getSource();t[r.id]||(t[r.id]=r.serialize())}return t}_serializeLayers(t){const n=[];for(const r of t){const s=this._layers[r];s&&"custom"!==s.type&&n.push(s.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&("function"==typeof t.isLayerDraped?t.isLayerDraped(this.getLayerSourceCache(t)):kM.has(t.type))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new he(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new he(new Error(`The source '${t}' does not exist in the map's style.`)))}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n));const r=this._changes.changed;if(this._changes.changed){const l=this._changes.getLayerUpdatesByScope();for(const c in l){const{updatedIds:h,removedIds:f}=l[c];(h||f)&&this._updateWorkerLayers(c,h,f)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this._changes.reset()}const s={};for(const l in this._mergedSourceCaches){const c=this._mergedSourceCaches[l];s[l]=c.used,c.used=!1}for(const l of this._mergedOrder){const c=this._mergedLayers[l];if(c.recalculate(t,this._availableImages),!c.isHidden(t.zoom)){const h=this.getOwnLayerSourceCache(c);h&&(h.used=!0)}if(!this._precompileDone&&this._shouldPrecompile)for(let h=c.minzoom||0;h<(c.maxzoom||25.5);h++){const f=this.map.painter;if(f){const p=c.getProgramIds();if(!p)continue;for(const m of p){const _=c.getDefaultProgramParams(m,t.zoom);_&&(f.style=this,this.fog&&(f._fogVisible=!0,_.overrideFog=!0,f.getOrCreateProgram(m,_)),f._fogVisible=!1,_.overrideFog=!1,f.getOrCreateProgram(m,_),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(_.overrideRtt=!0,f.getOrCreateProgram(m,_)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const l in s){const c=this._mergedSourceCaches[l];s[l]!==c.used&&c.getSource().fire(new xt("data",{sourceDataType:"visibility",dataType:"source",sourceId:c.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),r&&this.fire(new xt("data",{dataType:"style"}));for(const{style:l}of this.fragments)l.update(t)}_updateTilesForChangedImages(){const t=Array.from(this._changes.changedImages.keys());if(t.length){for(const n in this._sourceCaches)this._sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t);this._changes.changedImages.clear()}}_updateWorkerLayers(t,n,r){const s=this.getFragmentStyle(t);this.dispatcher.broadcast("updateLayers",{layers:n?s._serializeLayers(n):[],scope:t,removedIds:r||[],options:s.options})}setState(t){if(this._checkLoaded(),Va(this,cl(t)))return!1;(t=U(t)).layers=UC(t.layers);const n=function(s,l){if(!s)return[{command:en.setStyle,args:[l]}];let c=[];try{if(!Ke(s.version,l.version))return[{command:en.setStyle,args:[l]}];Ke(s.center,l.center)||c.push({command:en.setCenter,args:[l.center]}),Ke(s.zoom,l.zoom)||c.push({command:en.setZoom,args:[l.zoom]}),Ke(s.bearing,l.bearing)||c.push({command:en.setBearing,args:[l.bearing]}),Ke(s.pitch,l.pitch)||c.push({command:en.setPitch,args:[l.pitch]}),Ke(s.sprite,l.sprite)||c.push({command:en.setSprite,args:[l.sprite]}),Ke(s.glyphs,l.glyphs)||c.push({command:en.setGlyphs,args:[l.glyphs]}),Ke(s.transition,l.transition)||c.push({command:en.setTransition,args:[l.transition]}),Ke(s.light,l.light)||c.push({command:en.setLight,args:[l.light]}),Ke(s.fog,l.fog)||c.push({command:en.setFog,args:[l.fog]}),Ke(s.projection,l.projection)||c.push({command:en.setProjection,args:[l.projection]}),Ke(s.lights,l.lights)||c.push({command:en.setLights,args:[l.lights]}),Ke(s.camera,l.camera)||c.push({command:en.setCamera,args:[l.camera]});const h={},f=[];!function(_,y,v,b){let E;for(E in y=y||{},_=_||{})_.hasOwnProperty(E)&&(y.hasOwnProperty(E)||sh(E,v,b));for(E in y){if(!y.hasOwnProperty(E))continue;const D=y[E];_.hasOwnProperty(E)?Ke(_[E],D)||("geojson"===_[E].type&&"geojson"===D.type&&$0(_,y,E)?v.push({command:en.setGeoJSONSourceData,args:[E,D.data]}):$C(E,y,v,b)):U0(E,y,v)}}(s.sources,l.sources,f,h);const p=[];s.layers&&s.layers.forEach(_=>{_.source&&h[_.source]?c.push({command:en.removeLayer,args:[_.id]}):p.push(_)});let m=s.terrain;m&&h[m.source]&&(c.push({command:en.setTerrain,args:[void 0]}),m=void 0),c=c.concat(f),Ke(m,l.terrain)||c.push({command:en.setTerrain,args:[l.terrain]}),function(_,y,v){y=y||[];const b=(_=_||[]).map(Kd),E=y.map(Kd),D=_.reduce(jm,{}),T=y.reduce(jm,{}),C=b.slice(),I=Object.create(null);let A,M,R,L,O,z,N;for(A=0,M=0;A<b.length;A++)R=b[A],T.hasOwnProperty(R)?M++:(v.push({command:en.removeLayer,args:[R]}),C.splice(C.indexOf(R,M),1));for(A=0,M=0;A<E.length;A++)R=E[E.length-1-A],C[C.length-1-A]!==R&&(D.hasOwnProperty(R)?(v.push({command:en.removeLayer,args:[R]}),C.splice(C.lastIndexOf(R,C.length-M),1)):M++,z=C[C.length-A],v.push({command:en.addLayer,args:[T[R],z]}),C.splice(C.length-A,0,R),I[R]=!0);for(A=0;A<E.length;A++)if(R=E[A],L=D[R],O=T[R],!I[R]&&!Ke(L,O))if(Ke(L.source,O.source)&&Ke(L["source-layer"],O["source-layer"])&&Ke(L.type,O.type)){for(N in Bm(L.layout,O.layout,v,R,null,en.setLayoutProperty),Bm(L.paint,O.paint,v,R,null,en.setPaintProperty),Ke(L.slot,O.slot)||v.push({command:en.setSlot,args:[R,O.slot]}),Ke(L.filter,O.filter)||v.push({command:en.setFilter,args:[R,O.filter]}),Ke(L.minzoom,O.minzoom)&&Ke(L.maxzoom,O.maxzoom)||v.push({command:en.setLayerZoomRange,args:[R,O.minzoom,O.maxzoom]}),L)L.hasOwnProperty(N)&&"layout"!==N&&"paint"!==N&&"filter"!==N&&"metadata"!==N&&"minzoom"!==N&&"maxzoom"!==N&&"slot"!==N&&(0===N.indexOf("paint.")?Bm(L[N],O[N],v,R,N.slice(6),en.setPaintProperty):Ke(L[N],O[N])||v.push({command:en.setLayerProperty,args:[R,N,O[N]]}));for(N in O)O.hasOwnProperty(N)&&!L.hasOwnProperty(N)&&"layout"!==N&&"paint"!==N&&"filter"!==N&&"metadata"!==N&&"minzoom"!==N&&"maxzoom"!==N&&"slot"!==N&&(0===N.indexOf("paint.")?Bm(L[N],O[N],v,R,N.slice(6),en.setPaintProperty):Ke(L[N],O[N])||v.push({command:en.setLayerProperty,args:[R,N,O[N]]}))}else v.push({command:en.removeLayer,args:[R]}),z=C[C.lastIndexOf(R)+1],v.push({command:en.addLayer,args:[O,z]})}(p,l.layers,c),function(_=[],y=[],v){y=y||[];const b=(_=_||[]).map(Kd),E=y.map(Kd),D=_.reduce(jm,{}),T=y.reduce(jm,{}),C=b.slice();let I,A,M,R;for(I=0,A=0;I<b.length;I++)M=b[I],T.hasOwnProperty(M)?A++:(v.push({command:en.removeImport,args:[M]}),C.splice(C.indexOf(M,A),1));for(I=0,A=0;I<E.length;I++)M=E[E.length-1-I],C[C.length-1-I]!==M&&(D.hasOwnProperty(M)?(v.push({command:en.removeImport,args:[M]}),C.splice(C.lastIndexOf(M,C.length-A),1)):A++,R=C[C.length-I],v.push({command:en.addImport,args:[T[M],R]}),C.splice(C.length-I,0,M));for(const L of y){const O=D[L.id];if(!O||Ke(O,L))continue;Ke(O.config,L.config)||v.push({command:en.setImportConfig,args:[L.id,L.config]}),Ke(O.url,L.url)||v.push({command:en.setImportUrl,args:[L.id,L.url]});const z=L.data;Ke(O&&O.data,z)||v.push({command:en.setImportData,args:[L.id,z]})}}(s.imports,l.imports,c)}catch(h){console.warn("Unable to compute style diff:",h),c=[{command:en.setStyle,args:[l]}]}return c}(this.serialize(),t).filter(s=>!(s.command in PM));if(0===n.length)return!1;const r=n.filter(s=>!(s.command in AM));if(r.length>0)throw new Error(`Unimplemented: ${r.map(s=>s.command).join(", ")}.`);return n.forEach(s=>{this[s.command].apply(this,s.args)}),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(t,n){return this.getImage(t)?this.fire(new he(new Error("An image with this name already exists."))):(this.imageManager.addImage(t,this.scope,n),this._afterImageUpdated(t),this)}updateImage(t,n){this.imageManager.updateImage(t,this.scope,n)}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._afterImageUpdated(t),this):this.fire(new he(new Error("No image with this name exists.")))}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(this.scope),this._changes.changedImages.add(t),this._changes.changed=!0,this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new xt("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(t,n,r={}){return this._checkLoaded(),this._validate(Kf,`models.${t}`,n,null,r)||(this.modelManager.addModel(t,n,this.scope),this._changes.changed=!0),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this):this.fire(new he(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,n,r={}){if(this._checkLoaded(),void 0!==this.getOwnSource(t))throw new Error(`There is already a source with ID "${t}".`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(Xg,`sources.${t}`,n,null,r))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const s=V0(t,n,this.dispatcher,this);s.scope=this.scope,s.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(s.id),source:s.serialize(),sourceId:s.id}));const l=c=>{const h=(c?"symbol:":"other:")+s.id,f=Wn(h,this.scope),p=this._sourceCaches[h]=new Bo(f,s,c);(c?this._symbolSourceCaches:this._otherSourceCaches)[s.id]=p,p.onAdd(this.map)};l(!1),"vector"!==n.type&&"geojson"!==n.type||l(!0),s.onAdd&&s.onAdd(this.map),this.mergeSources(),this._changes.changed=!0}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const s in this._layers)if(this._layers[s].source===t)return this.fire(new he(new Error(`Source "${t}" cannot be removed while layer "${s}" is using it.`)));if(this.terrain&&this.terrain.get().source===t)return this.fire(new he(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const r=this.getOwnSourceCaches(t);for(const s of r){const l=Yh(s.id);delete this._sourceCaches[l],delete this._changes.updatedSourceCaches[s.id],s.fire(new xt("data",{sourceDataType:"metadata",dataType:"source",sourceId:s.getSource().id})),s.setEventedParent(null),s.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.changed=!0,this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.changed=!0}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const r=this.getOwnSourceCache(n);r&&t.push(r.getSource())}return t}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const s of t){if(this._validate(Xf,"lights",s))return;switch(s.type){case"ambient":if(this.ambientLight){const l=this.ambientLight;l.set(s),l.updateTransitions(n)}else this.ambientLight=new TE(s,LC,this.scope,this.options);break;case"directional":if(this.directionalLight){const l=this.directionalLight;l.set(s),l.updateTransitions(n)}else this.directionalLight=new TE(s,kC,this.scope,this.options)}}const r=new Gn(this.z||0,n);this.ambientLight&&this.ambientLight.recalculate(r),this.directionalLight&&this.directionalLight.recalculate(r),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const r=_=>.2126*(_[0]<=.03928?_[0]/12.92:Math.pow((_[0]+.055)/1.055,2.4))+.7152*(_[1]<=.03928?_[1]/12.92:Math.pow((_[1]+.055)/1.055,2.4))+.0722*(_[2]<=.03928?_[2]/12.92:Math.pow((_[2]+.055)/1.055,2.4)),s=t.properties.get("color").toArray01(),l=t.properties.get("intensity"),c=t.properties.get("direction"),h=1-Wt(c.x,c.y,c.z)[2]/90,f=r(s)*l*h,p=n.properties.get("color").toArray01(),m=n.properties.get("intensity");return(f+r(p)*m)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(!t)return this;const n=this.fragments.find(({id:r})=>r===t);if(!n)throw new Error(`Style import not found: ${t}`);return n.style}setConfigProperty(t,n,r){const s=al(r);if("success"!==s.result)return void Va(this,s.value);const l=s.value.expression,c=this.getFragmentStyle(t);c.options.set(n,l),c.updateConfigDependencies()}setConfig(t,n){if(this.options.clear(),t){for(const r in t){const s=al(t[r]);"success"===s.result&&this.options.set(r,s.value.expression)}this.updateSchema(n)}}updateSchema(t){if(t)for(const n in t){if(this.options.has(n))continue;const r=al(t[n].default);"success"===r.result&&this.options.set(n,r.value.expression)}}updateConfigDependencies(){for(const t of this._configDependentLayers){const n=this.getLayer(t);n&&(n.possiblyEvaluateVisibility(),this._updateLayer(n))}this.ambientLight&&this.ambientLight.scope===this.scope&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.scope===this.scope&&this.directionalLight.updateConfig(this.options),this._changes.changed=!0}addLayer(t,n,r={}){this._checkLoaded();const s=t.id;if(this._layers[s])return void this.fire(new he(new Error(`Layer with id "${s}" already exists on this map`)));let l;if("custom"===t.type){if(Va(this,function(m){const _=[],y=m.id;return void 0===y&&_.push({message:`layers.${y}: missing required property "id"`}),void 0===m.render&&_.push({message:`layers.${y}: missing required method "render"`}),m.renderingMode&&"2d"!==m.renderingMode&&"3d"!==m.renderingMode&&_.push({message:`layers.${y}: property "renderingMode" must be either "2d" or "3d"`}),_}(t)))return;l=Hd(t,this.options)}else{if("object"==typeof t.source&&(this.addSource(s,t.source),t=Vt(t=U(t),{source:s})),this._validate($x,`layers.${s}`,t,{arrayIndex:-1},r))return;l=Hd(t,this.options),this._validateLayer(l),l.setEventedParent(this,{layer:{id:s}}),this._serializedLayers[l.id]=l.serialize()}l.isConfigDependent&&this._configDependentLayers.add(l.fqid),l.setScope(this.scope);const c=n?this._order.indexOf(n):this._order.length;if(n&&-1===c)return void this.fire(new he(new Error(`Layer with id "${n}" does not exist on this map.`)));this._order.splice(c,0,s),this._layerOrderChanged=!0,this._layers[s]=l;const h=this.getOwnLayerSourceCache(l),f=!!this.directionalLight&&this.directionalLight.shadowsEnabled();h&&l.canCastShadows()&&f&&(h.castsShadows=!0);const p=this._changes.getRemovedLayer(l);if(p&&l.source&&h&&"custom"!==l.type){this._changes.discardLayerRemoval(l);const m=Wn(l.source,l.scope);p.type!==l.type?this._changes.updatedSourceCaches[m]="clear":(this._changes.updatedSourceCaches[m]="reload",h.pause())}this._updateLayer(l),l.onAdd&&l.onAdd(this.map),l.scope=this.scope,this.mergeLayers()}moveLayer(t,n){if(this._checkLoaded(),this._changes.changed=!0,!this._checkLayer(t)||t===n)return;const r=this._order.indexOf(t);this._order.splice(r,1);const s=n?this._order.indexOf(n):this._order.length;n&&-1===s?this.fire(new he(new Error(`Layer with id "${n}" does not exist on this map.`))):(this._order.splice(s,0,t),this._layerOrderChanged=!0,this.mergeLayers())}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const r=this._order.indexOf(t);this._order.splice(r,1),delete this._layers[t],delete this._serializedLayers[t],this._changes.changed=!0,this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const s=this.getOwnLayerSourceCache(n);if(s&&s.castsShadows){let l=!1;for(const c in this._layers)if(this._layers[c].source===n.source&&this._layers[c].canCastShadows()){l=!0;break}s.castsShadows=l}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,r){this._checkLoaded();const s=this._checkLayer(t);s&&(s.minzoom===n&&s.maxzoom===r||(null!=n&&(s.minzoom=n),null!=r&&(s.maxzoom=r),this._updateLayer(s)))}setSlot(t,n){this._checkLoaded();const r=this._checkLayer(t);r&&r.slot!==n&&(r.slot=n,this._updateLayer(r))}setFilter(t,n,r={}){this._checkLoaded();const s=this._checkLayer(t);if(s&&!Ke(s.filter,n))return null==n?(s.filter=void 0,void this._updateLayer(s)):void(this._validate(Yf,`layers.${s.id}.filter`,n,{layerType:s.type},r)||(s.filter=U(n),this._updateLayer(s)))}getFilter(t){const n=this._checkLayer(t);if(n)return U(n.filter)}setLayoutProperty(t,n,r,s={}){this._checkLoaded();const l=this._checkLayer(t);l&&(Ke(l.getLayoutProperty(n),r)||(l.setLayoutProperty(n,r,s),l.isConfigDependent&&this._configDependentLayers.add(l.fqid),this._updateLayer(l)))}getLayoutProperty(t,n){const r=this._checkLayer(t);if(r)return r.getLayoutProperty(n)}setPaintProperty(t,n,r,s={}){this._checkLoaded();const l=this._checkLayer(t);if(!l||Ke(l.getPaintProperty(n),r))return;const c=l.setPaintProperty(n,r,s);l.isConfigDependent&&this._configDependentLayers.add(l.fqid),c&&this._updateLayer(l),this._changes.changed=!0,this._changes.updatedPaintProps.add(l.fqid)}getPaintProperty(t,n){const r=this._checkLayer(t);if(r)return r.getPaintProperty(n)}setFeatureState(t,n){this._checkLoaded();const r=t.source,s=t.sourceLayer,l=this._checkSource(r);if(!l)return;const c=l.type;if("geojson"===c&&s)return void this.fire(new he(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===c&&!s)return void this.fire(new he(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===t.id&&this.fire(new he(new Error("The feature id parameter must be provided.")));const h=this.getOwnSourceCaches(r);for(const f of h)f.setFeatureState(s,t.id,n)}removeFeatureState(t,n){this._checkLoaded();const r=t.source,s=this._checkSource(r);if(!s)return;const l=s.type,c="vector"===l?t.sourceLayer:void 0;if("vector"===l&&!c)return void this.fire(new he(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&"string"!=typeof t.id&&"number"!=typeof t.id)return void this.fire(new he(new Error("A feature id is required to remove its specific state property.")));const h=this.getOwnSourceCaches(r);for(const f of h)f.removeFeatureState(c,t.id,n)}getFeatureState(t){this._checkLoaded();const n=t.source,r=t.sourceLayer,s=this._checkSource(n);if(s){if("vector"!==s.type||r)return void 0===t.id&&this.fire(new he(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(r,t.id);this.fire(new he(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Vt({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Vt({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:void 0;return Tt({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},r=>void 0!==r)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),r=Wn(t.source,t.scope);t.source&&!this._changes.updatedSourceCaches[r]&&n&&"raster"!==n.getSource().type&&(this._changes.updatedSourceCaches[r]="reload",n.pause()),this._changes.changed=!0,t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=h=>"fill-extrusion"===this._mergedLayers[h].type,r=this.order,s={},l=[];for(let h=r.length-1;h>=0;h--){const f=r[h];if(n(f)){s[f]=h;for(const p of t){const m=p[f];if(m)for(const _ of m)l.push(_)}}}l.sort((h,f)=>f.intersectionZ-h.intersectionZ);const c=[];for(let h=r.length-1;h>=0;h--){const f=r[h];if(n(f))for(let p=l.length-1;p>=0;p--){const m=l[p].feature;if(s[m.layer.id]<h)break;c.push(m),l.pop()}else for(const p of t){const m=p[f];if(m)for(const _ of m)c.push(_.feature)}}return c}queryRenderedFeatures(t,n,r){n&&n.filter&&this._validate(Yf,"queryRenderedFeatures.filter",n.filter,null,n),n.scope=this.scope,n.availableImages=this._availableImages,n.serializedLayers=this._serializedLayers;const s={};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new he(new Error("parameters.layers must be an Array."))),[];for(const p of n.layers){const m=this._mergedLayers[p];if(!m)return this.fire(new he(new Error(`The layer '${p}' does not exist in the map's style and cannot be queried for features.`))),[];s[m.source]=!0}}const l=[],c=n.serializedLayers||{},h=n&&n.layers?n.layers.some(p=>{const m=this.getLayer(p);return m&&m.is3D()}):this.has3DLayers(),f=M0.createFromScreenPoints(t,r);for(const p in this._mergedSourceCaches){const m=this._mergedSourceCaches[p].getSource();if(!m||m.scope!==n.scope)continue;const _=this._mergedSourceCaches[p].getSource().id;n.layers&&!s[_]||l.push(jC(this._mergedSourceCaches[p],this._mergedLayers,c,f,n,r,h,!!this.map._showQueryGeometry))}return this.placement&&l.push(function(p,m,_,y,v,b,E){const D={},T=b.queryRenderedSymbols(y),C=[];for(const I of Object.keys(T).map(Number))C.push(E[I]);C.sort(Rc);for(const I of C){const A=I.featureIndex.lookupSymbolFeatures(T[I.bucketInstanceId],m,I.bucketIndex,I.sourceLayerIndex,v.filter,v.layers,v.availableImages,p);for(const M in A){const R=D[M]=D[M]||[],L=A[M];L.sort((O,z)=>{const N=I.featureSortOrder;if(N){const V=N.indexOf(O.featureIndex);return N.indexOf(z.featureIndex)-V}return z.featureIndex-O.featureIndex});for(const O of L)R.push(O)}}for(const I in D)D[I].forEach(A=>{const M=A.feature,R=_(p[I]);if(!R)return;const L=R.getFeatureState(M.layer["source-layer"],M.id);M.source=M.layer.source,M.layer["source-layer"]&&(M.sourceLayer=M.layer["source-layer"]),M.state=L});return D}(this._mergedLayers,c,this.getLayerSourceCache.bind(this),f.screenGeometry,n,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(l)}querySourceFeatures(t,n){n&&n.filter&&this._validate(Yf,"querySourceFeatures.filter",n.filter,null,n);const r=this.getOwnSourceCaches(t);let s=[];for(const l of r)s=s.concat($i(l,n));return s}addSourceType(t,n,r){return _s.getSourceType(t)?r(new Error(`A source type called "${t}" already exists.`)):(_s.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},r):r(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,r={}){this._checkLoaded();const s=this.light.getLight();let l=!1;for(const h in t)if(!Ke(t[h],s[h])){l=!0;break}if(!l)return;const c=this._getTransitionParameters();this.light.setLight(t,n,r),this.light.updateTransitions(c)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(t,n=1){if(this._checkLoaded(),!t)return delete this.terrain,delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let r=t;if(1===n){if("object"==typeof r.source){const s="terrain-dem-src";this.addSource(s,r.source),r=U(r),r=Vt(r,{source:s})}if(this._validate(OD,"terrain",r))return}if(!this.terrain||this.terrain&&n!==this.terrain.drapeRenderMode){if(!r)return;this._createTerrain(r,n),this.fire(new xt("data",{dataType:"style"}))}else{const s=this.terrain,l=s.get();for(const c of Object.keys(rt.terrain))!r.hasOwnProperty(c)&&rt.terrain[c].default&&(r[c]=rt.terrain[c].default);for(const c in t)if(!Ke(t[c],l[c])){s.set(t),this.stylesheet.terrain=t;const h=this._getTransitionParameters({duration:0});s.updateTransitions(h),this.fire(new xt("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new AC(t,this.map.transform);this.stylesheet.fog=n.get();const r=this._getTransitionParameters({duration:0});n.updateTransitions(r)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!Ke(n.get(),t)){n.set(t),this.stylesheet.fog=n.get();const r=this._getTransitionParameters({duration:0});n.updateTransitions(r)}}else this._createFog(t);this._markersNeedUpdate=!0}_getTransitionParameters(t){return{now:me.now(),transition:Vt(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const r in this._mergedLayers)this.isLayerDraped(this._mergedLayers[r])?t.push(r):n.push(r);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const r=this.terrain=new FA(t,n);r.setScope(this.scope),this.stylesheet.terrain=t,this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const s=this._getTransitionParameters({duration:0});r.updateTransitions(s)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];"fill-extrusion"===n.type&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];"symbol"===n.type&&this._updateLayer(n)}}_validate(t,n,r,s,l={}){if(l&&!1===l.validate)return!1;const c=Vt({},this.serialize());return Va(this,t.call(cl,Vt({key:n,style:c,value:r,styleSpec:rt},s)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),t1.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const r of n)r.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const n=this.getSourceCaches(t);for(const r of n)r.resume(),r.reload()}updateSources(t){let n;this.directionalLight&&(n=pv(this.directionalLight));for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].update(t,void 0,void 0,n)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,r,s,l=!1){let c=!1,h=!1;const f={},p={};for(const m of this._mergedOrder){const _=this._mergedLayers[m];if("symbol"!==_.type)continue;const y=Wn(_.source,_.scope);let v=f[y];if(!v){const E=this.getLayerSourceCache(_);if(!E)continue;const D=E.getRenderableIds(!0).map(T=>E.getTileByID(T));p[y]=D.slice(),v=f[y]=D.sort((T,C)=>C.tileID.overscaledZ-T.tileID.overscaledZ||(T.tileID.isLessThan(C.tileID)?-1:1))}const b=this.crossTileSymbolIndex.addLayer(_,v,t.center.lng,t.projection);c=c||b}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),l=l||this._layerOrderChanged||0===r,this._layerOrderChanged&&this.fire(new xt("neworder")),(l||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(me.now(),t.zoom))&&(this.pauseablePlacement=new JC(t,this._mergedOrder,l,n,r,s,this.placement,this.fog&&t.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,f,p),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(me.now()),h=!0),c&&this.pauseablePlacement.placement.setStale()),h||c)for(const m of this._mergedOrder){const _=this._mergedLayers[m];"symbol"===_.type&&this.placement.updateLayerOpacities(_,f[Wn(_.source,_.scope)])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(me.now())}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t){this._checkLoaded();const n=this.stylesheet.imports=this.stylesheet.imports||[];return-1!==n.findIndex(({id:s})=>s===t.id)?this.fire(new he(new Error(`Import with id '${t.id}' already exists in the map's style.`))):(n.push(t),this._loadImports([t],!0),this)}setImportUrl(t,n){this._checkLoaded();const r=this.stylesheet.imports||[],s=this.getImportIndex(t);if(-1===s)return this;r[s].url=n;const l=this.fragments[s];l.style=this._createFragmentStyle({id:t,url:n});const c=new Promise(h=>l.style.on("style.import.load",h));return l.style.loadURL(n),c.then(()=>this._reloadImports()),this}setImportData(t,n){this._checkLoaded();const r=this.getImportIndex(t),s=this.stylesheet.imports||[];return-1===r?this:n?(this.fragments[r].style.setState(n),this._reloadImports(),this):(delete s[r].data,this.setImportUrl(t,s[r].url))}setImportConfig(t,n){this._checkLoaded();const r=this.getImportIndex(t),s=this.stylesheet.imports||[];if(-1===r)return this;n?s[r].config=n:delete s[r].config;const l=this.fragments[r],c=l.style.stylesheet&&l.style.stylesheet.schema;return l.config=n,l.style.setConfig(n,c),l.style.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],r=this.getImportIndex(t);return-1===r||(n.splice(r,1),this.fragments[r].style._remove(),this.fragments.splice(r,1),this._reloadImports()),this}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex(r=>r.id===t);return-1===n&&this.fire(new he(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const r=this._mergedOtherSourceCaches[n];r&&t.push(r.getSource())}return t}getSource(t,n){const r=this.getSourceCache(t,n);return r&&r.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const r=Wn(t,n);return this._mergedOtherSourceCaches[r]}getLayerSourceCache(t){const n=Wn(t.source,t.scope);return"symbol"===t.type?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){for(const t in this._changes.updatedSourceCaches){const n=this._changes.updatedSourceCaches[t];"reload"===n?this.reloadSource(t):"clear"===n&&this.clearSource(t)}}updateLayers(t){for(const n of this._changes.updatedPaintProps){const r=this.getLayer(n);r&&r.updateTransitions(t)}}getImages(t,n,r){this.imageManager.getImages(n.icons,n.scope,r),this._updateTilesForChangedImages();const s=l=>{l&&l.setDependencies(n.tileID.key,n.type,n.icons)};s(this._otherSourceCaches[n.source]),s(this._symbolSourceCaches[n.source])}getGlyphs(t,n,r){this.glyphManager.getGlyphs(n.stacks,n.scope,r)}getResource(t,n,r){return Ct(n,r)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return"symbol"===t.type?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return 0===n.length?(this.fire(new he(new Error(`There is no source with ID '${t}'`))),!1):n.every(r=>r.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function Nc(e,t){let n=!1,r=null;const s=()=>{r=null,n&&(e(),r=setTimeout(s,t),n=!1)};return()=>(n=!0,r||s(),r)}_s.getSourceType=function(e){return Nm[e]},_s.setSourceType=function(e,t){Nm[e]=t},_s.registerForPluginStateChange=function(e){return e({pluginStatus:vo,pluginURL:rc}),t1.on("pluginStateChange",e),e};class e2{constructor(t){this._hashName=t&&encodeURIComponent(t),Rr(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Nc(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,it.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),it.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=OM(t);if(this._hashName){const r=this._hashName;let s=!1;const l=it.location.hash.slice(1).split("&").map(c=>{const h=c.split("=")[0];return h===r?(s=!0,`${h}=${n}`):c}).filter(c=>c);return s||l.push(`${r}=${n}`),`#${l.join("&")}`}return`#${n}`}_getCurrentHash(){const t=it.location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map(r=>r.split("=")).forEach(r=>{r[0]===this._hashName&&(n=r)}),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some(r=>isNaN(r))){const r=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:r,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){const t=it.location.href.replace(/(#.+)?$/,this.getHashString());it.history.replaceState(it.history.state,null,t)}}function OM(e,t){const n=e.getCenter(),r=Math.round(100*e.getZoom())/100,s=Math.ceil((r*Math.LN2+Math.log(512/360/.5))/Math.LN10),l=Math.pow(10,s),c=Math.round(n.lng*l)/l,h=Math.round(n.lat*l)/l,f=e.getBearing(),p=e.getPitch();let m=t?`/${c}/${h}/${r}`:`${r}/${h}/${c}`;return(f||p)&&(m+="/"+Math.round(10*f)/10),p&&(m+=`/${Math.round(p)}`),m}const mv={linearity:.3,easing:qa(0,0,.3,1)},n2=Vt({deceleration:2500,maxSpeed:1400},mv),r2=Vt({deceleration:20,maxSpeed:1400},mv),FM=Vt({deceleration:1e3,maxSpeed:360},mv),i2=Vt({deceleration:1e3,maxSpeed:90},mv);class o2{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:me.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=me.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new tt(0,0),pinchAround:void 0,around:void 0};for(const{settings:l}of this._inertiaBuffer)n.zoom+=l.zoomDelta||0,n.bearing+=l.bearingDelta||0,n.pitch+=l.pitchDelta||0,l.panDelta&&n.pan._add(l.panDelta),l.around&&(n.around=l.around),l.pinchAround&&(n.pinchAround=l.pinchAround);const r=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,s={};if(n.pan.mag()){const l=_v(n.pan.mag(),r,Vt({},n2,t||{}));s.offset=n.pan.mult(l.amount/n.pan.mag()),s.center=this._map.transform.center,gv(s,l)}if(n.zoom){const l=_v(n.zoom,r,r2);s.zoom=this._map.transform.zoom+l.amount,gv(s,l)}if(n.bearing){const l=_v(n.bearing,r,FM);s.bearing=this._map.transform.bearing+Gt(l.amount,-179,179),gv(s,l)}if(n.pitch){const l=_v(n.pitch,r,i2);s.pitch=this._map.transform.pitch+l.amount,gv(s,l)}if(s.zoom||s.bearing){const l=void 0===n.pinchAround?n.around:n.pinchAround;s.around=l?this._map.unproject(l):this._map.getCenter()}return this.clear(),s.noMoveStart=!0,s}}function gv(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing)}function _v(e,t,n){const{maxSpeed:r,linearity:s,deceleration:l}=n,c=Gt(e*s/(t/1e3),-r,r),h=Math.abs(c)/(l*s);return{easing:n.easing,duration:1e3*h,amount:c*(h/2)}}class Uo extends xt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,r,s={}){const l=ne(n.getCanvasContainer(),r);super(t,Vt({point:l,lngLat:n.unproject(l),originalEvent:r},s)),this._defaultPrevented=!1,this.target=n}}class yv extends xt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,r){const s="touchend"===t?r.changedTouches:r.touches,l=Gl(n.getCanvasContainer(),s),c=l.map(f=>n.unproject(f)),h=l.reduce((f,p,m,_)=>f.add(p.div(_.length)),new tt(0,0));super(t,{points:l,point:h,lngLats:c,lngLat:n.unproject(h),originalEvent:r}),this._defaultPrevented=!1}}class eg extends xt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,r){super(t,{originalEvent:r}),this._defaultPrevented=!1}}class kl{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new eg(t.type,this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new Uo(t.type,this._map,t))}mouseup(t){this._map.fire(new Uo(t.type,this._map,t))}preclick(t){const n=Vt({},t);n.type="preclick",this._map.fire(new Uo(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new Uo(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new Uo(t.type,this._map,t))}mouseover(t){this._map.fire(new Uo(t.type,this._map,t))}mouseout(t){this._map.fire(new Uo(t.type,this._map,t))}touchstart(t){return this._firePreventable(new yv(t.type,this._map,t))}touchmove(t){this._map.fire(new yv(t.type,this._map,t))}touchend(t){this._map.fire(new yv(t.type,this._map,t))}touchcancel(t){this._map.fire(new yv(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class s2{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new Uo(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Uo("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new Uo(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class zM{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&0===t.button&&(Sf(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const r=n,s=this._startPos,l=this._lastPos;if(!s||!l||l.equals(r)||!this._box&&r.dist(s)<this._clickTolerance)return;this._lastPos=r,this._box||(this._box=_e("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const c=Math.min(s.x,r.x),h=Math.max(s.x,r.x),f=Math.min(s.y,r.y),p=Math.max(s.y,r.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${c}px,${f}px)`,this._box.style.width=h-c+"px",this._box.style.height=p-f+"px")})}mouseupWindow(t,n){if(!this._active)return;const r=this._startPos,s=n;if(r&&0===t.button){if(this.reset(),nx(),r.x!==s.x||r.y!==s.y)return this._map.fire(new xt("boxzoomend",{originalEvent:t})),{cameraAnimation:l=>l.fitScreenCoordinates(r,s,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&27===t.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Ge(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new xt(t,{originalEvent:n}))}}function vv(e,t){const n={};for(let r=0;r<e.length;r++)n[e[r].identifier]=t[r];return n}class Hi{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,r){(this.centroid||r.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=t.timeStamp),r.length===this.numTouches&&(this.centroid=function(s){const l=new tt(0,0);for(const c of s)l._add(c);return l.div(s.length)}(n),this.touches=vv(r,n)))}touchmove(t,n,r){if(this.aborted||!this.centroid)return;const s=vv(r,n);for(const l in this.touches){const c=s[l];(!c||c.dist(this.touches[l])>30)&&(this.aborted=!0)}}touchend(t,n,r){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),0===r.length){const s=!this.aborted&&this.centroid;if(this.reset(),s)return s}}}class lf{constructor(t){this.singleTap=new Hi(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,r){this.singleTap.touchstart(t,n,r)}touchmove(t,n,r){this.singleTap.touchmove(t,n,r)}touchend(t,n,r){const s=this.singleTap.touchend(t,n,r);if(s){const l=t.timeStamp-this.lastTime<500,c=!this.lastTap||this.lastTap.dist(s)<30;if(l&&c||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=s,this.count===this.numTaps)return this.reset(),s}}}class NM{constructor(){this._zoomIn=new lf({numTouches:1,numTaps:2}),this._zoomOut=new lf({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,r){this._zoomIn.touchstart(t,n,r),this._zoomOut.touchstart(t,n,r)}touchmove(t,n,r){this._zoomIn.touchmove(t,n,r),this._zoomOut.touchmove(t,n,r)}touchend(t,n,r){const s=this._zoomIn.touchend(t,n,r),l=this._zoomOut.touchend(t,n,r);return s?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:c=>c.easeTo({duration:300,zoom:c.getZoom()+1,around:c.unproject(s)},{originalEvent:t})}):l?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:c=>c.easeTo({duration:300,zoom:c.getZoom()-1,around:c.unproject(l)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const BM={0:1,2:2};class ng{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const r=Je(t);this._correctButton(t,r)&&(this._lastPoint=n,this._eventButton=r)}mousemoveWindow(t,n){const r=this._lastPoint;if(r)if(t.preventDefault(),null!=this._eventButton&&function(s,l){const c=BM[l];return void 0===s.buttons||(s.buttons&c)!==c}(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(r)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(r,n)}mouseupWindow(t){this._lastPoint&&Je(t)===this._eventButton&&(this._moved&&nx(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class wT extends ng{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return 0===n&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class ET extends ng{_correctButton(t,n){return 0===n&&t.ctrlKey||2===n}_move(t,n){const r=.8*(n.x-t.x);if(r)return this._active=!0,{bearingDelta:r}}contextmenu(t){t.preventDefault()}}class rg extends ng{_correctButton(t,n){return 0===n&&t.ctrlKey||2===n}_move(t,n){const r=-.5*(n.y-t.y);if(r)return this._active=!0,{pitchDelta:r}}contextmenu(t){t.preventDefault()}}class TT{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),Rr(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new tt(0,0)}touchstart(t,n,r){return this._calculateTransform(t,n,r)}touchmove(t,n,r){if(this._active&&!(r.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===r.length&&!ae())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,r)}}touchend(t,n,r){this._calculateTransform(t,n,r),this._active&&r.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,r){r.length>0&&(this._active=!0);const s=vv(r,n),l=new tt(0,0),c=new tt(0,0);let h=0;for(const p in s){const m=s[p],_=this._touches[p];_&&(l._add(m),c._add(m.sub(_)),h++,s[p]=m)}if(this._touches=s,h<this._minTouches||!c.mag())return;const f=c.div(h);return this._sum._add(f),this._sum.mag()<this._clickTolerance?void 0:{around:l.div(h),panDelta:f}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=_e("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")},500)}}class ys{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,r){return{}}touchstart(t,n,r){this._firstTwoTouches||r.length<2||(this._firstTwoTouches=[r[0].identifier,r[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,r){const s=this._firstTwoTouches;if(!s)return;t.preventDefault();const[l,c]=s,h=Qs(r,n,l),f=Qs(r,n,c);if(!h||!f)return;const p=this._aroundCenter?null:h.add(f).div(2);return this._move([h,f],p,t)}touchend(t,n,r){if(!this._firstTwoTouches)return;const[s,l]=this._firstTwoTouches,c=Qs(r,n,s),h=Qs(r,n,l);c&&h||(this._active&&nx(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Qs(e,t,n){for(let r=0;r<e.length;r++)if(e[r].identifier===n)return t[r]}function xv(e,t){return Math.log(e/t)/Math.LN2}class DT extends ys{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const r=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(xv(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:xv(this._distance,r),pinchAround:n}}}function ST(e,t){return 180*e.angleWith(t)/Math.PI}class bv extends ys{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const r=this._vector;if(this._vector=t[0].sub(t[1]),r&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:ST(this._vector,r),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,r=this._startVector;if(!r)return!1;const s=ST(t,r);return Math.abs(s)<n}}function wv(e){return Math.abs(e.y)>Math.abs(e.x)}class jM extends ys{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,wv(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,r){const s=this._lastPoints;if(!s)return;const l=t[0].sub(s[0]),c=t[1].sub(s[1]);return this._map._cooperativeGestures&&!ae()&&r.touches.length<3||(this._valid=this.gestureBeginsVertically(l,c,r.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(l.y+c.y)/2*-.5})}gestureBeginsVertically(t,n,r){if(void 0!==this._valid)return this._valid;const s=t.mag()>=2,l=n.mag()>=2;if(!s&&!l)return;if(!s||!l)return null==this._firstMove&&(this._firstMove=r),r-this._firstMove<100&&void 0;const c=t.y>0==n.y>0;return wv(t)&&wv(n)&&c}}const CT={panStep:100,bearingStep:15,pitchStep:10};class MT{constructor(){const t=CT;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,r=0,s=0,l=0,c=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?r=-1:(t.preventDefault(),l=-1);break;case 39:t.shiftKey?r=1:(t.preventDefault(),l=1);break;case 38:t.shiftKey?s=1:(t.preventDefault(),c=-1);break;case 40:t.shiftKey?s=-1:(t.preventDefault(),c=1);break;default:return}return this._rotationDisabled&&(r=0,s=0),{cameraAnimation:h=>{const f=h.getZoom();h.easeTo({duration:300,easeId:"keyboardHandler",easing:ho,zoom:n?Math.round(f)+n*(t.shiftKey?2:1):f,bearing:h.getBearing()+r*this._bearingStep,pitch:h.getPitch()+s*this._pitchStep,offset:[-l*this._panStep,-c*this._panStep],center:h.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function ho(e){return e*(2-e)}const zr=4.000244140625;class Nr{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,Rr(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||ae()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===it.WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const r=me.now(),s=r-(this._lastWheelEventTime||0);this._lastWheelEventTime=r,0!==n&&n%zr==0?this._type="wheel":0!==n&&Math.abs(n)<4?this._type="trackpad":s>400?(this._type=null,this._lastValue=n,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(s*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=ne(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;"wheel"===this._type&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(0!==this._delta){const p="wheel"===this._type&&Math.abs(this._delta)>zr?this._wheelZoomRate:this._defaultZoomRate;let m=2/(1+Math.exp(-Math.abs(this._delta*p)));this._delta<0&&0!==m&&(m=1/m);const _=n(),y=Math.pow(2,_),v="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):y;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(v*m))),"wheel"===this._type&&(this._startZoom=_,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const r="number"==typeof this._targetZoom?this._targetZoom:n(),s=this._startZoom,l=this._easing;let c,h=!1;if("wheel"===this._type&&s&&l){const p=Math.min((me.now()-this._lastWheelEventTime)/200,1);c=de(s,r,l(p)),p<1?this._frameId||(this._frameId=!0):h=!0}else c=r,h=!0;this._active=!0,h&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let f=c-n();return f*this._lastDelta<0&&(f=0),{noInertia:!0,needsRenderFrame:!h,zoomDelta:f,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=Nn;if(this._prevEase){const r=this._prevEase,s=(me.now()-r.start)/r.duration,l=r.easing(s+.01)-r.easing(s),c=.27/Math.sqrt(l*l+1e-4)*.01;n=qa(c,Math.sqrt(.0729-c*c),.25,1)}return this._prevEase={start:me.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=_e("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(it.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")},200)}}class _n{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class vr{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:r=>{r.easeTo({duration:300,zoom:r.getZoom()+(t.shiftKey?-1:1),around:r.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class je{constructor(){this._tap=new lf({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,r){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?r.length>0&&(this._swipePoint=n[0],this._swipeTouch=r[0].identifier):this._tap.touchstart(t,n,r))}touchmove(t,n,r){if(this._tapTime){if(this._swipePoint){if(r[0].identifier!==this._swipeTouch)return;const s=n[0],l=s.y-this._swipePoint.y;return this._swipePoint=s,t.preventDefault(),this._active=!0,{zoomDelta:l/128}}}else this._tap.touchmove(t,n,r)}touchend(t,n,r){this._tapTime?this._swipePoint&&0===r.length&&this.reset():this._tap.touchend(t,n,r)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class a2{constructor(t,n,r){this._el=t,this._mousePan=n,this._touchPan=r}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class VM{constructor(t,n,r){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=r}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class UM{constructor(t,n,r,s){this._el=t,this._touchZoom=n,this._touchRotate=r,this._tapDragZoom=s,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const ig=e=>e.zoom||e.drag||e.pitch||e.rotate;class $M extends xt{}class HM{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const r=H.sub([],n,t);this.radius=H.length(r[2]<0?H.div([],r,this.constants):[r[0],r[1],0])}projectRay(t){H.div(t,t,this.constants),H.normalize(t,t),H.mul(t,t,this.constants);const n=H.scale([],t,this.radius);if(n[2]>0){const r=H.scale([],[0,0,1],H.dot(n,[0,0,1])),s=H.scale([],H.normalize([],[n[0],n[1],0]),this.radius),l=H.add([],n,H.scale([],H.sub([],H.add([],s,r),n),2));n[0]=l[0],n[1]=l[1]}return n}}function Ev(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta}class l2{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new o2(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new HM,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),Rr(["handleEvent","handleWindowEvent"],this);const r=this._el;this._listeners=[[r,"touchstart",{passive:!0}],[r,"touchmove",{passive:!1}],[r,"touchend",void 0],[r,"touchcancel",void 0],[r,"mousedown",void 0],[r,"mousemove",void 0],[r,"mouseup",void 0],[it.document,"mousemove",{capture:!0}],[it.document,"mouseup",void 0],[r,"mouseover",void 0],[r,"mouseout",void 0],[r,"dblclick",void 0],[r,"click",void 0],[r,"keydown",{capture:!1}],[r,"keyup",void 0],[r,"wheel",{passive:!1}],[r,"contextmenu",void 0],[it,"blur",void 0]];for(const[s,l,c]of this._listeners)s.addEventListener(l,s===it.document?this.handleWindowEvent:this.handleEvent,c)}destroy(){for(const[t,n,r]of this._listeners)t.removeEventListener(n,t===it.document?this.handleWindowEvent:this.handleEvent,r)}_addDefaultHandlers(t){const n=this._map,r=n.getCanvasContainer();this._add("mapEvent",new kl(n,t));const s=n.boxZoom=new zM(n,t);this._add("boxZoom",s);const l=new NM,c=new vr;n.doubleClickZoom=new _n(c,l),this._add("tapZoom",l),this._add("clickZoom",c);const h=new je;this._add("tapDragZoom",h);const f=n.touchPitch=new jM(n);this._add("touchPitch",f);const p=new ET(t),m=new rg(t);n.dragRotate=new VM(t,p,m),this._add("mouseRotate",p,["mousePitch"]),this._add("mousePitch",m,["mouseRotate"]);const _=new wT(t),y=new TT(n,t);n.dragPan=new a2(r,_,y),this._add("mousePan",_),this._add("touchPan",y,["touchZoom","touchRotate"]);const v=new bv,b=new DT;n.touchZoomRotate=new UM(r,b,v,h),this._add("touchRotate",v,["touchPan","touchZoom"]),this._add("touchZoom",b,["touchPan","touchRotate"]),this._add("blockableMapEvent",new s2(n));const E=n.scrollZoom=new Nr(n,this);this._add("scrollZoom",E,["mousePan"]);const D=n.keyboard=new MT;this._add("keyboard",D);for(const T of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[T]&&n[T].enable(t[T])}_add(t,n,r){this._handlers.push({handlerName:t,handler:n,allowed:r}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!ig(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,r){for(const s in t)if(s!==r&&(!n||n.indexOf(s)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const n=[];for(const r of t)this._el.contains(r.target)&&n.push(r);return n}handleEvent(t,n){this._updatingCamera=!0;const r="renderFrame"===t.type,s=r?void 0:t,l={needsRenderFrame:!1},c={},h={},f=t.touches?this._getMapTouches(t.touches):void 0,p=f?Gl(this._el,f):r?void 0:ne(this._el,t);for(const{handlerName:y,handler:v,allowed:b}of this._handlers){if(!v.isEnabled())continue;let E;this._blockedByActive(h,b,y)?v.reset():v[n||t.type]&&(E=v[n||t.type](t,p,f),this.mergeHandlerResult(l,c,E,y,s),E&&E.needsRenderFrame&&this._triggerRenderFrame()),(E||v.isActive())&&(h[y]=v)}const m={};for(const y in this._previousActiveHandlers)h[y]||(m[y]=s);this._previousActiveHandlers=h,(Object.keys(m).length||Ev(l))&&(this._changes.push([l,c,m]),this._triggerRenderFrame()),(Object.keys(h).length||Ev(l))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:_}=l;_&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],_(this._map))}mergeHandlerResult(t,n,r,s,l){if(!r)return;Vt(t,r);const c={handlerName:s,originalEvent:r.originalEvent||l};void 0!==r.zoomDelta&&(n.zoom=c),void 0!==r.panDelta&&(n.drag=c),void 0!==r.pitchDelta&&(n.pitch=c),void 0!==r.bearingDelta&&(n.rotate=c)}_applyChanges(){const t={},n={},r={};for(const[s,l,c]of this._changes)s.panDelta&&(t.panDelta=(t.panDelta||new tt(0,0))._add(s.panDelta)),s.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+s.zoomDelta),s.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+s.bearingDelta),s.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+s.pitchDelta),void 0!==s.around&&(t.around=s.around),void 0!==s.aroundCoord&&(t.aroundCoord=s.aroundCoord),void 0!==s.pinchAround&&(t.pinchAround=s.pinchAround),s.noInertia&&(t.noInertia=s.noInertia),Vt(n,l),Vt(r,c);this._updateMapTransform(t,n,r),this._changes=[]}_updateMapTransform(t,n,r){const s=this._map,l=s.transform,c=C=>[C.x,C.y,C.z];if((C=>{const I=this._eventsInProgress.drag;return I&&!this._handlersById[I.handlerName].isActive()})()&&!Ev(t)){const C=l.zoom;l.cameraElevationReference="sea",null!=this._originalZoom&&l._orthographicProjectionAtLowPitch&&"globe"!==l.projection.name&&0===l.pitch?(l.cameraElevationReference="ground",l.zoom=this._originalZoom):(l.recenterOnTerrain(),l.cameraElevationReference="ground"),C!==l.zoom&&this._map._update(!0)}if(l._isCameraConstrained&&s._stop(!0),!Ev(t))return void this._fireEvents(n,r,!0);let{panDelta:h,zoomDelta:f,bearingDelta:p,pitchDelta:m,around:_,aroundCoord:y,pinchAround:v}=t;l._isCameraConstrained&&(f>0&&(f=0),l._isCameraConstrained=!1),void 0!==v&&(_=v),(f||(C=>n[C]&&!this._eventsInProgress[C])("drag"))&&_&&(this._dragOrigin=c(l.pointCoordinate3D(_)),this._originalZoom=l.zoom,this._trackingEllipsoid.setup(l._camera.position,this._dragOrigin)),l.cameraElevationReference="sea",s._stop(!0),_=_||s.transform.centerPoint,p&&(l.bearing+=p),m&&(l.pitch+=m),l._updateCameraState();const b=[0,0,0];if(h)if("mercator"===l.projection.name){const C=this._trackingEllipsoid.projectRay(l.screenPointToMercatorRay(_).dir),I=this._trackingEllipsoid.projectRay(l.screenPointToMercatorRay(_.sub(h)).dir);b[0]=I[0]-C[0],b[1]=I[1]-C[1]}else{const C=l.pointCoordinate(_);if("globe"===l.projection.name){h=h.rotate(-l.angle);const I=l._pixelsPerMercatorPixel/l.worldSize;b[0]=-h.x*Y_(dr(C.y))*I,b[1]=-h.y*Y_(l.center.lat)*I}else{const I=l.pointCoordinate(_.sub(h));C&&I&&(b[0]=I.x-C.x,b[1]=I.y-C.y)}}const E=l.zoom,D=[0,0,0];if(f){const C=c(y||l.pointCoordinate3D(_)),I={dir:H.normalize([],H.sub([],C,l._camera.position))};if(I.dir[2]<0){const A=l.zoomDeltaToMovement(C,f);H.scale(D,I.dir,A)}}const T=H.add(b,b,D);l._translateCameraConstrained(T),f&&Math.abs(l.zoom-E)>1e-4&&l.recenterOnTerrain(),l.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,r,!0)}_fireEvents(t,n,r){const s=ig(this._eventsInProgress),l=ig(t),c={};for(const m in t){const{originalEvent:_}=t[m];this._eventsInProgress[m]||(c[`${m}start`]=_),this._eventsInProgress[m]=t[m]}!s&&l&&this._fireEvent("movestart",l.originalEvent);for(const m in c)this._fireEvent(m,c[m]);l&&this._fireEvent("move",l.originalEvent);for(const m in t){const{originalEvent:_}=t[m];this._fireEvent(m,_)}const h={};let f;for(const m in this._eventsInProgress){const{handlerName:_,originalEvent:y}=this._eventsInProgress[m];this._handlersById[_].isActive()||(delete this._eventsInProgress[m],f=n[_]||y,h[`${m}end`]=f)}for(const m in h)this._fireEvent(m,h[m]);const p=ig(this._eventsInProgress);if(r&&(s||l)&&!p){this._updatingCamera=!0;const m=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),_=y=>0!==y&&-this._bearingSnap<y&&y<this._bearingSnap;m?(_(m.bearing||this._map.getBearing())&&(m.bearing=0),this._map.easeTo(m,{originalEvent:f})):(this._map.fire(new xt("moveend",{originalEvent:f})),_(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new xt(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new $M("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const cf="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class og extends xn{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=!1!==n.respectPrefersReducedMotion,Rr(["_renderFrameCallback"],this)}getCenter(){return new ce(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,r){return t=tt.convert(t).mult(-1),this.panTo(this.transform.center,Vt({offset:t},n),r)}panTo(t,n,r){return this.easeTo(Vt({center:t},n),r)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,r){return this.easeTo(Vt({zoom:t},n),r)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,r){return this.easeTo(Vt({bearing:t},n),r)}resetNorth(t,n){return this.rotateTo(0,Vt({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(Vt({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=fi.convert(t);const r=n&&n.bearing||0,s=n&&n.pitch||0,l=t.getNorthWest(),c=t.getSouthEast();return this._cameraForBounds(this.transform,l,c,r,s,n)}_extendCameraOptions(t){const n={top:0,bottom:0,right:0,left:0};if("number"==typeof(t=Vt({padding:n,offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding){const r=t.padding;t.padding={top:r,bottom:r,right:r,left:r}}return t.padding=Vt(n,t.padding),t}_minimumAABBFrustumDistance(t,n){const r=n.max[0]-n.min[0],s=n.max[1]-n.min[1];return r/s>t.aspect?r/(2*Math.tan(.5*t.fovX)*t.aspect):s/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,r,s,l,c){const h=t.clone(),f=this._extendCameraOptions(c);h.bearing=s,h.pitch=l;const p=ce.convert(n),m=ce.convert(r),_=.5*(p.lat+m.lat),y=.5*(p.lng+m.lng),v=Cr(_,y),b=H.normalize([],v),E=H.normalize([],H.cross([],b,[0,1,0])),D=H.cross([],E,b),T=[E[0],E[1],E[2],0,D[0],D[1],D[2],0,b[0],b[1],b[2],0,0,0,0,1],C=[v,Cr(p.lat,p.lng),Cr(m.lat,p.lng),Cr(m.lat,m.lng),Cr(p.lat,m.lng),Cr(_,p.lng),Cr(_,m.lng),Cr(p.lat,y),Cr(m.lat,y)];let I=Tn.fromPoints(C.map(X=>[H.dot(E,X),H.dot(D,X),H.dot(b,X)]));const A=H.transformMat4([],I.center,T);0===H.squaredLength(A)&&H.set(A,0,0,1),H.normalize(A,A),H.scale(A,A,ei),h.center=function([X,nt,ot]){const lt=Math.hypot(X,nt,ot),ht=Math.atan2(X,ot),ft=.5*Math.PI-Math.acos(-nt/lt);return new ce(xr(ht),xr(ft))}(A);const M=h.getWorldToCameraMatrix(),R=et.invert(new Float64Array(16),M);I=Tn.applyTransform(I,et.multiply([],M,T)),H.transformMat4(A,A,M);const L=.5*(I.max[2]-I.min[2]),O=this._minimumAABBFrustumDistance(h,I),z=H.scale([],[0,0,1],L),N=H.add(z,A,z),V=O+(0===h.pitch?0:H.distance(A,N)),B=h.globeCenterInViewSpace,$=H.sub([],A,[B[0],B[1],B[2]]);H.normalize($,$),H.scale($,$,V);const j=H.add([],A,$);H.transformMat4(j,j,R);const Z=ss/ei,K=H.length(j),Q=gn(Math.max(K*Z-ss,Number.EPSILON),0),W=Math.min(h.zoomFromMercatorZAdjusted(Q),f.maxZoom);return W>5.5?(h.setProjection({name:"mercator"}),h.zoom=W,this._cameraForBounds(h,n,r,s,l,c)):{center:h.center,zoom:W,bearing:s,pitch:l}}queryTerrainElevation(t,n){const r=this.transform.elevation;return r?(n=Vt({},{exaggerated:!0},n),r.getAtPoint(He.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,r,s,l,c){if("globe"===t.projection.name)return this._cameraForBoundsOnGlobe(t,n,r,s,l,c);const h=t.clone(),f=this._extendCameraOptions(c),p=h.padding;h.bearing=s,h.pitch=l;const m=ce.convert(n),_=ce.convert(r),y=new ce(m.lng,_.lat),v=new ce(_.lng,m.lat),b=h.project(m),E=h.project(_),D=this.queryTerrainElevation(m),T=this.queryTerrainElevation(_),C=this.queryTerrainElevation(y),I=this.queryTerrainElevation(v),A=[[b.x,b.y,Math.min(D||0,T||0,C||0,I||0)],[E.x,E.y,Math.max(D||0,T||0,C||0,I||0)]];let M=Tn.fromPoints(A);const R=h.getWorldToCameraMatrix(),L=et.invert(new Float64Array(16),R);M=Tn.applyTransform(M,R);const O=H.sub([],M.max,M.min),z=p.left||0,N=p.right||0,V=p.bottom||0,B=p.top||0,{left:$,right:j,top:Z,bottom:K}=f.padding,Q=.5*(z+N),W=.5*(B+V),X=Math.min(h.scaleZoom(h.scale*Math.min((h.width-(z+N+$+j))/O[0],(h.height-(V+B+K+Z))/O[1])),f.maxZoom),nt=h.scale/h.zoomScale(X);M=new Tn([M.min[0]-($+Q)*nt,M.min[1]-(K+W)*nt,M.min[2]],[M.max[0]+(j+Q)*nt,M.max[1]+(Z+W)*nt,M.max[2]]);const ot=.5*O[2],lt=this._minimumAABBFrustumDistance(h,M),ht=[0,0,1,0];an.transformMat4(ht,ht,R),an.normalize(ht,ht);const ft=H.scale([],ht,lt+ot),at=H.add([],M.center,ft),ut=("number"==typeof f.offset.x&&"number"==typeof f.offset.y?new tt(f.offset.x,f.offset.y):tt.convert(f.offset)).rotate(-be(s));M.center[0]-=ut.x*nt,M.center[1]+=ut.y*nt,H.transformMat4(M.center,M.center,L),H.transformMat4(at,at,L);const Et=[M.center[0],M.center[1],at[2]*h.pixelsPerMeter];H.scale(Et,Et,1/h.worldSize);const Ot=Vi(Et[0]),kt=dr(Et[1]),zt=Math.min(h._zoomFromMercatorZ(Et[2]),f.maxZoom),Zt=new ce(Ot,kt);return h.mercatorFromTransition&&zt<5.5?(h.setProjection({name:"globe"}),h.zoom=zt,this._cameraForBounds(h,n,r,s,l,c)):{center:Zt,zoom:zt,bearing:s,pitch:l}}fitBounds(t,n,r){const s=this.cameraForBounds(t,n);return this._fitInternal(s,n,r)}fitScreenCoordinates(t,n,r,s,l){const c=tt.convert(t),h=tt.convert(n),f=new tt(Math.min(c.x,h.x),Math.min(c.y,h.y)),p=new tt(Math.max(c.x,h.x),Math.max(c.y,h.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(c,h))return this;const m=this.transform.pointLocation3D(f),_=this.transform.pointLocation3D(p),y=this.transform.pointLocation3D(new tt(f.x,p.y)),v=this.transform.pointLocation3D(new tt(p.x,f.y)),b=[Math.min(m.lng,_.lng,y.lng,v.lng),Math.min(m.lat,_.lat,y.lat,v.lat)],E=[Math.max(m.lng,_.lng,y.lng,v.lng),Math.max(m.lat,_.lat,y.lat,v.lat)],D=s&&s.pitch?s.pitch:this.getPitch(),T=this._cameraForBounds(this.transform,b,E,r,D,s);return this._fitInternal(T,s,l)}_fitInternal(t,n,r){return t?(delete(n=Vt(t,n)).padding,n.linear?this.easeTo(n,r):this.flyTo(n,r)):this}jumpTo(t,n){this.stop();const r=t.preloadOnly?this.transform.clone():this.transform;let s=!1,l=!1,c=!1;return"zoom"in t&&r.zoom!==+t.zoom&&(s=!0,r.zoom=+t.zoom),void 0!==t.center&&(r.center=ce.convert(t.center)),"bearing"in t&&r.bearing!==+t.bearing&&(l=!0,r.bearing=+t.bearing),"pitch"in t&&r.pitch!==+t.pitch&&(c=!0,r.pitch=+t.pitch),null==t.padding||r.isPaddingEqual(t.padding)||(r.padding=t.padding),t.preloadOnly?(this._preloadTiles(r),this):(this.fire(new xt("movestart",n)).fire(new xt("move",n)),s&&this.fire(new xt("zoomstart",n)).fire(new xt("zoom",n)).fire(new xt("zoomend",n)),l&&this.fire(new xt("rotatestart",n)).fire(new xt("rotate",n)).fire(new xt("rotateend",n)),c&&this.fire(new xt("pitchstart",n)).fire(new xt("pitch",n)).fire(new xt("pitchend",n)),this.fire(new xt("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||Y(cf),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const r=this.transform;if(!r.projection.supportsFreeCamera)return Y(cf),this;this.stop();const s=r.zoom,l=r.pitch,c=r.bearing;r.setFreeCameraOptions(t);const h=s!==r.zoom,f=l!==r.pitch,p=c!==r.bearing;return this.fire(new xt("movestart",n)).fire(new xt("move",n)),h&&this.fire(new xt("zoomstart",n)).fire(new xt("zoom",n)).fire(new xt("zoomend",n)),p&&this.fire(new xt("rotatestart",n)).fire(new xt("rotate",n)).fire(new xt("rotateend",n)),f&&this.fire(new xt("pitchstart",n)).fire(new xt("pitch",n)).fire(new xt("pitchend",n)),this.fire(new xt("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),(!1===(t=Vt({offset:[0,0],duration:500,easing:Nn},t)).animate||this._prefersReducedMotion(t))&&(t.duration=0);const r=this.transform,s=this.getZoom(),l=this.getBearing(),c=this.getPitch(),h=this.getPadding(),f="zoom"in t?+t.zoom:s,p="bearing"in t?this._normalizeBearing(t.bearing,l):l,m="pitch"in t?+t.pitch:c,_="padding"in t?t.padding:r.padding,y=tt.convert(t.offset);let v,b,E;if("globe"===r.projection.name){const z=He.fromLngLat(r.center),N=y.rotate(-r.angle);z.x+=N.x/r.worldSize,z.y+=N.y/r.worldSize;const V=z.toLngLat(),B=ce.convert(t.center||V);this._normalizeCenter(B),v=r.centerPoint.add(N),b=new tt(z.x,z.y).mult(r.worldSize),E=new tt(Xr(B.lng),Ur(B.lat)).mult(r.worldSize).sub(b)}else{v=r.centerPoint.add(y);const z=r.pointLocation(v),N=ce.convert(t.center||z);this._normalizeCenter(N),b=r.project(z),E=r.project(N).sub(b)}const D=r.zoomScale(f-s);let T,C;t.around&&(T=ce.convert(t.around),C=r.locationPoint(T));const I=this._zooming||f!==s,A=this._rotating||l!==p,M=this._pitching||m!==c,R=!r.isPaddingEqual(_),L=z=>N=>{if(I&&(z.zoom=de(s,f,N)),A&&(z.bearing=de(l,p,N)),M&&(z.pitch=de(c,m,N)),R&&(z.interpolatePadding(h,_,N),v=z.centerPoint.add(y)),T)z.setLocationAtPoint(T,C);else{const V=z.zoomScale(z.zoom-s),B=f>s?Math.min(2,D):Math.max(.5,D),$=Math.pow(B,1-N),j=z.unproject(b.add(E.mult(N*$)).mult(V));z.setLocationAtPoint(z.renderWorldCopies?j.wrap():j,v)}return t.preloadOnly||this._fireMoveEvents(n),z};if(t.preloadOnly){const z=this._emulate(L,t.duration,r);return this._preloadTiles(z),this}const O={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=I,this._rotating=A,this._pitching=M,this._padding=R,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,O),this._ease(L(r),z=>{"sea"===r.cameraElevationReference&&r.recenterOnTerrain(),this._afterEase(n,z)},t),this}_prepareEase(t,n,r={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),n||r.moving||this.fire(new xt("movestart",t)),this._zooming&&!r.zooming&&this.fire(new xt("zoomstart",t)),this._rotating&&!r.rotating&&this.fire(new xt("rotatestart",t)),this._pitching&&!r.pitching&&this.fire(new xt("pitchstart",t))}_fireMoveEvents(t){this.fire(new xt("move",t)),this._zooming&&this.fire(new xt("zoom",t)),this._rotating&&this.fire(new xt("rotate",t)),this._pitching&&this.fire(new xt("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const r=this._zooming,s=this._rotating,l=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,r&&this.fire(new xt("zoomend",t)),s&&this.fire(new xt("rotateend",t)),l&&this.fire(new xt("pitchend",t)),this.fire(new xt("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const X=Ci(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(X,n)}this.stop(),t=Vt({offset:[0,0],speed:1.2,curve:1.42,easing:Nn},t);const r=this.transform,s=this.getZoom(),l=this.getBearing(),c=this.getPitch(),h=this.getPadding(),f="zoom"in t?Gt(+t.zoom,r.minZoom,r.maxZoom):s,p="bearing"in t?this._normalizeBearing(t.bearing,l):l,m="pitch"in t?+t.pitch:c,_="padding"in t?t.padding:r.padding,y=r.zoomScale(f-s),v=tt.convert(t.offset);let b=r.centerPoint.add(v);const E=r.pointLocation(b),D=ce.convert(t.center||E);this._normalizeCenter(D);const T=r.project(E),C=r.project(D).sub(T);let I=t.curve;const A=Math.max(r.width,r.height),M=A/y,R=C.mag();if("minZoom"in t){const X=Gt(Math.min(t.minZoom,s,f),r.minZoom,r.maxZoom),nt=A/r.zoomScale(X-s);I=Math.sqrt(nt/R*2)}const L=I*I;function O(X){const nt=(M*M-A*A+(X?-1:1)*L*L*R*R)/(2*(X?M:A)*L*R);return Math.log(Math.sqrt(nt*nt+1)-nt)}function z(X){return(Math.exp(X)-Math.exp(-X))/2}function N(X){return(Math.exp(X)+Math.exp(-X))/2}const V=O(0);let B=function(X){return N(V)/N(V+I*X)},$=function(X){return A*((N(V)*(z(nt=V+I*X)/N(nt))-z(V))/L)/R;var nt},j=(O(1)-V)/I;if(Math.abs(R)<1e-6||!isFinite(j)){if(Math.abs(A-M)<1e-6)return this.easeTo(t,n);const X=M<A?-1:1;j=Math.abs(Math.log(M/A))/I,$=function(){return 0},B=function(nt){return Math.exp(X*I*nt)}}t.duration="duration"in t?+t.duration:1e3*j/("screenSpeed"in t?+t.screenSpeed/I:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const Z=l!==p,K=m!==c,Q=!r.isPaddingEqual(_),W=X=>nt=>{const ot=nt*j,lt=1/B(ot);X.zoom=1===nt?f:s+X.scaleZoom(lt),Z&&(X.bearing=de(l,p,nt)),K&&(X.pitch=de(c,m,nt)),Q&&(X.interpolatePadding(h,_,nt),b=X.centerPoint.add(v));const ht=1===nt?D:X.unproject(T.add(C.mult($(ot))).mult(lt));return X.setLocationAtPoint(X.renderWorldCopies?ht.wrap():ht,b),X._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),X};if(t.preloadOnly){const X=this._emulate(W,t.duration,r);return this._preloadTiles(X),this}return this._zooming=!0,this._rotating=Z,this._pitching=K,this._padding=Q,this._prepareEase(n,!1),this._ease(W(r),()=>this._afterEase(n),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const r=this._onEaseEnd;this._onEaseEnd=void 0,r.call(this,n)}if(!t){const r=this.handlers;r&&r.stop(!1)}return this}_ease(t,n,r){!1===r.animate||0===r.duration?(t(1),n()):(this._easeStart=me.now(),this._easeOptions=r,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((me.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=Ds(t,-180,180);const r=Math.abs(t-n);return Math.abs(t-360-n)<r&&(t-=360),Math.abs(t+360-n)<r&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(!n.renderWorldCopies||n.maxBounds)return;const r=t.lng-n.center.lng;t.lng+=r>180?-360:r<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&me.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,r){const s=Math.ceil(15*n/1e3),l=[],c=t(r.clone());for(let h=0;h<=s;h++){const f=c(h/s);l.push(f.clone())}return l}}class uf{constructor(t={}){this.options=t,Rr(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact;return this._map=t,this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=_e("button","mapboxgl-ctrl-attrib-button",this._container),_e("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=_e("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===n&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(t,n){const r=this._map._getUIString(`AttributionControl.${n}`);t.setAttribute("aria-label",r),t.removeAttribute("title"),t.firstElementChild&&t.firstElementChild.setAttribute("title",r)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||Ae.ACCESS_TOKEN}];if(t){const r=n.reduce((s,l,c)=>(l.value&&(s+=`${l.key}=${l.value}${c<n.length-1?"&":""}`),s),"?");t.href=`${Ae.FEEDBACK_URL}/${r}#${OM(this._map,!0)}`,t.rel="noopener nofollow",this._setElementTitle(t,"MapFeedback")}}_updateData(t){!t||"metadata"!==t.sourceDataType&&"visibility"!==t.sourceDataType&&"style"!==t.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const s=this._map.style.stylesheet;this.styleOwner=s.owner,this.styleId=s.id}const n=this._map.style._mergedSourceCaches;for(const s in n){const l=n[s];if(l.used){const c=l.getSource();c.attribution&&t.indexOf(c.attribution)<0&&t.push(c.attribution)}}t.sort((s,l)=>s.length-l.length),t=t.filter((s,l)=>{for(let c=l+1;c<t.length;c++)if(t[c].indexOf(s)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const r=t.join(" | ");r!==this._attribHTML&&(this._attribHTML=r,t.length?(this._innerContainer.innerHTML=r,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Mo{constructor(){Rr(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=_e("div","mapboxgl-ctrl");const n=_e("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&"metadata"!==t.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(0===Object.entries(t).length)return!0;for(const n in t){const r=t[n].getSource();if(r.hasOwnProperty("mapbox_logo")&&!r.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class sg{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,r=n?this._queue.concat(n):this._queue;for(const s of r)if(s.id===t)return void(s.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const r of n)if(!r.cancelled&&(r.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function GM(e,t,n){if(e=new ce(e.lng,e.lat),t){const r=new ce(e.lng-360,e.lat),s=new ce(e.lng+360,e.lat),l=360*Math.ceil(Math.abs(e.lng-n.center.lng)/360),c=n.locationPoint(e).distSqr(t),h=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint(r).distSqr(t)<c&&(h||Math.abs(r.lng-n.center.lng)<l)?e=r:n.locationPoint(s).distSqr(t)<c&&(h||Math.abs(s.lng-n.center.lng)<l)&&(e=s)}for(;Math.abs(e.lng-n.center.lng)>180;){const r=n.locationPoint(e);if(r.x>=0&&r.y>=0&&r.x<=n.width&&r.y<=n.height)break;e.lng>n.center.lng?e.lng-=360:e.lng+=360}return e}const IT={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class AT extends xn{constructor(t,n){if(super(),(t instanceof it.HTMLElement||n)&&(t=Vt({element:t},n)),Rr(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=t&&t.occludedOpacity||.2,t&&t.element)this._element=t.element,this._offset=tt.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=_e("div");const l=41,c=27,h=Zo("svg",{display:"block",height:l*this._scale+"px",width:c*this._scale+"px",viewBox:`0 0 ${c} ${l}`},this._element),f=Zo("radialGradient",{id:"shadowGradient"},Zo("defs",{},h));Zo("stop",{offset:"10%","stop-opacity":.4},f),Zo("stop",{offset:"100%","stop-opacity":.05},f),Zo("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},h),Zo("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},h),Zo("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},h),Zo("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},h),this._offset=tt.convert(t&&t.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",l=>{l.preventDefault()}),this._element.addEventListener("mousedown",l=>{l.preventDefault()});const r=this._element.classList;for(const l in IT)r.remove(`mapboxgl-marker-anchor-${l}`);r.add(`mapboxgl-marker-anchor-${this._anchor}`);const s=t&&t.className?t.className.trim().split(/\s+/):[];r.add(...s),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=ce.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const s=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[s,-1*(24.6+s)],"bottom-right":[-s,-1*(24.6+s)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset}this._popup=t,t._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,r=t.charCode||t.keyCode;"Space"!==n&&"Enter"!==n&&32!==r&&13!==r||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,r=this._element;this._popup&&(n===r||r.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const r=t.unproject(n),s=t.getFreeCameraOptions();if(!s.position)return!1;const l=s.position.toLngLat();return l.distanceTo(r)<.9*l.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const r=t.unproject(n);let s;t._showingGlobe()&&Fp(t.transform,this._lngLat)?s=0:(s=1-t._queryFogOpacity(r),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(s*=this._occludedOpacity)),this._element.style.opacity=`${s}`,this._element.style.pointerEvents=s>0?"auto":"none",this._popup&&this._popup._setOpacity(s),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${t.x}px,${t.y}px)\n            ${IT[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${n.x}px,${n.y}px)\n        `}_calculateXYTransform(){const t=this._pos,n=this._map,r=this.getPitchAlignment();if(!n||!t||"map"!==r)return"";if(!n._showingGlobe()){const f=n.getPitch();return f?`rotateX(${f}deg)`:""}const s=xr(tb(n.transform,this._lngLat)),l=t.sub(Q1(n.transform)),c=Math.abs(l.x)+Math.abs(l.y);if(0===c)return"";const h=s/c;return`rotateX(${-l.y*h}deg) rotateY(${l.x*h}deg)`}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let r=0;const s=this.getRotationAlignment();if("map"===s)if(n._showingGlobe()){const l=n.project(new ce(this._lngLat.lng,this._lngLat.lat+.001)),c=n.project(new ce(this._lngLat.lng,this._lngLat.lat-.001)).sub(l);r=xr(Math.atan2(c.y,c.x))-90}else r=-n.getBearing();else if("horizon"===s){const l=Ts(4,6,n.getZoom()),c=Q1(n.transform);c.y+=l*n.transform.height;const h=t.sub(c),f=xr(Math.atan2(h.y,h.x));r=(f>90?f-270:f+90)*(1-l)}return r+=this._rotation,r?`rotateZ(${r}deg)`:""}_update(t){it.cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=GM(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat),!0===t?this._updateFrameId=it.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),n._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=tt.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const r=this._pointerdownPos,s=this._positionDelta;if(r&&s){if(!this._isDragging){const l=this._clickTolerance||n._clickTolerance;if(t.point.dist(r)<l)return;this._isDragging=!0}this._pos=t.point.sub(s),this._lngLat=n.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new xt("dragstart"))),this.fire(new xt("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new xt("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,r=this._pos;n&&r&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(r),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const qM={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},WM=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Tv(e=new tt(0,0),t="bottom"){if("number"==typeof e){const n=Math.round(Math.sqrt(.5*Math.pow(e,2)));switch(t){case"top":return new tt(0,e);case"top-left":return new tt(n,n);case"top-right":return new tt(-n,n);case"bottom":return new tt(0,-e);case"bottom-left":return new tt(n,-n);case"bottom-right":return new tt(-n,-n);case"left":return new tt(e,0);case"right":return new tt(-e,0)}return new tt(0,0)}return e instanceof tt||Array.isArray(e)?tt.convert(e):tt.convert(e[t]||[0,0])}class ZM{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=Ga((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,r){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+r}}const XM={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},c2={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},$o={showCompass:!0,showZoom:!0,visualizePitch:!1};class Dv{constructor(t,n,r=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new ET({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,r&&(this.mousePitch=new rg({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),Rr(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),Sf()}move(t,n){const r=this.map,s=this.mouseRotate.mousemoveWindow(t,n),l=s&&s.bearingDelta;if(l&&r.setBearing(r.getBearing()+l),this.mousePitch){const c=this.mousePitch.mousemoveWindow(t,n),h=c&&c.pitchDelta;h&&r.setPitch(r.getPitch()+h)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Ge(),it.removeEventListener("mousemove",this.mousemove),it.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Vt({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),ne(this.element,t)),it.addEventListener("mousemove",this.mousemove),it.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,ne(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){1!==t.targetTouches.length?this.reset():(this._startPos=this._lastPos=Gl(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){1!==t.targetTouches.length?this.reset():(this._lastPos=Gl(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){0===t.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const YM={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},KM={maxWidth:100,unit:"metric"},JM={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},ag={version:Go,supported:tx,setRTLTextPlugin:function(e,t,n=!1){if(vo===Xx||vo===Yx||vo===Kx)throw new Error("setRTLTextPlugin cannot be called multiple times.");rc=me.resolveURL(e),vo=Xx,Jx=t,Qx(),n||tp()},getRTLTextPluginStatus:Or,Map:class extends og{constructor(e){if(vg.mark(Eh.create),null!=(e=Vt({},c2,e)).minZoom&&null!=e.maxZoom&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=e.minPitch&&null!=e.maxPitch&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=e.minPitch&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=e.maxPitch&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(e.antialias&&function(t){const n=t.navigator?t.navigator.userAgent:null;return!!function(r){if(null==se){const s=r.navigator?r.navigator.userAgent:null;se=!!r.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return se}(t)&&n&&(n.match("Version/15.4")||n.match("Version/15.5")||n.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))}(it)&&(e.antialias=!1,Y("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new bm(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),e),this._interactive=e.interactive,this._minTileCacheSize=e.minTileCacheSize,this._maxTileCacheSize=e.maxTileCacheSize,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=e.preserveDrawingBuffer,this._antialias=e.antialias,this._trackResize=e.trackResize,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles,this._fadeDuration=e.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=e.crossSourceCollisions,this._collectResourceTiming=e.collectResourceTiming,this._language=this._parseLanguage(e.language),this._worldview=e.worldview,this._renderTaskQueue=new sg,this._domRenderTaskQueue=new sg,this._controls=[],this._markers=[],this._popups=[],this._mapId=mr(),this._locale=Vt({},XM,e.locale),this._clickTolerance=e.clickTolerance,this._cooperativeGestures=e.cooperativeGestures,this._performanceMetricsCollection=e.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new ZM(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new Jt(e.transformRequest,e.accessToken,e.testMode),this._silenceAuthErrors=!!e.testMode,"string"==typeof e.container){if(this._container=it.document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container.toString()}' not found.`)}else{if(!(e.container instanceof it.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(this._container.childNodes.length>0&&Y("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),e.maxBounds&&this.setMaxBounds(e.maxBounds),Rr(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),void 0!==it&&(this._fullscreenchangeEvent="onfullscreenchange"in it.document?"fullscreenchange":"webkitfullscreenchange",it.addEventListener("online",this._onWindowOnline,!1),it.addEventListener("resize",this._onWindowResize,!1),it.addEventListener("orientationchange",this._onWindowResize,!1),it.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),it.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new l2(this,e),this._localFontFamily=e.localFontFamily,this._localIdeographFontFamily=e.localIdeographFontFamily,(e.style||!e.testMode)&&this.setStyle(e.style||Ae.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),e.projection&&this.setProjection(e.projection),e.hash&&(this._hash=new e2("string"==typeof e.hash&&e.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch});const t=e.bounds;t&&(this.resize(),this.fitBounds(t,Vt({},e.fitBoundsOptions,{duration:0})))}this.resize(),e.attributionControl&&this.addControl(new uf({customAttribution:e.customAttribution})),this._logoControl=new Mo,this.addControl(this._logoControl,e.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",t=>{this._update("style"===t.dataType),this.fire(new xt(`${t.dataType}data`,t))}),this.on("dataloading",t=>{this.fire(new xt(`${t.dataType}dataloading`,t))})}_getMapId(){return this._mapId}addControl(e,t){if(void 0===t&&(t=e.getDefaultPosition?e.getDefaultPosition():"top-right"),!e||!e.onAdd)return this.fire(new he(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=e.onAdd(this);this._controls.push(e);const r=this._controlPositions[t];return-1!==t.indexOf("bottom")?r.insertBefore(n,r.firstChild):r.appendChild(n),this}removeControl(e){if(!e||!e.onRemove)return this.fire(new he(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(e);return t>-1&&this._controls.splice(t,1),e.onRemove(this),this}hasControl(e){return this._controls.indexOf(e)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(e){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new xt("movestart",e)).fire(new xt("move",e)),this.fire(new xt("resize",e)),t&&this.fire(new xt("moveend",e)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(e){return this.transform.setMaxBounds(fi.convert(e)),this._update()}setMinZoom(e){if((e=e??-2)>=-2&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e?this.setZoom(e):this.fire(new xt("zoomstart")).fire(new xt("zoom")).fire(new xt("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(e){if((e=e??22)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e?this.setZoom(e):this.fire(new xt("zoomstart")).fire(new xt("zoom")).fire(new xt("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(e){if((e=e??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e?this.setPitch(e):this.fire(new xt("pitchstart")).fire(new xt("pitch")).fire(new xt("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(e){if((e=e??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e?this.setPitch(e):this.fire(new xt("pitchstart")).fire(new xt("pitch")).fire(new xt("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(e){return"auto"===e?it.navigator.language:Array.isArray(e)?0===e.length?void 0:e.map(t=>"auto"===t?it.navigator.language:t):e}setLanguage(e){const t=this._parseLanguage(e);if(!this.style||t===this._language)return this;this._language=t,this.style.clearSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(e){return this.style&&e!==this._worldview?(this._worldview=e,this.style.clearSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(e){return this._lazyInitEmptyStyle(),e?"string"==typeof e&&(e={name:e}):e=null,this._useExplicitProjection=!!e,this._prioritizeAndUpdateProjection(e,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const e=this.transform,t=e.projection.name;let n;"globe"===t&&e.zoom>=6?(e.setMercatorFromTransition(),n=!0):"mercator"===t&&e.zoom<6&&(e.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(e,t){return this._updateProjection(e||t||{name:"mercator"})}_updateProjection(e){let t;return t="globe"===e.name&&this.transform.zoom>=6?this.transform.setMercatorFromTransition():this.transform.setProjection(e),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(e){return this.transform.locationPoint3D(ce.convert(e))}unproject(e){return this.transform.pointLocation3D(tt.convert(e))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(e,t,n){if("mouseenter"===e||"mouseover"===e){let r=!1;const s=c=>{const h=t.filter(p=>this.getLayer(p)),f=h.length?this.queryRenderedFeatures(c.point,{layers:h}):[];f.length?r||(r=!0,n.call(this,new Uo(e,this,c.originalEvent,{features:f}))):r=!1},l=()=>{r=!1};return{layers:new Set(t),listener:n,delegates:{mousemove:s,mouseout:l}}}if("mouseleave"===e||"mouseout"===e){let r=!1;const s=c=>{const h=t.filter(f=>this.getLayer(f));(h.length?this.queryRenderedFeatures(c.point,{layers:h}):[]).length?r=!0:r&&(r=!1,n.call(this,new Uo(e,this,c.originalEvent)))},l=c=>{r&&(r=!1,n.call(this,new Uo(e,this,c.originalEvent)))};return{layers:new Set(t),listener:n,delegates:{mousemove:s,mouseout:l}}}{const r=s=>{const l=t.filter(h=>this.getLayer(h)),c=l.length?this.queryRenderedFeatures(s.point,{layers:l}):[];c.length&&(s.features=c,n.call(this,s),delete s.features)};return{layers:new Set(t),listener:n,delegates:{[e]:r}}}}on(e,t,n){if(void 0===n)return super.on(e,t);if(Array.isArray(t)||(t=[t]),t)for(const s of t)if(!this._isValidId(s))return this;const r=this._createDelegatedListener(e,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(r);for(const s in r.delegates)this.on(s,r.delegates[s]);return this}once(e,t,n){if(void 0===n)return super.once(e,t);if(Array.isArray(t)||(t=[t]),t)for(const s of t)if(!this._isValidId(s))return this;const r=this._createDelegatedListener(e,t,n);for(const s in r.delegates)this.once(s,r.delegates[s]);return this}off(e,t,n){if(void 0===n)return super.off(e,t);t=new Set(Array.isArray(t)?t:[t]);for(const l of t)if(!this._isValidId(l))return this;const r=(l,c)=>{if(l.size!==c.size)return!1;for(const h of l)if(!c.has(h))return!1;return!0},s=this._delegatedListeners?this._delegatedListeners[e]:void 0;return s&&(l=>{for(let c=0;c<l.length;c++){const h=l[c];if(h.listener===n&&r(h.layers,t)){for(const f in h.delegates)this.off(f,h.delegates[f]);return l.splice(c,1),this}}})(s),this}queryRenderedFeatures(e,t){if(!this.style)return[];if(void 0!==t||void 0===e||e instanceof tt||Array.isArray(e)||(t=e,e=void 0),e=e||[[0,0],[this.transform.width,this.transform.height]],(t=t||{}).layers&&Array.isArray(t.layers))for(const n of t.layers)if(!this._isValidId(n))return[];return this.style.queryRenderedFeatures(e,t,this.transform)}querySourceFeatures(e,t){return this._isValidId(e)?this.style.querySourceFeatures(e,t):[]}isPointOnSurface(e){const{name:t}=this.transform.projection;return"globe"!==t&&"mercator"!==t&&Y(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(tt.convert(e))}setStyle(e,t){return!1!==(t=Vt({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t)).diff&&t.localIdeographFontFamily===this._localIdeographFontFamily&&t.localFontFamily===this._localFontFamily&&this.style&&e?(this._diffStyle(e,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(e,t))}_getUIString(e){const t=this._locale[e];if(null==t)throw new Error(`Missing UI string '${e}'`);return t}_updateStyle(e,t){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),e&&(this.style=new _s(this,t||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof e?this.style.loadURL(e):this.style.loadJSON(e)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new _s(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(e,t){if("string"==typeof e){const n=this._requestManager.normalizeStyleURL(e),r=this._requestManager.transformRequest(n,dt.Style);Dt(r,(s,l)=>{s?this.fire(new he(s)):l&&this._updateDiff(l,t)})}else"object"==typeof e&&this._updateDiff(e,t)}_updateDiff(e,t){try{this.style.setState(e)&&this._update(!0)}catch(n){Y(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(e,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(Y("There is no style added to the map."),!1)}_isValidId(e){return!(t=e,t.indexOf("\x1f")>=0&&(this.fire(new he(new Error(`IDs can't contain special symbols: "${e}".`))),1));var t}addSource(e,t){return this._isValidId(e)?(this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0)):this}isSourceLoaded(e){return!!this._isValidId(e)&&!!this.style&&this.style._isSourceCacheLoaded(e)}areTilesLoaded(){const e=this.style&&this.style._sourceCaches;for(const t in e){const n=e[t]._tiles;for(const r in n){const s=n[r];if("loaded"!==s.state&&"errored"!==s.state)return!1}}return!0}addSourceType(e,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,n)}removeSource(e){return this._isValidId(e)?(this.style.removeSource(e),this._updateTerrain(),this._update(!0)):this}getSource(e){return this._isValidId(e)?this.style.getOwnSource(e):null}addImage(e,t,{pixelRatio:n=1,sdf:r=!1,stretchX:s,stretchY:l,content:c}={}){if(this._lazyInitEmptyStyle(),t instanceof it.HTMLImageElement||it.ImageBitmap&&t instanceof it.ImageBitmap){const{width:h,height:f,data:p}=me.getImageData(t);this.style.addImage(e,{data:new rr({width:h,height:f},p),pixelRatio:n,stretchX:s,stretchY:l,content:c,sdf:r,version:0})}else if(void 0===t.width||void 0===t.height)this.fire(new he(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:h,height:f}=t,p=t;this.style.addImage(e,{data:new rr({width:h,height:f},new Uint8Array(p.data)),pixelRatio:n,stretchX:s,stretchY:l,content:c,sdf:r,version:0,userImage:p}),p.onAdd&&p.onAdd(this,e)}}updateImage(e,t){this._lazyInitEmptyStyle();const n=this.style.getImage(e);if(!n)return void this.fire(new he(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const r=t instanceof it.HTMLImageElement||it.ImageBitmap&&t instanceof it.ImageBitmap?me.getImageData(t):t,{width:s,height:l}=r;void 0!==s&&void 0!==l?s===n.data.width&&l===n.data.height?(n.data.replace(r.data,!(t instanceof it.HTMLImageElement||it.ImageBitmap&&t instanceof it.ImageBitmap)),this.style.updateImage(e,n)):this.fire(new he(new Error(`The width and height of the updated image (${s}, ${l})\n                must be that same as the previous version of the image\n                (${n.data.width}, ${n.data.height})`))):this.fire(new he(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(e){return e?!!this.style&&!!this.style.getImage(e):(this.fire(new he(new Error("Missing required image id"))),!1)}removeImage(e){this.style.removeImage(e)}loadImage(e,t){Te(this._requestManager.transformRequest(e,dt.Image),(n,r)=>{t(n,r instanceof it.HTMLImageElement?me.getImageData(r):r)})}listImages(){return this.style.listImages()}addModel(e,t){this._lazyInitEmptyStyle(),this.style.addModel(e,t)}hasModel(e){return e?this.style.hasModel(e):(this.fire(new he(new Error("Missing required model id"))),!1)}removeModel(e){this.style.removeModel(e)}listModels(){return this.style.listModels()}addLayer(e,t){return this._isValidId(e.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0)):this}moveLayer(e,t){return this._isValidId(e)?(this.style.moveLayer(e,t),this._update(!0)):this}removeLayer(e){return this._isValidId(e)?(this.style.removeLayer(e),this._update(!0)):this}getLayer(e){return this._isValidId(e)?this.style.getOwnLayer(e):null}setLayerZoomRange(e,t,n){return this._isValidId(e)?(this.style.setLayerZoomRange(e,t,n),this._update(!0)):this}setFilter(e,t,n={}){return this._isValidId(e)?(this.style.setFilter(e,t,n),this._update(!0)):this}getFilter(e){return this._isValidId(e)?this.style.getFilter(e):null}setPaintProperty(e,t,n,r={}){return this._isValidId(e)?(this.style.setPaintProperty(e,t,n,r),this._update(!0)):this}getPaintProperty(e,t){return this._isValidId(e)?this.style.getPaintProperty(e,t):null}setLayoutProperty(e,t,n,r={}){return this._isValidId(e)?(this.style.setLayoutProperty(e,t,n,r),this._update(!0)):this}getLayoutProperty(e,t){return this._isValidId(e)?this.style.getLayoutProperty(e,t):null}setConfigProperty(e,t,n){return this.style.setConfigProperty(e,t,n),this._update(!0)}setLights(e){if(this._lazyInitEmptyStyle(),e&&1===e.length&&"flat"===e[0].type){const t=e[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(e),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const e=this.style.getLights()||[];return 0===e.length&&e.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),e}setLight(e,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:e}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(e){return this._lazyInitEmptyStyle(),!e&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(e),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(e){return this._lazyInitEmptyStyle(),this.style.setFog(e),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(e){return this.style.setCamera(e),this._triggerCameraUpdate(e)}_triggerCameraUpdate(e){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===e["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(e){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(ce.convert(e),this.transform):0}setFeatureState(e,t){return this._isValidId(e.source)?(this.style.setFeatureState(e,t),this._update()):this}removeFeatureState(e,t){return this._isValidId(e.source)?(this.style.removeFeatureState(e,t),this._update()):this}getFeatureState(e){return this._isValidId(e.source)?this.style.getFeatureState(e):null}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,r,s,l=this._container;for(;l&&(!r||!s);){const c=it.getComputedStyle(l).transform;c&&"none"!==c&&(n=c.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&"0"!==n[0]&&"1"!==n[0]&&(r=n[0]),n[3]&&"0"!==n[3]&&"1"!==n[3]&&(s=n[3])),l=l.parentElement}this._containerWidth=r?Math.abs(e/r):e,this._containerHeight=s?Math.abs(t/s):t}_detectMissingCSS(){"rgb(250, 128, 114)"!==it.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&Y("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const e=this._container;e.classList.add("mapboxgl-map"),(this._missingCSSCanary=_e("div","mapboxgl-canary",e)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=_e("div","mapboxgl-canvas-container",e);this._canvas=_e("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=_e("div","mapboxgl-control-container",e),r=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(s=>{r[s]=_e("div",`mapboxgl-ctrl-${s}`,n)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(e,t){const n=me.devicePixelRatio||1;this._canvas.width=n*Math.ceil(e),this._canvas.height=n*Math.ceil(t),this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`}_addMarker(e){this._markers.push(e)}_removeMarker(e){const t=this._markers.indexOf(e);-1!==t&&this._markers.splice(t,1)}_addPopup(e){this._popups.push(e)}_removePopup(e){const t=this._popups.indexOf(e);-1!==t&&this._popups.splice(t,1)}_setupPainter(){const e=Vt({},tx.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",e);t?(Jv(t,!0),this.painter=new MM(t,this.transform),this.on("data",n=>{"source"===n.dataType&&this.painter.setTileLoadedFlag(!0)}),mo.testSupport(t)):this.fire(new he(new Error("Failed to initialize WebGL")))}_contextLost(e){e.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new xt("webglcontextlost",{originalEvent:e}))}_contextRestored(e){this._setupPainter(),this.resize(),this._update(),this.fire(new xt("webglcontextrestored",{originalEvent:e}))}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e)}_cancelRenderFrame(e){this._renderTaskQueue.remove(e)}_requestDomTask(e){!this.loaded()||this.loaded()&&!this.isMoving()?e():this._domRenderTaskQueue.add(e)}_render(e){let t;this.fire(new xt("renderstart"));const n=this.painter.context.extTimerQuery,r=me.now(),s=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=s.createQuery(),s.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],it.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],it.performance.now())),this._renderTaskQueue.run(e),this._domRenderTaskQueue.run(e),this._removed)return;this._updateProjectionTransition();const l=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const f=this.transform.zoom,p=this.transform.pitch,m=me.now(),_=new Gn(f,{now:m,fadeDuration:l,pitch:p,transition:this.style.transition});this.style.update(_)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let c=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),c=this._updateAverageElevation(r),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):c=this._updateAverageElevation(r),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,l,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:l,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new xt("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new xt("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const f=me.now()-r;s.endQuery(n.TIME_ELAPSED_EXT),setTimeout(()=>{const p=s.getQueryParameter(t,s.QUERY_RESULT)/1e6;s.deleteQuery(t),this.fire(new xt("gpu-timing-frame",{cpuTime:f,gpuTime:p})),it.performance.mark("frame-gpu",{startTime:r,detail:{gpuTime:p}})},50)}if(this.listens("gpu-timing-layer")){const f=this.painter.collectGpuTimers();setTimeout(()=>{const p=this.painter.queryGpuTimers(f);this.fire(new xt("gpu-timing-layer",{layerTimes:p}))},50)}if(this.listens("gpu-timing-deferred-render")){const f=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const p=this.painter.queryGpuTimeDeferredRender(f);this.fire(new xt("gpu-timing-deferred-render",{gpuTime:p}))},50)}const h=this._sourcesDirty||this._styleDirty||this._placementDirty||c;if(h||this._repaint)this.triggerRepaint();else{const f=!this.isMoving()&&this.loaded();if(f&&(c=this._updateAverageElevation(r,!0)),c)this.triggerRepaint();else if(this._triggerFrame(!1),f&&(this.fire(new xt("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const p=this._calculateSpeedIndex();this.fire(new xt("speedindexcompleted",{speedIndex:p})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||h||(this._fullyLoaded=!0,vg.mark(Eh.fullLoad),this._performanceMetricsCollection&&pD(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(e){for(const t of this._markers)e&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!e||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(e,t=!1){const n=s=>(this.transform.averageElevation=s,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&n(0);const r=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(r||(t||e-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(e)){const s=this.transform.averageElevation;let l=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(l)?l=0:this._averageElevationLastSampledAt=e;const c=Math.abs(s-l);if(c>1){if(this._isInitialLoad||r)return this._averageElevation.jumpTo(l),n(l);this._averageElevation.easeTo(l,e,300)}else if(c>1e-4)return this._averageElevation.jumpTo(l),n(l)}return!!this._averageElevation.isEasing(e)&&n(this._averageElevation.getValue(e))}_authenticate(){mD(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,e=>{if(e&&(e.message===dn||401===e.status)){const t=this.painter.context.gl;Jv(t,!1),this._logoControl instanceof Mo&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new he(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),sA(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){const e=this._isDragging();this.painter.updateTerrain(this.style,e)}_calculateSpeedIndex(){const e=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,r=n.createFramebuffer();function s(l){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,l,0);const c=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,c),c}return n.bindFramebuffer(n.FRAMEBUFFER,r),this._canvasPixelComparison(s(e),t.canvasCopies.map(s),t.timeStamps)}_canvasPixelComparison(e,t,n){let r=n[1]-n[0];const s=e.length/4;for(let l=0;l<t.length;l++){const c=t[l];let h=0;for(let f=0;f<c.length;f+=4)c[f]===e[f]&&c[f+1]===e[f+1]&&c[f+2]===e[f+2]&&c[f+3]===e[f+3]&&(h+=1);r+=(n[l+2]-n[l+1])*(1-h/s)}return r}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),void 0!==it&&(it.removeEventListener("resize",this._onWindowResize,!1),it.removeEventListener("orientationchange",this._onWindowResize,!1),it.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),it.removeEventListener("online",this._onWindowOnline,!1),it.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Ka.delete(this.painter.context.gl),this._removed=!0,this.fire(new xt("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(e){this._renderNextFrame=this._renderNextFrame||e,this.style&&!this._frame&&(this._frame=me.frame(t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)}))}_preloadTiles(e){return Ul(this.style?Object.values(this.style._sourceCaches):[],(t,n)=>t._preloadTiles(e,n),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update()}_onVisibilityChange(){"hidden"===it.document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(e){this._showTerrainWireframe!==e&&(this._showTerrainWireframe=e,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(e){this._showLayers2DWireframe!==e&&(this._showLayers2DWireframe=e,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(e){this._showLayers3DWireframe!==e&&(this._showLayers3DWireframe=e,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(e){this._speedIndexTiming!==e&&(this._speedIndexTiming=e,this._update())}get showPadding(){return!!this._showPadding}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,e?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update())}get repaint(){return!!this._repaint}set repaint(e){this._repaint!==e&&(this._repaint=e,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(e){this._vertices=e,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(e){this._showTileAABBs!==e&&(this._showTileAABBs=e,e&&this._update())}_setCacheLimits(e,t){oi=e,vi=t}get version(){return Go}},NavigationControl:class{constructor(e){this.options=Vt({},$o,e),this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(Rr(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),_e("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),_e("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(Rr(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))}),this._compassIcon=_e("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const e=this._map;if(!e)return;const t=e.getZoom(),n=t===e.getMaxZoom(),r=t===e.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=r,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",r.toString())}_rotateCompassArrow(){const e=this._map;if(!e)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(e.transform.pitch*(Math.PI/180)),.5)}) rotateX(${e.transform.pitch}deg) rotateZ(${e.transform.angle*(180/Math.PI)}deg)`:`rotate(${e.transform.angle*(180/Math.PI)}deg)`;e._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),e.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&e.on("pitch",this._rotateCompassArrow),e.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Dv(e,this._compass,this.options.visualizePitch)),this._container}onRemove(){const e=this._map;e&&(this._container.remove(),this.options.showZoom&&e.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&e.off("pitch",this._rotateCompassArrow),e.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(e,t){const n=_e("button",e,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(e,t){if(!this._map)return;const n=this._map._getUIString(`NavigationControl.${t}`);e.setAttribute("aria-label",n),e.firstElementChild&&e.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends xn{constructor(e){super(),this.options=Vt({geolocation:it.navigator.geolocation},YM,e),Rr(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Nc(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(e){return this._map=e,this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(e){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,e(n)};void 0!==this._supportsGeolocation?e(this._supportsGeolocation):void 0!==it.navigator.permissions?it.navigator.permissions.query({name:"geolocation"}).then(n=>t("denied"!==n.state)).catch(()=>t()):t()}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),n=e.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(e){if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new xt("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(e),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(e),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new xt("geolocate",e)),this._finish()}}_updateCamera(e){const t=new ce(e.coords.longitude,e.coords.latitude),n=e.coords.accuracy,r=Vt({bearing:this._map.getBearing()},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),r,{geolocateSource:!0})}_updateMarker(e){if(e){const t=new ce(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const e=this._map.transform,t=gn(1,e._center.lat)*e.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(e){if(this._map){if(this.options.trackUserLocation)if(1===e.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===e.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new xt("error",e)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(e){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=_e("button","mapboxgl-ctrl-geolocate",this._container),_e("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===e){Y("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=_e("div","mapboxgl-user-location"),this._dotElement.appendChild(_e("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(_e("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new AT({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=_e("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new AT({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||"ACTIVE_LOCK"!==this._watchState||t.originalEvent&&"resize"===t.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new xt("trackuserlocationend")))})}}_onDeviceOrientation(e){this._userLocationDotMarker&&(e.webkitCompassHeading?this._heading=e.webkitCompassHeading:!0===e.absolute&&(this._heading=-1*e.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return Y("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new xt("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new xt("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new xt("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let e;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(e={maximumAge:6e5,timeout:0},this._noTimeout=!0):(e=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,e),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{it.addEventListener("ondeviceorientationabsolute"in it?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};void 0!==it.DeviceMotionEvent&&"function"==typeof it.DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(t=>{"granted"===t&&e()}).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),it.removeEventListener("deviceorientation",this._onDeviceOrientation),it.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:uf,ScaleControl:class{constructor(e){this.options=Vt({},KM,e),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),Rr(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const e=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,r=t._containerWidth/2-e/2,s=t.unproject([r,n]),l=t.unproject([r+e,n]),c=s.distanceTo(l);if("imperial"===this.options.unit){const h=3.2808*c;h>5280?this._setScale(e,h/5280,"mile"):this._setScale(e,h,"foot")}else"nautical"===this.options.unit?this._setScale(e,c/1852,"nautical-mile"):c>=1e3?this._setScale(e,c/1e3,"kilometer"):this._setScale(e,c,"meter")}_setScale(e,t,n){this._map._requestDomTask(()=>{const r=function(l){const c=Math.pow(10,`${Math.floor(l)}`.length-1);let h=l/c;return h=h>=10?10:h>=5?5:h>=3?3:h>=2?2:h>=1?1:function(f){const p=Math.pow(10,Math.ceil(-Math.log(f)/Math.LN10));return Math.round(f*p)/p}(h),c*h}(t),s=r/t;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==n?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(r):`${r}&nbsp;${JM[n]}`,this._container.style.width=e*s+"px"})}onAdd(e){return this._map=e,this._language=e.getLanguage(),this._container=_e("div","mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(e){this._language=e,this._update()}setUnit(e){this.options.unit=e,this._update()}},FullscreenControl:class{constructor(e){this._fullscreen=!1,e&&e.container&&(e.container instanceof it.HTMLElement?this._container=e.container:Y("Full screen control 'container' must be a DOM element.")),Rr(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in it.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in it.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(e){return this._map=e,this._container||(this._container=this._map.getContainer()),this._controlContainer=_e("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",Y("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,it.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!it.document.fullscreenEnabled&&!it.document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=_e("button","mapboxgl-ctrl-fullscreen",this._controlContainer);_e("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),it.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",e)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(it.document.fullscreenElement||it.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?it.document.exitFullscreen?it.document.exitFullscreen():it.document.webkitCancelFullScreen&&it.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends xn{constructor(e){super(),this.options=Vt(Object.create(qM),e),Rr(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(e&&e.className?e.className.trim().split(/\s+/):[])}addTo(e){return this._map&&this.remove(),this._map=e,this.options.closeOnClick&&e.on("preclick",this._onClose),this.options.closeOnMove&&e.on("move",this._onClose),e.on("remove",this.remove),this._update(),e._addPopup(this),this._focusFirstElement(),this._trackPointer?(e.on("mousemove",this._onMouseEvent),e.on("mouseup",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")):e.on("move",this._update),this.fire(new xt("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const e=this._map;return e&&(e.off("move",this._update),e.off("move",this._onClose),e.off("preclick",this._onClose),e.off("click",this._onClose),e.off("remove",this.remove),e.off("mousemove",this._onMouseEvent),e.off("mouseup",this._onMouseEvent),e.off("drag",this._onMouseEvent),e._canvasContainer&&e._canvasContainer.classList.remove("mapboxgl-track-pointer"),e._removePopup(this),this._map=void 0),this.fire(new xt("close")),this}getLngLat(){return this._lngLat}setLngLat(e){this._lngLat=ce.convert(e),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const e=this._map;return e&&(e.off("move",this._update),e.on("mousemove",this._onMouseEvent),e.on("drag",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(it.document.createTextNode(e))}setHTML(e){const t=it.document.createDocumentFragment(),n=it.document.createElement("body");let r;for(n.innerHTML=e;r=n.firstChild,r;)t.appendChild(r);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this}setDOMContent(e){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=_e("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(e),this.options.closeButton){const n=this._closeButton=_e("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.setAttribute("aria-hidden","true"),n.innerHTML="&#215;",n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(e){return this._classList.add(e),this._updateClassList(),this}removeClassName(e){return this._classList.delete(e),this._updateClassList(),this}setOffset(e){return this.options.offset=e,this._update(),this}toggleClassName(e){let t;return this._classList.delete(e)?t=!1:(this._classList.add(e),t=!0),this._updateClassList(),t}_onMouseEvent(e){this._update(e.point)}_getAnchor(e){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,r=this._pos;if(!t||!n||!r)return"bottom";const s=n.offsetWidth,l=n.offsetHeight,c=r.x<s/2,h=r.x>t.transform.width-s/2;if(r.y+e<l)return c?"top-left":h?"top-right":"top";if(r.y>t.transform.height-l){if(c)return"bottom-left";if(h)return"bottom-right"}return c?"left":h?"right":"bottom"}_updateClassList(){const e=this._container;if(!e)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),e.className=t.join(" ")}_update(e){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let r=this._container;if(r||(r=this._container=_e("div","mapboxgl-popup",t.getContainer()),this._tip=_e("div","mapboxgl-popup-tip",r),r.appendChild(n)),this.options.maxWidth&&r.style.maxWidth!==this.options.maxWidth&&(r.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=GM(this._lngLat,this._pos,t.transform)),!this._trackPointer||e){const s=this._pos=this._trackPointer&&e?e:t.project(this._lngLat),l=Tv(this.options.offset),c=this._anchor=this._getAnchor(l.y),h=Tv(this.options.offset,c),f=s.add(h).round();t._requestDomTask(()=>{this._container&&c&&(this._container.style.transform=`${IT[c]} translate(${f.x}px,${f.y}px)`)})}if(!this._marker&&t._showingGlobe()){const s=Fp(t.transform,this._lngLat)?0:1;this._setOpacity(s)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(WM);e&&e.focus()}_onClose(){this.remove()}_setOpacity(e){this._container&&(this._container.style.opacity=`${e}`),this._content&&(this._content.style.pointerEvents=e?"auto":"none")}},Marker:AT,Style:_s,LngLat:ce,LngLatBounds:fi,Point:tt,MercatorCoordinate:He,FreeCameraOptions:t0,Evented:xn,config:Ae,prewarm:function(){Ac().acquire(Wd)},clearPrewarmedResources:function(){const e=Zd;e&&(e.isPreloaded()&&1===e.numActive()?(e.release(Wd),Zd=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return Ae.ACCESS_TOKEN},set accessToken(e){Ae.ACCESS_TOKEN=e},get baseApiUrl(){return Ae.API_URL},set baseApiUrl(e){Ae.API_URL=e},get workerCount(){return $r.workerCount},set workerCount(e){$r.workerCount=e},get maxParallelImageRequests(){return Ae.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(e){Ae.MAX_PARALLEL_IMAGE_REQUESTS=e},clearStorage(e){!function(t){if(!Xc())return;const n=it.caches.delete(Mn);t&&n.catch(t).then(()=>t())}(e)},workerUrl:"",workerClass:null,get dracoUrl(){return Xd()},set dracoUrl(e){R0=me.resolveURL(e),L0||(L0=new Am(Ac(),new xn)),L0.broadcast("setDracoUrl",R0)},setNow:me.setNow,restoreNow:me.restoreNow};qt.A=EE,qt.D=yc,qt.E=st,qt.F=Py,qt.K=Hm,qt.O=tn,qt.P=tt,qt.T=Zw,qt.V=yd,qt.a=by,qt.b=_c,qt.c=Hd,qt.d=class extends xn{constructor(e,t,n,r,s,l){super(),this.actor=e,this.layerIndex=t,this.availableImages=n,this.loadVectorData=s||ME,this.loading={},this.loaded={},this.deduped=new CE(e.scheduler),this.isSpriteLoaded=r,this.scheduler=e.scheduler,this.brightness=l}loadTile(e,t){const n=e.uid,r=e&&e.request,s=r&&r.collectResourceTiming,l=this.loading[n]=new zA(e);l.abort=this.loadVectorData(e,(c,h)=>{const f=!this.loading[n];if(delete this.loading[n],f||c||!h)return l.status="done",f||(this.loaded[n]=l),t(c);const p=h.rawData,m={};h.expires&&(m.expires=h.expires),h.cacheControl&&(m.cacheControl=h.cacheControl),l.vectorTile=h.vectorTile||new Ey(new Xp(p));const _=()=>{l.parse(l.vectorTile,this.layerIndex,this.availableImages,this.actor,(y,v)=>{if(y||!v)return t(y);const b={};if(s){const E=Qv(r);E.length>0&&(b.resourceTiming=JSON.parse(JSON.stringify(E)))}t(null,Vt({rawTileData:p.slice(0)},v,m,b))})};this.isSpriteLoaded?_():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(_,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom}):_()}),this.loaded=this.loaded||{},this.loaded[n]=l})}reloadTile(e,t){const n=this.loaded,r=e.uid,s=this;if(n&&n[r]){const l=n[r];l.showCollisionBoxes=e.showCollisionBoxes,l.projection=e.projection,l.brightness=e.brightness,l.tileTransform=Ml(e.tileID.canonical,e.projection),l.extraShadowCaster=e.extraShadowCaster;const c=(h,f)=>{const p=l.reloadCallback;p&&(delete l.reloadCallback,l.parse(l.vectorTile,s.layerIndex,this.availableImages,s.actor,p)),t(h,f)};"parsing"===l.status?l.reloadCallback=c:"done"===l.status&&(l.vectorTile?l.parse(l.vectorTile,this.layerIndex,this.availableImages,this.actor,c):c())}}abortTile(e,t){const n=e.uid,r=this.loading[n];r&&(r.abort&&r.abort(),delete this.loading[n]),t()}removeTile(e,t){const n=this.loaded,r=e.uid;n&&n[r]&&delete n[r],t()}},qt.e=al,qt.f=Qv,qt.g=Zi,qt.h=Dt,qt.i=Pt,qt.j=function(e,t){const n=Yd(e);for(const r of n){for(const s of r.meshes)BC(s);r.lights&&(r.lightMeshIndex=r.meshes.length,r.meshes.push(OE(r.lights,t)))}return n},qt.k=Gn,qt.l=function(e){let t=0;if(new Uint32Array(e,0,1)[0]!==PE){const n=new Uint32Array(e,0,7),[,,r,s,l,c]=n;t=n.byteLength+s+l+c+l,(r!==e.byteLength||t>=e.byteLength)&&Y("Invalid b3dm header information.")}return Fm(e,t)},qt.m=Id,qt.n=wi,qt.o=xt,qt.p=Ha,qt.q=function(e){Xi(),Mi&&Mi.then(t=>{t.keys().then(n=>{for(let r=0;r<n.length-e;r++)t.delete(n[r])})})},qt.r=zE,qt.s=ag,qt.t=Au,qt.v=yi,qt.w=it}),bh(0,function(qt){function it(Tt){if("number"==typeof Tt||"boolean"==typeof Tt||"string"==typeof Tt||null==Tt)return JSON.stringify(Tt);if(Array.isArray(Tt)){let q="[";for(const Y of Tt)q+=`${it(Y)},`;return`${q}]`}let U="{";for(const q of Object.keys(Tt).sort())U+=`${q}:${it(Tt[q])},`;return`${U}}`}function Go(Tt){let U="";for(const q of qt.r)U+=`/${it(Tt[q])}`;return U}class vs{constructor(U){this.keyCache={},U&&this.replace(U)}replace(U,q){this._layerConfigs={},this._layers={},this.update(U,[],q)}update(U,q,Y){this._options=Y;for(const yt of U){this._layerConfigs[yt.id]=yt;const Nt=this._layers[yt.id]=qt.c(yt,this._options);Nt.setScope(this.scope),Nt.compileFilter(),this.keyCache[yt.id]&&delete this.keyCache[yt.id]}for(const yt of q)delete this.keyCache[yt],delete this._layerConfigs[yt],delete this._layers[yt];this.familiesBySource={};const gt=function(yt,Nt){const Wt={};for(let Yt=0;Yt<yt.length;Yt++){const se=Nt&&Nt[yt[Yt].id]||Go(yt[Yt]);Nt&&(Nt[yt[Yt].id]=se);let ae=Wt[se];ae||(ae=Wt[se]=[]),ae.push(yt[Yt])}const _t=[];for(const Yt in Wt)_t.push(Wt[Yt]);return _t}(qt.v(this._layerConfigs),this.keyCache);for(const yt of gt){const Nt=yt.map(En=>this._layers[En.id]),Wt=Nt[0];if("none"===Wt.visibility)continue;const _t=Wt.source||"";let Yt=this.familiesBySource[_t];Yt||(Yt=this.familiesBySource[_t]={});const se=Wt.sourceLayer||"_geojsonTileLayer";let ae=Yt[se];ae||(ae=Yt[se]=[]),ae.push(Nt)}}}class Ae{loadTile(U,q){const{uid:Y,encoding:gt,rawImageData:yt,padding:Nt}=U,Wt=qt.w.ImageBitmap&&yt instanceof qt.w.ImageBitmap?this.getImageData(yt,Nt):yt;q(null,new qt.D(Y,Wt,gt,U.convertToFloat,Nt<1))}getImageData(U,q){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(U.width,U.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=U.width,this.offscreenCanvas.height=U.height,this.offscreenCanvasContext.drawImage(U,0,0,U.width,U.height);const Y=this.offscreenCanvasContext.getImageData(-q,-q,U.width+2*q,U.height+2*q);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Y}}function mo(Tt,U){if(0!==Tt.length){qo(Tt[0],U);for(var q=1;q<Tt.length;q++)qo(Tt[q],!U)}}function qo(Tt,U){for(var q=0,Y=0,gt=0,yt=Tt.length,Nt=yt-1;gt<yt;Nt=gt++){var Wt=(Tt[gt][0]-Tt[Nt][0])*(Tt[Nt][1]+Tt[gt][1]),_t=q+Wt;Y+=Math.abs(q)>=Math.abs(Wt)?q-_t+Wt:Wt-_t+q,q=_t}q+Y>=0!=!!U&&Tt.reverse()}var ia=qt.g(function Tt(U,q){var Y,gt=U&&U.type;if("FeatureCollection"===gt)for(Y=0;Y<U.features.length;Y++)Tt(U.features[Y],q);else if("GeometryCollection"===gt)for(Y=0;Y<U.geometries.length;Y++)Tt(U.geometries[Y],q);else if("Feature"===gt)Tt(U.geometry,q);else if("Polygon"===gt)mo(U.coordinates,q);else if("MultiPolygon"===gt)for(Y=0;Y<U.coordinates.length;Y++)mo(U.coordinates[Y],q);return U});const qc=qt.V.prototype.toGeoJSON;var $a={exports:{}},vf=qt.p,wh=qt.a.VectorTileFeature,Zi=xs;function xs(Tt,U){this.options=U||{},this.features=Tt,this.length=Tt.length}function bs(Tt,U){this.id="number"==typeof Tt.id?Tt.id:void 0,this.type=Tt.type,this.rawGeometry=1===Tt.type?[Tt.geometry]:Tt.geometry,this.properties=Tt.tags,this.extent=U||4096}xs.prototype.feature=function(Tt){return new bs(this.features[Tt],this.options.extent)},bs.prototype.loadGeometry=function(){var Tt=this.rawGeometry;this.geometry=[];for(var U=0;U<Tt.length;U++){for(var q=Tt[U],Y=[],gt=0;gt<q.length;gt++)Y.push(new vf(q[gt][0],q[gt][1]));this.geometry.push(Y)}return this.geometry},bs.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Tt=this.geometry,U=1/0,q=-1/0,Y=1/0,gt=-1/0,yt=0;yt<Tt.length;yt++)for(var Nt=Tt[yt],Wt=0;Wt<Nt.length;Wt++){var _t=Nt[Wt];U=Math.min(U,_t.x),q=Math.max(q,_t.x),Y=Math.min(Y,_t.y),gt=Math.max(gt,_t.y)}return[U,Y,q,gt]},bs.prototype.toGeoJSON=wh.prototype.toGeoJSON;var xf=qt.b,Ha=Zi;function ws(Tt){var U=new xf;return function(q,Y){for(var gt in q.layers)Y.writeMessage(3,tt,q.layers[gt])}(Tt,U),U.finish()}function tt(Tt,U){var q;U.writeVarintField(15,Tt.version||1),U.writeStringField(1,Tt.name||""),U.writeVarintField(5,Tt.extent||4096);var Y={keys:[],values:[],keycache:{},valuecache:{}};for(q=0;q<Tt.length;q++)Y.feature=Tt.feature(q),U.writeMessage(2,Ke,Y);var gt=Y.keys;for(q=0;q<gt.length;q++)U.writeStringField(3,gt[q]);var yt=Y.values;for(q=0;q<yt.length;q++)U.writeMessage(4,yg,yt[q])}function Ke(Tt,U){var q=Tt.feature;void 0!==q.id&&U.writeVarintField(1,q.id),U.writeMessage(2,jl,Tt),U.writeVarintField(3,q.type),U.writeMessage(4,xr,q)}function jl(Tt,U){var q=Tt.feature,Y=Tt.keys,gt=Tt.values,yt=Tt.keycache,Nt=Tt.valuecache;for(var Wt in q.properties){var _t=q.properties[Wt],Yt=yt[Wt];if(null!==_t){void 0===Yt&&(Y.push(Wt),yt[Wt]=Yt=Y.length-1),U.writeVarint(Yt);var se=typeof _t;"string"!==se&&"boolean"!==se&&"number"!==se&&(_t=JSON.stringify(_t));var ae=se+":"+_t,En=Nt[ae];void 0===En&&(gt.push(_t),Nt[ae]=En=gt.length-1),U.writeVarint(En)}}}function Es(Tt,U){return(U<<3)+(7&Tt)}function be(Tt){return Tt<<1^Tt>>31}function xr(Tt,U){for(var q=Tt.loadGeometry(),Y=Tt.type,gt=0,yt=0,Nt=q.length,Wt=0;Wt<Nt;Wt++){var _t=q[Wt],Yt=1;1===Y&&(Yt=_t.length),U.writeVarint(Es(1,Yt));for(var se=3===Y?_t.length-1:_t.length,ae=0;ae<se;ae++){1===ae&&1!==Y&&U.writeVarint(Es(2,se-1));var En=_t[ae].x-gt,Yn=_t[ae].y-yt;U.writeVarint(be(En)),U.writeVarint(be(Yn)),gt+=En,yt+=Yn}3===Y&&U.writeVarint(Es(7,1))}}function yg(Tt,U){var q=typeof Tt;"string"===q?U.writeStringField(1,Tt):"boolean"===q?U.writeBooleanField(7,Tt):"number"===q&&(Tt%1!=0?U.writeDoubleField(3,Tt):Tt<0?U.writeSVarintField(6,Tt):U.writeVarintField(5,Tt))}$a.exports=ws,$a.exports.fromVectorTileJs=ws,$a.exports.fromGeojsonVt=function(Tt,U){U=U||{};var q={};for(var Y in Tt)q[Y]=new Ha(Tt[Y].features,U),q[Y].name=Y,q[Y].version=U.version,q[Y].extent=U.extent;return ws({layers:q})},$a.exports.GeoJSONWrapper=Ha;var Ga=qt.g($a.exports);const oa={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Tt=>Tt},Vl=Math.fround||(qa=new Float32Array(1),Tt=>(qa[0]=+Tt,qa[0]));var qa;class Ds{constructor(U){this.options=Object.assign(Object.create(oa),U),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(U){const{log:q,minZoom:Y,maxZoom:gt}=this.options;q&&console.time("total time");const yt=`prepare ${U.length} points`;q&&console.time(yt),this.points=U;const Nt=[];for(let _t=0;_t<U.length;_t++){const Yt=U[_t];if(!Yt.geometry)continue;const[se,ae]=Yt.geometry.coordinates,En=Vl(Vt(se)),Yn=Vl(Ci(ae));Nt.push(En,Yn,1/0,_t,-1,1),this.options.reduce&&Nt.push(0)}let Wt=this.trees[gt+1]=this._createTree(Nt);q&&console.timeEnd(yt);for(let _t=gt;_t>=Y;_t--){const Yt=+Date.now();Wt=this.trees[_t]=this._createTree(this._cluster(Wt,_t)),q&&console.log("z%d: %d clusters in %dms",_t,Wt.numItems,+Date.now()-Yt)}return q&&console.timeEnd("total time"),this}getClusters(U,q){let Y=((U[0]+180)%360+360)%360-180;const gt=Math.max(-90,Math.min(90,U[1]));let yt=180===U[2]?180:((U[2]+180)%360+360)%360-180;const Nt=Math.max(-90,Math.min(90,U[3]));if(U[2]-U[0]>=360)Y=-180,yt=180;else if(Y>yt){const ae=this.getClusters([Y,gt,180,Nt],q),En=this.getClusters([-180,gt,yt,Nt],q);return ae.concat(En)}const Wt=this.trees[this._limitZoom(q)],_t=Wt.range(Vt(Y),Ci(Nt),Vt(yt),Ci(gt)),Yt=Wt.data,se=[];for(const ae of _t){const En=this.stride*ae;se.push(Yt[En+5]>1?Ul(Yt,En,this.clusterProps):this.points[Yt[En+3]])}return se}getChildren(U){const q=this._getOriginId(U),Y=this._getOriginZoom(U),gt="No cluster with the specified id.",yt=this.trees[Y];if(!yt)throw new Error(gt);const Nt=yt.data;if(q*this.stride>=Nt.length)throw new Error(gt);const Wt=this.options.radius/(this.options.extent*Math.pow(2,Y-1)),_t=yt.within(Nt[q*this.stride],Nt[q*this.stride+1],Wt),Yt=[];for(const se of _t){const ae=se*this.stride;Nt[ae+4]===U&&Yt.push(Nt[ae+5]>1?Ul(Nt,ae,this.clusterProps):this.points[Nt[ae+3]])}if(0===Yt.length)throw new Error(gt);return Yt}getLeaves(U,q,Y){const gt=[];return this._appendLeaves(gt,U,q=q||10,Y=Y||0,0),gt}getTile(U,q,Y){const gt=this.trees[this._limitZoom(U)],yt=Math.pow(2,U),{extent:Nt,radius:Wt}=this.options,_t=Wt/Nt,Yt=(Y-_t)/yt,se=(Y+1+_t)/yt,ae={features:[]};return this._addTileFeatures(gt.range((q-_t)/yt,Yt,(q+1+_t)/yt,se),gt.data,q,Y,yt,ae),0===q&&this._addTileFeatures(gt.range(1-_t/yt,Yt,1,se),gt.data,yt,Y,yt,ae),q===yt-1&&this._addTileFeatures(gt.range(0,Yt,_t/yt,se),gt.data,-1,Y,yt,ae),ae.features.length?ae:null}getClusterExpansionZoom(U){let q=this._getOriginZoom(U)-1;for(;q<=this.options.maxZoom;){const Y=this.getChildren(U);if(q++,1!==Y.length)break;U=Y[0].properties.cluster_id}return q}_appendLeaves(U,q,Y,gt,yt){const Nt=this.getChildren(q);for(const Wt of Nt){const _t=Wt.properties;if(_t&&_t.cluster?yt+_t.point_count<=gt?yt+=_t.point_count:yt=this._appendLeaves(U,_t.cluster_id,Y,gt,yt):yt<gt?yt++:U.push(Wt),U.length===Y)break}return yt}_createTree(U){const q=new qt.K(U.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Y=0;Y<U.length;Y+=this.stride)q.add(U[Y],U[Y+1]);return q.finish(),q.data=U,q}_addTileFeatures(U,q,Y,gt,yt,Nt){for(const Wt of U){const _t=Wt*this.stride,Yt=q[_t+5]>1;let se,ae,En;if(Yt)se=yi(q,_t,this.clusterProps),ae=q[_t],En=q[_t+1];else{const Kn=this.points[q[_t+3]];se=Kn.properties;const[Cn,Mn]=Kn.geometry.coordinates;ae=Vt(Cn),En=Ci(Mn)}const Yn={type:1,geometry:[[Math.round(this.options.extent*(ae*yt-Y)),Math.round(this.options.extent*(En*yt-gt))]],tags:se};let jr;jr=Yt||this.options.generateId?q[_t+3]:this.points[q[_t+3]].id,void 0!==jr&&(Yn.id=jr),Nt.features.push(Yn)}}_limitZoom(U){return Math.max(this.options.minZoom,Math.min(Math.floor(+U),this.options.maxZoom+1))}_cluster(U,q){const{radius:Y,extent:gt,reduce:yt,minPoints:Nt}=this.options,Wt=Y/(gt*Math.pow(2,q)),_t=U.data,Yt=[],se=this.stride;for(let ae=0;ae<_t.length;ae+=se){if(_t[ae+2]<=q)continue;_t[ae+2]=q;const En=_t[ae],Yn=_t[ae+1],jr=U.within(_t[ae],_t[ae+1],Wt),Kn=_t[ae+5];let Cn=Kn;for(const Mn of jr){const oi=Mn*se;_t[oi+2]>q&&(Cn+=_t[oi+5])}if(Cn>Kn&&Cn>=Nt){let Mn,oi=En*Kn,vi=Yn*Kn,Mi=-1;const Wo=((ae/se|0)<<5)+(q+1)+this.points.length;for(const Xc of jr){const Xi=Xc*se;if(_t[Xi+2]<=q)continue;_t[Xi+2]=q;const sa=_t[Xi+5];oi+=_t[Xi]*sa,vi+=_t[Xi+1]*sa,_t[Xi+4]=Wo,yt&&(Mn||(Mn=this._map(_t,ae,!0),Mi=this.clusterProps.length,this.clusterProps.push(Mn)),yt(Mn,this._map(_t,Xi)))}_t[ae+4]=Wo,Yt.push(oi/Cn,vi/Cn,1/0,Wo,-1,Cn),yt&&Yt.push(Mi)}else{for(let Mn=0;Mn<se;Mn++)Yt.push(_t[ae+Mn]);if(Cn>1)for(const Mn of jr){const oi=Mn*se;if(!(_t[oi+2]<=q)){_t[oi+2]=q;for(let vi=0;vi<se;vi++)Yt.push(_t[oi+vi])}}}}return Yt}_getOriginId(U){return U-this.points.length>>5}_getOriginZoom(U){return(U-this.points.length)%32}_map(U,q,Y){if(U[q+5]>1){const Nt=this.clusterProps[U[q+6]];return Y?Object.assign({},Nt):Nt}const gt=this.points[U[q+3]].properties,yt=this.options.map(gt);return Y&&yt===gt?Object.assign({},yt):yt}}function Ul(Tt,U,q){return{type:"Feature",id:Tt[U+3],properties:yi(Tt,U,q),geometry:{type:"Point",coordinates:[(Y=Tt[U],360*(Y-.5)),Br(Tt[U+1])]}};var Y}function yi(Tt,U,q){const Y=Tt[U+5],gt=Y>=1e4?`${Math.round(Y/1e3)}k`:Y>=1e3?Math.round(Y/100)/10+"k":Y,yt=Tt[U+6],Nt=-1===yt?{}:Object.assign({},q[yt]);return Object.assign(Nt,{cluster:!0,cluster_id:Tt[U+3],point_count:Y,point_count_abbreviated:gt})}function Vt(Tt){return Tt/360+.5}function Ci(Tt){const U=Math.sin(Tt*Math.PI/180),q=.5-.25*Math.log((1+U)/(1-U))/Math.PI;return q<0?0:q>1?1:q}function Br(Tt){const U=(180-360*Tt)*Math.PI/180;return 360*Math.atan(Math.exp(U))/Math.PI-90}var mr={exports:{}};mr.exports=function(){function Tt(dt,pt,vt,Ct){for(var Dt,Pt=Ct,Ft=vt-pt>>1,It=vt-pt,$t=dt[pt],Rt=dt[pt+1],Te=dt[vt],dn=dt[vt+1],Jt=pt+3;Jt<vt;Jt+=3){var hn=U(dt[Jt],dt[Jt+1],$t,Rt,Te,dn);if(hn>Pt)Dt=Jt,Pt=hn;else if(hn===Pt){var mn=Math.abs(Jt-Ft);mn<It&&(Dt=Jt,It=mn)}}Pt>Ct&&(Dt-pt>3&&Tt(dt,pt,Dt,Ct),dt[Dt+2]=Pt,vt-Dt>3&&Tt(dt,Dt,vt,Ct))}function U(dt,pt,vt,Ct,Dt,Pt){var Ft=Dt-vt,It=Pt-Ct;if(0!==Ft||0!==It){var $t=((dt-vt)*Ft+(pt-Ct)*It)/(Ft*Ft+It*It);$t>1?(vt=Dt,Ct=Pt):$t>0&&(vt+=Ft*$t,Ct+=It*$t)}return(Ft=dt-vt)*Ft+(It=pt-Ct)*It}function q(dt,pt,vt,Ct){var Dt={id:void 0===dt?null:dt,type:pt,geometry:vt,tags:Ct,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Pt){var Ft=Pt.geometry,It=Pt.type;if("Point"===It||"MultiPoint"===It||"LineString"===It)Y(Pt,Ft);else if("Polygon"===It||"MultiLineString"===It)for(var $t=0;$t<Ft.length;$t++)Y(Pt,Ft[$t]);else if("MultiPolygon"===It)for($t=0;$t<Ft.length;$t++)for(var Rt=0;Rt<Ft[$t].length;Rt++)Y(Pt,Ft[$t][Rt])}(Dt),Dt}function Y(dt,pt){for(var vt=0;vt<pt.length;vt+=3)dt.minX=Math.min(dt.minX,pt[vt]),dt.minY=Math.min(dt.minY,pt[vt+1]),dt.maxX=Math.max(dt.maxX,pt[vt]),dt.maxY=Math.max(dt.maxY,pt[vt+1])}function gt(dt,pt,vt,Ct){if(pt.geometry){var Dt=pt.geometry.coordinates,Pt=pt.geometry.type,Ft=Math.pow(vt.tolerance/((1<<vt.maxZoom)*vt.extent),2),It=[],$t=pt.id;if(vt.promoteId?$t=pt.properties[vt.promoteId]:vt.generateId&&($t=Ct||0),"Point"===Pt)yt(Dt,It);else if("MultiPoint"===Pt)for(var Rt=0;Rt<Dt.length;Rt++)yt(Dt[Rt],It);else if("LineString"===Pt)Nt(Dt,It,Ft,!1);else if("MultiLineString"===Pt){if(vt.lineMetrics){for(Rt=0;Rt<Dt.length;Rt++)Nt(Dt[Rt],It=[],Ft,!1),dt.push(q($t,"LineString",It,pt.properties));return}Wt(Dt,It,Ft,!1)}else if("Polygon"===Pt)Wt(Dt,It,Ft,!0);else{if("MultiPolygon"!==Pt){if("GeometryCollection"===Pt){for(Rt=0;Rt<pt.geometry.geometries.length;Rt++)gt(dt,{id:$t,geometry:pt.geometry.geometries[Rt],properties:pt.properties},vt,Ct);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Rt=0;Rt<Dt.length;Rt++){var Te=[];Wt(Dt[Rt],Te,Ft,!0),It.push(Te)}}dt.push(q($t,Pt,It,pt.properties))}}function yt(dt,pt){pt.push(_t(dt[0])),pt.push(Yt(dt[1])),pt.push(0)}function Nt(dt,pt,vt,Ct){for(var Dt,Pt,Ft=0,It=0;It<dt.length;It++){var $t=_t(dt[It][0]),Rt=Yt(dt[It][1]);pt.push($t),pt.push(Rt),pt.push(0),It>0&&(Ft+=Ct?(Dt*Rt-$t*Pt)/2:Math.sqrt(Math.pow($t-Dt,2)+Math.pow(Rt-Pt,2))),Dt=$t,Pt=Rt}var Te=pt.length-3;pt[2]=1,Tt(pt,0,Te,vt),pt[Te+2]=1,pt.size=Math.abs(Ft),pt.start=0,pt.end=pt.size}function Wt(dt,pt,vt,Ct){for(var Dt=0;Dt<dt.length;Dt++){var Pt=[];Nt(dt[Dt],Pt,vt,Ct),pt.push(Pt)}}function _t(dt){return dt/360+.5}function Yt(dt){var pt=Math.sin(dt*Math.PI/180),vt=.5-.25*Math.log((1+pt)/(1-pt))/Math.PI;return vt<0?0:vt>1?1:vt}function se(dt,pt,vt,Ct,Dt,Pt,Ft,It){if(Ct/=pt,Pt>=(vt/=pt)&&Ft<Ct)return dt;if(Ft<vt||Pt>=Ct)return null;for(var $t=[],Rt=0;Rt<dt.length;Rt++){var Te=dt[Rt],dn=Te.geometry,Jt=Te.type,hn=0===Dt?Te.minX:Te.minY,mn=0===Dt?Te.maxX:Te.maxY;if(hn>=vt&&mn<Ct)$t.push(Te);else if(!(mn<vt||hn>=Ct)){var ir=[];if("Point"===Jt||"MultiPoint"===Jt)ae(dn,ir,vt,Ct,Dt);else if("LineString"===Jt)En(dn,ir,vt,Ct,Dt,!1,It.lineMetrics);else if("MultiLineString"===Jt)jr(dn,ir,vt,Ct,Dt,!1);else if("Polygon"===Jt)jr(dn,ir,vt,Ct,Dt,!0);else if("MultiPolygon"===Jt)for(var gr=0;gr<dn.length;gr++){var si=[];jr(dn[gr],si,vt,Ct,Dt,!0),si.length&&ir.push(si)}if(ir.length){if(It.lineMetrics&&"LineString"===Jt){for(gr=0;gr<ir.length;gr++)$t.push(q(Te.id,Jt,ir[gr],Te.tags));continue}"LineString"!==Jt&&"MultiLineString"!==Jt||(1===ir.length?(Jt="LineString",ir=ir[0]):Jt="MultiLineString"),"Point"!==Jt&&"MultiPoint"!==Jt||(Jt=3===ir.length?"Point":"MultiPoint"),$t.push(q(Te.id,Jt,ir,Te.tags))}}}return $t.length?$t:null}function ae(dt,pt,vt,Ct,Dt){for(var Pt=0;Pt<dt.length;Pt+=3){var Ft=dt[Pt+Dt];Ft>=vt&&Ft<=Ct&&(pt.push(dt[Pt]),pt.push(dt[Pt+1]),pt.push(dt[Pt+2]))}}function En(dt,pt,vt,Ct,Dt,Pt,Ft){for(var It,$t,Rt=Yn(dt),Te=0===Dt?Cn:Mn,dn=dt.start,Jt=0;Jt<dt.length-3;Jt+=3){var hn=dt[Jt],mn=dt[Jt+1],ir=dt[Jt+2],gr=dt[Jt+3],si=dt[Jt+4],Io=0===Dt?hn:mn,br=0===Dt?gr:si,Ii=!1;Ft&&(It=Math.sqrt(Math.pow(hn-gr,2)+Math.pow(mn-si,2))),Io<vt?br>vt&&($t=Te(Rt,hn,mn,gr,si,vt),Ft&&(Rt.start=dn+It*$t)):Io>Ct?br<Ct&&($t=Te(Rt,hn,mn,gr,si,Ct),Ft&&(Rt.start=dn+It*$t)):Kn(Rt,hn,mn,ir),br<vt&&Io>=vt&&($t=Te(Rt,hn,mn,gr,si,vt),Ii=!0),br>Ct&&Io<=Ct&&($t=Te(Rt,hn,mn,gr,si,Ct),Ii=!0),!Pt&&Ii&&(Ft&&(Rt.end=dn+It*$t),pt.push(Rt),Rt=Yn(dt)),Ft&&(dn+=It)}var ai=dt.length-3;hn=dt[ai],mn=dt[ai+1],ir=dt[ai+2],(Io=0===Dt?hn:mn)>=vt&&Io<=Ct&&Kn(Rt,hn,mn,ir),ai=Rt.length-3,Pt&&ai>=3&&(Rt[ai]!==Rt[0]||Rt[ai+1]!==Rt[1])&&Kn(Rt,Rt[0],Rt[1],Rt[2]),Rt.length&&pt.push(Rt)}function Yn(dt){var pt=[];return pt.size=dt.size,pt.start=dt.start,pt.end=dt.end,pt}function jr(dt,pt,vt,Ct,Dt,Pt){for(var Ft=0;Ft<dt.length;Ft++)En(dt[Ft],pt,vt,Ct,Dt,Pt,!1)}function Kn(dt,pt,vt,Ct){dt.push(pt),dt.push(vt),dt.push(Ct)}function Cn(dt,pt,vt,Ct,Dt,Pt){var Ft=(Pt-pt)/(Ct-pt);return dt.push(Pt),dt.push(vt+(Dt-vt)*Ft),dt.push(1),Ft}function Mn(dt,pt,vt,Ct,Dt,Pt){var Ft=(Pt-vt)/(Dt-vt);return dt.push(pt+(Ct-pt)*Ft),dt.push(Pt),dt.push(1),Ft}function oi(dt,pt){for(var vt=[],Ct=0;Ct<dt.length;Ct++){var Dt,Pt=dt[Ct],Ft=Pt.type;if("Point"===Ft||"MultiPoint"===Ft||"LineString"===Ft)Dt=vi(Pt.geometry,pt);else if("MultiLineString"===Ft||"Polygon"===Ft){Dt=[];for(var It=0;It<Pt.geometry.length;It++)Dt.push(vi(Pt.geometry[It],pt))}else if("MultiPolygon"===Ft)for(Dt=[],It=0;It<Pt.geometry.length;It++){for(var $t=[],Rt=0;Rt<Pt.geometry[It].length;Rt++)$t.push(vi(Pt.geometry[It][Rt],pt));Dt.push($t)}vt.push(q(Pt.id,Ft,Dt,Pt.tags))}return vt}function vi(dt,pt){var vt=[];vt.size=dt.size,void 0!==dt.start&&(vt.start=dt.start,vt.end=dt.end);for(var Ct=0;Ct<dt.length;Ct+=3)vt.push(dt[Ct]+pt,dt[Ct+1],dt[Ct+2]);return vt}function Mi(dt,pt){if(dt.transformed)return dt;var vt,Ct,Dt,Pt=1<<dt.z,Ft=dt.x,It=dt.y;for(vt=0;vt<dt.features.length;vt++){var $t=dt.features[vt],Rt=$t.geometry,Te=$t.type;if($t.geometry=[],1===Te)for(Ct=0;Ct<Rt.length;Ct+=2)$t.geometry.push(Wo(Rt[Ct],Rt[Ct+1],pt,Pt,Ft,It));else for(Ct=0;Ct<Rt.length;Ct++){var dn=[];for(Dt=0;Dt<Rt[Ct].length;Dt+=2)dn.push(Wo(Rt[Ct][Dt],Rt[Ct][Dt+1],pt,Pt,Ft,It));$t.geometry.push(dn)}}return dt.transformed=!0,dt}function Wo(dt,pt,vt,Ct,Dt,Pt){return[Math.round(vt*(dt*Ct-Dt)),Math.round(vt*(pt*Ct-Pt))]}function Xc(dt,pt,vt,Ct,Dt){for(var Pt=pt===Dt.maxZoom?0:Dt.tolerance/((1<<pt)*Dt.extent),Ft={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:vt,y:Ct,z:pt,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},It=0;It<dt.length;It++){Ft.numFeatures++,Xi(Ft,dt[It],Pt,Dt);var $t=dt[It].minX,Rt=dt[It].minY,Te=dt[It].maxX,dn=dt[It].maxY;$t<Ft.minX&&(Ft.minX=$t),Rt<Ft.minY&&(Ft.minY=Rt),Te>Ft.maxX&&(Ft.maxX=Te),dn>Ft.maxY&&(Ft.maxY=dn)}return Ft}function Xi(dt,pt,vt,Ct){var Dt=pt.geometry,Pt=pt.type,Ft=[];if("Point"===Pt||"MultiPoint"===Pt)for(var It=0;It<Dt.length;It+=3)Ft.push(Dt[It]),Ft.push(Dt[It+1]),dt.numPoints++,dt.numSimplified++;else if("LineString"===Pt)sa(Ft,Dt,dt,vt,!1,!1);else if("MultiLineString"===Pt||"Polygon"===Pt)for(It=0;It<Dt.length;It++)sa(Ft,Dt[It],dt,vt,"Polygon"===Pt,0===It);else if("MultiPolygon"===Pt)for(var $t=0;$t<Dt.length;$t++){var Rt=Dt[$t];for(It=0;It<Rt.length;It++)sa(Ft,Rt[It],dt,vt,!0,0===It)}if(Ft.length){var Te=pt.tags||null;if("LineString"===Pt&&Ct.lineMetrics){for(var dn in Te={},pt.tags)Te[dn]=pt.tags[dn];Te.mapbox_clip_start=Dt.start/Dt.size,Te.mapbox_clip_end=Dt.end/Dt.size}var Jt={geometry:Ft,type:"Polygon"===Pt||"MultiPolygon"===Pt?3:"LineString"===Pt||"MultiLineString"===Pt?2:1,tags:Te};null!==pt.id&&(Jt.id=pt.id),dt.features.push(Jt)}}function sa(dt,pt,vt,Ct,Dt,Pt){var Ft=Ct*Ct;if(Ct>0&&pt.size<(Dt?Ft:Ct))vt.numPoints+=pt.length/3;else{for(var It=[],$t=0;$t<pt.length;$t+=3)(0===Ct||pt[$t+2]>Ft)&&(vt.numSimplified++,It.push(pt[$t]),It.push(pt[$t+1])),vt.numPoints++;Dt&&function(Rt,Te){for(var dn=0,Jt=0,hn=Rt.length,mn=hn-2;Jt<hn;mn=Jt,Jt+=2)dn+=(Rt[Jt]-Rt[mn])*(Rt[Jt+1]+Rt[mn+1]);if(dn>0===Te)for(Jt=0,hn=Rt.length;Jt<hn/2;Jt+=2){var ir=Rt[Jt],gr=Rt[Jt+1];Rt[Jt]=Rt[hn-2-Jt],Rt[Jt+1]=Rt[hn-1-Jt],Rt[hn-2-Jt]=ir,Rt[hn-1-Jt]=gr}}(It,Pt),dt.push(It)}}function Za(dt,pt){var vt=(pt=this.options=function(Dt,Pt){for(var Ft in Pt)Dt[Ft]=Pt[Ft];return Dt}(Object.create(this.options),pt)).debug;if(vt&&console.time("preprocess data"),pt.maxZoom<0||pt.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(pt.promoteId&&pt.generateId)throw new Error("promoteId and generateId cannot be used together.");var Dt,Pt,Ft,It,$t,Rt,Ct=function(Dt,Pt){var Ft=[];if("FeatureCollection"===Dt.type)for(var It=0;It<Dt.features.length;It++)gt(Ft,Dt.features[It],Pt,It);else gt(Ft,"Feature"===Dt.type?Dt:{geometry:Dt},Pt);return Ft}(dt,pt);this.tiles={},this.tileCoords=[],vt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",pt.indexMaxZoom,pt.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(Dt=Ct,Pt=pt,Ft=Pt.buffer/Pt.extent,It=Dt,$t=se(Dt,1,-1-Ft,Ft,0,-1,2,Pt),Rt=se(Dt,1,1-Ft,2+Ft,0,-1,2,Pt),($t||Rt)&&(It=se(Dt,1,-Ft,1+Ft,0,-1,2,Pt)||[],$t&&(It=oi($t,1).concat(It)),Rt&&(It=It.concat(oi(Rt,-1)))),Ct=It).length&&this.splitTile(Ct,0,0,0),vt&&(Ct.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Yc(dt,pt,vt){return 32*((1<<dt)*vt+pt)+dt}return Za.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Za.prototype.splitTile=function(dt,pt,vt,Ct,Dt,Pt,Ft){for(var It=[dt,pt,vt,Ct],$t=this.options,Rt=$t.debug;It.length;){Ct=It.pop(),vt=It.pop(),pt=It.pop(),dt=It.pop();var Te=1<<pt,dn=Yc(pt,vt,Ct),Jt=this.tiles[dn];if(!Jt&&(Rt>1&&console.time("creation"),Jt=this.tiles[dn]=Xc(dt,pt,vt,Ct,$t),this.tileCoords.push({z:pt,x:vt,y:Ct}),Rt)){Rt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",pt,vt,Ct,Jt.numFeatures,Jt.numPoints,Jt.numSimplified),console.timeEnd("creation"));var hn="z"+pt;this.stats[hn]=(this.stats[hn]||0)+1,this.total++}if(Jt.source=dt,Dt){if(pt===$t.maxZoom||pt===Dt)continue;var mn=1<<Dt-pt;if(vt!==Math.floor(Pt/mn)||Ct!==Math.floor(Ft/mn))continue}else if(pt===$t.indexMaxZoom||Jt.numPoints<=$t.indexMaxPoints)continue;if(Jt.source=null,0!==dt.length){Rt>1&&console.time("clipping");var ir,gr,si,Io,br,Ii,ai=.5*$t.buffer/$t.extent,Yi=.5-ai,Xa=.5+ai,wr=1+ai;ir=gr=si=Io=null,br=se(dt,Te,vt-ai,vt+Xa,0,Jt.minX,Jt.maxX,$t),Ii=se(dt,Te,vt+Yi,vt+wr,0,Jt.minX,Jt.maxX,$t),dt=null,br&&(ir=se(br,Te,Ct-ai,Ct+Xa,1,Jt.minY,Jt.maxY,$t),gr=se(br,Te,Ct+Yi,Ct+wr,1,Jt.minY,Jt.maxY,$t),br=null),Ii&&(si=se(Ii,Te,Ct-ai,Ct+Xa,1,Jt.minY,Jt.maxY,$t),Io=se(Ii,Te,Ct+Yi,Ct+wr,1,Jt.minY,Jt.maxY,$t),Ii=null),Rt>1&&console.timeEnd("clipping"),It.push(ir||[],pt+1,2*vt,2*Ct),It.push(gr||[],pt+1,2*vt,2*Ct+1),It.push(si||[],pt+1,2*vt+1,2*Ct),It.push(Io||[],pt+1,2*vt+1,2*Ct+1)}}},Za.prototype.getTile=function(dt,pt,vt){var Ct=this.options,Dt=Ct.extent,Pt=Ct.debug;if(dt<0||dt>24)return null;var Ft=1<<dt,It=Yc(dt,pt=(pt%Ft+Ft)%Ft,vt);if(this.tiles[It])return Mi(this.tiles[It],Dt);Pt>1&&console.log("drilling down to z%d-%d-%d",dt,pt,vt);for(var $t,Rt=dt,Te=pt,dn=vt;!$t&&Rt>0;)Rt--,Te=Math.floor(Te/2),dn=Math.floor(dn/2),$t=this.tiles[Yc(Rt,Te,dn)];return $t&&$t.source?(Pt>1&&console.log("found parent tile z%d-%d-%d",Rt,Te,dn),Pt>1&&console.time("drilling down"),this.splitTile($t.source,Rt,Te,dn,dt,pt,vt),Pt>1&&console.timeEnd("drilling down"),this.tiles[It]?Mi(this.tiles[It],Dt):null):null},function(dt,pt){return new Za(dt,pt)}}();var bf=qt.g(mr.exports);function un(Tt,U){const q=Tt.tileID.canonical;if(!this._geoJSONIndex)return U(null,null);const Y=this._geoJSONIndex.getTile(q.z,q.x,q.y);if(!Y)return U(null,null);const gt=new class{constructor(Nt){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=qt.E,this.length=Nt.length,this._features=Nt}feature(Nt){return new class{constructor(Wt){this._feature=Wt,this.extent=qt.E,this.type=Wt.type,this.properties=Wt.tags,"id"in Wt&&!isNaN(Wt.id)&&(this.id=parseInt(Wt.id,10))}loadGeometry(){if(1===this._feature.type){const Wt=[];for(const _t of this._feature.geometry)Wt.push([new qt.P(_t[0],_t[1])]);return Wt}{const Wt=[];for(const _t of this._feature.geometry){const Yt=[];for(const se of _t)Yt.push(new qt.P(se[0],se[1]));Wt.push(Yt)}return Wt}}toGeoJSON(Wt,_t,Yt){return qc.call(this,Wt,_t,Yt)}}(this._features[Nt])}}(Y.features);let yt=Ga(gt);0===yt.byteOffset&&yt.byteLength===yt.buffer.byteLength||(yt=new Uint8Array(yt)),U(null,{vectorTile:gt,rawData:yt.buffer})}class Wc extends qt.d{constructor(U,q,Y,gt,yt,Nt){super(U,q,Y,gt,un,Nt),yt&&(this.loadGeoJSON=yt)}loadData(U,q){const Y=U&&U.request,gt=Y&&Y.collectResourceTiming;this.loadGeoJSON(U,(yt,Nt)=>{if(yt||!Nt)return q(yt);if("object"!=typeof Nt)return q(new Error(`Input data given to '${U.source}' is not a valid GeoJSON object.`));{ia(Nt,!0);try{if(U.filter){const _t=qt.e(U.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===_t.result)throw new Error(_t.value.map(se=>`${se.key}: ${se.message}`).join(", "));const Yt=Nt.features.filter(se=>_t.value.evaluate({zoom:0},se));Nt={type:"FeatureCollection",features:Yt}}this._geoJSONIndex=U.cluster?new Ds(function({superclusterOptions:_t,clusterProperties:Yt}){if(!Yt||!_t)return _t;const se={},ae={},En={accumulated:null,zoom:0},Yn={properties:null},jr=Object.keys(Yt);for(const Kn of jr){const[Cn,Mn]=Yt[Kn],oi=qt.e(Mn),vi=qt.e("string"==typeof Cn?[Cn,["accumulated"],["get",Kn]]:Cn);se[Kn]=oi.value,ae[Kn]=vi.value}return _t.map=Kn=>{Yn.properties=Kn;const Cn={};for(const Mn of jr)Cn[Mn]=se[Mn].evaluate(En,Yn);return Cn},_t.reduce=(Kn,Cn)=>{Yn.properties=Cn;for(const Mn of jr)En.accumulated=Kn[Mn],Kn[Mn]=ae[Mn].evaluate(En,Yn)},_t}(U)).load(Nt.features):bf(Nt,U.geojsonVtOptions)}catch(_t){return q(_t)}this.loaded={};const Wt={};if(gt){const _t=qt.f(Y);_t&&(Wt.resourceTiming={},Wt.resourceTiming[U.source]=JSON.parse(JSON.stringify(_t)))}q(null,Wt)}})}reloadTile(U,q){const Y=this.loaded;return Y&&Y[U.uid]?super.reloadTile(U,q):this.loadTile(U,q)}loadGeoJSON(U,q){if(U.request)qt.h(U.request,q);else{if("string"!=typeof U.data)return q(new Error(`Input data given to '${U.source}' is not a valid GeoJSON object.`));try{return q(null,JSON.parse(U.data))}catch{return q(new Error(`Input data given to '${U.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(U,q){try{q(null,this._geoJSONIndex.getClusterExpansionZoom(U.clusterId))}catch(Y){q(Y)}}getClusterChildren(U,q){try{q(null,this._geoJSONIndex.getChildren(U.clusterId))}catch(Y){q(Y)}}getClusterLeaves(U,q){try{q(null,this._geoJSONIndex.getLeaves(U.clusterId,U.limit,U.offset))}catch(Y){q(Y)}}}class Rr{constructor(U,q){this.tileID=new qt.O(U.tileID.overscaledZ,U.tileID.wrap,U.tileID.canonical.z,U.tileID.canonical.x,U.tileID.canonical.y),this.tileZoom=U.tileZoom,this.uid=U.uid,this.zoom=U.zoom,this.canonical=U.tileID.canonical,this.pixelRatio=U.pixelRatio,this.tileSize=U.tileSize,this.source=U.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=U.projection,this.brightness=q}parse(U,q,Y,gt){this.status="parsing";const yt=new qt.O(Y.tileID.overscaledZ,Y.tileID.wrap,Y.tileID.canonical.z,Y.tileID.canonical.x,Y.tileID.canonical.y),Nt={},Wt=q.familiesBySource[Y.source],_t=new qt.F(yt,Y.promoteId);return _t.bucketLayerIDs=[],qt.l(U).then(Yt=>{if(!Yt)return gt(new Error("Could not parse tile"));const se=qt.j(Yt,1/qt.t(Y.tileID.canonical)),ae=Yt.json.extensionsUsed&&Yt.json.extensionsUsed.includes("MAPBOX_mesh_features"),En=new qt.k(this.zoom,{brightness:this.brightness});for(const Yn in Wt)for(const jr of Wt[Yn]){const Kn=jr[0],Cn=Yt.json.extensionsUsed;Kn.recalculate(En,[]);const Mn=new qt.T(se,yt,Cn&&Cn.includes("MAPBOX_mesh_features"),this.brightness);ae||(Mn.needsUpload=!0),Nt[Kn.fqid]=Mn,Mn.evaluate(Kn)}this.status="done",gt(null,{buckets:Nt,featureIndex:_t})}).catch(Yt=>gt(new Error(Yt.message)))}}class Wa{constructor(U,q,Y,gt,yt,Nt){this.actor=U,this.layerIndex=q,this.brightness=Nt,this.loading={},this.loaded={}}loadTile(U,q){const Y=U.uid,gt=this.loading[Y]=new Rr(U,this.brightness);qt.i(U.request,(yt,Nt)=>{const Wt=!this.loading[Y];return delete this.loading[Y],Wt||yt?(gt.status="done",Wt||(this.loaded[Y]=gt),q(yt)):Nt&&0!==Nt.byteLength?void gt.parse(Nt,this.layerIndex,U,(_t,Yt)=>{gt.status="done",this.loaded=this.loaded||{},this.loaded[Y]=gt,_t||!Yt?q(_t):q(null,Yt)}):(gt.status="done",this.loaded[Y]=gt,q())})}reloadTile(U,q){const Y=this.loaded,gt=U.uid;if(Y&&Y[gt]){const yt=Y[gt];yt.projection=U.projection,yt.brightness=U.brightness;const Nt=(Wt,_t)=>{yt.reloadCallback&&(delete yt.reloadCallback,this.loadTile(U,q)),q(Wt,_t)};"parsing"===yt.status?yt.reloadCallback=Nt:"done"===yt.status&&this.loadTile(U,q)}}abortTile(U,q){const Y=U.uid;this.loading[Y]&&delete this.loading[Y],q()}removeTile(U,q){const Y=this.loaded,gt=U.uid;Y&&Y[gt]&&delete Y[gt],q()}}class Zc{constructor(U){this.self=U,this.actor=new qt.A(U,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=qt.m({name:"mercator"}),this.workerSourceTypes={vector:qt.d,geojson:Wc,"batched-model":Wa},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(q,Y)=>{if(this.workerSourceTypes[q])throw new Error(`Worker source with name "${q}" already registered.`);this.workerSourceTypes[q]=Y},this.self.registerRTLTextPlugin=q=>{if(qt.n.isParsed())throw new Error("RTL text plugin already registered.");qt.n.applyArabicShaping=q.applyArabicShaping,qt.n.processBidirectionalText=q.processBidirectionalText,qt.n.processStyledBidirectionalText=q.processStyledBidirectionalText}}clearCaches(U,q,Y){delete this.layerIndexes[U],delete this.availableImages[U],delete this.workerSources[U],delete this.demWorkerSources[U],Y()}checkIfReady(U,q,Y){Y()}setReferrer(U,q){this.referrer=q}spriteLoaded(U,{scope:q,isLoaded:Y}){if(this.isSpriteLoaded[U]||(this.isSpriteLoaded[U]={}),this.isSpriteLoaded[U][q]=Y,this.workerSources[U]&&this.workerSources[U][q])for(const gt in this.workerSources[U][q]){const yt=this.workerSources[U][q][gt];for(const Nt in yt)yt[Nt]instanceof qt.d&&(yt[Nt].isSpriteLoaded=Y,yt[Nt].fire(new qt.o("isSpriteLoaded")))}}setImages(U,{scope:q,images:Y},gt){if(this.availableImages[U]||(this.availableImages[U]={}),this.availableImages[U][q]=Y,this.workerSources[U]&&this.workerSources[U][q]){for(const yt in this.workerSources[U][q]){const Nt=this.workerSources[U][q][yt];for(const Wt in Nt)Nt[Wt].availableImages=Y}gt()}else gt()}setProjection(U,q){this.projections[U]=qt.m(q)}setBrightness(U,q,Y){this.brightness=q,Y()}setLayers(U,q,Y){this.getLayerIndex(U,q.scope).replace(q.layers,q.options),Y()}updateLayers(U,q,Y){this.getLayerIndex(U,q.scope).update(q.layers,q.removedIds,q.options),Y()}loadTile(U,q,Y){q.projection=this.projections[U]||this.defaultProjection,this.getWorkerSource(U,q.type,q.source,q.scope).loadTile(q,Y)}loadDEMTile(U,q,Y){this.getDEMWorkerSource(U,q.source,q.scope).loadTile(q,Y)}reloadTile(U,q,Y){q.projection=this.projections[U]||this.defaultProjection,this.getWorkerSource(U,q.type,q.source,q.scope).reloadTile(q,Y)}abortTile(U,q,Y){this.getWorkerSource(U,q.type,q.source,q.scope).abortTile(q,Y)}removeTile(U,q,Y){this.getWorkerSource(U,q.type,q.source,q.scope).removeTile(q,Y)}removeSource(U,q,Y){if(!(this.workerSources[U]&&this.workerSources[U][q.scope]&&this.workerSources[U][q.scope][q.type]&&this.workerSources[U][q.scope][q.type][q.source]))return;const gt=this.workerSources[U][q.scope][q.type][q.source];delete this.workerSources[U][q.scope][q.type][q.source],void 0!==gt.removeSource?gt.removeSource(q,Y):Y()}loadWorkerSource(U,q,Y){try{this.self.importScripts(q.url),Y()}catch(gt){Y(gt.toString())}}syncRTLPluginState(U,q,Y){try{qt.n.setState(q);const gt=qt.n.getPluginURL();if(qt.n.isLoaded()&&!qt.n.isParsed()&&null!=gt){this.self.importScripts(gt);const yt=qt.n.isParsed();Y(yt?void 0:new Error(`RTL Text Plugin failed to import scripts from ${gt}`),yt)}}catch(gt){Y(gt.toString())}}setDracoUrl(U,q){this.dracoUrl=q}getAvailableImages(U,q){this.availableImages[U]||(this.availableImages[U]={});let Y=this.availableImages[U][q];return Y||(Y=[]),Y}getLayerIndex(U,q){this.layerIndexes[U]||(this.layerIndexes[U]={});let Y=this.layerIndexes[U][q];return Y||(Y=this.layerIndexes[U][q]=new vs,Y.scope=q),Y}getWorkerSource(U,q,Y,gt){return this.workerSources[U]||(this.workerSources[U]={}),this.workerSources[U][gt]||(this.workerSources[U][gt]={}),this.workerSources[U][gt][q]||(this.workerSources[U][gt][q]={}),this.isSpriteLoaded[U]||(this.isSpriteLoaded[U]={}),this.workerSources[U][gt][q][Y]||(this.workerSources[U][gt][q][Y]=new this.workerSourceTypes[q]({send:(Nt,Wt,_t,Yt,se,ae)=>{this.actor.send(Nt,Wt,_t,U,se,ae)},scheduler:this.actor.scheduler},this.getLayerIndex(U,gt),this.getAvailableImages(U,gt),this.isSpriteLoaded[U][gt],void 0,this.brightness)),this.workerSources[U][gt][q][Y]}getDEMWorkerSource(U,q,Y){return this.demWorkerSources[U]||(this.demWorkerSources[U]={}),this.demWorkerSources[U][Y]||(this.demWorkerSources[U][Y]={}),this.demWorkerSources[U][Y][q]||(this.demWorkerSources[U][Y][q]=new Ae),this.demWorkerSources[U][Y][q]}enforceCacheSizeLimit(U,q){qt.q(q)}getWorkerPerformanceMetrics(U,q,Y){Y(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Zc(self)),Zc}),bh(0,function(qt){return qt.s}),Qn}()}},gg=>{gg(gg.s=953)}]);